
<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Lipodem Takip Paneli - Ayrı JSON Dosyaları v2.0</title>
  
  <!-- 🔇 GitHub API Error Suppression CSS -->
  <style>
    /* DevTools console error suppression (limited effectiveness) */
    .console-error-level[data-message*="github.com"],
    .console-error-level[data-message*="409"],
    .console-error-level[data-message*="Failed to load resource"] {
      display: none !important;
    }
    
    /* Network panel error suppression (limited effectiveness) */
    .network-log-grid .data-container .data-grid .data-grid-data-grid-node[data-url*="github.com"][data-status="409"] {
      display: none !important;
    }
  </style>
  
  <!--
  ╔══════════════════════════════════════════════════════════════════════════════════════════╗
  ║                            🔍 KOD REFERANS DOKÜMANTASYONU                                ║
  ╠══════════════════════════════════════════════════════════════════════════════════════════╣
  ║                                                                                          ║
  ║  📌 PROJE TODO / YOL HARİTASI (PM-xx)                                                   ║
  ║                                                                                          ║
  ║  [PM-01] Bu referans bloğu ve işaretleme                      — DURUM: Tamamlandı         ║
  ║  [PM-02] Satır içi TODO işaretleri (kritik noktalara)           — DURUM: Kısmi            ║
  ║  [PM-03] Hasta Modu Ayarları (dietType, activity, goal, goalPct, perKg) — Tamamlandı     ║
  ║  [PM-04] Hedef Makro Motoru (goalPct ≠ 0 → override)            — DURUM: Tamamlandı       ║
  ║  [PM-05] Kalıcılık: GitHub Contents API + local fallback        — DURUM: Tamamlandı       ║
  ║  [PM-06] Başlık Rozeti ve Popover (hedef kcal, gerçekleşen ort., Δ%, plan %, Hafta özel) — Tamamlandı ║
  ║  [PM-07] Öğün başlık eşleşmesi (Kahvaltı/Ara öğün katı; Öğle/Akşam esnek) — Tamamlandı    ║
  ║  [PM-08] Mevcut öğünlere oranlı hedef dağıtımı                  — DURUM: Tamamlandı       ║
  ║  [PM-09] Haftaya özel ayarlar (weeklyOverrides), “Sadece bu hafta”, “Temizle” — Tamamlandı ║
  ║  [PM-10] Hafta tabı değişiminde rozeti/popover’ı tazele         — DURUM: Tamamlandı       ║
  ║  [PM-11] Kilo Seyri Modalı (Seyir tablosu geniş sütunlarla)     — DURUM: Tamamlandı       ║
  ║  [PM-12] Ölçümler Sekmesi (bel, kalça, üst bacak S/L, diz S/L, baldır S/L, bilek S/L, üst kol S/L) — Tamamlandı ║
  ║  [PM-13] Ölçümleri kaydet (weeklyOverrides[hafta].measurements) — DURUM: Tamamlandı       ║
  ║  [PM-14] Mini Sparkline (kilo trendi, eksik haftaları interpolasyonla geçer) — Tamamlandı ║
  ║  [PM-15] Haftalık gerçekleşen ort. kcal desteği (opsiyonel)      — DURUM: Açık            ║
  ║  [PM-16] UI/UX iyileştirmeleri (renk/tooltip/erişilebilirlik)    — DURUM: Açık            ║
  ║                                                                                          ║
  ║  Not: PM-xx kodları dosya içinde // TODO[PM-xx]: ... işaretleriyle belirtilmiştir.       ║
  ║                                                                                          ║
  ║  📊 MAKRO HESAPLAMA SİSTEMİ - SATIR YAPILARI VE BULMA YÖNTEMLERİ                       ║
  ║                                                                                          ║
  ║  🎯 YEMEK SATIRLARI:                                                                     ║
  ║     • Selector: tr[data-sira-no="${item.siraNo}"]                                       ║
  ║     • Özellik: data-sira-no attribute ile kesin targeting                               ║
  ║     • Güncelleme: updateFoodTableRow() ~line 13350                                      ║
  ║     • Çağrılan yer: alternatifSec() ~line 13940                                         ║
  ║                                                                                          ║
  ║  📅 GÜN TOPLAM SATIRLARI:                                                                ║
  ║     • Format: "📅 PAZARTESİ", "📅 SALI" vs.                                             ║
  ║     • Alternatif: "1. Gün (Pazartesi)" formatı da desteklenir                          ║
  ║     • Güncelleme: updateTotalRows() içinde gün detection ~line 13580                    ║
  ║     • Pattern: /^\d+\.\s*Gün\s*\(/i veya 📅 ile başlayan                               ║
  ║                                                                                          ║
  ║  🍽️ ÖĞÜN TOPLAM SATIRLARI:                                                              ║
  ║     • Format: "🍽️ Kahvaltı", "🍽️ Öğle", "🍽️ Akşam" vs.                                ║
  ║     • Detection: textContent.includes('🍽️') ~line 13588                                ║
  ║     • Güncelleme: updateTotalRows() içinde öğün accumulation                           ║
  ║                                                                                          ║
  ║  📊 GÜNLÜK ORTALAMA SATIRI:                                                              ║
  ║     • Unique Text: "📊 GÜNLÜK ORTALAMA"                                                 ║
  ║     • Selector: textContent.includes('📊 GÜNLÜK ORTALAMA')                              ║
  ║     • Güncelleme: updateTotalRows() ~line 13683                                         ║
  ║     • NOT: Style-based selector KULLANILMAZ (17 satır buluyordu)                       ║
  ║                                                                                          ║
  ║  🔄 GÜNCELEME AKIŞI:                                                                     ║
  ║     1. alternatifSec() → Alternatif yemek seçimi                                        ║
  ║     2. updateFoodTableRow() → İlgili yemek satırını güncelle                           ║
  ║     3. updateTotalRows() → Tüm toplam satırlarını yeniden hesapla                      ║
  ║     4. setTimeout() → 100ms sonra force update                                          ║
  ║                                                                                          ║
  ║  📂 VERİ YAPISI:                                                                         ║
  ║     • window.currentFoodAnalysisData[index].eslesenYemek → Seçili yemek                ║
  ║     • .calories, .protein, .carbs, .fat → Makro değerleri                              ║
  ║     • .siraNo → Row targeting için unique ID                                            ║
  ║                                                                                          ║
  ║  🛠️ DEBUG SİSTEMİ:                                                                       ║
  ║     • "📊 DETAY: Kalori=X, Karb=Y..." → Günlük ortalama değerleri                      ║
  ║     • "📅 Güncellenen gün: X" → Gün totali güncelleme                                  ║
  ║     • "🍽️ Öğün toplamına eklendi: X" → Öğün totali güncelleme                          ║
  ║     • "🔄 Alternatif yemek seçildi: X" → Seçim detayları                               ║
  ║                                                                                          ║
  ║  🧱 SABİTLER / AYARLAR (global)                                                         ║
  ║     • DIET_PRESETS[dietType] → perKg (carbs/protein/fat) varsayılanları                ║
  ║     • ACTIVITY_FACTORS[level] → Aktivite katsayısı                                     ║
  ║     • GOAL_FACTORS[goal] → Hedef katsayısı (goalPct ≠ 0 ise YOK SAYILIR)               ║
  ║     • DEFAULT_MEAL_DISTRIBUTION → Öğünlere başlangıç dağılım yüzdeleri                 ║
  ║                                                                                          ║
  ║  🧠 KİLİT FONKSİYONLAR                                                                  ║
  ║     • findWeekOverride(settings, haftaNo) → Haftaya özel ayarı bul (sayı/strings key)  ║
  ║     • computeEffectiveSettingsFor(aktif) → Haftaya göre birleştirilmiş ayarlar          ║
  ║     • calcTargetsFromSettings(s) → goalPct override mantığıyla kcal/makro hesap         ║
  ║     • updateHedefKcalBadgeForSelectedPatient() → Rozeti güncelle                        ║
  ║     • toggleKcalPopover() → Popover’da özet + mevcut öğünlere göre dağılım              ║
  ║     • acHastaAyarlar(), clearActiveWeekOverride() → Ayarları aç/hafta özel temizle      ║
  ║     • acKiloSeyri() → Kilo Seyri modalı; Seyir tablosu + Ölçümler formu + sparkline     ║
  ║     • kiloSeyriKaydet() → Haftalık kiloları kaydet                                      ║
  ║     • renderOlcumForm(), olcumleriKaydet() → Ölçüm formu ve kaydetme                    ║
  ║     • renderSparkline(svgId, series) → Eksik haftaları atlayarak çiz; doğru interpolasyon║
  ║                                                                                          ║
  ╠══════════════════════════════════════════════════════════════════════════════════════════╣
  ║                                                                                          ║
  ║  🍽️ ÖĞÜN ALTERNATİF SİSTEMİ - BLOK BAZLI ÖĞÜN DEĞİŞTİRME                              ║
  ║                                                                                          ║
  ║  🎯 ANA FONKSİYONLAR:                                                                    ║
  ║     • alternatifleriGosterOgun(gunAdi, ogunAdi) → Ana entry point ~line 19650          ║
  ║     • getCurrentMealMacros(gunAdi, ogunAdi) → Mevcut öğün makro hesaplama ~line 19680  ║
  ║     • findCompatibleMealTemplates(ogunAdi, mevcutMakrolar) → Uygun şablon arama ~line   ║
  ║     • selectMealAlternative(gunAdi, ogunAdi, sablonId) → Alternatif seçme ~line 20010   ║
  ║     • replaceMealWithTemplate(gunAdi, ogunAdi, sablon) → Öğün değiştirme ~line 20040   ║
  ║                                                                                          ║
  ║  🔧 YARDIMCI FONKSİYONLAR:                                                               ║
  ║     • normalizeOgunAdi(ogunAdi) → Öğün adı normalizasyonu ~line 19750                  ║
  ║     • calculateTemplateMacros(sablon) → Şablon makro hesaplama ~line 19920             ║
  ║     • calculateMacroSimilarity(makro1, makro2) → Benzerlik skoru ~line 19950           ║
  ║     • showMealAlternativeModal() → Modal gösterme ~line 19980                          ║
  ║     • closeMealAlternativeModal() → Modal kapatma ~line 20200                          ║
  ║                                                                                          ║
  ║  📋 ŞABLON ARŞİVİ SİSTEMİ:                                                               ║
  ║     • mevcutSablonlar[] → Global şablon listesi                                         ║
  ║     • sablonlariYukle() → GitHub'dan şablon çekme ~line 20320                          ║
  ║     • Dosya: meal-templates.json (GitHub repository)                                    ║
  ║     • Yapı: {id, name, type, foods: [{name, calories, protein, carbs, fat}]}           ║
  ║                                                                                          ║
  ║  🎯 ÇALIŞMA PRENSİBİ:                                                                    ║
  ║     1. Öğün satırındaki "🔄 Alt" butonuna tıklanır                                     ║
  ║     2. Mevcut öğünün makroları hesaplanır (tüm yemeklerin toplamı)                     ║
  ║     3. Şablon arşivinden aynı tipteki öğünler filtrelenir                              ║
  ║     4. Makro benzerlik skoru hesaplanır (0-100 arası)                                  ║
  ║     5. En iyi 10 alternatif modal pencerede listelenir                                 ║
  ║     6. Seçilen şablonla mevcut öğün tamamen değiştirilir                               ║
  ║                                                                                          ║
  ║  📊 BENZERLIK ALGORITASI:                                                                ║
  ║     • Kalori farkı: %40 ağırlık                                                         ║
  ║     • Protein farkı: %20 ağırlık                                                        ║
  ║     • Karb farkı: %20 ağırlık                                                           ║
  ║     • Yağ farkı: %20 ağırlık                                                            ║
  ║     • Skor aralığı: 0-100 (100 = tamamen aynı makrolar)                                ║
  ║                                                                                          ║
  ║  🔄 VERİ AKIŞI:                                                                          ║
  ║     PDF Render → currentFoodAnalysisData → Öğün Grouping → Makro Hesaplama →           ║
  ║     Şablon Filtreleme → Benzerlik Skoru → UI Modal → Kullanıcı Seçimi →                ║
  ║     Öğün Silme → Şablon Ekleme → UI Güncelleme                                         ║
  ║                                                                                          ║
  ║  🚨 GLOBAL ATAMALAR:                                                                     ║
  ║     • window.alternatifleriGosterOgun                                                   ║
  ║     • window.selectMealAlternative                                                      ║
  ║     • window.closeMealAlternativeModal                                                  ║
  ║                                                                                          ║
  ║  ⚙️ SABİTLER / AYARLAR (window.*)                                                        ║
  ║     • GITHUB_REPO_DEFAULT / GITHUB_REPO → Varsayılan repo (owner/repo)                  ║
  ║     • GITHUB_DEFAULT_BRANCH → Git işlemleri branch adı                                  ║
  ║     • TOKEN_KEY → localStorage anahtarı (github_api_token)                              ║
  ║     • UI_COL_WIDTHS { macro: 60, actions: 240 } → Tablo sütun genişlikleri              ║
  ║     • SUGGESTION_LIMIT → Öneri listelerinde maksimum öğe sayısı                         ║
  ║     • MIN_QUERY_LEN → Akıllı arama tetikleme eşiği                                      ║
  ║     • FEATURE_FLAGS { AUTO_SYNC } → Token varsa otomatik senkron                        ║
  ║                                                                                          ║
  ║  🧠 AKILLI ARAMA (Yemek Adı)                                                             ║
  ║     • initYemekAdiSmartSearch() → Dropdown; scrollbar tıklandığında kapanmaz            ║
  ║     • Seçimde otomatik doldurma: makrolar/kategori/etiketler                            ║
  ║     • Kayıt semantiği: modal.dataset.selectedDbName/Id ile eşleşme/alias kararı         ║
  ║     • Limit/Eşik: SUGGESTION_LIMIT, MIN_QUERY_LEN                                       ║
  ║                                                                                          ║
  ║  🖼️ TABLO DÜZENİ / BUTON GÖRÜNÜRLÜĞÜ                                                    ║
  ║     • table-layout: fixed + colgroup; makrolar dar (UI_COL_WIDTHS.macro)                ║
  ║     • İşlemler sütunu sabit genişlikte (UI_COL_WIDTHS.actions), sağdaki 4 buton sabit   ║
  ║     • Öğün başlık butonları: ilk hücre içinde sağ hizalı (orijinal konum)               ║
  ║                                                                                          ║
  ║  ⚡ OPTİMİSTİK KAYIT AKIŞI (food_list düzenleme)                                         ║
  ║     • yemekGithubKaydet():                                                               ║
  ║         - Önce local cache: window.lastSavedFoodData güncellenir                        ║
  ║         - flattenFoodDataToGlobal() → autocomplete/matching tazelenir                   ║
  ║         - updateYemekVeritabaniAnalizi() + updateTotalRows() çağrılır                   ║
  ║         - eslesmeyenlerListesiniGuncelle() ile side-bar güncellenir                     ║
  ║         - GitHub hata alırsa rollback (prev snapshot)                                   ║
  ║     • Dedup/Move: İsim/kategori değişimde tek kanonik kayıt korunur                     ║
  ║                                                                                          ║
  ║  🌐 GITHUB ENTEGRASYONU                                                                  ║
  ║     • Okuma: raw.githubusercontent.com (public) veya API üzerinden                      ║
  ║     • Yazma: api.github.com/repos/.../contents (PUT, base64 content, sha)               ║
  ║     • Branch: GITHUB_DEFAULT_BRANCH                                                     ║
  ║     • Token: UI input + localStorage(TOKEN_KEY)                                         ║
  ║     • Hastalar: patients/<hastaId>/hasta_data.json; listeler: patients/hastalar_listesi ║
  ║     • PDF: pdfs/ klasörüne yüklenir; URL'ler branch sabitine göre üretilir              ║
  ║                                                                                          ║
  ║  🔧 HIZLI DEBUG REFERANSI                                                                ║
  ║     • window.currentFoodAnalysisData → Satır/makro ve siraNo hedefleme                  ║
  ║     • window.globalFoodListFlat → Autocomplete/matching kaynağı                         ║
  ║     • window.lastSavedFoodData / lastSavedFoodDataTs → Optimistik JSON cache            ║
  ║     • localStorage.getItem('github_api_token') → Token kontrol                          ║
  ║                                                                                          ║
  ╚══════════════════════════════════════════════════════════════════════════════════════════╝
  -->
  
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiByeD0iNCIgZmlsbD0iIzAwN2NmZiIvPgo8cGF0aCBkPSJNMTEgMTBoMTB2MkgxMXptMCA0aDd2MmgtN3ptMCA0aDEwdjJIMTF6IiBmaWxsPSJ3aGl0ZSIvPgo8L3N2Zz4K" />
  
  <!-- PDF.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
  
  <!-- FontAwesome Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  
  <!-- JSZip -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  
  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- Türkçe karakter desteği için font ekle -->
  <script>
    // jsPDF font encoding düzeltmesi
    window.fixTurkishChars = function(text) {
      if (!text || typeof text !== 'string') return text;
      return text
        .replace(/Ş/g, 'S').replace(/ş/g, 's')
        .replace(/Ğ/g, 'G').replace(/ğ/g, 'g')
        .replace(/İ/g, 'I').replace(/ı/g, 'i')
        .replace(/Ç/g, 'C').replace(/ç/g, 'c')
        .replace(/Ö/g, 'O').replace(/ö/g, 'o')
        .replace(/Ü/g, 'U').replace(/ü/g, 'u');
    };
  </script>
  
  <!--
    ==============================================================================
    📌 GENEL AYARLAR & GELİŞTİRİCİ REHBERİ (CONFIG + QUICK MAP)
    ==============================================================================
    Bu bölüm, uygulamada sık ayarlanan sabitleri ve kritik fonksiyonların hızlı
    referansını içerir. Davranışı değiştirmeden önce bu sabitleri gözden geçirin.

    [GitHub Ayarları]
    - GITHUB_REPO_DEFAULT: UI boşsa kullanılacak varsayılan repo (owner/repo)
    - GITHUB_DEFAULT_BRANCH: Git işlemleri için branch adı
    - TOKEN_KEY: localStorage anahtarı (UI inputu ile birlikte çalışır)

    [UI Düzeni]
    - UI_COL_WIDTHS.macro: Makro sütunları px genişliği (Kalori/Karb/Protein/Yağ)
    - UI_COL_WIDTHS.actions: İşlemler sütunu px (sağdaki 4 buton)

    [Arama/Autocomplete]
    - SUGGESTION_LIMIT: Akıllı aramada gösterilecek öneri sayısı
    - MIN_QUERY_LEN: Aramanın başlaması için minimum karakter (0 = her tuşta)

    [Özellik Bayrakları]
    - FEATURE_FLAGS.AUTO_SYNC: Token varsa arka planda GitHub tazelemesi

    [Önemli Fonksiyon Haritası] (isime göre aratın)
    - initYemekAdiSmartSearch(): Solda 'Yemek Adı' akıllı arama & dropdown
    - flattenFoodDataToGlobal(foodData): Global flat liste (autocomplete/match)
    - yemekGithubKaydet(yemekData, mod, originalData): food_list düzenleme + optimistik UI
    - updateTotalRows(): Gün/öğün/günlük ortalama toplam satırlarını günceller
    - alternatifleriGosterOgun(): Öğün bazlı alternatif modalını açar
    - pdfYukleGithub(file, hastaId, haftaNo): PDF yükleme akışı

    Not: Bu sabitler window.* altında tutulur; konsoldan geçici değişiklik yapılabilir.
    ==============================================================================
  -->
  <script>
    // 🐛 DEBUG MODLARI - Console'da window.DEBUG_GITHUB_API = true yaparak aktifleştirin
    window.DEBUG_GITHUB_API = false; // GitHub API detaylarını göster/gizle
    window.DEBUG_VERBOSE = false;    // Tüm verbose logları göster/gizle
    // Alternatif motoru için özel debug bayrağı
    window.DEBUG_ALT = false;        // Hedefe göre alternatif seçimi logları
    window.logAlt = function(...args) {
      try { if (window.DEBUG_VERBOSE || window.DEBUG_ALT) console.log('[ALT]', ...args); } catch {}
    };
    
    // 🚥 GitHub API THROTTLING - 409 hatalarını azaltmak için
    window.GITHUB_API_QUEUE = [];
    window.GITHUB_API_PROCESSING = false;
    window.GITHUB_API_DELAY = 500; // API çağrıları arası minimum gecikme (ms)
    
    // GitHub
    window.GITHUB_REPO_DEFAULT = 'mustafasacar35/lipodem-takip-paneli-4';
    // Uyum için alias: bazı yerlerde GITHUB_REPO bekleniyor
    window.GITHUB_REPO = window.GITHUB_REPO_DEFAULT;
  // Varsayılan branch'i zorlamayalım; boş bırakılırsa repo'nun default branch'i kullanılır
  window.GITHUB_DEFAULT_BRANCH = '';
    window.TOKEN_KEY = 'github_api_token';

    // UI
  window.UI_COL_WIDTHS = { macro: 80, actions: 240 };

    // Autocomplete
    window.SUGGESTION_LIMIT = 10;
    window.MIN_QUERY_LEN = 0;

    // Özellik bayrakları
    window.FEATURE_FLAGS = { AUTO_SYNC: true };

    // =============================
    // 🧩 DİYET / MAKRO AYARLARI
    // =============================
    // TODO[PM-03]: Bu presets, Ayarlar modalında düzenlenebilir yapılacak ve kaydedilecek.
    window.DIET_PRESETS = {
      keto: { name: 'Ketojenik', carbsPerKg: 0.3, proteinPerKg: 0.8, fatPerKg: 1.2 },
      lowcarb: { name: 'LowCarb', carbsPerKg: 0.6, proteinPerKg: 0.8, fatPerKg: 1.0 }
    };

    // Aktivite düzeyi çarpanları (1-5)
    // 1→0.8, 2→0.9, 3→1.0, 4→1.1, 5→1.2
    window.ACTIVITY_FACTORS = { 1: 0.8, 2: 0.9, 3: 1.0, 4: 1.1, 5: 1.2 };

    // Hedef türü çarpanları (şimdilik 1.0 sabit; ileride defisit/sürdürme/sürüm)
    // TODO[PM-03]: Ayarlardan değiştirilebilir hale getir.
    window.GOAL_FACTORS = { maintain: 1.0, deficit: 0.9, surplus: 1.1 };

    // Öğün dağılımı varsayılanları (% olarak, toplam 100)
    // Şimdilik: Kahvaltı 10, Öğle 40, Akşam 50, Ara 5 (toplam 105 → normalize edilecek)
    // Not: Kullanıcı ara öğün yoksa 0 yazabilir; normalize edici fonksiyon oransal dağıtır.
    window.DEFAULT_MEAL_DISTRIBUTION = {
      kahvalti: 10,
      ogle: 40,
      aksam: 50,
      ara: 5
    };

    // Tolerans bantları (öneri motoru için) — bilgi/uyarı/kritik
    // TODO[PM-08]: Öneri kurallarında kullanılacak (şimdilik dokümantatif).
    window.TOLERANCE_BANDS = { info: 0.05, warn: 0.10, critical: 0.15 };

    // =============================
    // 🎯 SMART ALT: Hedefe Göre Akıllı Seçim (Config + Helpers)
    // =============================
    // Not: Bu bölüm öneri motoru için global ayarlar ve yardımcıları içerir.
    // İlerleyen adımlarda alternatif seçim/puanlama bu ayarları kullanacak.
    (function initSmartAlt() {
      const KEY = 'smart_alt_settings_v1';
      const UNDO_KEY = 'smart_alt_undo_v1';

      // Varsayılanlar (MVP)
      const DEFAULTS = {
        enabled: true,
        // Kalori ve makro toleransları (± oran)
        kcalTolerance: 0.10, // ±%10
        macroTolerance: { protein: 0.15, fat: 0.15, carbs: 0.20 },
        // Skor ağırlıkları: kcal > fat > protein > carbs
        weights: { kcal: 0.50, fat: 0.25, protein: 0.15, carbs: 0.10 },
        // Katı filtreler
        enforce: {
          mealType: true,
          role: true,
          category: true,
          compatibility: true,
          fillerLunchDinner: true
        },
        // Tercihler
        likesBoost: 0.05, // beğenilenlere küçük artı puan
        dislikesPenalty: 0.10, // sevilmeyene eksi puan
        // Porsiyon ölçekleme (fallback)
        portionScaling: { enabled: true, step: 0.10, min: 0.5, max: 1.5 },
        // Undo (kaç adım takip edilsin)
        undoStackLimit: 20
      };

      function loadSettings() {
        try { const raw = localStorage.getItem(KEY); return raw ? { ...DEFAULTS, ...JSON.parse(raw) } : { ...DEFAULTS }; }
        catch { return { ...DEFAULTS }; }
      }

      function saveSettings(cfg) {
        try { localStorage.setItem(KEY, JSON.stringify(cfg || window.SMART_ALT)); } catch {}
      }

      // Undo yığını (sadece hafif snapshot bilgisi; ileride genişletilecek)
      function loadUndo() {
        try { const raw = localStorage.getItem(UNDO_KEY); return Array.isArray(JSON.parse(raw)) ? JSON.parse(raw) : []; } catch { return []; }
      }
      function saveUndo(stack) { try { localStorage.setItem(UNDO_KEY, JSON.stringify(stack || [])); } catch {} }
      function pushUndo(snapshot) {
        try {
          if (!snapshot) return;
          const st = loadUndo();
          st.push(snapshot);
          const limit = (window.SMART_ALT && window.SMART_ALT.undoStackLimit) || DEFAULTS.undoStackLimit;
          while (st.length > limit) st.shift();
          saveUndo(st);
        } catch {}
      }
      function popUndo() {
        try { const st = loadUndo(); const v = st.pop(); saveUndo(st); return v; } catch { return null; }
      }
      function peekUndo() { try { const st = loadUndo(); return st.length ? st[st.length - 1] : null; } catch { return null; } }

      // Öğün adı normalize
      function safeNormalizeOgunAdi(name) {
        try { return (typeof normalizeOgunAdi === 'function') ? normalizeOgunAdi(name) : (name || '').toLowerCase(); }
        catch { return (name || '').toLowerCase(); }
      }

      // Aday yemeğin katı kurallara uyumunu kontrol eden yardımcı (ileride kullanılacak)
      function isCandidateCompliant(candidate, currentFood, context) {
        try {
          const cfg = window.SMART_ALT || DEFAULTS;
          if (!candidate) return false;

          const ogun = safeNormalizeOgunAdi(context?.ogun || '');
          // 1) mealType
          if (cfg.enforce.mealType) {
            const mt = Array.isArray(candidate.mealType) ? candidate.mealType.map(s => String(s).toLowerCase()) : [];
            if (ogun && mt.length && !mt.includes(ogun)) return false;
          }
          // 2) role (aynı rol tercih edilir; yoksa esnek)
          if (cfg.enforce.role) {
            const curRole = (currentFood && currentFood.role) ? String(currentFood.role).toLowerCase() : null;
            const candRole = (candidate.role) ? String(candidate.role).toLowerCase() : null;
            if (curRole && candRole && curRole !== candRole) return false;
          }
          // 3) category (aynı kategori tercih; farklı ise elersek daha katı olur)
          if (cfg.enforce.category) {
            const curCat = (currentFood && currentFood.category) ? String(currentFood.category).toLowerCase() : null;
            const candCat = (candidate.category) ? String(candidate.category).toLowerCase() : null;
            if (curCat && candCat && curCat !== candCat) return false;
          }
          // 4) filler (özel kural: sadece öğle/akşamda izinli işaretli ise)
          if (cfg.enforce.fillerLunchDinner) {
            const isFiller = !!(candidate.fillerLunch || candidate.fillerDinner);
            if (isFiller) {
              if (ogun === 'kahvalti' || ogun === 'ara') return false;
              // Öğle→ fillerLunch; Akşam→ fillerDinner
              if (ogun === 'ogle' && candidate.fillerLunch !== true) return false;
              if (ogun === 'aksam' && candidate.fillerDinner !== true) return false;
            }
          }
          // 5) compatibility tags (basit kesişim kontrolü; yoksa esnek)
          if (cfg.enforce.compatibility) {
            const curTags = Array.isArray(currentFood?.compatibilityTags) ? currentFood.compatibilityTags.map(String) : [];
            const candTags = Array.isArray(candidate.compatibilityTags) ? candidate.compatibilityTags.map(String) : [];
            if (curTags.length && candTags.length) {
              const hasAny = candTags.some(t => curTags.includes(t));
              if (!hasAny) return false;
            }
          }
          // Karaliste (global helper varsa kullan)
          try {
            if (typeof isBlacklisted === 'function') {
              const nm = candidate.originalName || candidate.name || '';
              if (nm && isBlacklisted(nm)) return false;
            }
          } catch {}
          
          // 6) keto/lowcarb uyumluluğu (mevcut yemekle uyumlu olmalı)
          if (currentFood) {
            const curKeto = !!(currentFood.keto);
            const curLowCarb = !!(currentFood.lowcarb);
            const candKeto = !!(candidate.keto);
            const candLowCarb = !!(candidate.lowcarb);
            
            // Keto yemek yerine keto olmayan konulamaz
            if (curKeto && !candKeto) return false;
            // LowCarb yemek yerine lowcarb olmayan konulamaz (keto yoksa)
            if (curLowCarb && !curKeto && !candLowCarb && !candKeto) return false;
          }
          
          return true;
        } catch { return false; }
      }

      // Dışa aç (global)
      window.SMART_ALT_DEFAULTS = DEFAULTS;
      window.SMART_ALT = loadSettings();
      window.getSmartAltSettings = () => ({ ...window.SMART_ALT });
      window.saveSmartAltSettings = (cfg) => { window.SMART_ALT = { ...window.SMART_ALT, ...(cfg || {}) }; saveSettings(window.SMART_ALT); };
      window.resetSmartAltSettings = () => { window.SMART_ALT = { ...DEFAULTS }; saveSettings(window.SMART_ALT); };
      window.pushSmartAltUndo = pushUndo;
      window.popSmartAltUndo = popUndo;
      window.peekSmartAltUndo = peekUndo;
      window.isSmartAltCandidateCompliant = isCandidateCompliant;
    })();

    // =============================
    // 🔢 Yardımcı: Hedef Makro Hesaplama
    // =============================
    // TODO[PM-04]: Ayarlar modalındaki değerlerle entegre et ve UI'ya yazdır.
    window.computeTargetMacros = function(weightKg, dietType = 'lowcarb', activityLevel = 3, goal = 'maintain') {
      try {
        const preset = (window.DIET_PRESETS && window.DIET_PRESETS[dietType]) || window.DIET_PRESETS.lowcarb;
        const af = (window.ACTIVITY_FACTORS && window.ACTIVITY_FACTORS[activityLevel]) || 1.0;
        const gf = (window.GOAL_FACTORS && window.GOAL_FACTORS[goal]) || 1.0;
        const factor = af * gf;
        // g cinsinden hedef makrolar (kilo × katsayı × faktör)
        const carbs = round1(weightKg * (preset?.carbsPerKg ?? 0) * factor);
        const protein = round1(weightKg * (preset?.proteinPerKg ?? 0) * factor);
        const fat = round1(weightKg * (preset?.fatPerKg ?? 0) * factor);
        const calories = Math.round(carbs * 4 + protein * 4 + fat * 9);
        return { carbs, protein, fat, calories };
      } catch (e) {
        console.error('computeTargetMacros error', e);
        return { carbs: 0, protein: 0, fat: 0, calories: 0 };
      }
      function round1(n) { return Math.round(n * 10) / 10; }
    };

    function findWeekOverride(settingsObj, haftaNo) {
      try {
        if (!settingsObj || !settingsObj.weeklyOverrides) return { has: false, override: null };
        const w = settingsObj.weeklyOverrides || {};
        const keyStr = String(haftaNo);
        const ov = (w[keyStr] !== undefined) ? w[keyStr] : w[haftaNo];
        return { has: !!ov, override: ov || null };
      } catch (e) {
        console.warn('findWeekOverride warn', e);
        return { has: false, override: null };
      }
    }

    async function clearActiveWeekOverride() {
      try {
        const aktif = (typeof getCurrentHasta === 'function') ? getCurrentHasta() : null;
        let haftaNo = null;
        const haftaListesi = (typeof getHaftaListesi === 'function') ? getHaftaListesi() : [];
        const idx = (typeof getAktifHaftaIndex === 'function') ? getAktifHaftaIndex() : (haftaListesi.length ? haftaListesi.length - 1 : 0);
        haftaNo = (haftaListesi?.[idx]?.haftaNo) || (idx + 1);
        if (!haftaNo || !aktif?.id) return;

        if (!confirm('Bu haftanın özel ayarını silmek istediğinize emin misiniz?\nBu işlemden sonra global ayarlar kullanılacaktır.')) return;
        const btn = document.getElementById('clearWeekOverrideBtn');
        let prevText = null;
        if (btn) { prevText = btn.textContent; btn.disabled = true; btn.style.opacity = '0.7'; }

        const gh = (typeof getGithubRepoAndToken === 'function') ? getGithubRepoAndToken() : null;
        let mevcut = null;
        if (gh) {
          try { mevcut = await githubGetFileJson(`patients/${aktif.id}/settings.json`, true); } catch {}
        }
        if (!mevcut) {
          try { mevcut = (typeof loadUserSettingsLocal === 'function') ? loadUserSettingsLocal(aktif.id) : null; } catch {}
        }
        mevcut = mevcut || {};
        const w = { ...(mevcut.weeklyOverrides || {}) };
        if (w[String(haftaNo)] || w[haftaNo]) {
          delete w[String(haftaNo)];
          delete w[haftaNo];
        }
        const yeni = Object.keys(w).length > 0 ? { ...mevcut, weeklyOverrides: w } : (() => { const tmp = { ...mevcut }; delete tmp.weeklyOverrides; return tmp; })();
        // Local'e yaz
        if (typeof saveUserSettingsLocal === 'function') saveUserSettingsLocal(aktif.id, yeni);
        // GitHub'a yaz (varsa)
        if (gh) {
          try { await githubPutFileJson(`patients/${aktif.id}/settings.json`, yeni, `chore(settings): clear week ${haftaNo} override for ${aktif.id}`); }
          catch (e) { console.warn('GitHub clear week override uyarısı:', e?.message || e); }
        }
        // Cache'i güncelle
        try { window.__cachedWeeklyOverrides = { ...(yeni.weeklyOverrides || {}) }; } catch {}
        // UI güncelle
        if (typeof updateHedefKcalBadgeForSelectedPatient === 'function') await updateHedefKcalBadgeForSelectedPatient();
        if (btn) {
          btn.style.display = 'none';
          btn.disabled = false;
          btn.style.opacity = '';
          if (prevText !== null) btn.textContent = prevText;
        }
        if (typeof showToast === 'function') showToast('Bu haftanın özel ayarı temizlendi', 'success');
      } catch (e) {
        console.error('clearActiveWeekOverride', e);
        alert('Hafta ayarı temizlenemedi: ' + (e?.message || e));
      }
    }

    // =============================
    // 🍽️ ÖĞÜN DAĞILIMI NORMALİZASYON
    // =============================
    // Girilen dağılımın toplamını 100'e ölçekler; eksik öğün(=0) varsa kalanları oransal dağıtır.
    // Çıktı tamsayı (yuvarlama sonrası toplam 100 tutulur)
    // TODO[PM-07]: UI sliderları ile bağla ve eksik öğünde 0 bırak.
    window.normalizeMealDistribution = function(dist) {
      const keys = ['kahvalti', 'ogle', 'aksam', 'ara'];
      const src = { ...window.DEFAULT_MEAL_DISTRIBUTION, ...(dist || {}) };
      // Negatifleri 0 yap
      keys.forEach(k => { if (!isFinite(src[k]) || src[k] < 0) src[k] = 0; });
      const sum = keys.reduce((a, k) => a + src[k], 0);
      if (sum === 100) return { ...src };

      // Eğer toplam 0 ise varsayılanı döndür
      if (sum <= 0) return { ...window.DEFAULT_MEAL_DISTRIBUTION };

      // Oransal ölçekle ve tamsayılaştır (en büyük kalana ekle)
      const scaled = keys.map(k => (src[k] / sum) * 100);
      const ints = scaled.map(x => Math.floor(x));
      let remainder = 100 - ints.reduce((a, b) => a + b, 0);
      // Kalanı, en büyük kesir paylarına dağıt
      const fractions = scaled.map((x, i) => ({ i, frac: x - Math.floor(x) }));
      fractions.sort((a, b) => b.frac - a.frac);
      for (let j = 0; j < remainder; j++) {
        const idx = fractions[j % fractions.length].i;
        ints[idx] += 1;
      }
      return { kahvalti: ints[0], ogle: ints[1], aksam: ints[2], ara: ints[3] };
    };

    // =============================
    // 💾 Basit Kalıcılık Yardımcıları (local)
    // =============================
    // TODO[PM-05]: GitHub JSON'a senkron eklenecek; şimdilik localStorage.
    window.saveUserSettingsLocal = function(hastaId, settings) {
      try {
        const key = `user_settings_${hastaId || 'default'}`;
        localStorage.setItem(key, JSON.stringify(settings));
        return true;
      } catch (e) { console.error('saveUserSettingsLocal', e); return false; }
    };

    window.loadUserSettingsLocal = function(hastaId) {
      try {
        const key = `user_settings_${hastaId || 'default'}`;
        const raw = localStorage.getItem(key);
        return raw ? JSON.parse(raw) : null;
      } catch (e) { console.error('loadUserSettingsLocal', e); return null; }
    };

    // =============================
    // 🔐 DEMO AUTH İŞARETİ
    // =============================
    // TODO[PM-09]: Kullanıcı adı + PIN akışı; GitHub'da hash saklama; admin impersonation.
    window.DEMO_AUTH_ENABLED = true;
  </script>
  
  <style>
    /* Tab Navigation Styles */
    .tab-button {
      transition: all 0.3s ease !important;
    }
    
    .tab-button.active {
      background: #e8f5e8 !important;
      border-bottom: 3px solid #28a745 !important;
      color: #28a745 !important;
      font-weight: 600 !important;
    }
    
    .tab-button:hover {
      background: #f8f9fa !important;
    }
    
    /* Şablon Kaydetme Modal Styles */
    #sablonKaydetModal input:focus,
    #sablonKaydetModal select:focus {
      border-color: #007bff !important;
      box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1) !important;
      outline: none !important;
    }
    
    #sablonKaydetModal input:invalid {
      border-color: #dc3545 !important;
    }
    
    #sablonKaydetModal button:hover {
      transform: translateY(-1px) !important;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2) !important;
    }
    
    /* Hızlı Filtre Butonları */
    .hizli-filtre {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      color: #495057;
      padding: 6px 12px;
      border-radius: 15px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
      white-space: nowrap;
    }
    
    .hizli-filtre:hover {
      background: #e9ecef;
      border-color: #adb5bd;
    }
    
    .hizli-filtre.active {
      background: #20c997;
      color: white;
      border-color: #20c997;
    }
    
    /* Yemek Liste Kartları */
    .yemek-kart {
      background: white;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .yemek-kart:hover {
      border-color: #20c997;
      box-shadow: 0 2px 8px rgba(32, 201, 151, 0.15);
      transform: translateY(-1px);
    }
    
    .yemek-kart.selected {
      border-color: #20c997;
      background: #e8f8f5;
      box-shadow: 0 0 0 2px rgba(32, 201, 151, 0.2);
    }
    
    .yemek-kart-header {
      padding: 12px 15px 8px 15px;
      border-bottom: 1px solid #f8f9fa;
    }
    
    .yemek-kart-body {
      padding: 8px 15px 12px 15px;
      font-size: 13px;
      color: #666;
    }
    
    /* Kısa Mesaj Sistemi */
    .toast-message {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #28a745;
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      font-weight: bold;
      font-size: 14px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 10000;
      animation: slideIn 0.3s ease-out;
    }
    
    .toast-message.error {
      background: #dc3545;
    }
    
    .toast-message.warning {
      background: #ffc107;
      color: #212529;
    }
    
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    body { 
      font-family: sans-serif; 
      margin: 0; 
      padding: 0; 
      background: #f7f7f7; 
      overflow-x: hidden;
    }
    
    /* Main Layout */
    .main-container {
      display: grid;
      grid-template-columns: 320px 4px 1fr 4px 200px;
      grid-template-rows: 60px 1fr;
      height: 100vh;
      gap: 0;
    }
    
    /* Resizable handles */
    .resize-handle {
      background: #e9ecef;
      cursor: ew-resize;
      border-left: 1px solid #dee2e6;
      border-right: 1px solid #dee2e6;
      position: relative;
      transition: background-color 0.2s;
    }
    
    .resize-handle:hover {
      background: #6c757d;
    }
    
    .resize-handle:before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 2px;
      height: 20px;
      background: #6c757d;
      border-radius: 1px;
    }
    
    .resize-handle:hover:before {
      background: white;
    }
    
    /* Header */
    .header {
      grid-column: 1 / -1;
      background: #343a40;
      color: white;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .header h2 {
      margin: 0;
      font-size: 18px;
    }
    
    /* Sol Sidebar */
    .left-sidebar {
      background: white;
      border-right: 1px solid #ddd;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
    }
    
    .sidebar-section {
      border-bottom: 1px solid #eee;
      padding: 15px;
    }
    
    .sidebar-section h3 {
      margin: 0 0 10px 0;
      font-size: 14px;
      color: #495057;
      text-transform: uppercase;
      border-bottom: 2px solid #007bff;
      padding-bottom: 5px;
    }
    
    /* Hasta Listesi */
    #hastaListesi {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    
    #hastaListesi li {
      padding: 8px 12px;
      cursor: pointer;
      border-radius: 4px;
      margin-bottom: 2px;
      font-size: 13px;
      transition: background 0.2s;
    }
    
    #hastaListesi li:hover {
      background: #f8f9fa;
    }
    
    /* Seçili hasta stili */
    #hastaListesi li.secili-hasta {
      position: relative;
      border: 2px solid #dc3545 !important;
      box-shadow: 0 0 10px rgba(220, 53, 69, 0.3) !important;
      transform: scale(1.02) !important;
    }
    
    #hastaListesi li.secili-hasta::after {
      content: '👈 SEÇİLİ';
      position: absolute;
      top: 50%;
      right: 8px;
      transform: translateY(-50%);
      background: #dc3545;
      color: white;
      padding: 2px 6px;
      border-radius: 10px;
      font-size: 9px;
      font-weight: bold;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0% { opacity: 1; transform: translateY(-50%) scale(1); }
      50% { opacity: 0.7; transform: translateY(-50%) scale(1.1); }
      100% { opacity: 1; transform: translateY(-50%) scale(1); }
    }
    
    /* Orta Panel */
    .center-panel {
      display: flex;
      flex-direction: column;
      background: white;
      overflow-y: auto;
    }
    
    /* Sağ Sidebar */
    .right-sidebar {
      background: white;
      border-left: 1px solid #ddd;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
    }
    
    /* Sistem Durumu Kompakt */
    .sistem-durumu-kompakt {
      background: #e9ecef;
      padding: 8px;
      border-radius: 4px;
      font-size: 11px;
      line-height: 1.3;
    }
    
    .sistem-durumu-kompakt .durum-item {
      display: block;
      margin-bottom: 3px;
    }
    
    /* Kompakt Grid */
    .kompakt-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-bottom: 15px;
    }
    
    .kompakt-box {
      padding: 12px;
      border-radius: 6px;
      border-left: 3px solid;
    }
    
    .pdf-box {
      background: #f8f9fa;
      border-left-color: #28a745;
    }
    
    .aciklama-box {
      background: #d1ecf1;
      border-left-color: #17a2b8;
    }
    
    textarea, input[type="file"] { width: 100%; margin-bottom: 10px; }
    button { padding: 10px 20px; }
    .matched img { width: 150px; margin: 5px; border: 1px solid #ccc; }
    
    /* Tab Sistemi CSS */
    .hafta-tabs {
      display: flex !important;
      flex-wrap: wrap !important;
      border-bottom: 2px solid #ddd;
      margin-bottom: 20px;
      background: #f8f9fa;
      padding: 5px;
      border-radius: 8px 8px 0 0;
      gap: 5px;
    }
    
    .hafta-tab {
      background: #e9ecef;
      border: 1px solid #ddd;
      border-bottom: none;
      padding: 10px 15px;
      margin-right: 3px;
      margin-bottom: 3px;
      cursor: pointer;
      border-radius: 8px 8px 0 0;
      transition: all 0.3s ease;
      min-width: 120px;
      max-width: 160px;
      text-align: center;
      position: relative;
      flex: 0 0 auto;
    }
    
    .hafta-tab:hover {
      background: #dee2e6;
      transform: translateY(-2px);
    }
    
    .hafta-tab.active {
      background: #fff;
      border-color: #007bff;
      border-width: 2px;
      font-weight: bold;
      color: #007bff;
      transform: translateY(-3px);
      box-shadow: 0 3px 10px rgba(0,123,255,0.2);
    }
    
    .hafta-tab-content {
      display: none;
      border: 2px solid #ddd;
      padding: 20px;
      border-radius: 0 8px 8px 8px;
      background: #fff;
      min-height: 400px;
    }
    
    .hafta-tab-content.active {
      display: block;
      animation: fadeIn 0.3s ease-in;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .hafta-tab-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
    }
    
    .hafta-no-input {
      width: 50px;
      font-weight: bold;
      text-align: center;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 5px;
    }
    
    .tab-status-indicators {
      display: flex;
      gap: 5px;
      margin-top: 5px;
      justify-content: center;
    }
    
    .status-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      display: inline-block;
    }
    
    .status-pdf { background: #28a745; }
    .status-kartlar { background: #ffc107; }
    .status-eslesen { background: #17a2b8; }
    .status-empty { background: #dc3545; }
    .status-locked { background: #fd7e14; }
    
    /* Kilit ikonu stili */
    .tab-lock-icon {
      position: absolute;
      top: 2px;
      right: 2px;
      font-size: 10px;
      color: #fd7e14;
      text-shadow: 0 0 2px rgba(0,0,0,0.5);
    }
    
    /* Kilitli hafta stili */
    .hafta-tab.locked {
      background: linear-gradient(135deg, #fff 0%, #fff5e6 100%);
      border-color: #fd7e14;
      position: relative;
    }
    
    .hafta-tab.locked.active {
      background: linear-gradient(135deg, #fff 0%, #fff5e6 100%);
      border-color: #fd7e14;
      color: #fd7e14;
    }
    
    /* Kayıt butonu stili */
    .kayit-btn {
      background: #28a745;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      font-weight: bold;
      transition: all 0.3s ease;
    }
    
    .kayit-btn:hover {
      background: #218838;
      transform: translateY(-1px);
    }
    
    .kayit-btn.saved {
      background: #6c757d;
      cursor: default;
    }
    
    .kayit-btn.saved:hover {
      transform: none;
    }
    
    /* Kilit açma butonu */
    .kilit-ac-btn {
      background: #fd7e14;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 11px;
      margin-left: 8px;
    }
    
    .kilit-ac-btn:hover {
      background: #e8630a;
    }
    
    /* Kilitli alan stili */
    .locked-area {
      position: relative;
      opacity: 0.6;
    }
    
    /* Kilitli alandaki input ve textarea'ları devre dışı bırak */
    .locked-area input,
    .locked-area textarea {
      pointer-events: none;
    }
    
    /* ZIP butonları her zaman aktif kalacak */
    .locked-area button[onclick*="zipEslesenGorseller"],
    .locked-area button[onclick*="haftaZipIndir"],
    .locked-area button[onclick*="kopyalaGptMesaj"] {
      pointer-events: auto !important;
      opacity: 1 !important;
    }
    
    .locked-area::before {
      content: '🔒 Bu alan kilitli - Kilidi açmak için kilit açma butonunu kullanın';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(253, 126, 20, 0.9);
      color: white;
      padding: 8px 12px;
      border-radius: 4px;
      font-size: 11px;
      z-index: 10;
      white-space: nowrap;
      pointer-events: none;
    }
    
    .yeni-hafta-tab {
      background: #28a745;
      color: white;
      border-color: #28a745;
      font-weight: bold;
    }
    
    .yeni-hafta-tab:hover {
      background: #218838;
      transform: translateY(-2px);
    }
    
    /* Hafta numarası düzenleme */
    .hafta-no-display {
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 4px;
      transition: all 0.2s ease;
      border: 1px solid transparent;
    }
    
    .hafta-no-display:hover {
      background: #e3f2fd;
      border-color: #90caf9;
      transform: scale(1.05);
    }
    
    /* Grid responsive */
    @media (max-width: 768px) {
      .hafta-tab-content > div:first-of-type {
        grid-template-columns: 1fr !important;
      }
      
      /* Hasta bilgi paneli responsive */
      #hastaBilgiPanel {
        padding: 8px 10px !important;
      }
      
      #hastaBilgiPanel h3 {
        font-size: 14px !important;
      }
      
      #hastaBilgiPanel p {
        font-size: 11px !important;
      }
      
      #hastaBilgiButonlar button {
        padding: 5px 8px !important;
        font-size: 10px !important;
      }
      
      #hastaBilgiPanel > div {
        flex-direction: column !important;
        align-items: flex-start !important;
        gap: 8px !important;
      }
      
      #hastaBilgiButonlar {
        margin-left: 0 !important;
        width: 100%;
      }
      
      #hastaBilgiButonlar > div {
        flex-wrap: wrap !important;
        gap: 4px !important;
      }
    }

    /* Manuel Kart Stilleri */
    .manuel-kart {
      display: inline-block;
      margin: 10px;
      position: relative;
      vertical-align: top;
    }
    
    .manuel-kart-ekleme-btn {
      background: #28a745;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      margin: 10px 0;
    }
    
    .manuel-kart-ekleme-btn:hover {
      background: #218838;
    }

    /* --- Hedef kcal rozeti stilleri --- */
    .kcal-badge {
      display: inline-flex; align-items: center; gap: 6px;
      background: linear-gradient(135deg, #17a2b8 0%, #0d6efd 100%);
      color: #fff; padding: 4px 8px; border-radius: 999px; font-size: 12px; font-weight: 600;
      box-shadow: 0 2px 4px rgba(0,0,0,0.15);
    }
    .kcal-badge .dot { width: 8px; height: 8px; border-radius: 50%; background: #fff; opacity: .9; }
    .kcal-delta { display:inline-block; padding: 2px 6px; border-radius: 999px; font-size: 11px; font-weight: 700; border:1px solid transparent; }
    .kcal-delta.ok { background: #e6f4ea; color: #137333; border-color: #ccead6; }
    .kcal-delta.over { background: #fde8e8; color: #c62828; border-color: #f5c2c2; }
    .kcal-delta.under { background: #fff4e5; color: #b26a00; border-color: #ffd8a8; }
  .kcal-plan { display:inline-block; padding: 2px 6px; border-radius: 999px; font-size: 11px; font-weight: 700; border:1px solid #b6d4fe; background:#e7f0ff; color:#084298; }
    .kcal-info-btn {
      padding: 0 6px; height: 24px; line-height: 22px; border-radius: 999px; border: 1px solid #cfe2ff; background: #e9f2ff; color: #0d6efd; cursor: pointer; font-size: 12px;
    }
    /* Popover panel */
    .kcal-popover {
      position: fixed; z-index: 1000; background: #fff; border: 1px solid #e5e7eb; border-radius: 10px; box-shadow: 0 12px 32px rgba(0,0,0,0.18);
      width: 320px; max-width: calc(100vw - 24px); padding: 12px;
      animation: kcalPopIn .12s ease-out;
    }
    @keyframes kcalPopIn { from { opacity: 0; transform: translateY(-4px); } to { opacity: 1; transform: translateY(0); } }
    .kcal-popover h4 { margin: 0 0 8px 0; font-size: 14px; color: #0d6efd; }
    .kcal-popover .row { display: flex; justify-content: space-between; font-size: 12px; padding: 4px 0; }
    .kcal-popover .muted { color: #6b7280; }
    .kcal-popover .grid { display: grid; grid-template-columns: 1fr auto; gap: 4px 8px; font-size: 12px; }
    /* Week-specific override pill */
    .kcal-week-pill { display:inline-block; padding: 2px 6px; border-radius: 999px; font-size: 10px; font-weight: 700; border:1px solid #ffd8a8; background:#fff4e5; color:#b26a00; }
    
    /* Yemek kart stilleri */
    .yemek-kart:hover {
      background-color: #f8f9fa;
      border-color: #20c997 !important;
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .yemek-kart:active {
      transform: translateY(0);
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>

  <div class="main-container">
    <!-- Header -->
    <div class="header">
      <h2>Lipedem Hasta Takip Sistemi</h2>
      <div style="display: flex; align-items: center; gap: 10px;">
        <button id="pdfOnizlemeBtn" onclick="pdfOnizlemeAc()" style="
          background: linear-gradient(135deg, #007bff, #0056b3); 
          color: white; 
          border: none; 
          padding: 8px 16px; 
          border-radius: 5px; 
          cursor: pointer; 
          font-size: 14px; 
          display: flex;
          align-items: center; 
          gap: 6px;
          transition: all 0.3s ease;
          box-shadow: 0 2px 4px rgba(0,123,255,0.3);
        " 
        onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 8px rgba(0,123,255,0.4)'"
        onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,123,255,0.3)'">
          📄 PDF Önizleme
        </button>
      </div>
    </div>

    <!-- Sol Sidebar -->
    <div class="left-sidebar">
      <!-- Hasta Listesi -->
      <div class="sidebar-section">
        <h3>👥 Hastalar</h3>
        <input type="text" id="hastaAra" placeholder="Hasta ara..." style="width:100%; padding:6px; margin-bottom:8px; border:1px solid #ddd; border-radius:4px; font-size:12px;" oninput="filtreleHastalar()">
        <select id="arsivFiltre" style="width:100%; padding:6px; margin-bottom:10px; border:1px solid #ddd; border-radius:4px; font-size:12px;" onchange="filtreleHastalar()">
          <option value="aktif">Aktif Hastalar (0)</option>
          <option value="arsiv">Arşiv (0)</option>
          <option value="tum">Tümü (0)</option>
        </select>
        <ul id="hastaListesi"></ul>
        <button onclick="yeniHastaFormu()" style="width:100%; padding:8px; margin-top:10px; background:#28a745; color:white; border:none; border-radius:4px; cursor:pointer; font-size:12px;">+ Yeni Hasta</button>
      </div>
    </div>

    <!-- Sol Ayırıcı -->
    <div class="resize-handle" id="leftHandle"></div>

    <!-- Orta Panel -->
    <div class="center-panel">
      <!-- Hasta Bilgi Paneli (Sabit) -->
      <div id="hastaBilgiPanel" style="background: #fff; border-bottom: 2px solid #007bff; padding: 10px 15px; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
        <div style="display: flex; justify-content: space-between; align-items: center; min-height: 40px;">
          <div style="flex: 1; min-width: 0;">
            <h3 id="secilenHastaIsim" style="margin: 0; color: #007bff; font-size: 16px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">Hasta Seçilmedi</h3>
            <p id="secilenHastaNot" style="margin: 2px 0 0 0; color: #666; font-size: 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">Lütfen sol menüden bir hasta seçin</p>
          </div>
          <div id="hastaBilgiButonlar" style="display: none; flex-shrink: 0; margin-left: 15px;">
            <!-- 🎯 Hedef kcal rozeti + bilgi -->
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px; justify-content: flex-end;">
              <span id="hedefKcalBadge" class="kcal-badge" title="Hedef kcal: Hasta Ayarları’ndaki (kilo × makro katsayıları × aktivite × hedef) formülüyle hesaplanan günlük kalori hedefidir. Hasta seçildiğinde otomatik yüklenir; Ayarlar’dan değiştirildiğinde güncellenir. (Ort: gerçekleşen günlük ortalama kalori)" onclick="toggleKcalPopover(event)">
                <span class="dot"></span>
                <span>Hedef:</span>
                <strong id="hedefKcalBadgeValue">—</strong>
                <span>kcal</span>
                <span style="opacity:.65;">·</span>
                <span>Ort:</span>
                <strong id="gercekKcalBadgeValue">—</strong>
                <span>kcal</span>
                <span style="opacity:.65;">·</span>
                <span id="kcalDelta" class="kcal-delta">±0%</span>
                <span style="opacity:.65;">·</span>
                <span id="kcalPlan" class="kcal-plan" title="Hedef % (±) — global ya da hafta özel">±0%</span>
                <span style="opacity:.65;">·</span>
                <span id="kcalWeekPill" class="kcal-week-pill" style="display:none;" title="Bu hafta, global ayarların üzerine hafta özel ayarlar uygulanıyor">Hafta özel</span>
              </span>
              <button class="kcal-info-btn" onclick="showHedefKcalInfo()" title="Hedef kcal hakkında bilgi">?</button>
              <button class="kcal-info-btn" onclick="acKiloSeyri()" title="Haftalara göre kilo seyrini gör">📈</button>
            </div>
            <!-- Popover placeholder; runtime'da konumlandırılır -->
            <div id="kcalPopover" class="kcal-popover" style="display:none;"></div>
            <div style="display: flex; gap: 6px; flex-wrap: wrap;">
              <button onclick="duzenleHasta()" style="padding: 6px 10px; background: #ffc107; color: #000; border: none; border-radius: 3px; cursor: pointer; font-size: 11px;">✏️ Düzenle</button>
              <!-- TODO[PM-03]: Ayarlar modalı açılışı -->
              <button onclick="acHastaAyarlar()" style="padding: 6px 10px; background: #17a2b8; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 11px;" title="Hasta ayarları ve hedef makrolar">⚙️ Ayarlar</button>
              <button id="smartAltUndoBtn" onclick="undoLastChange()" style="padding: 6px 10px; background: #6c757d; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 11px; margin-left:6px; opacity:0.7;" title="Son akıllı seçim(ler)i geri al" disabled>↩️ Geri Al</button>
              <button onclick="arsivleHasta()" style="padding: 6px 10px; background: #6c757d; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 11px;">📦 Arşivle</button>
              <button onclick="silHasta()" style="padding: 6px 10px; background: #dc3545; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 11px;" title="Dosyayı arşivle ve listeden kaldır">🗑️ Sil</button>
              <button onclick="sadeceLisedenKaldir()" style="padding: 6px 10px; background: #fd7e14; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 11px;" title="Sadece listeden kaldır, dosyayı koru">📋 Listeden Kaldır</button>
              <button onclick="kapatDetay()" style="padding: 6px 10px; background: #6c757d; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 11px;">✖️ Kapat</button>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Yemek Veritabanı Paneli (Orta Panelin En Üstünde) -->
      <div id="yemekVeriTabaniPanel" style="display: none; background: #f8f9fa; border-bottom: 2px solid #fd7e14; margin-bottom: 10px;">
        <div style="background: white; padding: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
          
          <!-- Başlık ve Kapatma Butonu -->
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 2px solid #fd7e14; padding-bottom: 10px;">
            <h3 style="margin: 0; color: #fd7e14; display: flex; align-items: center; gap: 8px; font-size: 18px;">
              <span style="font-size: 20px;">🍽️</span>
              <span>Yemek Veritabanı</span>
            </h3>
            <button onclick="yemekVeritabaniPaneliGizle()" style="background: none; border: none; font-size: 20px; color: #fd7e14; cursor: pointer; padding: 3px 8px; border-radius: 50%; transition: all 0.2s;" onmouseover="this.style.background='#fd7e14'; this.style.color='white'" onmouseout="this.style.background='none'; this.style.color='#fd7e14'">×</button>
          </div>
          
          <!-- Filtre Kontrolleri -->
          <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap: 10px; margin-bottom: 15px; padding: 10px; background: #e9ecef; border-radius: 4px;">
            
            <!-- Arama Kutusu -->
            <div>
              <label style="display: block; font-weight: bold; margin-bottom: 3px; color: #333; font-size: 12px;">🔍 Akıllı Arama</label>
              <input type="text" id="yemekVeriArama" placeholder="Yemek adı, etiket, kalori ara..." style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;" oninput="yemekVeriTabaniFiltrele()">
            </div>
            
            <!-- Kategori Filtresi -->
            <div>
              <label style="display: block; font-weight: bold; margin-bottom: 3px; color: #333; font-size: 12px;">📂 Kategori</label>
              <select id="yemekVeriKategori" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;" onchange="yemekVeriTabaniFiltrele()">
                <option value="">Tümü</option>
              </select>
            </div>
            
            <!-- Rol Filtresi -->
            <div>
              <label style="display: block; font-weight: bold; margin-bottom: 3px; color: #333; font-size: 12px;">⚡ Rol</label>
              <select id="yemekVeriRol" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;" onchange="yemekVeriTabaniFiltrele()">
                <option value="">Tümü</option>
                <option value="bread">🍞 Ekmek</option>
                <option value="dessert">🍰 Tatlı</option>
                <option value="drink">🥤 İçecek</option>
                <option value="fruit">🍎 Meyve</option>
                <option value="mainDish">🍽️ Ana Yemek</option>
                <option value="sideDish">🥗 Yan Yemek</option>
                <option value="snack">🍪 Atıştırmalık</option>
                <option value="soup">🍲 Çorba</option>
                <option value="supplement">💊 Takviye</option>
              </select>
            </div>
            
            <!-- Öğün Türü Filtresi -->
            <div>
              <label style="display: block; font-weight: bold; margin-bottom: 3px; color: #333; font-size: 12px;">🍽️ Öğün</label>
              <select id="yemekVeriOgun" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;" onchange="yemekVeriTabaniFiltrele()">
                <option value="">Tümü</option>
                <option value="breakfast">Kahvaltı</option>
                <option value="lunch">Öğle</option>
                <option value="dinner">Akşam</option>
              </select>
            </div>
          </div>
          
          <!-- Yemek Tablosu (50 satır sabit yükseklik) -->
          <div style="background: white; border-radius: 4px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1); height: 1050px; overflow-y: hidden;">
            <table style="width: 100%; border-collapse: collapse; table-layout: fixed;">
              <thead style="background: linear-gradient(135deg, #fd7e14 0%, #ff9500 100%); color: white; position: sticky; top: 0; z-index: 10;">
                <tr style="height: 35px;">
                  <th onclick="yemekVeriTabaniSirala('ad')" style="padding: 6px; text-align: left; cursor: pointer; border-right: 1px solid rgba(255,255,255,0.2); user-select: none; font-size: 11px; width: 25%;" title="İsme göre sırala">
                    🍽️ Yemek Adı <span id="sort-ad" style="opacity: 0.7;">↕️</span>
                  </th>
                  <th onclick="yemekVeriTabaniSirala('kalori')" style="padding: 6px; text-align: center; cursor: pointer; border-right: 1px solid rgba(255,255,255,0.2); user-select: none; font-size: 11px; width: 10%;" title="Kaloriye göre sırala">
                    🔥 Kalori <span id="sort-kalori" style="opacity: 0.7;">↕️</span>
                  </th>
                  <th onclick="yemekVeriTabaniSirala('protein')" style="padding: 6px; text-align: center; cursor: pointer; border-right: 1px solid rgba(255,255,255,0.2); user-select: none; font-size: 11px; width: 10%;" title="Proteine göre sırala">
                    💪 Protein <span id="sort-protein" style="opacity: 0.7;">↕️</span>
                  </th>
                  <th onclick="yemekVeriTabaniSirala('karbonhidrat')" style="padding: 6px; text-align: center; cursor: pointer; border-right: 1px solid rgba(255,255,255,0.2); user-select: none; font-size: 11px; width: 10%;" title="Karbonhidrata göre sırala">
                    🌾 Karb. <span id="sort-karbonhidrat" style="opacity: 0.7;">↕️</span>
                  </th>
                  <th onclick="yemekVeriTabaniSirala('yag')" style="padding: 6px; text-align: center; cursor: pointer; border-right: 1px solid rgba(255,255,255,0.2); user-select: none; font-size: 11px; width: 10%;" title="Yağa göre sırala">
                    🧈 Yağ <span id="sort-yag" style="opacity: 0.7;">↕️</span>
                  </th>
                  <th onclick="yemekVeriTabaniSirala('kategori')" style="padding: 6px; text-align: center; cursor: pointer; border-right: 1px solid rgba(255,255,255,0.2); user-select: none; font-size: 11px; width: 12%;" title="Kategoriye göre sırala">
                    📂 Kategori <span id="sort-kategori" style="opacity: 0.7;">↕️</span>
                  </th>
                  <th onclick="yemekVeriTabaniSirala('role')" style="padding: 6px; text-align: center; cursor: pointer; border-right: 1px solid rgba(255,255,255,0.2); user-select: none; font-size: 11px; width: 8%;" title="Role göre sırala">
                    ⚡ Rol <span id="sort-role" style="opacity: 0.7;">↕️</span>
                  </th>
                  <th style="padding: 6px; text-align: center; font-size: 11px; width: 10%;">🎯 Özellikler</th>
                  <th style="padding: 6px; text-align: center; font-size: 11px; width: 15%;">⚙️ İşlemler</th>
                </tr>
              </thead>
              <tbody id="yemekVeriTablosuBody" style="font-size: 11px;">
                <!-- Dinamik içerik buraya gelecek (50 satır) -->
              </tbody>
            </table>
          </div>
          
          <!-- Alt Bilgi (Sayfalama ile güncellenecek) -->
          <div class="alt-bilgi" style="margin-top: 10px; padding: 8px; background: #e9ecef; border-radius: 4px; text-align: center; color: #6c757d; font-size: 10px;">
            💡 <strong>İpucu:</strong> Satırlara tıklayarak yemekleri düzenleyebilir, sütun başlıklarına tıklayarak sıralayabilirsiniz.
          </div>
        </div>
      </div>
      
      <!-- Hafta Tab'ları -->
      <div id="haftaTabs" class="hafta-tabs"></div>
      
      <!-- Hafta İçeriği -->
      <div id="haftaTabContent"></div>
      
      <!-- Eşleşen Kartlar (Alt Panel) -->
      <div style="border-top: 1px solid #ddd; background: #f8f9fa; padding: 15px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
          <h4 style="margin: 0; color: #6f42c1;">🔗 Eşleşen Kartlar</h4>
          <button id="manuelKartEkleBtn" onclick="manuelKartEklemeModalAc()" class="manuel-kart-ekleme-btn" style="font-size: 11px; padding: 5px 10px;">
            ➕ Manuel Kart Ekle
          </button>
        </div>
        <!-- 📁 ACCORDION PANEL SİSTEMİ -->
        <div id="accordionContainer" style="margin-top: 10px;">
          
          <!-- 1️⃣ EŞLEŞEN KARTLAR ACCORDION -->
          <div class="accordion-section" style="margin-bottom: 8px;">
            <button class="accordion-header" onclick="toggleAccordion('eslesen')" style="
              width: 100%;
              padding: 12px 15px;
              background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
              color: white;
              border: none;
              border-radius: 8px;
              font-weight: bold;
              cursor: pointer;
              display: flex;
              justify-content: space-between;
              align-items: center;
              font-size: 14px;
            ">
              <span id="eslesenBaslik">📋 Eşleşen Kartlar</span>
              <span id="eslesenIcon">▶</span>
            </button>
            <div id="eslesenContent" class="accordion-content" style="
              display: none;
              background: white;
              border: 1px solid #ddd;
              border-top: none;
              border-radius: 0 0 8px 8px;
              padding: 15px;
              min-height: 200px;
              max-height: 60vh;
              overflow-y: auto;
            ">
              <div style="text-align: center; color: #666; padding: 40px;">
                Önce bir hasta seçin...
              </div>
            </div>
          </div>

          <!-- 3️⃣ YEMEK KULLANIM ANALİZİ ACCORDION -->
          <div class="accordion-section" style="margin-bottom: 8px;">
            <button class="accordion-header" onclick="toggleAccordion('analiz')" style="
              width: 100%;
              padding: 12px 15px;
              background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
              color: white;
              border: none;
              border-radius: 8px;
              font-weight: bold;
              cursor: pointer;
              display: flex;
              justify-content: space-between;
              align-items: center;
              font-size: 14px;
            ">
              <span id="analizBaslik">  Yemek Kullanım Analizi (0/239)</span>
              <span id="analizIcon">▶</span>
            </button>
            <div id="analizContent" class="accordion-content" style="
              display: none;
              background: white;
              border: 1px solid #ddd;
              border-top: none;
              border-radius: 0 0 8px 8px;
              padding: 15px;
            ">
              <div style="margin-bottom: 10px; text-align: center;">
                <button onclick="siralaYemekAnalizi('cok')" id="btnCok" style="margin: 2px; padding: 5px 10px; border: none; border-radius: 4px; background: #28a745; color: white; cursor: pointer; font-size: 11px;">🔺 En Çok Kullanılan</button>
                <button onclick="siralaYemekAnalizi('az')" id="btnAz" style="margin: 2px; padding: 5px 10px; border: none; border-radius: 4px; background: #dc3545; color: white; cursor: pointer; font-size: 11px;">🔻 En Az Kullanılan</button>
                <button onclick="siralaYemekAnalizi('hic')" id="btnHic" style="margin: 2px; padding: 5px 10px; border: none; border-radius: 4px; background: #6c757d; color: white; cursor: pointer; font-size: 11px;">❌ Hiç Kullanılmayan</button>
                <button onclick="siralaYemekAnalizi('alfabetik')" id="btnAlfabetik" style="margin: 2px; padding: 5px 10px; border: none; border-radius: 4px; background: #17a2b8; color: white; cursor: pointer; font-size: 11px;">📝 Alfabetik</button>
              </div>
              
              <div id="yemekAnaliziListe" style="max-height: 60vh; overflow-y: auto; font-size: 13px; line-height: 1.4; border: 1px solid #eee; border-radius: 4px; background: #fafafa;">
                <div style="text-align: center; color: #666; padding: 20px;">Hasta ve hafta seçin...</div>
              </div>
            </div>
          </div>

          <!-- 2️⃣ EŞLEŞMEYEN TARİFLER ACCORDION (EN ALTTA) -->
          <div class="accordion-section" style="margin-bottom: 8px;">
            <button class="accordion-header" onclick="toggleAccordion('eslesmeyenler')" style="
              width: 100%;
              padding: 12px 15px;
              background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
              color: white;
              border: none;
              border-radius: 8px;
              font-weight: bold;
              cursor: pointer;
              display: flex;
              justify-content: space-between;
              align-items: center;
              font-size: 14px;
            ">
              <span id="eslesmeyenlerBaslik">  Eşleşmeyen Tarifler</span>
              <span id="eslesmeyenlerIcon">▶</span>
            </button>
            <div id="eslesmeyenlerContent" class="accordion-content" style="
              display: none;
              background: white;
              border: 1px solid #ddd;
              border-top: none;
              border-radius: 0 0 8px 8px;
              padding: 15px;
              min-height: 100px;
              max-height: 50vh;
              overflow-y: auto;
            ">
              <div style="text-align: center; color: #666; padding: 20px;">
                Eşleşmeyen tarif bulunamadı
              </div>
            </div>
          </div>

          <!-- 4️⃣ YEMEK VERİTABANI ANALİZİ ACCORDION -->
          <div class="accordion-section" style="margin-bottom: 8px;">
            <button class="accordion-header" onclick="toggleAccordion('veritabaniAnalizi')" style="
              width: 100%;
              padding: 12px 15px;
              background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
              color: white;
              border: none;
              border-radius: 8px;
              font-weight: bold;
              cursor: pointer;
              display: flex;
              justify-content: space-between;
              align-items: center;
              font-size: 14px;
            ">
              <span id="veritabaniAnaliziBaslik">🍽️ Yemek Veritabanı Analizi</span>
              <span style="color: #28a745; font-size: 10px; margin-left: 5px;" title="Otomatik GitHub senkronizasyonu aktif">🔄 Auto-Sync</span>
              <!-- <button onclick="lokalFoodListGithubYukle()" style="
                background: #007bff;
                color: white;
                border: none;
                padding: 4px 8px;
                border-radius: 4px;
                font-size: 11px;
                cursor: pointer;
                margin-left: 10px;
              " title="Lokal food_list.json dosyasını GitHub'a yükle">🚀 Lokal→GitHub</button> -->
              <span id="veritabaniAnaliziIcon">▶</span>
            </button>
            <div id="veritabaniAnaliziContent" class="accordion-content" style="
              display: none;
              background: white;
              border: 1px solid #ddd;
              border-top: none;
              border-radius: 0 0 8px 8px;
              padding: 15px;
              min-height: 100px;
              max-height: 70vh;
              overflow-y: auto;
            ">
              <div style="text-align: center; color: #666; padding: 20px;">
                PDF yüklendiğinde yemek veritabanı analizi burada görüntülenecek
              </div>
            </div>
          </div>
          
          <!-- BUTONLAR İÇİN SABİT ALAN (İndirme butonları vs) -->
          <div id="sidebarButtons" style="margin-top: 10px; padding: 10px; border: 1px solid #ddd; border-radius: 8px; background: white; min-height: 60px;">
            <!-- Şablon Arşivi Butonu -->
            <button onclick="acSablonArsivi()" style="
              width: 100%; 
              padding: 10px; 
              background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
              color: white; 
              border: none; 
              border-radius: 6px; 
              font-size: 14px; 
              font-weight: bold; 
              cursor: pointer;
              margin-bottom: 8px;
              transition: all 0.3s ease;
            " 
            onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(102,126,234,0.3)'" 
            onmouseout="this.style.transform='translateY(0px)'; this.style.boxShadow='none'">
              📋 Şablon Arşivi
            </button>
            
            <!-- Diyet Türleri Yönetimi Butonu -->
            <button onclick="acDiyetTurleri()" style="
              width: 100%; 
              padding: 10px; 
              background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); 
              color: white; 
              border: none; 
              border-radius: 6px; 
              font-size: 14px; 
              font-weight: bold; 
              cursor: pointer;
              margin-bottom: 8px;
              transition: all 0.3s ease;
            " 
            onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(240,147,251,0.3)'" 
            onmouseout="this.style.transform='translateY(0px)'; this.style.boxShadow='none'">
              🎯 Diyet Türleri
            </button>
          </div>
        </div>
      </div>
      
      <!-- Yemek Veritabanı Paneli -->
      <div id="yemekVeriTabaniPanel" style="display: none; padding: 20px; background: #f8f9fa; height: calc(100vh - 140px); overflow-y: auto;">
        <div style="background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
          
          <!-- Başlık ve Kapatma Butonu -->
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #fd7e14; padding-bottom: 15px;">
            <h2 style="margin: 0; color: #fd7e14; display: flex; align-items: center; gap: 10px;">
              <span style="font-size: 28px;">🍽️</span>
              <span>Yemek Veritabanı</span>
            </h2>
            <button onclick="yemekVeritabaniPaneliGizle()" style="background: none; border: none; font-size: 24px; color: #fd7e14; cursor: pointer; padding: 5px 10px; border-radius: 50%; transition: all 0.2s;" onmouseover="this.style.background='#fd7e14'; this.style.color='white'" onmouseout="this.style.background='none'; this.style.color='#fd7e14'">×</button>
          </div>
          
          <!-- Üst Kontroller: Arama ve Filtreler -->
          <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap: 15px; margin-bottom: 20px;">
            <!-- Akıllı Arama -->
            <div>
              <label style="display: block; font-weight: bold; margin-bottom: 5px; color: #333;">🔍 Akıllı Arama</label>
              <input type="text" id="yemekVeriArama" placeholder="Yemek adı, etiket, kalori aralığı ara..." style="width: 100%; padding: 10px; border: 2px solid #e9ecef; border-radius: 6px; font-size: 14px;" oninput="yemekVeriTabaniFiltrele()">
            </div>
            
            <!-- Kategori Filtresi -->
            <div>
              <label style="display: block; font-weight: bold; margin-bottom: 5px; color: #333;">📂 Kategori</label>
              <select id="yemekVeriKategori" style="width: 100%; padding: 10px; border: 2px solid #e9ecef; border-radius: 6px; font-size: 14px;" onchange="yemekVeriTabaniFiltrele()">
                <option value="">Tümü</option>
              </select>
            </div>
            
            <!-- Rol Filtresi -->
            <div>
              <label style="display: block; font-weight: bold; margin-bottom: 5px; color: #333;">⚡ Rol</label>
              <select id="yemekVeriRol" style="width: 100%; padding: 10px; border: 2px solid #e9ecef; border-radius: 6px; font-size: 14px;" onchange="yemekVeriTabaniFiltrele()">
                <option value="">Tümü</option>
                <option value="mainDish">Ana Yemek</option>
                <option value="side">Yan Yemek</option>
                <option value="snack">Atıştırmalık</option>
                <option value="drink">İçecek</option>
                <option value="dessert">Tatlı</option>
              </select>
            </div>
            
            <!-- Öğün Türü Filtresi -->
            <div>
              <label style="display: block; font-weight: bold; margin-bottom: 5px; color: #333;">🍽️ Öğün</label>
              <select id="yemekVeriOgun" style="width: 100%; padding: 10px; border: 2px solid #e9ecef; border-radius: 6px; font-size: 14px;" onchange="yemekVeriTabaniFiltrele()">
                <option value="">Tümü</option>
                <option value="breakfast">Kahvaltı</option>
                <option value="lunch">Öğle</option>
                <option value="dinner">Akşam</option>
              </select>
            </div>
          </div>
          
          <!-- Yemek Tablosu -->
          <div style="background: white; border: 1px solid #dee2e6; border-radius: 6px; overflow: hidden;">
            <table id="yemekVeriTablosu" style="width: 100%; border-collapse: collapse;">
              <thead style="background: linear-gradient(135deg, #fd7e14, #e9661a); color: white;">
                <tr>
                  <th onclick="yemekVeriTabaniSirala('name')" style="padding: 12px; text-align: left; cursor: pointer; border-right: 1px solid rgba(255,255,255,0.2); user-select: none;" title="Ada göre sırala">
                    🍽️ Yemek Adı <span id="sort-name" style="opacity: 0.7;">↕️</span>
                  </th>
                  <th onclick="yemekVeriTabaniSirala('calories')" style="padding: 12px; text-align: center; cursor: pointer; border-right: 1px solid rgba(255,255,255,0.2); user-select: none;" title="Kaloriye göre sırala">
                    🔥 Kalori <span id="sort-calories" style="opacity: 0.7;">↕️</span>
                  </th>
                  <th onclick="yemekVeriTabaniSirala('protein')" style="padding: 12px; text-align: center; cursor: pointer; border-right: 1px solid rgba(255,255,255,0.2); user-select: none;" title="Proteine göre sırala">
                    💪 Protein <span id="sort-protein" style="opacity: 0.7;">↕️</span>
                  </th>
                  <th onclick="yemekVeriTabaniSirala('carbs')" style="padding: 12px; text-align: center; cursor: pointer; border-right: 1px solid rgba(255,255,255,0.2); user-select: none;" title="Karbonhidrata göre sırala">
                    🌾 Karb <span id="sort-carbs" style="opacity: 0.7;">↕️</span>
                  </th>
                  <th onclick="yemekVeriTabaniSirala('fat')" style="padding: 12px; text-align: center; cursor: pointer; border-right: 1px solid rgba(255,255,255,0.2); user-select: none;" title="Yağa göre sırala">
                    🧈 Yağ <span id="sort-fat" style="opacity: 0.7;">↕️</span>
                  </th>
                  <th onclick="yemekVeriTabaniSirala('category')" style="padding: 12px; text-align: center; cursor: pointer; border-right: 1px solid rgba(255,255,255,0.2); user-select: none;" title="Kategoriye göre sırala">
                    📂 Kategori <span id="sort-category" style="opacity: 0.7;">↕️</span>
                  </th>
                  <th onclick="yemekVeriTabaniSirala('role')" style="padding: 12px; text-align: center; cursor: pointer; border-right: 1px solid rgba(255,255,255,0.2); user-select: none;" title="Role göre sırala">
                    ⚡ Rol <span id="sort-role" style="opacity: 0.7;">↕️</span>
                  </th>
                  <th style="padding: 12px; text-align: center;">🎯 Özellikler</th>
                </tr>
              </thead>
              <tbody id="yemekVeriTablosuBody" style="font-size: 13px;">
                <!-- Dinamik içerik buraya gelecek -->
              </tbody>
            </table>
          </div>
          
          <!-- Alt Bilgi (Sayfalama ile güncellenecek) -->
          <div class="alt-bilgi" style="margin-top: 15px; padding: 10px; background: #e9ecef; border-radius: 6px; text-align: center; color: #6c757d; font-size: 12px;">
            💡 <strong>İpucu:</strong> Satırlara tıklayarak yemekleri düzenleyebilir, sütun başlıklarına tıklayarak sıralayabilirsiniz.
          </div>
        </div>
      </div>
    </div>

    <!-- Sağ Ayırıcı -->
    <div class="resize-handle" id="rightHandle"></div>

    <!-- Sağ Sidebar -->
    <div class="right-sidebar">
      <!-- Hızlı İşlemler - ÜST -->
      <div class="sidebar-section">
        <h3>⚡ İşlemler</h3>
        <input type="password" id="githubToken" placeholder="GitHub Token" style="width:100%; margin-bottom:5px; padding:6px; font-size:11px; border:1px solid #ddd; border-radius:3px;" oninput="saveTokenToStorage()">
        <input type="text" id="githubRepo" placeholder="GitHub Repo (owner/repo)" value="mustafasacar35/lipodem-takip-paneli-4" style="width:100%; margin-bottom:5px; padding:6px; font-size:11px; border:1px solid #ddd; border-radius:3px;">
        <button onclick="testGitHubToken()" style="width:100%; margin-bottom:5px; padding:6px; font-size:11px; background:#17a2b8; color:white; border:none; border-radius:3px; cursor:pointer;">🔍 Token Test Et</button>
        <button onclick="ilkKurulumOlustur()" style="width:100%; margin-bottom:5px; padding:6px; font-size:11px; background:#198754; color:white; border:none; border-radius:3px; cursor:pointer; font-weight:bold;">🚀 İlk Kurulum (Seed)</button>
        <!-- Otomatik senkronizasyon aktif, manuel buton gerekmiyor -->
        <!-- <button onclick="lokalFoodListGithubYukle()" style="width:100%; margin-bottom:5px; padding:6px; font-size:11px; background:#007bff; color:white; border:none; border-radius:3px; cursor:pointer;">🚀 Food List Senkronize</button> -->
      </div>

      <!-- Alternatif Yemek Kontrolleri - DINAMIK KONUM -->
      <div id="alternativeControls" style="display: none; border-top: 1px solid #ddd; padding-top: 10px; margin-top: 10px;">
        <h4 style="margin: 0 0 5px 0; font-size: 12px; color: #17a2b8;">🔄 Alternatif Mod</h4>
        <div style="display: flex; gap: 2%; margin-bottom: 5px;">
          <button onclick="alternatifleriDurdur()" style="flex: 1; padding:6px; font-size:11px; background:#6c757d; color:white; border:none; border-radius:3px; cursor:pointer;">⏹️ Durdur</button>
          <button onclick="orijinalYemegiGeriYukle()" style="flex: 1; padding:6px; font-size:11px; background:#28a745; color:white; border:none; border-radius:3px; cursor:pointer;">↩️ Orijinal</button>
        </div>
        
        <div id="alternativeInfo" style="font-size: 10px; color: #666; margin: 5px 0; padding: 5px; background: #f8f9fa; border-radius: 3px;">
          Alternatif mod aktif değil
        </div>
        
        <!-- Alternatif Yemek Listesi - YÜKSEKLİK ARTTIRILDI -->
        <div id="alternativeList" style="display: none; max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 3px; margin-top: 5px;">
          <!-- Alternatif yemekler buraya gelecek -->
        </div>
      </div>

      <!-- Araçlar - DINAMIK KONUM -->
      <div class="sidebar-section" id="araclarBolumu">
        <h3>🛠️ Araçlar</h3>
        <input type="file" id="cokluPdfInput" multiple accept=".pdf" style="display:none" onchange="processCokluPdf(this.files)">
        <button onclick="document.getElementById('cokluPdfInput').click()" style="width:100%; margin-bottom:5px; padding:6px; font-size:11px; background:#6f42c1; color:white; border:none; border-radius:3px; cursor:pointer; font-weight:bold;">📁 Çoklu PDF Yükle</button>
        <button onclick="yeniKartFormGoster()" style="width:100%; margin-bottom:5px; padding:6px; font-size:11px; background:#17a2b8; color:white; border:none; border-radius:3px; cursor:pointer;">+ Yeni Kart</button>
        <button onclick="kartDuzenleFormGoster()" style="width:100%; margin-bottom:5px; padding:6px; font-size:11px; background:#ffc107; color:black; border:none; border-radius:3px; cursor:pointer;">✏️ Kart Düzenle</button>
        <button onclick="kartSilFormGoster()" style="width:100%; margin-bottom:5px; padding:6px; font-size:11px; background:#dc3545; color:white; border:none; border-radius:3px; cursor:pointer;">🗑️ Kart Sil</button>
        <button id="yemekVeritabaniBtn" onclick="yemekVeritabaniPaneliGoster()" style="width:100%; margin-bottom:5px; padding:6px; font-size:11px; background:#fd7e14; color:white; border:none; border-radius:3px; cursor:pointer; font-weight:bold;">🍽️ Yemek Veritabanı</button>
        <button onclick="manuelEslestirmePaneliGoster()" style="width:100%; margin-bottom:5px; padding:6px; font-size:11px; background:#6f42c1; color:white; border:none; border-radius:3px; cursor:pointer;">🔗 Manuel Eşleştirme</button>
        <button onclick="eslesmemeRegeleriPaneliGoster()" style="width:100%; margin-bottom:5px; padding:6px; font-size:11px; background:#dc3545; color:white; border:none; border-radius:3px; cursor:pointer;">🚫 Eşleşme Yasakları</button>
        <button onclick="generateCustomLenfMasajTakvimi()" style="width:100%; margin-bottom:5px; padding:6px; font-size:11px; background:#28a745; color:white; border:none; border-radius:3px; cursor:pointer;">💆 Lenf Masaj Takvimi</button>
        <button onclick="generateCustomEgzersizTakvimi()" style="width:100%; margin-bottom:5px; padding:6px; font-size:11px; background:#007bff; color:white; border:none; border-radius:3px; cursor:pointer;">🏃 Egzersiz Takvimi</button>
        <button onclick="openBlacklistModal()" style="width:100%; margin-bottom:5px; padding:6px; font-size:11px; background:#dc3545; color:white; border:none; border-radius:3px; cursor:pointer;">🚫 Karaliste</button>
      </div>

      <!-- Sistem Durumu - EN ALT -->
      <div class="sidebar-section" style="margin-top: auto; border-top: 1px solid #ddd; padding-top: 10px;">
        <h3>📊 Sistem</h3>
        <div class="sistem-durumu-kompakt">
          <span class="durum-item" id="tariflerKlasoruDurumu">🔄 Tarifler kontrol ediliyor...</span>
          <span class="durum-item" id="dataKlasoruDurumu">🔄 Data kontrol ediliyor...</span>
          <span class="durum-item" id="githubDurumu">⏳ GitHub kontrol ediliyor...</span>
        </div>
      </div>
    </div>
  </div>

  <script>
    // =============================
    // PM-03/04/05 Hasta Ayarları Modal Mantığı
    // =============================
    function qs(id) { return document.getElementById(id); }

    // Some globals are declared with let (not attached to window). Resolve active patient safely.
    function getCurrentHasta() {
      try { if (typeof seciliHasta !== 'undefined' && seciliHasta) return seciliHasta; } catch {}
      try { if (window.seciliHasta) return window.seciliHasta; } catch {}
      return null;
    }

    async function acHastaAyarlar() {
      const aktif = getCurrentHasta();
      if (!aktif) { alert('Önce bir hasta seçin.'); return; }
      try {
        // Hasta adı
        const isim = aktif.isim || aktif.ad || '';
        const isimEl = qs('hastaAyarHastaIsim');
        if (isimEl) isimEl.textContent = isim ? `• ${isim}` : '';

        // Modalı açmadan önce alanları resetle
        qs('hedef_kcal').textContent = '-';
        qs('hedef_c').textContent = '-';
        qs('hedef_p').textContent = '-';
        qs('hedef_f').textContent = '-';

        // Aktif hafta etiketi
        try {
          const haftaListesi = (typeof getHaftaListesi === 'function') ? getHaftaListesi() : [];
          const idx = (typeof getAktifHaftaIndex === 'function') ? getAktifHaftaIndex() : (haftaListesi.length ? haftaListesi.length - 1 : 0);
          const haftaNo = (haftaListesi?.[idx]?.haftaNo) || (idx + 1);
          const lbl = document.getElementById('ayar_currentWeekLabel');
          if (lbl) lbl.textContent = `${haftaNo}. Hafta`;
        } catch {}

        // GitHub'dan ayarları çek (varsa), yoksa local'e düş
        const gh = getGithubRepoAndToken();
        let remoteHasta = null, remoteDefaults = null;
        if (gh) {
          try { remoteHasta = await githubGetFileJson(`patients/${aktif.id}/settings.json`, true); } catch {}
          try { remoteDefaults = await githubGetFileJson('settings/defaults.json', true); } catch {}
        }
        // Local
        const localHasta = (typeof loadUserSettingsLocal === 'function') ? loadUserSettingsLocal(aktif.id) : null;
        const localDefaults = (typeof loadUserSettingsLocal === 'function') ? loadUserSettingsLocal('default') : null;

        // Başlangıç config
        const etkinHasta = remoteHasta || localHasta || {};
        // Hafta override var mı? (weeklyOverrides[haftaNo])
        let haftaOverride = null;
        try {
          const haftaListesi = (typeof getHaftaListesi === 'function') ? getHaftaListesi() : [];
          const idx = (typeof getAktifHaftaIndex === 'function') ? getAktifHaftaIndex() : (haftaListesi.length ? haftaListesi.length - 1 : 0);
          const haftaNo = (haftaListesi?.[idx]?.haftaNo) || (idx + 1);
          const ov = findWeekOverride(etkinHasta || {}, haftaNo);
          haftaOverride = ov.has ? ov.override : null;
        } catch {}
        const etkin = haftaOverride ? { ...etkinHasta, ...haftaOverride } : etkinHasta;
        const dietType = etkin.dietType || 'lowcarb';
        const activityLevel = parseInt(etkin.activityLevel || 3, 10);
        const goal = etkin.goal || 'maintain';
        const goalPct = typeof etkin.goalPct === 'number' ? etkin.goalPct : 0;
        const weight = parseFloat(etkin.weightKg ?? '') || '';
        const dist = etkin.mealDistribution || { ...window.DEFAULT_MEAL_DISTRIBUTION };

        // Diyet per-kg katsayılar: hasta ayarı > defaults > preset
        const preset = window.DIET_PRESETS[dietType] || window.DIET_PRESETS.lowcarb;
        const ck = (etkin?.perKg?.carbsPerKg)
          ?? (remoteDefaults?.perKg?.carbsPerKg)
          ?? (localDefaults?.perKg?.carbsPerKg)
          ?? preset.carbsPerKg;
        const pk = (etkin?.perKg?.proteinPerKg)
          ?? (remoteDefaults?.perKg?.proteinPerKg)
          ?? (localDefaults?.perKg?.proteinPerKg)
          ?? preset.proteinPerKg;
        const fk = (etkin?.perKg?.fatPerKg)
          ?? (remoteDefaults?.perKg?.fatPerKg)
          ?? (localDefaults?.perKg?.fatPerKg)
          ?? preset.fatPerKg;

        // UI alanlarını doldur
        qs('ayar_dietType').value = dietType;
        qs('ayar_activity').value = String(activityLevel);
        qs('ayar_goal').value = goal;
  if (qs('ayar_goalPct')) qs('ayar_goalPct').value = goalPct;
        qs('ayar_weight').value = weight;
        qs('ayar_ck').value = ck;
        qs('ayar_pk').value = pk;
        qs('ayar_fk').value = fk;

        // Öğün dağılımını normalize ederek doldur
        const n = (typeof normalizeMealDistribution === 'function') ? normalizeMealDistribution(dist) : dist;
        ['kahvalti','ogle','aksam','ara'].forEach(k => {
          qs('ayar_'+k).value = n[k] ?? 0;
          qs('ayar_'+k+'_r').value = n[k] ?? 0;
        });
        guncelleToplam();

        // Diyet değişince presetleri yükle
        qs('ayar_dietType').onchange = () => {
          const dt = qs('ayar_dietType').value;
          const p = window.DIET_PRESETS[dt] || window.DIET_PRESETS.lowcarb;
          // Kullanıcı isteği: değiştirince presetleri doldur (elle override edilebilir)
          qs('ayar_ck').value = p.carbsPerKg;
          qs('ayar_pk').value = p.proteinPerKg;
          qs('ayar_fk').value = p.fatPerKg;
          hedefMakroGuncelle();
        };

        // Canlı hedef makro hesaplaması
        ['ayar_activity','ayar_goal','ayar_goalPct','ayar_weight','ayar_ck','ayar_pk','ayar_fk'].forEach(id => {
          const el = qs(id);
          el && (el.oninput = hedefMakroGuncelle);
          el && (el.onchange = hedefMakroGuncelle);
        });

        // Aç ve hedefi hesapla
  // Checkbox default: this week checked
  const chk = document.getElementById('ayar_onlyThisWeek');
  if (chk) chk.checked = true;
  qs('hastaAyarModal').style.display = 'block';
        hedefMakroGuncelle();
        // Haftaya özel override varsa temizle butonunu göster
        try {
          let haftaNo = null;
          try {
            const haftaListesi = (typeof getHaftaListesi === 'function') ? getHaftaListesi() : [];
            const idx = (typeof getAktifHaftaIndex === 'function') ? getAktifHaftaIndex() : (haftaListesi.length ? haftaListesi.length - 1 : 0);
            haftaNo = (haftaListesi?.[idx]?.haftaNo) || (idx + 1);
          } catch {}
          const gh = getGithubRepoAndToken();
          let remoteHasta = null;
          if (gh) { try { remoteHasta = await githubGetFileJson(`patients/${aktif.id}/settings.json`, true); } catch {} }
          const localHasta = (typeof loadUserSettingsLocal === 'function') ? loadUserSettingsLocal(aktif.id) : null;
          const etkinHastaRaw = remoteHasta || localHasta || {};
          const { has: hasWeekOverride } = findWeekOverride(etkinHastaRaw || {}, haftaNo);
          const clrBtn = document.getElementById('clearWeekOverrideBtn');
          if (clrBtn) clrBtn.style.display = hasWeekOverride ? 'inline-block' : 'none';
        } catch {}
      } catch (e) {
        console.error('acHastaAyarlar error', e);
        alert('Ayarlar açılırken bir hata oluştu.');
      }
    }

    function hastaAyarModalKapat(ev) {
      if (ev && ev.target && ev.currentTarget && ev.target !== ev.currentTarget) return; // dış tık
      qs('hastaAyarModal').style.display = 'none';
    }

    // Slider/sayı senkronizasyon ve normalize
    function ayarSliderDegisti(k) {
      const rv = parseInt(qs('ayar_'+k+'_r').value, 10) || 0;
      qs('ayar_'+k).value = rv;
      ayarDagilimDegisti();
    }
    function ayarDagilimDegisti() {
      const d = {
        kahvalti: parseInt(qs('ayar_kahvalti').value || '0', 10),
        ogle: parseInt(qs('ayar_ogle').value || '0', 10),
        aksam: parseInt(qs('ayar_aksam').value || '0', 10),
        ara: parseInt(qs('ayar_ara').value || '0', 10),
      };
      const n = (typeof normalizeMealDistribution === 'function') ? normalizeMealDistribution(d) : d;
      ['kahvalti','ogle','aksam','ara'].forEach(k => {
        qs('ayar_'+k).value = n[k] ?? 0;
        qs('ayar_'+k+'_r').value = n[k] ?? 0;
      });
      guncelleToplam();
    }
    function guncelleToplam() {
      const toplam = ['kahvalti','ogle','aksam','ara'].reduce((a,k)=> a + (parseInt(qs('ayar_'+k).value||'0',10)||0), 0);
      qs('ayar_toplam').textContent = toplam;
    }

    // Hedef makroları canlı hesapla
    function hedefMakroGuncelle() {
      try {
        const weight = parseFloat(qs('ayar_weight').value || '0');
        const dietType = qs('ayar_dietType').value;
        const activityLevel = parseInt(qs('ayar_activity').value || '3', 10);
        const goal = qs('ayar_goal').value || 'maintain';
  const goalPct = parseFloat(qs('ayar_goalPct')?.value || '0');

        // Geçici olarak DIET_PRESETS'i kullanıcı katsayılarıyla patch etmeden hesaplayalım:
        const ck = parseFloat(qs('ayar_ck').value || '0');
        const pk = parseFloat(qs('ayar_pk').value || '0');
        const fk = parseFloat(qs('ayar_fk').value || '0');

        // computeTargetMacros mevcut preset'i kullanıyor; kullanıcı katsayılarını hesaba katmak için
        // geçici bir preset oluşturup oradan hesap yapalım.
        const tmp = { carbsPerKg: ck, proteinPerKg: pk, fatPerKg: fk };
  const af = window.ACTIVITY_FACTORS[activityLevel] || 1.0;
  const hasCustom = isFinite(goalPct) && goalPct !== 0;
  const base = hasCustom ? 1.0 : (window.GOAL_FACTORS[goal] || 1.0);
  const gp = hasCustom ? (1 + goalPct/100) : 1.0;
  const factor = af * base * gp;
        const carbs = isFinite(weight) ? Math.round(weight * tmp.carbsPerKg * factor * 10)/10 : 0;
        const protein = isFinite(weight) ? Math.round(weight * tmp.proteinPerKg * factor * 10)/10 : 0;
        const fat = isFinite(weight) ? Math.round(weight * tmp.fatPerKg * factor * 10)/10 : 0;
        const calories = Math.round(carbs*4 + protein*4 + fat*9);

        qs('hedef_kcal').textContent = calories || '-';
        // Header rozeti (varsa) güncelle
        const badge = document.getElementById('hedefKcalBadgeValue');
  if (badge) badge.textContent = (calories && isFinite(calories)) ? String(calories) : '—';
        // Plan yüzdesini rozete yaz
        const planEl = document.getElementById('kcalPlan');
        if (planEl) {
          const v = Math.round((isFinite(goalPct) ? goalPct : 0));
          planEl.textContent = (v > 0 ? `+${v}%` : `${v}%`);
          planEl.title = `Seçili hedef planı: ${v > 0 ? '+'+v : v}%`;
        }
  updateKcalDelta();
        qs('hedef_c').textContent = isFinite(carbs) ? carbs : '-';
        qs('hedef_p').textContent = isFinite(protein) ? protein : '-';
        qs('hedef_f').textContent = isFinite(fat) ? fat : '-';
      } catch (e) { console.error('hedefMakroGuncelle', e); }
    }

    // Hasta seçildiğinde badge’i otomatik yükle: local/GitHub ayarlarına göre hesapla
    async function updateHedefKcalBadgeForSelectedPatient() {
      try {
        const aktif = getCurrentHasta();
        const badge = document.getElementById('hedefKcalBadgeValue');
        if (!aktif || !badge) return;
        // Ayarları oku: hasta > defaults > preset
        const gh = getGithubRepoAndToken();
        let remoteHasta = null, remoteDefaults = null;
        if (gh) {
          try { remoteHasta = await githubGetFileJson(`patients/${aktif.id}/settings.json`, true); } catch {}
          try { remoteDefaults = await githubGetFileJson('settings/defaults.json', true); } catch {}
        }
        const localHasta = (typeof loadUserSettingsLocal === 'function') ? loadUserSettingsLocal(aktif.id) : null;
        const localDefaults = (typeof loadUserSettingsLocal === 'function') ? loadUserSettingsLocal('default') : null;
        const etkinHastaRaw = remoteHasta || localHasta || {};
        let etkinHasta = etkinHastaRaw;
        try {
          const haftaListesi = (typeof getHaftaListesi === 'function') ? getHaftaListesi() : [];
          const idx = (typeof getAktifHaftaIndex === 'function') ? getAktifHaftaIndex() : (haftaListesi.length ? haftaListesi.length - 1 : 0);
          const haftaNo = (haftaListesi?.[idx]?.haftaNo) || (idx + 1);
          const ov = findWeekOverride(etkinHastaRaw, haftaNo);
          if (ov.has) etkinHasta = { ...etkinHastaRaw, ...ov.override };
        } catch {}

        const dietType = etkinHasta.dietType || 'lowcarb';
        const activityLevel = parseInt(etkinHasta.activityLevel || 3, 10);
  const goal = etkinHasta.goal || 'maintain';
  const goalPct = typeof etkinHasta.goalPct === 'number' ? etkinHasta.goalPct : 0;
        
        // Aktif haftaya özel kilo değerini al (önce hafta override, sonra hafta objesi, son olarak ayarlar)
        let weight = 0;
        try {
          const haftaListesi = (typeof getHaftaListesi === 'function') ? getHaftaListesi() : [];
          const idx = (typeof getAktifHaftaIndex === 'function') ? getAktifHaftaIndex() : (haftaListesi.length ? haftaListesi.length - 1 : 0);
          const haftaNo = (haftaListesi?.[idx]?.haftaNo) || (idx + 1);
          const h = haftaListesi.find(hh => hh.haftaNo === haftaNo);
          
          // 1. Hafta override'dan kilo al
          const ov = findWeekOverride(etkinHastaRaw, haftaNo);
          if (ov.has && isFinite(parseFloat(ov.override?.weightKg)) && parseFloat(ov.override.weightKg) > 0) {
            weight = parseFloat(ov.override.weightKg);
          }
          // 2. Hafta objesinden kilo al
          else if (h && isFinite(parseFloat(h?.weightKg)) && parseFloat(h.weightKg) > 0) {
            weight = parseFloat(h.weightKg);
          }
          // 3. Hasta ayarlarından kilo al
          else {
            weight = parseFloat(etkinHasta.weightKg ?? '0') || 0;
          }
        } catch {
          weight = parseFloat(etkinHasta.weightKg ?? '0') || 0;
        }
        const preset = window.DIET_PRESETS[dietType] || window.DIET_PRESETS.lowcarb;
        const ck = (etkinHasta?.perKg?.carbsPerKg)
          ?? (remoteDefaults?.perKg?.carbsPerKg)
          ?? (localDefaults?.perKg?.carbsPerKg)
          ?? preset.carbsPerKg;
        const pk = (etkinHasta?.perKg?.proteinPerKg)
          ?? (remoteDefaults?.perKg?.proteinPerKg)
          ?? (localDefaults?.perKg?.proteinPerKg)
          ?? preset.proteinPerKg;
        const fk = (etkinHasta?.perKg?.fatPerKg)
          ?? (remoteDefaults?.perKg?.fatPerKg)
          ?? (localDefaults?.perKg?.fatPerKg)
          ?? preset.fatPerKg;
        const af = window.ACTIVITY_FACTORS[activityLevel] || 1.0;
  const hasCustom = isFinite(goalPct) && goalPct !== 0;
  const base = hasCustom ? 1.0 : (window.GOAL_FACTORS[goal] || 1.0);
  const gp = hasCustom ? (1 + goalPct/100) : 1.0;
  const factor = af * base * gp;
        const calories = Math.round((weight * ck * factor)*4 + (weight * pk * factor)*4 + (weight * fk * factor)*9);
  badge.textContent = (calories && isFinite(calories)) ? String(calories) : '—';
  const planEl = document.getElementById('kcalPlan');
  if (planEl) {
    const v = Math.round(isFinite(goalPct) ? goalPct : 0);
    planEl.textContent = (v > 0 ? `+${v}%` : `${v}%`);
    planEl.title = `Seçili hedef planı: ${v > 0 ? '+'+v : v}%`;
  }
  // Gerçekleşen ortalama kcal (hafta bazlı): varsa göster, yoksa '—'
  try {
    const rBadge = document.getElementById('gercekKcalBadgeValue');
    if (rBadge) {
      let realized = null;
      try {
        const haftaListesi = (typeof getHaftaListesi === 'function') ? getHaftaListesi() : [];
        const idx = (typeof getAktifHaftaIndex === 'function') ? getAktifHaftaIndex() : (haftaListesi.length ? haftaListesi.length - 1 : 0);
        const haftaNo = (haftaListesi?.[idx]?.haftaNo) || (idx + 1);
        // Önce hafta objesindeki değeri dene
        try {
          const h = haftaListesi.find(hh => hh.haftaNo === haftaNo);
          if (h && isFinite(h.realizedAvgKcal) && h.realizedAvgKcal > 0) {
            realized = Math.round(Number(h.realizedAvgKcal));
          }
        } catch {}
        // Yoksa cache'e bak
        if (!(isFinite(realized) && realized > 0)) {
          const cached = window.__weeklyRealizedAvg
            && window.__weeklyRealizedAvg[aktif.id]
            && window.__weeklyRealizedAvg[aktif.id][String(haftaNo)];
          if (isFinite(cached) && cached > 0) {
            realized = Math.round(Number(cached));
          }
        }
      } catch {}
      rBadge.textContent = (isFinite(realized) && realized > 0) ? String(realized) : '—';
    }
  } catch {}
  // Hafta özel override varsa rozet yanında göster
    try {
      let haftaNo = null;
      try {
        const haftaListesi = (typeof getHaftaListesi === 'function') ? getHaftaListesi() : [];
        const idx = (typeof getAktifHaftaIndex === 'function') ? getAktifHaftaIndex() : (haftaListesi.length ? haftaListesi.length - 1 : 0);
        haftaNo = (haftaListesi?.[idx]?.haftaNo) || (idx + 1);
      } catch {}
      const { has: hasWeekOverride } = findWeekOverride(etkinHastaRaw || {}, haftaNo);
      const weekPill = document.getElementById('kcalWeekPill');
      if (weekPill) weekPill.style.display = hasWeekOverride ? 'inline-block' : 'none';
    } catch {}
  updateKcalDelta();
      } catch (e) {
        console.warn('Hedef kcal rozeti güncellenemedi:', e?.message || e);
      }
    }

    function showHedefKcalInfo() {
      alert('Hedef kcal nedir?\n\nHasta Ayarları’ndaki değerlere göre (kilo × makro katsayıları × aktivite × hedef) günlük kalori hedefinizdir. Hasta seçince otomatik yüklenir; Ayarlar’dan değiştirince anında güncellenir.');
    }

    // Rozet: Hedef vs Gerçekleşen farkını (%) hesapla ve rozete yansıt
    function updateKcalDelta() {
      try {
        const tEl = document.getElementById('hedefKcalBadgeValue');
        const rEl = document.getElementById('gercekKcalBadgeValue');
        const dEl = document.getElementById('kcalDelta');
        if (!tEl || !rEl || !dEl) return;
        const t = parseFloat((tEl.textContent || '').replace(/[^0-9.]/g, ''));
        const r = parseFloat((rEl.textContent || '').replace(/[^0-9.]/g, ''));
        if (!isFinite(t) || t <= 0 || !isFinite(r) || r <= 0) {
          dEl.textContent = '—';
          dEl.className = 'kcal-delta';
          return;
        }
        const pct = Math.round(((r / t) - 1) * 100);
        dEl.textContent = (pct >= 0 ? `+${pct}%` : `${pct}%`);
        const abs = Math.abs(pct);
        let cls = 'kcal-delta ';
        if (abs <= 5) cls += 'ok';
        else if (pct > 5) cls += 'over';
        else cls += 'under';
        dEl.className = cls;
      } catch {}
    }

    // --- Popover: Hedef kcal detay ---
    function computeEffectiveSettingsFor(aktif) {
      // Not: Bu fonksiyon minimal IO yapmalı; mümkünse önceden yüklenmiş verileri kullan
      return (async () => {
        const gh = getGithubRepoAndToken();
        let remoteHasta = null, remoteDefaults = null;
        if (gh) {
          try { remoteHasta = await githubGetFileJson(`patients/${aktif.id}/settings.json`, true); } catch {}
          try { remoteDefaults = await githubGetFileJson('settings/defaults.json', true); } catch {}
        }
        const localHasta = (typeof loadUserSettingsLocal === 'function') ? loadUserSettingsLocal(aktif.id) : null;
        const localDefaults = (typeof loadUserSettingsLocal === 'function') ? loadUserSettingsLocal('default') : null;
        const etkinHastaRaw = remoteHasta || localHasta || {};
        // Haftalık override varsa etkinle birleştir
        let etkinHasta = etkinHastaRaw;
        try {
          const haftaListesi = (typeof getHaftaListesi === 'function') ? getHaftaListesi() : [];
          const idx = (typeof getAktifHaftaIndex === 'function') ? getAktifHaftaIndex() : (haftaListesi.length ? haftaListesi.length - 1 : 0);
          const haftaNo = (haftaListesi?.[idx]?.haftaNo) || (idx + 1);
          const w = etkinHastaRaw?.weeklyOverrides?.[String(haftaNo)] || etkinHastaRaw?.weeklyOverrides?.[haftaNo];
          if (w) etkinHasta = { ...etkinHastaRaw, ...w };
        } catch {}
        const dietType = etkinHasta.dietType || 'lowcarb';
        const activityLevel = parseInt(etkinHasta.activityLevel || 3, 10);
        const goal = etkinHasta.goal || 'maintain';
        const weight = parseFloat(etkinHasta.weightKg ?? '0') || 0;
        const preset = window.DIET_PRESETS[dietType] || window.DIET_PRESETS.lowcarb;
        const ck = (etkinHasta?.perKg?.carbsPerKg)
          ?? (remoteDefaults?.perKg?.carbsPerKg)
          ?? (localDefaults?.perKg?.carbsPerKg)
          ?? preset.carbsPerKg;
        const pk = (etkinHasta?.perKg?.proteinPerKg)
          ?? (remoteDefaults?.perKg?.proteinPerKg)
          ?? (localDefaults?.perKg?.proteinPerKg)
          ?? preset.proteinPerKg;
        const fk = (etkinHasta?.perKg?.fatPerKg)
          ?? (remoteDefaults?.perKg?.fatPerKg)
          ?? (localDefaults?.perKg?.fatPerKg)
          ?? preset.fatPerKg;
        const dist = (typeof normalizeMealDistribution === 'function') ? normalizeMealDistribution(etkinHasta.mealDistribution || window.DEFAULT_MEAL_DISTRIBUTION) : (etkinHasta.mealDistribution || window.DEFAULT_MEAL_DISTRIBUTION);
        // goalPct: Hasta ayarındaki değer öncelikli; yoksa defaults; o da yoksa 0
        const goalPct = (typeof etkinHasta.goalPct === 'number')
          ? etkinHasta.goalPct
          : (typeof remoteDefaults?.goalPct === 'number')
            ? remoteDefaults.goalPct
            : (typeof localDefaults?.goalPct === 'number')
              ? localDefaults.goalPct
              : 0;
  return { dietType, activityLevel, goal, goalPct, weight, perKg: { ck, pk, fk }, dist };
      })();
    }

    function calcTargetsFromSettings(s) {
      const af = window.ACTIVITY_FACTORS[s.activityLevel] || 1.0;
  const hasCustom = isFinite(s.goalPct) && s.goalPct !== 0;
  const base = hasCustom ? 1.0 : (window.GOAL_FACTORS[s.goal] || 1.0);
  const gp = hasCustom ? (1 + s.goalPct/100) : 1.0;
  const factor = af * base * gp;
      const carbs = Math.round(s.weight * s.perKg.ck * factor * 10)/10;
      const protein = Math.round(s.weight * s.perKg.pk * factor * 10)/10;
      const fat = Math.round(s.weight * s.perKg.fk * factor * 10)/10;
      const calories = Math.round(carbs*4 + protein*4 + fat*9);
      return { calories, carbs, protein, fat };
    }

    function calcMealBreakdown(targets, dist) {
      const pct = {
        kahvalti: (dist.kahvalti||0)/100,
        ogle: (dist.ogle||0)/100,
        aksam: (dist.aksam||0)/100,
        ara: (dist.ara||0)/100,
      };
      const parts = {};
      for (const k of ['kahvalti','ogle','aksam','ara']) {
        parts[k] = {
          kcal: Math.round(targets.calories * pct[k]),
          c: Math.round(targets.carbs * pct[k] * 10)/10,
          p: Math.round(targets.protein * pct[k] * 10)/10,
          f: Math.round(targets.fat * pct[k] * 10)/10,
        };
      }
      return parts;
    }

    // Aktif hafta tabında hangi öğün başlıkları varsa tespit et (🍽️ satırları)
    // SIKILIK KURALI:
    //  - Kahvaltı ve Ara öğün başlıkları SADECE tam başlıkla kabul edilir (örn: "Kahvaltı", "Ara öğün").
    //  - Öğle ve Akşam önceki esnek kuralla (normalizeOgunAdi) algılanmaya devam eder.
    function getPresentMealKeysInActiveWeek() {
      try {
        const rows = document.querySelectorAll('#veritabaniAnaliziContent table tbody tr');
        const present = new Set();
        rows.forEach(row => {
          const firstCell = row.querySelector('td');
          if (!firstCell) return;
          const cellText = (firstCell.textContent || '').trim();
          if (cellText.includes('🍽️')) {
            // Önce kahvaltı/ara için sıkı eşleşme dene
            const raw = cellText
              .replace(/🍽️/g, '')
              .trim()
              .toLowerCase();
            const keyStrict = strictMealKeyForHeaderText(raw);
            if (keyStrict) {
              present.add(keyStrict);
            } else {
              // Öğle/Akşam için esnek algılama (mevcut davranışı koru)
              const n = normalizeOgunAdi(cellText);
              const keyLoose = normalizedMealToKey(n);
              if (keyLoose === 'ogle' || keyLoose === 'aksam') present.add(keyLoose);
            }
          }
        });
        return Array.from(present);
      } catch (e) {
        console.warn('getPresentMealKeysInActiveWeek error:', e);
        return [];
      }
    }

    // Yalnızca tam başlıkları key'e dönüştür (eşleşme yoksa null)
    function strictMealKeyForHeaderText(textLower) {
      const t = String(textLower || '').trim();
      // Sadece kahvaltı ve ara öğün için sıkı eşleşme uygula
      if (t === 'kahvaltı' || t === 'kahvalti') return 'kahvalti';
      if (t === 'ara öğün' || t === 'ara ogun') return 'ara';
      return null;
    }

    function normalizedMealToKey(n) {
      if (!n) return null;
      const s = String(n).toLowerCase();
      if (s === 'kahvaltı' || s === 'kahvalti' || s.includes('sabah')) return 'kahvalti';
      if (s === 'öğle' || s === 'ogle') return 'ogle';
      if (s === 'akşam' || s === 'aksam') return 'aksam';
      if (s.startsWith('ara')) return 'ara';
      return null;
    }

    function mealKeyToLabel(key) {
      switch (key) {
        case 'kahvalti': return 'Kahvaltı';
        case 'ogle': return 'Öğle';
        case 'aksam': return 'Akşam';
        case 'ara': return 'Ara';
        default: return key;
      }
    }

    function orderMealKeys(keys) {
      const order = ['kahvalti','ogle','aksam','ara'];
      return keys.slice().sort((a,b) => order.indexOf(a) - order.indexOf(b));
    }

    // Seçili öğünler için dağılımı yeniden normalize et (kalan yüzdeyi ağırlığa göre paylaştır)
    function renormalizeDistributionForKeys(dist, keys) {
      const base = {
        kahvalti: Number(dist?.kahvalti || 0),
        ogle: Number(dist?.ogle || 0),
        aksam: Number(dist?.aksam || 0),
        ara: Number(dist?.ara || 0),
      };
      const out = { kahvalti: 0, ogle: 0, aksam: 0, ara: 0 };
      if (!keys || keys.length === 0) return base; // tümünü kullan
      const sum = keys.reduce((acc, k) => acc + (base[k] || 0), 0);
      if (sum <= 0) {
        // Hepsi 0 ise eşit böl
        const even = 100 / keys.length;
        keys.forEach(k => { out[k] = even; });
        return out;
      }
      keys.forEach(k => { out[k] = (base[k] || 0) * 100 / sum; });
      return out;
    }

    async function toggleKcalPopover(ev) {
      const badgeEl = ev.currentTarget;
      const pop = document.getElementById('kcalPopover');
      if (!pop) return;
      if (pop.style.display === 'block') { pop.style.display = 'none'; return; }

      const aktif = getCurrentHasta();
      if (!aktif) return;

      // Hesapla
      const eff = await computeEffectiveSettingsFor(aktif);
      // Haftaya özel override var mı?
      let hasWeekOverride = false;
      try {
        const gh = getGithubRepoAndToken();
        let remoteHasta = null;
        if (gh) {
          try { remoteHasta = await githubGetFileJson(`patients/${aktif.id}/settings.json`, true); } catch {}
        }
        const localHasta = (typeof loadUserSettingsLocal === 'function') ? loadUserSettingsLocal(aktif.id) : null;
        const etkinHastaRaw = remoteHasta || localHasta || {};
        let haftaNo = null;
        try {
          const haftaListesi = (typeof getHaftaListesi === 'function') ? getHaftaListesi() : [];
          const idx = (typeof getAktifHaftaIndex === 'function') ? getAktifHaftaIndex() : (haftaListesi.length ? haftaListesi.length - 1 : 0);
          haftaNo = (haftaListesi?.[idx]?.haftaNo) || (idx + 1);
        } catch {}
        hasWeekOverride = !!(etkinHastaRaw?.weeklyOverrides?.[String(haftaNo)] || etkinHastaRaw?.weeklyOverrides?.[haftaNo]);
      } catch {}
      const t = calcTargetsFromSettings(eff);

      // Aktif haftada görünen öğünleri bul (varsa bunları, yoksa tümünü göster)
      let keys = getPresentMealKeysInActiveWeek();
      if (!keys || keys.length === 0) keys = ['kahvalti','ogle','aksam','ara'];
      keys = orderMealKeys(keys);

      // Seçili öğünler için dağılımı yeniden normalize et ve parçaları hesapla
      const distForKeys = (keys.length === 4)
        ? eff.dist
        : renormalizeDistributionForKeys(eff.dist, keys);
      const parts = calcMealBreakdown(t, distForKeys);
      const rowsHtml = keys.map(k => {
        const pct = Math.round(distForKeys[k] || 0);
        return `<div>${mealKeyToLabel(k)} (${pct}%)</div><div><strong>${parts[k].kcal}</strong> kcal · C ${parts[k].c} · P ${parts[k].p} · F ${parts[k].f}</div>`;
      }).join('\n');

      // Mevcut analizden gerçekleşen günlük ortalamayı al (varsa)
      let realizedAvg = null;
      try {
        const ortBadge = document.getElementById('gercekKcalBadgeValue');
        if (ortBadge) realizedAvg = parseInt(ortBadge.textContent.replace(/[^0-9]/g,'')) || null;
      } catch {}

      // İçeriği doldur
      pop.innerHTML = `
        <h4>🎯 Günlük Hedef Dağılımı</h4>
        <div class="row" style="align-items:center; gap:8px;">
          <span class="muted">Toplam</span>
          <div style="display:flex; gap:10px; align-items:center;">
            <strong>${t.calories} kcal</strong>
            <span class="muted">·</span>
            <span>C ${t.carbs}</span>
            <span class="muted">·</span>
            <span>P ${t.protein}</span>
            <span class="muted">·</span>
            <span>F ${t.fat}</span>
            <span class="muted">·</span>
            <span class="kcal-plan" title="Hedef % (±) — global ya da hafta özel">${(() => { const v = Math.round(eff.goalPct||0); return v>0?`+${v}%`:`${v}%`; })()}</span>
            ${hasWeekOverride ? '<span class="muted">·</span><span class="kcal-week-pill" title="Bu hafta için özel ayarlar aktif">Hafta özel</span>' : ''}
          </div>
        </div>
        ${realizedAvg ? `<div class="row" style="align-items:center; gap:8px;"><span class="muted">Gerçekleşen</span><div><strong>${realizedAvg} kcal</strong></div></div>` : ''}
        <div class="grid" style="margin-top:6px;">
          ${rowsHtml}
        </div>
      `;

      // Konumlandır (badge altına)
      const rect = badgeEl.getBoundingClientRect();
      const top = rect.bottom + 8 + window.scrollY;
      const left = Math.min(window.scrollX + rect.left, window.scrollX + window.innerWidth - 340);
      pop.style.top = `${top}px`;
      pop.style.left = `${left}px`;
      pop.style.display = 'block';

      // Dış tık ile kapat
      const closeOnOutside = (e) => {
        if (!pop.contains(e.target) && e.target !== badgeEl) {
          pop.style.display = 'none';
          window.removeEventListener('mousedown', closeOnOutside);
          window.removeEventListener('scroll', closeOnOutside, true);
          window.removeEventListener('resize', closeOnOutside);
        }
      };
      window.addEventListener('mousedown', closeOnOutside);
      window.addEventListener('scroll', closeOnOutside, true);
      window.addEventListener('resize', closeOnOutside);
    }

    // Varsayılan yükle/kaydet (localStorage) — TODO[PM-05]: GitHub ile senkronla
    async function ayarVarsayilaniYukle() {
      try {
        const gh = getGithubRepoAndToken();
        let defaults = null;
        if (gh) {
          try { defaults = await githubGetFileJson('settings/defaults.json', true); } catch {}
        }
        if (!defaults) { defaults = (typeof loadUserSettingsLocal === 'function') ? loadUserSettingsLocal('default') : null; }
        if (!defaults) { alert('Sistem varsayılanı bulunamadı.'); return; }
        // Diyet
        qs('ayar_dietType').value = defaults.dietType || 'lowcarb';
        qs('ayar_activity').value = String(defaults.activityLevel || 3);
        qs('ayar_goal').value = defaults.goal || 'maintain';
  if (qs('ayar_goalPct')) qs('ayar_goalPct').value = typeof defaults.goalPct === 'number' ? defaults.goalPct : 0;
        qs('ayar_weight').value = defaults.weightKg || '';
        qs('ayar_ck').value = defaults.perKg?.carbsPerKg ?? window.DIET_PRESETS.lowcarb.carbsPerKg;
        qs('ayar_pk').value = defaults.perKg?.proteinPerKg ?? window.DIET_PRESETS.lowcarb.proteinPerKg;
        qs('ayar_fk').value = defaults.perKg?.fatPerKg ?? window.DIET_PRESETS.lowcarb.fatPerKg;
        const n = (typeof normalizeMealDistribution === 'function') ? normalizeMealDistribution(defaults.mealDistribution || window.DEFAULT_MEAL_DISTRIBUTION) : (defaults.mealDistribution || window.DEFAULT_MEAL_DISTRIBUTION);
        ['kahvalti','ogle','aksam','ara'].forEach(k => { qs('ayar_'+k).value = n[k]; qs('ayar_'+k+'_r').value = n[k]; });
        guncelleToplam();
        hedefMakroGuncelle();
      } catch (e) { console.error('ayarVarsayilaniYukle', e); }
    }

    // =============================
    // 📈 Kilo Seyri modal mantığı
    // =============================
    function kiloSeyriModalKapat(ev) {
      if (ev && ev.target && ev.currentTarget && ev.target !== ev.currentTarget) return;
      const m = document.getElementById('kiloSeyriModal');
      if (m) m.style.display = 'none';
    }

    async function acKiloSeyri() {
      const aktif = getCurrentHasta();
      if (!aktif) { alert('Önce bir hasta seçin.'); return; }
  const m = document.getElementById('kiloSeyriModal');
  const tbody = document.getElementById('kiloSeyriBody');
  if (!m || !tbody) return;

      // Tüm haftaları sırala
      const haftalar = (typeof getHaftaListesi === 'function') ? getHaftaListesi() : [];
      // Hasta ayarlarını yükle (remote > local)
      const gh = getGithubRepoAndToken();
      let remoteHasta = null, remoteDefaults = null;
      if (gh) {
        try { remoteHasta = await githubGetFileJson(`patients/${aktif.id}/settings.json`, true); } catch {}
        try { remoteDefaults = await githubGetFileJson('settings/defaults.json', true); } catch {}
      }
      const localHasta = (typeof loadUserSettingsLocal === 'function') ? loadUserSettingsLocal(aktif.id) : null;
      const localDefaults = (typeof loadUserSettingsLocal === 'function') ? loadUserSettingsLocal('default') : null;
  const baseHasta = remoteHasta || localHasta || {};
  // Ölçümler formu placeholder’ları ve Rapor için cache: local+remote birleştir
  try {
    const mergedWeekly = { ...(localHasta?.weeklyOverrides || {}), ...(remoteHasta?.weeklyOverrides || {}) };
    window.__cachedWeeklyOverrides = mergedWeekly;
  } catch {}

      // Yardımcı: hedef kcal hesapla (goalPct mantığı ile)
      const calcKcal = (weight, perKg, activityLevel, goal, goalPct) => {
        const af = window.ACTIVITY_FACTORS[activityLevel] || 1.0;
        const hasCustom = isFinite(goalPct) && goalPct !== 0;
        const base = hasCustom ? 1.0 : (window.GOAL_FACTORS[goal] || 1.0);
        const gp = hasCustom ? (1 + goalPct/100) : 1.0;
        const factor = af * base * gp;
        const c = weight * (perKg?.carbsPerKg || 0) * factor;
        const p = weight * (perKg?.proteinPerKg || 0) * factor;
        const f = weight * (perKg?.fatPerKg || 0) * factor;
        return Math.round(c*4 + p*4 + f*9);
      };

      // Haftalara özel gerçekleşen günlük ortalamayı kullanacağız.
      // Not: Değer, PDF analizi sırasında updateTotalRows() içinde aktif hafta için cache'lenir.

      // Satırları oluştur
      let firstWeight = null;
      let prevWeight = null;
      const weightSeries = [];
      const weekNumbers = [];
      const weekDates = [];
      const rows = haftalar.map(h => {
        const haftaNo = h?.haftaNo ?? null;
        weekNumbers.push(haftaNo);
        // Hafta tarihini formatla
        const weekDate = h?.baslangic ? h.baslangic : null;
        weekDates.push(weekDate);
        // Hafta override
        const { has: hasOv, override } = findWeekOverride(baseHasta, haftaNo);
        // Etkin ayarlar: override varsa birleştir
        const etkin = hasOv ? { ...baseHasta, ...override } : baseHasta;
        const dietType = etkin.dietType || 'lowcarb';
        const preset = window.DIET_PRESETS[dietType] || window.DIET_PRESETS.lowcarb;
        const perKg = {
          carbsPerKg: (etkin?.perKg?.carbsPerKg) ?? (remoteDefaults?.perKg?.carbsPerKg) ?? (localDefaults?.perKg?.carbsPerKg) ?? preset.carbsPerKg,
          proteinPerKg: (etkin?.perKg?.proteinPerKg) ?? (remoteDefaults?.perKg?.proteinPerKg) ?? (localDefaults?.perKg?.proteinPerKg) ?? preset.proteinPerKg,
          fatPerKg: (etkin?.perKg?.fatPerKg) ?? (remoteDefaults?.perKg?.fatPerKg) ?? (localDefaults?.perKg?.fatPerKg) ?? preset.fatPerKg,
        };
        const activityLevel = parseInt(etkin.activityLevel || 3, 10);
        const goal = etkin.goal || 'maintain';
        const goalPct = (typeof etkin.goalPct === 'number') ? etkin.goalPct : (typeof remoteDefaults?.goalPct === 'number') ? remoteDefaults.goalPct : (typeof localDefaults?.goalPct === 'number') ? localDefaults.goalPct : 0;
        // Kilo: sadece hafta bazlı giriş varsa kullan; global fallback kullanma
        let weight = null;
        if (hasOv && isFinite(parseFloat(override?.weightKg)) && parseFloat(override.weightKg) > 0) {
          weight = parseFloat(override.weightKg);
        } else if (isFinite(parseFloat(h?.weightKg)) && parseFloat(h.weightKg) > 0) {
          weight = parseFloat(h.weightKg);
        } else {
          weight = null; // veri yok
        }
        weightSeries.push(isFinite(weight) && weight > 0 ? weight : null);
        if (firstWeight === null && isFinite(weight) && weight > 0) firstWeight = weight;
        const deltaKg = (isFinite(prevWeight) && prevWeight > 0 && isFinite(weight) && weight > 0) ? (Math.round((weight - prevWeight) * 10) / 10) : null;
        const totalDeltaKg = (isFinite(firstWeight) && firstWeight > 0 && isFinite(weight) && weight > 0) ? (Math.round((weight - firstWeight) * 10) / 10) : null;
        prevWeight = isFinite(weight) && weight > 0 ? weight : prevWeight;
        
        // Hedef kcal hesaplama: sadece kilo varsa hesapla
        const kcal = (isFinite(weight) && weight > 0) ? calcKcal(weight, perKg, activityLevel, goal, goalPct) : null;
        const planPct = Math.round(isFinite(goalPct) ? goalPct : 0);
        // Hafta bazlı gerçekleşen ortalama kcal: önce hafta objesinden, yoksa opsiyonel cache'ten al
        let realizedAvg = null;
        try {
          if (isFinite(h?.realizedAvgKcal) && h.realizedAvgKcal > 0) {
            realizedAvg = Math.round(Number(h.realizedAvgKcal));
          } else {
            const aktif = getCurrentHasta();
            const cached = window.__weeklyRealizedAvg
              && aktif && window.__weeklyRealizedAvg[aktif.id]
              && window.__weeklyRealizedAvg[aktif.id][String(haftaNo)];
            if (isFinite(cached) && cached > 0) {
              realizedAvg = Math.round(Number(cached));
            }
          }
        } catch {}
        // 0 veya geçersizse boş göster
        if (!isFinite(realizedAvg) || realizedAvg <= 0) realizedAvg = null;
        const deltaPct = (isFinite(kcal) && kcal > 0 && isFinite(realizedAvg) && realizedAvg > 0)
          ? Math.round(((realizedAvg / kcal) - 1) * 100)
          : null;
        return `<tr>
          <td style="padding:8px; border-bottom:1px solid #f1f3f5;">${haftaNo ?? '-'}</td>
          <td style="padding:8px; border-bottom:1px solid #f1f3f5;">
            <input type="number" inputmode="decimal" min="1" step="0.1" data-hafta="${haftaNo ?? ''}" class="hafta-weight-input" value="${weight ? weight.toFixed(1) : ''}" placeholder="kg" style="width:100px; padding:6px; border:1px solid #ced4da; border-radius:6px;">
          </td>
          <td style="padding:8px; border-bottom:1px solid #f1f3f5;">${(kcal && isFinite(kcal)) ? kcal : '-'}</td>
          <td style="padding:8px; border-bottom:1px solid #f1f3f5;">${(isFinite(realizedAvg) && realizedAvg>0) ? realizedAvg : '-'}</td>
          <td style="padding:8px; border-bottom:1px solid #f1f3f5;">${(deltaPct!==null) ? (deltaPct>=0?`+${deltaPct}%`:`${deltaPct}%`) : ''}</td>
          <td style="padding:8px; border-bottom:1px solid #f1f3f5;">${(deltaKg!==null) ? (deltaKg>0?`+${deltaKg}`:`${deltaKg}`) : ''}</td>
          <td style="padding:8px; border-bottom:1px solid #f1f3f5;">${(totalDeltaKg!==null) ? (totalDeltaKg>0?`+${totalDeltaKg}`:`${totalDeltaKg}`) : ''}</td>
          <td style="padding:8px; border-bottom:1px solid #f1f3f5;">${planPct>0?`+${planPct}%`:`${planPct}%`}</td>
          <td style="padding:8px; border-bottom:1px solid #f1f3f5;">${hasOv ? '<span class="kcal-week-pill">Hafta özel</span>' : '-'}</td>
        </tr>`;
      }).join('');

      tbody.innerHTML = rows || '<tr><td colspan="9" style="padding:10px; color:#6c757d;">Bu hastada hafta verisi bulunamadı.</td></tr>';

      // Sparkline çizimi
      try {
        renderSparkline('kiloSparkline', weightSeries, weekNumbers, weekDates);
        const kiloSvg = document.getElementById('kiloSparkline');
        if (kiloSvg) {
          kiloSvg.style.cursor = 'pointer';
          kiloSvg.onclick = () => openLargeChartModal('Kilo Trendi', weightSeries, weekNumbers, 'kg', weekDates, '#0d6efd');
        }
      } catch (e) { console.warn('sparkline draw warn:', e?.message || e); }

      // Ölçümler sekmesi formunu da hazırla (aktif haftaya göre)
      try {
        const haftaListesi = (typeof getHaftaListesi === 'function') ? getHaftaListesi() : [];
        const idx = (typeof getAktifHaftaIndex === 'function') ? getAktifHaftaIndex() : (haftaListesi.length ? haftaListesi.length - 1 : 0);
        const haftaNo = (haftaListesi?.[idx]?.haftaNo) || (idx + 1);
        const { has, override } = findWeekOverride(baseHasta, haftaNo);
        const mvals = has && override?.measurements ? override.measurements : {};
        renderOlcumForm(haftaNo, mvals);
        // Ölçüm sparkline seçeneklerini yükle ve çiz
        try {
          bindOlcumSparkline(baseHasta, haftaListesi);
        } catch(e){ console.warn('olcum spark bind warn:', e?.message || e); }
      } catch {}
      m.style.display = 'block';
    }

    function renderSparkline(svgId, series, weeks, dates) {
      const svg = document.getElementById(svgId);
      if (!svg) return;
      const w = svg.viewBox && svg.viewBox.baseVal ? svg.viewBox.baseVal.width : (parseInt(svg.getAttribute('width')) || 120);
      const h = svg.viewBox && svg.viewBox.baseVal ? svg.viewBox.baseVal.height : (parseInt(svg.getAttribute('height')) || 28);
      // Filter valid numbers
      const pts = (series || []).map(v => (isFinite(v) && v > 0) ? v : null);
      const valid = pts.filter(v => v !== null);
      svg.innerHTML = '';
      // Background baseline
      const bg = document.createElementNS('http://www.w3.org/2000/svg','rect');
      bg.setAttribute('x','0'); bg.setAttribute('y','0'); bg.setAttribute('width', String(w)); bg.setAttribute('height', String(h));
      bg.setAttribute('fill','#f8f9fa');
      svg.appendChild(bg);
      if (valid.length < 2) {
        // Not enough data, draw a faint placeholder line
        const line = document.createElementNS('http://www.w3.org/2000/svg','line');
        line.setAttribute('x1','0'); line.setAttribute('y1', String(h/2));
        line.setAttribute('x2', String(w)); line.setAttribute('y2', String(h/2));
        line.setAttribute('stroke', '#dee2e6'); line.setAttribute('stroke-width','1');
        svg.appendChild(line);
        attachSparkEvents(svg, []);
        return;
      }
      const min = Math.min.apply(null, valid);
      const max = Math.max.apply(null, valid);
      const range = (max - min) || 1;
      const n = pts.length;
      const xStep = n > 1 ? (w / (n - 1)) : w;
      // Build path skipping nulls
      let d = '';
      let firstDrawn = true;
      const drawnPoints = [];
      for (let i = 0; i < n; i++) {
        const v = pts[i];
        if (v === null) continue;
        const x = i * xStep;
        const y = h - ((v - min) / range) * (h - 4) - 2; // 2px padding top/bottom
        d += (firstDrawn ? `M ${x.toFixed(1)} ${y.toFixed(1)}` : ` L ${x.toFixed(1)} ${y.toFixed(1)}`);
        firstDrawn = false;
        drawnPoints.push({ x, y, val: v, idx: i, week: (weeks && typeof weeks[i] !== 'undefined') ? weeks[i] : (i + 1), date: (dates && typeof dates[i] !== 'undefined') ? dates[i] : null });
      }
      // Determine color by overall trend (first valid to last valid)
      const firstIdx = pts.findIndex(v => v !== null);
      let lastIdx = -1; for (let i = pts.length - 1; i >= 0; i--) { if (pts[i] !== null) { lastIdx = i; break; } }
      const trendUp = lastIdx > firstIdx ? (pts[lastIdx] - pts[firstIdx]) >= 0 : false;
      const color = trendUp ? '#dc3545' : '#198754'; // up = red (weight up), down = green
      const path = document.createElementNS('http://www.w3.org/2000/svg','path');
      path.setAttribute('d', d);
      path.setAttribute('fill','none');
      path.setAttribute('stroke', color);
      path.setAttribute('stroke-width','2');
      path.setAttribute('stroke-linecap','round');
      path.setAttribute('stroke-linejoin','round');
      svg.appendChild(path);

      // Nokta marker'ları
      for (const p of drawnPoints) {
        const c = document.createElementNS('http://www.w3.org/2000/svg','circle');
        c.setAttribute('cx', p.x.toFixed(1));
        c.setAttribute('cy', p.y.toFixed(1));
        c.setAttribute('r', '2.5');
        c.setAttribute('fill', color);
        c.setAttribute('opacity', '0.9');
        svg.appendChild(c);
      }

      // Hover tooltip ve en yakın noktayı bulma
      attachSparkEvents(svg, drawnPoints);
    }

    // Büyük grafik modalı
    function openLargeChartModal(title, series, weeks, unit, dates, color) {
      let modal = document.getElementById('chartLargeModal');
      if (!modal) {
        const html = `
        <div id="chartLargeModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:10020;" onclick="closeLargeChartModal(event)">
          <div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:94%; max-width:1100px; max-height:85vh; background:#fff; border-radius:12px; overflow:hidden;" onclick="event.stopPropagation()">
            <div style="padding:12px 16px; border-bottom:1px solid #e9ecef; display:flex; align-items:center; justify-content:space-between;">
              <div style="font-weight:600;">📊 <span id="largeChartTitle"></span></div>
              <button onclick="closeLargeChartModal()" style="background:#dc3545; color:#fff; border:none; border-radius:6px; padding:6px 10px; cursor:pointer; font-size:12px;">Kapat</button>
            </div>
            <div style="padding:12px;">
              <svg id="largeChartSVG" viewBox="0 0 900 420" width="100%" height="420" preserveAspectRatio="none" style="background:#f8f9fa; border-radius:8px;"></svg>
            </div>
          </div>
        </div>`;
        const wrap = document.createElement('div');
        wrap.innerHTML = html;
        document.body.appendChild(wrap.firstElementChild);
        modal = document.getElementById('chartLargeModal');
      }
      // Başlık
      document.getElementById('largeChartTitle').textContent = title;
      // Çiz
      drawLargeChart('largeChartSVG', series, weeks, unit, dates, color);
      modal.style.display = 'block';
    }
    function closeLargeChartModal(ev){
      if (ev && ev.target && ev.currentTarget && ev.target !== ev.currentTarget) return;
      const modal = document.getElementById('chartLargeModal');
      if (modal) modal.style.display = 'none';
    }
    function drawLargeChart(svgId, series, weeks, unit, dates, color) {
      const svg = document.getElementById(svgId);
      if (!svg) return;
      const vbW = 900, vbH = 420;
      svg.innerHTML = '';
      const valid = (series || []).map(v => (isFinite(v) && v > 0) ? v : null).filter(v => v !== null);
      // grid
      const g = document.createElementNS('http://www.w3.org/2000/svg','rect');
      g.setAttribute('x','0'); g.setAttribute('y','0'); g.setAttribute('width', String(vbW)); g.setAttribute('height', String(vbH)); g.setAttribute('fill','#f8f9fa');
      svg.appendChild(g);
      // axis
      const margin = { l: 48, r: 16, t: 16, b: 32 };
      const plotW = vbW - margin.l - margin.r;
      const plotH = vbH - margin.t - margin.b;
      const originX = margin.l, originY = margin.t + plotH;
      // axes lines
      const axX = document.createElementNS('http://www.w3.org/2000/svg','line');
      axX.setAttribute('x1', String(originX)); axX.setAttribute('y1', String(originY)); axX.setAttribute('x2', String(originX + plotW)); axX.setAttribute('y2', String(originY)); axX.setAttribute('stroke','#adb5bd'); axX.setAttribute('stroke-width','1');
      const axY = document.createElementNS('http://www.w3.org/2000/svg','line');
      axY.setAttribute('x1', String(originX)); axY.setAttribute('y1', String(originY)); axY.setAttribute('x2', String(originX)); axY.setAttribute('y2', String(margin.t)); axY.setAttribute('stroke','#adb5bd'); axY.setAttribute('stroke-width','1');
      svg.appendChild(axX); svg.appendChild(axY);
      if (valid.length < 2) return;
      const min = Math.min.apply(null, valid); const max = Math.max.apply(null, valid); const range = (max - min) || 1;
      
      // Renk varsayılan değeri
      color = color || '#0d6efd';
      
      // ticks: 4 yatay çizgi
      for (let i=1;i<=4;i++) {
        const y = originY - (i*plotH/4);
        const ln = document.createElementNS('http://www.w3.org/2000/svg','line');
        ln.setAttribute('x1', String(originX)); ln.setAttribute('y1', String(y)); ln.setAttribute('x2', String(originX+plotW)); ln.setAttribute('y2', String(y)); ln.setAttribute('stroke','#e9ecef');
        svg.appendChild(ln);
        const label = document.createElementNS('http://www.w3.org/2000/svg','text');
        const val = min + (range*(i/4));
        label.setAttribute('x', String(8)); label.setAttribute('y', String(y+4)); label.setAttribute('fill','#495057'); label.setAttribute('font-size','11'); label.textContent = val.toFixed(1) + ' ' + unit;
        svg.appendChild(label);
      }
      // path
      const n = series.length; const xStep = n>1 ? (plotW/(n-1)) : plotW;
      let d = ''; let first = true; const pts = [];
      for (let i=0;i<n;i++){
        const v = (isFinite(series[i]) && series[i] > 0) ? series[i] : null;
        if (v===null) continue;
        const x = originX + (i * xStep);
        const y = originY - ((v - min)/range) * plotH;
        d += first ? `M ${x.toFixed(1)} ${y.toFixed(1)}` : ` L ${x.toFixed(1)} ${y.toFixed(1)}`;
        first = false; pts.push({x,y,val:v,week: weeks && weeks[i] ? weeks[i] : (i+1), date: dates && dates[i] ? dates[i] : null});
      }
      const p = document.createElementNS('http://www.w3.org/2000/svg','path');
      p.setAttribute('d', d); p.setAttribute('fill','none'); p.setAttribute('stroke', color); p.setAttribute('stroke-width','2.5');
      svg.appendChild(p);
      for (const pt of pts){
        const c = document.createElementNS('http://www.w3.org/2000/svg','circle');
        c.setAttribute('cx', pt.x.toFixed(1)); c.setAttribute('cy', pt.y.toFixed(1)); c.setAttribute('r','3'); c.setAttribute('fill', color); svg.appendChild(c);
        
        // Veri noktası etiketi (üstte)
        const t = document.createElementNS('http://www.w3.org/2000/svg','text');
        t.setAttribute('x', String(pt.x + 4)); t.setAttribute('y', String(pt.y - 6)); t.setAttribute('fill','#212529'); t.setAttribute('font-size','11'); 
        
        // Değer formatlaması: ondalık varsa göster, yoksa tam sayı
        const formattedValue = (pt.val % 1 === 0) ? pt.val.toString() : pt.val.toFixed(1);
        t.textContent = `${formattedValue} ${unit}`; 
        svg.appendChild(t);
        
        // X-eksen etiketi (altta)
        const xLabel = document.createElementNS('http://www.w3.org/2000/svg','text');
        xLabel.setAttribute('x', String(pt.x)); 
        xLabel.setAttribute('y', String(originY + 18)); 
        xLabel.setAttribute('fill','#495057'); 
        xLabel.setAttribute('font-size','10'); 
        xLabel.setAttribute('text-anchor','middle');
        
        // İlk satır: Hafta numarası
        const tspan1 = document.createElementNS('http://www.w3.org/2000/svg','tspan');
        tspan1.textContent = `Hafta ${pt.week}`;
        xLabel.appendChild(tspan1);
        
        // İkinci satır: Tarih (varsa)
        if (pt.date) {
          const dateObj = new Date(pt.date);
          if (!isNaN(dateObj.getTime())) {
            const shortDate = `${(dateObj.getMonth() + 1).toString().padStart(2, '0')}/${dateObj.getDate().toString().padStart(2, '0')}`;
            const tspan2 = document.createElementNS('http://www.w3.org/2000/svg','tspan');
            tspan2.setAttribute('x', String(pt.x));
            tspan2.setAttribute('dy', '12'); // Alt satıra geç
            tspan2.textContent = `(${shortDate})`;
            xLabel.appendChild(tspan2);
          }
        }
        
        svg.appendChild(xLabel);
      }
    }

    function attachSparkEvents(svg, points) {
      const unit = (svg.id || '').toLowerCase().includes('kilo') ? 'kg' : 'cm';
      // Tooltip div (sabit/tek seferlik)
      const tipId = svg.id + '_tooltip';
      let tip = document.getElementById(tipId);
      if (!tip) {
        tip = document.createElement('div');
        tip.id = tipId;
        tip.style.position = 'fixed';
        tip.style.pointerEvents = 'none';
        tip.style.zIndex = '10010';
        tip.style.background = 'rgba(0,0,0,0.75)';
        tip.style.color = '#fff';
        tip.style.fontSize = '11px';
        tip.style.padding = '4px 6px';
        tip.style.borderRadius = '4px';
        tip.style.boxShadow = '0 2px 6px rgba(0,0,0,0.25)';
        tip.style.display = 'none';
        document.body.appendChild(tip);
      }
      const show = (x, y, text) => {
        tip.textContent = text;
        tip.style.left = Math.round(x + 10) + 'px';
        tip.style.top = Math.round(y - 24) + 'px';
        tip.style.display = 'block';
      };
      const hide = () => { tip.style.display = 'none'; };
      const onMove = (ev) => {
        if (!points || points.length === 0) { hide(); return; }
        const rect = svg.getBoundingClientRect();
        const mx = ev.clientX - rect.left;
        // En yakın nokta
        let best = null, bestDist = Infinity;
        for (const p of points) {
          const d = Math.abs(p.x - mx);
          if (d < bestDist) { bestDist = d; best = p; }
        }
        if (!best) { hide(); return; }
        const absX = rect.left + best.x;
        const absY = rect.top + best.y;
        const haftaTxt = (typeof best.week !== 'undefined' && best.week !== null) ? `Hafta ${best.week}` : '';
        const dateTxt = best.date ? ` (${new Date(best.date).toLocaleDateString('tr-TR', {month: '2-digit', day: '2-digit'})})` : '';
        // Değer formatlaması: ondalık varsa göster, yoksa tam sayı
        const formattedValue = (best.val % 1 === 0) ? best.val.toString() : best.val.toFixed(1);
        show(absX, absY, `${haftaTxt}${dateTxt}: ${formattedValue} ${unit}`);
      };
      svg.onmousemove = onMove;
      svg.onmouseleave = hide;
    }

    function seyirTabDegistir(tab) {
      const seyirTbl = document.getElementById('seyirTablo');
      const olcumDiv = document.getElementById('olcumIcerik');
      const raporDiv = document.getElementById('raporIcerik');
      const seyirActions = document.getElementById('seyirActions');
      const olcumActions = document.getElementById('olcumActions');
      const raporActions = document.getElementById('raporActions');
      const a = document.getElementById('seyirTabBtn');
      const b = document.getElementById('olcumTabBtn');
      const c = document.getElementById('raporTabBtn');
      if (!seyirTbl || !olcumDiv) return;
      const isOlcum = tab === 'olcum';
      const isRapor = tab === 'rapor';
      seyirTbl.style.display = (!isOlcum && !isRapor) ? 'table' : 'none';
      olcumDiv.style.display = isOlcum ? 'block' : 'none';
      if (raporDiv) raporDiv.style.display = isRapor ? 'block' : 'none';
      if (seyirActions) seyirActions.style.display = (!isOlcum && !isRapor) ? 'block' : 'none';
      if (olcumActions) olcumActions.style.display = isOlcum ? 'block' : 'none';
  if (raporActions) raporActions.style.display = isRapor ? 'flex' : 'none';
      if (a) { a.classList.toggle('active', (!isOlcum && !isRapor)); a.style.background = (!isOlcum && !isRapor) ? '#0d6efd' : '#e9ecef'; a.style.color = (!isOlcum && !isRapor) ? '#fff' : '#212529'; }
      if (b) { b.classList.toggle('active', isOlcum); b.style.background = isOlcum ? '#0d6efd' : '#e9ecef'; b.style.color = isOlcum ? '#fff' : '#212529'; }
      if (c) { c.classList.toggle('active', isRapor); c.style.background = isRapor ? '#0d6efd' : '#e9ecef'; c.style.color = isRapor ? '#fff' : '#212529'; }
      if (isRapor) {
        try { raporuYenile(); } catch(e) { console.warn('rapor draw warn:', e?.message || e); }
      }
    }

    function renderOlcumForm(haftaNo, vals) {
      const grid = document.getElementById('olcumFormGrid');
      if (!grid) return;
      const fields = [
        { key: 'bel', label: 'Bel (cm)' },
        { key: 'kalca', label: 'Kalça (cm)' },
        { key: 'ustBacakSag', label: 'Üst Bacak (Sağ) (cm)' },
        { key: 'ustBacakSol', label: 'Üst Bacak (Sol) (cm)' },
        { key: 'dizSag', label: 'Diz (Sağ) (cm)' },
        { key: 'dizSol', label: 'Diz (Sol) (cm)' },
        { key: 'baldirSag', label: 'Baldır (Sağ) (cm)' },
        { key: 'baldirSol', label: 'Baldır (Sol) (cm)' },
        { key: 'bilekSag', label: 'Bilek (Sağ) (cm)' },
        { key: 'bilekSol', label: 'Bilek (Sol) (cm)' },
        { key: 'ustKolSag', label: 'Üst Kol (Sağ) (cm)' },
        { key: 'ustKolSol', label: 'Üst Kol (Sol) (cm)' },
      ];
      // Önceki haftanın en son girilen ölçümlerini placeholder olarak belirleyelim
      const aktif = getCurrentHasta();
      let placeholders = {};
      try {
        const gh = getGithubRepoAndToken();
        // Not: render içinde async yapmak istemiyoruz; elde var olan cache/bellekten baseHasta geçiyoruz
        // acKiloSeyri içinde baseHasta ile çağrıldığı için, burada mevcut weeklyOverrides'a erişmek yeterli.
        const mevcut = (typeof loadUserSettingsLocal === 'function') ? (aktif?.id ? loadUserSettingsLocal(aktif.id) : null) : null;
        const weekly = (mevcut && mevcut.weeklyOverrides) ? mevcut.weeklyOverrides : (window.__cachedWeeklyOverrides || {});
        // aktif hafta numarasından geriye doğru ara
        const numHafta = parseInt(haftaNo, 10);
        const keys = Object.keys(weekly || {});
        for (let h = numHafta - 1; h >= 1; h--) {
          const ov = weekly[String(h)] || weekly[h];
          if (ov && ov.measurements) { placeholders = ov.measurements; break; }
        }
      } catch {}
      grid.innerHTML = fields.map(f => `
        <div style="display:flex; flex-direction:column; gap:6px;">
          <label style="font-size:12px; color:#495057;">${f.label}</label>
          <input type="number" step="0.1" min="0" id="olc_${f.key}" data-hafta="${haftaNo}" placeholder="${isFinite(parseFloat(placeholders?.[f.key])) ? parseFloat(placeholders[f.key]).toFixed(1) : 'cm'}" value="${isFinite(parseFloat(vals?.[f.key])) ? parseFloat(vals[f.key]).toFixed(1) : ''}" style="padding:8px; border:1px solid #ced4da; border-radius:6px; opacity:${isFinite(parseFloat(vals?.[f.key])) ? '1' : '0.9'};">
        </div>
      `).join('');
    }

    function bindOlcumSparkline(settingsObj, haftaListesi) {
      const sel = document.getElementById('olcumSparkKey');
      const svgId = 'olcumSparkline';
      if (!sel) return;
      const metricList = [
        { key: 'bel', label: 'Bel (cm)' },
        { key: 'kalca', label: 'Kalça (cm)' },
        { key: 'ustBacakSag', label: 'Üst Bacak Sağ (cm)' },
        { key: 'ustBacakSol', label: 'Üst Bacak Sol (cm)' },
        { key: 'dizSag', label: 'Diz Sağ (cm)' },
        { key: 'dizSol', label: 'Diz Sol (cm)' },
        { key: 'baldirSag', label: 'Baldır Sağ (cm)' },
        { key: 'baldirSol', label: 'Baldır Sol (cm)' },
        { key: 'bilekSag', label: 'Bilek Sağ (cm)' },
        { key: 'bilekSol', label: 'Bilek Sol (cm)' },
        { key: 'ustKolSag', label: 'Üst Kol Sağ (cm)' },
        { key: 'ustKolSol', label: 'Üst Kol Sol (cm)' },
      ];
      // Options yükle (ilk çağrıda) veya güncelle
      if (sel.childElementCount === 0) {
        sel.innerHTML = metricList.map(m => `<option value="${m.key}">${m.label}</option>`).join('');
      }
      const draw = () => {
        const key = sel.value || 'bel';
        // Seriyi oluştur: sadece veri olan haftalar, eksikler atlanır
        const series = [];
        const weeks = [];
        const dates = [];
        (haftaListesi || []).forEach(h => {
          const haftaNo = h?.haftaNo ?? null;
          const { has, override } = findWeekOverride(settingsObj, haftaNo);
          const mv = has && override?.measurements ? override.measurements : null;
          const v = mv && isFinite(parseFloat(mv[key])) ? parseFloat(mv[key]) : null;
          series.push(v);
          weeks.push(haftaNo);
          dates.push(h?.baslangic || null);
        });
        renderSparkline(svgId, series, weeks, dates);
        const svg = document.getElementById(svgId);
        if (svg) {
          svg.style.cursor = 'pointer';
          const title = 'Ölçüm Trendi - ' + (sel.options[sel.selectedIndex]?.text || key);
          // Ölçümler için farklı renk (turuncu)
          const color = '#fd7e14';
          svg.onclick = () => openLargeChartModal(title, series, weeks, 'cm', dates, color);
        }
      };
      // İlk çizim
      draw();
      // Değişimde yeniden çiz
      sel.onchange = draw;
    }

    async function olcumleriKaydet() {
      try {
        const aktif = getCurrentHasta();
        if (!aktif?.id) { alert('Hasta seçili değil.'); return; }
        const btn = document.getElementById('olcumKaydetBtn');
        const prev = btn ? btn.textContent : null;
        if (btn) { btn.disabled = true; btn.textContent = 'Kaydediliyor…'; btn.style.opacity = '0.7'; }

        // Aktif hafta (ölçümler hep aktif hafta için)
        const haftaListesi = (typeof getHaftaListesi === 'function') ? getHaftaListesi() : [];
        const idx = (typeof getAktifHaftaIndex === 'function') ? getAktifHaftaIndex() : (haftaListesi.length ? haftaListesi.length - 1 : 0);
        const haftaNo = (haftaListesi?.[idx]?.haftaNo) || (idx + 1);

        // Mevcut ayarları yükle (local > remote)
        const gh = getGithubRepoAndToken();
        let mevcut = null;
        if (gh) { try { mevcut = await githubGetFileJson(`patients/${aktif.id}/settings.json`, true); } catch {} }
        if (!mevcut) { try { mevcut = (typeof loadUserSettingsLocal === 'function') ? loadUserSettingsLocal(aktif.id) : null; } catch {} }
        mevcut = mevcut || {};

        // Formdan ölçümleri topla
        const keys = ['bel','kalca','ustBacakSag','ustBacakSol','dizSag','dizSol','baldirSag','baldirSol','bilekSag','bilekSol','ustKolSag','ustKolSol'];
        const measurements = {};
        keys.forEach(k => {
          const el = document.getElementById('olc_'+k);
          if (!el) return;
          const v = parseFloat(el.value);
          if (isFinite(v) && v > 0) measurements[k] = Math.round(v * 10) / 10;
        });

        const weeklyOverrides = { ...(mevcut.weeklyOverrides || {}) };
        const key = String(haftaNo);
        const prevOv = weeklyOverrides[key] || {};
        weeklyOverrides[key] = { ...prevOv, measurements };

        const finalPayload = { ...mevcut, weeklyOverrides };
        
        // Debug: Ölçüm kaydını logla
        console.log('📏 Ölçüm kaydedildi:', {
          haftaNo,
          measurements,
          finalWeeklyOverrides: finalPayload.weeklyOverrides
        });
        
        if (typeof saveUserSettingsLocal === 'function') saveUserSettingsLocal(aktif.id, finalPayload);
        if (gh) { try { await githubPutFileJson(`patients/${aktif.id}/settings.json`, finalPayload, `feat(measure): update measurements week ${haftaNo} for ${aktif.id}`); } catch (e) { console.warn('GitHub measure uyarı:', e?.message || e); } }

        showToast('Ölçümler kaydedildi.', 'success');
  try { window.__cachedWeeklyOverrides = weeklyOverrides; } catch {}
        // Kaydedilen (normalize edilmiş) değerlerle formu tazele
        try { renderOlcumForm(haftaNo, measurements); } catch {}
      } catch (e) {
        console.error('olcumleriKaydet', e);
        alert('Ölçümler kaydedilemedi: ' + (e?.message || e));
      } finally {
        const btn = document.getElementById('olcumKaydetBtn');
        if (btn) { btn.disabled = false; btn.textContent = 'Ölçümleri Kaydet'; btn.style.opacity = ''; }
      }
    }

    function raporuYenile() {
      const thead = document.getElementById('raporThead');
      const tbody = document.getElementById('raporTbody');
      if (!thead || !tbody) return;
      
      let haftalar = (typeof getHaftaListesi === 'function') ? getHaftaListesi() : [];
      let weekly = (window.__cachedWeeklyOverrides) || {};
      
      // Eğer cache boşsa localStorage içinden aktif hastanın weeklyOverrides'ını çek
      try {
        if (!weekly || Object.keys(weekly).length === 0) {
          const aktif = (typeof getCurrentHasta === 'function') ? getCurrentHasta() : null;
          if (aktif?.id && (typeof loadUserSettingsLocal === 'function')) {
            const mevcut = loadUserSettingsLocal(aktif.id);
            const w2 = mevcut?.weeklyOverrides || {};
            if (Object.keys(w2).length > 0) {
              weekly = w2;
              try { window.__cachedWeeklyOverrides = weekly; } catch {}
            }
          }
        }
      } catch {}
      
      // Debug bilgisi
      console.log('🔍 Rapor Debug:', {
        haftalarCount: haftalar?.length || 0,
        weeklyKeys: Object.keys(weekly || {}),
        weekly: weekly
      });
      
      // Birleşik hafta listesi oluştur: hem haftalar hem weeklyOverrides'dan
      const allWeekNumbers = new Set();
      
      // Haftalar listesinden hafta numaralarını ekle
      (haftalar || []).forEach(h => {
        const n = parseInt(h?.haftaNo, 10);
        if (isFinite(n)) allWeekNumbers.add(n);
      });
      
      // weeklyOverrides anahtarlarından hafta numaralarını ekle
      Object.keys(weekly || {}).forEach(k => {
        const n = parseInt(k, 10);
        if (isFinite(n)) allWeekNumbers.add(n);
      });
      
      // Sıralı birleşik hafta listesi oluştur
      const combinedWeeks = Array.from(allWeekNumbers).sort((a,b) => a-b);
      
      // Birleşik hafta verilerini oluştur - mevcut haftalar listesinin üzerine yazma
      const originalHaftalar = [...(haftalar || [])]; // Orijinalini koru
      haftalar = combinedWeeks.map(weekNum => {
        // Önce mevcut haftalar listesinden bul
        const existing = originalHaftalar.find(h => parseInt(h?.haftaNo, 10) === weekNum);
        if (existing) return existing;
        
        // Yoksa weeklyOverrides'dan temel bilgi ile oluştur
        const weeklyData = weekly[String(weekNum)] || weekly[weekNum];
        return {
          haftaNo: weekNum,
          weightKg: weeklyData?.weightKg || null,
          baslangic: null,
          bitis: null,
          tabTarih: `Hafta ${weekNum}`
        };
      });
      
      console.log('🔍 Birleşik haftalar:', haftalar);
      
      // Fallback: Eğer hala boşsa weeklyOverrides anahtarlarından üret
      if (!haftalar || haftalar.length === 0) {
        const keys = Object.keys(weekly || {});
        if (keys.length) {
          const nums = keys.map(k => parseInt(k, 10)).filter(n => isFinite(n)).sort((a,b)=>a-b);
          haftalar = nums.map(n => ({ haftaNo: n, weightKg: (isFinite(parseFloat(weekly[String(n)]?.weightKg)) ? parseFloat(weekly[String(n)]?.weightKg) : null) }));
        }
      }
      const metricList = [
        { key: '__kilo__', label: 'Kilo (kg)', unit: 'kg', color: '#198754' },
        { key: 'bel', label: 'Bel (cm)', unit: 'cm', color: '#0d6efd' },
        { key: 'kalca', label: 'Kalça (cm)', unit: 'cm', color: '#6f42c1' },
        { key: 'ustBacakSag', label: 'Üst Bacak Sağ (cm)', unit: 'cm', color: '#fd7e14' },
        { key: 'ustBacakSol', label: 'Üst Bacak Sol (cm)', unit: 'cm', color: '#20c997' },
        { key: 'dizSag', label: 'Diz Sağ (cm)', unit: 'cm', color: '#dc3545' },
        { key: 'dizSol', label: 'Diz Sol (cm)', unit: 'cm', color: '#6610f2' },
        { key: 'baldirSag', label: 'Baldır Sağ (cm)', unit: 'cm', color: '#198754' },
        { key: 'baldirSol', label: 'Baldır Sol (cm)', unit: 'cm', color: '#0dcaf0' },
        { key: 'bilekSag', label: 'Bilek Sağ (cm)', unit: 'cm', color: '#6c757d' },
        { key: 'bilekSol', label: 'Bilek Sol (cm)', unit: 'cm', color: '#343a40' },
        { key: 'ustKolSag', label: 'Üst Kol Sağ (cm)', unit: 'cm', color: '#adb5bd' },
        { key: 'ustKolSol', label: 'Üst Kol Sol (cm)', unit: 'cm', color: '#198754' }
      ];
      // Başlık satırı: Hafta (tarih aralığı) + metrikler
      const ths = ['<th style="text-align:left; padding:8px; border-bottom:1px solid #e9ecef;">Hafta</th>', '<th style="text-align:left; padding:8px; border-bottom:1px solid #e9ecef;">Tarih</th>']
        .concat(metricList.map(m => `<th style="text-align:right; padding:8px; border-bottom:1px solid #e9ecef;">${m.label}</th>`)).join('');
      thead.innerHTML = `<tr style="background:#f8f9fa;">${ths}</tr>`;
      // Satırlar
      const rows = (haftalar || []).map((h, rowIdx) => {
        const haftaNo = h?.haftaNo ?? '';
        const haftaNum = isFinite(parseInt(haftaNo,10)) ? parseInt(haftaNo,10) : null;
        const tarih = (h?.baslangic && h?.bitis) ? `${h.baslangic} - ${h.bitis}` : (h?.tabTarih || '');
        const tds = metricList.map(m => {
          let val = null;
          if (m.key === '__kilo__') {
            const ovK = (haftaNum!=null) ? (weekly[String(haftaNum)] || weekly[haftaNum]) : (weekly[String(haftaNo)] || weekly[haftaNo]);
            if (ovK && isFinite(parseFloat(ovK.weightKg)) && parseFloat(ovK.weightKg) > 0) {
              val = parseFloat(ovK.weightKg);
            } else {
              const w = isFinite(h?.weightKg) ? parseFloat(h.weightKg) : NaN;
              val = (isFinite(w) && w>0) ? w : null;
            }
          } else {
            const ov = (haftaNum!=null) ? (weekly[String(haftaNum)] || weekly[haftaNum]) : (weekly[String(haftaNo)] || weekly[haftaNo]);
            const mv = ov && ov.measurements ? ov.measurements : null;
            const vv = mv && isFinite(parseFloat(mv[m.key])) ? parseFloat(mv[m.key]) : null;
            val = (isFinite(vv) && vv > 0) ? vv : null;
          }
          // Δ hesapla (önceki haftaya göre)
          let prevVal = null;
          if (m.key === '__kilo__') {
            const prevBase = ((haftaNum!=null?haftaNum:parseInt(haftaNo,10)) || 0) - 1;
            const pOv = weekly[String(prevBase)] || weekly[prevBase];
            if (pOv && isFinite(parseFloat(pOv?.weightKg))) {
              prevVal = parseFloat(pOv.weightKg);
            } else {
              // haftalar dizisinde önceki haftanın weightKg'ı
              const idx = (haftalar || []).findIndex(x => (x?.haftaNo ?? null) === haftaNo);
              if (idx>0) {
                const ph = haftalar[idx-1];
                const pw = isFinite(ph?.weightKg) ? parseFloat(ph.weightKg) : NaN;
                prevVal = (isFinite(pw) && pw>0) ? pw : null;
              }
            }
          } else {
            // weeklyOverrides içinde önceki hafta dolu ise
            const basePrev = (haftaNum!=null) ? (haftaNum-1) : (parseInt(haftaNo,10)-1);
            const p = weekly[String(basePrev)] || weekly[basePrev];
            const pm = p && p.measurements ? p.measurements : null;
            prevVal = pm && isFinite(parseFloat(pm[m.key])) ? parseFloat(pm[m.key]) : null;
          }
          const hasVal = (typeof val === 'number') && Number.isFinite(val);
          const hasPrev = (typeof prevVal === 'number') && Number.isFinite(prevVal);
          const delta = (hasVal && hasPrev) ? (val - prevVal) : null;
          const formatted = hasVal ? String(Math.round(val)) : '-';
          // Δ sadece geçerli değer varsa ve ilk satır değilse gösterilsin
          const showDelta = (rowIdx > 0) && hasVal && (delta !== null);
          const deltaTxt = showDelta ? (delta>0 ? ` +${Math.round(delta)}` : ` ${Math.round(delta)}`) : '';
          const deltaDiv = deltaTxt ? `<div style=\"color:#6c757d; font-size:11px;\">${deltaTxt}</div>` : '';
          return `<td style=\"text-align:right; padding:8px; border-bottom:1px solid #f1f3f5; white-space:nowrap;\">${formatted}${deltaDiv}</td>`;
        }).join('');
        // Hafta sütununda "X hafta" yaz
        const haftaLabel = (haftaNum!=null ? haftaNum : haftaNo) ? `${haftaNum || haftaNo} hafta` : '';
        return `<tr><td style=\"padding:8px; border-bottom:1px solid #f1f3f5;\">${haftaLabel}</td><td style=\"padding:8px; border-bottom:1px solid #f1f3f5;\">${tarih}</td>${tds}</tr>`;
      }).join('');
      // Alt toplam: Fark satırı (son ölçüm - ilk ölçüm) — veri olmayan haftaları atla
      let farkRow = '';
      if ((haftalar || []).length > 0) {
        const farkTds = metricList.map(m => {
          let firstVal = null, lastVal = null;
          // Baştan sona ilk dolu değeri bul
          for (let i = 0; i < haftalar.length; i++) {
            const hh = haftalar[i]; const w = hh?.haftaNo ?? null;
            if (m.key === '__kilo__') {
              const ov = weekly[String(w)] || weekly[w];
              const v = ov && isFinite(parseFloat(ov?.weightKg)) ? parseFloat(ov.weightKg) : (isFinite(hh?.weightKg) && hh.weightKg>0 ? parseFloat(hh.weightKg) : null);
              if (isFinite(v) && v > 0) { firstVal = v; break; }
            } else {
              const ov = weekly[String(w)] || weekly[w];
              const mv = ov && ov.measurements ? ov.measurements : null;
              const v = mv && isFinite(parseFloat(mv[m.key])) ? parseFloat(mv[m.key]) : null;
              if (isFinite(v) && v > 0) { firstVal = v; break; }
            }
          }
          // Sondan başa en son dolu değeri bul
          for (let i = haftalar.length - 1; i >= 0; i--) {
            const hh = haftalar[i]; const w = hh?.haftaNo ?? null;
            if (m.key === '__kilo__') {
              const ov = weekly[String(w)] || weekly[w];
              const v = ov && isFinite(parseFloat(ov?.weightKg)) ? parseFloat(ov.weightKg) : (isFinite(hh?.weightKg) && hh.weightKg>0 ? parseFloat(hh.weightKg) : null);
              if (isFinite(v) && v > 0) { lastVal = v; break; }
            } else {
              const ov = weekly[String(w)] || weekly[w];
              const mv = ov && ov.measurements ? ov.measurements : null;
              const v = mv && isFinite(parseFloat(mv[m.key])) ? parseFloat(mv[m.key]) : null;
              if (isFinite(v) && v > 0) { lastVal = v; break; }
            }
          }
          const diff = ((typeof firstVal === 'number') && Number.isFinite(firstVal) && (typeof lastVal === 'number') && Number.isFinite(lastVal))
            ? (lastVal - firstVal) : null;
          const txt = (diff===null) ? '' : (diff>0 ? `+${Math.round(diff)}` : `${Math.round(diff)}`);
          return `<td style=\"text-align:right; padding:8px; border-top:2px solid #dee2e6; font-weight:600; background:#fff;\">${txt}</td>`;
        }).join('');
        farkRow = `<tr style=\"background:#f8f9fa;\"><td style=\"padding:8px; border-top:2px solid #dee2e6; font-weight:600;\">Fark</td><td style=\"padding:8px; border-top:2px solid #dee2e6;\"></td>${farkTds}</tr>`;
      }
      tbody.innerHTML = (rows ? rows + farkRow : `<tr><td colspan=\"${2+metricList.length}\" style=\"padding:10px; color:#6c757d;\">Veri yok.</td></tr>`);
      // Grafik için serileri cache'le
      window.__raporMetricList = metricList;
  window.__raporHaftalar = haftalar;
      window.__raporWeekly = weekly;
    }

    function raporuGrafikteGoster() {
      let haftalar = window.__raporHaftalar || [];
      const weekly = window.__raporWeekly || {};
      if (!haftalar || haftalar.length === 0) {
        const keys = Object.keys(weekly || {});
        if (keys.length) {
          const nums = keys.map(k => parseInt(k, 10)).filter(n => isFinite(n)).sort((a,b)=>a-b);
          haftalar = nums.map(n => ({ haftaNo: n, weightKg: (isFinite(parseFloat(weekly[String(n)]?.weightKg)) ? parseFloat(weekly[String(n)]?.weightKg) : null) }));
        }
      }
      const metricList = window.__raporMetricList || [];
      const weekNumbers = (haftalar || []).map(h => h?.haftaNo ?? null);
      // Çoklu serileri aynı grafikte çizmek için büyük modalı birleştir kullan
      // Her metrik için seri topla
      const allSeries = metricList.map(m => {
        if (m.key==='__kilo__') return (haftalar || []).map(h => {
          const haftaNo = h?.haftaNo ?? null;
          const ovK = weekly[String(haftaNo)] || weekly[haftaNo];
          if (ovK && isFinite(parseFloat(ovK?.weightKg))) return parseFloat(ovK.weightKg);
          return (isFinite(h?.weightKg) && h.weightKg>0) ? h.weightKg : null;
        });
        return (haftalar || []).map(h => {
          const haftaNo = h?.haftaNo ?? null;
          const ov = weekly[String(haftaNo)] || weekly[haftaNo];
          const mv = ov && ov.measurements ? ov.measurements : null;
          return mv && isFinite(parseFloat(mv[m.key])) ? parseFloat(mv[m.key]) : null;
        });
      });
      openMultiSeriesChart('Tüm Ölçümler', metricList, allSeries, weekNumbers);
    }

    function openMultiSeriesChart(title, metricList, seriesList, weeks) {
      // Modal reuse: large chart modal içine çoklu çizim yapalım
      openLargeChartModal(title, [], weeks, 'cm');
      const svg = document.getElementById('largeChartSVG');
      if (!svg) return;
      const vbW = 900, vbH = 420;
      // Ekseni ve grid’i tekrar çiz (drawLargeChart min seriye bağlı, burada kontrol bizde)
      svg.innerHTML = '';
      const rect = document.createElementNS('http://www.w3.org/2000/svg','rect');
      rect.setAttribute('x','0'); rect.setAttribute('y','0'); rect.setAttribute('width', String(vbW)); rect.setAttribute('height', String(vbH)); rect.setAttribute('fill','#f8f9fa'); svg.appendChild(rect);
      const margin = { l: 48, r: 16, t: 24, b: 36 };
      const plotW = vbW - margin.l - margin.r; const plotH = vbH - margin.t - margin.b;
      const originX = margin.l, originY = margin.t + plotH;
      // axes
      const axX = document.createElementNS('http://www.w3.org/2000/svg','line'); axX.setAttribute('x1', String(originX)); axX.setAttribute('y1', String(originY)); axX.setAttribute('x2', String(originX + plotW)); axX.setAttribute('y2', String(originY)); axX.setAttribute('stroke','#adb5bd'); axX.setAttribute('stroke-width','1'); svg.appendChild(axX);
      const axY = document.createElementNS('http://www.w3.org/2000/svg','line'); axY.setAttribute('x1', String(originX)); axY.setAttribute('y1', String(originY)); axY.setAttribute('x2', String(originX)); axY.setAttribute('y2', String(margin.t)); axY.setAttribute('stroke','#adb5bd'); axY.setAttribute('stroke-width','1'); svg.appendChild(axY);
      // y min/max tüm serilere göre
      const allVals = [];
      seriesList.forEach(s => s.forEach(v => { if (isFinite(v) && v>0) allVals.push(v); }));
      if (allVals.length < 2) return;
      const min = Math.min.apply(null, allVals), max = Math.max.apply(null, allVals), range = (max - min) || 1;
      // grid ve y ekseni çentikleri (tamsayılar için) — etiketleri göstermiyoruz
      const yMinInt = Math.floor(min);
      const yMaxInt = Math.ceil(max);
      for (let v = yMinInt; v <= yMaxInt; v += 1) {
        const y = originY - ((v - min) / range) * plotH;
        // ana yatay çizgi
        const ln = document.createElementNS('http://www.w3.org/2000/svg','line');
        ln.setAttribute('x1', String(originX)); ln.setAttribute('y1', String(y)); ln.setAttribute('x2', String(originX+plotW)); ln.setAttribute('y2', String(y)); ln.setAttribute('stroke','#e9ecef'); ln.setAttribute('stroke-width','1'); svg.appendChild(ln);
        // y ekseninde küçük çentik
        const tick = document.createElementNS('http://www.w3.org/2000/svg','line');
        tick.setAttribute('x1', String(originX - 5)); tick.setAttribute('y1', String(y)); tick.setAttribute('x2', String(originX)); tick.setAttribute('y2', String(y)); tick.setAttribute('stroke','#adb5bd'); tick.setAttribute('stroke-width','1'); svg.appendChild(tick);
      }

      // YALNIZCA: Her ölçüm serisinin başlangıç değerinin Y konumuna etiket bas
      try {
        const labeledVals = new Set();
        seriesList.forEach(s => {
          let firstVal = null;
          for (let i=0; i<s.length; i++) { if (isFinite(s[i]) && s[i] > 0) { firstVal = s[i]; break; } }
          if (firstVal === null) return;
          const y = originY - ((firstVal - min) / range) * plotH;
          const vi = Math.round(firstVal); // etikette tamsayı gösterelim
          const key = String(vi);
          if (labeledVals.has(key)) return; // aynı değeri bir kez yaz
          labeledVals.add(key);
          // Daha belirgin bir çentik
          const btick = document.createElementNS('http://www.w3.org/2000/svg','line');
          btick.setAttribute('x1', String(originX - 8)); btick.setAttribute('y1', String(y)); btick.setAttribute('x2', String(originX)); btick.setAttribute('y2', String(y)); btick.setAttribute('stroke','#6c757d'); btick.setAttribute('stroke-width','1.5'); svg.appendChild(btick);
          // Etiket
          const blabel = document.createElementNS('http://www.w3.org/2000/svg','text');
          blabel.setAttribute('x', String(8)); blabel.setAttribute('y', String(y + 4)); blabel.setAttribute('fill','#495057'); blabel.setAttribute('font-size','11'); blabel.textContent = vi + ' cm'; svg.appendChild(blabel);
        });
      } catch {}
      // x ekseni hafta etiketleri
      const n = weeks.length; const xStep = n>1 ? (plotW/(n-1)) : plotW;
      for (let i=0;i<n;i+=1){
        const x = originX + (i * xStep);
        const t = document.createElementNS('http://www.w3.org/2000/svg','text');
        t.setAttribute('x', String(x)); t.setAttribute('y', String(originY + 14)); t.setAttribute('fill','#495057'); t.setAttribute('font-size','10'); t.setAttribute('text-anchor','middle');
        const wn = weeks[i] != null ? weeks[i] : (i+1);
        t.textContent = `${wn}. hafta`;
        svg.appendChild(t);
      }
      // Serileri çiz ve sağ tarafa lejant
      let lx = originX + plotW + 8, ly = margin.t + 8;
      metricList.forEach((m, idx) => {
        const s = seriesList[idx];
        // path
        let d = ''; let first = true; const color = m.color || '#0d6efd';
        let lastX = null, lastY = null;
        for (let i=0;i<n;i++){
          const v = (isFinite(s[i]) && s[i] > 0) ? s[i] : null; if (v===null) continue;
          const x = originX + (i * xStep); const y = originY - ((v - min)/range) * plotH;
          d += first ? `M ${x.toFixed(1)} ${y.toFixed(1)}` : ` L ${x.toFixed(1)} ${y.toFixed(1)}`; first=false;
          lastX = x; lastY = y;
        }
        const p = document.createElementNS('http://www.w3.org/2000/svg','path'); p.setAttribute('d', d); p.setAttribute('fill','none'); p.setAttribute('stroke', color); p.setAttribute('stroke-width','2'); svg.appendChild(p);
        // legend
        const sw = document.createElementNS('http://www.w3.org/2000/svg','rect'); sw.setAttribute('x', String(lx)); sw.setAttribute('y', String(ly - 8)); sw.setAttribute('width','18'); sw.setAttribute('height','4'); sw.setAttribute('fill', color); svg.appendChild(sw);
        const tt = document.createElementNS('http://www.w3.org/2000/svg','text'); tt.setAttribute('x', String(lx + 24)); tt.setAttribute('y', String(ly)); tt.setAttribute('fill','#212529'); tt.setAttribute('font-size','11'); tt.textContent = m.label; svg.appendChild(tt);
        ly += 18;

        // Çizginin sonunda bitiş değeri + Δ (ör: 72 (-7 cm))
        if (lastX !== null && lastY !== null) {
          const endLabel = document.createElementNS('http://www.w3.org/2000/svg','text');
          endLabel.setAttribute('x', String(Math.min(originX + plotW - 4, lastX + 6)));
          endLabel.setAttribute('y', String(lastY));
          endLabel.setAttribute('fill', color);
          endLabel.setAttribute('font-size','11');
          endLabel.setAttribute('font-weight','600');
          endLabel.setAttribute('dominant-baseline','middle');
          // İnce beyaz kontur ile okunabilirlik
          endLabel.setAttribute('paint-order','stroke');
          endLabel.setAttribute('stroke','#fff');
          endLabel.setAttribute('stroke-width','2');
          // delta: ilk geçerli - son geçerli
          let firstVal = null; let lastVal = null;
          for (let k=0;k<s.length;k++){ if (isFinite(s[k]) && s[k] > 0) { firstVal = s[k]; break; } }
          for (let k=s.length-1;k>=0;k--){ if (isFinite(s[k]) && s[k] > 0) { lastVal = s[k]; break; } }
          let deltaTxt = '';
          if (firstVal !== null && lastVal !== null) {
            const d = Math.round((lastVal - firstVal));
            const u = m.unit || 'cm';
            if (d !== 0) deltaTxt = ` (${d>0?'+':''}${d} ${u})`;
          }
          const endValTxt = (lastVal !== null) ? String(Math.round(lastVal)) : '';
          endLabel.textContent = endValTxt + (deltaTxt ? ` ${deltaTxt}` : '');
          svg.appendChild(endLabel);
        }
      });
    }

    async function kiloSeyriKaydet() {
      try {
        const aktif = getCurrentHasta();
        if (!aktif?.id) { alert('Hasta seçili değil.'); return; }
        const btn = document.getElementById('kiloSeyriKaydetBtn');
        const prev = btn ? btn.textContent : null;
        if (btn) { btn.disabled = true; btn.textContent = 'Kaydediliyor…'; btn.style.opacity = '0.7'; }

        // Mevcut hasta ayarlarını yükle (local > remote)
        const gh = getGithubRepoAndToken();
        let mevcut = null;
        if (gh) { try { mevcut = await githubGetFileJson(`patients/${aktif.id}/settings.json`, true); } catch {} }
        if (!mevcut) { try { mevcut = (typeof loadUserSettingsLocal === 'function') ? loadUserSettingsLocal(aktif.id) : null; } catch {} }
        mevcut = mevcut || {};

        // Inputlardan yeni hafta-kilo çiftlerini topla
        const inputs = Array.from(document.querySelectorAll('.hafta-weight-input'));
        const weeklyOverrides = { ...(mevcut.weeklyOverrides || {}) };
        inputs.forEach(inp => {
          const haftaStr = (inp.getAttribute('data-hafta') || '').trim();
          if (!haftaStr) return;
          const val = parseFloat(inp.value);
          if (!isFinite(val) || val <= 0) return;
          const key = String(haftaStr);
          const prevOv = weeklyOverrides[key] || {};
          weeklyOverrides[key] = { ...prevOv, weightKg: Math.round(val * 10) / 10 };
        });

        const finalPayload = Object.keys(weeklyOverrides).length > 0
          ? { ...mevcut, weeklyOverrides }
          : { ...mevcut };

        // Local'e yaz
        if (typeof saveUserSettingsLocal === 'function') saveUserSettingsLocal(aktif.id, finalPayload);
        // GitHub'a yaz (varsa)
        if (gh) {
          try { await githubPutFileJson(`patients/${aktif.id}/settings.json`, finalPayload, `feat(weight): update weekly weights for ${aktif.id}`); }
          catch (e) { console.warn('GitHub weekly weights uyarı:', e?.message || e); }
        }

        // UI yenile
        await updateHedefKcalBadgeForSelectedPatient();
        await acKiloSeyri(); // tabloyu baştan çiz
  try { window.__cachedWeeklyOverrides = weeklyOverrides; } catch {}
        showToast('Kilo seyri kaydedildi.', 'success');
      } catch (e) {
        console.error('kiloSeyriKaydet', e);
        alert('Kilo seyri kaydedilemedi: ' + (e?.message || e));
      } finally {
        const btn = document.getElementById('kiloSeyriKaydetBtn');
        if (btn) { btn.disabled = false; btn.textContent = 'Kaydet'; btn.style.opacity = ''; }
      }
    }

    async function ayarVarsayilanKaydet() {
      try {
        const payload = toAyarPayload();
        const ok = (typeof saveUserSettingsLocal === 'function') ? saveUserSettingsLocal('default', payload) : false;
        if (!ok) throw new Error('Local kaydetme başarısız');
        // GitHub'a senkronize et (varsa)
        const gh = getGithubRepoAndToken();
        if (gh) {
          try {
            await githubPutFileJson('settings/defaults.json', payload, 'feat(settings): update system defaults');
            alert('Sistem varsayılanı GitHub’a kaydedildi.');
          } catch (err) {
            console.warn('GitHub defaults kaydetme uyarısı:', err?.message || err);
            alert('Sistem varsayılanı local kaydedildi, GitHub kaydı başarısız. Token/repo kontrol edin.');
          }
        } else {
          alert('Sistem varsayılanı local kaydedildi. (GitHub token/repo girilirse senkron yapılır)');
        }
      } catch (e) { console.error('ayarVarsayilanKaydet', e); alert('Kaydedilemedi: '+(e?.message||e)); }
    }

    async function hastaAyarKaydet() {
      try {
        const aktif = getCurrentHasta();
        if (!aktif?.id) { alert('Hasta seçili değil.'); return; }
        const payload = toAyarPayload();
        // Haftalık mı global mi?
        const onlyThisWeek = !!document.getElementById('ayar_onlyThisWeek')?.checked;
        let finalPayload = null;
        // Mevcut ayarları yükle (local > remote)
        let mevcut = null;
        try { mevcut = (typeof loadUserSettingsLocal === 'function') ? loadUserSettingsLocal(aktif.id) : null; } catch {}
        // Haftayı belirle
        let haftaNo = null;
        try {
          const haftaListesi = (typeof getHaftaListesi === 'function') ? getHaftaListesi() : [];
          const idx = (typeof getAktifHaftaIndex === 'function') ? getAktifHaftaIndex() : (haftaListesi.length ? haftaListesi.length - 1 : 0);
          haftaNo = (haftaListesi?.[idx]?.haftaNo) || (idx + 1);
        } catch {}
        if (onlyThisWeek && haftaNo) {
          // weeklyOverrides altında sadece bu hafta güncellensin
          const weeklyOverrides = { ...(mevcut?.weeklyOverrides || {}) };
          weeklyOverrides[String(haftaNo)] = { ...payload };
          // Global değerleri koru; ancak weeklyOverrides'ı ekle
          finalPayload = { ...(mevcut || {}), weeklyOverrides };
        } else {
          // Global kaydet: weeklyOverrides varsa koru
          const weeklyOverrides = mevcut?.weeklyOverrides ? { ...mevcut.weeklyOverrides } : undefined;
          finalPayload = weeklyOverrides ? { ...payload, weeklyOverrides } : { ...payload };
        }
        const ok = (typeof saveUserSettingsLocal === 'function') ? saveUserSettingsLocal(aktif.id, finalPayload) : false;
        if (!ok) throw new Error('Local kaydetme başarısız');
        // GitHub'a senkronize et (varsa)
        const gh = getGithubRepoAndToken();
        if (gh) {
          try {
            await githubPutFileJson(`patients/${aktif.id}/settings.json`, finalPayload, `feat(settings): update patient ${aktif.id} settings`);
            alert('Hasta ayarları GitHub’a kaydedildi.');
          } catch (err) {
            console.warn('GitHub patient settings kaydetme uyarısı:', err?.message || err);
            alert('Hasta ayarları local kaydedildi, GitHub kaydı başarısız. Token/repo kontrol edin.');
          }
        } else {
          alert('Hasta ayarları local kaydedildi. (GitHub token/repo girilirse senkron yapılır)');
        }
        // UI'ları güncelle
        try { await updateHedefKcalBadgeForSelectedPatient(); } catch {}
        try { hedefMakroGuncelle(); } catch {}
      } catch (e) { console.error('hastaAyarKaydet', e); alert('Kaydedilemedi: '+(e?.message||e)); }
    }

    function toAyarPayload() {
      const dietType = qs('ayar_dietType').value;
      const activityLevel = parseInt(qs('ayar_activity').value || '3', 10);
      const goal = qs('ayar_goal').value || 'maintain';
      const goalPct = parseFloat(qs('ayar_goalPct')?.value || '0') || 0;
      const weightKg = parseFloat(qs('ayar_weight').value || '0') || 0;
      const perKg = {
        carbsPerKg: parseFloat(qs('ayar_ck').value || '0') || 0,
        proteinPerKg: parseFloat(qs('ayar_pk').value || '0') || 0,
        fatPerKg: parseFloat(qs('ayar_fk').value || '0') || 0,
      };
      const mealDistribution = {
        kahvalti: parseInt(qs('ayar_kahvalti').value || '0', 10),
        ogle: parseInt(qs('ayar_ogle').value || '0', 10),
        aksam: parseInt(qs('ayar_aksam').value || '0', 10),
        ara: parseInt(qs('ayar_ara').value || '0', 10),
      };
      const normalized = (typeof normalizeMealDistribution === 'function') ? normalizeMealDistribution(mealDistribution) : mealDistribution;
      return { dietType, activityLevel, goal, goalPct, weightKg, perKg, mealDistribution: normalized };
    }

    // =============================
    // GitHub JSON okuma/yazma yardımcıları (contents API) — PM-05
    // =============================
    function getGithubRepoAndToken() {
      try {
        const repoEl = document.getElementById('githubRepo');
        const tokenEl = document.getElementById('githubToken');
        const repo = (repoEl?.value || window.GITHUB_REPO || '').trim();
        const token = (tokenEl?.value || loadTokenFromStorage?.() || '').trim();
        if (!repo || !token) return null;
        return { repo, token };
      } catch { return null; }
    }

    async function githubGetFileJson(path, silent = false) {
      const gh = getGithubRepoAndToken();
      if (!gh) { if (!silent) throw new Error('GitHub repo veya token eksik'); else return null; }
      const { repo, token } = gh;
      const url = `https://api.github.com/repos/${repo}/contents/${path}`;
      const resp = await fetch(url, { headers: { 'Authorization': `token ${token}` } });
      if (resp.status === 404) { if (!silent) throw new Error('Dosya bulunamadı'); return null; }
      if (!resp.ok) throw new Error(`GET ${path} hata: ${resp.status}`);
      const data = await resp.json();
      const decoded = decodeBase64UTF8(data.content);
      try { return JSON.parse(decoded); } catch (e) { console.warn('JSON parse uyarı', e); return null; }
    }

    async function githubGetFileSha(path) {
      const gh = getGithubRepoAndToken();
      if (!gh) throw new Error('GitHub repo veya token eksik');
      const { repo, token } = gh;
      const url = `https://api.github.com/repos/${repo}/contents/${path}`;
      const resp = await fetch(url, { headers: { 'Authorization': `token ${token}` } });
      if (resp.status === 404) return null; // dosya yok -> create
      if (!resp.ok) throw new Error(`SHA getirme hata: ${resp.status}`);
      const data = await resp.json();
      return data.sha || null;
    }

    async function githubPutFileJson(path, jsonData, message = 'update via app') {
      const gh = getGithubRepoAndToken();
      if (!gh) throw new Error('GitHub repo veya token eksik');
      const { repo, token } = gh;
      const url = `https://api.github.com/repos/${repo}/contents/${path}`;
      const content = encodeUTF8ToBase64(jsonData);

      // Gürültüyü azalt: Önce SHA var mı bak. Varsa update (sha ile), yoksa create.
      let sha = null;
      try {
        sha = await githubGetFileSha(path);
      } catch (e) {
        // SHA sorgusu başarısızsa devam etmeyelim; gerçek hata göster.
        throw new Error(`SHA getirme hatası: ${e?.message || e}`);
      }

      const baseBody = { message, content };
      if (window.GITHUB_DEFAULT_BRANCH) {
        baseBody.branch = window.GITHUB_DEFAULT_BRANCH; // sadece doluysa gönder
      }
      const body = sha ? { ...baseBody, sha } : baseBody;

      let resp = await fetch(url, {
        method: 'PUT',
        headers: {
          'Authorization': `token ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(body)
      });

      // Başarılı ise direkt dön
      if (resp.ok) {
        return await resp.json();
      }

      // Çok nadir: SHA arada değişmiş olabilir → bir kez daha dene
      if (resp.status === 409) {
        try {
          const latestSha = await githubGetFileSha(path);
          if (!latestSha) {
            const txt = await resp.text();
            throw new Error(`PUT ${path} 409 ve sha bulunamadı: ${txt}`);
          }
          const retryResp = await fetch(url, {
            method: 'PUT',
            headers: {
              'Authorization': `token ${token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ ...baseBody, sha: latestSha })
          });
          if (!retryResp.ok) {
            const txt = await retryResp.text();
            throw new Error(`PUT (retry) ${path} hata: ${retryResp.status} ${txt}`);
          }
          return await retryResp.json();
        } catch (e) {
          const txt = await resp.text().catch(() => '');
          throw new Error(`PUT ${path} 409 ve retry da başarısız: ${txt} | ${e?.message || e}`);
        }
      }

      // Diğer hatalarda detaylı mesaj göster
      const txt = await resp.text().catch(() => '');
      throw new Error(`PUT ${path} hata: ${resp.status} ${txt}`);
    }
  </script>

  <!-- Hasta Ayarları Modal (PM-03) -->
  <div id="hastaAyarModal" style="display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10005;" onclick="hastaAyarModalKapat(event)">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 12px; width: 95%; max-width: 800px; max-height: 90%; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.3);" onclick="event.stopPropagation()">
      <!-- Header -->
      <div style="padding: 16px 20px; border-bottom: 1px solid #ddd; background: linear-gradient(135deg, #17a2b8 0%, #0d6efd 100%); color: white;">
        <h3 style="margin: 0; font-size: 20px; display:flex; align-items:center; gap:8px;">⚙️ Hasta Ayarları <small id="hastaAyarHastaIsim" style="opacity:.9; font-weight:500;"></small></h3>
        <div style="margin-top:4px; font-size:12px; opacity:.9;">Diyet tipi, aktivite, hedef ve öğün dağılımı. Değerler hastaya özel kaydedilir.</div>
      </div>
      <!-- Body -->
      <div style="padding: 16px; max-height: 65vh; overflow-y: auto;">
        <div style="display:grid; grid-template-columns: 1.2fr 1fr; gap:16px;">
          <!-- Sol: Girişler -->
          <div>
            <!-- TODO[PM-03]: Diyet tipi ve aktivite/goal alanları -->
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:10px;">
              <div>
                <label style="font-weight:600; font-size:12px; color:#495057;">Diyet Tipi</label>
                <select id="ayar_dietType" style="width:100%; padding:8px; border:1px solid #ced4da; border-radius:4px; font-size:13px;">
                  <option value="lowcarb">LowCarb</option>
                  <option value="keto">Ketojenik</option>
                </select>
              </div>
              <div>
                <label style="font-weight:600; font-size:12px; color:#495057;">Aktivite Düzeyi (1-5)</label>
                <select id="ayar_activity" style="width:100%; padding:8px; border:1px solid #ced4da; border-radius:4px; font-size:13px;">
                  <option value="1">1 - Çok düşük</option>
                  <option value="2">2 - Düşük</option>
                  <option value="3" selected>3 - Orta</option>
                  <option value="4">4 - Yüksek</option>
                  <option value="5">5 - Çok yüksek</option>
                </select>
              </div>
              <div>
                <label style="font-weight:600; font-size:12px; color:#495057;">Hedef</label>
                <select id="ayar_goal" style="width:100%; padding:8px; border:1px solid #ced4da; border-radius:4px; font-size:13px;">
                  <option value="maintain" selected>Sürdür</option>
                  <option value="deficit">Kilo Ver</option>
                  <option value="surplus">Kilo Al</option>
                </select>
              </div>
              <div>
                <label style="font-weight:600; font-size:12px; color:#495057;">Hedef % (±)</label>
                <div style="display:flex; gap:6px; align-items:center;">
                  <input type="number" id="ayar_goalPct" min="-50" max="50" step="1" placeholder="Örn: -16" style="width:100%; padding:8px; border:1px solid #ced4da; border-radius:4px; font-size:13px;">
                  <span style="font-size:12px; color:#6c757d;">%</span>
                </div>
                <div style="margin-top:4px; font-size:11px; color:#6c757d;">Örn: -16 → %16 kalori düşür; +10 → %10 artır.</div>
              </div>
              <div>
                <label style="font-weight:600; font-size:12px; color:#495057;">Kilo (kg)</label>
                <input type="number" id="ayar_weight" min="1" step="0.1" placeholder="Örn: 72" style="width:100%; padding:8px; border:1px solid #ced4da; border-radius:4px; font-size:13px;">
              </div>
            </div>
            <!-- Per-kg katsayıları -->
            <div style="background:#f8f9fa; border:1px solid #e9ecef; border-radius:8px; padding:12px; margin-bottom:12px;">
              <div style="font-weight:600; margin-bottom:8px; font-size:13px; color:#495057;">Kg Başına Katsayılar (seçilen diyet)</div>
              <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px;">
                <div>
                  <label style="font-size:12px; color:#6c757d;">Carb (g/kg)</label>
                  <input type="number" id="ayar_ck" step="0.1" min="0" style="width:100%; padding:8px; border:1px solid #ced4da; border-radius:4px; font-size:13px;">
                </div>
                <div>
                  <label style="font-size:12px; color:#6c757d;">Protein (g/kg)</label>
                  <input type="number" id="ayar_pk" step="0.1" min="0" style="width:100%; padding:8px; border:1px solid #ced4da; border-radius:4px; font-size:13px;">
                </div>
                <div>
                  <label style="font-size:12px; color:#6c757d;">Yağ (g/kg)</label>
                  <input type="number" id="ayar_fk" step="0.1" min="0" style="width:100%; padding:8px; border:1px solid #ced4da; border-radius:4px; font-size:13px;">
                </div>
              </div>
              <div style="margin-top:8px; font-size:11px; color:#6c757d;">Seçili diyetin varsayılanlarını kullan veya değerleri elle düzenle.</div>
            </div>
            <!-- Öğün dağılımı -->
            <div style="background:#fff; border:1px solid #e9ecef; border-radius:8px; padding:12px;">
              <div style="font-weight:600; margin-bottom:8px; font-size:13px; color:#495057;">Öğün Dağılımı (%) – toplam 100 olmalı</div>
              <div style="display:grid; grid-template-columns: 1fr 60px; gap:8px; align-items:center; margin-bottom:6px;">
                <label for="ayar_kahvalti">Kahvaltı</label>
                <input type="number" id="ayar_kahvalti" min="0" max="100" step="1" value="10" oninput="ayarDagilimDegisti()" style="width:60px; padding:6px; border:1px solid #ced4da; border-radius:4px; text-align:right;">
                <input type="range" id="ayar_kahvalti_r" min="0" max="100" value="10" oninput="ayarSliderDegisti('kahvalti')" style="grid-column: 1 / span 2;">
              </div>
              <div style="display:grid; grid-template-columns: 1fr 60px; gap:8px; align-items:center; margin-bottom:6px;">
                <label for="ayar_ogle">Öğle</label>
                <input type="number" id="ayar_ogle" min="0" max="100" step="1" value="40" oninput="ayarDagilimDegisti()" style="width:60px; padding:6px; border:1px solid #ced4da; border-radius:4px; text-align:right;">
                <input type="range" id="ayar_ogle_r" min="0" max="100" value="40" oninput="ayarSliderDegisti('ogle')" style="grid-column: 1 / span 2;">
              </div>
              <div style="display:grid; grid-template-columns: 1fr 60px; gap:8px; align-items:center; margin-bottom:6px;">
                <label for="ayar_aksam">Akşam</label>
                <input type="number" id="ayar_aksam" min="0" max="100" step="1" value="50" oninput="ayarDagilimDegisti()" style="width:60px; padding:6px; border:1px solid #ced4da; border-radius:4px; text-align:right;">
                <input type="range" id="ayar_aksam_r" min="0" max="100" value="50" oninput="ayarSliderDegisti('aksam')" style="grid-column: 1 / span 2;">
              </div>
              <div style="display:grid; grid-template-columns: 1fr 60px; gap:8px; align-items:center;">
                <label for="ayar_ara">Ara</label>
                <input type="number" id="ayar_ara" min="0" max="100" step="1" value="5" oninput="ayarDagilimDegisti()" style="width:60px; padding:6px; border:1px solid #ced4da; border-radius:4px; text-align:right;">
                <input type="range" id="ayar_ara_r" min="0" max="100" value="5" oninput="ayarSliderDegisti('ara')" style="grid-column: 1 / span 2;">
              </div>
              <div style="text-align:right; margin-top:8px; font-size:12px; color:#6c757d;">Toplam: <span id="ayar_toplam">105</span>%</div>
            </div>
          </div>
          <!-- Sağ: Hedef Makrolar -->
          <div>
            <div style="background:#fff; border:1px solid #e9ecef; border-radius:8px; padding:12px;">
              <div style="font-weight:700; margin-bottom:8px; font-size:14px; color:#343a40;">🎯 Hedef Makrolar</div>
              <div id="ayar_hedef_box" style="font-size:13px; line-height:1.6;">
                <div>Kalori: <strong id="hedef_kcal">-</strong> kcal</div>
                <div>Karbonhidrat: <strong id="hedef_c">-</strong> g</div>
                <div>Protein: <strong id="hedef_p">-</strong> g</div>
                <div>Yağ: <strong id="hedef_f">-</strong> g</div>
              </div>
              <div style="margin-top:10px; font-size:11px; color:#6c757d;">Not: Makrolar girdi değiştikçe canlı güncellenir.</div>
            </div>
          </div>
        </div>
      </div>
      <!-- Footer -->
      <div style="padding: 12px 16px; border-top: 1px solid #ddd; background:#f8f9fa; display:flex; justify-content:space-between; gap:8px; flex-wrap:wrap;">
        <div style="display:flex; gap:12px; flex-wrap:wrap; align-items:center;">
          <label style="display:flex; align-items:center; gap:6px; font-size:12px; color:#495057; background:#fff; border:1px solid #dee2e6; padding:6px 8px; border-radius:6px;">
            <input type="checkbox" id="ayar_onlyThisWeek" checked>
            <span>Sadece bu hafta için kaydet (<span id="ayar_currentWeekLabel">-</span>)</span>
          </label>
          <button id="clearWeekOverrideBtn" onclick="clearActiveWeekOverride()" style="background:#fff3cd; color:#664d03; border:1px solid #ffe69c; padding:8px 12px; border-radius:6px; cursor:pointer; font-size:12px; display:none;" title="Bu haftanın özel ayarını sil ve global ayarlara dön">Hafta ayarını temizle</button>
          <button onclick="hastaAyarModalKapat()" style="background:#6c757d; color:white; border:none; padding:10px 16px; border-radius:4px; cursor:pointer;">Kapat</button>
        </div>
        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <button onclick="ayarVarsayilaniYukle()" style="background:#e9ecef; color:#212529; border:none; padding:10px 16px; border-radius:4px; cursor:pointer;">Varsayılanı Yükle</button>
          <button onclick="ayarVarsayilanKaydet()" style="background:#0d6efd; color:white; border:none; padding:10px 16px; border-radius:4px; cursor:pointer;">Sistem Varsayılanı Kaydet</button>
          <button onclick="hastaAyarKaydet()" style="background:#28a745; color:white; border:none; padding:10px 16px; border-radius:4px; cursor:pointer;">💾 Hastaya Kaydet</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 📈 Kilo Seyri Modalı -->
  <div id="kiloSeyriModal" style="display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10006;" onclick="kiloSeyriModalKapat(event)">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 12px; width: 96%; max-width: 980px; max-height: 88%; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.3);" onclick="event.stopPropagation()">
      <div style="padding: 14px 18px; border-bottom: 1px solid #ddd; display:flex; align-items:center; justify-content:space-between;">
        <div style="display:flex; align-items:center; gap:8px;">
          <span style="font-size:18px;">📈</span>
          <h3 style="margin:0; font-size:18px;">Kilo Seyri</h3>
        </div>
        <button onclick="kiloSeyriModalKapat()" style="background:#dc3545; color:white; border:none; border-radius:6px; padding:6px 10px; cursor:pointer; font-size:12px;">Kapat</button>
      </div>
      <div style="padding:12px; max-height:70vh; overflow:auto;">
        <div style="display:flex; align-items:center; gap:12px; border-bottom:1px solid #e9ecef; margin-bottom:10px;">
          <button id="seyirTabBtn" onclick="seyirTabDegistir('seyir')" class="seyir-tab-btn active" style="padding:6px 10px; border:none; background:#0d6efd; color:white; border-radius:6px; cursor:pointer; font-size:12px;">Seyir</button>
          <button id="olcumTabBtn" onclick="seyirTabDegistir('olcum')" class="seyir-tab-btn" style="padding:6px 10px; border:none; background:#e9ecef; color:#212529; border-radius:6px; cursor:pointer; font-size:12px;">Ölçümler</button>
          <button id="raporTabBtn" onclick="seyirTabDegistir('rapor')" class="seyir-tab-btn" style="padding:6px 10px; border:none; background:#e9ecef; color:#212529; border-radius:6px; cursor:pointer; font-size:12px;">Rapor</button>
          <div style="flex:1"></div>
          <div id="sparklineWrap" style="display:flex; align-items:center; gap:6px; margin-right:8px;">
            <span style="font-size:12px; color:#6c757d;">Trend</span>
            <svg id="kiloSparkline" width="120" height="28" viewBox="0 0 120 28" preserveAspectRatio="none" style="display:block;"></svg>
          </div>
          <div id="seyirActions">
            <button id="kiloSeyriKaydetBtn" onclick="kiloSeyriKaydet()" style="background:#198754; color:white; border:none; border-radius:6px; padding:6px 12px; cursor:pointer; font-size:12px;">Kaydet</button>
          </div>
          <div id="olcumActions" style="display:none;">
            <button id="olcumKaydetBtn" onclick="olcumleriKaydet()" style="background:#198754; color:white; border:none; border-radius:6px; padding:6px 12px; cursor:pointer; font-size:12px;">Ölçümleri Kaydet</button>
          </div>
          <div id="raporActions" style="display:none; gap:8px; align-items:center;">
            <button onclick="raporuYenile()" style="background:#0d6efd; color:white; border:none; border-radius:6px; padding:6px 12px; cursor:pointer; font-size:12px;">Yenile</button>
            <button onclick="raporuGrafikteGoster()" style="background:#198754; color:white; border:none; border-radius:6px; padding:6px 12px; cursor:pointer; font-size:12px;">Grafikte Göster</button>
          </div>
        </div>
        <table id="seyirTablo" style="width:100%; border-collapse:collapse; font-size:13px;">
          <thead>
            <tr style="background:#f8f9fa;">
              <th style="text-align:left; padding:8px; border-bottom:1px solid #e9ecef;">Hafta</th>
              <th style="text-align:left; padding:8px; border-bottom:1px solid #e9ecef;">Kilo (kg)</th>
              <th style="text-align:left; padding:8px; border-bottom:1px solid #e9ecef;">Hedef kcal</th>
              <th style="text-align:left; padding:8px; border-bottom:1px solid #e9ecef;">Gerç. ort. kcal</th>
              <th style="text-align:left; padding:8px; border-bottom:1px solid #e9ecef;">Δ% (hedef)</th>
              <th style="text-align:left; padding:8px; border-bottom:1px solid #e9ecef;">Δ kg</th>
              <th style="text-align:left; padding:8px; border-bottom:1px solid #e9ecef;">Toplam Δ kg</th>
              <th style="text-align:left; padding:8px; border-bottom:1px solid #e9ecef;">Plan %</th>
              <th style="text-align:left; padding:8px; border-bottom:1px solid #e9ecef;">Hafta Özel</th>
            </tr>
          </thead>
          <tbody id="kiloSeyriBody">
          </tbody>
        </table>
        <div id="olcumIcerik" style="display:none;">
          <div style="font-size:12px; color:#6c757d; margin:10px 0;">Haftaya göre vücut ölçümleri. Sağ/sol için ayrı alanlar vardır.</div>
          <div style="display:flex; align-items:center; gap:10px; margin:8px 0 12px 0;">
            <label for="olcumSparkKey" style="font-size:12px; color:#495057;">Grafik:</label>
            <select id="olcumSparkKey" style="padding:6px 8px; border:1px solid #ced4da; border-radius:6px; font-size:12px;"></select>
            <div style="flex:1"></div>
            <svg id="olcumSparkline" width="220" height="36" viewBox="0 0 220 36" preserveAspectRatio="none" style="display:block; background:#f8f9fa; border-radius:6px;"></svg>
          </div>
          <div id="olcumFormGrid" style="display:grid; grid-template-columns: repeat(2, minmax(280px,1fr)); gap:12px;">
            <!-- JS ile doldurulacak -->
          </div>
        </div>
        <div id="raporIcerik" style="display:none;">
          <div style="font-size:12px; color:#6c757d; margin:10px 0;">Haftalar satırlarda, ölçümler sütunlarda; hücrelerde önce değer, altında Δ (önceki haftaya göre).</div>
          <table id="raporTable" style="width:100%; border-collapse:collapse; font-size:12px;">
            <thead id="raporThead"></thead>
            <tbody id="raporTbody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Eşleşme Yasakları Paneli -->
  <div id="eslesmemePanel" style="display:none; background:#fff; border:2px solid #dc3545; padding:20px; margin:16px 0; border-radius:8px; position:relative;">
    <button onclick="eslesmemeRegeleriPaneliGizle()" style="position:absolute; top:10px; right:10px; background:none; border:none; font-size:20px; cursor:pointer; color:#dc3545; font-weight:bold; width:30px; height:30px; border-radius:50%; display:flex; align-items:center; justify-content:center;" title="Kapat">×</button>
    <h3>Eşleşme Yasakları Paneli</h3>
    <div style="display:flex; gap:20px; margin-bottom:20px;">
      <div style="flex:1;">
        <label style="display:block; margin-bottom:5px; font-weight:bold;">PDF'deki Yemek Adı:</label>
        <textarea id="yasakTarifAdi" placeholder="Örn: tavuklu hünkar beğendi" style="width:100%; height:80px; padding:8px; resize:vertical;"></textarea>
        <small style="display:block; color:#666; margin-top:5px;">
          PDF'de görünen yemek adını yazın (bu hiç eşleşmesin)
        </small>
      </div>
      <div style="flex:1;">
        <label style="display:block; margin-bottom:5px; font-weight:bold;">Yasaklı Kartlar:</label>
        <input type="text" id="yasakKartArama" placeholder="Kart adında ara..." style="width:100%; padding:8px; margin-bottom:8px;" />
        <div id="yasakKartListesi" style="height:120px; overflow-y:auto; border:1px solid #ddd; padding:8px; background:#f8f9fa;">
          <!-- Dinamik kartlar buraya gelecek -->
        </div>
        <small style="display:block; color:#666; margin-top:5px;">
          Bu kartlarla eşleşmesin diye işaretleyin
        </small>
      </div>
    </div>
    <div style="margin-bottom:15px;">
      <button onclick="eslesmemeKuraliEkle()" style="background:#dc3545; color:white; padding:10px 20px; border:none; border-radius:5px; cursor:pointer;">
        Yasak Ekle
      </button>
      <button onclick="eslesmemeKurallariniTemizle()" style="background:#6c757d; color:white; padding:10px 20px; border:none; border-radius:5px; cursor:pointer; margin-left:10px;">
        Tüm Yasakları Temizle
      </button>
      <button onclick="eslesmemeKurallariniGitHubKaydet()" style="background:#007bff; color:white; padding:10px 20px; border:none; border-radius:5px; cursor:pointer; margin-left:10px;">
        GitHub'a Kaydet
      </button>
      <button onclick="eslesmemeKurallariniGitHubYukle()" style="background:#6f42c1; color:white; padding:10px 20px; border:none; border-radius:5px; cursor:pointer; margin-left:10px;">
        GitHub'dan Yükle
      </button>
    </div>
    <div id="eslesmemeStatus" style="margin-bottom:15px; padding:10px; border-radius:5px; display:none;"></div>
    <div>
      <h4>Kayıtlı Eşleşme Yasakları:</h4>
      <div id="eslesmemeListesi" style="max-height:200px; overflow-y:auto; border:1px solid #ddd; padding:10px; background:#f8f9fa;">
        <em>Henüz yasak yok</em>
      </div>
    </div>
  </div>

  <!-- Manuel Eşleştirme Paneli -->
  <div id="manuelEslestirmePanel" style="display:none; background:#fff; border:2px solid #28a745; padding:20px; margin:16px 0; border-radius:8px; position:relative;">
    <button onclick="manuelEslestirmePaneliGizle()" style="position:absolute; top:10px; right:10px; background:none; border:none; font-size:20px; cursor:pointer; color:#28a745; font-weight:bold; width:30px; height:30px; border-radius:50%; display:flex; align-items:center; justify-content:center;" title="Kapat">×</button>
    <h3>Manuel Eşleştirme Paneli</h3>
    <div style="display:flex; gap:20px; margin-bottom:20px;">
      <div style="flex:1;">
        <label style="display:block; margin-bottom:5px; font-weight:bold;">PDF'deki Yemek Adı:</label>
        <textarea id="manuelTarifAdi" placeholder="Örn: *Kıymalı karnabahar /bamya yemeği" style="width:100%; height:80px; padding:8px; resize:vertical;"></textarea>
        <small style="display:block; color:#666; margin-top:5px;">
          PDF'de görünen tam metni yazın (*, / işaretleri dahil)
        </small>
      </div>
      <div style="flex:1;">
        <label style="display:block; margin-bottom:5px; font-weight:bold;">Eşleşecek Kartlar:</label>
        <input type="text" id="eskiKartArama" placeholder="Kart adında ara..." style="width:100%; padding:8px; margin-bottom:8px;" oninput="manuelEslestirmeKartAra(this.value)" />
        <div id="manuelKartListesi" style="height:120px; overflow-y:auto; border:1px solid #ddd; padding:8px; background:#f8f9fa;">
          <!-- Dinamik kartlar buraya gelecek -->
        </div>
        <small style="display:block; color:#666; margin-top:5px;">
          Eşleşmesini istediğiniz kartları işaretleyin
        </small>
      </div>
    </div>
    <div style="margin-bottom:15px;">
      <button onclick="manuelEslestirmeEkle()" style="background:#28a745; color:white; padding:10px 20px; border:none; border-radius:5px; cursor:pointer;">
        Eşleştirme Ekle
      </button>
      <button onclick="manuelEslestirmeleriTemizle()" style="background:#dc3545; color:white; padding:10px 20px; border:none; border-radius:5px; cursor:pointer; margin-left:10px;">
        Tüm Eşleştirmeleri Temizle
      </button>
      <button onclick="manuelEslestirmeleriGitHubKaydet()" style="background:#007bff; color:white; padding:10px 20px; border:none; border-radius:5px; cursor:pointer; margin-left:10px;">
        GitHub'a Kaydet
      </button>
      <button onclick="manuelEslestirmeleriGitHubYukle()" style="background:#6f42c1; color:white; padding:10px 20px; border:none; border-radius:5px; cursor:pointer; margin-left:10px;">
        GitHub'dan Yükle
      </button>
    </div>
    <div id="manuelEslestirmeStatus" style="margin-bottom:15px; padding:10px; border-radius:5px; display:none;"></div>
    <div>
      <h4>Kayıtlı Manuel Eşleştirmeler:</h4>
      <div id="manuelEslestirmeListesi" style="max-height:200px; overflow-y:auto; border:1px solid #ddd; padding:10px; background:#f8f9fa;">
        <em>Henüz manuel eşleştirme yok</em>
      </div>
    </div>
  </div>

  <!-- Kart Silme Formu -->
  <div id="kartSilFormu" style="display:none; background:#fff; border:2px solid #dc3545; padding:20px; margin:16px 0; border-radius:8px; position:relative;">
    <button onclick="kartSilFormGizle()" style="position:absolute; top:10px; right:10px; background:none; border:none; font-size:20px; cursor:pointer; color:#dc3545; font-weight:bold; width:30px; height:30px; border-radius:50%; display:flex; align-items:center; justify-content:center;" title="Kapat">×</button>
    <h3>Tarif Kartı Sil</h3>
    <div style="margin-bottom:15px;">
      <label style="display:block; margin-bottom:5px; font-weight:bold;">Silinecek Kartı Seçin:</label>
      <input type="text" id="kartAramaInput" placeholder="Kart adında ara... (örn: avok salat)" style="width:300px; padding:8px; margin-bottom:8px;" />
      <select id="silinecekKart" style="width:300px; padding:8px;">
        <option value="">Kart seçin...</option>
      </select>
      <small style="display:block; color:#666; margin-top:5px;">
        Yukarıdaki arama kutusuna yazarak filtreleyin veya listeden seçin
      </small>
      <small style="display:block; color:#666; margin-top:2px;">
        Bu işlem hem dosyayı hem de list.json'dan kaydı siler
      </small>
    </div>
    <div id="onizlemeAlani" style="margin-bottom:15px; text-align:center;"></div>
    <div style="margin-bottom:15px;">
      <button onclick="kartSil()" style="background:#dc3545; color:white; padding:10px 20px; border:none; border-radius:5px; cursor:pointer;">
        Kartı Sil
      </button>
      <button onclick="kartSilFormGizle()" style="background:#6c757d; color:white; padding:10px 20px; border:none; border-radius:5px; cursor:pointer; margin-left:10px;">
        İptal
      </button>
    </div>
    <div id="silmeStatus" style="margin-top:15px; padding:10px; border-radius:5px; display:none;"></div>
  </div>

  <!-- Yeni Kart Ekleme Formu -->
  <div id="yeniKartFormu" style="display:none; background:#fff; border:2px solid #007bff; padding:20px; margin:16px 0; border-radius:8px; position:relative;">
    <button onclick="yeniKartFormGizle()" style="position:absolute; top:10px; right:10px; background:none; border:none; font-size:20px; cursor:pointer; color:#007bff; font-weight:bold; width:30px; height:30px; border-radius:50%; display:flex; align-items:center; justify-content:center;" title="Kapat">×</button>
    <h3>Yeni Tarif Kartı Ekle</h3>
    <div style="margin-bottom:15px;">
      <label style="display:block; margin-bottom:5px; font-weight:bold;">Kart Adı:</label>
      <input id="yeniKartAdi" placeholder="Örn: mantarli_tavuk_sote" style="width:300px; padding:8px;" />
      <small style="display:block; color:#666; margin-top:5px;">
        Not: Türkçe karakterler kullanmayın, boşluk yerine _ kullanın, .jpg eklemeyin
      </small>
    </div>
    <div style="margin-bottom:15px;">
      <label style="display:block; margin-bottom:5px; font-weight:bold;">Görsel Dosyası:</label>
      <input type="file" id="yeniKartDosya" accept="image/jpeg,image/jpg,image/png" style="padding:8px;" />
      <small style="display:block; color:#666; margin-top:5px;">
        Sadece JPG/PNG dosyaları kabul edilir
      </small>
    </div>
    <div style="margin-bottom:15px;">
      <button onclick="yeniKartKaydet()" style="background:#28a745; color:white; padding:10px 20px; border:none; border-radius:5px; cursor:pointer;">
        Kartı Kaydet ve GitHub'a Yükle
      </button>
      <button onclick="yeniKartFormGizle()" style="background:#6c757d; color:white; padding:10px 20px; border:none; border-radius:5px; cursor:pointer; margin-left:10px;">
        İptal
      </button>
    </div>
    <div id="yuklemeStatus" style="margin-top:15px; padding:10px; border-radius:5px; display:none;"></div>
  </div>

  <!-- Kart Düzenleme Formu -->
  <div id="kartDuzenleFormu" style="display:none; background:#fff; border:2px solid #ffc107; padding:20px; margin:16px 0; border-radius:8px; position:relative;">
    <button onclick="kartDuzenleFormGizle()" style="position:absolute; top:10px; right:10px; background:none; border:none; font-size:20px; cursor:pointer; color:#ffc107; font-weight:bold; width:30px; height:30px; border-radius:50%; display:flex; align-items:center; justify-content:center;" title="Kapat">×</button>
    <h3>Tarif Kartı Düzenle</h3>
    
    <!-- Kart Seçimi -->
    <div style="margin-bottom:20px;">
      <label style="display:block; margin-bottom:5px; font-weight:bold;">Düzenlenecek Kartı Seçin:</label>
      <div style="display:flex; gap:8px; margin-bottom:10px;">
        <input type="text" id="duzenleKartArama" placeholder="Kart adında ara..." style="flex:1; padding:8px;" oninput="kartListesiniFiltreleForDuzenleme(this.value)" />
        <button onclick="listjsonTemizle()" style="padding:8px 12px; background:#dc3545; color:white; border:none; border-radius:4px; cursor:pointer; font-size:12px;"
                title="Mevcut olmayan dosyaları list.json'dan temizle">
          🧹 Temizle
        </button>
      </div>
      <div id="duzenleKartListesi" style="height:150px; overflow-y:auto; border:1px solid #ddd; padding:10px; background:#f8f9fa;">
        <!-- Dinamik kartlar buraya gelecek -->
      </div>
    </div>
    
    <!-- Seçili Kart Bilgileri -->
    <div id="seciliKartBilgileri" style="display:none;">
      <div style="margin-bottom:15px;">
        <label style="display:block; margin-bottom:5px; font-weight:bold;">Mevcut Kart:</label>
        <div id="mevcutKartOnizleme" style="border:1px solid #ddd; padding:10px; background:#f8f9fa; border-radius:5px;">
          <!-- Mevcut kart önizlemesi -->
        </div>
      </div>
      
      <div style="margin-bottom:15px;">
        <label style="display:block; margin-bottom:5px; font-weight:bold;">Yeni Kart Adı:</label>
        <input id="duzenleKartYeniAdi" placeholder="Yeni kart adı" style="width:300px; padding:8px;" />
        <small style="display:block; color:#666; margin-top:5px;">
          Not: Türkçe karakterler kullanmayın, boşluk yerine _ kullanın, .jpg eklemeyin
        </small>
      </div>
      
      <div style="margin-bottom:15px;">
        <label style="display:block; margin-bottom:5px; font-weight:bold;">Yeni Görsel Dosyası (isteğe bağlı):</label>
        <input type="file" id="duzenleKartYeniDosya" accept="image/jpeg,image/jpg,image/png" style="padding:8px;" />
        <small style="display:block; color:#666; margin-top:5px;">
          Boş bırakırsanız sadece isim değişir. Dosya seçerseniz hem isim hem görsel değişir.
        </small>
      </div>
      
      <div style="margin-bottom:15px;">
        <button onclick="kartDuzenlemeKaydet()" style="background:#ffc107; color:#212529; padding:10px 20px; border:none; border-radius:5px; cursor:pointer; font-weight:bold;">
          Değişiklikleri Kaydet
        </button>
        <button onclick="kartDuzenleFormGizle()" style="background:#6c757d; color:white; padding:10px 20px; border:none; border-radius:5px; cursor:pointer; margin-left:10px;">
          İptal
        </button>
      </div>
    </div>
    
    <div id="duzenlemeStatus" style="margin-top:15px; padding:10px; border-radius:5px; display:none;"></div>
  </div>

  <!-- Manuel Kart Ekleme Modal -->
  <div id="manuelKartModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000;" onclick="manuelKartModalKapat(event)">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 8px; width: 80%; max-width: 800px; max-height: 80%; overflow: hidden;" onclick="event.stopPropagation()">
      <div style="padding: 20px; border-bottom: 1px solid #ddd;">
        <h3 style="margin: 0; color: #333;">Manuel Kart Ekleme</h3>
        <p style="margin: 5px 0 0 0; color: #666; font-size: 14px;">Seçili haftaya eklemek istediğiniz tarif kartlarını seçin</p>
      </div>
      
      <div style="padding: 20px;">
        <input type="text" id="manuelKartArama" placeholder="Tarif ara (boş bırakın tümünü görmek için)..." style="width: 100%; padding: 10px; font-size: 14px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 15px;" oninput="manuelKartAramaYap(this.value)">
        
        <div id="manuelKartListe" style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; padding: 10px;">
          <div style="text-align: center; color: #666; padding: 20px;">Yükleniyor...</div>
        </div>
      </div>
      
      <div style="padding: 20px; border-top: 1px solid #ddd; text-align: right;">
        <button onclick="manuelKartModalKapat()" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin-right: 10px;">İptal</button>
        <button onclick="secilenManuelKartlariEkle()" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">Seçilen Kartları Ekle</button>
      </div>
    </div>
  </div>

  <!-- Yemek Ekleme/Düzenleme Modal -->
  <div id="yemekDuzenleModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10001;" onclick="yemekModalKapat(event)">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 8px; width: 90%; max-width: 900px; max-height: 90%; overflow: hidden;" onclick="event.stopPropagation()">
      <div style="padding: 20px; border-bottom: 1px solid #ddd; background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white;">
        <h3 style="margin: 0;" id="yemekModalBaslik">🍽️ Yemek Ekle/Düzenle</h3>
        <p style="margin: 5px 0 0 0; font-size: 14px; opacity: 0.9;">Yemek veritabanına yeni yemek ekleyin veya mevcut yemeği düzenleyin</p>
      </div>
      
      <!-- Tab Navigation -->
      <div style="display: flex; border-bottom: 1px solid #ddd; background: #f8f9fa;">
        <button type="button" id="yeniYemekTab" onclick="tabAc('yeniYemek')" style="flex: 1; padding: 12px 20px; border: none; background: transparent; cursor: pointer; font-weight: 500; transition: all 0.3s ease; border-bottom: 3px solid transparent;">
          <i class="fas fa-plus-circle" style="margin-right: 8px; color: #28a745;"></i>Yeni Yemek Ekle
        </button>
        <button type="button" id="eslestirTab" onclick="tabAc('eslestir')" style="flex: 1; padding: 12px 20px; border: none; background: transparent; cursor: pointer; font-weight: 500; transition: all 0.3s ease; border-bottom: 3px solid transparent;">
          <i class="fas fa-link" style="margin-right: 8px; color: #20c997;"></i>Veritabanından Eşleştir
        </button>
      </div>
      
      <!-- Tab Content Container -->
      <div style="padding: 20px; max-height: 60vh; overflow-y: auto;">
        
        <!-- Yeni Yemek Ekleme Tab -->
        <div id="yeniYemekContent" style="display: block;">
        <form id="yemekDuzenleForm">
          <!-- Temel Bilgiler -->
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
            <div>
              <label style="display: block; font-weight: bold; margin-bottom: 5px; color: #333;">Yemek Adı *</label>
              <input type="text" id="yemekAdi" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
            </div>
            <div>
              <label style="display: block; font-weight: bold; margin-bottom: 5px; color: #333;">Kategori *</label>
              <div style="display: flex; gap: 8px; align-items: end;">
                <select id="yemekKategori" required style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;" onchange="kategoriDegisti()">
                  <option value="">Kategori Seçin...</option>
                  <option value="AKSAM">AKSAM</option>
                  <option value="AKŞAM">AKŞAM</option>
                  <option value="APERATIF">APERATIF</option>
                  <option value="ATIŞTIRMALIK">ATIŞTIRMALIK</option>
                  <option value="EKMEKLER">EKMEKLER</option>
                  <option value="KAHVALTI">KAHVALTI</option>
                  <option value="KOLLAJEN">KOLLAJEN</option>
                  <option value="KURUYEMİŞLER">KURUYEMİŞLER</option>
                  <option value="MEYVE">MEYVE</option>
                  <option value="MEYVELER">MEYVELER</option>
                  <option value="OGLE">OGLE</option>
                  <option value="SALATALAR">SALATALAR</option>
                  <option value="TATLILAR">TATLILAR</option>
                  <option value="TOSTLAR">TOSTLAR</option>
                  <option value="Yeni Eklenenler">Yeni Eklenenler</option>
                  <option value="diğer">diğer</option>
                  <option value="ÇORBALAR">ÇORBALAR</option>
                  <option value="ÖĞLEN">ÖĞLEN</option>
                  <option value="İÇECEKLER">İÇECEKLER</option>
                  <option value="__YENI__" style="background: #28a745; color: white; font-weight: bold;">+ YENİ KATEGORİ EKLE</option>
                </select>
                <button type="button" onclick="kategoriEkleModal()" style="padding: 8px 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; white-space: nowrap;" title="Yeni kategori ekle">➕</button>
              </div>
              <!-- Yeni kategori input alanı (gizli) -->
              <div id="yeniKategoriAlani" style="display: none; margin-top: 8px;">
                <div style="display: flex; gap: 8px;">
                  <input type="text" id="yeniKategoriAdi" placeholder="Yeni kategori adı (örn: SÜTLÜ ÜRÜNLER)" style="flex: 1; padding: 8px; border: 2px solid #28a745; border-radius: 4px; font-size: 14px;">
                  <button type="button" onclick="yeniKategoriKaydet()" style="padding: 8px 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">✓</button>
                  <button type="button" onclick="yeniKategoriIptal()" style="padding: 8px 12px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">✗</button>
                </div>
                <small style="color: #666;">Büyük harflerle yazın. Bu kategori tüm sistemde kullanılabilir hale gelecek.</small>
              </div>
            </div>
          </div>

          <!-- Besin Değerleri -->
          <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;">
              <div>
                <label style="display: block; font-weight: bold; margin-bottom: 5px; color: #333;">
                  🧮 Kalori (kcal)
                </label>
                <input type="number" id="yemekKalori" min="0" step="0.1" readonly 
                       style="width: 100%; padding: 8px; border: 1px solid #28a745; border-radius: 4px; background: #d4f4dd; color: #155724; font-weight: bold; text-align: center;"
                       title="Kalori = (Protein × 4) + (Karbonhidrat × 4) + (Yağ × 9)">
              </div>
              <div>
                <label style="display: block; font-weight: bold; margin-bottom: 5px; color: #333;">Protein (g)</label>
                <input type="number" id="yemekProtein" min="0" step="0.1" 
                       style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"
                       oninput="hesaplaKalori()">
              </div>
              <div>
                <label style="display: block; font-weight: bold; margin-bottom: 5px; color: #333;">Karbonhidrat (g)</label>
                <input type="number" id="yemekKarb" min="0" step="0.1" 
                       style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"
                       oninput="hesaplaKalori()">
              </div>
              <div>
                <label style="display: block; font-weight: bold; margin-bottom: 5px; color: #333;">Yağ (g)</label>
                <input type="number" id="yemekYag" min="0" step="0.1" 
                       style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"
                       oninput="hesaplaKalori()">
              </div>
            </div>
          </div>

          <!-- Porsiyon Bilgileri -->
          <div style="background: #e8f4f8; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
            <h4 style="margin: 0 0 15px 0; color: #495057;">⚖️ Porsiyon Bilgileri</h4>
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;">
              <div>
                <label style="display: block; font-weight: bold; margin-bottom: 5px; color: #333;">Min Miktar</label>
                <input type="number" id="yemekMinMiktar" min="0" step="0.1" value="0.5" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
              </div>
              <div>
                <label style="display: block; font-weight: bold; margin-bottom: 5px; color: #333;">Max Miktar</label>
                <input type="number" id="yemekMaxMiktar" min="0" step="0.1" value="1" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
              </div>
              <div>
                <label style="display: block; font-weight: bold; margin-bottom: 5px; color: #333;">Adım</label>
                <input type="number" id="yemekAdim" min="0.1" step="0.1" value="0.5" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
              </div>
              <div>
                <label style="display: block; font-weight: bold; margin-bottom: 5px; color: #333;">Çarpan</label>
                <input type="number" id="yemekCarpan" min="0.1" step="0.1" value="1" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
              </div>
            </div>
          </div>

          <!-- Özellikler -->
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
            <!-- Rol -->
            <div>
              <label style="display: block; font-weight: bold; margin-bottom: 5px; color: #333;">Rol</label>
              <div style="display: flex; gap: 8px; align-items: end;">
                <select id="yemekRol" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" onchange="rolDegisti()">
                  <option value="">Rol Seçin...</option>
                  <option value="bread">bread (Ekmek)</option>
                  <option value="dessert">dessert (Tatlı)</option>
                  <option value="drink">drink (İçecek)</option>
                  <option value="fruit">fruit (Meyve)</option>
                  <option value="mainDish">mainDish (Ana Yemek)</option>
                  <option value="sideDish">sideDish (Yan Yemek)</option>
                  <option value="snack">snack (Atıştırmalık)</option>
                  <option value="soup">soup (Çorba)</option>
                  <option value="supplement">supplement (Takviye)</option>
                  <option value="__YENI__" style="background: #17a2b8; color: white; font-weight: bold;">+ YENİ ROL EKLE</option>
                </select>
                <button type="button" onclick="rolEkleModal()" style="padding: 8px 12px; background: #17a2b8; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; white-space: nowrap;" title="Yeni rol ekle">➕</button>
              </div>
              <!-- Yeni rol input alanı (gizli) -->
              <div id="yeniRolAlani" style="display: none; margin-top: 8px;">
                <div style="display: flex; gap: 8px;">
                  <input type="text" id="yeniRolKodu" placeholder="Rol kodu (örn: pasta)" style="flex: 1; padding: 8px; border: 2px solid #17a2b8; border-radius: 4px; font-size: 12px;">
                  <input type="text" id="yeniRolAciklama" placeholder="Açıklama (örn: Pasta)" style="flex: 1; padding: 8px; border: 2px solid #17a2b8; border-radius: 4px; font-size: 12px;">
                  <button type="button" onclick="yeniRolKaydet()" style="padding: 8px 12px; background: #17a2b8; color: white; border: none; border-radius: 4px; cursor: pointer;">✓</button>
                  <button type="button" onclick="yeniRolIptal()" style="padding: 8px 12px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">✗</button>
                </div>
                <small style="color: #666;">Kod: küçük harflerle, Açıklama: büyük harfle başlasın. Bu rol tüm sistemde kullanılabilir hale gelecek.</small>
              </div>
            </div>

            <!-- Öğün Türleri -->
            <div>
              <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 5px;">
                <label style="font-weight: bold; color: #333;">Öğün Türleri</label>
                <button type="button" onclick="ogunEkleModal()" style="padding: 4px 8px; background: #17a2b8; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; margin-left: auto;" title="Yeni öğün tipi ekle">➕ YENİ ÖĞÜN</button>
              </div>
              <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                <label style="display: flex; align-items: center; gap: 5px; font-size: 13px;">
                  <input type="checkbox" id="yemekBreakfast" value="breakfast"> Breakfast (Kahvaltı)
                </label>
                <label style="display: flex; align-items: center; gap: 5px; font-size: 13px;">
                  <input type="checkbox" id="yemekLunch" value="lunch"> Lunch (Öğle)
                </label>
                <label style="display: flex; align-items: center; gap: 5px; font-size: 13px;">
                  <input type="checkbox" id="yemekDinner" value="dinner"> Dinner (Akşam)
                </label>
                <label style="display: flex; align-items: center; gap: 5px; font-size: 13px;">
                  <input type="checkbox" id="yemekDessert" value="dessert"> Dessert (Tatlı)
                </label>
                <label style="display: flex; align-items: center; gap: 5px; font-size: 13px;">
                  <input type="checkbox" id="yemekDrink" value="drink"> Drink (İçecek)
                </label>
                <label style="display: flex; align-items: center; gap: 5px; font-size: 13px;">
                  <input type="checkbox" id="yemekSnack" value="snack"> Snack (Atıştırmalık)
                </label>
                <!-- Dinamik öğün tipleri buraya eklenecek -->
                <div id="dinamikOgunler" style="display: contents;"></div>
              </div>
              <!-- Yeni öğün input alanı (gizli) -->
              <div id="yeniOgunAlani" style="display: none; margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 4px; border: 2px solid #17a2b8;">
                <div style="display: flex; gap: 8px; margin-bottom: 5px;">
                  <input type="text" id="yeniOgunKodu" placeholder="Öğün kodu (örn: brunch)" style="flex: 1; padding: 8px; border: 2px solid #17a2b8; border-radius: 4px; font-size: 12px;">
                  <input type="text" id="yeniOgunAciklama" placeholder="Açıklama (örn: Brunch)" style="flex: 1; padding: 8px; border: 2px solid #17a2b8; border-radius: 4px; font-size: 12px;">
                  <button type="button" onclick="yeniOgunKaydet()" style="padding: 8px 12px; background: #17a2b8; color: white; border: none; border-radius: 4px; cursor: pointer;">✓</button>
                  <button type="button" onclick="yeniOgunIptal()" style="padding: 8px 12px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">✗</button>
                </div>
                <small style="color: #666;">Kod: küçük harflerle, Açıklama: büyük harfle başlasın. Bu öğün tipi tüm sistemde kullanılabilir hale gelecek.</small>
              </div>
            </div>
          </div>

          <!-- Diet Özellikleri -->
          <div style="background: #fff3cd; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
            <h4 style="margin: 0 0 15px 0; color: #495057;">🥗 Diyet Özellikleri</h4>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
              <label style="display: flex; align-items: center; gap: 8px; font-weight: bold;">
                <input type="checkbox" id="yemekKeto"> Keto Uyumlu
              </label>
              <label style="display: flex; align-items: center; gap: 8px; font-weight: bold;">
                <input type="checkbox" id="yemekLowCarb"> Düşük Karbonhidrat
              </label>
              <label style="display: flex; align-items: center; gap: 8px; font-weight: bold;">
                <input type="checkbox" id="yemekPorsiyonSabit"> Porsiyon Sabit
              </label>
            </div>
          </div>

          <!-- Filler Özellikleri -->
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
            <label style="display: flex; align-items: center; gap: 8px; font-weight: bold;">
              <input type="checkbox" id="yemekFillerOgle"> Öğle Filler
            </label>
            <label style="display: flex; align-items: center; gap: 8px; font-weight: bold;">
              <input type="checkbox" id="yemekFillerAksam"> Akşam Filler
            </label>
          </div>

          <!-- Etiketler (Tags) -->
          <div style="margin-bottom: 20px;">
            <label style="display: block; font-weight: bold; margin-bottom: 5px; color: #333;">🏷️ Etiketler (Tags) - virgülle ayırın</label>
            <input type="text" id="yemekEtiketler" placeholder="örn: keto, protein, sebze, et" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            <small style="color: #666;">Arama ve kategorilendirme için kullanılacak etiketler (tags alanı)</small>
            
            <!-- Popüler Etiketler -->
            <div style="margin-top: 8px;">
              <small style="color: #666; font-weight: bold;">💡 Popüler etiketler (tıklayarak ekle):</small>
              <div style="display: flex; flex-wrap: wrap; gap: 4px; margin-top: 4px;">
                <button type="button" onclick="etiketEkle('yemekEtiketler', 'keto')" style="padding: 2px 6px; background: #28a745; color: white; border: none; border-radius: 12px; font-size: 10px; cursor: pointer;">keto</button>
                <button type="button" onclick="etiketEkle('yemekEtiketler', 'et')" style="padding: 2px 6px; background: #dc3545; color: white; border: none; border-radius: 12px; font-size: 10px; cursor: pointer;">et</button>
                <button type="button" onclick="etiketEkle('yemekEtiketler', 'yumurta')" style="padding: 2px 6px; background: #ffc107; color: black; border: none; border-radius: 12px; font-size: 10px; cursor: pointer;">yumurta</button>
                <button type="button" onclick="etiketEkle('yemekEtiketler', 'salata')" style="padding: 2px 6px; background: #198754; color: white; border: none; border-radius: 12px; font-size: 10px; cursor: pointer;">salata</button>
                <button type="button" onclick="etiketEkle('yemekEtiketler', 'ekmek')" style="padding: 2px 6px; background: #795548; color: white; border: none; border-radius: 12px; font-size: 10px; cursor: pointer;">ekmek</button>
                <button type="button" onclick="etiketEkle('yemekEtiketler', 'zeytinyağı')" style="padding: 2px 6px; background: #ff9800; color: white; border: none; border-radius: 12px; font-size: 10px; cursor: pointer;">zeytinyağı</button>
                <button type="button" onclick="etiketEkle('yemekEtiketler', 'peynir')" style="padding: 2px 6px; background: #ffeb3b; color: black; border: none; border-radius: 12px; font-size: 10px; cursor: pointer;">peynir</button>
                <button type="button" onclick="etiketEkle('yemekEtiketler', 'tavuk')" style="padding: 2px 6px; background: #ff5722; color: white; border: none; border-radius: 12px; font-size: 10px; cursor: pointer;">tavuk</button>
                <button type="button" onclick="etiketEkle('yemekEtiketler', 'sebze')" style="padding: 2px 6px; background: #4caf50; color: white; border: none; border-radius: 12px; font-size: 10px; cursor: pointer;">sebze</button>
              </div>
            </div>
          </div>

          <!-- Uyumluluk Etiketleri (Compatibility Tags) -->
          <div style="margin-bottom: 20px;">
            <label style="display: block; font-weight: bold; margin-bottom: 5px; color: #333;">🤝 Uyumluluk Etiketleri (Compatibility) - virgülle ayırın</label>
            <input type="text" id="yemekUyumluluk" placeholder="örn: salata, kuruyemiş, sebze, çorba" style="width: 100%; padding: 8px; border: 1px solid #28a745; border-radius: 4px;">
            <small style="color: #666;">Bu yemekle uyumlu olan kategoriler (compatibilityTags alanı) - alternatif önerilerde öncelik verilir</small>
            
            <!-- Popüler Uyumluluk Etiketleri -->
            <div style="margin-top: 8px;">
              <small style="color: #666; font-weight: bold;">💡 Popüler uyumluluk etiketleri (tıklayarak ekle):</small>
              <div style="display: flex; flex-wrap: wrap; gap: 4px; margin-top: 4px;">
                <button type="button" onclick="etiketEkle('yemekUyumluluk', 'salata')" style="padding: 2px 6px; background: #198754; color: white; border: none; border-radius: 12px; font-size: 10px; cursor: pointer;">salata</button>
                <button type="button" onclick="etiketEkle('yemekUyumluluk', 'kuruyemiş')" style="padding: 2px 6px; background: #795548; color: white; border: none; border-radius: 12px; font-size: 10px; cursor: pointer;">kuruyemiş</button>
                <button type="button" onclick="etiketEkle('yemekUyumluluk', 'yoğurt')" style="padding: 2px 6px; background: #e3f2fd; color: black; border: none; border-radius: 12px; font-size: 10px; cursor: pointer;">yoğurt</button>
                <button type="button" onclick="etiketEkle('yemekUyumluluk', 'peynir')" style="padding: 2px 6px; background: #ffeb3b; color: black; border: none; border-radius: 12px; font-size: 10px; cursor: pointer;">peynir</button>
                <button type="button" onclick="etiketEkle('yemekUyumluluk', 'sebze')" style="padding: 2px 6px; background: #4caf50; color: white; border: none; border-radius: 12px; font-size: 10px; cursor: pointer;">sebze</button>
                <button type="button" onclick="etiketEkle('yemekUyumluluk', 'çorba')" style="padding: 2px 6px; background: #ff9800; color: white; border: none; border-radius: 12px; font-size: 10px; cursor: pointer;">çorba</button>
                <button type="button" onclick="etiketEkle('yemekUyumluluk', 'ekmek')" style="padding: 2px 6px; background: #795548; color: white; border: none; border-radius: 12px; font-size: 10px; cursor: pointer;">ekmek</button>
                <button type="button" onclick="etiketEkle('yemekUyumluluk', 'zeytin')" style="padding: 2px 6px; background: #424242; color: white; border: none; border-radius: 12px; font-size: 10px; cursor: pointer;">zeytin</button>
              </div>
            </div>
          </div>

          <!-- Uyumsuzluk Etiketleri (Incompatibility Tags) -->
          <div style="margin-bottom: 20px;">
            <label style="display: block; font-weight: bold; margin-bottom: 5px; color: #333;">🚫 Uyumsuzluk Etiketleri (Incompatibility) - virgülle ayırın</label>
            <input type="text" id="yemekUyumsuzluk" placeholder="örn: şeker, alkol, fazla tuz" style="width: 100%; padding: 8px; border: 1px solid #dc3545; border-radius: 4px;">
            <small style="color: #666;">Bu yemekle uyumsuz olan kategoriler (incompatibilityTags alanı) - aynı öğünde çakışma engellenir</small>
          </div>

          <!-- Sezon Bilgileri -->
          <div style="background: #d1ecf1; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
            <h4 style="margin: 0 0 15px 0; color: #495057;">🗓️ Sezon Bilgileri</h4>
            <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 15px; align-items: center;">
              <div>
                <label style="display: block; font-weight: bold; margin-bottom: 5px; color: #333;">Sezon Aralığı (1-12 ay)</label>
                <input type="text" id="yemekSezon" value="[1,12]" placeholder="[1,12]" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                <small style="color: #666;">Örnek: [6,8] (Haziran-Ağustos), [1,12] (Tüm yıl)</small>
              </div>
              <div>
                <label style="display: flex; align-items: center; gap: 8px; font-weight: bold;">
                  <input type="checkbox" id="yemekTersSezon"> Ters Sezon
                </label>
                <small style="color: #666;">Belirtilen aylar dışında kullanılır</small>
              </div>
            </div>
          </div>
        </form>
        </div>
        
        <!-- Eşleştirme Tab -->
        <div id="eslestirContent" style="display: none;">
          <div style="background: #e3f2fd; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #20c997;">
            <h4 style="margin: 0 0 10px 0; color: #0d47a1; display: flex; align-items: center; gap: 10px;">
              <i class="fas fa-link" style="color: #20c997;"></i>
              Akıllı Yemek Eşleştirme
            </h4>
            <p style="margin: 0; color: #1565c0; font-size: 14px;">
              PDF'den okunan "<strong id="eslestirYemekAdi"></strong>" yemeğini veritabanındaki mevcut bir yemekle eşleştirin.
            </p>
          </div>
          
          <!-- Arama ve Filtreleme -->
          <div style="margin-bottom: 20px;">
            <div style="position: relative;">
              <input type="text" id="yemekAramaInput" placeholder="Veritabanında yemek ara... (örn: tavuk, pilav, salata)" 
                     style="width: 100%; padding: 12px 45px 12px 12px; border: 2px solid #20c997; border-radius: 8px; font-size: 14px;"
                     oninput="yemekListesiniFiltrele()">
              <i class="fas fa-search" style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: #20c997;"></i>
            </div>
            
            <!-- Hızlı Filtreler -->
            <div style="margin-top: 15px; display: flex; flex-wrap: wrap; gap: 8px;">
              <button type="button" onclick="hizliFiltre('all')" class="hizli-filtre active" data-filtre="all">
                Tümü (<span id="toplamYemekSayisi">0</span>)
              </button>
              <button type="button" onclick="hizliFiltre('KAHVALTI')" class="hizli-filtre" data-filtre="KAHVALTI">
                🌅 Kahvaltı
              </button>
              <button type="button" onclick="hizliFiltre('OGLE')" class="hizli-filtre" data-filtre="OGLE">
                🌞 Öğle
              </button>
              <button type="button" onclick="hizliFiltre('AKSAM')" class="hizli-filtre" data-filtre="AKSAM">
                🌙 Akşam
              </button>
              <button type="button" onclick="hizliFiltre('TATLI')" class="hizli-filtre" data-filtre="TATLI">
                🍰 Tatlı
              </button>
              <button type="button" onclick="hizliFiltre('ICECEK')" class="hizli-filtre" data-filtre="ICECEK">
                🥤 İçecek
              </button>
            </div>
          </div>
          
          <!-- Yemek Listesi -->
          <div style="background: #f8f9fa; border-radius: 8px; max-height: 300px; overflow-y: auto; border: 1px solid #dee2e6;">
            <div id="yemekListesiContainer" style="padding: 10px;">
              <!-- Yemek listesi JavaScript ile doldurulacak -->
            </div>
          </div>
          
          <!-- Seçilen Yemek Bilgisi -->
          <div id="secilenYemekBilgi" style="display: none; background: #d4edda; padding: 15px; border-radius: 8px; margin-top: 15px; border: 1px solid #c3e6cb;">
            <h5 style="margin: 0 0 10px 0; color: #155724; display: flex; align-items: center; gap: 8px;">
              <i class="fas fa-check-circle"></i>
              Seçilen Yemek:
            </h5>
            <div id="secilenYemekDetay" style="color: #155724; font-size: 14px;">
              <!-- Seçilen yemek detayları buraya gelecek -->
            </div>
          </div>
          
          <!-- Alias Ekleme Seçeneği -->
          <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-top: 15px; border: 1px solid #ffeaa7;">
            <label style="display: flex; align-items: center; gap: 8px; font-weight: 500; color: #856404; margin-bottom: 10px;">
              <input type="checkbox" id="aliasEkleCheckbox" onchange="aliasEklemeToggle()">
              🔗 Bu isimle yeni bir alias (takma ad) oluştur
            </label>
            <div id="aliasEklemeAlani" style="display: none; margin-top: 10px;">
              <p style="margin: 0 0 10px 0; font-size: 13px; color: #856404;">
                "<strong id="pdfYemekAdi"></strong>" ismi ile veritabanına kaydedilecek ve gelecekte otomatik olarak seçilen yemekle eşleştirilecek.
              </p>
            </div>
          </div>
        </div>
        
      </div>
      
      <div style="padding: 20px; border-top: 1px solid #ddd; text-align: right; background: #f8f9fa;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <!-- Sol taraf - Silme butonu -->
          <button onclick="yemekSil()" style="background: #dc3545; color: white; border: none; padding: 12px 24px; border-radius: 4px; cursor: pointer; display: none;" id="yemekSilBtn" title="Bu yemeği kalıcı olarak sil">🗑️ Sil</button>
          
          <!-- Sağ taraf - Diğer butonlar -->
          <div>
            <button onclick="yemekModalKapat()" style="background: #6c757d; color: white; border: none; padding: 12px 24px; border-radius: 4px; cursor: pointer; margin-right: 10px;">İptal</button>
            <button onclick="yemekKaydet()" style="background: #28a745; color: white; border: none; padding: 12px 24px; border-radius: 4px; cursor: pointer; display: none;" id="yemekKaydetBtn">💾 Kaydet</button>
            <button onclick="yemekEslestir()" style="background: #20c997; color: white; border: none; padding: 12px 24px; border-radius: 4px; cursor: pointer; display: none;" id="eslestirKaydetBtn">🔗 Eşleştir</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Şablon Arşivi Modal -->
  <div id="sablonArsiviModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10002;" onclick="sablonArsiviModalKapat(event)">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 8px; width: 95%; max-width: 1200px; max-height: 90%; overflow: hidden;" onclick="event.stopPropagation()">
      <div style="padding: 20px; border-bottom: 1px solid #ddd; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
        <h3 style="margin: 0; font-size: 24px;">📋 Şablon Arşivi</h3>
        <p style="margin: 5px 0 0 0; font-size: 14px; opacity: 0.9;">Kaydedilmiş öğün şablonlarınızı görüntüleyin, düzenleyin ve yönetin</p>
      </div>
      
      <!-- Üst Kontrol Çubuğu -->
      <div style="padding: 15px 20px; border-bottom: 1px solid #ddd; background: #f8f9fa; display: flex; justify-content: space-between; align-items: center;">
        <div style="display: flex; align-items: center; gap: 15px;">
          <span id="sablonSayisiInfo" style="font-weight: bold; color: #495057;">📊 Toplam: 0 şablon</span>
          <button onclick="sablonlariYenile()" style="
            padding: 8px 16px; 
            background: #28a745; 
            color: white; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer;
            font-size: 12px;
          ">🔄 Yenile</button>
        </div>
        <div style="display: flex; align-items: center; gap: 10px;">
          <select id="sablonFiltre" onchange="sablonlariFiltrele()" style="padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 12px;">
            <option value="">Tüm Şablonlar</option>
            <option value="öğle">Öğle Şablonları</option>
            <option value="akşam">Akşam Şablonları</option>
            <option value="kahvaltı">Kahvaltı Şablonları</option>
            <option value="ara">Ara Öğün Şablonları</option>
          </select>
          <select id="diyetTuruFiltre" onchange="sablonlariFiltrele()" style="padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 12px;">
            <option value="">Tüm Diyet Türleri</option>
            <option value="no-diet">Diyet Türü Olmayan</option>
          </select>
          <input type="text" id="sablonArama" placeholder="Şablon ara..." onkeyup="sablonlariAra()" style="
            padding: 8px 12px; 
            border: 1px solid #ccc; 
            border-radius: 4px; 
            font-size: 12px;
            width: 200px;
          ">
        </div>
      </div>
      
      <!-- Şablon Listesi -->
      <div id="sablonListesi" style="padding: 20px; max-height: 60vh; overflow-y: auto;">
        <div style="text-align: center; color: #666; padding: 40px;">
          <i class="fas fa-spinner fa-spin" style="font-size: 24px; margin-bottom: 10px;"></i>
          <p>Şablonlar yükleniyor...</p>
        </div>
      </div>
      
      <!-- Alt Kontrol Çubuğu -->
      <div style="padding: 15px 20px; border-top: 1px solid #ddd; text-align: right; background: #f8f9fa;">
        <button onclick="sablonArsiviModalKapat()" style="background: #6c757d; color: white; border: none; padding: 12px 24px; border-radius: 4px; cursor: pointer;">Kapat</button>
      </div>
    </div>
  </div>

  <!-- Satır Bölme Modal (PDF satırını birden fazla yemeğe ayır) -->
  <div id="satirBolModal" style="display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10002;" onclick="splitModalKapat(event)">
    <div style="position:absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 8px; width: 90%; max-width: 800px; max-height: 85%; overflow: hidden;" onclick="event.stopPropagation()">
      <div style="padding: 14px 18px; border-bottom: 1px solid #ddd; background: linear-gradient(135deg, #6f42c1, #8a63d2); color: white;">
        <h3 style="margin:0; font-size: 18px;">✂️ Satırı Böl</h3>
        <div id="splitModalOrjText" style="margin-top:6px; font-size:12px; opacity:.9;"></div>
      </div>
      <div style="padding:16px; display:flex; gap:16px;">
        <div style="flex:1;">
          <label style="font-weight:600; color:#333;">Yeni Öğeler (her satıra bir yemek):</label>
          <textarea id="splitLinesTextarea" style="width:100%; min-height:180px; border:1px solid #ddd; border-radius:6px; padding:10px; font-size:13px;" placeholder="Örnek:\nPatlıcan musakka\nYeşil salata + 1 yemek kaşığı zeytinyağı ile\nKollajen (1 ölçek 10 gram)"></textarea>
          <div style="margin-top:8px; font-size:12px; color:#666;">
            İpucu: Buraya satırı parçalayıp her yemeği alt alta yazın. Uygula dediğinizde haftaya satırlar olarak eklenecek ve otomatik eşleştirilecek.
          </div>
        </div>
        <div style="width:260px;">
          <label style="font-weight:600; color:#333;">Hızlı Bölme Araçları</label>
          <div style="border:1px solid #eee; border-radius:6px; padding:10px;">
            <button onclick="splitQuickSuggest('kollajen')" style="display:block; width:100%; margin-bottom:6px; background:#e9ecef; border:none; padding:8px; border-radius:4px; cursor:pointer;">'Kollajen' öncesinden böl</button>
            <button onclick="splitQuickSuggest('doubleSpace')" style="display:block; width:100%; margin-bottom:6px; background:#e9ecef; border:none; padding:8px; border-radius:4px; cursor:pointer;">Çift boşluğa göre böl</button>
            <button onclick="splitQuickSuggest('comma')" style="display:block; width:100%; margin-bottom:6px; background:#e9ecef; border:none; padding:8px; border-radius:4px; cursor:pointer;">Virgüllere göre böl (temkinli)</button>
            <div style="margin-top:8px; font-size:12px; color:#666;">Not: Bu araçlar öneri doldurur; düzenleyip Uygula'ya basın.</div>
          </div>
        </div>
      </div>
      <div style="padding:12px 16px; border-top:1px solid #ddd; text-align:right;">
        <button onclick="splitModalKapat()" style="background:#6c757d; color:white; border:none; padding:8px 14px; border-radius:4px; cursor:pointer; margin-right:8px;">İptal</button>
        <button onclick="applySplitFromModal()" style="background:#28a745; color:white; border:none; padding:8px 14px; border-radius:4px; cursor:pointer;">Uygula</button>
      </div>
    </div>
  </div>

    <!-- 🚫 Karaliste Modal (render dışı bırakılan PDF satırları) -->
    <div id="karalisteModal" style="display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10002;" onclick="closeBlacklistModal(event)">
      <div style="position:absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 8px; width: 90%; max-width: 700px; max-height: 85%; overflow: hidden;" onclick="event.stopPropagation()">
        <div style="padding: 14px 18px; border-bottom: 1px solid #ddd; background: linear-gradient(135deg, #dc3545, #c82333); color: white;">
          <h3 style="margin:0; font-size: 18px;">🚫 Karaliste (Render dışı bırakılan satırlar)</h3>
          <div style="margin-top:6px; font-size:12px; opacity:.9;">Bu listedeki satırlar analiz tablosunda gösterilmez. İşareti kaldırarak karalisteden çıkarabilirsiniz.</div>
        </div>
        <div style="padding:16px;">
          <div id="karalisteBos" style="display:none; color:#666; font-size:13px;">Karalistede öğe yok.</div>
          <div id="karalisteListesi" style="max-height:50vh; overflow:auto; border:1px solid #eee; border-radius:6px; padding:10px; background:#fff;"></div>
        </div>
        <div style="padding: 12px 16px; border-top: 1px solid #eee; display:flex; justify-content:space-between; gap:8px; background:#fafafa; flex-wrap: wrap;">
          <div style="display:flex; gap:8px; flex-wrap:wrap;">
            <button onclick="clearBlacklist()" style="background:#ffc107; color:#212529; border:none; padding:10px 16px; border-radius:4px; cursor:pointer;">Tümünü Temizle</button>
          </div>
          <button onclick="closeBlacklistModal()" style="background:#6c757d; color:white; border:none; padding:10px 16px; border-radius:4px; cursor:pointer;">Kapat</button>
        </div>
      </div>
    </div>

  <!-- PDF Önizleme Modal -->
  <div id="pdfOnizlemeModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10002;" onclick="pdfModalKapat(event)">
    <div style="position: relative; width: 90%; max-width: 800px; height: 90%; margin: 2.5% auto; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.3);" onclick="event.stopPropagation()">
      
      <!-- Modal Header -->
      <div style="background: linear-gradient(135deg, #28a745, #20c997); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;">
        <h2 style="margin: 0; font-size: 18px; display: flex; align-items: center; gap: 10px;">
          <span>📄</span>
          <span id="pdfModalBaslik">Diyet Listesi Önizlemesi</span>
        </h2>
        <button onclick="pdfModalKapat()" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer; padding: 0; line-height: 1;">×</button>
      </div>
      
      <!-- Modal Body - PDF Style Content -->
      <div style="height: calc(100% - 140px); overflow-y: auto; padding: 0;">
        <div id="pdfOnizlemeContent" style="padding: 30px; font-family: 'Times New Roman', serif; line-height: 1.4; background: white;">
          <!-- PDF content buraya gelecek -->
        </div>
      </div>
      
      <!-- Modal Footer -->
      <div style="padding: 15px 20px; border-top: 1px solid #ddd; text-align: right; background: #f8f9fa; display: flex; justify-content: space-between; align-items: center;">
        <div style="color: #666; font-size: 14px;">
          <span id="pdfHastaInfo">Hasta bilgileri</span>
        </div>
        <div>
          <button onclick="pdfModalKapat()" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin-right: 10px;">Kapat</button>
          <button onclick="pdfYazdir()" style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin-right: 10px;">🖨️ Yazdır</button>
          <button onclick="pdfIndir()" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">💾 PDF İndir</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Diyet Türleri Yönetimi Modal -->
  <div id="diyetTurleriModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10003;" onclick="diyetTurleriKapat(event)">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 12px; width: 95%; max-width: 1000px; max-height: 90%; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.3);" onclick="event.stopPropagation()">
      
      <!-- Modal Header -->
      <div style="padding: 20px; border-bottom: 1px solid #ddd; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white;">
        <h3 style="margin: 0; font-size: 24px;">🎯 Diyet Türleri Yönetimi</h3>
        <p style="margin: 5px 0 0 0; opacity: 0.9; font-size: 14px;">Farklı diyet türlerini tanımlayın ve makro oranlarını ayarlayın</p>
      </div>

      <!-- Modal Content -->
      <div style="padding: 20px; max-height: 70vh; overflow-y: auto;">
        
        <!-- Yeni Diyet Türü Ekleme Formu -->
        <div style="background: #f8f9fa; border-radius: 8px; padding: 20px; margin-bottom: 20px; border: 1px solid #e9ecef;">
          <h4 style="margin: 0 0 15px 0; color: #495057;">➕ Yeni Diyet Türü Ekle</h4>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
            <div>
              <label style="display: block; font-weight: 600; color: #495057; margin-bottom: 5px;">Diyet Adı:</label>
              <input type="text" id="yeniDiyetAdi" placeholder="Örn: Ketojenik, Düşük Karbonhidrat, Akdeniz" style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 4px; font-size: 14px;">
            </div>
            <div>
              <label style="display: block; font-weight: 600; color: #495057; margin-bottom: 5px;">Açıklama:</label>
              <input type="text" id="yeniDiyetAciklama" placeholder="Kısa açıklama" style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 4px; font-size: 14px;">
            </div>
          </div>

          <!-- Makro Oranları -->
          <h5 style="margin: 15px 0 10px 0; color: #495057;">📊 Makro Oranları (Toplam %100 olmalı)</h5>
          <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
            <div>
              <label style="display: block; font-weight: 600; color: #495057; margin-bottom: 5px;">Karbonhidrat %:</label>
              <input type="range" id="karbOrani" min="0" max="100" value="45" oninput="updateMakroValues()" style="width: 100%;">
              <div style="text-align: center; font-size: 14px; font-weight: bold; color: #007bff;" id="karbValue">45%</div>
            </div>
            <div>
              <label style="display: block; font-weight: 600; color: #495057; margin-bottom: 5px;">Protein %:</label>
              <input type="range" id="proteinOrani" min="0" max="100" value="25" oninput="updateMakroValues()" style="width: 100%;">
              <div style="text-align: center; font-size: 14px; font-weight: bold; color: #28a745;" id="proteinValue">25%</div>
            </div>
            <div>
              <label style="display: block; font-weight: 600; color: #495057; margin-bottom: 5px;">Yağ %:</label>
              <input type="range" id="yagOrani" min="0" max="100" value="30" oninput="updateMakroValues()" style="width: 100%;">
              <div style="text-align: center; font-size: 14px; font-weight: bold; color: #dc3545;" id="yagValue">30%</div>
            </div>
          </div>
          <div style="text-align: center; margin: 10px 0; padding: 8px; background: #e7f3ff; border-radius: 4px; border: 1px solid #b8daff;">
            <span style="font-weight: bold;">Toplam: </span><span id="toplamOran" style="font-weight: bold; color: #007bff;">100%</span>
          </div>

          <!-- Yasaklı Anahtar Kelimeler -->
          <h5 style="margin: 15px 0 10px 0; color: #495057;">🚫 Yasaklı Anahtar Kelimeler</h5>
          <textarea id="yasakliKelimeler" placeholder="Bu diyette yasaklı yemek türleri (virgülle ayırın):&#10;Örn: süt, peynir, yoğurt, ekmek, pilav, makarna" style="width: 100%; height: 60px; padding: 10px; border: 1px solid #ced4da; border-radius: 4px; font-size: 14px; resize: vertical;"></textarea>

          <!-- Zorunlu Özellikler -->
          <h5 style="margin: 15px 0 10px 0; color: #495057;">✅ Zorunlu Özellikler</h5>
          <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
            <label style="display: flex; align-items: center; cursor: pointer;">
              <input type="checkbox" id="ketojenik" style="margin-right: 8px;">
              <span>Ketojenik Uyumlu</span>
            </label>
            <label style="display: flex; align-items: center; cursor: pointer;">
              <input type="checkbox" id="glutensiz" style="margin-right: 8px;">
              <span>Glüten Siz</span>
            </label>
            <label style="display: flex; align-items: center; cursor: pointer;">
              <input type="checkbox" id="vegan" style="margin-right: 8px;">
              <span>Vegan</span>
            </label>
            <label style="display: flex; align-items: center; cursor: pointer;">
              <input type="checkbox" id="vegetarian" style="margin-right: 8px;">
              <span>Vejetaryen</span>
            </label>
            <label style="display: flex; align-items: center; cursor: pointer;">
              <input type="checkbox" id="dusukKalori" style="margin-right: 8px;">
              <span>Düşük Kalori</span>
            </label>
            <label style="display: flex; align-items: center; cursor: pointer;">
              <input type="checkbox" id="yuksekProtein" style="margin-right: 8px;">
              <span>Yüksek Protein</span>
            </label>
          </div>

          <button onclick="diyetTuruEkle()" style="width: 100%; margin-top: 15px; padding: 12px; background: linear-gradient(135deg, #28a745, #20c997); color: white; border: none; border-radius: 6px; font-size: 14px; font-weight: bold; cursor: pointer;">➕ Diyet Türü Ekle</button>
        </div>

        <!-- Mevcut Diyet Türleri Listesi -->
        <div>
          <h4 style="margin: 0 0 15px 0; color: #495057;">📋 Mevcut Diyet Türleri</h4>
          <div id="diyetTurleriListesi" style="border: 1px solid #e9ecef; border-radius: 8px; min-height: 200px; max-height: 300px; overflow-y: auto;">
            <div style="padding: 40px; text-align: center; color: #6c757d;">
              Henüz diyet türü tanımlanmamış. Yukarıdaki formu kullanarak yeni diyet türü ekleyin.
            </div>
          </div>
        </div>
      </div>

      <!-- Modal Footer -->
      <div style="padding: 15px 20px; border-top: 1px solid #ddd; background: #f8f9fa; text-align: right;">
        <button onclick="diyetTurleriKapat()" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin-right: 10px;">Kapat</button>
        <button onclick="diyetTurleriKaydet()" style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">💾 Kaydet</button>
      </div>
    </div>
  </div>

  <!-- Şablon Kaydetme Modal -->
  <div id="sablonKaydetModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10004;" onclick="sablonKaydetModalKapat(event)">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.3); width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto;" onclick="event.stopPropagation()">
      
      <!-- Modal Header -->
      <div style="padding: 20px; border-bottom: 1px solid #ddd; background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); color: white; border-radius: 12px 12px 0 0;">
        <h3 style="margin: 0; display: flex; align-items: center; gap: 10px;">
          <i class="fas fa-save"></i>
          Şablon Kaydet
        </h3>
        <p style="margin: 5px 0 0 0; opacity: 0.9; font-size: 14px;" id="sablonKaydetAciklama">Öğün şablonunuzu kaydedin</p>
      </div>

      <!-- Modal Content -->
      <div style="padding: 20px;">
        <!-- Şablon İsmi -->
        <div style="margin-bottom: 20px;">
          <label style="display: block; font-weight: bold; margin-bottom: 8px; color: #333;">
            <i class="fas fa-tag"></i> Şablon İsmi
          </label>
          <input type="text" id="sablonKaydetIsim" placeholder="Şablon ismini girin..." style="
            width: 100%; 
            padding: 12px; 
            border: 2px solid #ddd; 
            border-radius: 6px; 
            font-size: 14px;
            transition: border-color 0.3s ease;
          " onkeyup="if(event.key==='Enter') sablonKaydetOnay()">
          <small style="color: #666; font-size: 12px;" id="sablonKaydetOneri"></small>
        </div>

        <!-- Diyet Türü Seçimi -->
        <div style="margin-bottom: 20px;">
          <label style="display: block; font-weight: bold; margin-bottom: 8px; color: #333;">
            <i class="fas fa-chart-pie"></i> Diyet Türü (İsteğe Bağlı)
          </label>
          <select id="sablonKaydetDiyetTuru" style="
            width: 100%; 
            padding: 12px; 
            border: 2px solid #ddd; 
            border-radius: 6px; 
            font-size: 14px;
            background: white;
            cursor: pointer;
          ">
            <option value="">Diyet türü seçin (isteğe bağlı)</option>
          </select>
          <small style="color: #666; font-size: 12px;">Şablonunuza uygun diyet türünü seçebilirsiniz</small>
        </div>

        <!-- Hasta Bilgileri (Kaynak) -->
        <div id="sablonKaydetHastaBilgi" style="
          background: linear-gradient(135deg, #e8f5e8 0%, #f1f8e9 100%); 
          padding: 15px; 
          border-radius: 6px; 
          border-left: 4px solid #28a745;
          margin-bottom: 20px;
          display: none;
        ">
          <h4 style="margin: 0 0 10px 0; color: #155724; font-size: 14px;">
            <i class="fas fa-user-md"></i> Kaynak Hasta Bilgileri
          </h4>
          <div style="display: grid; grid-template-columns: 1fr; gap: 8px; font-size: 13px;">
            <div><strong>Hasta:</strong> <span id="sablonKaydetHastaIsim">-</span></div>
            <div><strong>Tarih Aralığı:</strong> <span id="sablonKaydetHastaTarih">-</span></div>
            <div><strong>Hafta:</strong> <span id="sablonKaydetHastaHafta">-</span></div>
            <div><strong>Gün:</strong> <span id="sablonKaydetHastaGun">-</span></div>
          </div>
          <small style="color: #155724; font-size: 11px; opacity: 0.8;">Bu şablon yukarıdaki hastanın PDF'inden oluşturulmuştur</small>
        </div>

        <!-- Şablon Özeti -->
        <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; border-left: 4px solid #007bff;">
          <h4 style="margin: 0 0 10px 0; color: #495057; font-size: 14px;">📊 Şablon Özeti</h4>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 13px;">
            <div><strong>Yemek Sayısı:</strong> <span id="sablonKaydetYemekSayisi">-</span></div>
            <div><strong>Toplam Kalori:</strong> <span id="sablonKaydetKalori">-</span> kcal</div>
            <div><strong>Öğün Tipi:</strong> <span id="sablonKaydetOgunTipi">-</span></div>
            <div><strong>Tarih:</strong> <span id="sablonKaydetTarih">-</span></div>
          </div>
        </div>
      </div>

      <!-- Modal Footer -->
      <div style="padding: 15px 20px; border-top: 1px solid #ddd; background: #f8f9fa; text-align: right; border-radius: 0 0 12px 12px;">
        <button onclick="sablonKaydetModalKapat()" style="
          background: #6c757d; 
          color: white; 
          border: none; 
          padding: 12px 24px; 
          border-radius: 6px; 
          cursor: pointer; 
          margin-right: 10px;
          font-size: 14px;
        ">❌ İptal</button>
        <button onclick="sablonKaydetOnay()" style="
          background: #28a745; 
          color: white; 
          border: none; 
          padding: 12px 24px; 
          border-radius: 6px; 
          cursor: pointer;
          font-size: 14px;
          font-weight: bold;
        ">💾 Kaydet</button>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script>
    // === GLOBAL DEĞİŞKENLER VE FONKSİYONLAR ===
    window.aktifHaftaIndex = null;
    window.diyetTurleri = []; // Diyet türleri global değişkeni
    
    // toggleAccordion fonksiyonunu global olarak tanımla
    window.toggleAccordion = function(section) {
      const sections = ['eslesen', 'eslesmeyenler', 'analiz', 'veritabaniAnalizi'];
      
      sections.forEach(s => {
        const content = document.getElementById(s + 'Content');
        const icon = document.getElementById(s + 'Icon');
        
        if (content && icon) {
          if (s === section) {
            // Seçilen bölümü aç/kapat
            const isOpen = content.style.display === 'block';
            content.style.display = isOpen ? 'none' : 'block';
            icon.textContent = isOpen ? '▶' : '▼';
          } else {
            // Diğer bölümleri kapat
            content.style.display = 'none';
            icon.textContent = '▶';
          }
        }
      });
    };
    
    // updateYemekAnalizi fonksiyonunu global olarak tanımla
    window.updateYemekAnalizi = function() {
      console.log('📊 updateYemekAnalizi fonksiyonu çağrıldı');
      
      if (!window.seciliHasta) {
        console.log('❌ Hasta seçilmemiş, analiz yapılamıyor');
        return;
      }
      
      try {
        const haftaListesi = typeof getHaftaListesi === 'function' ? getHaftaListesi() : null;
        
        if (!haftaListesi || haftaListesi.length === 0) {
          console.log('❌ Hafta verisi bulunamadı, analiz yapılamıyor');
          return;
        }
        
        console.log(`✅ Analiz verisi hazır: ${haftaListesi.length} hafta`);
        
        // Analiz grafiğini güncelle
        if (typeof generateAnalysisChart === 'function') {
          generateAnalysisChart();
        }
        
        // Sidebar güncellemelerini tetikle
        if (typeof gosterEslesenKartlarSidebar === 'function' && window.aktifHaftaIndex !== null) {
          gosterEslesenKartlarSidebar(window.aktifHaftaIndex);
        }
        
      } catch (error) {
        console.error('❌ updateYemekAnalizi hatası:', error);
      }
    };

    // === TOAST MESAJ SİSTEMİ ===
    function showToast(message, type = 'success', duration = 2500) {
      // Mevcut toast'ları temizle
      const existingToasts = document.querySelectorAll('.toast-message');
      existingToasts.forEach(toast => toast.remove());
      
      // Yeni toast oluştur
      const toast = document.createElement('div');
      toast.className = `toast-message ${type}`;
      toast.textContent = message;
      
      // Body'ye ekle
      document.body.appendChild(toast);
      
      // Belirli süre sonra kaldır
      setTimeout(() => {
        if (toast.parentNode) {
          toast.style.animation = 'slideIn 0.3s ease-out reverse';
          setTimeout(() => toast.remove(), 300);
        }
      }, duration);
    }
    
    // ⚡ ÇOKLU PDF İŞLEME FONKSİYONU (Global)
    
    // Profesyonel PDF adını parse etme
    function parseProfessionalPdfName(fileName) {
      console.log('🔍 PDF dosya adı parse ediliyor:', fileName);
      
      // .pdf uzantısını kaldır
      const cleanName = fileName.replace(/\.pdf$/i, '');
      
      // Regex pattern'ler (esnek format desteği)
      const patterns = [
        // "ESİN KARAKUŞ 28 TEMMUZ -3 AĞUSTOS 17. HAFTA"
        /^(.+?)\s+(\d{1,2})\s+([A-Za-zçÇğĞıİöÖşŞüÜ]+)\s*-\s*(\d{1,2})\s+([A-Za-zçÇğĞıİöÖşŞüÜ]+)\s+(\d+)\.\s*HAFTA/i,
        
        // "FİGEN TEZMAN 4-10 AĞUSTOS 1.HAFTA"
        /^(.+?)\s+(\d{1,2})-(\d{1,2})\s+([A-Za-zçÇğĞıİöÖşŞüÜ]+)\s+(\d+)\.?\s*HAFTA/i,
        
        // "HASTA ADI TARIH ARALIGI X. HAFTA" (genel format)
        /^(.+?)\s+(.+?)\s+(\d+)\.?\s*HAFTA/i
      ];
      
      for (const pattern of patterns) {
        const match = cleanName.match(pattern);
        if (match) {
          console.log('✅ Pattern match bulundu:', match);
          
          let sonuc = {};
          
          if (pattern === patterns[0]) {
            // "ESİN KARAKUŞ 28 TEMMUZ -3 AĞUSTOS 17. HAFTA"
            sonuc = {
              hastaAdi: match[1].trim().toUpperCase(),
              haftaNo: parseInt(match[6]),
              tarihAraligi: `${match[2]} ${match[3]} - ${match[4]} ${match[5]}`.toUpperCase(),
              baslangicGun: parseInt(match[2]),
              baslangicAy: match[3].toUpperCase(),
              bitisGun: parseInt(match[4]),
              bitisAy: match[5].toUpperCase()
            };
          } else if (pattern === patterns[1]) {
            // "FİGEN TEZMAN 4-10 AĞUSTOS 1.HAFTA"
            sonuc = {
              hastaAdi: match[1].trim().toUpperCase(),
              haftaNo: parseInt(match[5]),
              tarihAraligi: `${match[2]}-${match[3]} ${match[4]}`.toUpperCase(),
              baslangicGun: parseInt(match[2]),
              bitisGun: parseInt(match[3]),
              baslangicAy: match[4].toUpperCase(),
              bitisAy: match[4].toUpperCase() // Aynı ay
            };
            
            console.log(`🎯 PATTERN 1 MATCH - Dosya: ${fileName}`);
            console.log(`   📝 Hasta: ${sonuc.hastaAdi}`);
            console.log(`   📅 Tarih: ${match[2]}-${match[3]} ${match[4]}`);
            console.log(`   🔢 Hafta: ${sonuc.haftaNo}`);
            console.log(`   🗓️ Başlangıç: ${sonuc.baslangicGun} ${sonuc.baslangicAy}`);
            console.log(`   🗓️ Bitiş: ${sonuc.bitisGun} ${sonuc.bitisAy}`);
          } else {
            // Genel format
            sonuc = {
              hastaAdi: match[1].trim().toUpperCase(),
              haftaNo: parseInt(match[3]),
              tarihAraligi: match[2].trim().toUpperCase()
            };
          }
          
          console.log('📋 Parse sonucu:', sonuc);
          return sonuc;
        }
      }
      
      console.warn('⚠️ Hiçbir pattern uyuşmadı:', cleanName);
      return null;
    }

    // Türkçe ay adını sayıya çevir
    function turkceAyToNumber(ayAdi) {
      const aylar = {
        'OCAK': 1, 'ŞUBAT': 2, 'MART': 3, 'NİSAN': 4, 'MAYIS': 5, 'HAZİRAN': 6,
        'TEMMUZ': 7, 'AĞUSTOS': 8, 'EYLÜL': 9, 'EKİM': 10, 'KASIM': 11, 'ARALIK': 12
      };
      return aylar[ayAdi.toUpperCase()] || null;
    }

    // Parse edilen tarih bilgisini Date formatına çevir
    function parseEdilmistarihleriDateOlarak(parsedData) {
      if (!parsedData || !parsedData.baslangicGun || !parsedData.baslangicAy) {
        return null;
      }
      
      console.log('🔍 parseEdilmistarihleriDateOlarak giriş:', parsedData);
      
      const currentYear = new Date().getFullYear();
      const baslangicAyNo = turkceAyToNumber(parsedData.baslangicAy);
      const bitisAyNo = parsedData.bitisAy ? turkceAyToNumber(parsedData.bitisAy) : baslangicAyNo;
      
      if (!baslangicAyNo || !bitisAyNo) {
        console.warn('⚠️ Ay adı çevrilemedi:', parsedData.baslangicAy, parsedData.bitisAy);
        return null;
      }
      
      console.log('🔍 Tarih bileşenleri:', {
        currentYear,
        baslangicGun: parsedData.baslangicGun,
        baslangicAyNo,
        bitisGun: parsedData.bitisGun,
        bitisAyNo
      });
      
      // ⚡ TİMEZONE FİX: Direkt string formatında oluştur, Date objesi kullanma!
      const baslangicDateStr = `${currentYear}-${baslangicAyNo.toString().padStart(2, '0')}-${parsedData.baslangicGun.toString().padStart(2, '0')}`;
      const bitisDateStr = `${currentYear}-${bitisAyNo.toString().padStart(2, '0')}-${(parsedData.bitisGun || parsedData.baslangicGun).toString().padStart(2, '0')}`;
      
      console.log('🔍 Oluşturulan tarih stringleri:', {
        baslangicDateStr,
        bitisDateStr
      });
      
      // Gün sayısını hesapla (Date objesi sadece hesaplama için)
      const baslangicDate = new Date(currentYear, baslangicAyNo - 1, parsedData.baslangicGun);
      const bitisDate = new Date(currentYear, bitisAyNo - 1, parsedData.bitisGun || parsedData.baslangicGun);
      
      // Bitiş tarihi başlangıçtan küçükse, sonraki yıla geç
      if (bitisDate < baslangicDate) {
        bitisDate.setFullYear(currentYear + 1);
      }
      
      const gunSayisi = Math.ceil((bitisDate - baslangicDate) / (1000 * 60 * 60 * 24)) + 1;
      
      const result = {
        baslangic: baslangicDateStr,
        bitis: bitisDateStr,
        gunSayisi: gunSayisi
      };
      
      console.log('✅ parseEdilmistarihleriDateOlarak sonuç:', result);
      return result;
    }

    // PDF'den gelen tarih aralığına göre tab bilgilerini güncelle
    function updateTabInfoFromPdf(haftaIndex, parsedPdf, parsedTarihler) {
      if (!parsedTarihler || !parsedTarihler.gunSayisi) return;
      
      const haftalar = getHaftaListesi();
      const hafta = haftalar[haftaIndex];
      
      console.log(`🎯 PDF TAB GÜNCELLEME - Hafta ${haftaIndex + 1}`);
      console.log(`📅 PDF'den gelen tarihler:`, parsedTarihler);
      console.log(`📅 Önceki hafta tarihleri:`, {
        baslangic: hafta.baslangic,
        bitis: hafta.bitis
      });
      
      // ⚡ ÖNEMLİ: Hafta tarihlerini PDF'den gelen tarihlerle güncelle
      hafta.baslangic = parsedTarihler.baslangic;
      hafta.bitis = parsedTarihler.bitis;
      
      console.log(`✅ Hafta tarihleri PDF'den güncellendi:`, {
        yeniBaslangic: hafta.baslangic,
        yeniBitis: hafta.bitis
      });
      
      // Tarih aralığı 7 günden fazla ise özel format kullan
      if (parsedTarihler.gunSayisi > 7) {
        console.log(`📅 PDF tarih aralığı ${parsedTarihler.gunSayisi} gün - Tab adı güncelleniyor`);
        
        // Tab adı için özel format: "1. Hafta\n08/13 - 08/24"
        hafta.ozelTabFormat = true;
        hafta.tabBaslik = `${hafta.haftaNo || (haftaIndex + 1)}. Hafta`;
        
        // Tarih formatını oluştur - ISO string'den direkt parse etmeye dikkat!
        // Zaman dilimi sorununu önlemek için direkt split kullanıyoruz
        const basDateParts = parsedTarihler.baslangic.split('-'); // [2025, 08, 13]
        const bitDateParts = parsedTarihler.bitis.split('-'); // [2025, 08, 24]
        
        hafta.tabTarih = `${basDateParts[1]}/${basDateParts[2]} - ${bitDateParts[1]}/${bitDateParts[2]}`;
        
        console.log(`✅ Tab bilgileri güncellendi: ${hafta.tabBaslik} - ${hafta.tabTarih}`);
      } else {
        // Normal format kullan
        hafta.ozelTabFormat = false;
        delete hafta.tabBaslik;
        delete hafta.tabTarih;
        console.log(`📅 Normal tab formatı kullanılıyor (${parsedTarihler.gunSayisi} gün)`);
      }
      
      // localStorage'a kaydet
      saveToStorage();
      
      console.log(`💾 Hafta bilgileri localStorage'a kaydedildi`);
    }

    // Dosyayı Base64'e çevirme
    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => {
          const base64 = reader.result.split(',')[1]; // Data URL prefix'ini kaldır
          resolve(base64);
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    // Tarih aralığını parse etme
    function parseTarihAraligi(tarihAraligi) {
      console.log('📅 Tarih aralığı parse ediliyor:', tarihAraligi);
      
      const bugun = new Date();
      const yil = bugun.getFullYear();
      
      // "28 TEMMUZ - 3 AĞUSTOS" formatını parse et
      const aylar = {
        'OCAK': '01', 'ŞUBAT': '02', 'MART': '03', 'NİSAN': '04',
        'MAYIS': '05', 'HAZİRAN': '06', 'TEMMUZ': '07', 'AĞUSTOS': '08',
        'EYLÜL': '09', 'EKİM': '10', 'KASIM': '11', 'ARALIK': '12'
      };
      
      try {
        // Format 1: "28 TEMMUZ - 3 AĞUSTOS"
        if (tarihAraligi.includes(' - ')) {
          const parts = tarihAraligi.split(' - ');
          if (parts.length >= 2) {
            const baslangicParts = parts[0].trim().split(' ');
            const bitisParts = parts[1].trim().split(' ');
            
            const baslangicGun = baslangicParts[0].padStart(2, '0');
            const baslangicAy = aylar[baslangicParts[1]] || '01';
            
            const bitisGun = bitisParts[0].padStart(2, '0');
            const bitisAy = aylar[bitisParts[1]] || '01';
            
            const sonuc = {
              baslangic: `${yil}-${baslangicAy}-${baslangicGun}`,
              bitis: `${yil}-${bitisAy}-${bitisGun}`
            };
            
            console.log('✅ Tarih parse başarılı (Format 1):', sonuc);
            return sonuc;
          }
        }
        
        // Format 2: "4-10 AĞUSTOS" (aynı ay içinde)
        const ayiciMatch = tarihAraligi.match(/^(\d{1,2})-(\d{1,2})\s+([A-Za-zÇĞIİÖŞÜçğıöşü]+)$/i);
        if (ayiciMatch) {
          const baslangicGun = ayiciMatch[1].padStart(2, '0');
          const bitisGun = ayiciMatch[2].padStart(2, '0');
          const ayAdi = ayiciMatch[3].toUpperCase();
          const ay = aylar[ayAdi] || '01';
          
          const sonuc = {
            baslangic: `${yil}-${ay}-${baslangicGun}`,
            bitis: `${yil}-${ay}-${bitisGun}`
          };
          
          console.log('✅ Tarih parse başarılı (Format 2):', sonuc);
          return sonuc;
        }
        
        console.log('⚠️ Tarih formatı tanınmadı, pattern denemesi yapılıyor...');
        
      } catch (error) {
        console.warn('❌ Tarih parse hatası:', error);
      }
      
      // Fallback
      const fallback = {
        baslangic: bugun.toISOString().split('T')[0],
        bitis: bugun.toISOString().split('T')[0]
      };
      
      console.log('⚠️ Fallback tarih kullanılıyor:', fallback);
      return fallback;
    }

    // Hasta bulma/oluşturma (GitHub entegrasyonlu)
    // Çoklu PDF işlemi için hasta cache'i
    const cokluPdfHastaCache = new Map();

    async function findOrCreateHastaWithGitHub(hastaAdi) {
      console.log('👤 Hasta aranıyor/oluşturuluyor:', hastaAdi);
      
      // Cache'de var mı kontrol et (çoklu PDF işlemi için)
      const cacheKey = hastaAdi.toUpperCase();
      if (cokluPdfHastaCache.has(cacheKey)) {
        const cachedHasta = cokluPdfHastaCache.get(cacheKey);
        console.log('🚨 CACHE\'DEN HASTA ALINDI:', hastaAdi);
        console.log('🔍 Cache hafta sayısı:', cachedHasta.haftalar ? cachedHasta.haftalar.length : 0);
        console.log('🔍 Cache hafta detayları:', cachedHasta.haftalar ? cachedHasta.haftalar.map(h => ({ haftaNo: h.haftaNo, baslangic: h.baslangic, bitis: h.bitis })) : []);
        return cachedHasta;
      }
      
      // DÜZELTME: Global hastalar dizisini kullan (localStorage'dan her defasında yükleme!)
      // let hastalar = JSON.parse(localStorage.getItem('lipedem_hasta_kayitlari') || '[]');
      
      // Mevcut hastayı ara (global hastalar dizisinde)
      let hasta = hastalar.find(h => 
        (h.ad && h.ad.toUpperCase() === hastaAdi.toUpperCase()) || 
        (h.isim && h.isim.toUpperCase() === hastaAdi.toUpperCase())
      );
      
      if (!hasta) {
        // Yeni hasta oluştur (manuel kayıt formatına uygun)
        const hastaId = generatePatientId(hastaAdi);
        hasta = {
          id: hastaId,
          isim: hastaAdi,
          ad: hastaAdi, // backward compatibility
          not: "",
          arsiv: false,
          kayitTarihi: new Date().toISOString(),
          haftalar: [],
          durumu: 'aktif',
          olusturmaTarihi: new Date().toISOString(),
          yeniSistem: true
        };
        hastalar.push(hasta);
        console.log('✅ Yeni hasta oluşturuldu:', hastaAdi);
        
        // GitHub'a hasta listesi kaydet
        const token = document.getElementById('githubToken').value.trim();
        if (token) {
          try {
            // Hasta listesini GitHub'a kaydet
            const hastaListesi = await hastaListesiYukle() || [];
            const yeniHastaListesi = {
              id: hastaId,
              isim: hastaAdi,
              kayitTarihi: new Date().toISOString(),
              durumu: 'aktif'
            };
            
            // Aynı hasta yoksa ekle
            if (!hastaListesi.find(h => h.id === hastaId)) {
              hastaListesi.push(yeniHastaListesi);
              await hastaListesiKaydet(hastaListesi);
              console.log('✅ Hasta listesi GitHub\'a güncellendi');
            }
            
            // Hasta verisini GitHub'a kaydet
            await hastayiAyriKaydet(hasta);
            console.log('✅ Hasta verisi GitHub\'a kaydedildi');
            
          } catch (error) {
            console.error('⚠️ GitHub kaydetme hatası:', error);
          }
        }
      } else {
        console.log('✅ Mevcut hasta bulundu:', hastaAdi, 'Hafta sayısı:', hasta.haftalar ? hasta.haftalar.length : 0);
      }
      
      // Cache'e ekle (çoklu PDF işlemi için)
      cokluPdfHastaCache.set(cacheKey, hasta);
      
      // DÜZELTME: Manuel sistemle aynı şekilde saveToStorage() kullan
      saveToStorage();
      
      return hasta;
    }

    // Hafta bulma/oluşturma (GitHub güncellemeli)
    async function findOrCreateHaftaWithGitHub(hasta, haftaNo, tarihAraligi) {
      console.log('📅 Hafta aranıyor/oluşturuluyor:', haftaNo, tarihAraligi);
      
      if (!hasta.haftalar) hasta.haftalar = [];
      
      // Mevcut haftayı ara (hafta numarasına göre)
      let hafta = hasta.haftalar.find(h => h.haftaNo === haftaNo);
      
      if (!hafta) {
        // Tarihleri parse et
        const tarihBilgisi = parseTarihAraligi(tarihAraligi);
        
        console.log(`✨ ${haftaNo}. hafta oluşturuluyor, mevcut hafta sayısı: ${hasta.haftalar.length}`);
        console.log('📅 Hafta için hesaplanan tarihler:', tarihBilgisi);
        
        // Yeni hafta oluştur (manuel kayıt formatına uygun)
        hafta = {
          haftaNo: haftaNo,
          baslangic: tarihBilgisi.baslangic,
          bitis: tarihBilgisi.bitis,
          aciklama: "",
          pdf: null,
          pdfName: null,
          pdfOrijinalIsim: null,
          pdfYolu: null,
          githubUrl: null,
          indirmeUrl: null,
          kayitTarihi: new Date().toISOString(),
          tarifKartlar: [],
          tarifler: [],
          gptMesaj: "",
          pdfFile: {}
        };
        hasta.haftalar.push(hafta);
        console.log(`✅ ${hasta.isim || hasta.ad} için ${haftaNo}. hafta oluşturuldu (${tarihAraligi})`);
        console.log('📋 Oluşturulan hafta detayı:', { haftaNo: hafta.haftaNo, baslangic: hafta.baslangic, bitis: hafta.bitis });
        
        // GitHub'a güncellenmiş hasta verisini kaydet
        const token = document.getElementById('githubToken').value.trim();
        if (token) {
          try {
            await hastayiAyriKaydet(hasta);
            console.log(`✅ ${hasta.isim || hasta.ad} hafta verisi GitHub'a güncellendi`);
          } catch (error) {
            console.error('⚠️ Hafta GitHub kaydetme hatası:', error);
          }
        }
        
        // Cache'i de güncelle (çoklu PDF işlemi için)
        if (typeof cokluPdfHastaCache !== 'undefined') {
          const cacheKey = (hasta.isim || hasta.ad).toUpperCase();
          cokluPdfHastaCache.set(cacheKey, hasta);
          console.log(`🔄 Cache güncellendi: ${hasta.isim || hasta.ad} - Hafta sayısı: ${hasta.haftalar.length}`);
        }
        
        // DÜZELTME: Manuel sistemle aynı şekilde saveToStorage() kullan
        saveToStorage();
      } else {
        console.log(`✅ ${hasta.isim || hasta.ad} için ${haftaNo}. hafta zaten mevcut`);
      }
      
      return hafta;
    }

    async function processCokluPdf(files) {
      if (!files || files.length === 0) {
        alert('Lütfen en az bir PDF dosyası seçin.');
        return;
      }

      console.log('📁 Çoklu PDF işlemi başlatıldı:', files.length, 'dosya');
      
      const sonuclar = [];
      let basarili = 0;
      let hatali = 0;

      // Progress gösterimi
      const progressDiv = document.createElement('div');
      progressDiv.style.cssText = `
        position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
        background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        z-index: 10000; min-width: 300px; text-align: center;
      `;
      progressDiv.innerHTML = `
        <h3>📁 PDF'ler İşleniyor...</h3>
        <div id="progressBar" style="width: 100%; height: 20px; background: #f0f0f0; border-radius: 10px; overflow: hidden; margin: 10px 0;">
          <div id="progressFill" style="width: 0%; height: 100%; background: linear-gradient(45deg, #667eea, #764ba2); transition: width 0.3s;"></div>
        </div>
        <div id="progressText">0 / ${files.length}</div>
      `;
      document.body.appendChild(progressDiv);

      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        const progress = ((i + 1) / files.length) * 100;
        
        // Progress güncelle
        document.getElementById('progressFill').style.width = progress + '%';
        document.getElementById('progressText').textContent = `${i + 1} / ${files.length}`;
        
        try {
          console.log(`🔍 ${i + 1}/${files.length} - "${file.name}" analiz ediliyor...`);
          
          // Dosya adını parse et
          const parsed = parseProfessionalPdfName(file.name);
          
          if (!parsed) {
            console.warn('⚠️ Dosya adı format hatası:', file.name);
            sonuclar.push({ dosya: file.name, durum: 'HATA', mesaj: 'Dosya adı formatı tanınmadı' });
            hatali++;
            continue;
          }

          // Hasta oluştur/bul (GitHub entegrasyonlu)
          const hasta = await findOrCreateHastaWithGitHub(parsed.hastaAdi);
          
          // Hafta oluştur/bul (GitHub güncellemeli)
          const hafta = await findOrCreateHaftaWithGitHub(hasta, parsed.haftaNo, parsed.tarihAraligi);
          
          // PDF dosyasını işle
          try {
            // PDF'i GitHub'a yükle (manuel sistemle aynı)
            console.log(`📤 ${file.name} GitHub'a yükleniyor...`);
            const pdfSonuc = await pdfYukleGithub(file, hasta.id, hafta.haftaNo);
            
            if (!pdfSonuc) {
              console.error(`❌ ${file.name} yükleme başarısız`);
              sonuclar.push({ dosya: file.name, durum: 'HATA', mesaj: 'PDF yükleme başarısız' });
              hatali++;
              continue;
            }
            
            // Manuel sistemle aynı şekilde yol referansı kaydet (Base64 değil!)
            hafta.pdfOrijinalIsim = pdfSonuc.orijinalAd;
            hafta.pdfName = pdfSonuc.guvenliAd;
            hafta.pdfYolu = pdfSonuc.dosyaYolu;
            hafta.githubUrl = pdfSonuc.githubUrl;
            hafta.indirmeUrl = pdfSonuc.indirmeUrl;
            hafta.kayitTarihi = new Date().toISOString();
            
            // Tab bilgilerini güncelle (7 günden uzun aralık varsa özel format)
            if (parsed.baslangicGun && parsed.baslangicAy) {
              const parsedTarihler = parseEdilmistarihleriDateOlarak(parsed);
              if (parsedTarihler && parsedTarihler.gunSayisi > 7) {
                console.log(`📅 Çoklu PDF - uzun tarih aralığı tespit edildi: ${parsedTarihler.gunSayisi} gün`);
                hafta.ozelTabFormat = true;
                hafta.tabBaslik = `${hafta.haftaNo}. Hafta`;
                
                // Zaman dilimi sorununu önlemek için direkt split kullanıyoruz
                const basDateParts = parsedTarihler.baslangic.split('-');
                const bitDateParts = parsedTarihler.bitis.split('-');
                hafta.tabTarih = `${basDateParts[1]}/${basDateParts[2]} - ${bitDateParts[1]}/${bitDateParts[2]}`;
              }
            }
            
            // PDF analizi için geçici Base64 oluştur (JSON'a kaydetmiyoruz!)
            const pdfBase64 = await fileToBase64(file);
            hafta.pdfFile = file; // Geçici analiz için File objesi
            
            // PDF'den metin çıkar ve tarif analizi yap
            try {
              console.log(`🔍 ${file.name} PDF içerik analizi başlıyor...`);
              
              // Base64'den PDF metnini çıkar
              let base64Data = pdfBase64;
              if (base64Data.includes(',')) {
                base64Data = base64Data.split(',')[1];
              }
              
              // Base64 verisini temizle ve doğrula
              base64Data = base64Data.replace(/[^A-Za-z0-9+/=]/g, '');
              
              if (!base64Data || base64Data.length === 0) {
                console.warn(`⚠️ ${file.name} için geçersiz Base64 verisi`);
                hafta.tarifler = [];
                hafta.tarifKartlar = [];
                throw new Error('Geçersiz PDF Base64 verisi');
              }
              
              console.log(`📄 Base64 veri uzunluğu: ${base64Data.length} karakter`);
              
              const binaryString = atob(base64Data);
              const bytes = new Uint8Array(binaryString.length);
              for (let i = 0; i < binaryString.length; i++) {
                bytes[i] = binaryString.charCodeAt(i);
              }
              
              const pdf = await pdfjsLib.getDocument({ data: bytes }).promise;
              let fullText = '';
              
              console.log(`📖 PDF toplam sayfa sayısı: ${pdf.numPages}`);
              
              // Manuel sistemle AYNI şekilde metin çıkarma
              for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                console.log(`📄 Sayfa ${pageNum}/${pdf.numPages} işleniyor...`);
                const page = await pdf.getPage(pageNum);
                const textContent = await page.getTextContent();
                const strings = textContent.items.map(item => item.str);
                const pageText = strings.join('\n') + '\n';
                
                console.log(`📄 Sayfa ${pageNum} metin uzunluğu: ${pageText.length} karakter`);
                console.log(`📄 Sayfa ${pageNum} ilk 200 karakter:`, pageText.substring(0, 200));
                
                // Tavuk içeren satırları özel kontrol et
                if (pageText.toLowerCase().includes('tavuk')) {
                  console.log(`🐔 Sayfa ${pageNum}'da TAVUK bulundu!`);
                  const tavukSatirlari = pageText.split('\n').filter(line => line.toLowerCase().includes('tavuk'));
                  console.log(`🐔 Sayfa ${pageNum} tavuk satırları:`, tavukSatirlari);
                }
                
                // Pirzola içeren satırları özel kontrol et
                if (pageText.toLowerCase().includes('pirzola')) {
                  console.log(`🥩 Sayfa ${pageNum}'da PIRZOLA bulundu!`);
                  const pirzolaSatirlari = pageText.split('\n').filter(line => line.toLowerCase().includes('pirzola'));
                  console.log(`🥩 Sayfa ${pageNum} pirzola satırları:`, pirzolaSatirlari);
                }
                
                // 150 gr içeren satırları özel kontrol et
                if (pageText.includes('150') && pageText.toLowerCase().includes('gr')) {
                  console.log(`⚖️ Sayfa ${pageNum}'da 150 gr bulundu!`);
                  const miktarSatirlari = pageText.split('\n').filter(line => line.includes('150') && line.toLowerCase().includes('gr'));
                  console.log(`⚖️ Sayfa ${pageNum} 150 gr satırları:`, miktarSatirlari);
                }
                
                fullText += pageText; // Manuel sistemle aynı: '\n' kullan!
              }
              
              console.log(`📄 PDF metni çıkarıldı: ${fullText.length} karakter`);
              console.log(`📄 PDF tam metni (ilk 500 karakter):`, fullText.substring(0, 500));
              
              // Ham metinde aradığımız satırları kontrol et
              console.log(`🔍 Ham metinde 'tavuk' var mı?`, fullText.toLowerCase().includes('tavuk'));
              console.log(`🔍 Ham metinde 'pirzola' var mı?`, fullText.toLowerCase().includes('pirzola'));
              console.log(`🔍 Ham metinde '150' var mı?`, fullText.includes('150'));
              
              // Tarif detaylarını çıkar
              const tarifDetaylar = extractTariflerDetay(fullText);
              hafta.tarifler = tarifDetaylar;
              console.log(`🍽️ ${tarifDetaylar.length} tarif detayı bulundu`);
              
              // Manuel sistemle AYNI şekilde eşleştirme yap
              if (window.tarifKartlari && window.tarifKartlari.length > 0 && tarifDetaylar.length > 0) {
                console.log(`🔗 ${file.name} için tarif eşleştirmesi başlıyor (manuel sistem gibi)...`);
                
                // Global değişkenleri geçici güncelle (manuel sistem için gerekli)
                const tempSeciliHasta = seciliHasta;
                const tempHastalar = window.hastalar ? [...window.hastalar] : [];
                
                // Hasta listesini güncelle
                if (!window.hastalar) window.hastalar = [];
                let hastaIndex = window.hastalar.findIndex(h => h.id === hasta.id);
                if (hastaIndex === -1) {
                  window.hastalar.push(hasta);
                  hastaIndex = window.hastalar.length - 1;
                } else {
                  window.hastalar[hastaIndex] = hasta;
                }
                
                // seciliHasta'yı geçici olarak güncelle
                seciliHasta = hasta;
                
                // Manuel sistemle AYNI şekilde hafta localStorage güncellemesi
                const haftaIndex = hasta.haftalar.findIndex(h => h.haftaNo === hafta.haftaNo);
                if (haftaIndex >= 0) {
                  // Manuel sistemle AYNI: önce tarifler güncelle
                  hasta.haftalar[haftaIndex].tarifler = tarifDetaylar;
                  
                  try {
                    // Manuel sistemle AYNI otomatik eşleştirme fonksiyonunu kullan
                    const eslestirmeSonucu = await otomatikEsleHafta(haftaIndex);
                    
                    if (eslestirmeSonucu) {
                      console.log('✅ Eşleştirme sonuçları hafta verilerine kaydediliyor...');
                      hafta.tarifKartlar = eslestirmeSonucu.eslesenKartlar || [];
                      console.log('📝 JSON\'a kaydedilecek eşleşen kart sayısı:', eslestirmeSonucu.eslesenKartlar?.length || 0);
                      
                      // Manuel sistemle AYNI şekilde hasta verilerini güncelle
                      seciliHasta.haftalar[haftaIndex].tarifKartlar = hafta.tarifKartlar || [];
                      
                      // Mevcut JSON'da eslesmeyenTarifler varsa sil (manuel sistemle aynı)
                      if (seciliHasta.haftalar[haftaIndex].eslesmeyenTarifler) {
                        delete seciliHasta.haftalar[haftaIndex].eslesmeyenTarifler;
                        console.log('🧹 Eski eslesmeyenTarifler verisi JSON\'dan temizlendi');
                      }
                      
                      // Manuel sistemle AYNI şekilde GitHub'a kaydet
                      await hastayiAyriKaydet(seciliHasta);
                      console.log('📝 Eşleştirme sonrası GitHub\'a kaydedildi (manuel sistem gibi)');
                    }
                    
                    console.log(`✅ Manuel sistem uyumlu eşleştirme tamamlandı: ${hafta.tarifKartlar.length} eşleşme bulundu`);
                  } catch (eslesmeError) {
                    console.warn('⚠️ Eşleştirme hatası:', eslesmeError);
                    hafta.tarifKartlar = [];
                  }
                }
                
                // Global değişkenleri geri yükle
                seciliHasta = tempSeciliHasta;
                window.hastalar = tempHastalar;
                
              } else {
                console.warn('⚠️ Tarif kartları yüklenmemiş veya tarif bulunamadı, eşleştirme atlanıyor');
                hafta.tarifKartlar = [];
              }
              
            } catch (pdfAnalysisError) {
              console.error('❌ PDF analiz hatası:', pdfAnalysisError);
              hafta.tarifler = [];
              hafta.tarifKartlar = [];
            }
            
            // Geçici pdfFile'ı temizle (manuel sistemle aynı)
            if (hafta.pdfFile) {
              delete hafta.pdfFile;
            }
            
            // Güncellenmiş hasta verisini kaydet
            console.log(`🔍 DEBUG: ${file.name} - Hasta kaydedilmeden önce hafta.tarifKartlar:`, hafta.tarifKartlar);
            console.log(`🔍 DEBUG: ${file.name} - Hasta kaydedilmeden önce hafta.tarifler:`, hafta.tarifler);
            console.log(`🔍 DEBUG: ${file.name} - Final hafta verisi (Base64 olmadan):`, JSON.stringify(hafta, null, 2));
            await hastayiAyriKaydet(hasta);
            
            // Manuel sistemle AYNI şekilde localStorage da güncelle
            saveToStorage();
            
          } catch (pdfError) {
            console.warn('⚠️ PDF işleme hatası:', pdfError);
            // PDF hatası olsa bile hasta/hafta kaydını tamamla
          }
          
          sonuclar.push({ 
            dosya: file.name, 
            durum: 'BAŞARILI', 
            hasta: parsed.hastaAdi,
            hafta: parsed.haftaNo,
            tarihAraligi: parsed.tarihAraligi,
            tarifSayisi: hafta.tarifler ? hafta.tarifler.length : 0,
            eslesmeSayisi: hafta.tarifKartlar ? hafta.tarifKartlar.length : 0,
            mesaj: `${hafta.tarifler ? hafta.tarifler.length : 0} tarif, ${hafta.tarifKartlar ? hafta.tarifKartlar.length : 0} eşleşme`
          });
          basarili++;
          
          console.log(`✅ ${file.name} başarıyla işlendi`);
          
        } catch (error) {
          console.error('❌ PDF işleme hatası:', file.name, error);
          sonuclar.push({ dosya: file.name, durum: 'HATA', mesaj: error.message });
          hatali++;
        }
        
        // Küçük bir delay (UI donmaması için)
        await new Promise(resolve => setTimeout(resolve, 100));
      }

      // Progress dialog'u kapat
      document.body.removeChild(progressDiv);
      
      // GitHub'dan hasta listesini yeniden yükle ve UI'ı güncelle
      if (basarili > 0) {
        try {
          console.log('🔄 Çoklu PDF işlemi sonrası sistem güncelleniyor...');
          
          // Cache'i temizle (yeni veriler için)
          try {
            const cacheKeys = Object.keys(localStorage).filter(key => key.startsWith('hasta_'));
            cacheKeys.forEach(key => localStorage.removeItem(key));
            console.log('✅ Cache temizlendi');
          } catch (cacheError) {
            console.warn('⚠️ Cache temizleme hatası:', cacheError);
          }
          
          // Hasta listesini yeniden yükle
          if (typeof loadHastaDataFromGitHub === 'function') {
            await loadHastaDataFromGitHub(true); // sessiz mod
            console.log('✅ Hasta listesi GitHub\'dan yeniden yüklendi');
          }
          
          // UI'ı güncelle
          if (typeof updateHastaListesi === 'function') {
            updateHastaListesi();
            console.log('✅ Hasta listesi UI güncellendi');
          } else {
            console.warn('⚠️ updateHastaListesi fonksiyonu bulunamadı');
          }
          
          // Ana sistem UI'ını güncelle
          if (typeof renderYeniSistem === 'function') {
            renderYeniSistem();
            console.log('✅ Ana sistem UI güncellendi');
          }
          
        } catch (error) {
          console.warn('⚠️ Sistem güncelleme hatası:', error);
        }
      }
      
      // Sonuç raporu göster
      let raporHtml = `
        <div style="max-height: 400px; overflow-y: auto;">
          <h3>📊 İşlem Raporu</h3>
          <p><strong>Toplam:</strong> ${files.length} dosya</p>
          <p><strong>Başarılı:</strong> ${basarili}</p>
          <p><strong>Hatalı:</strong> ${hatali}</p>
          <hr>
          <h4>Detaylar:</h4>
      `;
      
      sonuclar.forEach(sonuc => {
        const ikon = sonuc.durum === 'BAŞARILI' ? '✅' : '❌';
        raporHtml += `<p>${ikon} <strong>${sonuc.dosya}</strong>`;
        if (sonuc.hasta) {
          raporHtml += ` → ${sonuc.hasta} (${sonuc.hafta}. hafta)`;
          if (sonuc.tarifSayisi !== undefined) raporHtml += ` - ${sonuc.tarifSayisi} tarif`;
          if (sonuc.eslesmeSayisi !== undefined) raporHtml += `, ${sonuc.eslesmeSayisi} eşleşme`;
        }
        if (sonuc.mesaj && sonuc.durum === 'HATA') raporHtml += ` - ${sonuc.mesaj}`;
        raporHtml += `</p>`;
      });
      
      raporHtml += '</div>';
      
      // Modal dialog oluştur
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
        background: rgba(0,0,0,0.5); z-index: 10000; 
        display: flex; align-items: center; justify-content: center;
      `;
      modal.innerHTML = `
        <div style="background: white; padding: 20px; border-radius: 8px; max-width: 600px; width: 90%;">
          ${raporHtml}
          <button onclick="this.closest('div').parentElement.remove()" 
                  style="margin-top: 15px; padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
            Tamam
          </button>
        </div>
      `;
      document.body.appendChild(modal);
      
      console.log('🎉 Çoklu PDF işlemi tamamlandı! Başarılı:', basarili, 'Hatalı:', hatali);
      
      // Otomatik kaydetme - çoklu PDF işlemi tamamlandı (Cache temizlenmeden önce!)
      if (basarili > 0 && typeof cokluPdfHastaCache !== 'undefined') {
        console.log('💾 Çoklu PDF işlemi başarılı, tüm hasta verileri otomatik kaydediliyor...');
        
        // Cache'deki tüm hastaları global hastalar dizisine ekle/güncelle
        for (const [key, hasta] of cokluPdfHastaCache.entries()) {
          autoSaveHastaData(hasta);
        }
      }
      
      // Cache'i temizle
      if (typeof cokluPdfHastaCache !== 'undefined') {
        console.log('🧹 Cache temizleniyor... Önceki boyut:', cokluPdfHastaCache.size);
        cokluPdfHastaCache.clear();
      }
      
      // Final kaydetme: Tüm değişiklikleri kesin olarak kaydet
      saveToStorage();
      console.log('💾 Çoklu PDF işlemi sonrası final kaydetme tamamlandı');
      
      // Yemek analizini güncelle (çoklu PDF işlemi sonrası)
      if (basarili > 0) {
        console.log('📊 Çoklu PDF işlemi sonrası yemek analizi güncelleniyor...');
        setTimeout(() => {
          updateYemekAnalizi();
        }, 1000); // Veriler tamamen yüklenmesi için 1 saniye bekle
      }
    }

    // UTF-8 Base64 decode yardımcı fonksiyonu (Türkçe karakterler için)
    function decodeBase64UTF8(base64Content) {
      try {
        // Modern tarayıcılarda TextDecoder kullan
        const bytes = Uint8Array.from(atob(base64Content), c => c.charCodeAt(0));
        const decoded = new TextDecoder('utf-8').decode(bytes);
        
        // 🕵️ DEBUG: Encoding karşılaştırması (sadece önemli farklar için log)
        const simpleDecoded = atob(base64Content);
        if (decoded !== simpleDecoded && decoded.includes('İ') || decoded.includes('Ğ') || decoded.includes('Ü')) {
          console.log('� UTF-8 decode kullanıldı (Türkçe karakter tespit edildi)');
        }
        
        return decoded;
      } catch (decodeError) {
        // Fallback: Normal atob kullan
        console.warn('UTF-8 decode başarısız, normal decode deneniyor:', decodeError);
        return atob(base64Content);
      }
    }
    
    // UTF-8 encoding için yardımcı fonksiyon
    function encodeUTF8ToBase64(jsonData) {
      try {
        const jsonString = JSON.stringify(jsonData, null, 2);
        const encoder = new TextEncoder();
        const utf8Bytes = encoder.encode(jsonString);
        
        // Büyük veri setleri için chunk'lara bölerek işle
        let binaryString = '';
        const chunkSize = 8192; // 8KB chunks
        for (let i = 0; i < utf8Bytes.length; i += chunkSize) {
          const chunk = utf8Bytes.slice(i, i + chunkSize);
          binaryString += String.fromCharCode.apply(null, chunk);
        }
        return btoa(binaryString);
      } catch (error) {
        console.warn('UTF-8 encode başarısız, fallback kullanılıyor:', error);
        // Fallback: Eski yöntem
        return btoa(unescape(encodeURIComponent(JSON.stringify(jsonData, null, 2))));
      }
    }
    
    // Base64'ü blob'a çevir
    function base64ToBlob(base64Content, mimeType = 'application/octet-stream') {
      try {
        // Base64 string'den yeni satırları temizle
        const cleanedBase64 = base64Content.replace(/\s/g, '');
        const byteCharacters = atob(cleanedBase64);
        const byteNumbers = new Array(byteCharacters.length);
        
        for (let i = 0; i < byteCharacters.length; i++) {
          byteNumbers[i] = byteCharacters.charCodeAt(i);
        }
        
        const byteArray = new Uint8Array(byteNumbers);
        return new Blob([byteArray], { type: mimeType });
      } catch (error) {
        console.error('Base64 to blob conversion error:', error);
        throw new Error('Base64 dosya dönüştürme hatası');
      }
    }
    
    // Hasta verisini GitHub'dan al (Yeni Sistem Uyumlu)
    async function getHastaData(hastaId, githubRepo = null, githubToken = null, hastaIsim = null) {
      try {
        // Parametrelerden veya global değişkenlerden al
        const repo = githubRepo || (typeof GITHUB_REPO !== 'undefined' ? GITHUB_REPO : null);
        const token = githubToken || (typeof GITHUB_TOKEN !== 'undefined' ? GITHUB_TOKEN : null);
        
        if (!repo || !token) {
          throw new Error('GitHub repo veya token eksik');
        }
        
        // Yeni sistem: hasta_ID_ISIM.json formatında dosya ara
        const dosyaAdlari = [];
        
        if (hastaIsim) {
          dosyaAdlari.push(generateFileName({ id: hastaId, isim: hastaIsim }));
          dosyaAdlari.push(generateFileName({ id: hastaId, isim: turkceKarakterDuzelt(hastaIsim) }));
          dosyaAdlari.push(generateFileName({ isim: hastaIsim }));
          dosyaAdlari.push(generateFileName({ isim: turkceKarakterDuzelt(hastaIsim) }));
        }
        
        // Çift entryleri kaldır
        const benzersizDosyaAdlari = [...new Set(dosyaAdlari)];
        
        console.log('🔍 Hasta verisi aranan dosyalar:', benzersizDosyaAdlari);
        
        // Her dosya adını dene
        for (const dosyaAdi of benzersizDosyaAdlari) {
          try {
            const response = await fetch(`https://api.github.com/repos/${repo}/contents/patients/${dosyaAdi}`, {
              headers: {
                'Authorization': `token ${token}`
              }
            });
            
            if (response.ok) {
              const data = await response.json();
              const content = decodeBase64UTF8(data.content);
              console.log(`✅ Hasta verisi bulundu: ${dosyaAdi}`);
              return JSON.parse(content);
            }
          } catch (e) {
            console.log(`❌ Dosya bulunamadı: ${dosyaAdi}`);
          }
        }
        
        // Eski sistem de deneyelim (backward compatibility)
        try {
          const response = await fetch(`https://api.github.com/repos/${repo}/contents/patients/${hastaId}/hasta_data.json`, {
            headers: {
              'Authorization': `token ${token}`
            }
          });
          
          if (response.ok) {
            const data = await response.json();
            const content = decodeBase64UTF8(data.content);
            console.log(`✅ Hasta verisi eski sistemde bulundu: ${hastaId}/hasta_data.json`);
            return JSON.parse(content);
          }
        } catch (e) {
          console.log(`❌ Eski sistem de bulunamadı: ${hastaId}/hasta_data.json`);
        }
        
        throw new Error('Hasta verisi bulunamadı');
      } catch (error) {
        console.error('Hasta verisi alma hatası:', error);
        throw error;
      }
    }
    
    // --- GitHub'a JSON dosyası kaydetme fonksiyonu ---
    // Global değişkenler
    let seciliHasta = null;
    
    // Eşleşmeyenler listesini güncelle - manuel eşleştirme sonrası
    function eslesmeyenlerListesiniGuncelle() {
      const eslesmeyenlerContent = document.getElementById('eslesmeyenlerContent');
      const eslesmeyenlerBaslik = document.getElementById('eslesmeyenlerBaslik');
      
      if (!eslesmeyenlerContent || !eslesmeyenlerBaslik) {
        console.log('🔍 Eşleşmeyenler DOM elementleri bulunamadı');
        return;
      }
      
      // Mevcut eşleşmeyen tarifleri tekrar kontrol et
      const aktifHasta = seciliHasta;
      if (!aktifHasta || !aktifHasta.haftalar) {
        console.log('ℹ️ Yemek analizi için hasta seçilmedi veya hafta verisi yok');
        return;
      }
      
      let yeniEslesmeyenler = [];
      
      // Önce JSON'dan kaydedilmiş eşleşmeyen tarifleri al
      aktifHasta.haftalar.forEach(hafta => {
        if (hafta.eslesmeyenTarifler && hafta.eslesmeyenTarifler.length > 0) {
          hafta.eslesmeyenTarifler.forEach(tarif => {
            if (!yeniEslesmeyenler.includes(tarif)) {
              yeniEslesmeyenler.push(tarif);
            }
          });
        }
      });
      
      // Eğer JSON'da eşleşmeyen tarif yoksa, eski yöntemle hesapla
      if (yeniEslesmeyenler.length === 0) {
        aktifHasta.haftalar.forEach(hafta => {
          if (hafta.tarifler && hafta.tarifler.length > 0) {
            hafta.tarifler.forEach(tarif => {
              // Normalize et
              function normalizeLocal(str) {
                return str
                  .toLowerCase()
                  .replace(/ç/g, 'c').replace(/ğ/g, 'g').replace(/ş/g, 's')
                  .replace(/ü/g, 'u').replace(/ö/g, 'o').replace(/ı/g, 'i')
                  .replace(/i̇/g, 'i')
                  .replace(/[_*\/()]/g, ' ')
                  .replace(/\s+/g, ' ')
                  .replace(/[^a-z0-9\s]/g, '')
                  .trim();
              }
              
              const normalizedTarif = normalizeLocal(tarif);
              
              // Otomatik eşleşme kontrolü
              const otomatikEslesen = tariflerKlasoruGorselleri.some(kart => {
                const normalizedKart = normalizeLocal(kart.name.replace(/\.[^/.]+$/, ''));
                return normalizedKart.includes(normalizedTarif) || 
                       normalizedTarif.includes(normalizedKart) ||
                       normalizedKart === normalizedTarif;
              });
              
              // Manuel eşleşme kontrolü  
              const manuelEslesen = manuelEslestirmeler[normalizedTarif];
              
              // Yasak kural kontrolü
              const yasakMi = eslesmemeKurallari[normalizedTarif];
              
              // Eğer hiçbir yerde eşleşmiyor ve yasaklanmamışsa eşleşmeyen listesine ekle
              if (!otomatikEslesen && !manuelEslesen && !yasakMi && !yeniEslesmeyenler.includes(tarif)) {
                yeniEslesmeyenler.push(tarif);
              }
            });
          }
        });
      }
      
      // UI'ı güncelle
      if (yeniEslesmeyenler.length > 0) {
        eslesmeyenlerBaslik.textContent = `🚫 Eşleşmeyen Tarifler (${yeniEslesmeyenler.length})`;
        eslesmeyenlerContent.innerHTML = '';
        
        yeniEslesmeyenler.forEach(tarif => {
          const p = document.createElement('p');
          p.textContent = tarif;
          p.style.color = '#dc3545';
          p.style.margin = '6px 0';
          p.style.padding = '4px 8px';
          p.style.background = '#fff5f5';
          p.style.borderLeft = '3px solid #dc3545';
          p.style.borderRadius = '4px';
          p.style.cursor = 'pointer';
          p.style.transition = 'background-color 0.2s';
          p.title = 'Tıkla ve manuel eşleştirme yap';
          
          p.onmouseenter = () => p.style.background = '#ffe6e6';
          p.onmouseleave = () => p.style.background = '#fff5f5';
          p.onclick = () => {
            console.log('🔗 Eşleşmeyen tarif adına tıklandı:', tarif);
            try {
              if (typeof eslesmeyenTarifManuelEslestir === 'function') {
                eslesmeyenTarifManuelEslestir(tarif);
              } else {
                console.error('❌ eslesmeyenTarifManuelEslestir fonksiyonu bulunamadı!');
                alert('Manuel eşleştirme fonksiyonu yüklenemedi. Sayfayı yenileyin.');
              }
            } catch (error) {
              console.error('❌ Eşleşmeyen tarif tıklama hatası:', error);
              alert('Hata: ' + error.message);
            }
          };
          
          eslesmeyenlerContent.appendChild(p);
        });
      } else {
        eslesmeyenlerBaslik.textContent = '🚫 Eşleşmeyen Tarifler';
        eslesmeyenlerContent.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">🎉 Tüm tarifler eşleştirildi!</div>';
      }
      
      console.log('🔄 Eşleşmeyenler listesi güncellendi:', yeniEslesmeyenler.length, 'adet');
    }
    
    // Alias function for backward compatibility
    function updateEslesmeyenTarifler() {
      eslesmeyenlerListesiniGuncelle();
    }

    // Aktif hafta index'ini al
    function getAktifHaftaIndex() {
      const aktifTab = document.querySelector('.hafta-tab.active');
      if (aktifTab && aktifTab.dataset.haftaIndex !== undefined) {
        const index = parseInt(aktifTab.dataset.haftaIndex);
        console.log('🔍 Aktif hafta index bulundu:', index);
        return index;
      }
      
      // Fallback: En son hafta
      if (seciliHasta?.haftalar?.length > 0) {
        const lastIndex = seciliHasta.haftalar.length - 1;
        console.log('⚠️ Aktif tab bulunamadı, en son hafta kullanılıyor:', lastIndex);
        return lastIndex;
      }
      
      console.error('❌ Hiç hafta bulunamadı!');
      return 0;
    }
    
    // Token'ı localStorage'da sakla ve input'a yükle
    const TOKEN_KEY = 'github_api_token';
    function saveTokenToStorage() {
      const val = document.getElementById('githubToken').value;
      try { localStorage.setItem(TOKEN_KEY, val); } catch {}
      // Backward-compat: also store under previous key if used elsewhere
      try { localStorage.setItem('githubToken', val); } catch {}
    }
    function loadTokenFromStorage() {
      // Prefer canonical key; if missing, migrate from legacy key 'githubToken'
      let token = '';
      try { token = localStorage.getItem(TOKEN_KEY) || ''; } catch {}
      if (!token) {
        try {
          const legacy = localStorage.getItem('githubToken') || '';
          if (legacy) {
            // Migrate to canonical key and keep legacy for compatibility
            try { localStorage.setItem(TOKEN_KEY, legacy); } catch {}
            token = legacy;
          }
        } catch {}
      }
      return token || '';
    }
    // Sayfa açılışında token input'u doldur ve SADECE YENİ SİSTEMİ YÜKLİ
    window.addEventListener('DOMContentLoaded', async function() {
      // 🔇 GitHub API 409 ve network hatalarını console'da gizle
      const originalError = console.error;
      const originalWarn = console.warn;
      const originalLog = console.log;
      
      // Konsoldaki TÜM mesajları intercept eden süper agresif filter
      function isGitHubRelatedMessage(args) {
        const message = Array.from(args).join(' ').toLowerCase();
        return (message.includes('github.com') || 
                message.includes('409') ||
                message.includes('failed to load resource') ||
                message.includes('conflict') ||
                message.includes('api.github.com') ||
                message.includes('PUT https://api.github.com') ||
                message.includes('server responded with a status of 409')) && 
               !window.DEBUG_GITHUB_API;
      }
      
      // Console error suppression - GitHub API hatalarını filtrele
      console.error = function(...args) {
        if (isGitHubRelatedMessage(args)) {
          return; // Tamamen gizle
        }
        originalError.apply(console, args);
      };
      
      // Console warn suppression
      console.warn = function(...args) {
        if (isGitHubRelatedMessage(args)) {
          return;
        }
        originalWarn.apply(console, args);
      };
      
      // Console log suppression (bazen hatalar console.log ile de gelir)
      console.log = function(...args) {
        if (isGitHubRelatedMessage(args)) {
          return;
        }
        originalLog.apply(console, args);
      };
      
      // 🔇 DevTools native console override - daha agresif yaklaşım
      const originalConsole = window.console;
      Object.defineProperty(window, 'console', {
        value: new Proxy(originalConsole, {
          get(target, prop) {
            if (['error', 'warn', 'log'].includes(prop)) {
              return function(...args) {
                const message = args.join(' ');
                if ((message.includes('github.com') || 
                     message.includes('409') ||
                     message.includes('Failed to load resource') ||
                     message.includes('server responded with a status of 409')) && 
                    !window.DEBUG_GITHUB_API) {
                  return; // Silent suppression
                }
                return target[prop].apply(target, args);
              };
            }
            return target[prop];
          }
        })
      });
      
      // 🔇 Browser'ın kendi network hatalarını da gizle
      window.addEventListener('error', function(event) {
        if (event.message && 
            (event.message.includes('409') || event.message.includes('github.com') || 
             event.message.includes('Failed to load resource'))) {
          if (!window.DEBUG_GITHUB_API) {
            event.preventDefault();
            event.stopPropagation();
            return false;
          }
        }
      }, true);
      
      // 🔇 Global error handler - window.onerror override
      window.onerror = function(message, source, lineno, colno, error) {
        if (typeof message === 'string' && 
            (message.includes('github.com') || 
             message.includes('409') ||
             message.includes('Failed to load resource'))) {
          if (!window.DEBUG_GITHUB_API) {
            return true; // Suppress error
          }
        }
        return false; // Let other errors through
      };
      
      // 🔇 Resource loading errors (images, scripts, etc.)
      window.addEventListener('error', function(e) {
        if (e.target !== window && e.target.src && 
            (e.target.src.includes('github.com') || e.target.src.includes('409'))) {
          if (!window.DEBUG_GITHUB_API) {
            e.preventDefault();
            e.stopPropagation();
            return false;
          }
        }
      }, true);
      
      // 🔇 Unhandled promise rejection'ları da gizle (fetch hatalarını)
      window.addEventListener('unhandledrejection', function(event) {
        const reason = event.reason?.message || event.reason || '';
        if (reason.includes && (reason.includes('409') || reason.includes('github.com'))) {
          if (!window.DEBUG_GITHUB_API) {
            event.preventDefault();
            return false;
          }
        }
      });
      
      // 🔇 Fetch API wrapper - GitHub 409 hatalarını tamamen gizle
      const originalFetch = window.fetch;
      window.fetch = async function(...args) {
        // GitHub API çağrılarını detect et
        const isGitHubAPI = args[0]?.includes && args[0].includes('github.com');
        
        try {
          const response = await originalFetch.apply(this, args);
          
          // GitHub API hatalarını tamamen sessiz hale getir
          if (!window.DEBUG_GITHUB_API && isGitHubAPI && response.status === 409) {
            // Silent response - hiç log yazmadan döndür
            return response;
          }
          
          return response;
        } catch (error) {
          // GitHub API network hatalarını da sessiz hale getir
          if (!window.DEBUG_GITHUB_API && isGitHubAPI) {
            // Error'ı sessizce rethrow et
            const silentError = new Error(error.message);
            silentError.silent = true; // Custom flag
            throw silentError;
          }
          throw error;
        }
      };
      
      // 🔇 XMLHttpRequest override (fetch kullanmayan request'ler için)
      const originalXHR = window.XMLHttpRequest;
      window.XMLHttpRequest = function() {
        const xhr = new originalXHR();
        const originalOpen = xhr.open;
        
        xhr.open = function(method, url, ...args) {
          this._isGitHubAPI = url.includes('github.com');
          return originalOpen.apply(this, [method, url, ...args]);
        };
        
        const originalSend = xhr.send;
        xhr.send = function(...args) {
          if (!window.DEBUG_GITHUB_API && this._isGitHubAPI) {
            // GitHub API XHR'larını sessiz hale getir
            this.addEventListener('error', function(e) {
              e.preventDefault();
              e.stopPropagation();
            }, true);
          }
          return originalSend.apply(this, args);
        };
        
        return xhr;
      };
      
      const token = loadTokenFromStorage();
      const input = document.getElementById('githubToken');
      if (input) input.value = token;
      
      // ESKİ SİSTEM DEVRE DIŞI - Sadece yeni JSON sistemi kullan
      console.log('🚀 Yeni sistem başlatılıyor...');
      
      // Debug modları hakkında bilgi
      console.log('🐛 Debug modları:');
      console.log('   window.DEBUG_GITHUB_API =', window.DEBUG_GITHUB_API, '(GitHub API hatalarını göster/gizle)');
      console.log('   window.DEBUG_VERBOSE =', window.DEBUG_VERBOSE, '(Detaylı logları göster/gizle)');
      console.log('   💡 Aktifleştirmek için: window.DEBUG_GITHUB_API = true');
      
      // Karalisteyi önce yükle (token varsa GitHub'dan, yoksa public)
      try {
        const tknTmp = document.getElementById('githubToken')?.value?.trim();
        if (tknTmp) {
          await karalisteGitHubYukle(true);
        } else {
          await karalistePublicYukle();
        }
      } catch {}

  // Token sonradan girilirse: GitHub'dan yükle ve birleştir (karaliste) + diğer verileri tazele
      try {
        const tokenInputEl = document.getElementById('githubToken');
        if (tokenInputEl) {
          let lastToken = tokenInputEl.value.trim();
          tokenInputEl.addEventListener('change', async () => {
            const cur = tokenInputEl.value.trim();
            if (cur && cur !== lastToken) {
      console.log('🔑 Yeni token algılandı, GitHub verileri yükleniyor...');
      // 1) Karalisteyi GitHub'dan yükle ve yerelle birleştir (union)
      try { await karalisteGitHubYukle(true); } catch (e) { console.warn('Karaliste yükleme uyarısı:', e?.message || e); }
      // 2) Manuel eşleştirmeler, eşleşmeme kuralları ve split kurallarını GitHub'dan tazele (sessiz)
      try { await manuelEslestirmeleriGitHubYukle(true); } catch (e) { console.warn('Manuel eşleştirme yükleme uyarısı:', e?.message || e); }
      try { await eslesmemeKurallariniGitHubYukle(true); } catch (e) { console.warn('Eşleşmeme kural yükleme uyarısı:', e?.message || e); }
      try { await splitKurallariniGitHubYukle(true); } catch (e) { console.warn('Split kural yükleme uyarısı:', e?.message || e); }
  // 3) Hasta listesini/verilerini GitHub'dan güncelle (sessiz)
  try { await loadHastaDataFromGitHub(true); } catch (e) { console.warn('Hasta verileri yükleme uyarısı:', e?.message || e); }
  // 3.5) Şablon arşivini yükle (öğün Kaydet/Kaydedildi durumu için gerekli)
  try { if (typeof sablonlariYukle === 'function') await sablonlariYukle(); } catch (e) { console.warn('Şablon arşivi yükleme uyarısı:', e?.message || e); }
  // 4) UI'ı güncelle
      try { renderBlacklistModal(); } catch {}
      try { updateYemekVeritabaniAnalizi(); } catch {}
      try { updateYemekAnalizi(); } catch {}
      try { if (typeof eslesmeyenlerListesiniGuncelle === 'function') eslesmeyenlerListesiniGuncelle(); } catch {}
      try { if (typeof durumGuncelle === 'function') durumGuncelle(); } catch {}
            }
            lastToken = cur;
          });
        }
      } catch {}

      // Önce manuel eşleştirmeleri yükle
      manuelEslestirmeleriYukle();
      eslesmemeKurallariniYukle();
      
      // Sadece yeni sistemi başlat
      loadHastaDataFromGitHub().then(() => {
        console.log('✅ Yeni sistem hazır');
        
        // Diyet türlerini yükle
        diyetTurleriYukle().then(() => {
          console.log('✅ Diyet türleri yüklendi');
        }).catch(error => {
          console.log('⚠️ Diyet türleri yüklenemedi:', error.message);
        });
        
        // Otomatik senkronizasyonu başlat
        setTimeout(() => {
          otomatikGithubKontrol();
          periyodikSenkronizasyonBaslat();
        }, 2000);
        
        // Sistem yüklendikten sonra yemek analizini başlat
        setTimeout(async () => {
          // İlk render'dan önce şablon arşivini yükle ki öğünlerde Kaydet durumu doğru olsun
          try {
            if (!Array.isArray(window.mevcutSablonlar) || window.mevcutSablonlar.length === 0) {
              if (typeof sablonlariYukle === 'function') await sablonlariYukle();
            }
          } catch (e) { console.warn('Şablon yükleme uyarısı:', e?.message || e); }

          updateYemekAnalizi();
          // Eşleşmeyenler listesini de güncelle
          setTimeout(() => {
            try {
              if (typeof eslesmeyenlerListesiniGuncelle === 'function') {
                eslesmeyenlerListesiniGuncelle();
              } else {
                console.warn('⚠️ eslesmeyenlerListesiniGuncelle fonksiyonu henüz yüklenmemiş');
              }
            } catch (error) {
              console.warn('⚠️ eslesmeyenlerListesiniGuncelle hatası:', error.message);
            }
          }, 500);
  }, 1500); // Tüm veriler yüklenmesi için 1.5 saniye bekle
        
      }).catch(error => {
        console.warn('⚠️ Yeni sistem yüklenemedi:', error.message);
        // Boş yeni sistem ile başlat
        renderHastalarYeniSistem();
      });
    });

    // Data klasöründen hasta verilerini otomatik yükle
    // Türkçe karakter düzeltme fonksiyonu - YENİ VE GÜVENLİ VERSİYON
    function turkceKarakterDuzelt(text) {
      if (!text || typeof text !== 'string') return text;
      
      // SADECE BOZUK KARAKTERLERI TEMİZLE, YENİ BOZUKLUK YARATMA!
      let temizMetin = text;
      
      // 1. Sadece gerçekten bozuk olan ÃÂÃÂ kalıplarını temizle
      const bozukKaliplar = [
        /ÃÂÃÂÃÂÃÂÃÂÃÂÃÂÃÂÃÂÃÂÃÂÃÂÃÂÃÂÃÂÃÂÃÂÃÂÃÂÃÂÃÂÃÂÃÂÃÂÃÂÃÂÃÂÃÂÃÂÃÂÃÂÃÂÃÂÃÂÃÂÃÂÃÂÃÂÃÂÃÂÃÂÃÂÃÂÃÂÃÂÃÂÃÂÃÂÃÂÃÂÃÂÃÂÃÂÃÂÃÂÃÂÃÂÃÂÃÂÃÂÃÂÃÂÃÂÃÂ/g,
        /ÃÂÃÂÃÂÃÂÃÂÃÂÃÂÃÂÃÂÃÂÃÂÃÂÃÂÃÂÃÂÃÂÃÂÃÂÃÂÃÂÃÂÃÂÃÂÃÂÃÂÃÂÃÂÃÂÃÂÃÂÃÂÃÂ/g,
        /ÃÂÃÂÃÂÃÂÃÂÃÂÃÂÃÂÃÂÃÂÃÂÃÂÃÂÃÂÃÂÃÂ/g,
        /ÃÂÃÂÃÂÃÂ/g,
        /ãâãâ/g,
        /ãâ/g
      ];
      
      // Bozuk kalıpları kaldır
      bozukKaliplar.forEach(kalip => {
        temizMetin = temizMetin.replace(kalip, '');
      });
      
      // 2. ÖNCE tam isim kalıplarını düzelt (en spesifik olanlar)
      temizMetin = temizMetin.replace(/\^EYDA E EÇ0\^Ç/gi, 'ŞEYDA EĞEÇİŞ');
      
      // 2.1. PDF'de yaygın bozuk karakterleri düzelt
      const karakterDuzeltmeleri = {
        '^': 'Ş',    // PDF'de Ş karakteri ^ olarak görünüyor
        '0^': 'İ',   // PDF'de İ karakteri 0^ olarak görünüyor  
        'Ç^': 'Ç',   // PDF'de Ç karakteri Ç^ olarak görünüyor
        '°': 'İ',    // Alternatif İ gösterimi
        '*': 'Ş',    // Alternatif Ş gösterimi
        '§': 'Ş'     // Başka bir Ş gösterimi
      };
      
      // Karakter düzeltmelerini uygula
      for (const [bozuk, dogru] of Object.entries(karakterDuzeltmeleri)) {
        temizMetin = temizMetin.replace(new RegExp(escapeRegex(bozuk), 'g'), dogru);
      }
      
      // 2.5. Diğer özel kalıpları düzelt
      temizMetin = temizMetin.replace(/\^EYDA/g, 'ŞEYDA');
      temizMetin = temizMetin.replace(/E EÇ0\^Ç/g, 'EĞEÇİŞ');
      temizMetin = temizMetin.replace(/EGEÇ0\^/g, 'EĞEÇİŞ');
      
      // 2. Sadece kesin bozuk karakterleri düzelt (DİKKATLİ!)
      if (temizMetin.includes('°')) {
        temizMetin = temizMetin.replace(/°/g, 'İ');
      }
      if (temizMetin.includes('*')) {
        temizMetin = temizMetin.replace(/\*/g, 'Ş');
      }
      
      // 3. Bilinen bozuk isimleri düzelt
      const isimDuzeltmeleri = {
        'efKE BAY': 'ŞEFİKE BAY',
        'EF°KE BAY': 'ŞEFİKE BAY',
        'EFKE BAY': 'ŞEFİKE BAY',
        'ATAYŞ': 'ATAYŞ', // Doğru halini koru
        'ATAYYŞ': 'ATAYŞ', // Çifte Ş'yi düzelt
        'KK': 'KÖK',
        'KARAGZ': 'KARAGÖZ',
        'FSUN': 'FİSUN',
        'F°SUN': 'FİSUN'
      };
      
      // Sadece kesin bozuk isimleri düzelt
      for (const [bozuk, dogru] of Object.entries(isimDuzeltmeleri)) {
        if (temizMetin.includes(bozuk)) {
          temizMetin = temizMetin.replace(new RegExp(bozuk, 'gi'), dogru);
        }
      }
      
      // 4. Fazla boşlukları temizle
      temizMetin = temizMetin.replace(/\s+/g, ' ').trim();
      
      return temizMetin;
    }
    
    // Regex escape helper
    function escapeRegex(str) {
      return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    // PDF için Türkçe karakterleri ASCII'ye çevir
    function pdfIcinASCII(text) {
      if (!text || typeof text !== 'string') return text;
      
      return text
        .replace(/Ş/g, 'S').replace(/ş/g, 's')
        .replace(/Ğ/g, 'G').replace(/ğ/g, 'g')
        .replace(/İ/g, 'I').replace(/ı/g, 'i')
        .replace(/Ç/g, 'C').replace(/ç/g, 'c')
        .replace(/Ö/g, 'O').replace(/ö/g, 'o')
        .replace(/Ü/g, 'U').replace(/ü/g, 'u');
    }

    // ACIL DURUM: LocalStorage'daki bozuk verileri temizle
    function localStorageTemizle() {
      console.log('🧹 LocalStorage bozuk veri temizliği başlatılıyor...');
      
      try {
        const hastaDataKey = 'hastaData';
        const hastalarKey = 'hastalar';
        
        // Her iki key'i de kontrol et
        const keys = [hastaDataKey, hastalarKey];
        let temizlenen = 0;
        
        keys.forEach(key => {
          const data = localStorage.getItem(key);
          if (data) {
            try {
              const hastalar = JSON.parse(data);
              let degisiklik = false;
              
              hastalar.forEach(hasta => {
                const eskiIsim = hasta.isim;
                hasta.isim = turkceKarakterDuzelt(hasta.isim);
                if (eskiIsim !== hasta.isim) {
                  degisiklik = true;
                  temizlenen++;
                }
                if (hasta.not) {
                  hasta.not = turkceKarakterDuzelt(hasta.not);
                }
              });
              
              if (degisiklik) {
                localStorage.setItem(key, JSON.stringify(hastalar));
                console.log(`💾 ${key} güncellendi`);
              }
            } catch (e) {
              console.error(`❌ ${key} parse hatası:`, e);
            }
          }
        });
        
        if (temizlenen > 0) {
          console.log(`🎉 ${temizlenen} hasta ismi temizlendi!`);
        } else {
          console.log('✅ Veri zaten temiz!');
        }
        
      } catch (error) {
        console.error('❌ LocalStorage temizleme hatası:', error);
      }
    }
    
    // Sayfa yüklendiğinde otomatik temizleme yap
    setTimeout(() => {
      localStorageTemizle();
    }, 2000);

    // Manuel olarak mevcut hasta verilerini düzeltme fonksiyonu
    // Manuel olarak mevcut hasta verilerini düzeltme fonksiyonu
    function manuelHastaIsimleriniDuzelt() {
      console.log('🔧 Hasta isimlerini düzeltiliyor...');
      let degisiklikSayisi = 0;
      
      hastalar.forEach((hasta, index) => {
        if (hasta.isim) {
          const eskiIsim = hasta.isim;
          const yeniIsim = turkceKarakterDuzelt(eskiIsim);
          
          if (eskiIsim !== yeniIsim) {
            hasta.isim = yeniIsim;
            degisiklikSayisi++;
            console.log(`✅ ${index + 1}. "${eskiIsim}" → "${yeniIsim}"`);
          }
        }
        
        // Notları da düzelt
        if (hasta.not) {
          const eskiNot = hasta.not;
          const yeniNot = turkceKarakterDuzelt(eskiNot);
          if (eskiNot !== yeniNot) {
            hasta.not = yeniNot;
            console.log(`📝 Not düzeltildi: "${eskiNot}" → "${yeniNot}"`);
          }
        }
      });
      
      if (degisiklikSayisi > 0) {
        // Verileri kaydet
        saveToStorage();
        
        // Hasta listesini sırala ve yenile
        hastalar.sort((a, b) => a.isim.localeCompare(b.isim, 'tr'));
        renderHastalar();
        
        // Eğer bir hasta seçiliyse paneli güncelle
        if (seciliHasta) {
          const secilenHastaIsim = document.getElementById('secilenHastaIsim');
          const secilenHastaNot = document.getElementById('secilenHastaNot');
          if (secilenHastaIsim) secilenHastaIsim.textContent = seciliHasta.isim.toUpperCase();
          if (secilenHastaNot) secilenHastaNot.textContent = seciliHasta.not || 'Not bulunmuyor';
        }
        
        console.log(`🎉 RADIKAL DÜZELTMe TAmamlandı: ${degisiklikSayisi} hasta ismi düzeltildi!`);
        alert(`✅ RADIKAL ÇÖZÜM: ${degisiklikSayisi} hasta ismi düzeltildi!\n\nArtık "AYŞÂE" → "AYŞE" gibi düzeltmeler yapıldı.`);
        
        // Düzeltilen hastaları yeni sisteme kaydet
        console.log('📤 Düzeltilen hastalar yeni sisteme kaydediliyor...');
        tumHastalariAyriKaydet().then(() => {
          console.log('✅ Tüm düzeltmeler yeni sisteme kaydedildi');
        }).catch(error => {
          console.error('❌ Yeni sisteme kaydetme hatası:', error);
          alert('⚠️ Düzeltmeler yapıldı ama GitHub kaydı başarısız. Token kontrolü yapın.');
        });
      } else {
        console.log('✅ Tüm hasta isimleri zaten doğru!');
        alert('✅ Tüm hasta isimleri zaten doğru formatta!');
      }
    }
    window.manuelHastaIsimleriniDuzelt = manuelHastaIsimleriniDuzelt;

    // ESKİ SİSTEM DEVRE DIŞI - Artık sadece yeni JSON sistemi kullanılıyor
    async function loadDataFromFolder() {
      const durumElement = document.getElementById('dataKlasoruDurumu');
      console.log('⚠️ ESKİ SİSTEM DEVRE DIŞI - Sadece yeni JSON sistemi kullanılıyor');
      if (durumElement) {
        durumElement.innerHTML = '❌ ESKİ SİSTEM DEVRE DIŞI - Yeni JSON sistemi aktif';
      }
      // Eski sistem tamamen devre dışı - data/hasta_kayitlari.json artık kullanılmıyor
    }

    // Fresh veri yükleme (cache'i bypass ederek)
    async function initFreshDataLoad() {
      console.log('🚀 Fresh veri yükleme başlıyor...');
      
  // Önce localStorage'dan yükle (temel veriler için)
      manuelEslestirmeleriYukle();
      eslesmemeKurallariniYukle();
  splitKurallariniYukle();
      
      // Token varsa GitHub'dan fresh yükle ve override et
      const token = document.getElementById('githubToken').value.trim();
      if (token) {
        try {
          console.log('🔄 GitHub\'tan fresh veriler yükleniyor...');
          
          // Cache timestamp kontrolü - 5 dakikadan eski ise yenile
          const lastUpdate = localStorage.getItem('lastGithubUpdate');
          const now = Date.now();
          const fiveMinutes = 5 * 60 * 1000;
          
          if (!lastUpdate || (now - parseInt(lastUpdate)) > fiveMinutes) {
            console.log('⏰ Cache eski, GitHub\'tan yenileniyor...');
            
            // GitHub token kontrolü
            const token = document.getElementById('githubToken').value.trim();
            if (!token) {
              console.warn('⚠️ GitHub token yok - Manuel eşleştirme ve yasak kuralları yüklenemedi');
              console.log('💡 Çözüm: GitHub token girin veya localStorage\'dan yüklenecek');
            } else {
              console.log('🔑 GitHub token mevcut, veriler yükleniyor...');
              
              await manuelEslestirmeleriGitHubYukle(true); // sessiz yükleme
              await eslesmemeKurallariniGitHubYukle(true); // sessiz yükleme
              await splitKurallariniGitHubYukle(true); // sessiz yükleme
              
              console.log('✅ GitHub data klasörü verileri yüklendi:', Object.keys(manuelEslestirmeler).length, 'manuel eşleştirme,', Object.keys(eslesmemeKurallari).length, 'yasak');
            }
            
            // Token olmasa bile public GitHub dosyalarını dene
            if (!token || Object.keys(manuelEslestirmeler).length === 0) {
              console.log('🌐 Public GitHub dosyaları deneniyor...');
              await loadPublicGitHubData();
            }
            
            // Hasta verilerini de GitHub'dan yükle
            await loadHastaDataFromGitHub(true); // sessiz yükleme
            
            // Cache timestamp'ini güncelle
            localStorage.setItem('lastGithubUpdate', now.toString());
            
            console.log('✅ GitHub veriler yüklendi:', Object.keys(manuelEslestirmeler).length, 'manuel eşleştirme,', Object.keys(eslesmemeKurallari).length, 'yasak');
          } else {
            console.log('✅ GitHub cache taze, localStorage kullanılıyor');
          }
          
        } catch (error) {
          console.warn('⚠️ GitHub\'dan veri yüklenemedi, localStorage kullanılıyor:', error.message);
        }
      }
      
      console.log('📊 Yüklenen veriler:');
      console.log('- Manuel eşleştirmeler:', Object.keys(manuelEslestirmeler).length, 'adet');
      console.log('- Eşleşme yasakları:', Object.keys(eslesmemeKurallari).length, 'adet');
    }

    // Public GitHub dosyalarını token olmadan yükle
    async function loadPublicGitHubData() {
      try {
        console.log('📥 Public manuel eşleştirmeler yükleniyor...');
        const manuelUrl = 'https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli-4/main/data/manuel_eslestirmeler.json';
        
        try {
          const manuelResp = await fetch(manuelUrl);
          if (manuelResp.ok) {
            const manuelData = await manuelResp.json();
            if (manuelData.eslestirmeler) {
              manuelEslestirmeler = manuelData.eslestirmeler;
            } else {
              manuelEslestirmeler = manuelData;
            }
            console.log('✅ Public manuel eşleştirmeler yüklendi:', Object.keys(manuelEslestirmeler).length, 'adet');
          } else {
            console.warn('⚠️ Public manuel eşleştirmeler yüklenemedi:', manuelResp.status);
          }
        } catch (manuelError) {
          console.warn('⚠️ Public manuel eşleştirme hatası:', manuelError.message);
        }

        console.log('📥 Public yasak kuralları yükleniyor...');
        const yasakUrl = 'https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli-4/main/data/eslesmeme_kurallari.json';
        
        try {
          const yasakResp = await fetch(yasakUrl);
          if (yasakResp.ok) {
            const yasakData = await yasakResp.json();
            if (yasakData.kurallar) {
              eslesmemeKurallari = yasakData.kurallar;
            } else {
              eslesmemeKurallari = yasakData;
            }
            console.log('✅ Public yasak kuralları yüklendi:', Object.keys(eslesmemeKurallari).length, 'adet');
          } else {
            console.warn('⚠️ Public yasak kuralları yüklenemedi:', yasakResp.status);
          }
        } catch (yasakError) {
          console.warn('⚠️ Public yasak kuralı hatası:', yasakError.message);
        }

        // Split kuralları (public)
        try {
          console.log('📥 Public split kuralları yükleniyor...');
          const splitUrl = 'https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli-4/main/data/split_kurallari.json';
          const splitResp = await fetch(splitUrl);
          if (splitResp.ok) {
            const splitData = await splitResp.json();
            if (splitData.kurallar) {
              splitKurallari = splitData.kurallar;
            } else {
              splitKurallari = splitData;
            }
            localStorage.setItem(SPLIT_KURALLARI_KEY, JSON.stringify(splitKurallari));
            console.log('✅ Public split kuralları yüklendi:', Object.keys(splitKurallari).length, 'adet');
          } else {
            console.warn('⚠️ Public split kuralları yüklenemedi:', splitResp.status);
          }
        } catch (splitError) {
          console.warn('⚠️ Public split kuralı hatası:', splitError.message);
        }

        // UI'yi güncelle
        if (typeof manuelEslestirmeListesiniGoster === 'function') {
          manuelEslestirmeListesiniGoster();
        }
        if (typeof eslesmemeKurallariniGoster === 'function') {
          eslesmemeKurallariniGoster();
        }

      } catch (error) {
        console.error('❌ Public GitHub data yükleme hatası:', error);
      }
    }

    // GitHub'dan hasta verilerini yükle (YENİ SİSTEM)
    async function loadHastaDataFromGitHub(sessiz = false) {
      // PDF yükleme devam ediyorsa GitHub data yükleme işlemini engelle
      if (window.pdfYuklemeDevamEdiyor) {
        console.log('🚫 PDF yükleme devam ediyor, loadHastaDataFromGitHub atlanıyor');
        return;
      }
      
      const durumElement = document.getElementById('githubDurumu');
      const token = document.getElementById('githubToken').value.trim();
      
      if (!token) {
        if (!sessiz) console.log('ℹ️ GitHub token girilmedi, offline modda çalışıyor');
        if (durumElement) durumElement.innerHTML = 'ℹ️ Offline Mod - GitHub token girilmedi';
        return;
      }
      
      try {
        if (!sessiz) console.log('📥 GitHub\'dan hasta listesi yükleniyor (Yeni Sistem)...');
        if (durumElement) durumElement.innerHTML = '🔄 GitHub\'dan hasta listesi yükleniyor...';
        
        // Hasta listesini yükle ve sonucu al
        const yuklenmisList = await hastaListesiYukle();
        
        if (yuklenmisList.length > 0) {
          console.log('✅ GitHub\'dan hasta listesi yüklendi:', yuklenmisList.length, 'hasta');
          
          // Hastalar listesini yeni sistemden render et
          await renderHastalarYeniSistem();
          
          if (durumElement) {
            durumElement.innerHTML = `✅ GitHub'dan yüklendi (${yuklenmisList.length} hasta - Yeni Sistem)`;
          }
          
          // Alert kaldırıldı - sadece console'da bilgi veriliyor
        } else {
          console.log('⚠️ Hasta listesi boş');
          if (durumElement) durumElement.innerHTML = '⚠️ Hasta listesi boş - Yeni hastalar ekleyebilirsiniz';
          
          // Alert kaldırıldı - sadece console'da bilgi veriliyor
        }
      } catch (error) {
        if (!sessiz) console.warn('⚠️ GitHub\'dan hasta verileri yüklenemedi:', error.message);
        if (durumElement) durumElement.innerHTML = '❌ GitHub bağlantı hatası: ' + error.message;
      }
    }

    // GitHub token test fonksiyonu
    async function testGitHubToken() {
      const token = document.getElementById('githubToken').value.trim();
      if (!token) {
        alert('❌ GitHub token girilmedi!');
        return false;
      }
      
      try {
        console.log('🔍 GitHub token test ediliyor...');
        
        const userResponse = await fetch('https://api.github.com/user', {
          headers: { 'Authorization': `token ${token}` }
        });
        
        if (!userResponse.ok) {
          alert(`❌ GitHub token geçersiz!\nHata: ${userResponse.status}`);
          return false;
        }
        
        const user = await userResponse.json();
        console.log('✅ GitHub kullanıcı bilgileri alındı:', user.login);
        
        alert(`✅ GitHub token geçerli!\n\n👤 Kullanıcı: ${user.login}`);
        return true;
        
      } catch (error) {
        console.error('❌ GitHub token test hatası:', error);
        alert('❌ GitHub bağlantı hatası: ' + error.message);
        return false;
      }
    }

    // === YENİ SİSTEM: HASTA LİSTESİ YÖNETİMİ ===
    
    // Hasta listesini GitHub'dan yükle
    async function hastaListesiYukle() {
      try {
        const token = document.getElementById('githubToken').value.trim();
        if (!token) {
          console.log('ℹ️ GitHub token yok, offline modda çalışıyor');
          return [];
        }
        
        const owner = 'mustafasacar35';
        const repo = 'lipodem-takip-paneli-4';
        const response = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/patients/hastalar_listesi.json`, {
          headers: { 'Authorization': `token ${token}` }
        });
        
        if (response.ok) {
          const data = await response.json();
          
          // Base64'ü UTF-8 olarak decode et (Türkçe karakterler için)
          const contentStr = decodeBase64UTF8(data.content).trim();
          
          // Boş dosya kontrolü
          if (!contentStr || contentStr === '' || contentStr === '{}' || contentStr === 'null') {
            console.log('📝 Hasta listesi dosyası boş, yeni liste oluşturulacak');
            hastaListesi = []; // Global değişkeni sıfırla
            return [];
          }
          
          try {
            const content = JSON.parse(contentStr);
            if (Array.isArray(content)) {
              console.log('✅ Hasta listesi GitHub\'dan yüklendi:', content.length, 'hasta');
              hastaListesi = content; // Global değişkeni güncelle
              return content;
            } else {
              console.log('⚠️ Hasta listesi array değil, yeni liste oluşturulacak');
              hastaListesi = []; // Global değişkeni sıfırla
              return [];
            }
          } catch (parseError) {
            console.error('❌ JSON parse hatası:', parseError);
            console.log('📝 Bozuk JSON, yeni liste oluşturulacak');
            hastaListesi = []; // Global değişkeni sıfırla
            return [];
          }
        } else if (response.status === 404) {
          console.log('📝 Hasta listesi bulunamadı, yeni liste oluşturulacak');
          hastaListesi = []; // Global değişkeni sıfırla
          return [];
        } else {
          throw new Error(`GitHub API hatası: ${response.status}`);
        }
      } catch (error) {
        console.error('❌ Hasta listesi yükleme hatası:', error);
        throw error;
      }
    }
    
    // Hasta listesini GitHub'a kaydet
    async function hastaListesiKaydet(hastaListesi) {
      const token = document.getElementById('githubToken').value.trim();
      if (!token) {
        console.warn('ℹ️ GitHub token yok, offline modda çalışıyor');
        return false;
      }
      
      let retryCount = 0; // Retry counter eklendi
      
      try {
        const owner = 'mustafasacar35';
        const repo = 'lipodem-takip-paneli-4';
        const branch = 'main';
        
        // UTF-8 için doğru encoding
        const content = encodeUTF8ToBase64(hastaListesi);
        
        // Önce mevcut dosyanın SHA'sını al
        let sha = undefined;
        try {
          const checkResponse = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/patients/hastalar_listesi.json`, {
            headers: { 'Authorization': `token ${token}` }
          });
          if (checkResponse.ok) {
            const data = await checkResponse.json();
            sha = data.sha;
          }
        } catch (e) {}
        
        let response = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/patients/hastalar_listesi.json`, {
          method: 'PUT',
          headers: {
            'Authorization': `token ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            message: `Hasta listesi güncellendi: ${hastaListesi.length} hasta`,
            content: content,
            sha: sha,
            branch
          })
        });
        
        if (response.status === 409) {
          // 409 hatalarını sadece debug modunda logla - console spam'ini azalt  
          if (window.DEBUG_GITHUB_API) {
            console.log('🔄 409 Conflict: hasta listesi kaydı için yeniden deneniyor... (normal durum)');
          }
          // Exponential backoff - daha akıllı bekleme
          retryCount++;
          const waitTime = Math.min(1200 * Math.pow(1.5, retryCount), 8000); // Max 8 saniye
          await new Promise(r => setTimeout(r, waitTime));
          try {
            const checkResponse2 = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/patients/hastalar_listesi.json`, {
              headers: { 'Authorization': `token ${token}` }
            });
            if (checkResponse2.ok) {
              const data2 = await checkResponse2.json();
              sha = data2.sha;
            }
          } catch (_) {}
          response = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/patients/hastalar_listesi.json`, {
            method: 'PUT',
            headers: {
              'Authorization': `token ${token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              message: `Hasta listesi güncellendi: ${hastaListesi.length} hasta (retry)`,
              content,
              sha,
              branch
            })
          });
        }

        if (response.ok) {
          console.log('✅ Hasta listesi GitHub\'a kaydedildi');
          return true;
        } else {
          throw new Error(`GitHub API hatası: ${response.status}`);
        }
      } catch (error) {
        console.error('❌ Hasta listesi kaydetme hatası:', error);
        return false;
      }
    }
    
    // Hasta listesinden hasta kaldır
    async function hastaListesindenKaldir(hastaId) {
      try {
        const mevcutListe = await hastaListesiYukle();
        
        // Hasta ID'sine göre filtrele
        const yeniListe = mevcutListe.filter(hasta => hasta.id !== hastaId);
        
        console.log(`🗑️ Hasta listesinden kaldırılıyor: ID=${hastaId}`);
        console.log(`📊 Liste boyutu: ${mevcutListe.length} → ${yeniListe.length}`);
        
        // Güncellenmiş listeyi kaydet
        const sonuc = await hastaListesiKaydet(yeniListe);
        if (sonuc) {
          console.log('✅ Hasta listesinden başarıyla kaldırıldı');
          return true;
        } else {
          throw new Error('Hasta listesi güncellenemedi');
        }
      } catch (error) {
        console.error('❌ Hasta listesinden kaldırma hatası:', error);
        return false;
      }
    }
    
    // 🚥 GitHub API Queue Processor - 409 hatalarını azaltmak için
    async function processGitHubAPIQueue() {
      if (window.GITHUB_API_PROCESSING || window.GITHUB_API_QUEUE.length === 0) {
        return;
      }
      
      window.GITHUB_API_PROCESSING = true;
      
      while (window.GITHUB_API_QUEUE.length > 0) {
        const { apiCall, resolve, reject } = window.GITHUB_API_QUEUE.shift();
        
        try {
          await new Promise(r => setTimeout(r, window.GITHUB_API_DELAY)); // Throttle
          const result = await apiCall();
          resolve(result);
        } catch (error) {
          reject(error);
        }
      }
      
      window.GITHUB_API_PROCESSING = false;
    }
    
    // GitHub API çağrılarını queue'ya ekle
    function queueGitHubAPI(apiCall) {
      return new Promise((resolve, reject) => {
        window.GITHUB_API_QUEUE.push({ apiCall, resolve, reject });
        processGitHubAPIQueue();
      });
    }
    
    // Hasta listesine yeni hasta ekle
    async function hastaListesineEkle(hasta) {
      const mevcutListe = await hastaListesiYukle();
      
      // Hasta objesi veya string kontrolü
      let hastaIsim, hastaId, hastaNot, hastaArsiv;
      
      if (typeof hasta === 'string') {
        // String olarak geçirildiyse (eski kullanım)
        hastaIsim = hasta;
        hastaId = generatePatientId(hastaIsim);
        hastaNot = '';
        hastaArsiv = false;
      } else {
        // Obje olarak geçirildiyse
        hastaIsim = hasta.isim || hasta.ad || hasta.name;
        hastaId = hasta.id || generatePatientId(hastaIsim);
        hastaNot = hasta.not || hasta.notes || '';
        hastaArsiv = hasta.arsiv || hasta.archived || false;
      }
      
      if (!hastaIsim) {
        console.error('❌ Hasta ismi bulunamadı:', hasta);
        return false;
      }
      
      // Hasta zaten var mı kontrol et
      const mevcutIndex = mevcutListe.findIndex(h => h.id === hastaId || h.isim === hastaIsim);
      
      if (mevcutIndex !== -1) {
        // Mevcut hastayı güncelle
        mevcutListe[mevcutIndex] = {
          id: hastaId,
          isim: hastaIsim,
          not: hastaNot,
          arsiv: hastaArsiv,
          sonGuncelleme: new Date().toISOString()
        };
        console.log('📝 Mevcut hasta güncellendi:', hastaIsim);
      } else {
        // Yeni hasta ekle
        mevcutListe.push({
          id: hastaId,
          isim: hastaIsim,
          not: hastaNot,
          arsiv: hastaArsiv,
          olusturma: new Date().toISOString(),
          sonGuncelleme: new Date().toISOString()
        });
        console.log('➕ Yeni hasta eklendi:', hastaIsim);
      }
      
      // Listeyi sırala (arsiv olmayanlar önce, sonra alfabetik)
      mevcutListe.sort((a, b) => {
        if (a.arsiv !== b.arsiv) return a.arsiv ? 1 : -1;
        return a.isim.localeCompare(b.isim, 'tr');
      });
      
      await hastaListesiKaydet(mevcutListe);
      return mevcutListe;
    }

    // === YENİ SİSTEM: PDF YÖNETİMİ ===
    
    // PDF'i GitHub'a yükleme fonksiyonu
    async function pdfYukleGithub(file, hastaId, haftaNo) {
      const token = document.getElementById('githubToken').value.trim();
      if (!token) {
        alert('GitHub token gerekli!');
        return null;
      }
      
      try {
        console.log('📤 PDF GitHub\'a yükleniyor:', file.name);
        
        const owner = 'mustafasacar35';
        const repo = 'lipodem-takip-paneli-4';
        
        // Güvenli dosya adı oluştur (sadece problemli karakterleri temizle)
        const guvenliDosyaAdi = file.name
          .replace(/[\/\\*?"<>|:]/g, '_')  // Sadece gerçekten problemli olanları
          .replace(/\s+/g, ' ')            // Çoklu boşlukları tek yap
          .trim();
        
        const dosyaYolu = `pdfs/${guvenliDosyaAdi}`;
        
        // Dosyayı base64'e çevir
        const base64Data = await new Promise((resolve) => {
          const reader = new FileReader();
          reader.onload = () => {
            const base64 = reader.result.split(',')[1];
            resolve(base64);
          };
          reader.readAsDataURL(file);
        });
        
        // Önce dosyanın var olup olmadığını kontrol et
        let sha = undefined;
        try {
          const checkResponse = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${dosyaYolu}`, {
            headers: { 'Authorization': `token ${token}` }
          });
          if (checkResponse.ok) {
            const data = await checkResponse.json();
            sha = data.sha;
            console.log('⚠️ Aynı isimde PDF bulundu, üzerine yazılacak');
          }
        } catch (e) {
          console.log('✅ Yeni PDF dosyası');
        }
        
        // PDF'i GitHub'a yükle
        const response = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${dosyaYolu}`, {
          method: 'PUT',
          headers: {
            'Authorization': `token ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            message: `PDF yüklendi: ${file.name} (Hasta ID: ${hastaId}, Hafta: ${haftaNo})`,
            content: base64Data,
            sha: sha
          })
        });
        
        if (response.ok) {
          const result = await response.json();
          console.log('✅ PDF başarıyla yüklendi:', dosyaYolu);
          
          return {
            dosyaYolu: dosyaYolu,
            orijinalAd: file.name,
            guvenliAd: guvenliDosyaAdi,
            githubUrl: `https://github.com/${owner}/${repo}/blob/${(window.GITHUB_DEFAULT_BRANCH||'main')}/${dosyaYolu}`,
            indirmeUrl: `https://raw.githubusercontent.com/${owner}/${repo}/${(window.GITHUB_DEFAULT_BRANCH||'main')}/${dosyaYolu}`,
            sha: result.content.sha
          };
        } else {
          throw new Error(`GitHub API hatası: ${response.status}`);
        }
        
      } catch (error) {
        console.error('❌ PDF yükleme hatası:', error);
        alert(`PDF yüklenemedi: ${error.message}`);
        return null;
      }
    }

    // === YENİ SİSTEM: HER HASTA İÇİN AYRI JSON DOSYASI ===
    
    // Dosya adı oluşturma fonksiyonu
    function generateFileName(hasta) {
      if (!hasta || !hasta.isim) {
        console.error('❌ generateFileName: Geçersiz hasta objesi', hasta);
        return 'hasta_gecersiz.json';
      }
      
      const temizIsim = hasta.isim
        .toLowerCase()
        .replace(/ç/g, 'c').replace(/ğ/g, 'g').replace(/ş/g, 's')
        .replace(/ü/g, 'u').replace(/ö/g, 'o').replace(/ı/g, 'i')
        .replace(/[^a-z0-9]/g, '_')
        .replace(/_+/g, '_')
        .replace(/^_|_$/g, '');
        
      // ID yoksa isimden oluştur
      const hastaId = hasta.id || temizIsim;
      
      return `hasta_${hastaId}_${temizIsim}.json`;
    }
    
    function generatePatientId(isim) {
      if (!isim) return 'hasta_gecersiz';
      
      return isim
        .toLowerCase()
        .replace(/ç/g, 'c').replace(/ğ/g, 'g').replace(/ş/g, 's')
        .replace(/ü/g, 'u').replace(/ö/g, 'o').replace(/ı/g, 'i')
        .replace(/[^a-z0-9]/g, '_')
        .replace(/_+/g, '_')
        .replace(/^_|_$/g, '');
    }
    
    // Patients klasörünü oluşturma
    async function createPatientsFolder() {
      const token = document.getElementById('githubToken').value.trim();
      if (!token) return;
      
      try {
        const owner = 'mustafasacar35';
        const repo = 'lipodem-takip-paneli-4';
        
        // README.md dosyası ile klasör oluştur
        const content = btoa(`# Hasta Dosyaları

Bu klasörde her hastanın ayrı JSON dosyası bulunur.

## Dosya Adlandırma
- Formato: hasta_[ID]_[ISIM].json
- Örnek: hasta_1_ayse_yilmaz.json

## Dosya Yapısı
Her hasta dosyası şu bilgileri içerir:
- Hasta bilgileri (id, isim, not)
- Hafta takip bilgileri
- PDF dosyaları (base64)
- Eşleştirme kartları
- GPT mesajları

## Arşivleme
Kullanıcı 13+ hafta olan hastaları manuel olarak arşivler.
`);
        
        await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/patients/README.md`, {
          method: 'PUT',
          headers: {
            'Authorization': `token ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            message: 'Patients klasörü oluşturuldu',
            content: content
          })
        });
        
        console.log('✅ Patients klasörü oluşturuldu');
        
      } catch (error) {
        console.warn('Patients klasörü oluşturma hatası:', error);
      }
    }
    
    // Tek hasta kaydetme fonksiyonu
    async function hastayiAyriKaydet(hasta) {
      // Güvenlik kontrolü
      if (!hasta || !hasta.isim) {
        alert('❌ Geçersiz hasta verisi! Lütfen önce bir hasta seçin.');
        return false;
      }
      
      const token = document.getElementById('githubToken').value.trim();
      if (!token) {
        alert('❌ GitHub token gerekli! Lütfen GitHub token girin.');
        return false;
      }
      
      try {
        console.log(`💾 ${hasta.isim} hastası kaydediliyor...`);
        
        const owner = 'mustafasacar35';
        const repo = 'lipodem-takip-paneli-4';
        const branch = 'main';
        
        // Son güncelleme tarihini ekle
        hasta.sonGuncelleme = new Date().toISOString();
        hasta.githubKaydedildi = true;
        
        const fileName = generateFileName(hasta);
        
        // Hasta verilerini kaydetmeden önce hafta verilerinde GitHub linklerini güncelle
        if (hasta.haftalar && hasta.haftalar.length > 0) {
          hasta.haftalar.forEach(hafta => {
            if (hafta.pdf) { // PDF varsa link oluştur
              hafta.githubLink = `https://github.com/${owner}/${repo}/blob/${branch}/patients/${fileName}`;
              hafta.githubRawLink = `https://raw.githubusercontent.com/${owner}/${repo}/${branch}/patients/${fileName}`;
            }
          });
        }
        
        // UTF-8 için doğru encoding
        const content = encodeUTF8ToBase64(hasta);
        
        // Önce dosyanın SHA'sını kontrol et
        let sha = undefined;
        try {
          const checkResponse = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/patients/${fileName}`, {
            headers: { 'Authorization': `token ${token}` }
          });
          if (checkResponse.ok) {
            const data = await checkResponse.json();
            sha = data.sha;
          }
        } catch (e) {}
        
        // Dosyayı kaydet - retry mekanizması ile (azaltılmış retry)
        let maxRetries = 3; // 5'ten 3'e düşürüldü
        let retryDelay = 1500; // Biraz daha uzun bekleme
        
        for (let attempt = 1; attempt <= maxRetries; attempt++) {
          try {
            // 🔇 Silent fetch for GitHub API to prevent console spam
            let response;
            try {
              response = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/patients/${fileName}`, {
                method: 'PUT',
                headers: {
                  'Authorization': `token ${token}`,
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                  message: `Hasta kaydı güncellendi: ${hasta.isim}`,
                  content: content,
                  sha: sha
                })
              });
            } catch (fetchError) {
              // Fetch hatalarını debug modunda değilse gizle
              if (window.DEBUG_GITHUB_API) {
                console.warn('GitHub API fetch hatası:', fetchError);
              }
              throw fetchError;
            }
            
            if (response.ok) {
              console.log(`✅ ${hasta.isim} ayrı dosya olarak kaydedildi (${attempt}. denemede)`);
              
              // Hasta listesine de ekle/güncelle
              await hastaListesineEkle(hasta);
              
              return true;
            } else if (response.status === 409 && attempt < maxRetries) {
              // 409 hatalarını sadece debug modunda logla - console spam'ini azalt
              if (window.DEBUG_GITHUB_API) {
                console.log(`🔄 409 Conflict (${attempt}/${maxRetries}): ${hasta.isim} için yeniden deneniyor... (normal durum)`);
              }
              
              // SHA'yı yeniden al
              try {
                const recheckResponse = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/patients/${fileName}`, {
                  headers: { 'Authorization': `token ${token}` }
                });
                if (recheckResponse.ok) {
                  const data = await recheckResponse.json();
                  sha = data.sha;
                  console.log(`🔄 Yeni SHA alındı: ${sha}`);
                }
              } catch (e) {
                console.warn('SHA yeniden alma hatası:', e);
              }
              
              // Exponential backoff - her deneme daha uzun bekle
              const backoffDelay = Math.min(retryDelay * Math.pow(2, attempt - 1), 10000); // Max 10 saniye
              await new Promise(resolve => setTimeout(resolve, backoffDelay));
              continue;
            } else {
              throw new Error(`GitHub API hatası: ${response.status}`);
            }
          } catch (networkError) {
            if (attempt < maxRetries) {
              console.warn(`🌐 Ağ hatası (${attempt}/${maxRetries}): ${hasta.isim} için yeniden deneniyor...`, networkError.message);
              await new Promise(resolve => setTimeout(resolve, retryDelay * attempt));
              continue;
            } else {
              throw networkError;
            }
          }
        }
        
        throw new Error(`GitHub kayıt başarısız: ${maxRetries} deneme tükendi`);
        
      } catch (error) {
        console.error(`❌ ${hasta.isim} kaydetme hatası:`, error);
        return false;
      }
    }
    
    // Tüm hastaları ayrı dosyalar halinde kaydetme
    async function tumHastalariAyriKaydet() {
      const token = document.getElementById('githubToken').value.trim();
      if (!token) {
        alert('GitHub token gerekli!');
        return;
      }
      
      if (!confirm('Tüm hastaları ayrı JSON dosyaları halinde kaydetmek istediğinize emin misiniz?\n\nBu yeni sisteme geçiş işlemidir.')) {
        return;
      }
      
      console.log('🚀 Yeni sistem başlatılıyor: Her hasta için ayrı JSON dosyası...');
      
      // Önce patients klasörünü oluştur
      await createPatientsFolder();
      
      let basarili = 0;
      let hatali = 0;
      
      const durum = document.getElementById('githubDurumu');
      if (durum) durum.innerHTML = '💾 Yeni sisteme geçiliyor...';
      
      for (const hasta of hastalar) {
        try {
          const sonuc = await hastayiAyriKaydet(hasta);
          if (sonuc) {
            basarili++;
          } else {
            hatali++;
          }
          
          // Rate limiting için bekleme
          await new Promise(resolve => setTimeout(resolve, 500));
          
          // İlerleme göster
          if (durum) {
            durum.innerHTML = `💾 İşleniyor: ${basarili + hatali}/${hastalar.length} hasta`;
          }
          
        } catch (error) {
          console.error(`${hasta.isim} kaydedilemedi:`, error);
          hatali++;
        }
      }
      
      if (durum) {
        durum.innerHTML = `✅ Yeni sistem tamamlandı: ${basarili} başarılı, ${hatali} hatalı`;
      }
      
      alert(`🎉 Yeni sisteme geçiş tamamlandı!\n\n✅ Başarılı: ${basarili}\n❌ Hatalı: ${hatali}\n\nArtık her hasta ayrı JSON dosyasında saklanıyor.`);
      
      console.log('🎯 Yeni sistem bilgileri:');
      console.log('- Her hasta için ayrı JSON dosyası oluşturuldu');
      console.log('- GitHub patients/ klasöründe saklaniyor');
      console.log('- 13+ hafta olan hastalar listede en altta görünür');
      console.log('- Manuel arşivleme sistemi aktif');
    }

    async function uploadToGitHub() {
      const token = document.getElementById('githubToken').value.trim();
      if (!token) { 
        alert('❌ Lütfen önce GitHub API token girin!'); 
        return; 
      }
      
      console.log('  Yeni sisteme göre tüm hastalar kaydediliyor...');
      
      // Yeni sistemi kullan
      await tumHastalariAyriKaydet();
    }

    // --- Eşleşme Yasakları Paneli Fonksiyonları ---
    const ESLESMEME_KURALLARI_KEY = 'lipedem_eslesmeme_kurallari';
    let eslesmemeKurallari = {};

    async function eslesmemeRegeleriPaneliGoster() {
      // Kartları yükle
      if (tariflerKlasoruGorselleri.length === 0) {
        await tariflerKlasoruGorselleriniYukle();
      }
      
      // Kart listesini doldur
      yasakKartListesiniGoster();
      
      // Arama işlevi
      document.getElementById('yasakKartArama').oninput = function() {
        yasakKartListesiniGoster(this.value);
      };
      
      // Eşleşme yasaklarını göster
      eslesmemeListesiniGoster();
      
      document.getElementById('eslesmemePanel').style.display = 'block';
    }

    function eslesmemeRegeleriPaneliGizle() {
      document.getElementById('eslesmemePanel').style.display = 'none';
      document.getElementById('yasakTarifAdi').value = '';
      document.getElementById('yasakKartArama').value = '';
      document.getElementById('eslesmemeStatus').style.display = 'none';
      yasakKartListesiniGoster(''); // Listeyi sıfırla
    }

    function yasakKartListesiniGoster(aramaMetni = '') {
      const div = document.getElementById('yasakKartListesi');
      div.innerHTML = '';
      
      // Filtreleme
      const filtrelenmisKartlar = tariflerKlasoruGorselleri.filter(kart => {
        if (!aramaMetni) return true;
        return kart.name.toLowerCase().includes(aramaMetni.toLowerCase());
      });
      
      filtrelenmisKartlar.forEach(kart => {
        const label = document.createElement('label');
        label.style.cssText = 'display:block; margin:4px 0; cursor:pointer; padding:2px;';
        label.innerHTML = `
          <input type="checkbox" data-kart="${kart.name}" style="margin-right:8px;" />
          ${kart.name}
        `;
        div.appendChild(label);
      });
    }

    function eslesmemeStatusGoster(mesaj, tip = 'info') {
      const statusDiv = document.getElementById('eslesmemeStatus');
      statusDiv.style.display = 'block';
      statusDiv.innerHTML = mesaj;
      
      if (tip === 'success') {
        statusDiv.style.background = '#d4edda';
        statusDiv.style.color = '#155724';
        statusDiv.style.border = '1px solid #c3e6cb';
      } else if (tip === 'error') {
        statusDiv.style.background = '#f8d7da';
        statusDiv.style.color = '#721c24';
        statusDiv.style.border = '1px solid #f5c6cb';
      } else {
        statusDiv.style.background = '#d1ecf1';
        statusDiv.style.color = '#0c5460';
        statusDiv.style.border = '1px solid #bee5eb';
      }
    }

    function eslesmemeKuraliEkle() {
      const tarifAdi = document.getElementById('yasakTarifAdi').value.trim();
      const checkboxes = document.querySelectorAll('#yasakKartListesi input[type="checkbox"]:checked');
      const secilenKartlar = Array.from(checkboxes).map(cb => cb.getAttribute('data-kart'));
      
      if (!tarifAdi) {
        eslesmemeStatusGoster('Yemek adı boş olamaz!', 'error');
        return;
      }
      
      if (secilenKartlar.length === 0) {
        eslesmemeStatusGoster('En az bir kart seçmelisiniz!', 'error');
        return;
      }
      
      // Normalize et
      function normalizeLocal(str) {
        return str
          .toLowerCase()
          .replace(/ç/g, 'c').replace(/ğ/g, 'g').replace(/ş/g, 's')
          .replace(/ü/g, 'u').replace(/ö/g, 'o').replace(/ı/g, 'i')
          .replace(/i̇/g, 'i')
          .replace(/[_*\/()]/g, ' ')
          .replace(/\s+/g, ' ')
          .replace(/[^a-z0-9\s]/g, '')
          .trim();
      }
      
      const normalizeEdilmis = normalizeLocal(tarifAdi);
      
      // Kaydet
      eslesmemeKurallari[normalizeEdilmis] = {
        orijinalMetin: tarifAdi,
        yasakliKartlar: secilenKartlar,
        eklemeTarihi: new Date().toISOString()
      };
      
      eslesmemeKurallariniKaydet();
      eslesmemeListesiniGoster();
      
      eslesmemeStatusGoster(`✅ Yasak eklendi! "${tarifAdi}" → ${secilenKartlar.length} kart yasaklandı`, 'success');
      
      // Formu temizle
      document.getElementById('yasakTarifAdi').value = '';
      document.querySelectorAll('#yasakKartListesi input[type="checkbox"]').forEach(cb => cb.checked = false);
    }

    function eslesmemeKurallariniKaydet() {
      try {
        localStorage.setItem(ESLESMEME_KURALLARI_KEY, JSON.stringify(eslesmemeKurallari));
        
        // Hemen render'ı güncelle - yeni kurallar ile
        console.log('🔄 Eşleşme kuralları güncellendi, render güncelleniyor...');
        
        // 1. Eşleşmeyen tarifler listesini güncelle
        setTimeout(() => {
          eslesmeyenlerListesiniGuncelle();
        }, 300);
        
        // 2. Aktif hafta için eşleşen kartları yeniden kontrol et
        setTimeout(() => {
          if (typeof window.seciliHasta !== 'undefined' && window.seciliHasta) {
            otomatikEsleHafta();
          }
        }, 800);
        
        // 3. Sidebar'daki kartları güncelle
        setTimeout(() => {
          if (typeof window.aktifHaftaIndex !== 'undefined' && window.aktifHaftaIndex !== null) {
            gosterEslesenKartlarSidebar(window.aktifHaftaIndex);
          }
        }, 1200);
        
        // 4. Yemek veritabanı analizini güncelle
        setTimeout(() => {
          updateYemekVeritabaniAnalizi();
        }, 1500);
        
        // Otomatik GitHub kaydı (token varsa)
        const token = document.getElementById('githubToken').value.trim();
        if (token && Object.keys(eslesmemeKurallari).length > 0) {
          // 2 saniye bekle sonra otomatik kaydet
          setTimeout(() => {
            eslesmemeKurallariniGitHubKaydet(true); // true = sessiz kaydetme
          }, 2000);
        }
      } catch(e) {
        console.error('Eşleşme yasakları kaydetme hatası:', e);
      }
    }

    function eslesmemeKurallariniYukle() {
      try {
        const data = localStorage.getItem(ESLESMEME_KURALLARI_KEY);
        if (data) {
          eslesmemeKurallari = JSON.parse(data);
        }
      } catch(e) {
        console.error('Eşleşme yasakları yükleme hatası:', e);
        eslesmemeKurallari = {};
      }
    }

    function eslesmemeKurallariniTemizle() {
      if (!confirm('Tüm eşleşme yasaklarını silmek istediğinize emin misiniz?')) return;
      
      eslesmemeKurallari = {};
      eslesmemeKurallariniKaydet();
      eslesmemeListesiniGoster();
      eslesmemeStatusGoster('Tüm eşleşme yasakları temizlendi.', 'success');
    }

    function eslesmemeListesiniGoster() {
      const div = document.getElementById('eslesmemeListesi');
      div.innerHTML = '';
      
      const anahtarlar = Object.keys(eslesmemeKurallari);
      if (anahtarlar.length === 0) {
        div.innerHTML = '<em>Henüz yasak yok</em>';
        return;
      }
      
      anahtarlar.forEach(anahtar => {
        const yasak = eslesmemeKurallari[anahtar];
        const yasakDiv = document.createElement('div');
        yasakDiv.style.cssText = 'border:1px solid #ddd; margin:8px 0; padding:8px; background:#fff; border-radius:4px;';
        yasakDiv.innerHTML = `
          <div style="font-weight:bold; color:#dc3545;">${yasak.orijinalMetin}</div>
          <div style="margin:5px 0; font-size:0.9em;">🚫 ${yasak.yasakliKartlar.join(', ')}</div>
          <button onclick="eslesmemeKuraliSil('${anahtar}')" style="background:#dc3545; color:white; border:none; padding:4px 8px; border-radius:3px; font-size:0.8em; cursor:pointer;">Sil</button>
        `;
        div.appendChild(yasakDiv);
      });
    }

    function eslesmemeKuraliSil(anahtar) {
      if (!confirm('Bu yasağı silmek istediğinize emin misiniz?')) return;
      
      delete eslesmemeKurallari[anahtar];
      eslesmemeKurallariniKaydet();
      eslesmemeListesiniGoster();
      eslesmemeStatusGoster('Yasak silindi.', 'success');
    }

    // --- Satır Bölme Kuralları (Kalıcı) ---
    const SPLIT_KURALLARI_KEY = 'lipedem_split_kurallari';
    let splitKurallari = {};

    function splitNormalize(str) {
      try {
        return (str || '')
          .toLowerCase()
          .replace(/ç/g, 'c').replace(/ğ/g, 'g').replace(/ş/g, 's')
          .replace(/ü/g, 'u').replace(/ö/g, 'o').replace(/ı/g, 'i')
          .replace(/i̇/g, 'i')
          .replace(/[_*\/()]/g, ' ')
          .replace(/\s+/g, ' ')
          .replace(/[^a-z0-9\s]/g, '')
          .trim();
      } catch { return (str || '').toLowerCase().trim(); }
    }

    function splitKurallariniYukle() {
      try {
        const data = localStorage.getItem(SPLIT_KURALLARI_KEY);
        if (data) splitKurallari = JSON.parse(data) || {};
        else splitKurallari = {};
      } catch(e) {
        console.warn('Split kuralları yüklenemedi:', e);
        splitKurallari = {};
      }
    }

    function splitKurallariniKaydet(sessiz = true) {
      try {
        localStorage.setItem(SPLIT_KURALLARI_KEY, JSON.stringify(splitKurallari));
        const token = document.getElementById('githubToken').value.trim();
        if (token && Object.keys(splitKurallari).length > 0) {
          // kısa bir gecikme ile sessiz GitHub kaydı
          setTimeout(() => { splitKurallariniGitHubKaydet(true); }, 1500);
        }
        if (!sessiz) console.log('✅ Split kuralları kaydedildi');
      } catch(e) {
        console.error('Split kuralları kaydedilemedi:', e);
      }
    }

    async function splitKurallariniGitHubKaydet(sessizKaydetme = false) {
      const token = document.getElementById('githubToken').value.trim();
      if (!token) { if (!sessizKaydetme) alert('GitHub API token gerekli!'); return; }

      const owner = 'mustafasacar35';
      const repo = 'lipodem-takip-paneli-4';
      const path = 'data/split_kurallari.json';
      const branch = 'main';

      try {
        // mevcut dosya SHA
        let sha = undefined;
        try {
          const resp = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}?ref=${branch}`, {
            headers: { Authorization: `token ${token}` }
          });
          if (resp.ok) { const data = await resp.json(); sha = data.sha; }
        } catch(e) {}

        const kayitVerisi = { version: '1.0', sonGuncelleme: new Date().toISOString(), kurallar: splitKurallari };
        const content = encodeUTF8ToBase64(kayitVerisi);

        const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, {
          method: 'PUT',
          headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: 'Split kuralları güncellendi', content, branch, sha })
        });

        if (res.ok) {
          localStorage.setItem('lastGithubUpdate', Date.now().toString());
          if (!sessizKaydetme) console.log('✅ Split kuralları GitHub\'a kaydedildi');
        } else {
          throw new Error(await res.text());
        }
      } catch (error) {
        console.error('Split kuralları GitHub kaydetme hatası:', error);
        if (!sessizKaydetme) alert('GitHub split kaydetme hatası: ' + error.message);
      }
    }

    async function splitKurallariniGitHubYukle(sessizYukleme = false) {
      const token = document.getElementById('githubToken').value.trim();
      if (!token) { if (!sessizYukleme) alert('GitHub API token gerekli!'); return; }

      const owner = 'mustafasacar35';
      const repo = 'lipodem-takip-paneli-4';
      const path = 'data/split_kurallari.json';
      const branch = 'main';

      try {
        const resp = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}?ref=${branch}`, {
          headers: { Authorization: `token ${token}` }
        });
        if (resp.ok) {
          const data = await resp.json();
          const jsonContent = decodeBase64UTF8(data.content);
          const parsed = JSON.parse(jsonContent);
          splitKurallari = parsed.kurallar || parsed || {};
          localStorage.setItem(SPLIT_KURALLARI_KEY, JSON.stringify(splitKurallari));
          localStorage.setItem('lastGithubUpdate', Date.now().toString());
          if (!sessizYukleme) console.log('✅ Split kuralları GitHub\'dan yüklendi:', Object.keys(splitKurallari).length);
        } else if (resp.status === 404) {
          if (!sessizYukleme) console.log('ℹ️ GitHub\'da split kuralları dosyası bulunamadı');
        } else {
          throw new Error('GitHub\'dan split okuma başarısız: ' + resp.status);
        }
      } catch (error) {
        console.error('Split kuralları yükleme hatası:', error);
        if (!sessizYukleme) alert('Split kuralları yüklenemedi: ' + error.message);
      }
    }

    function splitKuraliEkle(orijinalMetin, ciktiSatirlari) {
      const key = splitNormalize(orijinalMetin);
      if (!key) return null;
      const temizCiktilar = (ciktiSatirlari || []).map(s => (s || '').trim()).filter(Boolean);
      if (temizCiktilar.length === 0) return null;
      splitKurallari[key] = {
        orijinalMetin,
        ciktilar: temizCiktilar,
        eklemeTarihi: new Date().toISOString()
      };
      splitKurallariniKaydet(true);
      return key;
    }

    function applySplitKurallariToList(lines) {
      if (!Array.isArray(lines) || Object.keys(splitKurallari).length === 0) return lines;
      const finalList = [];
      for (const line of lines) {
        const key = splitNormalize(line);
        const kural = splitKurallari[key];
        if (kural && Array.isArray(kural.ciktilar) && kural.ciktilar.length) {
          // Kurala göre satırı böl ve ekle (küçük harfe normalize ederek)
          finalList.push(...kural.ciktilar.map(s => (s || '').trim().toLowerCase()).filter(Boolean));
        } else {
          finalList.push(line);
        }
      }
      return finalList;
    }

    // GitHub entegrasyonu için fonksiyonlar
    async function eslesmemeKurallariniGitHubKaydet(sessizKaydetme = false) {
      const token = document.getElementById('githubToken').value.trim();
      if (!token) {
        if (!sessizKaydetme) {
          alert('GitHub API token gerekli!');
        }
        return;
      }

      const owner = 'mustafasacar35';
      const repo = 'lipodem-takip-paneli-4';
      const path = 'data/eslesmeme_kurallari.json';
      const branch = 'main';

      try {
        if (!sessizKaydetme) {
          eslesmemeStatusGoster('GitHub\'a kaydediliyor...', 'info');
        }

        // Önce mevcut dosyanın SHA'sını al
        let sha = undefined;
        try {
          const resp = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}?ref=${branch}`, {
            headers: { Authorization: `token ${token}` }
          });
          if (resp.ok) {
            const data = await resp.json();
            sha = data.sha;
          }
        } catch (e) {}

        // Veriyi hazırla
        const kayitVerisi = {
          version: '1.0',
          sonGuncelleme: new Date().toISOString(),
          eslesmemeKurallari: eslesmemeKurallari
        };

        // UTF-8 için doğru encoding
        const content = encodeUTF8ToBase64(kayitVerisi);

        // Dosyayı yükle
        const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, {
          method: 'PUT',
          headers: {
            'Authorization': `token ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            message: 'Eşleşme yasakları güncellendi',
            content,
            branch,
            sha
          })
        });

        if (res.ok) {
          // Cache timestamp'ini güncelle
          localStorage.setItem('lastGithubUpdate', Date.now().toString());
          if (!sessizKaydetme) {
            eslesmemeStatusGoster('✅ GitHub\'a başarıyla kaydedildi!', 'success');
          }
        } else {
          throw new Error('GitHub kaydı başarısız: ' + (await res.text()));
        }

      } catch (error) {
        console.error('GitHub kaydetme hatası:', error);
        if (!sessizKaydetme) {
          eslesmemeStatusGoster(`❌ GitHub kaydetme hatası: ${error.message}`, 'error');
        }
      }
    }

    async function eslesmemeKurallariniGitHubYukle(sessizYukleme = false) {
      const token = document.getElementById('githubToken').value.trim();
      if (!token) {
        if (!sessizYukleme) {
          alert('GitHub API token gerekli!');
        }
        return;
      }

      const owner = 'mustafasacar35';
      const repo = 'lipodem-takip-paneli-4';
      const path = 'data/eslesmeme_kurallari.json';
      const branch = 'main';

      try {
        if (!sessizYukleme) {
          eslesmemeStatusGoster('GitHub\'dan yükleniyor...', 'info');
        }

        const resp = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}?ref=${branch}`, {
          headers: { Authorization: `token ${token}` }
        });

        if (resp.ok) {
          const data = await resp.json();
          const jsonContent = decodeBase64UTF8(data.content);
          const kayitVerisi = JSON.parse(jsonContent);
          
          // Eski format kontrolü
          if (kayitVerisi.eslesmemeKurallari) {
            eslesmemeKurallari = kayitVerisi.eslesmemeKurallari;
          } else {
            // Eski format (direkt object)
            eslesmemeKurallari = kayitVerisi;
          }
          
          // LocalStorage'a da kaydet
          localStorage.setItem(ESLESMEME_KURALLARI_KEY, JSON.stringify(eslesmemeKurallari));
          
          // Cache timestamp'ini güncelle
          localStorage.setItem('lastGithubUpdate', Date.now().toString());
          
          // Listeyi güncelle (eğer panel açıksa)
          if (document.getElementById('eslesmemePanel').style.display !== 'none') {
            eslesmemeListesiniGoster();
          }

          if (!sessizYukleme) {
            const kuralSayisi = Object.keys(eslesmemeKurallari).length;
            eslesmemeStatusGoster(`✅ GitHub'dan ${kuralSayisi} yasak yüklendi!`, 'success');
          } else {
            const kuralSayisi = Object.keys(eslesmemeKurallari).length;
            console.log(`Eşleşme yasakları GitHub'dan güncellendi: ${kuralSayisi} adet`);
          }

        } else if (resp.status === 404) {
          // Dosya henüz yok, normal
          if (!sessizYukleme) {
            eslesmemeStatusGoster('ℹ️ GitHub\'da henüz yasak dosyası yok', 'info');
          }
        } else {
          throw new Error('GitHub\'dan okuma başarısız: ' + resp.status);
        }

      } catch (error) {
        console.error('GitHub yükleme hatası:', error);
        if (!sessizYukleme) {
          eslesmemeStatusGoster(`❌ GitHub yükleme hatası: ${error.message}`, 'error');
        }
      }
    }

    // --- Manuel Eşleştirme Paneli Fonksiyonları ---
    const MANUEL_ESLESTIRME_KEY = 'lipedem_manuel_eslestirmeler';
    let manuelEslestirmeler = {};

    // Global karakter düzeltme fonksiyonu
    function karakterDuzelt(text) {
      if (!text) return text;
      return text
        .replace(/Ä±/g, 'ı')
        .replace(/Ä/g, 'ğ') 
        .replace(/Å/g, 'ş')
        .replace(/Ğ/g, 'ğ')
        .replace(/Ã¼/g, 'ü')
        .replace(/Ã¶/g, 'ö')
        .replace(/Ã§/g, 'ç')
        .replace(/â/g, 'a')
        .replace(/î/g, 'i')
        .replace(/û/g, 'u')
        .replace(/ô/g, 'o');
    }

    // Normalize fonksiyonu - Manuel eşleştirme için
    function normalize(str) {
      return str
        .toLowerCase()
        .replace(/ç/g, 'c').replace(/ğ/g, 'g').replace(/ş/g, 's')
        .replace(/ü/g, 'u').replace(/ö/g, 'o').replace(/ı/g, 'i')
        .replace(/i̇/g, 'i')
        .replace(/[_*\/()]/g, ' ')  // Sembolleri boşlukla değiştir
        .replace(/\s+/g, ' ')       // Çoklu boşlukları tek boşluğa çevir
        .replace(/[^a-z0-9\s]/g, '') // Sadece harf, rakam ve boşluk bırak
        .trim();
    }

    function manuelEslestirmeleriYukle() {
      try {
        const data = localStorage.getItem(MANUEL_ESLESTIRME_KEY);
        if (data) {
          manuelEslestirmeler = JSON.parse(data);
        }
      } catch(e) {
        console.error('Manuel eşleştirme yükleme hatası:', e);
        manuelEslestirmeler = {};
      }
    }

    // Kaydetme throttle değişkenleri
    let kaydetmeZamanlayicisi = null;
    let gitHubKaydetmeDevamEdiyor = false;
    let sonKaydetmeZamani = 0;

    function manuelEslestirmeleriKaydet() {
      try {
        localStorage.setItem(MANUEL_ESLESTIRME_KEY, JSON.stringify(manuelEslestirmeler));
        console.log('📁 Manuel eşleştirmeler localStorage\'a kaydedildi');
        
        // Hemen render'ı güncelle - yeni eşleştirmeler ile
        console.log('🔄 Manuel eşleştirme kaydedildi, render güncelleniyor...');
        
        // 1. Eşleşmeyen tarifler listesini güncelle
        setTimeout(() => {
          eslesmeyenlerListesiniGuncelle();
        }, 300);
        
        // 2. Aktif hafta için eşleşen kartları yeniden kontrol et
        setTimeout(() => {
          if (typeof window.seciliHasta !== 'undefined' && window.seciliHasta) {
            otomatikEsleHafta();
          }
        }, 800);
        
        // 3. Sidebar'daki kartları güncelle
        setTimeout(() => {
          if (typeof window.aktifHaftaIndex !== 'undefined' && window.aktifHaftaIndex !== null) {
            gosterEslesenKartlarSidebar(window.aktifHaftaIndex);
          }
        }, 1200);
        
        // 4. Yemek veritabanı analizini güncelle
        setTimeout(() => {
          updateYemekVeritabaniAnalizi();
        }, 1500);
        
        // Otomatik GitHub kaydı (token varsa)
        const token = document.getElementById('githubToken').value.trim();
        if (token && Object.keys(manuelEslestirmeler).length > 0) {
          const simdikiZaman = Date.now();
          const sonKaydetmedenGecenZaman = simdikiZaman - sonKaydetmeZamani;
          
          // Mevcut zamanlayıcıyı iptal et
          if (kaydetmeZamanlayicisi) {
            clearTimeout(kaydetmeZamanlayicisi);
            console.log('🔄 Önceki kaydetme zamanlayıcısı iptal edildi');
          }
          
          // Eğer son kaydetmeden 10 saniye geçmemişse, daha fazla bekle
          const beklemeZamani = sonKaydetmedenGecenZaman < 10000 ? 5000 : 3000;
          
          // Yeni zamanlayıcı başlat
          kaydetmeZamanlayicisi = setTimeout(async () => {
            if (!gitHubKaydetmeDevamEdiyor) {
              console.log(`⏰ Zamanlayıcı tetiklendi (${beklemeZamani}ms bekledikten sonra), GitHub\'a kaydediliyor...`);
              sonKaydetmeZamani = Date.now();
              await manuelEslestirmeleriGitHubKaydet(true); // true = sessiz kaydetme
            } else {
              console.log('⚠️ GitHub kaydetme devam ediyor, atlandı');
            }
            kaydetmeZamanlayicisi = null;
          }, beklemeZamani);
          
          console.log(`⏰ GitHub kaydetme ${beklemeZamani}ms sonra yapılacak`);
        }
      } catch(e) {
        console.error('Manuel eşleştirme kaydetme hatası:', e);
      }
    }

    async function manuelEslestirmePaneliGoster() {
      // Kartları yükle
      if (tariflerKlasoruGorselleri.length === 0) {
        await tariflerKlasoruGorselleriniYukle();
      }
      
      // Kart listesini doldur
      manuelKartListesiniGoster();
      
      // Arama işlevi
      document.getElementById('manuelKartArama').oninput = function() {
        manuelKartListesiniGoster(this.value);
      };
      
      // Manuel eşleştirmeleri göster (zaten yüklü olmalı)
      manuelEslestirmeListesiniGoster();
      
      document.getElementById('manuelEslestirmePanel').style.display = 'block';
    }

    // Eşleşmeyen tariften direkt manuel eşleştirme
    async function eslesmeyenTarifManuelEslestir(tarifAdi) {
      console.log('🔗 Eşleşmeyen tarif için manuel eşleştirme başlatılıyor:', tarifAdi);
      
      // Manuel eşleştirme panelini göster
      await manuelEslestirmePaneliGoster();
      
      // Sol kutucuğa tarif adını doldur
      const yeniTarifInput = document.getElementById('manuelTarifAdi');
      if (yeniTarifInput) {
        yeniTarifInput.value = tarifAdi;
        yeniTarifInput.focus();
      }
      
      // Sağ tarafta arama kutucuğunu temizle (kullanıcı arayacak)
      const kartAramaInput = document.getElementById('eskiKartArama');
      if (kartAramaInput) {
        kartAramaInput.value = '';
        kartAramaInput.placeholder = `"${tarifAdi}" için eşleşecek kartı ara...`;
      }
      
      // Kullanıcıya bilgilendirme
      const statusDiv = document.getElementById('manuelEslestirmeStatus');
      if (statusDiv) {
        statusDiv.style.display = 'block';
        statusDiv.style.background = '#d1ecf1';
        statusDiv.style.color = '#0c5460';
        statusDiv.style.border = '1px solid #bee5eb';
        statusDiv.innerHTML = `
          <strong>🎯 Eşleşmeyen Tarif Seçildi:</strong> "${tarifAdi}"<br>
          <small>Sağdaki arama kutusundan uygun kartı bulup eşleştirin. Eşleştirme sonrası bu tarif "Eşleşmeyenler" listesinden kaldırılacak.</small>
        `;
      }
    }

    // Eşleşen tariften direkt manuel eşleştirme (düzenleme için)
    async function eslesenTarifManuelEslestir(tarifAdi, eslesenKartlar) {
      console.log('🔧 Eşleşen tarif için manuel eşleştirme düzenleme başlatılıyor:', tarifAdi, eslesenKartlar);
      
      // Manuel eşleştirme panelini göster
      await manuelEslestirmePaneliGoster();
      
      // Sol kutucuğa tarif adını doldur
      const yeniTarifInput = document.getElementById('manuelTarifAdi');
      if (yeniTarifInput) {
        yeniTarifInput.value = tarifAdi;
      }
      
      // Sağ tarafta arama kutucuğunu temizle
      const kartAramaInput = document.getElementById('eskiKartArama');
      if (kartAramaInput) {
        kartAramaInput.value = '';
        kartAramaInput.placeholder = `"${tarifAdi}" için eşleşecek kartları düzenle...`;
      }
      
      // Eşleşen kartları otomatik seç
      setTimeout(() => {
        const kartCheckboxes = document.querySelectorAll('#manuelKartListesi input[type="checkbox"]');
        const secilenKartIsimleri = eslesenKartlar.map(kart => kart.name || kart.kartResmi);
        
        kartCheckboxes.forEach(checkbox => {
          const kartAdi = checkbox.getAttribute('data-kart');
          if (secilenKartIsimleri.includes(kartAdi)) {
            checkbox.checked = true;
            console.log('✅ Kart otomatik seçildi:', kartAdi);
          }
        });
        
        console.log('🎯 Otomatik seçilen kartlar:', secilenKartIsimleri);
      }, 500); // Kartların yüklenmesi için kısa bir bekleme
      
      // Kullanıcıya bilgilendirme
      const statusDiv = document.getElementById('manuelEslestirmeStatus');
      if (statusDiv) {
        statusDiv.style.display = 'block';
        statusDiv.style.background = '#d4edda';
        statusDiv.style.color = '#155724';
        statusDiv.style.border = '1px solid #c3e6cb';
        statusDiv.innerHTML = `
          <strong>🔧 Eşleşen Tarif Düzenleniyor:</strong> "${tarifAdi}"<br>
          <small>Mevcut eşleşen kartlar otomatik seçildi. İstediğiniz değişiklikleri yapıp kaydedin.</small>
        `;
      }
    }

    // Manuel eşleştirme paneli için dinamik kart arama
    function manuelEslestirmeKartAra(aramaMetni) {
      console.log('🔍 Manuel eşleştirme kart arama:', aramaMetni);
      manuelKartListesiniGoster(aramaMetni);
    }

    function manuelKartListesiniGoster(aramaMetni = '') {
      const div = document.getElementById('manuelKartListesi');
      div.innerHTML = '';

      console.log('🔍 Manuel kart listesi gösteriliyor, arama metni:', aramaMetni);
      
      // Arama metnini kelimelere ayır ve türkçe karakterleri normalize et
      const aramaKelimeleri = aramaMetni.trim().split(/\s+/).filter(k => k.length > 0)
        .map(kelime => karakterDuzelt(kelime.toLowerCase()));
      
      console.log('🔍 Arama kelimeleri:', aramaKelimeleri);
      
      // Filtreleme fonksiyonu
      function kartEslesiyorMu(kartAdi) {
        if (aramaKelimeleri.length === 0) return true;
        
        const kartMetni = karakterDuzelt(kartAdi.toLowerCase())
          .replace(/\.(jpg|jpeg|png)$/i, '') // dosya uzantısını kaldır
          .replace(/_/g, ' '); // alt çizgileri boşluğa çevir
        
        // Tüm arama kelimelerinin kart adında bulunup bulunmadığını kontrol et
        const eslesiyor = aramaKelimeleri.every(kelime => kartMetni.includes(kelime));
        
        if (aramaKelimeleri.length > 0) {
          console.log(`🔎 "${kartAdi}" → "${kartMetni}" eşleşme: ${eslesiyor}`);
        }
        
        return eslesiyor;
      }
      
      // Filtreleme
      const filtrelenmisKartlar = tariflerKlasoruGorselleri.filter(kart => 
        kartEslesiyorMu(kart.name)
      );
      
      console.log(`📋 Filtrelenmiş kart sayısı: ${filtrelenmisKartlar.length}`);
      
      // Sonuçları eşleşme skoruna göre sırala
      if (aramaKelimeleri.length > 0) {
        filtrelenmisKartlar.sort((a, b) => {
          const aAdi = karakterDuzelt(a.name.toLowerCase()).replace(/\.(jpg|jpeg|png)$/i, '').replace(/_/g, ' ');
          const bAdi = karakterDuzelt(b.name.toLowerCase()).replace(/\.(jpg|jpeg|png)$/i, '').replace(/_/g, ' ');
          
          // Tam arama metni eşleşmesi
          const aramaTam = aramaKelimeleri.join(' ');
          const aIceriyor = aAdi.includes(aramaTam);
          const bIceriyor = bAdi.includes(aramaTam);
          
          if (aIceriyor && !bIceriyor) return -1;
          if (!aIceriyor && bIceriyor) return 1;
          
          // Başlangıç eşleşmesi
          const aBaslangic = aramaKelimeleri.some(kelime => aAdi.startsWith(kelime));
          const bBaslangic = aramaKelimeleri.some(kelime => bAdi.startsWith(kelime));
          
          if (aBaslangic && !bBaslangic) return -1;
          if (!aBaslangic && bBaslangic) return 1;
          
          // Alfabetik sıralama
          return a.name.localeCompare(b.name, 'tr-TR');
        });
      }
      
      filtrelenmisKartlar.forEach(kart => {
        const label = document.createElement('label');
        label.style.cssText = 'display:block; margin:4px 0; cursor:pointer; padding:2px;';
        
        const duzeltilmisKartAdi = kart.name; // Artık karakterDuzelt global fonksiyonu kullanılıyor
        
        label.innerHTML = `
          <input type="checkbox" data-kart="${kart.name}" style="margin-right:8px;" />
          ${duzeltilmisKartAdi}
        `;
        div.appendChild(label);
      });
    }

    function manuelEslestirmePaneliGizle() {
      const panel = document.getElementById('manuelEslestirmePanel');
      const tarifAdi = document.getElementById('manuelTarifAdi');
      const kartSecimi = document.getElementById('manuelKartSecimi');
      const status = document.getElementById('manuelEslestirmeStatus');
      
      if (panel) panel.style.display = 'none';
      if (tarifAdi) tarifAdi.value = '';
      if (kartSecimi) kartSecimi.selectedIndex = -1;
      if (status) status.style.display = 'none';
      
      // Panel kapandığında render'ı güncelle (eğer değişiklik yapıldıysa)
      console.log('🔄 Manuel eşleştirme paneli kapandı, hafif güncelleme...');
      setTimeout(() => {
        if (typeof window.aktifHaftaIndex !== 'undefined' && window.aktifHaftaIndex !== null) {
          gosterEslesenKartlarSidebar(window.aktifHaftaIndex);
        }
      }, 500);
    }

    function manuelEslestirmeStatusGoster(mesaj, tip = 'info') {
      const statusDiv = document.getElementById('manuelEslestirmeStatus');
      statusDiv.style.display = 'block';
      statusDiv.innerHTML = mesaj;
      
      if (tip === 'success') {
        statusDiv.style.background = '#d4edda';
        statusDiv.style.color = '#155724';
        statusDiv.style.border = '1px solid #c3e6cb';
      } else if (tip === 'error') {
        statusDiv.style.background = '#f8d7da';
        statusDiv.style.color = '#721c24';
        statusDiv.style.border = '1px solid #f5c6cb';
      } else {
        statusDiv.style.background = '#d1ecf1';
        statusDiv.style.color = '#0c5460';
        statusDiv.style.border = '1px solid #bee5eb';
      }
    }

    function manuelEslestirmeEkle() {
      const tarifAdi = document.getElementById('manuelTarifAdi').value.trim();
      const checkboxes = document.querySelectorAll('#manuelKartListesi input[type="checkbox"]:checked');
      const secilenKartlar = Array.from(checkboxes).map(cb => cb.getAttribute('data-kart'));
      
      if (!tarifAdi) {
        manuelEslestirmeStatusGoster('Yemek adı boş olamaz!', 'error');
        return;
      }
      
      if (secilenKartlar.length === 0) {
        manuelEslestirmeStatusGoster('En az bir kart seçmelisiniz!', 'error');
        return;
      }
      
      // Normalize et - fonksiyonu burada tanımla
      function normalizeLocal(str) {
        return str
          .toLowerCase()
          .replace(/ç/g, 'c').replace(/ğ/g, 'g').replace(/ş/g, 's')
          .replace(/ü/g, 'u').replace(/ö/g, 'o').replace(/ı/g, 'i')
          .replace(/i̇/g, 'i')
          .replace(/[_*\/()]/g, ' ')  // Sembolleri boşlukla değiştir
          .replace(/\s+/g, ' ')       // Çoklu boşlukları tek boşluğa çevir
          .replace(/[^a-z0-9\s]/g, '') // Sadece harf, rakam ve boşluk bırak
          .trim();
      }
      
      const normalizeEdilmis = normalizeLocal(tarifAdi);
      
      // Kaydet
      manuelEslestirmeler[normalizeEdilmis] = {
        orijinalMetin: tarifAdi,
        kartlar: secilenKartlar,
        eklemeTarihi: new Date().toISOString()
      };
      
      manuelEslestirmeleriKaydet();
      manuelEslestirmeListesiniGoster();

      // Karakter düzeltme fonksiyonu
      function karakterDuzelt(text) {
        if (!text) return text;
        return text
          .replace(/Ä±/g, 'ı')
          .replace(/Ä/g, 'ğ') 
          .replace(/Å/g, 'ş')
          .replace(/Ğ/g, 'ğ')
          .replace(/Ã¼/g, 'ü')
          .replace(/Ã¶/g, 'ö')
          .replace(/Ã§/g, 'ç')
          .replace(/â/g, 'a')
          .replace(/î/g, 'i')
          .replace(/û/g, 'u')
          .replace(/ô/g, 'o');
      }
      
      const duzeltilmisMetin = karakterDuzelt(tarifAdi);
      manuelEslestirmeStatusGoster(`✅ Eşleştirme eklendi! "${duzeltilmisMetin}" → ${secilenKartlar.length} kart`, 'success');
      
      // Eşleşmeyenler listesini güncelle - eklenen tarifi kaldır
      eslesmeyenlerListesiniGuncelle();
      
      // Formu temizle
      document.getElementById('manuelTarifAdi').value = '';
      document.querySelectorAll('#manuelKartListesi input[type="checkbox"]').forEach(cb => cb.checked = false);
    }

    function manuelEslestirmeleriTemizle() {
      if (!confirm('Tüm manuel eşleştirmeleri silmek istediğinize emin misiniz?')) return;
      
      manuelEslestirmeler = {};
      manuelEslestirmeleriKaydet();
      manuelEslestirmeListesiniGoster();
      manuelEslestirmeStatusGoster('Tüm manuel eşleştirmeler temizlendi.', 'success');
    }

    function manuelEslestirmeListesiniGoster() {
      const div = document.getElementById('manuelEslestirmeListesi');
      div.innerHTML = '';
      
      const anahtarlar = Object.keys(manuelEslestirmeler);
      if (anahtarlar.length === 0) {
        div.innerHTML = '<em>Henüz manuel eşleştirme yok</em>';
        return;
      }

    function manuelEslestirmeSil(anahtar) {
      console.log('🗑️ Silme işlemi başlatıldı, anahtar:', anahtar);
      
      if (!confirm('Bu eşleştirmeyi silmek istediğinize emin misiniz?')) {
        console.log('❌ Kullanıcı silme işlemini iptal etti');
        return;
      }
      
      console.log('✅ Kullanıcı silme işlemini onayladı');
      delete manuelEslestirmeler[anahtar];
      manuelEslestirmeleriKaydet();
      manuelEslestirmeListesiniGoster();
      manuelEslestirmeStatusGoster('Eşleştirme silindi.', 'success');
      
      // Eşleştirme silindiğinde eşleşmeyenler listesini güncelle
      eslesmeyenlerListesiniGuncelle();
      console.log('🔄 Silme işlemi tamamlandı');
    }

    function manuelEslestirmeListesiniGoster() {
      const div = document.getElementById('manuelEslestirmeListesi');
      div.innerHTML = '';
      
      const anahtarlar = Object.keys(manuelEslestirmeler);
      if (anahtarlar.length === 0) {
        div.innerHTML = '<em>Henüz manuel eşleştirme yok</em>';
        return;
      }

      // Karakter düzeltme fonksiyonu
      function karakterDuzelt(text) {
        if (!text) return text;
        return text
          .replace(/Ä±/g, 'ı')
          .replace(/Ä/g, 'ğ') 
          .replace(/Å/g, 'ş')
          .replace(/Ğ/g, 'ğ')
          .replace(/Ã¼/g, 'ü')
          .replace(/Ã¶/g, 'ö')
          .replace(/Ã§/g, 'ç')
          .replace(/â/g, 'a')
          .replace(/î/g, 'i')
          .replace(/û/g, 'u')
          .replace(/ô/g, 'o');
      }
      
      anahtarlar.forEach(anahtar => {
        const eslestirme = manuelEslestirmeler[anahtar];
        const eslestirmeDiv = document.createElement('div');
        eslestirmeDiv.style.cssText = 'border:1px solid #ddd; margin:8px 0; padding:8px; background:#fff; border-radius:4px;';
        
        // Orijinal metni ve kartları düzelt
        const duzeltilmisMetin = karakterDuzelt(eslestirme.orijinalMetin);
        const duzeltilmisKartlar = eslestirme.kartlar.map(kart => karakterDuzelt(kart));
        
        eslestirmeDiv.innerHTML = `
          <div style="font-weight:bold; color:#28a745;">${duzeltilmisMetin}</div>
          <div style="margin:5px 0; font-size:0.9em;">→ ${duzeltilmisKartlar.join(', ')}</div>
          <div style="display:flex; gap:8px; margin-top:5px;">
            <button class="duzenle-btn" style="background:#17a2b8; color:white; border:none; padding:4px 8px; border-radius:3px; font-size:0.8em; cursor:pointer;">✏️ Düzenle</button>
            <button class="sil-btn" style="background:#dc3545; color:white; border:none; padding:4px 8px; border-radius:3px; font-size:0.8em; cursor:pointer;">🗑️ Sil</button>
          </div>
        `;
        
        // Event listener'ları güvenli şekilde ekle
        const duzenleBtn = eslestirmeDiv.querySelector('.duzenle-btn');
        const silBtn = eslestirmeDiv.querySelector('.sil-btn');
        
        if (duzenleBtn && silBtn) {
          duzenleBtn.addEventListener('click', () => {
            console.log('🔧 Düzenle butonuna tıklandı, anahtar:', anahtar);
            manuelEslestirmeDuzenle(anahtar);
          });
          
          silBtn.addEventListener('click', () => {
            console.log('🗑️ Sil butonuna tıklandı, anahtar:', anahtar);
            manuelEslestirmeSil(anahtar);
          });
          
          console.log('✅ Event listener\'lar eklendi, anahtar:', anahtar);
        } else {
          console.error('❌ Butonlar bulunamadı!', { duzenleBtn, silBtn });
        }
        
        div.appendChild(eslestirmeDiv);
      });
    }
      manuelEslestirmeleriKaydet();
      manuelEslestirmeListesiniGoster();
      manuelEslestirmeStatusGoster('Eşleştirme silindi.', 'success');
    }

    function manuelEslestirmeDuzenle(anahtar) {
      // Mevcut eşleştirme verilerini al
      const mevcutEslestirme = manuelEslestirmeler[anahtar];
      if (!mevcutEslestirme) {
        alert('Eşleştirme bulunamadı!');
        return;
      }

      // Düzenle modalı oluştur
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
        background: rgba(0,0,0,0.5); z-index: 10000; 
        display: flex; align-items: center; justify-content: center;
      `;

      modal.innerHTML = `
        <div style="background: white; padding: 30px; border-radius: 10px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
          <h3 style="margin-bottom: 20px; color: #17a2b8;">✏️ Manuel Eşleştirme Düzenle</h3>
          
          <div style="margin-bottom: 15px;">
            <label style="display: block; font-weight: bold; margin-bottom: 5px;">Tarif Adı:</label>
            <input type="text" id="duzenleOrijinalMetin" value="${karakterDuzelt(mevcutEslestirme.orijinalMetin)}" 
                   style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
          </div>
          
          <div style="margin-bottom: 20px;">
            <label style="display: block; font-weight: bold; margin-bottom: 5px;">Eşleşen Kartlar (virgülle ayırın):</label>
            <textarea id="duzenleKartlar" rows="4" 
                      style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; resize: vertical;">${mevcutEslestirme.kartlar.map(kart => karakterDuzelt(kart)).join(', ')}</textarea>
            <small style="color: #666;">Örnek: karnıyarık, patlıcan yemeği, et yemeği</small>
          </div>
          
          <div style="display: flex; gap: 10px; justify-content: flex-end; flex-wrap: wrap;">
            <button onclick="manuelEslestirmeDuzenleKaydet('${anahtar}')" 
                    style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 14px;">
              ✅ Kaydet
            </button>
            <button onclick="manuelEslestirmeDuzenleYeniKaydet('${anahtar}')" 
                    style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 14px;">
              ➕ Yeni Kaydet
            </button>
            <button onclick="manuelEslestirmeDuzenleIptal()" 
                    style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 14px;">
              ❌ İptal
            </button>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
      window.currentEditModal = modal;
      
      // İlk input'a odaklan
      setTimeout(() => {
        document.getElementById('duzenleOrijinalMetin').focus();
      }, 100);
    }

    function manuelEslestirmeDuzenleKaydet(eskiAnahtar) {
      const yeniOrijinalMetin = document.getElementById('duzenleOrijinalMetin').value.trim();
      const yeniKartlarMetin = document.getElementById('duzenleKartlar').value.trim();

      if (!yeniOrijinalMetin || !yeniKartlarMetin) {
        alert('Lütfen tüm alanları doldurun!');
        return;
      }

      // Kartları virgülle ayır ve temizle
      const yeniKartlar = yeniKartlarMetin.split(',').map(kart => kart.trim()).filter(kart => kart.length > 0);
      
      if (yeniKartlar.length === 0) {
        alert('En az bir kart adı girmelisiniz!');
        return;
      }

      // Yeni anahtar oluştur
      const yeniAnahtar = normalize(yeniOrijinalMetin);
      
      // Anahtar değişmişse ve yeni anahtar zaten varsa uyar
      if (eskiAnahtar !== yeniAnahtar && manuelEslestirmeler[yeniAnahtar]) {
        if (!confirm('Bu tarif adı zaten mevcut! Mevcut eşleştirmeyi güncellemek istediğinize emin misiniz?')) {
          return;
        }
      }

      // Eski eşleştirmeyi sil (anahtar değişmişse)
      if (eskiAnahtar !== yeniAnahtar) {
        delete manuelEslestirmeler[eskiAnahtar];
      }

      // Yeni eşleştirmeyi kaydet
      manuelEslestirmeler[yeniAnahtar] = {
        orijinalMetin: yeniOrijinalMetin,
        kartlar: yeniKartlar
      };

      // Kaydet ve güncelle
      manuelEslestirmeleriKaydet();
      manuelEslestirmeListesiniGoster();
      manuelEslestirmeDuzenleIptal();
      
      manuelEslestirmeStatusGoster('Eşleştirme başarıyla güncellendi!', 'success');
    }

    function manuelEslestirmeDuzenleYeniKaydet(eskiAnahtar) {
      console.log('➕ Yeni eşleştirme olarak kaydetme başlatıldı, eski anahtar:', eskiAnahtar);
      
      const yeniOrijinalMetin = document.getElementById('duzenleOrijinalMetin').value.trim();
      const yeniKartlarMetin = document.getElementById('duzenleKartlar').value.trim();

      if (!yeniOrijinalMetin || !yeniKartlarMetin) {
        alert('Lütfen tüm alanları doldurun!');
        return;
      }

      // Kartları virgülle ayır ve temizle
      const yeniKartlar = yeniKartlarMetin.split(',').map(kart => kart.trim()).filter(kart => kart.length > 0);
      
      if (yeniKartlar.length === 0) {
        alert('En az bir kart adı girmelisiniz!');
        return;
      }

      // Yeni anahtar oluştur
      function normalize(str) {
        return str
          .toLowerCase()
          .replace(/ç/g, 'c').replace(/ğ/g, 'g').replace(/ş/g, 's')
          .replace(/ü/g, 'u').replace(/ö/g, 'o').replace(/ı/g, 'i')
          .replace(/i̇/g, 'i')
          .replace(/[_*\/()]/g, ' ')
          .replace(/\s+/g, ' ')
          .replace(/[^a-z0-9\s]/g, '')
          .trim();
      }
      
      const yeniAnahtar = normalize(yeniOrijinalMetin);
      
      // Yeni anahtar zaten varsa uyar
      if (manuelEslestirmeler[yeniAnahtar]) {
        if (!confirm('Bu tarif adı zaten mevcut! Mevcut eşleştirmeyi güncellemek istediğinize emin misiniz?')) {
          return;
        }
      }

      // Yeni eşleştirmeyi kaydet (eski eşleştirmeyi silme!)
      manuelEslestirmeler[yeniAnahtar] = {
        orijinalMetin: yeniOrijinalMetin,
        kartlar: yeniKartlar,
        eklemeTarihi: new Date().toISOString()
      };

      // Kaydet ve güncelle
      manuelEslestirmeleriKaydet();
      manuelEslestirmeListesiniGoster();
      manuelEslestirmeDuzenleIptal();
      
      manuelEslestirmeStatusGoster(`✅ Yeni eşleştirme oluşturuldu: "${yeniOrijinalMetin}" → ${yeniKartlar.length} kart`, 'success');
      
      // Eşleşmeyenler listesini güncelle (yeni eşleştirme eklendiğinde)
      eslesmeyenlerListesiniGuncelle();
      
      console.log('✅ Yeni eşleştirme başarıyla oluşturuldu:', yeniAnahtar);
    }

    function manuelEslestirmeDuzenleIptal() {
      if (window.currentEditModal) {
        document.body.removeChild(window.currentEditModal);
        window.currentEditModal = null;
      }
    }

    // Sayfa yüklenirken manuel eşleştirmeleri yükle
    window.addEventListener('DOMContentLoaded', function() {
      // Bu fonksiyon yukarıda initManuelEslestirmeler() ile birleştirildi
      // Çift yüklemeyi önlemek için kaldırıldı
    });

    // GitHub'a manuel eşleştirmeleri kaydetme
    async function manuelEslestirmeleriGitHubKaydet(sessizKaydetme = false) {
      // Zaten kaydetme devam ediyorsa çık
      if (gitHubKaydetmeDevamEdiyor) {
        if (!sessizKaydetme) {
          console.log('⚠️ GitHub kaydetme zaten devam ediyor, işlem atlandı');
        }
        return;
      }
      
      const token = document.getElementById('githubToken').value.trim();
      if (!token) {
        if (!sessizKaydetme) {
          alert('GitHub API token gerekli!');
        }
        return;
      }

      // Kaydetme başladı işaretini koy
      gitHubKaydetmeDevamEdiyor = true;

      const owner = 'mustafasacar35';
      const repo = 'lipodem-takip-paneli-4';
      const path = 'data/manuel_eslestirmeler.json';
      const branch = 'main';

      try {
        if (!sessizKaydetme) {
          manuelEslestirmeStatusGoster('GitHub\'a kaydediliyor...', 'info');
        }

        // Önce mevcut dosyanın SHA'sını al (güncelleme için gerekli)
        let sha = undefined;
        try {
          const resp = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}?ref=${branch}`, {
            headers: { Authorization: `token ${token}` }
          });
          if (resp.ok) {
            const data = await resp.json();
            sha = data.sha;
          }
        } catch (e) {}

        // Veriyi hazırla
        const kayitVerisi = {
          version: '1.0',
          sonGuncelleme: new Date().toISOString(),
          eslestirmeler: manuelEslestirmeler
        };

        // UTF-8 için doğru encoding
        const content = encodeUTF8ToBase64(kayitVerisi);

        // Dosyayı yükle
        const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, {
          method: 'PUT',
          headers: {
            'Authorization': `token ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            message: 'Manuel eşleştirmeler güncellendi',
            content,
            branch,
            sha
          })
        });

        if (res.ok) {
          // Cache timestamp'ini güncelle
          localStorage.setItem('lastGithubUpdate', Date.now().toString());
          if (!sessizKaydetme) {
            manuelEslestirmeStatusGoster('✅ GitHub\'a başarıyla kaydedildi!', 'success');
          }
          console.log('✅ GitHub kaydetme başarılı - durum sıfırlanacak');
        } else {
          throw new Error('GitHub kaydı başarısız: ' + (await res.text()));
        }

      } catch (error) {
        console.error('GitHub kaydetme hatası:', error);
        
        // SHA conflict hatası varsa dosyayı tekrar çek ve tekrar dene
        if (error.message && error.message.includes('but expected')) {
          console.log('🔄 SHA conflict, tekrar deneniyor...');
          try {
            // En güncel SHA'yı al
            const sharedResp = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}?ref=${branch}`, {
              headers: { 'Authorization': `token ${token}` }
            });
            
            if (sharedResp.ok) {
              const sharedData = await sharedResp.json();
              const guncelSha = sharedData.sha;
              
              console.log('🔄 Güncel SHA alındı, tekrar kaydediliyor...');
              
              // Tekrar dene - aynı veri yapısını kullan
              const retryKayitVerisi = {
                version: '1.0',
                sonGuncelleme: new Date().toISOString(),
                eslestirmeler: manuelEslestirmeler
              };
              
              const retryRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, {
                method: 'PUT',
                headers: {
                  'Authorization': `token ${token}`,
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                  message: 'Manuel eşleştirmeler güncellendi (retry)',
                  content: encodeUTF8ToBase64(retryKayitVerisi),
                  branch,
                  sha: guncelSha
                })
              });
              
              if (retryRes.ok) {
                console.log('✅ Retry başarılı - GitHub\'a kaydedildi!');
                localStorage.setItem('lastGithubUpdate', Date.now().toString());
                if (!sessizKaydetme) {
                  manuelEslestirmeStatusGoster('✅ GitHub\'a başarıyla kaydedildi! (retry)', 'success');
                }
                // Başarılı retry sonrası da durumu sıfırla
                gitHubKaydetmeDevamEdiyor = false;
                return;
              } else {
                console.error('❌ Retry de başarısız oldu:', await retryRes.text());
              }
            }
          } catch (retryError) {
            console.error('❌ Retry de başarısız:', retryError);
          }
        }
        
        if (!sessizKaydetme) {
          manuelEslestirmeStatusGoster(`❌ GitHub kaydetme hatası: ${error.message}`, 'error');
        }
      } finally {
        // Kaydetme durumunu her durumda sıfırla
        gitHubKaydetmeDevamEdiyor = false;
        console.log('🔄 GitHub kaydetme durumu sıfırlandı');
      }
    }

    // GitHub'dan manuel eşleştirmeleri yükleme
    async function manuelEslestirmeleriGitHubYukle(sessizYukleme = false) {
      const token = document.getElementById('githubToken').value.trim();
      if (!token) {
        if (!sessizYukleme) {
          alert('GitHub API token gerekli!');
        }
        return;
      }

      const owner = 'mustafasacar35';
      const repo = 'lipodem-takip-paneli-4';
      const path = 'data/manuel_eslestirmeler.json';
      const branch = 'main';

      try {
        if (!sessizYukleme) {
          manuelEslestirmeStatusGoster('GitHub\'dan yükleniyor...', 'info');
        }

        const resp = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}?ref=${branch}`, {
          headers: { Authorization: `token ${token}` }
        });

        if (resp.ok) {
          const data = await resp.json();
          const jsonContent = decodeBase64UTF8(data.content);
          const kayitVerisi = JSON.parse(jsonContent);
          
          // Eski format kontrolü
          if (kayitVerisi.eslestirmeler) {
            manuelEslestirmeler = kayitVerisi.eslestirmeler;
          } else {
            // Eski format (direkt object)
            manuelEslestirmeler = kayitVerisi;
          }
          
          // LocalStorage'a da kaydet
          localStorage.setItem(MANUEL_ESLESTIRME_KEY, JSON.stringify(manuelEslestirmeler));
          
          // Cache timestamp'ini güncelle
          localStorage.setItem('lastGithubUpdate', Date.now().toString());
          
          // Listeyi güncelle (eğer panel açıksa)
          if (document.getElementById('manuelEslestirmePanel').style.display !== 'none') {
            manuelEslestirmeListesiniGoster();
          }

          if (!sessizYukleme) {
            const eslestirmeSayisi = Object.keys(manuelEslestirmeler).length;
            manuelEslestirmeStatusGoster(`✅ GitHub'dan ${eslestirmeSayisi} eşleştirme yüklendi!`, 'success');
          } else {
            // Sessiz yükleme olsa bile konsola yazdır
            const eslestirmeSayisi = Object.keys(manuelEslestirmeler).length;
            console.log(`Manuel eşleştirmeler GitHub'dan güncellendi: ${eslestirmeSayisi} adet`);
          }

        } else if (resp.status === 404) {
          // Dosya henüz yok, normal
          if (!sessizYukleme) {
            manuelEslestirmeStatusGoster('ℹ️ GitHub\'da henüz eşleştirme dosyası yok', 'info');
          }
        } else {
          throw new Error('GitHub\'dan okuma başarısız: ' + resp.status);
        }

      } catch (error) {
        console.error('GitHub yükleme hatası:', error);
        if (!sessizYukleme) {
          manuelEslestirmeStatusGoster(`❌ GitHub yükleme hatası: ${error.message}`, 'error');
        }
      }
    }

    // --- Kart Silme Fonksiyonları ---
    function kartSilFormGoster() {
      const token = document.getElementById('githubToken').value.trim();
      if (!token) {
        alert('Önce GitHub API token girin!');
        return;
      }
      
      // Mevcut kartları listele
      kartListesiniYenile();
      document.getElementById('kartSilFormu').style.display = 'block';
    }

    function kartSilFormGizle() {
      document.getElementById('kartSilFormu').style.display = 'none';
      document.getElementById('silinecekKart').value = '';
      document.getElementById('kartAramaInput').value = '';
      document.getElementById('onizlemeAlani').innerHTML = '';
      document.getElementById('silmeStatus').style.display = 'none';
    }

    async function kartListesiniYenile() {
      const select = document.getElementById('silinecekKart');
      const aramaInput = document.getElementById('kartAramaInput');
      
      // Eğer tarifler listesi boşsa yükle
      if (tariflerKlasoruGorselleri.length === 0) {
        await tariflerKlasoruGorselleriniYukle();
      }
      
      // Tüm kartları sakla (filtreleme için)
      window.tumKartListesi = [...tariflerKlasoruGorselleri];
      
      // İlk yüklemede tüm kartları göster
      kartListesiniFiltrele('');
      
      // Arama input'una olay dinleyicisi ekle
      aramaInput.oninput = function() {
        const aramaMetni = this.value.toLowerCase();
        kartListesiniFiltrele(aramaMetni);
      };
      
      // Kart seçildiğinde önizleme göster
      select.onchange = function() {
        kartOnizlemeGoster(this.value);
      };
    }

    function kartListesiniFiltrele(aramaMetni) {
      const select = document.getElementById('silinecekKart');
      select.innerHTML = '<option value="">Kart seçin...</option>';
      
      if (!window.tumKartListesi) return;
      
      // Arama metnini kelimelere ayır ve türkçe karakterleri normalize et
      const aramaKelimeleri = aramaMetni.trim().split(/\s+/).filter(k => k.length > 0)
        .map(kelime => karakterDuzelt(kelime.toLowerCase()));
      
      console.log('🔍 Arama kelimeleri:', aramaKelimeleri);
      
      // Filtreleme fonksiyonu
      function kartEslesiyorMu(kartAdi) {
        if (aramaKelimeleri.length === 0) return true;
        
        const kartMetni = karakterDuzelt(kartAdi.toLowerCase())
          .replace(/\.(jpg|jpeg|png)$/i, '') // dosya uzantısını kaldır
          .replace(/_/g, ' '); // alt çizgileri boşluğa çevir
        
        console.log(`🔎 Kart "${kartAdi}" test ediliyor: "${kartMetni}"`);
        
        // Tüm arama kelimelerinin kart adında bulunup bulunmadığını kontrol et
        const eslesiyor = aramaKelimeleri.every(kelime => {
          const eslesme = kartMetni.includes(kelime);
          console.log(`  ✓ "${kelime}" kelimesi "${kartMetni}" içinde: ${eslesme}`);
          return eslesme;
        });
        
        console.log(`📊 "${kartAdi}" sonuç: ${eslesiyor}`);
        return eslesiyor;
      }
      
      // Filtrelenmiş kartları ekle
      const filtrelenmisKartlar = window.tumKartListesi.filter(kart => 
        kartEslesiyorMu(kart.name)
      );
      
      console.log(`📋 Filtrelenmiş kart sayısı: ${filtrelenmisKartlar.length}`);
      
      // Eşleşme skoruna göre sırala (daha iyi eşleşenler üstte)
      filtrelenmisKartlar.sort((a, b) => {
        const aMetni = karakterDuzelt(a.name.toLowerCase()).replace(/\.(jpg|jpeg|png)$/i, '').replace(/_/g, ' ');
        const bMetni = karakterDuzelt(b.name.toLowerCase()).replace(/\.(jpg|jpeg|png)$/i, '').replace(/_/g, ' ');
        
        // Tam eşleşme kontrolü
        if (aramaKelimeleri.length > 0) {
          const aramaMetniTam = aramaKelimeleri.join(' ');
          const aIceriyor = aMetni.includes(aramaMetniTam);
          const bIceriyor = bMetni.includes(aramaMetniTam);
          
          if (aIceriyor && !bIceriyor) return -1;
          if (!aIceriyor && bIceriyor) return 1;
        }
        
        // Alfabetik sıralama
        return a.name.localeCompare(b.name, 'tr-TR');
      });
      
      // Seçenekleri ekle
      filtrelenmisKartlar.forEach(kart => {
        const option = document.createElement('option');
        option.value = kart.name;
        option.textContent = kart.name;
        
        // Eşleşen kelimeleri vurgula (sadece görsel amaçlı)
        if (aramaKelimeleri.length > 0) {
          let vurguluMetin = kart.name;
          aramaKelimeleri.forEach(kelime => {
            const regex = new RegExp(`(${kelime})`, 'gi');
            vurguluMetin = vurguluMetin.replace(regex, '→$1←');
          });
          option.setAttribute('title', vurguluMetin.replace(/→/g, '').replace(/←/g, ''));
        }
        
        select.appendChild(option);
      });
      
      // Sonuç sayısını göster
      const sonucSayisi = filtrelenmisKartlar.length;
      if (aramaMetni && sonucSayisi === 0) {
        const option = document.createElement('option');
        option.value = '';
        option.textContent = 'Eşleşen kart bulunamadı';
        option.disabled = true;
        select.appendChild(option);
      }
    }

    function kartOnizlemeGoster(seciliKart) {
      const onizleme = document.getElementById('onizlemeAlani');
      onizleme.innerHTML = '';
      
      if (seciliKart && window.tumKartListesi) {
        const kartBilgisi = window.tumKartListesi.find(k => k.name === seciliKart);
        if (kartBilgisi) {
          onizleme.innerHTML = `
            <p><strong>Silinecek kart:</strong> ${seciliKart}</p>
            <img src="${kartBilgisi.url}" alt="${seciliKart}" style="width:150px; border:1px solid #ccc;">
          `;
          
          // Arama input'unu seçilen kart adıyla güncelle
          const aramaInput = document.getElementById('kartAramaInput');
          if (aramaInput.value.trim() === '') {
            aramaInput.value = seciliKart.replace(/\.(jpg|jpeg|png)$/i, '').replace(/_/g, ' ');
          }
        }
      }
    }

    function silmeStatusGoster(mesaj, tip = 'info') {
      const statusDiv = document.getElementById('silmeStatus');
      statusDiv.style.display = 'block';
      statusDiv.innerHTML = mesaj;
      
      if (tip === 'success') {
        statusDiv.style.background = '#d4edda';
        statusDiv.style.color = '#155724';
        statusDiv.style.border = '1px solid #c3e6cb';
      } else if (tip === 'error') {
        statusDiv.style.background = '#f8d7da';
        statusDiv.style.color = '#721c24';
        statusDiv.style.border = '1px solid #f5c6cb';
      } else {
        statusDiv.style.background = '#d1ecf1';
        statusDiv.style.color = '#0c5460';
        statusDiv.style.border = '1px solid #bee5eb';
      }
    }

    async function kartSil() {
      const token = document.getElementById('githubToken').value.trim();
      const silinecekKart = document.getElementById('silinecekKart').value;
      
      if (!token) {
        alert('GitHub API token gerekli!');
        return;
      }
      
      if (!silinecekKart) {
        alert('Silinecek kartı seçin!');
        return;
      }

      // Onay al
      if (!confirm(`"${silinecekKart}" kartını gerçekten silmek istiyorsan? Bu işlem geri alınamaz!`)) {
        return;
      }

      const owner = 'mustafasacar35';
      const repo = 'lipodem-takip-paneli-4';
      const branch = 'main';

      try {
        silmeStatusGoster('Dosya bilgisi alınıyor...', 'info');

        // 1. Önce dosyanın SHA'sını al (silmek için gerekli)
        const dosyaPath = `tarifler/${silinecekKart}`;
        const dosyaRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${dosyaPath}?ref=${branch}`, {
          headers: { Authorization: `token ${token}` }
        });

        if (!dosyaRes.ok) {
          throw new Error('Dosya bulunamadı veya erişim hatası');
        }

        const dosyaData = await dosyaRes.json();

        silmeStatusGoster('Dosya GitHub\'dan siliniyor...', 'info');

        // 2. Dosyayı sil
        const silRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${dosyaPath}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `token ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            message: `Tarif kartı silindi: ${silinecekKart}`,
            sha: dosyaData.sha,
            branch
          })
        });

        if (!silRes.ok) {
          throw new Error('Dosya silme başarısız: ' + (await silRes.text()));
        }

        silmeStatusGoster('list.json güncelleniyor...', 'info');

        // 3. list.json'u güncelle
        const listRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/tarifler/list.json?ref=${branch}`, {
          headers: { Authorization: `token ${token}` }
        });

        if (!listRes.ok) {
          throw new Error('list.json dosyası alınamadı');
        }

        const listData = await listRes.json();
        const mevcutListe = JSON.parse(decodeBase64UTF8(listData.content));
        
        // Silinen dosyayı listeden çıkar
        const guncelListe = mevcutListe.filter(kart => kart !== silinecekKart);

        // Güncellenmiş listeyi yükle
        const yeniListeContent = encodeUTF8ToBase64(guncelListe);
        const listUpdateRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/tarifler/list.json`, {
          method: 'PUT',
          headers: {
            'Authorization': `token ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            message: `list.json güncellendi - ${silinecekKart} silindi`,
            content: yeniListeContent,
            sha: listData.sha,
            branch
          })
        });

        if (!listUpdateRes.ok) {
          throw new Error('list.json güncelleme başarısız: ' + (await listUpdateRes.text()));
        }

        silmeStatusGoster(`✅ Başarılı! ${silinecekKart} kartı silindi ve list.json güncellendi.`, 'success');
        
        // Lokal listeyi de güncelle
        await tariflerKlasoruGorselleriniYukle();
        
        // Liste güncelle
        kartListesiniYenile();
        
        // Arama kutusunu ve seçimi temizle
        document.getElementById('kartAramaInput').value = '';
        document.getElementById('silinecekKart').value = '';
        
        // Önizlemeyi temizle
        document.getElementById('onizlemeAlani').innerHTML = '';

      } catch (error) {
        console.error('Kart silme hatası:', error);
        silmeStatusGoster(`❌ Hata: ${error.message}`, 'error');
      }
    }

    // --- Yeni Kart Ekleme Fonksiyonları ---
    function yeniKartFormGoster() {
      const token = document.getElementById('githubToken').value.trim();
      if (!token) {
        alert('Önce GitHub API token girin!');
        return;
      }
      document.getElementById('yeniKartFormu').style.display = 'block';
    }

    function yeniKartFormGizle() {
      document.getElementById('yeniKartFormu').style.display = 'none';
      document.getElementById('yeniKartAdi').value = '';
      document.getElementById('yeniKartDosya').value = '';
      document.getElementById('yuklemeStatus').style.display = 'none';
    }

    // --- Kart Düzenleme Fonksiyonları ---
    function kartDuzenleFormGoster() {
      const token = document.getElementById('githubToken').value.trim();
      if (!token) {
        alert('Önce GitHub API token girin!');
        return;
      }
      document.getElementById('kartDuzenleFormu').style.display = 'block';
      document.getElementById('seciliKartBilgileri').style.display = 'none';
      kartListesiniYenileForDuzenleme();
    }

    function kartDuzenleFormGizle() {
      document.getElementById('kartDuzenleFormu').style.display = 'none';
      document.getElementById('duzenleKartArama').value = '';
      document.getElementById('duzenleKartYeniAdi').value = '';
      document.getElementById('duzenleKartYeniDosya').value = '';
      document.getElementById('seciliKartBilgileri').style.display = 'none';
      document.getElementById('duzenlemeStatus').style.display = 'none';
      seciliDuzenleKart = null;
    }

    let seciliDuzenleKart = null;

    async function kartListesiniYenileForDuzenleme() {
      const listeDiv = document.getElementById('duzenleKartListesi');
      listeDiv.innerHTML = '<div style="color:#666;">Kart listesi yükleniyor...</div>';
      
      try {
        const token = document.getElementById('githubToken').value.trim();
        const owner = 'mustafasacar35';
        const repo = 'lipodem-takip-paneli-4';
        
        const response = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/tarifler/list.json`, {
          headers: { 'Authorization': `token ${token}` }
        });
        
        if (!response.ok) throw new Error('Kart listesi alınamadı');
        
        const data = await response.json();
        const content = JSON.parse(decodeBase64UTF8(data.content));
        
        kartListesiniGosterForDuzenleme(content);
        
      } catch (error) {
        console.error('Kart listesi yenileme hatası:', error);
        listeDiv.innerHTML = `<div style="color:red;">Hata: ${error.message}</div>`;
      }
    }

    function kartListesiniGosterForDuzenleme(kartlar, filtreMetni = '') {
      const listeDiv = document.getElementById('duzenleKartListesi');
      listeDiv.innerHTML = '';
      
      const filtrelenmisKartlar = kartlar.filter(kart => 
        kart.toLowerCase().includes(filtreMetni.toLowerCase())
      );
      
      if (filtrelenmisKartlar.length === 0) {
        listeDiv.innerHTML = '<div style="color:#666;">Kart bulunamadı</div>';
        return;
      }
      
      // Mevcut olmayan dosyaları takip et
      
      filtrelenmisKartlar.forEach(kartAdi => {
        const kartDiv = document.createElement('div');
        kartDiv.style.cssText = 'padding:8px; margin:4px 0; border:1px solid #ddd; border-radius:4px; cursor:pointer; background:white; display:flex; align-items:center; gap:10px;';
        
        // Kart önizlemesi
        const img = document.createElement('img');
        img.src = `https://mustafasacar35.github.io/lipodem-takip-paneli-4/tarifler/${kartAdi}`;
        img.style.cssText = 'width:40px; height:40px; object-fit:cover; border-radius:4px;';
        img.onerror = () => {
          img.style.display = 'none';
          dosyaBulunamadi(kartAdi);
          // Kart div'ini farklı stil yap
          kartDiv.style.background = '#fff3cd';
          kartDiv.style.borderColor = '#ffc107';
          span.style.color = '#856404';
          span.title = 'Bu dosya bulunamıyor - list.json\'dan temizlenebilir';
        };
        
        // Kart adı
        const span = document.createElement('span');
        // Encoding sorunlarını temizleyip daha okunaklı göster
        let gosterimAdi = kartAdi
          .replace(/Ä±/g, 'ı').replace(/Ä/g, 'a')
          .replace(/Å/g, 'ş').replace(/Ğ/g, 'ğ')
          .replace(/Ã¼/g, 'ü').replace(/Ã¶/g, 'ö')
          .replace(/â/g, 'a').replace(/î/g, 'i')
          .replace(/û/g, 'u').replace(/ô/g, 'o')
          .replace(/_/g, ' ')
          .replace('.jpg', '');
        span.textContent = gosterimAdi;
        span.setAttribute('data-original', kartAdi); // Orijinal adı sakla
        span.style.flex = '1';
        
        kartDiv.appendChild(img);
        kartDiv.appendChild(span);
        
        kartDiv.onclick = () => {
          const originalName = span.getAttribute('data-original');
          kartSecForDuzenleme(originalName);
        };
        
        // Hover efekti
        kartDiv.onmouseenter = () => kartDiv.style.background = '#e3f2fd';
        kartDiv.onmouseleave = () => {
          const originalName = span.getAttribute('data-original');
          kartDiv.style.background = seciliDuzenleKart === originalName ? '#bbdefb' : 'white';
        };
        
        const originalName = span.getAttribute('data-original');
        if (seciliDuzenleKart === originalName) {
          kartDiv.style.background = '#bbdefb';
        }
        
        listeDiv.appendChild(kartDiv);
      });
    }

    function kartListesiniFiltreleForDuzenleme(aramaMetni) {
      // Türkçe karakter normalizasyonu
      const normalizeText = (text) => {
        return text.toLowerCase()
          .replace(/ç/g, 'c').replace(/Ç/g, 'c')
          .replace(/ğ/g, 'g').replace(/Ğ/g, 'g')
          .replace(/ı/g, 'i').replace(/I/g, 'i').replace(/İ/g, 'i')
          .replace(/ö/g, 'o').replace(/Ö/g, 'o')
          .replace(/ş/g, 's').replace(/Ş/g, 's')
          .replace(/ü/g, 'u').replace(/Ü/g, 'u')
          // Encoding sorunları için
          .replace(/Ä±/g, 'i').replace(/Ä/g, 'a')
          .replace(/Å/g, 's').replace(/Ğ/g, 'g')
          .replace(/Ã¼/g, 'u').replace(/Ã¶/g, 'o')
          .replace(/â/g, 'a').replace(/î/g, 'i')
          .replace(/û/g, 'u').replace(/ô/g, 'o');
      };
      
      // Son yüklenen kart listesini tekrar filtrele
      kartListesiniYenileForDuzenleme().then(() => {
        // Liste yenilendikten sonra filtreyi uygula
        setTimeout(() => {
          const listeDiv = document.getElementById('duzenleKartListesi');
          const kartDivleri = Array.from(listeDiv.children);
          
          const normalizedArama = normalizeText(aramaMetni);
          
          kartDivleri.forEach(kartDiv => {
            const span = kartDiv.querySelector('span');
            const kartAdi = span?.getAttribute('data-original') || '';
            const gosterimAdi = span?.textContent || '';
            
            // Hem orijinal hem gösterim adında ara
            const normalizedKart = normalizeText(kartAdi);
            const normalizedGosterim = normalizeText(gosterimAdi);
            const goster = normalizedKart.includes(normalizedArama) || normalizedGosterim.includes(normalizedArama);
            kartDiv.style.display = goster ? 'flex' : 'none';
          });
          
          // Debug: Arama sonuçlarını göster
          if (aramaMetni.length > 2) {
            const goruntulenenKartlar = kartDivleri.filter(div => div.style.display !== 'none').length;
            console.log(`🔍 "${aramaMetni}" araması: ${goruntulenenKartlar} kart bulundu`);
            if (aramaMetni.includes('Ä') || aramaMetni.includes('ı')) {
              console.log(`💡 Normalizasyon: "${aramaMetni}" → "${normalizedArama}"`);
            }
          }
        }, 100);
      });
    }

    function kartSecForDuzenleme(kartAdi) {
      seciliDuzenleKart = kartAdi;
      
      // Görsel seçimi güncelle
      const listeDiv = document.getElementById('duzenleKartListesi');
      Array.from(listeDiv.children).forEach(div => {
        const span = div.querySelector('span');
        if (span) {
          const originalName = span.getAttribute('data-original');
          div.style.background = originalName === kartAdi ? '#bbdefb' : 'white';
        }
      });
      
      // Kart bilgilerini göster
      document.getElementById('seciliKartBilgileri').style.display = 'block';
      
      // Mevcut kart önizlemesi
      const onizlemeDiv = document.getElementById('mevcutKartOnizleme');
      const temizAd = kartAdi
        .replace(/Ä±/g, 'ı').replace(/Ä/g, 'a')
        .replace(/Å/g, 'ş').replace(/Ğ/g, 'ğ')
        .replace(/Ã¼/g, 'ü').replace(/Ã¶/g, 'ö')
        .replace(/_/g, ' ')
        .replace('.jpg', '');
      
      onizlemeDiv.innerHTML = `
        <div style="display:flex; align-items:center; gap:15px;">
          <img src="https://mustafasacar35.github.io/lipodem-takip-paneli-4/tarifler/${kartAdi}" 
               style="width:80px; height:80px; object-fit:cover; border-radius:8px; border:1px solid #ddd;" 
               onerror="this.style.display='none'; this.nextElementSibling.querySelector('.error-msg').style.display='block'">
          <div>
            <div style="font-weight:bold; font-size:16px;">${temizAd}</div>
            <div style="color:#666; font-size:12px;">Mevcut kart (${kartAdi})</div>
            <div class="error-msg" style="color:#dc3545; font-size:11px; display:none;">❌ Görsel bulunamadı</div>
          </div>
        </div>
      `;
      
      // Yeni adı önceden doldur (kullanıcı isterse değiştirebilir) - encoding temizleyerek
      const yeniAdiInput = document.getElementById('duzenleKartYeniAdi');
      if (yeniAdiInput) {
        // Dosya uzantısını kaldır ve encoding sorunlarını temizle
        let temizAd = kartAdi.replace('.jpg', '').replace('.jpeg', '').replace('.png', '');
        temizAd = temizAd
          .replace(/Ä±/g, 'i').replace(/Ä/g, 'a')
          .replace(/Å/g, 's').replace(/Ğ/g, 'g')
          .replace(/Ã¼/g, 'u').replace(/Ã¶/g, 'o')
          .replace(/â/g, 'a').replace(/î/g, 'i')
          .replace(/û/g, 'u').replace(/ô/g, 'o');
        yeniAdiInput.value = temizAd;
        console.log(`💡 Kart seçildi: "${kartAdi}" → Temizlenmiş ad: "${temizAd}"`);
      }
    }

    // List.json'dan mevcut olmayan dosyaları temizle
    async function listjsonTemizle() {
      const token = document.getElementById('githubToken').value.trim();
      if (!token) {
        alert('GitHub token gerekli!');
        return;
      }
      
      if (!confirm('Mevcut olmayan dosyalar list.json\'dan temizlenecek. Emin misiniz?')) {
        return;
      }
      
      try {
        console.log('🔄 List.json temizliği başlatıldı...');
        
        // Önce list.json'u al
        const response = await fetch('https://api.github.com/repos/mustafasacar35/lipodem-takip-paneli-4/contents/tarifler/list.json', {
          headers: {
            'Authorization': `token ${token}`,
            'Accept': 'application/vnd.github.v3+json'
          }
        });
        
        if (!response.ok) {
          throw new Error(`List.json alınamadı: ${response.status}`);
        }
        
        const fileData = await response.json();
        const currentContent = JSON.parse(decodeBase64UTF8(fileData.content));
        
        // Her dosyanın varlığını kontrol et
        const validFiles = [];
        let removedCount = 0;
        
        statusGoster('Dosyalar kontrol ediliyor...', 'info');
        
        for (const fileName of currentContent) {
          try {
            const checkResponse = await fetch(`https://mustafasacar35.github.io/lipodem-takip-paneli-4/tarifler/${fileName}`, {
              method: 'HEAD'
            });
            
            if (checkResponse.ok) {
              validFiles.push(fileName);
            } else {
              console.log(`❌ Kaldırıldı: ${fileName}`);
              removedCount++;
            }
          } catch (error) {
            console.log(`❌ Kaldırıldı: ${fileName} (hata)`);
            removedCount++;
          }
        }
        
        if (removedCount === 0) {
          statusGoster('Temizlenecek dosya bulunamadı. Tüm dosyalar mevcut.', 'success');
          return;
        }
        
        statusGoster(`${removedCount} dosya temizleniyor...`, 'info');
        
        // Güncellenmiş list.json'u gönder
        const updateResponse = await fetch('https://api.github.com/repos/mustafasacar35/lipodem-takip-paneli-4/contents/tarifler/list.json', {
          method: 'PUT',
          headers: {
            'Authorization': `token ${token}`,
            'Accept': 'application/vnd.github.v3+json',
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            message: `List.json temizlendi: ${removedCount} dosya kaldırıldı`,
            content: encodeUTF8ToBase64(validFiles),
            sha: fileData.sha
          })
        });
        
        if (!updateResponse.ok) {
          throw new Error(`List.json güncellenemedi: ${updateResponse.status}`);
        }
        
        alert(`✅ Başarılı! ${removedCount} mevcut olmayan dosya list.json'dan temizlendi.`);
        
        // Cache'i temizle ve listeyi yenile
        localStorage.removeItem('tarifKartlariCache');
        kartListesiniYenileForDuzenleme();
        
      } catch (error) {
        console.error('List.json temizleme hatası:', error);
        alert(`❌ Hata: ${error.message}`);
      }
    }

    // Mevcut olmayan dosyaları toplu raporla
    let mevcutOlmayanDosyalar = new Set();
    
    function dosyaBulunamadi(dosyaAdi) {
      mevcutOlmayanDosyalar.add(dosyaAdi);
      
      // 2 saniye sonra toplu rapor ver
      setTimeout(() => {
        if (mevcutOlmayanDosyalar.size > 0) {
          const eksikler = Array.from(mevcutOlmayanDosyalar);
          console.log(`🚨 TOPLU RAPOR: ${eksikler.length} dosya bulunamadı:`);
          eksikler.forEach(dosya => console.log(`  ❌ ${dosya}`));
          console.log('💡 Bu dosyaları temizlemek için "🧹 Temizle" butonunu kullanın');
          mevcutOlmayanDosyalar.clear();
        }
      }, 2000);
    }

    async function kartDuzenlemeKaydet() {
      const yeniAd = document.getElementById('duzenleKartYeniAdi').value.trim();
      const yeniDosya = document.getElementById('duzenleKartYeniDosya').files[0];
      
      if (!seciliDuzenleKart) {
        alert('Lütfen önce düzenlenecek kartı seçin!');
        return;
      }
      
      if (!yeniAd) {
        alert('Yeni kart adını girin!');
        return;
      }
      
      // Dosya adını normalize et
      let normalizeEdilmisAd = yeniAd.toLowerCase()
        .replace(/[çğıöşü]/g, c => ({'ç':'c','ğ':'g','ı':'i','ö':'o','ş':'s','ü':'u'}[c] || c))
        .replace(/[^a-z0-9_]/g, '_')
        .replace(/_+/g, '_')
        .replace(/^_|_$/g, '');
      
      if (!normalizeEdilmisAd.endsWith('.jpg')) {
        normalizeEdilmisAd += '.jpg';
      }
      
      if (normalizeEdilmisAd === seciliDuzenleKart && !yeniDosya) {
        alert('Herhangi bir değişiklik yapmadınız!');
        return;
      }
      
      const token = document.getElementById('githubToken').value.trim();
      
      try {
        duzenlemeStatusGoster('Kart düzenleniyor...', 'info');
        
        const owner = 'mustafasacar35';
        const repo = 'lipodem-takip-paneli-4';
        
        // 1. Eski kartı sil
        if (normalizeEdilmisAd !== seciliDuzenleKart) {
          await kartSilGitHub(seciliDuzenleKart, token, owner, repo, false); // sessiz silme
        }
        
        // 2. Yeni kart ekle
        let gorselBase64;
        if (yeniDosya) {
          // Yeni dosya seçilmişse onu kullan
          gorselBase64 = await dosyayiBase64Cevir(yeniDosya);
        } else {
          // Dosya seçilmemişse mevcut dosyayı indir ve tekrar yükle
          const mevcutResponse = await fetch(`https://mustafasacar35.github.io/lipodem-takip-paneli-4/tarifler/${seciliDuzenleKart}`);
          const mevcutBlob = await mevcutResponse.blob();
          gorselBase64 = await new Promise(resolve => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result.split(',')[1]);
            reader.readAsDataURL(mevcutBlob);
          });
        }
        
        // GitHub'a yeni kartı yükle
        // Önce dosyanın var olup olmadığını kontrol et (SHA için)
        let existingSha = null;
        try {
          const checkResponse = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/tarifler/${normalizeEdilmisAd}`, {
            headers: { 'Authorization': `token ${token}` }
          });
          if (checkResponse.ok) {
            const existingData = await checkResponse.json();
            existingSha = existingData.sha;
            console.log(`📄 Mevcut dosya bulundu: ${normalizeEdilmisAd}, SHA: ${existingSha}`);
          }
        } catch (e) {
          console.log(`📄 Yeni dosya: ${normalizeEdilmisAd}`);
        }
        
        const uploadPayload = {
          message: `Kart düzenlendi: ${seciliDuzenleKart} → ${normalizeEdilmisAd}`,
          content: gorselBase64
        };
        
        // Eğer dosya varsa SHA'sını ekle
        if (existingSha) {
          uploadPayload.sha = existingSha;
        }
        
        const uploadResponse = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/tarifler/${normalizeEdilmisAd}`, {
          method: 'PUT',
          headers: {
            'Authorization': `token ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(uploadPayload)
        });
        
        if (!uploadResponse.ok) {
          const errorText = await uploadResponse.text();
          console.error('Upload hatası:', uploadResponse.status, errorText);
          throw new Error(`Yeni kart yüklenemedi (${uploadResponse.status}): ${errorText}`);
        }
        
        // 3. list.json'u güncelle
        await listJsonGuncelle(token, owner, repo);
        
        duzenlemeStatusGoster(`✅ Kart başarıyla düzenlendi: ${normalizeEdilmisAd}`, 'success');
        
        // Cache'i temizle ve listeyi yenile
        tariflerKlasoruGorselleri = [];
        await tariflerKlasoruGorselleriniYukle();
        
        setTimeout(() => {
          kartDuzenleFormGizle();
        }, 2000);
        
      } catch (error) {
        console.error('Kart düzenleme hatası:', error);
        duzenlemeStatusGoster(`❌ Hata: ${error.message}`, 'error');
      }
    }

    function duzenlemeStatusGoster(mesaj, tip = 'info') {
      const statusDiv = document.getElementById('duzenlemeStatus');
      statusDiv.style.display = 'block';
      statusDiv.innerHTML = mesaj;
      
      if (tip === 'success') {
        statusDiv.style.background = '#d4edda';
        statusDiv.style.color = '#155724';
        statusDiv.style.border = '1px solid #c3e6cb';
      } else if (tip === 'error') {
        statusDiv.style.background = '#f8d7da';
        statusDiv.style.color = '#721c24';
        statusDiv.style.border = '1px solid #f5c6cb';
      } else {
        statusDiv.style.background = '#d1ecf1';
        statusDiv.style.color = '#0c5460';
        statusDiv.style.border = '1px solid #bee5eb';
      }
    }

    // Yardımcı fonksiyonlar
    function dosyayiBase64Cevir(dosya) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result.split(',')[1]);
        reader.onerror = reject;
        reader.readAsDataURL(dosya);
      });
    }

    async function kartSilGitHub(kartAdi, token, owner, repo, showAlert = true) {
      // Önce dosyanın SHA'sını al
      const getResponse = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/tarifler/${kartAdi}`, {
        headers: { 'Authorization': `token ${token}` }
      });
      
      if (!getResponse.ok) {
        throw new Error('Dosya bulunamadı');
      }
      
      const fileData = await getResponse.json();
      
      // Dosyayı sil
      const deleteResponse = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/tarifler/${kartAdi}`, {
        method: 'DELETE',
        headers: {
          'Authorization': `token ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          message: `Kart silindi: ${kartAdi}`,
          sha: fileData.sha
        })
      });
      
      if (!deleteResponse.ok) {
        throw new Error('Dosya silinemedi');
      }
      
      if (showAlert) {
        console.log(`✅ ${kartAdi} başarıyla silindi`);
      }
    }

    async function listJsonGuncelle(token, owner, repo) {
      // Tarifler klasöründeki tüm dosyaları listele
      const response = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/tarifler`, {
        headers: { 'Authorization': `token ${token}` }
      });
      
      if (!response.ok) throw new Error('Klasör içeriği alınamadı');
      
      const files = await response.json();
      const imageFiles = files
        .filter(file => file.type === 'file' && /\.(jpg|jpeg|png)$/i.test(file.name))
        .map(file => file.name)
        .sort();
      
      // list.json'un mevcut SHA'sını al
      const listResponse = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/tarifler/list.json`, {
        headers: { 'Authorization': `token ${token}` }
      });
      
      let listSha;
      if (listResponse.ok) {
        const listData = await listResponse.json();
        listSha = listData.sha;
      }
      
      // list.json'u güncelle
      const updateResponse = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/tarifler/list.json`, {
        method: 'PUT',
        headers: {
          'Authorization': `token ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          message: 'list.json güncellendi (kart düzenleme)',
          content: encodeUTF8ToBase64(imageFiles),
          ...(listSha && { sha: listSha })
        })
      });
      
      if (!updateResponse.ok) {
        throw new Error('list.json güncellenemedi');
      }
    }

    function statusGoster(mesaj, tip = 'info') {
      const statusDiv = document.getElementById('yuklemeStatus');
      statusDiv.style.display = 'block';
      statusDiv.innerHTML = mesaj;
      
      if (tip === 'success') {
        statusDiv.style.background = '#d4edda';
        statusDiv.style.color = '#155724';
        statusDiv.style.border = '1px solid #c3e6cb';
      } else if (tip === 'error') {
        statusDiv.style.background = '#f8d7da';
        statusDiv.style.color = '#721c24';
        statusDiv.style.border = '1px solid #f5c6cb';
      } else {
        statusDiv.style.background = '#d1ecf1';
        statusDiv.style.color = '#0c5460';
        statusDiv.style.border = '1px solid #bee5eb';
      }
    }

    async function yeniKartKaydet() {
      const token = document.getElementById('githubToken').value.trim();
      const kartAdi = document.getElementById('yeniKartAdi').value.trim();
      const dosyaInput = document.getElementById('yeniKartDosya');
      
      // Validasyon
      if (!token) {
        alert('GitHub API token gerekli!');
        return;
      }
      
      if (!kartAdi) {
        alert('Kart adı gerekli!');
        return;
      }
      
      if (!dosyaInput.files || !dosyaInput.files[0]) {
        alert('Görsel dosyası seçin!');
        return;
      }

      // Dosya adını normalize et
      let dosyaAdi = kartAdi.toLowerCase()
        .replace(/ç/g, 'c').replace(/ğ/g, 'g').replace(/ş/g, 's')
        .replace(/ü/g, 'u').replace(/ö/g, 'o').replace(/ı/g, 'i')
        .replace(/\s+/g, '_')
        .replace(/[^a-z0-9_]/g, '');
      
      if (!dosyaAdi.endsWith('.jpg')) {
        dosyaAdi += '.jpg';
      }

      const dosya = dosyaInput.files[0];
      
      try {
        statusGoster('Dosya hazırlanıyor...', 'info');
        
        // Dosyayı base64'e çevir
        const dosyaBase64 = await new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => {
            const base64 = reader.result.split(',')[1]; // data:image/jpeg;base64, kısmını çıkar
            resolve(base64);
          };
          reader.onerror = reject;
          reader.readAsDataURL(dosya);
        });

        const owner = 'mustafasacar35';
        const repo = 'lipodem-takip-paneli-4';
        const branch = 'main';

        statusGoster('Görsel GitHub\'a yükleniyor...', 'info');

        // 1. Önce dosya var mı kontrol et
        const gorselPath = `tarifler/${dosyaAdi}`;
        let mevcutSha = null;
        
        try {
          const mevcutRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${gorselPath}?ref=${branch}`, {
            headers: { Authorization: `token ${token}` }
          });
          
          if (mevcutRes.ok) {
            const mevcutData = await mevcutRes.json();
            mevcutSha = mevcutData.sha;
            console.log('📁 Mevcut dosya SHA bulundu:', mevcutSha);
          }
        } catch (e) {
          console.log('📁 Dosya mevcut değil, yeni dosya oluşturulacak');
        }

        // 2. Görseli tarifler klasörüne yükle
        const gorselPayload = {
          message: `Yeni tarif kartı eklendi: ${dosyaAdi}`,
          content: dosyaBase64,
          branch
        };
        
        // SHA varsa ekle
        if (mevcutSha) {
          gorselPayload.sha = mevcutSha;
        }
        
        const gorselRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${gorselPath}`, {
          method: 'PUT',
          headers: {
            'Authorization': `token ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(gorselPayload)
        });

        if (!gorselRes.ok) {
          const errorText = await gorselRes.text();
          throw new Error('Görsel yükleme başarısız: ' + errorText);
        }

        statusGoster('list.json güncelleniyor...', 'info');

        // 2. list.json dosyasını güncelle
        // Önce mevcut list.json'u al
        const listRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/tarifler/list.json?ref=${branch}`, {
          headers: { Authorization: `token ${token}` }
        });

        if (!listRes.ok) {
          throw new Error('list.json dosyası alınamadı');
        }

        const listData = await listRes.json();
        const mevcutListe = JSON.parse(decodeBase64UTF8(listData.content));
        
        // Yeni dosyayı listeye ekle (eğer yoksa)
        if (!mevcutListe.includes(dosyaAdi)) {
          mevcutListe.push(dosyaAdi);
          mevcutListe.sort(); // Alfabetik sırala
        }

        // Güncellenmiş listeyi yükle
        const yeniListeContent = encodeUTF8ToBase64(mevcutListe);
        const listUpdateRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/tarifler/list.json`, {
          method: 'PUT',
          headers: {
            'Authorization': `token ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            message: `list.json güncellendi - ${dosyaAdi} eklendi`,
            content: yeniListeContent,
            sha: listData.sha,
            branch
          })
        });

        if (!listUpdateRes.ok) {
          throw new Error('list.json güncelleme başarısız: ' + (await listUpdateRes.text()));
        }

        statusGoster(`✅ Başarılı! ${dosyaAdi} kartı eklendi ve list.json güncellendi.`, 'success');
        
        // Lokal listeyi de güncelle (anında görünmesi için)
        await tariflerKlasoruGorselleriniYukle();
        
        // Formu temizle
        setTimeout(() => {
          yeniKartFormGizle();
        }, 2000);

      } catch (error) {
        console.error('Kart yükleme hatası:', error);
        statusGoster(`❌ Hata: ${error.message}`, 'error');
      }
    }
    // --- Tarifler klasörü görsellerini otomatik yükle (GitHub Pages uyumlu) ---
    let tariflerKlasoruGorselleri = [];
    
    function durumGuncelle() {
      const durumElement = document.getElementById('tariflerKlasoruDurumu');
      if (durumElement) {
        if (tariflerKlasoruGorselleri.length > 0) {
          durumElement.innerHTML = `✅ Tarifler klasörü: <span style="color:green; font-weight:bold;">${tariflerKlasoruGorselleri.length} görsel</span>`;
          durumElement.parentElement.style.borderLeftColor = '#28a745';
        } else {
          durumElement.innerHTML = `⚠️ Tarifler klasörü: <span style="color:orange; font-weight:bold;">Görsel bulunamadı</span> - Manuel yükleme gerekli`;
          durumElement.parentElement.style.borderLeftColor = '#ffc107';
        }
      }
    }
    
    async function tariflerKlasoruGorselleriniYukle() {
      const durumElement = document.getElementById('tariflerKlasoruDurumu');
      if (durumElement) {
        durumElement.innerHTML = '🔄 Tarifler klasörü kontrol ediliyor...';
        durumElement.parentElement.style.borderLeftColor = '#6c757d';
      }
      
      try {
        // Her zaman bulunduğun dizinin köküne göre tarifler/ yolunu oluştur
        // Önce GitHub'dan tarifler yüklemeyi deneyelim
        console.log('🌐 GitHub\'dan tarifler yükleniyor...');
        const githubTariflerUrl = 'https://mustafasacar35.github.io/lipodem-takip-paneli-4/tarifler/list.json';
        
        try {
          const githubResp = await fetch(githubTariflerUrl);
          if (githubResp.ok) {
            const responseText = await githubResp.text();
            console.log('Tarifler GitHub\'dan yüklendi (ilk 200 karakter):', responseText.substring(0, 200));
            
            const files = JSON.parse(responseText);
            console.log('GitHub\'dan yüklenen tarif dosyaları:', files.length, 'adet');
            
            tariflerKlasoruGorselleri = files.map(name => ({
              name,
              url: 'https://mustafasacar35.github.io/lipodem-takip-paneli-4/tarifler/' + name
            }));
            
            window.tarifKartlari = files;
            console.log('🔧 window.tarifKartlari GitHub\'dan ayarlandı:', window.tarifKartlari.length, 'kart');
            console.log(`✅ GitHub\'dan ${tariflerKlasoruGorselleri.length} tarif görsel yüklendi`);
            
            durumGuncelle();
            return; // Başarılı, devam etme
          }
        } catch (githubError) {
          console.warn('⚠️ GitHub\'dan tarif yükleme başarısız:', githubError.message);
        }
        
        // GitHub başarısız olduysa local denemeyi yap
        console.log('📁 Local dosya yükleme deneniyor...');
        let basePath = window.location.pathname;
        if (!basePath.endsWith('/')) basePath = basePath.substring(0, basePath.lastIndexOf('/') + 1);
        const tariflerPath = window.location.origin + basePath + 'tarifler/';
        
        console.log('Tarifler klasörü aranıyor:', tariflerPath);
        
        const resp = await fetch(tariflerPath + 'list.json');
        if (!resp.ok) {
          console.warn(`list.json bulunamadı (${resp.status}): ${tariflerPath}list.json`);
          throw new Error(`list.json bulunamadı: ${resp.status} - ${tariflerPath}list.json`);
        }
        
        const responseText = await resp.text();
        console.log('Tarifler klasöründen ham JSON (ilk 200 karakter):', responseText.substring(0, 200));
        
        let files;
        try {
          files = JSON.parse(responseText);
        } catch (jsonError) {
          console.error('❌ JSON parsing hatası:', jsonError.message);
          console.log('📄 Hatalı JSON içeriği (ilk 1000 karakter):', responseText.substring(0, 1000));
          
          // JSON'u satır satır kontrol et
          const lines = responseText.split('\n');
          console.log('📊 Toplam satır sayısı:', lines.length);
          
          // 200-210 arası satırları göster (hata 204. satırda)
          for (let i = 200; i < Math.min(210, lines.length); i++) {
            console.log(`❌ Satır ${i + 1}: "${lines[i]}"`);
          }
          
          throw new Error(`JSON format hatası: ${jsonError.message}`);
        }
        
        console.log('Tarifler klasöründen yüklenen dosyalar:', files);
        
        tariflerKlasoruGorselleri = files.map(name => ({
          name,
          url: tariflerPath + name
        }));
        
        // Manuel kart ekleme için dosya adlarını da ayrı bir diziye kaydet
        window.tarifKartlari = files;
        console.log('🔧 window.tarifKartlari ayarlandı:', window.tarifKartlari.length, 'kart');
        
        console.log(`✅ Tarifler klasöründen ${tariflerKlasoruGorselleri.length} görsel yüklendi`);
        
      } catch (e) {
        console.warn('⚠️ Tarifler klasörü yüklenemedi:', e.message);
        console.log('💡 Çözüm: Ana dizinde "tarifler/" klasörü oluşturun ve içine list.json dosyası ekleyin');
        tariflerKlasoruGorselleri = [];
        window.tarifKartlari = []; // Manuel kart ekleme için boş dizi
        console.log('🔧 window.tarifKartlari boş dizi olarak ayarlandı');
      }
      
      durumGuncelle();
    }
    tariflerKlasoruGorselleriniYukle();

    // pdf.js worker ayarı (uyumluluk için)
    if (window['pdfjsLib']) {
      pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
    }
    // --- Hasta Yönetimi Modülü ---
    // --- Kalıcı veri yönetimi ---
    const STORAGE_KEY = 'lipedem_hasta_kayitlari';
    function saveToStorage() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(hastalar));
        console.log('💾 Hastalar localStorage\'a kaydedildi');
        // Hasta sayılarını güncelle - async olarak çağır
        if (typeof guncelleHastaSayilari === 'function') {
          guncelleHastaSayilari().catch(err => console.warn('Hasta sayıları güncelleme hatası:', err));
        }
      } catch(e) { console.error('localStorage kaydetme hatası:', e); }
    }
    
    // Veri değiştiğinde otomatik kaydetme
    function autoSaveHastaData(hasta) {
      try {
        if (!hasta) return;
        
        // Global hastalar dizisinde güncelle
        const hastaIndex = hastalar.findIndex(h => h.id === hasta.id);
        if (hastaIndex >= 0) {
          hastalar[hastaIndex] = hasta;
          console.log('🔄 Hasta verisi güncellendi:', hasta.isim);
        } else {
          hastalar.push(hasta);
          console.log('➕ Yeni hasta eklendi:', hasta.isim);
        }
        
        // localStorage'a kaydet
        saveToStorage();
        
        return true;
      } catch(e) { 
        console.error('Otomatik kaydetme hatası:', e); 
        return false;
      }
    }
    function loadFromStorage() {
      try {
        const data = localStorage.getItem(STORAGE_KEY);
        if (data) return JSON.parse(data);
      } catch(e) { console.error('localStorage okuma hatası:', e); }
      return null;
    }

    // Başlangıç verisi veya storage'dan yükle
    let hastalar = loadFromStorage() || [
      { id: 1, isim: "Ayşe Yılmaz", not: "Hashimoto tiroiditi var", arsiv: false },
      { id: 2, isim: "Fatma Demir", not: "Zeytin sevmez", arsiv: false },
      { id: 3, isim: "Zeynep Kaya", not: "3. haftada kabızlık yaşandı", arsiv: true }
    ];
    
    // YENİ SİSTEM: Global hasta listesi
    let hastaListesi = [];
    
    // Temizlenmiş verileri kaydet
    if (hastalar.length > 0) {
      saveToStorage();
      console.log('💾 Temizlenmiş veriler localStorage\'a kaydedildi');
    }
    
    // Hasta listesini otomatik sırala (isim sırası) - güvenli sıralama
    hastalar.sort((a, b) => {
      const isimA = (a.isim || a.ad || '').toString();
      const isimB = (b.isim || b.ad || '').toString();
      return isimA.localeCompare(isimB, 'tr');
    });
    
    // === YENİ SİSTEM: SIDEBAR HASTA LİSTESİ ===
    
    // Yeni sistemden hasta listesini renderla
    async function renderHastalarYeniSistem() {
      // PDF yükleme devam ediyorsa GitHub render işlemlerini engelle
      if (window.pdfYuklemeDevamEdiyor) {
        console.log('🚫 PDF yükleme devam ediyor, renderHastalarYeniSistem atlanıyor');
        return;
      }
      
      const ul = document.getElementById('hastaListesi');
      const ara = document.getElementById('hastaAra').value.toLowerCase();
      const filtre = document.getElementById('arsivFiltre').value;
      ul.innerHTML = '<li style="padding: 10px; text-align: center; color: #666;">Yükleniyor...</li>';
      
      try {
        // Token kontrolü
        const token = document.getElementById('githubToken').value.trim();
        if (!token) {
          ul.innerHTML = '<li style="padding: 10px; text-align: center; color: #dc3545;">⚠️ GitHub token gerekli</li>';
          return;
        }
        
        // GitHub'dan hasta listesini al ve global değişkeni güncelle
        const yuklenmisList = await hastaListesiYukle();
        
        if (yuklenmisList.length === 0) {
          ul.innerHTML = '<li style="padding: 10px; text-align: center; color: #666;">Henüz hasta kaydı yok - Yeni hasta ekleyebilirsiniz</li>';
          return;
        }
        
        ul.innerHTML = '';
        
        // Filtreleme ve sıralama - yüklenen listeyi kullan
        const filtreliHastalar = yuklenmisList.filter(hasta => {
          const hastaIsim = hasta.isim || hasta.ad || '';
          const aramaUygun = hastaIsim.toLowerCase().includes(ara);
          const filtreUygun = filtre === 'hepsi' || 
                             (filtre === 'aktif' && !hasta.arsiv) || 
                             (filtre === 'arsiv' && hasta.arsiv);
          return aramaUygun && filtreUygun;
        });
        
        // Hasta sayılarını güncelle - yüklenen listeyi kullan
        const aktifSayisi = yuklenmisList.filter(h => !h.arsiv).length;
        const arsivSayisi = yuklenmisList.filter(h => h.arsiv).length;
        console.log(`📊 Yeni sistem hasta sayıları: Aktif=${aktifSayisi}, Arşiv=${arsivSayisi}, Toplam=${yuklenmisList.length}`);
        
        // Filtreleme ve hasta hafta verilerini analiz etme
        const hastalarVeriAnaliziIle = await Promise.all(filtreliHastalar.map(async (hasta) => {
          const hastaIsim = hasta.isim || hasta.ad || 'Bilinmeyen Hasta';
          
          // En büyük hafta sayısını bul - sadece localStorage'a bak (güvenilir kaynak)
          let maxHafta = 0;
          let hastaDetayiBulundu = false;
          
          // Önce localStorage'dan kontrol et (ÖNCELIK: localStorage)
          const localHasta = hastalar.find(h => h && h.id === hasta.id);
          if (localHasta && localHasta.haftalar && localHasta.haftalar.length > 0) {
            const haftaNumaralari = localHasta.haftalar.map(h => h.haftaNo || h.hafta || 0);
            maxHafta = Math.max(...haftaNumaralari);
            hastaDetayiBulundu = true;
            console.log(`📊 Hasta ${hastaIsim} - localStorage'dan hafta bilgisi alındı: maxHafta=${maxHafta}, haftalar: [${haftaNumaralari.join(', ')}]`);
          }
          
          // localStorage'da bulunamadıysa GitHub'dan dene (opsiyonel ve sadece yedek)
          if (!hastaDetayiBulundu && hasta.id) {
            try {
              const dosyaAdlari = [
                generateFileName({ id: hasta.id, isim: hasta.isim }),
                generateFileName({ isim: hasta.isim })
              ];
              
              for (const dosyaAdi of dosyaAdlari) {
                try {
                  const response = await fetch(`https://api.github.com/repos/mustafasacar35/lipodem-takip-paneli-4/contents/patients/${dosyaAdi}`, {
                    headers: { 'Authorization': `token ${token}` }
                  });
                  
                  if (response.ok) {
                    const data = await response.json();
                    const hastaDetay = JSON.parse(decodeBase64UTF8(data.content));
                    if (hastaDetay.haftalar && hastaDetay.haftalar.length > 0) {
                      const haftaNumaralari = hastaDetay.haftalar.map(h => h.haftaNo || h.hafta || 0);
                      const githubMaxHafta = Math.max(...haftaNumaralari);
                      
                      // ⚠️ UYARI: GitHub verisi localStorage'ı geçersiz kılmasın
                      // Sadece localStorage boşsa GitHub verisini kullan
                      maxHafta = githubMaxHafta;
                      hastaDetayiBulundu = true;
                      console.log(`📊 Hasta ${hastaIsim} - GitHub'dan yedek hafta bilgisi alındı: maxHafta=${githubMaxHafta}, haftalar: [${haftaNumaralari.join(', ')}]`);
                      break;
                    }
                  } else if (response.status === 404) {
                    // Hasta dosyası bulunamadı, diğer dosya adlarını dene
                    continue;
                  }
                } catch (e) {
                  // Sessizce geç
                }
              }
            } catch (e) {
              // Sessizce geç
            }
          }
          
          return {
            ...hasta,
            maxHafta: maxHafta,
            hastaIsim: hastaIsim,
            hastaDetayiBulundu: hastaDetayiBulundu
          };
        }));
        
        // En büyük hafta numarasına göre sırala, aynı hafta numarası olanlarda alfabetik
        hastalarVeriAnaliziIle.sort((a, b) => {
          if (a.maxHafta !== b.maxHafta) {
            return a.maxHafta - b.maxHafta; // Küçük haftadan büyük haftaya
          }
          return a.hastaIsim.localeCompare(b.hastaIsim, 'tr'); // Alfabetik sıralama
        });
        
        hastalarVeriAnaliziIle.forEach((hasta, index) => {
          const li = document.createElement('li');
          
          // Hafta sayısına göre renk belirleme
          const getHaftaRengi = (haftaNo) => {
            const renkPaleti = [
              // Hafta 0 - PDF Yok
              { background: 'linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%)', borderColor: '#dee2e6', textColor: '#6c757d' },
              // Hafta 1 - Açık Mavi
              { background: 'linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%)', borderColor: '#2196f3', textColor: '#0d47a1' },
              // Hafta 2 - Cyan
              { background: 'linear-gradient(135deg, #e0f7fa 0%, #80deea 100%)', borderColor: '#00bcd4', textColor: '#006064' },
              // Hafta 3 - Teal
              { background: 'linear-gradient(135deg, #e0f2f1 0%, #80cbc4 100%)', borderColor: '#009688', textColor: '#004d40' },
              // Hafta 4 - Yeşil
              { background: 'linear-gradient(135deg, #e8f5e8 0%, #a5d6a7 100%)', borderColor: '#4caf50', textColor: '#1b5e20' },
              // Hafta 5 - Açık Yeşil
              { background: 'linear-gradient(135deg, #f1f8e9 0%, #c5e1a5 100%)', borderColor: '#8bc34a', textColor: '#33691e' },
              // Hafta 6 - Lime
              { background: 'linear-gradient(135deg, #f9fbe7 0%, #dcedc8 100%)', borderColor: '#cddc39', textColor: '#827717' },
              // Hafta 7 - Sarı
              { background: 'linear-gradient(135deg, #fffde7 0%, #fff176 100%)', borderColor: '#ffeb3b', textColor: '#f57f17' },
              // Hafta 8 - Amber
              { background: 'linear-gradient(135deg, #fff8e1 0%, #ffcc02 100%)', borderColor: '#ffc107', textColor: '#ff6f00' },
              // Hafta 9 - Turuncu
              { background: 'linear-gradient(135deg, #fff3e0 0%, #ffb74d 100%)', borderColor: '#ff9800', textColor: '#e65100' },
              // Hafta 10 - Koyu Turuncu
              { background: 'linear-gradient(135deg, #fbe9e7 0%, #ffab91 100%)', borderColor: '#ff5722', textColor: '#d84315' },
              // Hafta 11 - Kırmızı
              { background: 'linear-gradient(135deg, #ffebee 0%, #ef9a9a 100%)', borderColor: '#f44336', textColor: '#c62828' },
              // Hafta 12 - Pink
              { background: 'linear-gradient(135deg, #fce4ec 0%, #f48fb1 100%)', borderColor: '#e91e63', textColor: '#ad1457' },
              // Hafta 13 - Mor
              { background: 'linear-gradient(135deg, #f3e5f5 0%, #ce93d8 100%)', borderColor: '#9c27b0', textColor: '#6a1b9a' }
            ];

            if (haftaNo === 0) {
              return renkPaleti[0];
            } else if (haftaNo >= 1 && haftaNo <= 13) {
              return renkPaleti[haftaNo];
            } else {
              // 14+ hafta için özel altın renk (başarı ve deneyim)
              return {
                background: 'linear-gradient(135deg, #fff8e1 0%, #ffd54f 100%)',
                borderColor: '#ff8f00',
                textColor: '#e65100'
              };
            }
          };
          
          const renkSemasi = getHaftaRengi(hasta.maxHafta);
          
          li.style.cssText = `cursor: pointer; padding: 8px 12px; border-radius: 8px; margin-bottom: 3px; 
                             background: ${renkSemasi.background}; 
                             border-left: 4px solid ${renkSemasi.borderColor}; 
                             border: 1px solid ${renkSemasi.borderColor}20;
                             box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                             transition: all 0.3s ease;`;
          
          // Hover efekti için
          li.onmouseenter = () => {
            li.style.transform = 'translateX(3px)';
            li.style.boxShadow = '0 4px 8px rgba(0,0,0,0.15)';
          };
          li.onmouseleave = () => {
            li.style.transform = 'translateX(0)';
            li.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)';
          };
          
          // İsim div'ini ayrı oluştur - hafta bilgisiyle birlikte
          const isimDiv = document.createElement('div');
          isimDiv.style.cssText = `font-weight: bold; color: ${hasta.arsiv ? '#6c757d' : renkSemasi.textColor}; font-size: 13px;`;
          
          // Sıra numarasını ekle
          const siraSpan = document.createElement('span');
          siraSpan.style.cssText = `color: ${renkSemasi.textColor}80; font-weight: normal; margin-right: 8px;`;
          siraSpan.textContent = `${index + 1}.`;
          isimDiv.appendChild(siraSpan);
          
          // İsim kısmını ekle
          const isimSpan = document.createElement('span');
          isimSpan.textContent = `${hasta.arsiv ? '  ' : ''}${hasta.hastaIsim.toUpperCase()}`;
          isimDiv.appendChild(isimSpan);
          
          // Hafta bilgisini ekle (renkli)
          const haftaSpan = document.createElement('span');
          haftaSpan.style.cssText = `color: ${renkSemasi.borderColor}; font-weight: bold; font-size: 11px;`; // Border renginde ve bold
          if (hasta.maxHafta > 0) {
            haftaSpan.textContent = ` (${hasta.maxHafta}. hafta)`;
          } else {
            haftaSpan.textContent = ` (pdf yok)`;
          }
          isimDiv.appendChild(haftaSpan);
          
          li.appendChild(isimDiv);
          
          // Not varsa ekle
          if (hasta.not) {
            const notDiv = document.createElement('div');
            notDiv.style.cssText = `font-size: 11px; color: ${renkSemasi.textColor}90; margin-top: 2px;`;
            notDiv.textContent = hasta.not; // textContent kullan
            li.appendChild(notDiv);
          }
          
          li.onclick = () => hastaSecYeniSistem(hasta);
          li.dataset.hastaId = hasta.id;
          li.classList.add('hasta-item'); // CSS vurgulama için
          ul.appendChild(li);
        });
        
        console.log(`✅ Yeni sistem hasta listesi güncellendi: ${filtreliHastalar.length} hasta gösteriliyor`);
        
        // Sidebar'daki hasta sayılarını güncelle
        await guncelleHastaSayilari();
        
        // Toplu ZIP butonunu ekle
        ekleTopluZipButonu();
        
      } catch (error) {
        console.error('❌ Yeni sistem hasta listesi yükleme hatası:', error);
        ul.innerHTML = '<li style="padding: 10px; text-align: center; color: #dc3545;">Hasta listesi yüklenemedi</li>';
      }
    }
    
    // Yeni sistemde hasta seçme
    async function hastaSecYeniSistem(hastaBilgi) {
      try {
        console.log('👤 Yeni sistemde hasta seçiliyor:', hastaBilgi.isim);
        console.log('  GitHub\'dan hasta bilgileri alınıyor:', hastaBilgi.isim);
        
        const owner = 'mustafasacar35';
        const repo = 'lipodem-takip-paneli-4';
        
        // Dosya adı alternatifleri dene
        const dosyaAdlari = [
          generateFileName({ id: hastaBilgi.id, isim: hastaBilgi.isim }),
          generateFileName({ id: hastaBilgi.id, isim: turkceKarakterDuzelt(hastaBilgi.isim) }),
          generateFileName({ isim: hastaBilgi.isim }),
          generateFileName({ isim: turkceKarakterDuzelt(hastaBilgi.isim) })
        ];
        
        // Çift entryleri kaldır
        const benzersizDosyaAdlari = [...new Set(dosyaAdlari)];
        
        console.log('🔍 Denenen dosya adları:', benzersizDosyaAdlari);
        
        let hastaDetay = null;
        let bulunanDosya = null;
        
        // Her dosya adını sırayla dene
        for (const dosyaAdi of benzersizDosyaAdlari) {
          try {
            console.log(`🔍 Denenen dosya: ${dosyaAdi}`);
            const token = document.getElementById('githubToken').value.trim();
            const headers = token ? { 'Authorization': `token ${token}` } : {};
            const response = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/patients/${dosyaAdi}`, { headers });
            
            if (response.ok) {
              const data = await response.json();
              hastaDetay = JSON.parse(decodeBase64UTF8(data.content));
              bulunanDosya = dosyaAdi;
              console.log(`✅ Dosya bulundu: ${dosyaAdi}`);
              break;
            }
          } catch (e) {
            console.log(`❌ Dosya bulunamadı: ${dosyaAdi}`);
          }
        }
        
        if (hastaDetay) {
          // ⭐ YENİ YAKLAŞIM: localStorage'ı temel al, GitHub'ı sadece eksik PDF'ler için kullan
          if (seciliHasta && seciliHasta.id === hastaDetay.id && seciliHasta.haftalar) {
            console.log('🔄 localStorage verisi temel alınıyor, GitHub sadece eksik PDF bağlantıları için kullanılacak');
            
            // LocalStorage'daki hafta verilerini koru
            const mevcutHaftalar = seciliHasta.haftalar || [];
            const gitHubHaftalar = hastaDetay.haftalar || [];
            
            console.log('🔍 MEVCUT HAFTALAR (localStorage - Temel):', mevcutHaftalar.map(h => ({ haftaNo: h.haftaNo, baslangic: h.baslangic, bitis: h.bitis })));
            console.log('🔍 GITHUB HAFTALAR (Sadece PDF link için):', gitHubHaftalar.map(h => ({ haftaNo: h.haftaNo, baslangic: h.baslangic, bitis: h.bitis })));
            
            // LocalStorage verilerini temel al, sadece GitHub'dan PDF linklerini al
            const birlesikHaftalar = mevcutHaftalar.map(mevcutHafta => {
              const githubHafta = gitHubHaftalar.find(gh => gh.haftaNo === mevcutHafta.haftaNo);
              if (githubHafta) {
                // Sadece PDF ile ilgili alanları GitHub'dan al
                return {
                  ...mevcutHafta, // localStorage verisi öncelikli
                  // GitHub'dan sadece PDF linklerini al
                  ...(githubHafta.githubUrl && { githubUrl: githubHafta.githubUrl }),
                  ...(githubHafta.githubLink && { githubLink: githubHafta.githubLink }),
                  ...(githubHafta.indirmeUrl && { indirmeUrl: githubHafta.indirmeUrl }),
                  ...(githubHafta.githubRawLink && { githubRawLink: githubHafta.githubRawLink }),
                  ...(githubHafta.pdfGithubPath && { pdfGithubPath: githubHafta.pdfGithubPath })
                };
              }
              return mevcutHafta;
            });
            
            console.log('✅ Hafta verileri localStorage temel alınarak hazırlandı:', birlesikHaftalar.length, 'hafta');
            
            // Hasta verisini güncelle (localStorage öncelikli)
            hastaDetay.haftalar = birlesikHaftalar;
            seciliHasta.haftalar = birlesikHaftalar;
            
          } else {
            // Yeni hasta veya hafta verisi yok - GitHub verisini al
            console.log('🆕 GitHub\'dan hasta verisi alınıyor:', hastaDetay.isim);
          }
          
          // Cache'i de güncelle (çoklu PDF işlemi için)
          if (typeof cokluPdfHastaCache !== 'undefined') {
            const cacheKey = hastaDetay.isim.toUpperCase();
            cokluPdfHastaCache.set(cacheKey, hastaDetay);
            console.log(`🔄 Cache güncellendi: ${hastaDetay.isim} - Hafta sayısı: ${hastaDetay.haftalar?.length || 0}`);
          }
          
          // Global değişkeni güncelle
          seciliHasta = hastaDetay;
          
          // Otomatik kaydet - hasta verilerini localStorage'a kaydet
          autoSaveHastaData(seciliHasta);
          
          // UI'ı güncelle
          const secilenHastaIsim = document.getElementById('secilenHastaIsim');
          const secilenHastaNot = document.getElementById('secilenHastaNot');
          const hastaBilgiButonlar = document.getElementById('hastaBilgiButonlar');
          
          if (secilenHastaIsim) secilenHastaIsim.textContent = hastaDetay.isim;
          if (secilenHastaNot) secilenHastaNot.textContent = hastaDetay.not || 'Not yok';
          if (hastaBilgiButonlar) hastaBilgiButonlar.style.display = 'block'; // Butonları göster
          
          // Seçili hastayı vurgula
          vurgulaSeciliHasta(hastaBilgi.id);
          
          console.log('✅ Yeni sistemde hasta bilgileri yüklendi:', hastaDetay.isim);
          
          // Hafta tablarını göster
          gosterHaftalar();

          // Hedef kcal rozeti otomatik güncelle
          updateHedefKcalBadgeForSelectedPatient();
          
          // Eşleşmeyenler listesini güncelle (hasta değiştiğinde)
          setTimeout(() => {
            try {
              if (typeof eslesmeyenlerListesiniGuncelle === 'function') {
                eslesmeyenlerListesiniGuncelle();
              } else {
                console.warn('⚠️ eslesmeyenlerListesiniGuncelle fonksiyonu henüz yüklenmemiş (hasta değişimi)');
              }
            } catch (error) {
              console.warn('⚠️ eslesmeyenlerListesiniGuncelle hatası (hasta değişimi):', error.message);
            }
          }, 1000);
          
        } else {
          throw new Error(`Hasta dosyası bulunamadı. Denenen dosyalar: ${benzersizDosyaAdlari.join(', ')}`);
        }
        
      } catch (error) {
        console.error('❌ Yeni sistemde hasta seçme hatası:', error);
        alert(`Hasta detayları yüklenemedi: ${error.message}`);
      }
    }

    // === ESKİ SİSTEM (GERİYE UYUMLULUK) ===

    // ESKİ SİSTEM DEVRE DIŞI - Yeni sisteme yönlendir
    function renderHastalar() {
      // PDF yükleme devam ediyorsa GitHub render işlemlerini engelle
      if (window.pdfYuklemeDevamEdiyor) {
        console.log('🚫 PDF yükleme devam ediyor, renderHastalar atlanıyor');
        return;
      }
      
      console.log('⚠️ renderHastalar çağrıldı, yeni sisteme yönlendiriliyor...');
      renderHastalarYeniSistem();
    }

    // Hastanın en son PDF yüklenen haftasını bul
    function getEnSonPdfHafta(hasta) {
      if (!hasta.haftalar || hasta.haftalar.length === 0) return 0;
      
      let enSonPdfHafta = 0;
      hasta.haftalar.forEach(hafta => {
        if (hafta.pdf && hafta.haftaNo > enSonPdfHafta) {
          enSonPdfHafta = hafta.haftaNo;
        }
      });
      
      return enSonPdfHafta;
    }

    function vurgulaSeciliHasta(hastaId) {
      // Önce tüm hasta vurgularını kaldır
      const tumHastalar = document.querySelectorAll('.hasta-item');
      tumHastalar.forEach(hasta => {
        hasta.classList.remove('secili-hasta');
      });
      
      // Seçilen hastayı vurgula
      const secilenHasta = document.querySelector(`[data-hasta-id="${hastaId}"]`);
      if (secilenHasta) {
        secilenHasta.classList.add('secili-hasta');
        console.log('✅ Hasta vurgulandı:', hastaId);
      } else {
        console.log('⚠️ Vurgulanacak hasta bulunamadı:', hastaId);
      }
    }

    function filtreleHastalar() { 
      // Yeni sistem kullanıyorsa
      if (typeof renderHastalarYeniSistem === 'function') {
        renderHastalarYeniSistem();
      } else {
        // Eski sistem fallback
        renderHastalar();
      }
    }

    async function guncelleHastaSayilari() {
      try {
        // Yeni sistemden hasta listesini al
        const hastaData = await hastaListesiYukle();
        
        let aktifSayisi = 0;
        let arsivSayisi = 0;
        
        hastaData.forEach(hasta => {
          // arsiv property'sini kontrol et
          if (hasta.arsiv) {
            arsivSayisi++;
          } else {
            aktifSayisi++;
          }
        });
        
        const tumSayisi = hastaData.length;
        
        console.log(`📊 Yeni sistem hasta sayıları: Aktif=${aktifSayisi}, Arşiv=${arsivSayisi}, Toplam=${tumSayisi}`);
        
        // Select option'larını güncelle
        const arsivFiltre = document.getElementById('arsivFiltre');
        if (arsivFiltre) {
          const mevcutSecim = arsivFiltre.value || 'aktif'; // Mevcut seçimi al
          
          arsivFiltre.innerHTML = `
            <option value="aktif">Aktif Hastalar (${aktifSayisi})</option>
            <option value="arsiv">Arşiv (${arsivSayisi})</option>
            <option value="tum">Tümü (${tumSayisi})</option>
          `;
          
          // Seçili değeri geri yükle
          arsivFiltre.value = mevcutSecim;
        }
        
      } catch (error) {
        console.error('Hasta sayıları güncellenirken hata:', error);
      }
    }

    function yeniHastaFormu() {
      console.log('🆕 Yeni hasta ekleme başlatıldı (YENİ SİSTEM)');
      
      // Yeni hasta ismini iste
      const yeniIsim = prompt('Yeni hasta ismini girin:');
      if (yeniIsim === null) return; // İptal edildi
      
      const temizIsim = yeniIsim.trim();
      if (!temizIsim) {
        alert('İsim boş olamaz!');
        return;
      }
      
      // Yeni hasta notunu iste
      const yeniNot = prompt('Hasta notu (opsiyonel):');
      if (yeniNot === null) return; // İptal edildi
      
      // ARTIK KARİKATER DÜZELTMESİ YAPMA - OLDUĞU GİBİ KULLAN
      const duzeltilmisIsim = temizIsim;
      
      // Aynı isimde hasta var mı kontrol et (hem eski hem yeni sistemde)
      const mevcutHastaEski = hastalar.find(h => h && h.isim && h.isim.toLowerCase() === duzeltilmisIsim.toLowerCase());
      if (mevcutHastaEski) {
        alert('Bu isimde bir hasta zaten mevcut! (Eski sistem)');
        return;
      }
      
      // Yeni sistemde de kontrol et
      const mevcutHastaYeni = hastaListesi.find(h => h && h.isim && h.isim.toLowerCase() === duzeltilmisIsim.toLowerCase());
      if (mevcutHastaYeni) {
        alert('Bu isimde bir hasta zaten mevcut! (Yeni sistem)');
        return;
      }
      
      // Yeni hasta oluştur
      const yeniHasta = {
        id: Date.now(),
        isim: duzeltilmisIsim,
        not: yeniNot ? yeniNot.trim() : '',
        arsiv: false,
        haftalar: [],
        olusturmaTarihi: new Date().toISOString(),
        yeniSistem: true
      };
      
      console.log('✅ Yeni hasta oluşturuldu:', duzeltilmisIsim);
      
      // YENİ SİSTEME KAYDET
      // 1. Önce individual hasta dosyası olarak kaydet
      hastayiAyriKaydet(yeniHasta).then(basarili => {
        if (basarili) {
          console.log('✅ Yeni hasta GitHub\'a kaydedildi:', duzeltilmisIsim);
          
          // 2. Global hasta listesini güncelle
          const yeniHastaListeItem = {
            id: yeniHasta.id,
            isim: yeniHasta.isim,
            olusturmaTarihi: yeniHasta.olusturmaTarihi,
            arsiv: yeniHasta.arsiv || false
          };
          hastaListesi.push(yeniHastaListeItem);
          hastaListesi.sort((a, b) => {
            if (!a || !a.isim) return 1;
            if (!b || !b.isim) return -1;
            return a.isim.localeCompare(b.isim, 'tr');
          });
          console.log('✅ Global hasta listesi güncellendi');
          
          // 3. Hasta listesini yeniden render et
          renderHastalarYeniSistem();
          
          // 4. Yeni hastayı seç
          seciliHasta = yeniHasta;
          
          // 5. Başarı mesajı
          alert(`✅ Yeni hasta başarıyla eklendi!\n\n👤 ${duzeltilmisIsim}\n📁 Yeni sistem ile kaydedildi`);
          
        } else {
          console.error('❌ GitHub kaydetme başarısız');
          alert('❌ Hasta oluşturuldu ama GitHub\'a kaydedilemedi!\nLütfen GitHub token kontrolü yapın.');
        }
      }).catch(error => {
        console.error('❌ Hasta kaydetme hatası:', error);
        alert('❌ Hasta kaydetme hatası: ' + error.message);
      });
      
      // ESKİ SİSTEME EKLEME (sadece local olarak - geriye uyumluluk için)
      hastalar.push(yeniHasta);
      hastalar.sort((a, b) => {
        if (!a || !a.isim) return 1;
        if (!b || !b.isim) return -1;
        return a.isim.localeCompare(b.isim, 'tr');
      });
      saveToStorage();
      renderHastalar();
    }

    function iptalHastaFormu() {
      // Eski form elementleri kaldırıldı
      console.log('Form iptal edildi');
    }

    function hastaDetayGoster(id) {
      seciliHasta = hastalar.find(h => h.id === id);
      if (!seciliHasta) return;
      
      const hastaIsim = seciliHasta.isim || seciliHasta.ad || 'Bilinmeyen Hasta';
      console.log(`👤 Hasta seçildi: ${hastaIsim}`);
      
      // Hasta bilgi panelini güncelle ve göster
      const hastaBilgiPanel = document.getElementById('hastaBilgiPanel');
      const secilenHastaIsim = document.getElementById('secilenHastaIsim');
      const secilenHastaNot = document.getElementById('secilenHastaNot');
      
      console.log('🔍 Hasta bilgi paneli elementleri:', {
        hastaBilgiPanel: !!hastaBilgiPanel,
        secilenHastaIsim: !!secilenHastaIsim,
        secilenHastaNot: !!secilenHastaNot
      });
      
      if (hastaBilgiPanel && secilenHastaIsim && secilenHastaNot) {
        secilenHastaIsim.textContent = turkceKarakterDuzelt(hastaIsim);
        secilenHastaNot.textContent = seciliHasta.not || 'Not bulunmuyor';
        
        // Butonları göster
        const hastaBilgiButonlar = document.getElementById('hastaBilgiButonlar');
        if (hastaBilgiButonlar) {
          hastaBilgiButonlar.style.display = 'block';
        }
        
        console.log('✅ Hasta bilgi paneli güncellendi:', hastaIsim);
      } else {
        console.log('❌ Hasta bilgi paneli elementleri bulunamadı!');
      }
      
      // Sol sidebar'da aktif hastayı vurgula
      renderHastalar();
      
      // Hafta listesini göster (center panel'de)
      gosterHaftalar();
      
      // Sidebar'ları güncelle
      hastaSecildiginde(hastalar.findIndex(h => h.id === id));
      
      console.log(`✅ ${hastaIsim} için hafta tabları yüklendi ve aktif hafta otomatik seçilecek`);
    }

    function duzenleHasta() {
      if (!seciliHasta) return;
      
      const hastaIsim = seciliHasta.isim || seciliHasta.ad || 'Bilinmeyen Hasta';
      console.log('Hasta düzenleme için:', hastaIsim);
      
      // Mevcut bilgileri al
      const mevcutIsim = seciliHasta.isim || seciliHasta.ad || '';
      const mevcutNot = seciliHasta.not || '';
      
      // Yeni isim iste
      const yeniIsim = prompt('Hasta ismini düzenleyin:', mevcutIsim);
      if (yeniIsim === null) return; // İptal edildi
      
      const temizIsim = yeniIsim.trim();
      if (!temizIsim) {
        alert('İsim boş olamaz!');
        return;
      }
      
      // Yeni not iste
      const yeniNot = prompt('Hasta notunu düzenleyin:', mevcutNot);
      if (yeniNot === null) return; // İptal edildi
      
      // ARTIK KARİKATER DÜZELTMESİ YAPMA - OLDUĞU GİBİ KULLAN
      const duzeltilmisIsim = temizIsim;
      
      // Değişiklikleri kaydet
      seciliHasta.isim = duzeltilmisIsim;
      seciliHasta.not = yeniNot.trim();
      
      // Verileri kaydet
      saveToStorage();
      
      // Ekranı güncelle
      const secilenHastaIsim = document.getElementById('secilenHastaIsim');
      const secilenHastaNot = document.getElementById('secilenHastaNot');
      
      if (secilenHastaIsim) {
        secilenHastaIsim.textContent = duzeltilmisIsim;
      }
      if (secilenHastaNot) {
        secilenHastaNot.textContent = seciliHasta.not || 'Not bulunmuyor';
      }
      
      // Hasta listesini yenile ve sırala
      hastalar.sort((a, b) => {
        if (!a || !a.isim) return 1;
        if (!b || !b.isim) return -1;
        return a.isim.localeCompare(b.isim, 'tr');
      });
      renderHastalar();
      
      console.log(`✅ Hasta bilgileri güncellendi: ${mevcutIsim} → ${duzeltilmisIsim}`);
      
      // YENİ SİSTEM HASTA LİSTESİNDE İSMİ GÜNCELLE
      const hastaListeItem = hastaListesi.find(h => h && h.id === seciliHasta.id);
      if (hastaListeItem) {
        hastaListeItem.isim = duzeltilmisIsim;
        console.log('✅ Yeni sistem hasta listesinde isim güncellendi');
      }
      
      // YENİ SİSTEME KAYDET
      hastayiAyriKaydet(seciliHasta).then(basarili => {
        if (basarili) {
          console.log('✅ Hasta güncellemesi GitHub\'a kaydedildi:', duzeltilmisIsim);
          renderHastalarYeniSistem(); // Yeni sistemi güncelle
        } else {
          console.warn('⚠️ GitHub kaydı başarısız oldu, ancak yerel değişiklikler kaydedildi');
        }
      }).catch(error => {
        console.error('❌ GitHub kaydetme hatası:', error);
      });
    }

    async function arsivleHasta() {
      if (!seciliHasta) {
        alert('❌ Önce bir hasta seçin!');
        return;
      }
      
      try {
        // Arşiv durumunu değiştir
        seciliHasta.arsiv = !seciliHasta.arsiv;
        seciliHasta.sonGuncelleme = new Date().toISOString();
        
        const durum = seciliHasta.arsiv ? 'arşivlendi' : 'arşivden çıkarıldı';
        console.log(`📦 ${seciliHasta.isim} ${durum}`);
        
        // GitHub'a kaydet
        const sonuc = await hastayiAyriKaydet(seciliHasta);
        if (sonuc) {
          alert(`✅ ${seciliHasta.isim} ${durum}!`);
          
          // Hasta listesini yenile
          await renderHastalarYeniSistem();
          
          // Hasta bilgi panelini güncelle
          const secilenHastaNot = document.getElementById('secilenHastaNot');
          if (secilenHastaNot) {
            secilenHastaNot.textContent = seciliHasta.not || 'Not bulunmuyor';
          }
        } else {
          // Hata durumunda geri al
          seciliHasta.arsiv = !seciliHasta.arsiv;
          alert(`❌ ${durum} işlemi başarısız!`);
        }
      } catch (error) {
        console.error('❌ Arşivleme hatası:', error);
        alert(`❌ Arşivleme hatası: ${error.message}`);
      }
    }

    async function silHasta() {
      if (!seciliHasta) {
        alert('❌ Önce bir hasta seçin!');
        return;
      }
      
      const onay = confirm(`🗑️ "${seciliHasta.isim}" hasta kaydını silmek istediğinize emin misiniz?\n\nBu işlem geri alınamaz!`);
      if (!onay) return;
      
      try {
        console.log(`🗑️ ${seciliHasta.isim} hasta kaydı siliniyor...`);
        
        // GitHub'dan hasta dosyasını sil
        const owner = 'mustafasacar35';
        const repo = 'lipodem-takip-paneli-4';
        const token = document.getElementById('githubToken').value.trim();
        
        if (!token) {
          alert('❌ GitHub token gerekli!');
          return;
        }
        
        // Dosya adı alternatifleri dene (hastaSecYeniSistem gibi)
        const dosyaAdlari = [
          generateFileName({ id: seciliHasta.id, isim: seciliHasta.isim }),
          generateFileName({ id: seciliHasta.id, isim: turkceKarakterDuzelt(seciliHasta.isim) }),
          generateFileName({ isim: seciliHasta.isim }),
          generateFileName({ isim: turkceKarakterDuzelt(seciliHasta.isim) })
        ];
        
        const benzersizDosyaAdlari = [...new Set(dosyaAdlari)];
        console.log('🔍 Silinecek dosya adları deneniyor:', benzersizDosyaAdlari);
        
        let bulunanDosya = null;
        let dosyaSHA = null;
        
        // Dosyayı bul
        for (const dosyaAdi of benzersizDosyaAdlari) {
          try {
            console.log(`🔍 Denenen dosya: ${dosyaAdi}`);
            const shaResponse = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/patients/${dosyaAdi}`, {
              headers: { 'Authorization': `token ${token}` }
            });
            
            if (shaResponse.ok) {
              const shaData = await shaResponse.json();
              bulunanDosya = dosyaAdi;
              dosyaSHA = shaData.sha;
              console.log(`✅ Silinecek dosya bulundu: ${dosyaAdi}`);
              break;
            }
          } catch (e) {
            console.log(`❌ Dosya bulunamadı: ${dosyaAdi}`);
          }
        }
        
        if (!bulunanDosya) {
          throw new Error(`Hasta dosyası bulunamadı. Denenen dosyalar: ${benzersizDosyaAdlari.join(', ')}`);
        }
        
        // Dosyayı silmek yerine adını değiştir (timestamp ile benzersiz hale getir)
        const timestamp = new Date().getTime();
        const eskiDosyaAdi = bulunanDosya;
        const yeniDosyaAdi = `silindi_${timestamp}_${eskiDosyaAdi}`;
        
        console.log(`🔄 Dosya adı değiştiriliyor: ${eskiDosyaAdi} → ${yeniDosyaAdi}`);
        
        // Yeni dosya adının zaten var olup olmadığını kontrol et
        try {
          const varlikKontrol = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/patients/${yeniDosyaAdi}`, {
            headers: { 'Authorization': `token ${token}` }
          });
          
          if (varlikKontrol.ok) {
            console.warn(`⚠️ ${yeniDosyaAdi} zaten var, farklı timestamp deneniyor`);
            const yeniTimestamp = timestamp + Math.floor(Math.random() * 1000);
            yeniDosyaAdi = `silindi_${yeniTimestamp}_${eskiDosyaAdi}`;
            console.log(`🔄 Yeni dosya adı: ${yeniDosyaAdi}`);
          }
        } catch (e) {
          // Dosya yok, bu iyi
          console.log(`✅ ${yeniDosyaAdi} kullanılabilir`);
        }
        
        // Önce dosyanın içeriğini al
        const contentResponse = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/patients/${eskiDosyaAdi}`, {
          headers: { 'Authorization': `token ${token}` }
        });
        
        if (!contentResponse.ok) {
          throw new Error(`Dosya içeriği alınamadı: ${contentResponse.status}`);
        }
        
        const contentData = await contentResponse.json();
        const dosyaIcerigi = contentData.content; // Base64 içerik
        
        // Yeni adla dosyayı oluştur
        const createResponse = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/patients/${yeniDosyaAdi}`, {
          method: 'PUT',
          headers: {
            'Authorization': `token ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            message: `Hasta dosyası arşivlendi: ${seciliHasta.isim} - ${new Date().toLocaleString('tr-TR')}`,
            content: dosyaIcerigi // Base64 içeriği direkt kullan
          })
        });
        
        if (!createResponse.ok) {
          const errorText = await createResponse.text();
                // Header rozeti anında güncelle
                updateHedefKcalBadgeForSelectedPatient();
          console.error('❌ Arşiv dosyası oluşturma hatası:', createResponse.status, errorText);
          
          if (createResponse.status === 422) {
                // Yine de local ayarlara göre rozeti güncelle
                updateHedefKcalBadgeForSelectedPatient();
            throw new Error(`Arşiv dosyası zaten var veya geçersiz: ${yeniDosyaAdi}. Lütfen tekrar deneyin.`);
          } else {
            throw new Error(`Arşiv dosyası oluşturulamadı: ${createResponse.status} - ${errorText}`);
              updateHedefKcalBadgeForSelectedPatient();
          }
        }
        
        console.log(`✅ Arşiv dosyası oluşturuldu: ${yeniDosyaAdi}`);
        
        // Eski dosyayı sil
        const deleteResponse = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/patients/${eskiDosyaAdi}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `token ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            message: `Hasta dosyası arşivlendi (eski dosya silindi): ${seciliHasta.isim}`,
            sha: dosyaSHA
          })
        });
        
        if (deleteResponse.ok) {
          console.log(`✅ Hasta dosyası arşivlendi: ${eskiDosyaAdi} → ${yeniDosyaAdi}`);
          
          // Hasta listesinden de kaldır
          const listeGuncellendi = await hastaListesindenKaldir(seciliHasta.id);
          if (listeGuncellendi) {
            alert(`✅ ${seciliHasta.isim} hasta kaydı arşivlendi!\n\nDosya: ${yeniDosyaAdi}`);
            
            // Panel temizle ve listeyi yenile
            kapatDetay();
            await renderHastalarYeniSistem();
          } else {
            alert(`⚠️ Hasta dosyası arşivlendi ama listeden kaldırılamadı. Sayfayı yenileyin.`);
          }
        } else {
          throw new Error(`Eski dosya silinemedi: ${deleteResponse.status}`);
        }
        
      } catch (error) {
        console.error('❌ Hasta silme hatası:', error);
        
        // 422 hatası özel durumu - alternatif silme yöntemi öner
        if (error.message.includes('422') || error.message.includes('zaten var')) {
          const alternatifOnay = confirm(`❌ Arşivleme başarısız (dosya çakışması).\n\n🔄 Alternatif yöntem: Sadece hasta listesinden kaldırmak ister misiniz?\n\n(Dosya GitHub'da kalacak ama listede görünmeyecek)`);
          
          if (alternatifOnay) {
            try {
              const listeGuncellendi = await hastaListesindenKaldir(seciliHasta.id);
              if (listeGuncellendi) {
                alert(`✅ ${seciliHasta.isim} hasta listesinden kaldırıldı!\n\n⚠️ Not: Dosya GitHub'da hala mevcut.`);
                kapatDetay();
                await renderHastalarYeniSistem();
                return;
              }
            } catch (listeError) {
              console.error('❌ Liste güncelleme hatası:', listeError);
            }
          }
        }
        
        alert(`❌ Hasta silme hatası: ${error.message}\n\n💡 Öneriler:\n- Aynı hasta için önceki silme işlemi tamamlanmamış olabilir\n- Birkaç dakika bekleyip tekrar deneyin\n- Ya da sadece "listeden kaldır" seçeneğini kullanın`);
      }
    }

    // Sadece listeden kaldırma fonksiyonu (dosyayı silmez)
    async function sadeceLisedenKaldir() {
      if (!seciliHasta) {
        alert('❌ Önce bir hasta seçin!');
        return;
      }
      
      const onay = confirm(`📋 "${seciliHasta.isim}" hastasını sadece listeden kaldırmak istediğinize emin misiniz?\n\n⚠️ Dosya GitHub'da kalacak, sadece listede görünmeyecek.`);
      if (!onay) return;
      
      try {
        console.log(`📋 ${seciliHasta.isim} listeden kaldırılıyor...`);
        
        const listeGuncellendi = await hastaListesindenKaldir(seciliHasta.id);
        if (listeGuncellendi) {
          alert(`✅ ${seciliHasta.isim} listeden kaldırıldı!\n\n💾 Dosya GitHub'da korunuyor.`);
          kapatDetay();
          await renderHastalarYeniSistem();
        } else {
          throw new Error('Liste güncellenemedi');
        }
        
      } catch (error) {
        console.error('❌ Listeden kaldırma hatası:', error);
        alert(`❌ Listeden kaldırma hatası: ${error.message}`);
      }
    }

    // Global erişim için
    window.sadeceLisedenKaldir = sadeceLisedenKaldir;

    function kapatDetay() {
      // Hasta bilgi panelindeki bilgileri sıfırla
      const secilenHastaIsim = document.getElementById('secilenHastaIsim');
      const secilenHastaNot = document.getElementById('secilenHastaNot');
      const hastaBilgiButonlar = document.getElementById('hastaBilgiButonlar');
      
      if (secilenHastaIsim) {
        secilenHastaIsim.textContent = 'Hasta Seçilmedi';
      }
      if (secilenHastaNot) {
        secilenHastaNot.textContent = 'Lütfen sol menüden bir hasta seçin';
      }
      if (hastaBilgiButonlar) {
        hastaBilgiButonlar.style.display = 'none';
      }
      
      // Seçili hastayı temizle
      seciliHasta = null;
      
      // Hafta tablarını temizle
      const haftaTabs = document.getElementById('haftaTabs');
      const haftaTabContent = document.getElementById('haftaTabContent');
      if (haftaTabs) haftaTabs.innerHTML = '';
      if (haftaTabContent) haftaTabContent.innerHTML = '';
      
      // Cache'i temizle
      if (typeof cokluPdfHastaCache !== 'undefined') {
        console.log('🧹 Cache temizleniyor...');
        cokluPdfHastaCache.clear();
      }
      
      // Sol sidebar'da vurgulamayı kaldır
      renderHastalar();
    }


    // --- Hasta Haftaları ---
    function getHaftaListesi() {
      if (!seciliHasta) {
        console.log('🔍 getHaftaListesi: seciliHasta yok');
        return [];
      }
      if (!seciliHasta.haftalar) {
        console.log('🔍 getHaftaListesi: haftalar array yok, oluşturuluyor');
        seciliHasta.haftalar = [];
      }
      
      console.log(`🔍 getHaftaListesi: ${seciliHasta.haftalar.length} hafta bulundu`);
      console.log('🔍 getHaftaListesi detay:', seciliHasta.haftalar.map(h => ({ haftaNo: h.haftaNo, baslangic: h.baslangic, bitis: h.bitis, pdfName: h.pdfName })));
      
      // Hafta listesini hafta numarasına göre sırala (küçükten büyüğe)
      const sorted = seciliHasta.haftalar.sort((a, b) => {
        const aHaftaNo = a.haftaNo || 1;
        const bHaftaNo = b.haftaNo || 1;
        return aHaftaNo - bHaftaNo;
      });
      
      console.log(`🔍 getHaftaListesi: Sıralanmış ${sorted.length} hafta döndürülüyor`);
      return sorted;
    }

    function haftaEkle() {
      if (!seciliHasta) return;
      if (!seciliHasta.haftalar) seciliHasta.haftalar = [];
      
      // Bir sonraki hafta numarasını hesapla
      let sonrakiHaftaNo = 1;
      if (seciliHasta.haftalar.length > 0) {
        const sonHafta = seciliHasta.haftalar[seciliHasta.haftalar.length - 1];
        sonrakiHaftaNo = (sonHafta.haftaNo || seciliHasta.haftalar.length) + 1;
      }
      
      let startDate = null;
      if (seciliHasta.haftalar.length > 0) {
        // ⚡ ÖNEMLİ: En büyük hafta numarasına sahip haftayı bul (tarih sırası değil!)
        const haftaListesi = getHaftaListesi();
        
        let enBuyukHaftaNoHafta = haftaListesi[0];
        let enBuyukHaftaNo = enBuyukHaftaNoHafta.haftaNo || 1;
        
        // En büyük hafta numarasını bul
        haftaListesi.forEach(hafta => {
          const haftaNo = hafta.haftaNo || 1;
          if (haftaNo > enBuyukHaftaNo) {
            enBuyukHaftaNo = haftaNo;
            enBuyukHaftaNoHafta = hafta;
          }
        });
        
        console.log('📅 En büyük hafta numarası:', enBuyukHaftaNo, 'Tarihi:', enBuyukHaftaNoHafta.baslangic, '-', enBuyukHaftaNoHafta.bitis);
        
        // ⚡ ÇÖZÜM: Tab'da görünen tarihi hesapla (PDF'den gelen özel format vs. dikkate al)
        let tabGoruntulenenBitisTarihi = null;
        
        // Özel tab formatı kontrolü
        if (enBuyukHaftaNoHafta.ozelTabFormat && enBuyukHaftaNoHafta.tabTarih) {
          // PDF'den gelen uzun tarih aralığı için özel format - son tarihi çıkar
          const tabTarih = enBuyukHaftaNoHafta.tabTarih;
          const tarihParcalari = tabTarih.split(' - ');
          if (tarihParcalari.length === 2) {
            const bitisParcasi = tarihParcalari[1].trim();
            // MM/DD formatından yıl ekle
            const [ay, gun] = bitisParcasi.split('/');
            const yil = new Date().getFullYear();
            tabGoruntulenenBitisTarihi = `${yil}-${ay.padStart(2, '0')}-${gun.padStart(2, '0')}`;
          }
        } else {
          // Normal hafta verisi - bitiş tarihini al
          tabGoruntulenenBitisTarihi = enBuyukHaftaNoHafta.bitis;
        }
        
        console.log('📅 Tab\'da görünen bitiş tarihi:', tabGoruntulenenBitisTarihi);
        
        try {
          if (tabGoruntulenenBitisTarihi) {
            // ⚡ ÖNEMLİ: Tab'da görünen bitiş tarihinden 1 gün sonra başla
            const tabBitis = new Date(tabGoruntulenenBitisTarihi + 'T00:00:00');
            startDate = new Date(tabBitis.getTime() + 1*24*60*60*1000);
            console.log('📅 Tab bitiş tarihinden yeni hafta başlangıcı hesaplandı:', startDate.toISOString().slice(0,10));
          } else {
            throw new Error('Tab bitiş tarihi bulunamadı');
          }
          
          // Tarih geçerli mi kontrol et
          if (isNaN(startDate.getTime())) {
            throw new Error('Geçersiz tarih');
          }
        } catch (e) {
          console.warn('Son hafta tarih hatası:', e);
          // Bugünden başla
          const now = new Date();
          const day = now.getDay();
          const diff = (day === 0 ? 1 : 8 - day); // Gelecek pazartesi
          startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() + diff);
        }
      } else {
        // İlk hafta için bugünün pazartesisi
        const now = new Date();
        const day = now.getDay();
        const diff = (day === 0 ? -6 : 1) - day; // Pazartesiye çek
        startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() + diff);
      }
      
      // Final güvenlik kontrolü
      if (!startDate || isNaN(startDate.getTime())) {
        startDate = new Date(); // En son çare olarak bugün
      }
      
      // Varsayılan olarak 7 gün (1 hafta) süreli yap
      const endDate = new Date(startDate.getTime() + 6*24*60*60*1000); // 6 gün ekle (toplam 7 gün)
      
      console.log('📅 Yeni hafta tarihleri hesaplandı:', {
        haftaNo: sonrakiHaftaNo,
        startDate: startDate.toISOString().slice(0,10),
        endDate: endDate.toISOString().slice(0,10),
        gunSayisi: Math.round((endDate - startDate) / (24*60*60*1000)) + 1
      });
      
      seciliHasta.haftalar.push({
        haftaNo: sonrakiHaftaNo, // YENİ: Hafta numarası
        baslangic: startDate.toISOString().slice(0,10),
        bitis: endDate.toISOString().slice(0,10),
        aciklama: '',
        pdf: null,
        pdfName: null,  // PDF güvenli dosya adı
        pdfOrijinalIsim: null,  // PDF'nin orijinal dosya adı
        pdfYolu: null,  // GitHub'daki PDF yolu (pdfs/dosya.pdf)
        githubUrl: null,  // GitHub'da görüntüleme linki
        indirmeUrl: null,  // Direkt indirme linki
        kayitTarihi: null, // PDF yükleme tarihi
        tarifKartlar: [],
        tarifler: [],
        gptMesaj: '',
        kilitli: false, // YENİ: Emniyet kilidi (false = açık)
        kayitTarihi: null // Kaydedilme tarihi
      });
      saveToStorage();
      
      console.log('✅ Yeni hafta eklendi:', sonrakiHaftaNo, 'numaralı hafta');
      
      // Otomatik kaydetme - hafta eklendi
      autoSaveHastaData(seciliHasta);
      
      // ⚡ ÖNEMLİ: GitHub'a da kaydet (hemen)
      console.log('💾 Yeni hafta GitHub\'a kaydediliyor...');
      hastayiAyriKaydet(seciliHasta).then(() => {
        console.log('✅ Yeni hafta GitHub\'a kaydedildi');
      }).catch(e => {
        console.warn('⚠️ GitHub kaydı başarısız:', e);
      });
      
      // ⚡ ÖNEMLİ: Hasta listesini güncelle (yan taraftaki hafta numarası için)
      console.log('🔄 Hasta listesi güncelleniyor (hafta numarası için)...');
      renderHastalar();
      
      // Tab sistemini yeniden yükle ve yeni tab'a geç
      gosterHaftalar();
      const yeniTabIndex = seciliHasta.haftalar.length - 1;
      
      // 5. hafta kontrolü - Lenf Drenaj Takvimi otomatik oluştur
      if (sonrakiHaftaNo === 5) {
        setTimeout(() => {
          if (confirm(`🏥 5. hafta eklendi!\n\nLenf Drenaj Masajı Takvimi otomatik olarak oluşturulsun mu?`)) {
            generateLenfDrenajTakvimi();
          }
        }, 500);
      }
      
      setTimeout(() => {
        switchTab(yeniTabIndex);
        // Sidebar'ları güncelle
        hastaSecildiginde(hastalar.findIndex(h => h.id === seciliHasta.id));
      }, 100);
    }

    // Hafta verilerini normalize et (eski data format uyumluluğu için)
    function normalizeHaftaData() {
      if (!seciliHasta || !seciliHasta.haftalar) return;
      
      let dataUpdated = false;
      
      seciliHasta.haftalar.forEach((hafta, index) => {
        // Hafta numarası yoksa ekle
        if (!hafta.haftaNo) {
          hafta.haftaNo = index + 1;
          dataUpdated = true;
        }
        
        // Tarif kartları alanı yoksa ekle
        if (!hafta.tarifKartlar) {
          hafta.tarifKartlar = [];
          dataUpdated = true;
        }
        
        // Tarifler alanı yoksa ekle
        if (!hafta.tarifler) {
          hafta.tarifler = [];
          dataUpdated = true;
        }
        
        // GPT mesaj alanı yoksa ekle
        if (hafta.gptMesaj === undefined) {
          hafta.gptMesaj = '';
          dataUpdated = true;
        }
        
        // Açıklama alanı yoksa ekle
        if (hafta.aciklama === undefined) {
          hafta.aciklama = '';
          dataUpdated = true;
        }
        
        // PDF alanı yoksa ekle
        if (hafta.pdf === undefined) {
          hafta.pdf = null;
          dataUpdated = true;
        }
        
        // PDF dosya adı yoksa ekle
        if (hafta.pdfName === undefined) {
          hafta.pdfName = null;
          dataUpdated = true;
        }
        
        // PDF orijinal isim yoksa ekle
        if (hafta.pdfOrijinalIsim === undefined) {
          hafta.pdfOrijinalIsim = hafta.pdfName; // Mevcut pdfName'i kopyala
          dataUpdated = true;
        }
        
        // PDF yolu yoksa ekle
        if (hafta.pdfYolu === undefined) {
          hafta.pdfYolu = null;
          dataUpdated = true;
        }
        
        // GitHub URL'leri yoksa ekle
        if (hafta.githubUrl === undefined) {
          hafta.githubUrl = null;
          dataUpdated = true;
        }
        
        if (hafta.indirmeUrl === undefined) {
          hafta.indirmeUrl = null;
          dataUpdated = true;
        }
        
        // Kayıt tarihi yoksa ekle
        if (hafta.kayitTarihi === undefined) {
          hafta.kayitTarihi = null;
          dataUpdated = true;
        }
        
        // Kilit durumu yoksa ekle (varsayılan: kilitli değil)
        if (hafta.kilitli === undefined) {
          hafta.kilitli = false;
          dataUpdated = true;
        }
        
        // Başlangıç ve bitiş tarihleri yoksa oluştur
        if (!hafta.baslangic || !hafta.bitis) {
          try {
            const now = new Date();
            // Bu haftanın pazartesini bul
            const thisWeekMonday = new Date(now.getFullYear(), now.getMonth(), now.getDate() - now.getDay() + 1);
            // İstenen hafta için pazartesi (index * 7 gün ekle)
            const weekStart = new Date(thisWeekMonday.getTime() + (index * 7 * 24 * 60 * 60 * 1000));
            const weekEnd = new Date(weekStart.getTime() + 6*24*60*60*1000);
            
            hafta.baslangic = weekStart.toISOString().slice(0,10);
            hafta.bitis = weekEnd.toISOString().slice(0,10);
            dataUpdated = true;
          } catch (e) {
            console.warn('Tarih oluşturma hatası hafta', index + 1, ':', e);
          }
        } else {
          // ⚡ ÖNEMLİ: PDF'den özel tarih aralığı gelen haftaları normalize etme!
          if (hafta.ozelTabFormat) {
            console.log(`📅 ${index + 1}. hafta PDF'den özel tarih aralığına sahip, normalize edilmiyor`);
            return; // Bu haftayı normal hizalama işleminden çıkar
          }
          
          // Mevcut başlangıç tarihinin pazartesi olmasını garanti altına al
          try {
            const baslangicTarihi = new Date(hafta.baslangic);
            const gunNo = baslangicTarihi.getDay(); // 0=Pazar, 1=Pazartesi
            
            if (gunNo !== 1) { // Pazartesi değilse düzelt
              const gunFarki = gunNo === 0 ? 1 : (1 - gunNo); // Pazartesiye kadar olan gün farkı
              baslangicTarihi.setDate(baslangicTarihi.getDate() + gunFarki);
              
              // Bitiş tarihini de güncelle (6 gün sonra pazar)
              const bitisTarihi = new Date(baslangicTarihi.getTime() + 6*24*60*60*1000);
              
              hafta.baslangic = baslangicTarihi.toISOString().slice(0,10);
              hafta.bitis = bitisTarihi.toISOString().slice(0,10);
              dataUpdated = true;
              
              console.log(`📅 ${index + 1}. hafta başlangıcı pazartesi olarak düzeltildi:`, hafta.baslangic);
            }
          } catch (e) {
            console.warn('Tarih düzeltme hatası hafta', index + 1, ':', e);
          }
        }
      });
      
      if (dataUpdated) {
        console.log('🔄 Hafta verileri normalize edildi');
        saveToStorage();
      }
    }

    function gosterHaftalar() {
      // PDF yükleme devam ediyorsa hafta render işlemlerini engelle
      if (window.pdfYuklemeDevamEdiyor) {
        console.log('🚫 PDF yükleme devam ediyor, gosterHaftalar atlanıyor');
        return;
      }
      
      const tabsDiv = document.getElementById('haftaTabs');
      const contentDiv = document.getElementById('haftaTabContent');
      
      if (!tabsDiv || !contentDiv) return;
      
      // CSS class'ını garanti et
      tabsDiv.className = 'hafta-tabs';
      tabsDiv.style.display = 'flex';
      tabsDiv.style.flexWrap = 'wrap';
      tabsDiv.style.gap = '5px';
      console.log('🏷️ Hafta tabs CSS class atandı:', tabsDiv.className);
      console.log('🏷️ Hafta tabs computed style:', window.getComputedStyle(tabsDiv).display);
      
      tabsDiv.innerHTML = '';
      contentDiv.innerHTML = '';
      
      // Hafta verilerini normalize et
      normalizeHaftaData();
      
      const haftalar = getHaftaListesi();
      
      // DEBUG: Hafta verilerini detaylı logla
      console.log('🔍 HAFTA VERİLERİ DEBUG:');
      console.log('🔍 SeciliHasta:', seciliHasta?.isim);
      console.log('🔍 SeciliHasta haftalar count:', seciliHasta?.haftalar?.length);
      console.log('🔍 GetHaftaListesi count:', haftalar?.length);
      console.log('🔍 Hafta detayları:', haftalar.map(h => ({
        haftaNo: h.haftaNo,
        baslangic: h.baslangic,
        bitis: h.bitis,
        hasPdf: !!h.pdf,
        pdfName: h.pdfName || h.pdfOrijinalIsim || 'yok'
      })));
      
      // Cache'i kontrol et
      if (typeof cokluPdfHastaCache !== 'undefined') {
        const cacheKey = seciliHasta?.isim?.toUpperCase();
        const cachedData = cokluPdfHastaCache.get(cacheKey);
        console.log('🔍 Cache\'te bu hasta:', !!cachedData);
        if (cachedData) {
          console.log('🔍 Cache\'teki hafta sayısı:', cachedData.haftalar?.length);
          console.log('🔍 Cache\'teki haftalar:', cachedData.haftalar?.map(h => ({
            haftaNo: h.haftaNo,
            baslangic: h.baslangic,
            bitis: h.bitis
          })));
        }
      }
      
      // Backward compatibility: Mevcut haftalara hafta numarası ekle
      let haftaNumarasiDegisti = false;
      haftalar.forEach((hafta, i) => {
        if (!hafta.haftaNo) {
          hafta.haftaNo = i + 1;
          haftaNumarasiDegisti = true;
        }
      });
      if (haftaNumarasiDegisti) {
        saveToStorage();
        console.log('🔄 Mevcut haftalara hafta numaraları eklendi');
      }
      
      // Tabları oluştur
      haftalar.forEach((hafta, i) => {
        const haftaNo = hafta.haftaNo || (i + 1);
        
        // Tab başlığı oluştur - İLK TAB AKTİF OLSUN (son tıklanan kalacak)
        const tabDiv = document.createElement('div');
        tabDiv.className = `hafta-tab ${i === 0 ? 'active' : ''} ${hafta.kilitli ? 'locked' : ''}`;
        tabDiv.dataset.haftaIndex = i; // Dataset ekle
        tabDiv.onclick = () => switchTab(i);
        
        // Status göstergeleri
        const hasPdf = hafta.pdf ? 'status-pdf' : 'status-empty';
        const hasKartlar = (hafta.tarifKartlar && hafta.tarifKartlar.length > 0) ? 'status-kartlar' : 'status-empty';
        const hasEslesen = (hafta.tarifler && hafta.tarifler.length > 0) ? 'status-eslesen' : 'status-empty';
        const isLocked = hafta.kilitli ? 'status-locked' : 'status-empty';
        
        // Tarih bilgilerini güvenli şekilde kontrol et
        const baslangicTarih = hafta.baslangic || '';
        const bitisTarih = hafta.bitis || '';
        let tarihGosterim = '';
        let detayTarihGosterim = '';
        
        // Özel tab formatı kontrolü
        if (hafta.ozelTabFormat && hafta.tabBaslik && hafta.tabTarih) {
          // PDF'den gelen uzun tarih aralığı için özel format
          tarihGosterim = hafta.tabTarih;
          detayTarihGosterim = hafta.tabTarih; // Detay için de aynı format
        } else if (baslangicTarih && bitisTarih) {
          try {
            // Tarihleri parse et ve doğru formatta göster
            const basDate = new Date(baslangicTarih);
            const bitDate = new Date(bitisTarih);
            
            if (!isNaN(basDate.getTime()) && !isNaN(bitDate.getTime())) {
              const basAy = String(basDate.getMonth() + 1).padStart(2, '0');
              const basGun = String(basDate.getDate()).padStart(2, '0');
              const bitAy = String(bitDate.getMonth() + 1).padStart(2, '0');
              const bitGun = String(bitDate.getDate()).padStart(2, '0');
              tarihGosterim = `${basAy}/${basGun} - ${bitAy}/${bitGun}`;
              detayTarihGosterim = `${basDate.getFullYear()}-${basAy}-${basGun} - ${bitDate.getFullYear()}-${bitAy}-${bitGun}`;
            }
          } catch (e) {
            console.warn('Tarih parse hatası:', e);
            tarihGosterim = 'Tarih belirtilmemiş';
            detayTarihGosterim = 'Tarih belirtilmemiş';
          }
        } else {
          tarihGosterim = 'Tarih belirtilmemiş';
          detayTarihGosterim = 'Tarih belirtilmemiş';
        }
        
        // Tab başlığını belirle
        const tabBaslik = hafta.ozelTabFormat && hafta.tabBaslik ? hafta.tabBaslik : `${haftaNo}. Hafta`;
        
        tabDiv.innerHTML = `
          <div style="font-weight: bold; font-size: 14px;">${tabBaslik}</div>
          <div style="font-size: 10px; color: #666; margin-top: 2px;">
            ${tarihGosterim}
          </div>
          <div class="tab-status-indicators">
            <span class="status-indicator ${hasPdf}" title="PDF durumu"></span>
            <span class="status-indicator ${hasKartlar}" title="Manuel kartlar"></span>
            <span class="status-indicator ${hasEslesen}" title="Eşleşen kartlar"></span>
            <span class="status-indicator ${isLocked}" title="Kilit durumu"></span>
          </div>
          ${hafta.kilitli ? '<span class="tab-lock-icon">🔒</span>' : ''}
        `;
        tabsDiv.appendChild(tabDiv);
        console.log(`🏷️ ${haftaNo}. hafta tab'ı eklendi, CSS class:`, tabDiv.className);
        
        // Tab içeriği oluştur - İLK TAB AKTİF OLSUN (son tıklanan kalacak)
        const contentTab = document.createElement('div');
        contentTab.className = `hafta-tab-content ${i === 0 ? 'active' : ''}`;
        contentTab.id = `haftaContent_${i}`;
        
        contentTab.innerHTML = `
          <div class="hafta-tab-header">
            <div style="display: flex; align-items: center; gap: 15px;">
              <div style="display: flex; align-items: center; gap: 5px;">
                <span id="haftaNoDisplay_${i}" style="font-weight: bold; font-size: 18px; cursor: text; padding: 4px 8px; border-radius: 4px; min-width: 20px; text-align: center;" 
                      onclick="editHaftaNo(${i})" title="Hafta numarasını düzenlemek için tıklayın">${haftaNo}</span>
                <span style="font-weight: bold; font-size: 18px;">. Hafta</span>
                <input type="number" id="haftaNo_${i}" value="${haftaNo}" min="1" max="52" 
                       style="display: none; width: 50px; font-weight: bold; text-align: center; border: 2px solid #007bff; border-radius: 4px; padding: 4px;"
                       onblur="saveHaftaNo(${i})" onkeypress="if(event.key==='Enter') saveHaftaNo(${i})">
              </div>
              <span style="color: #666; font-size: 14px;">📅 ${detayTarihGosterim}</span>
            </div>
            <div style="display: flex; gap: 5px;">
              ${!hafta.kilitli ? `
                <button onclick="haftaKaydet(${i})" class="kayit-btn" style="padding: 5px 12px; font-size: 12px;">  Kilitle</button>
              ` : `
                <button class="kayit-btn saved" style="padding: 5px 12px; font-size: 12px;">🔒 Kilitli</button>
                <button onclick="haftaKilidiAc(${i})" class="kilit-ac-btn" style="padding: 5px 10px; font-size: 11px;">🔓 Kilidi Aç</button>
              `}
              <button onclick="duzenleHafta(${i})" style="padding: 5px 10px; font-size: 12px;">Düzenle</button>
              <button onclick="silHafta(${i})" style="padding: 5px 10px; font-size: 12px; color: red;">Sil</button>
              ${haftaNo === 5 ? `<button onclick="haftaZipIndir(${i}, 5)" style="padding: 5px 10px; font-size: 12px; background: #17a2b8; color: white; border: none; border-radius: 4px;" title="5. hafta özel ZIP (Kilitli durumda da kullanılabilir)">📦 ZIP</button>` : ''}
              ${haftaNo === 9 ? `<button onclick="haftaZipIndir(${i}, 9)" style="padding: 5px 10px; font-size: 12px; background: #6f42c1; color: white; border: none; border-radius: 4px;" title="9. hafta özel ZIP (Kilitli durumda da kullanılabilir)">📦 ZIP</button>` : ''}
            </div>
          </div>
          
          <!-- Ana İçerik - Horizontal Layout (2 kolon: PDF ve Açıklama) -->
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
            
            <!-- PDF Bölümü -->
            <div style="padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #28a745;" class="${hafta.kilitli ? 'locked-area' : ''}">
              <h4 style="margin: 0 0 10px 0; color: #28a745; font-size: 14px;">📄 PDF</h4>
              <input type="file" accept="application/pdf" onchange="pdfYukleHafta(${i}, this)" 
                     style="width: 100%; margin-bottom: 10px; font-size: 12px;" ${hafta.kilitli ? 'disabled' : ''}>
              ${hafta.pdf || hafta.pdfYolu ? `
                <div style="color: green; font-weight: bold; font-size: 12px; background: #d4edda; padding: 8px; border-radius: 4px; border-left: 3px solid #28a745;">
                  ✅ <strong style="color: #155724; font-size: 13px;">${hafta.pdfOrijinalIsim || hafta.pdfName || 'hafta.pdf'}</strong>
                  ${hafta.pdfOrijinalIsim && hafta.pdfName && hafta.pdfOrijinalIsim !== hafta.pdfName ? `
                    <div style="color: #6c757d; font-size: 11px; margin-top: 2px;">
                      📁 Güvenli ad: ${hafta.pdfName}
                    </div>
                  ` : ''}
                  <div style="color: #666; font-weight: normal; margin-top: 5px; font-size: 11px;">
                    📊 ${hafta.tarifler ? hafta.tarifler.length : 0} tarif tespit edildi
                  </div>
                  <div style="color: #495057; font-weight: normal; margin-top: 3px; font-size: 10px;">
                    📅 Yüklenme: ${hafta.kayitTarihi ? new Date(hafta.kayitTarihi).toLocaleString('tr-TR') : 'Bilinmiyor'}
                  </div>
                  ${hafta.githubUrl || hafta.githubLink ? `
                    <div style="margin-top: 8px; padding-top: 5px; border-top: 1px solid #c3e6cb;">
                      <a href="javascript:void(0)" onclick="pdfGoruntule('${hafta.indirmeUrl || hafta.githubRawLink || hafta.githubUrl}')" style="color: #0066cc; text-decoration: none; font-size: 11px; display: inline-flex; align-items: center; gap: 3px;">
                        <span style="font-size: 12px;">👁️</span> PDF Görüntüle
                      </a>
                      <span style="margin: 0 5px; color: #dee2e6;">|</span>
                      <a href="${hafta.githubUrl || hafta.githubLink}" target="_blank" style="color: #666; text-decoration: none; font-size: 11px; display: inline-flex; align-items: center; gap: 3px;">
                        <span style="font-size: 12px;">🔗</span> GitHub'da Görüntüle
                      </a>
                      ${hafta.indirmeUrl || hafta.githubRawLink ? `
                        <span style="margin: 0 5px; color: #dee2e6;">|</span>
                        <a href="javascript:void(0)" onclick="pdfIndir('${hafta.indirmeUrl || hafta.githubRawLink}', '${hafta.pdfOrijinalIsim || hafta.pdfName}')" style="color: #28a745; text-decoration: none; font-size: 11px; display: inline-flex; align-items: center; gap: 3px;">
                          <span style="font-size: 12px;">💾</span> İndir
                        </a>
                      ` : ''}
                    </div>
                  ` : ''}
                </div>
              ` : '<div style="color: #666; font-size: 12px; background: #f8f9fa; padding: 8px; border-radius: 4px;">📄 PDF henüz yüklenmedi</div>'}
            </div>
            
            <!-- Tarif Kartları Bölümü - GİZLENDİ -->
            <div style="display: none; padding: 15px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;">
              <h4 style="margin: 0 0 10px 0; color: #856404; font-size: 14px;">🖼️ Tarif Kartları</h4>
              <input type="file" accept="image/jpeg,image/jpg,image/png" multiple 
                     onchange="tarifKartYukleHafta(${i}, this)" style="width: 100%; font-size: 12px;">
              <div id="haftaKartGorsel_${i}" style="margin-top: 10px;"></div>
            </div>
            
            <!-- Açıklama Bölümü -->
            <div style="padding: 15px; background: #d1ecf1; border-radius: 8px; border-left: 4px solid #17a2b8;" class="${hafta.kilitli ? 'locked-area' : ''}">
              <h4 style="margin: 0 0 10px 0; color: #0c5460; font-size: 14px;">📝 Açıklama</h4>
              <input type="text" id="aciklama_${i}" value="${hafta.aciklama||''}" 
                     placeholder="Bu hafta hakkında not..." 
                     style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #bee5eb; font-size: 12px;"
                     onchange="aciklamaKaydet(${i})" ${hafta.kilitli ? 'readonly' : ''}>>
            </div>
          </div>
          
          <!-- GPT Mesajı - Grid'in Altında -->
          <div style="margin-bottom: 20px;" class="${hafta.kilitli ? 'locked-area' : ''}">
            <h4 style="margin: 0 0 10px 0; color: #dc3545; font-size: 16px;">💬 ${haftaNo}. Haftanın Mesajı</h4>
            <textarea id="gptMesaj_${i}" rows="3" 
                      style="width: 100%; padding: 10px; border-radius: 4px; border: 1px solid #ddd; resize: vertical;"
                      placeholder="Bu hafta için GPT mesajı veya not..."
                      ${hafta.kilitli ? 'disabled' : ''}>${hafta.gptMesaj||''}</textarea>
            <div style="margin-top: 10px; display: flex; justify-content: space-between; align-items: center;">
              <div>
                <button onclick="gptMesajKaydet(${i})" style="padding: 8px 15px; font-size: 12px;" ${hafta.kilitli ? 'disabled' : ''}>💾 Kaydet</button>
                <button onclick="kopyalaGptMesaj(${i})" style="padding: 8px 15px; margin-left: 10px; font-size: 12px;">📋 Kopyala</button>
              </div>
              <div>
                <button onclick="zipEslesenGorseller(${i})" style="
                  padding: 8px 12px; 
                  font-size: 12px; 
                  background: #17a2b8; 
                  color: white; 
                  border: none; 
                  border-radius: 4px; 
                  cursor: pointer;
                  font-weight: bold;
                " title="Haftalık PDF, eşleşen tarif kartları ve GPT mesajını tek ZIP dosyasında indirir${hafta.kilitli ? ' (Kilitli haftada da kullanılabilir)' : ''}">🗜️ ZIP İndir</button>
              </div>
            </div>
          </div>
          
          <!-- Eşleşen Kartlar - Full Width (Eski, Gizli) -->
          <div style="margin-bottom: 20px; display: none;">
            <h4 style="margin: 0 0 10px 0; color: #6f42c1; font-size: 16px;">🔗 Eşleşen Kartlar</h4>
            <div id="eslesenKartlar_${i}" style="border: 1px solid #ddd; padding: 15px; border-radius: 8px; background: #f9f9f9; min-height: 80px;"></div>
          </div>
          
          <!-- GPT Mesajı - Full Width (Eski, Gizli) -->
          <div style="margin-bottom: 20px; display: none;">
            <h4 style="margin: 0 0 10px 0; color: #dc3545; font-size: 16px;">💬 ${haftaNo}. Haftanın Mesajı</h4>
            <textarea id="gptMesaj_${i}" rows="3" 
                      style="width: 100%; padding: 10px; border-radius: 4px; border: 1px solid #ddd; resize: vertical;"
                      placeholder="Bu hafta için GPT mesajı veya not...">${hafta.gptMesaj||''}</textarea>
            <div style="margin-top: 10px;">
              <button onclick="gptMesajKaydet(${i})" style="padding: 8px 15px; font-size: 12px;">💾 Kaydet</button>
              <button onclick="kopyalaGptMesaj(${i})" style="padding: 8px 15px; margin-left: 10px; font-size: 12px;">📋 Kopyala</button>
            </div>
          </div>
        `;
        
        contentDiv.appendChild(contentTab);
        
        // Alt işlemleri çalıştır (async olarak)
        setTimeout(() => {
          gosterTariflerHafta(i);
          gosterKartlarHafta(i);
          
          // PDF yüklü ama tarifler yoksa otomatik tara
          if (hafta.pdf && (!hafta.tarifler || hafta.tarifler.length === 0)) {
            pdfOkuVeEsleHafta(i);
          } else if (hafta.tarifler && hafta.tarifler.length > 0) {
            otomatikEsleHafta(i);
          }
        }, 100 * i); // Sıralı yükleme
      });
      
      // "Hafta Ekle" tab'ını ekle
      const haftaEkleTab = document.createElement('div');
      haftaEkleTab.className = 'hafta-tab hafta-ekle-tab';
      haftaEkleTab.style.background = '#28a745';
      haftaEkleTab.style.color = 'white';
      haftaEkleTab.style.border = '2px solid #28a745';
      haftaEkleTab.onclick = () => haftaEkle();
      
      haftaEkleTab.innerHTML = `
        <div style="font-weight: bold; font-size: 14px;">+ Hafta Ekle</div>
        <div style="font-size: 10px; margin-top: 2px;">Yeni hafta oluştur</div>
      `;
      tabsDiv.appendChild(haftaEkleTab);
      
      // En yüksek hafta numaralı tab'ı aktif yap
      if (haftalar.length > 0) {
        // En büyük hafta numarasını bul
        let enBuyukHaftaIndex = 0;
        let enBuyukHaftaNo = haftalar[0].haftaNo || 1;
        
        haftalar.forEach((hafta, index) => {
          const haftaNo = hafta.haftaNo || (index + 1);
          if (haftaNo > enBuyukHaftaNo) {
            enBuyukHaftaNo = haftaNo;
            enBuyukHaftaIndex = index;
          }
        });
        
        console.log(`🎯 En büyük hafta numarası: ${enBuyukHaftaNo}, index: ${enBuyukHaftaIndex}`);
        
        // Hafta tabının içerikleri ve eşleşen kartlar tamamen yüklendikten sonra aktif tab'ı seç
        setTimeout(() => {
          console.log(`🔄 ${enBuyukHaftaIndex}. hafta tab'ı için eşleşen kartlar kontrol ediliyor...`);
          
          // Eşleşen kartların yüklenip yüklenmediğini kontrol et (maksimum 10 deneme)
          let denemeSayisi = 0;
          const maxDeneme = 10;
          
          const checkAndActivate = () => {
            denemeSayisi++;
            const eslesenDiv = document.getElementById(`eslesenKartlar_${enBuyukHaftaIndex}`);
            
            if (eslesenDiv && (eslesenDiv.children.length > 0 || eslesenDiv.innerHTML.includes('henüz eşleşme yok'))) {
              console.log(`✅ ${enBuyukHaftaIndex}. hafta için eşleşen kartlar hazır, tab aktif hale getiriliyor`);
              switchTab(enBuyukHaftaIndex);
            } else if (denemeSayisi < maxDeneme) {
              console.log(`⏳ ${enBuyukHaftaIndex}. hafta için eşleşen kartlar henüz hazır değil, 200ms daha bekleniyor... (${denemeSayisi}/${maxDeneme})`);
              setTimeout(checkAndActivate, 200);
            } else {
              console.log(`⚠️ ${enBuyukHaftaIndex}. hafta için eşleşen kartlar ${maxDeneme} denemede hazır olamadı, tab zorla aktif hale getiriliyor`);
              switchTab(enBuyukHaftaIndex);
            }
          };
          
          checkAndActivate();
        }, 500); // İlk gecikmeyi artırdık
      }
    }
    
    // Tab değiştirme fonksiyonu
    function switchTab(activeIndex) {
      // Tüm tabları pasif yap
      document.querySelectorAll('.hafta-tab').forEach((tab, index) => {
        tab.classList.toggle('active', index === activeIndex);
      });
      
      // Tüm içerikleri gizle
      document.querySelectorAll('.hafta-tab-content').forEach((content, index) => {
        content.classList.toggle('active', index === activeIndex);
      });
      
      // Sidebar'ları güncelle
      haftaTabSecildiginde(activeIndex);
      
      console.log(`🏷️ ${activeIndex + 1}. hafta tab'ına geçildi`);
    }
    
    // Tab değiştirme fonksiyonunu global yap
    window.switchTab = switchTab;

// Hafta açıklama kaydet (otomatik)
function aciklamaKaydet(i) {
  const haftalar = getHaftaListesi();
  const hafta = haftalar[i];
  const aciklamaInput = document.getElementById('aciklama_' + i);
  
  // Kilit kontrolü
  if (hafta.kilitli) {
    alert('🔒 Bu hafta kilitli! Açıklama değiştirmek için önce kilidi açın.');
    // Eski değeri geri yükle
    aciklamaInput.value = hafta.aciklama || '';
    return;
  }
  
  hafta.aciklama = aciklamaInput.value;
  saveToStorage();
  
  // Visual feedback
  aciklamaInput.style.backgroundColor = '#d4edda';
  aciklamaInput.style.borderColor = '#28a745';
  setTimeout(() => {
    aciklamaInput.style.backgroundColor = '';
    aciklamaInput.style.borderColor = '';
  }, 800);
  
  console.log('✅ Açıklama otomatik kaydedildi:', aciklamaInput.value);
  
  // YENİ SİSTEM: GitHub'a da kaydet
  if (seciliHasta) {
    hastayiAyriKaydet(seciliHasta).then(basarili => {
      if (basarili) {
        console.log('✅ Açıklama GitHub\'a da kaydedildi');
      } else {
        console.warn('⚠️ Açıklama localStorage\'a kaydedildi ama GitHub kaydı başarısız');
      }
    }).catch(error => {
      console.error('❌ GitHub kaydetme hatası:', error);
    });
  }
}

// Hafta numarası düzenleme (inline editing)
function editHaftaNo(i) {
  const displaySpan = document.getElementById(`haftaNoDisplay_${i}`);
  const inputField = document.getElementById(`haftaNo_${i}`);
  
  // Display'i gizle, input'u göster
  displaySpan.style.display = 'none';
  inputField.style.display = 'inline-block';
  inputField.focus();
  inputField.select();
  
  // Visual feedback
  inputField.style.backgroundColor = '#e3f2fd';
}

function saveHaftaNo(i) {
  const displaySpan = document.getElementById(`haftaNoDisplay_${i}`);
  const inputField = document.getElementById(`haftaNo_${i}`);
  const yeniHaftaNo = parseInt(inputField.value);
  
  if (yeniHaftaNo < 1 || yeniHaftaNo > 52 || isNaN(yeniHaftaNo)) {
    alert('Hafta numarası 1-52 arasında olmalıdır!');
    const haftalar = getHaftaListesi();
    inputField.value = haftalar[i].haftaNo || (i + 1);
    return;
  }
  
  // Veriyi kaydet
  const haftalar = getHaftaListesi();
  haftalar[i].haftaNo = yeniHaftaNo;
  saveToStorage();
  
  // UI'ı güncelle
  displaySpan.textContent = yeniHaftaNo;
  displaySpan.style.display = 'inline-block';
  inputField.style.display = 'none';
  inputField.style.backgroundColor = '';
  
  // Tab başlığını güncelle
  const tablar = document.querySelectorAll('.hafta-tab');
  if (tablar[i]) {
    const tabBaslik = tablar[i].querySelector('div:first-child');
    if (tabBaslik) {
      tabBaslik.textContent = `${yeniHaftaNo}. Hafta`;
    }
  }
  
  // Success feedback
  displaySpan.style.backgroundColor = '#d4edda';
  displaySpan.style.color = '#155724';
  setTimeout(() => {
    displaySpan.style.backgroundColor = '';
    displaySpan.style.color = '';
  }, 1000);
  
  console.log(`Hafta numarası güncellendi: ${yeniHaftaNo}. hafta`);
}

// Global fonksiyonlar
window.editHaftaNo = editHaftaNo;
window.saveHaftaNo = saveHaftaNo;

// Hafta numarası kaydet (eski fonksiyon - backward compatibility)
function haftaNoKaydet(i) {
  saveHaftaNo(i);
}

// PDF dosya adından hafta numarasını çıkar
function pdfDosyaAdindenHaftaNoAl(dosyaAdi) {
  if (!dosyaAdi) return null;
  
  // Farklı hafta formatlarını kontrol et
  const patterns = [
    /(\d+)\.?\s*hafta/i,           // "8. hafta", "8 hafta", "8.hafta"
    /hafta\s*(\d+)/i,              // "hafta 8", "hafta8"
    /week\s*(\d+)/i,               // "week 8", "week8"
    /(\d+)\.?\s*week/i,            // "8. week", "8 week"
    /w(\d+)/i,                     // "w8", "W8"
    /(\d+)\.?\s*hf/i,              // "8. hf", "8 hf", "8hf"
    /hf\s*(\d+)/i,                 // "hf 8", "hf8"
    /(\d+)\.?\s*h(?![a-z])/i,      // "8. h", "8 h", "8h" (ama "hafta" olmayacak)
  ];
  
  for (let pattern of patterns) {
    const match = dosyaAdi.match(pattern);
    if (match) {
      const haftaNo = parseInt(match[1]);
      if (haftaNo >= 1 && haftaNo <= 52) {
        console.log(`📅 PDF dosya adından hafta numarası bulundu: "${dosyaAdi}" → ${haftaNo}. hafta`);
        return haftaNo;
      }
    }
  }
  
  console.log(`⚠️ PDF dosya adından hafta numarası çıkarılamadı: "${dosyaAdi}"`);
  return null;
}

// PDF içeriğinden hafta numarasını çıkar
function pdfIcerigindenhaftaNoAl(pdfIcerik) {
  if (!pdfIcerik) return null;
  
  // İlk birkaç satırdan hafta numarasını ara
  const ilkSatirlar = pdfIcerik.split('\n').slice(0, 20).join(' ');
  
  const patterns = [
    /(\d+)\.?\s*hafta/i,
    /hafta\s*(\d+)/i,
    /week\s*(\d+)/i,
    /(\d+)\.?\s*week/i,
  ];
  
  for (let pattern of patterns) {
    const match = ilkSatirlar.match(pattern);
    if (match) {
      const haftaNo = parseInt(match[1]);
      if (haftaNo >= 1 && haftaNo <= 52) {
        console.log(`📄 PDF içeriğinden hafta numarası bulundu: ${haftaNo}. hafta`);
        return haftaNo;
      }
    }
  }
  
  return null;
}

// Hafta sil
async function silHafta(i) {
  if (!seciliHasta) {
    alert('❌ Lütfen önce bir hasta seçin!');
    return;
  }

  const haftalar = getHaftaListesi();
  const silinecekHafta = haftalar[i];
  
  if (!silinecekHafta) {
    alert('❌ Silinecek hafta bulunamadı!');
    return;
  }

  if (!confirm(`Bu haftayı silmek istediğinize emin misiniz?\n\nHafta: ${silinecekHafta.haftaNo}\nTarih Aralığı: ${silinecekHafta.baslangic} - ${silinecekHafta.bitis}\n\n⚠️ Bu işlem geri alınamaz!`)) {
    return;
  }

  try {
    console.log(`🗑️ Hafta ${silinecekHafta.haftaNo} siliniyor...`);
    
    // 1. Web arayüzünden sil
    haftalar.splice(i, 1);
    console.log('✅ Hafta web arayüzünden silindi');
    
    // 2. Cache'den sil (localStorage)
    try {
      const cacheKey = `hasta_${seciliHasta.id}`;
      const cachedData = localStorage.getItem(cacheKey);
      if (cachedData) {
        const parsedData = JSON.parse(cachedData);
        if (parsedData.haftalar) {
          parsedData.haftalar = parsedData.haftalar.filter(h => h.haftaNo !== silinecekHafta.haftaNo);
          localStorage.setItem(cacheKey, JSON.stringify(parsedData));
          console.log('✅ Hafta cache\'den silindi');
        }
      }
    } catch (cacheError) {
      console.warn('⚠️ Cache temizleme hatası:', cacheError);
    }
    
    // 3. Hasta JSON dosyasından sil (GitHub'a kaydet)
    try {
      // seciliHasta nesnesini de güncelle
      if (seciliHasta.haftalar) {
        seciliHasta.haftalar = seciliHasta.haftalar.filter(h => h.haftaNo !== silinecekHafta.haftaNo);
      }
      
      // GitHub'a kaydet
      const kaydedildi = await hastayiAyriKaydet(seciliHasta);
      if (kaydedildi) {
        console.log('✅ Hafta hasta JSON dosyasından silindi ve GitHub\'a kaydedildi');
      } else {
        console.warn('⚠️ GitHub\'a kaydetme başarısız, sadece yerel silme yapıldı');
      }
    } catch (githubError) {
      console.warn('⚠️ GitHub kaydetme hatası:', githubError);
    }
    
    // 4. UI'ı güncelle
    gosterHaftalar();
    
    // 5. Hasta listesini güncelle
    if (typeof updateHastaListesi === 'function') {
      updateHastaListesi();
    }
    
    console.log(`✅ Hafta ${silinecekHafta.haftaNo} başarıyla silindi`);
    alert(`✅ Hafta ${silinecekHafta.haftaNo} başarıyla silindi!`);
    
  } catch (error) {
    console.error('❌ Hafta silme hatası:', error);
    alert(`❌ Hafta silinirken hata oluştu: ${error.message}`);
  }
}

// Hafta düzenle (tarih ve açıklama)
function duzenleHafta(i) {
  const haftalar = getHaftaListesi();
  const hafta = haftalar[i];
  const yeniBaslangic = prompt('Yeni başlangıç tarihi (YYYY-MM-DD):', hafta.baslangic);
  if (!yeniBaslangic) return;
  const yeniBitis = prompt('Yeni bitiş tarihi (YYYY-MM-DD):', hafta.bitis);
  if (!yeniBitis) return;
  hafta.baslangic = yeniBaslangic;
  hafta.bitis = yeniBitis;
  hafta.aciklama = document.getElementById('aciklama_' + i).value;
  
  // Otomatik kaydetme - hafta düzenlendi
  autoSaveHastaData(seciliHasta);
  
  gosterHaftalar();
}

    // PDF'i GitHub'dan indirme fonksiyonu
    async function pdfIndir(githubRawLink, dosyaAdi) {
      try {
        console.log('📥 PDF indiriliyor:', dosyaAdi);
        
        const response = await fetch(githubRawLink);
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = dosyaAdi;
        document.body.appendChild(a);
        a.click();
        
        // Cleanup
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
        console.log('✅ PDF başarıyla indirildi:', dosyaAdi);
        
      } catch (error) {
        console.error('❌ PDF indirme hatası:', error);
        alert(`PDF indirilemedi: ${error.message}`);
      }
    }

    // PDF'i browser'da görüntüleme fonksiyonu
    function pdfGoruntule(pdfUrl) {
      try {
        console.log('👁️ PDF görüntüleniyor:', pdfUrl);
        
        if (!pdfUrl) {
          alert('PDF URL\'si bulunamadı.');
          return;
        }
        
        // Yeni sekmede PDF'i aç
        window.open(pdfUrl, '_blank');
        
      } catch (error) {
        console.error('❌ PDF görüntüleme hatası:', error);
        alert(`PDF görüntülenemedi: ${error.message}`);
      }
    }

    async function haftaZipIndir(haftaIndex, haftaNo) {
      try {
        console.log('🚀 ZIP fonksiyonu başlatıldı, hafta:', haftaNo);
        
        if (!seciliHasta) {
          alert('Lütfen önce bir hasta seçin!');
          return;
        }

        // GitHub değişkenlerini kontrol et
        console.log('🔍 GITHUB_REPO:', GITHUB_REPO);
        console.log('🔍 GITHUB_TOKEN var mı:', !!GITHUB_TOKEN);
        console.log('🔍 Seçili hasta:', seciliHasta.id);

        const haftalar = getHaftaListesi();
        if (!haftalar[haftaIndex]) {
          alert('Hafta bulunamadı!');
          return;
        }

        const hafta = haftalar[haftaIndex];
        console.log('🔍 Hafta bilgileri:', hafta);
        
        const hasta = await getHastaData(seciliHasta.id);
        
        // ZIP dosya adını oluştur
        const tarihAraligi = `${hafta.baslangic}_${hafta.bitis}`.replace(/\./g, '_').replace(/\s/g, '_');
        const hastaAdi = hasta.isim.toUpperCase().replace(/\s/g, '_').replace(/[İıÇçĞğÜüŞşÖö]/g, match => {
          const trMap = {'İ': 'I', 'ı': 'i', 'Ç': 'C', 'ç': 'c', 'Ğ': 'G', 'ğ': 'g', 'Ü': 'U', 'ü': 'u', 'Ş': 'S', 'ş': 's', 'Ö': 'O', 'ö': 'o'};
          return trMap[match] || match;
        });
        const zipAdi = `${hastaAdi}_${tarihAraligi}_${haftaNo}_HAFTA.ZIP`;

        // JSZip instance oluştur
        const zip = new JSZip();

        // 5. hafta için özel içerik
        if (haftaNo === 5) {
          // Menü PDF'si (5. hafta)
          if (hafta.pdfName || hafta.pdfOrijinalIsim) {
            try {
              if (!GITHUB_TOKEN) {
                console.warn('⚠️ GitHub token bulunamadı, PDF eklenemeyecek');
                return;
              }
              
              const pdfFileName = hafta.pdfName || hafta.pdfOrijinalIsim;
              const pdfUrl = `https://api.github.com/repos/${GITHUB_REPO}/contents/patients/${seciliHasta.id}/hafta_${haftaNo}_${pdfFileName}`;
              
              console.log('🔍 5. hafta PDF URL:', pdfUrl);
              console.log('🔍 PDF dosya adı:', pdfFileName);
              
              const pdfResponse = await fetch(pdfUrl, {
                headers: { 'Authorization': `token ${GITHUB_TOKEN}` }
              });
              
              console.log('🔍 PDF response status:', pdfResponse.status);
              
              if (pdfResponse.ok) {
                const pdfData = await pdfResponse.json();
                const pdfBlob = base64ToBlob(pdfData.content, 'application/pdf');
                zip.file(`MENU_PDF_${hafta.pdfOrijinalIsim || hafta.pdfName || 'menu.pdf'}`, pdfBlob);
                console.log('✅ 5. hafta Menü PDF eklendi:', pdfFileName);
              } else {
                const errorText = await pdfResponse.text();
                console.warn('❌ PDF yanıtı başarısız:', pdfResponse.status, errorText);
              }
            } catch (error) {
              console.warn('❌ Menü PDF eklenemedi:', error);
            }
          } else {
            console.warn('⚠️ 5. hafta PDF bilgisi bulunamadı');
          }

          // Eşleşen tarif kartları (5. hafta) - JPG dosyaları
          if (hafta.tarifKartlar && hafta.tarifKartlar.length > 0) {
            for (const kart of hafta.tarifKartlar) {
              try {
                const response = await fetch(kart.data);
                if (response.ok) {
                  const blob = await response.blob();
                  zip.file(`TARIF_KARTI_${kart.name}`, blob);
                  console.log(`✅ 5. hafta tarif kartı eklendi: ${kart.name}`);
                } else {
                  console.warn(`❌ Tarif kartı indirilemedi: ${kart.name}`);
                }
              } catch (error) {
                console.warn(`❌ Tarif kartı hatası: ${kart.name}`, error);
              }
            }
          } else {
            console.warn('⚠️ 5. hafta tarif kartı bulunamadı');
          }

          // GPT Mesajı (5. hafta)
          if (hafta.gptMesaj && hafta.gptMesaj.trim()) {
            zip.file('GPT_MESAJI.txt', hafta.gptMesaj.trim());
            console.log('✅ 5. hafta GPT mesajı eklendi');
          } else {
            console.warn('⚠️ 5. hafta GPT mesajı bulunamadı');
          }

          // 5. hafta için otomatik masaj planı PDF'si ekle
          console.log('🏥 5. hafta masaj PDF fonksiyonu çağrılıyor...');
          console.log('🔍 ÇAĞRI: haftalar verisi:', JSON.stringify(haftalar.slice(3, 6), null, 2)); // 4,5,6. haftaları göster
          await createAndAddLenfMasajPDF(zip, hasta, haftalar);
        }
        
        // 9. hafta için özel içerik
        if (haftaNo === 9) {
          // Menü PDF'si (9. hafta)
          if (hafta.pdfName || hafta.pdfOrijinalIsim) {
            try {
              if (!GITHUB_TOKEN) {
                console.warn('⚠️ GitHub token bulunamadı, PDF eklenemeyecek');
                return;
              }
              
              const pdfFileName = hafta.pdfName || hafta.pdfOrijinalIsim;
              const pdfUrl = `https://api.github.com/repos/${GITHUB_REPO}/contents/patients/${seciliHasta.id}/hafta_${haftaNo}_${pdfFileName}`;
              
              console.log('🔍 9. hafta PDF URL:', pdfUrl);
              console.log('🔍 PDF dosya adı:', pdfFileName);
              
              const pdfResponse = await fetch(pdfUrl, {
                headers: { 'Authorization': `token ${GITHUB_TOKEN}` }
              });
              
              console.log('🔍 PDF response status:', pdfResponse.status);
              
              if (pdfResponse.ok) {
                const pdfData = await pdfResponse.json();
                const pdfBlob = base64ToBlob(pdfData.content, 'application/pdf');
                zip.file(`MENU_PDF_${hafta.pdfOrijinalIsim || hafta.pdfName || 'menu.pdf'}`, pdfBlob);
                console.log('✅ 9. hafta Menü PDF eklendi:', pdfFileName);
              } else {
                const errorText = await pdfResponse.text();
                console.warn('❌ PDF yanıtı başarısız:', pdfResponse.status, errorText);
              }
            } catch (error) {
              console.warn('❌ Menü PDF eklenemedi:', error);
            }
          } else {
            console.warn('⚠️ 9. hafta PDF bilgisi bulunamadı');
          }

          // Eşleşen tarif kartları (9. hafta) - JPG dosyaları
          if (hafta.tarifKartlar && hafta.tarifKartlar.length > 0) {
            for (const kart of hafta.tarifKartlar) {
              try {
                const response = await fetch(kart.data);
                if (response.ok) {
                  const blob = await response.blob();
                  zip.file(`TARIF_KARTI_${kart.name}`, blob);
                  console.log(`✅ 9. hafta tarif kartı eklendi: ${kart.name}`);
                } else {
                  console.warn(`❌ Tarif kartı indirilemedi: ${kart.name}`);
                }
              } catch (error) {
                console.warn(`❌ Tarif kartı hatası: ${kart.name}`, error);
              }
            }
          } else {
            console.warn('⚠️ 9. hafta tarif kartı bulunamadı');
          }

          // GPT Mesajı (9. hafta)
          if (hafta.gptMesaj && hafta.gptMesaj.trim()) {
            zip.file('GPT_MESAJI.txt', hafta.gptMesaj.trim());
            console.log('✅ 9. hafta GPT mesajı eklendi');
          } else {
            console.warn('⚠️ 9. hafta GPT mesajı bulunamadı');
          }

          // 9. hafta için otomatik egzersiz takvimi PDF'si ekle
          console.log('🏃 9. hafta egzersiz PDF fonksiyonu çağrılıyor...');
          // Hafta verilerini tabdakiyle senkronize et
          const guncelHaftalar = getHaftaListesi();
          await createAndAddEgzersizPDF(zip, hasta, guncelHaftalar);
        }

        // ZIP dosyasını oluştur ve indir
        const zipBlob = await zip.generateAsync({type: 'blob'});
        
        const url = window.URL.createObjectURL(zipBlob);
        const a = document.createElement('a');
        a.href = url;
        a.download = zipAdi;
        document.body.appendChild(a);
        a.click();
        
        // Cleanup
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
        console.log(`✅ ${haftaNo}. hafta ZIP dosyası başarıyla indirildi:`, zipAdi);
        
      } catch (error) {
        console.error('❌ ZIP indirme hatası:', error);
        alert(`ZIP dosyası oluşturulamadı: ${error.message}`);
      }
    }

    // ⚡ YENİ: Belirli bir hafta tab'ının tarihini kullanarak masaj PDF'i oluştur
    async function generate5HaftaMasajPDF(besinciHaftaTab) {
      try {
        console.log('🤲 5. hafta tab\'ından masaj PDF oluşturuluyor...', { 
          haftaNo: besinciHaftaTab.haftaNo, 
          baslangic: besinciHaftaTab.baslangic,
          bitis: besinciHaftaTab.bitis
        });
        
        // Kütüphane kontrolü
        if (!window.jspdf) {
          console.error('❌ jsPDF kütüphanesi yüklenmemiş');
          return null;
        }
        
        // 5. hafta tab'ının başlangıç tarihini al
        const haftaBaslangici = new Date(besinciHaftaTab.baslangic + 'T00:00:00'); // Timezone safe
        console.log('✅ 5. hafta tab başlangıç tarihi:', haftaBaslangici.toLocaleDateString('tr-TR'));
        
        // PDF oluştur
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'mm', 'a4');
        
        // Hasta adını ASCII'ye çevir
        const asciiHastaAdi = seciliHasta.isim
            .replace(/Ş/g, 'S').replace(/ş/g, 's')
            .replace(/Ğ/g, 'G').replace(/ğ/g, 'g')
            .replace(/Ü/g, 'U').replace(/ü/g, 'u')
            .replace(/İ/g, 'I').replace(/ı/g, 'i')
            .replace(/Ö/g, 'O').replace(/ö/g, 'o')
            .replace(/Ç/g, 'C').replace(/ç/g, 'c');
        
        // Başlık
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(14);
        doc.setTextColor(0, 0, 0);
        
        const title = `${asciiHastaAdi.toUpperCase()}`;
        const titleWidth = doc.getTextWidth(title);
        doc.text(title, (210 - titleWidth) / 2, 20);
        
        doc.setFontSize(12);
        const subtitle = 'LENF DRENAJ MASAJI PROGRAMI';
        const subtitleWidth = doc.getTextWidth(subtitle);
        doc.text(subtitle, (210 - subtitleWidth) / 2, 28);
        
        // Açıklama kutusu
        doc.setFontSize(8);
        doc.setFont('helvetica', 'normal');
        doc.rect(15, 32, 170, 10);
        doc.text('8 Haftalik Lenf Drenaj Masaji Uygulama Programi', 20, 36);
        doc.text('(5. Haftadan itibaren) - Yesil check isareti tamamlanan gunler', 20, 40);
        
        let currentY = 50;
        const gunler = ['Pazartesi', 'Sali', 'Carsamba', 'Persembe', 'Cuma', 'Cumartesi', 'Pazar'];
        
        // 8 haftalık program (5-12. haftalar)
        for (let lenfHaftaIndex = 0; lenfHaftaIndex < 8; lenfHaftaIndex++) {
          const gercekHaftaNo = lenfHaftaIndex + 5; // 5. haftadan başlar
          const haftaBaslangic = new Date(haftaBaslangici.getTime() + (lenfHaftaIndex * 7 * 24 * 60 * 60 * 1000));
          
          // Sayfa sonu kontrolü
          if (currentY > 270) {
            doc.addPage();
            currentY = 20;
          }
          
          // Hafta başlığı
          doc.setTextColor(0, 0, 0);
          doc.setFont('helvetica', 'bold');
          doc.setFontSize(9);
          doc.rect(15, currentY, 170, 6);
          
          const haftaBaslangicStr = haftaBaslangic.toLocaleDateString('tr-TR');
          const haftaBitisStr = new Date(haftaBaslangic.getTime() + (6 * 24 * 60 * 60 * 1000)).toLocaleDateString('tr-TR');
          
          // ✅ 5. hafta masaj planı: Tüm haftalar normal siyah renkte
          doc.setTextColor(0, 0, 0);
          
          doc.text(`${gercekHaftaNo}. HAFTA (${haftaBaslangicStr} - ${haftaBitisStr})`, 20, currentY + 4);
          currentY += 8;
          
          // Tablo başlıkları
          doc.setTextColor(0, 0, 0);
          doc.setFont('helvetica', 'bold');
          doc.setFontSize(9);
          
          const colWidths = [30, 40, 50, 50];
          let tableStartX = 15;
          
          // Başlık satırı
          doc.rect(tableStartX, currentY, colWidths[0], 6);
          doc.text('TARIH', tableStartX + 2, currentY + 4);
          tableStartX += colWidths[0];
          
          doc.rect(tableStartX, currentY, colWidths[1], 6);
          doc.text('GUN', tableStartX + 2, currentY + 4);
          tableStartX += colWidths[1];
          
          doc.rect(tableStartX, currentY, colWidths[2], 6);
          doc.text('SABAH', tableStartX + 2, currentY + 4);
          tableStartX += colWidths[2];
          
          doc.rect(tableStartX, currentY, colWidths[3], 6);
          doc.text('AKSAM', tableStartX + 2, currentY + 4);
          currentY += 6;
          
          // Her gün için satır
          doc.setFont('helvetica', 'normal');
          doc.setFontSize(8);
          
          for (let gunIndex = 0; gunIndex < 7; gunIndex++) {
            const gunTarihi = new Date(haftaBaslangic.getTime() + (gunIndex * 24 * 60 * 60 * 1000));
            const tarihStr = gunTarihi.toLocaleDateString('tr-TR');
            const gun = gunler[gunIndex];
            
            // Masaj uygulama kontrolü
            let sabahUygulama = '-';
            let aksamUygulama = '-';
            
            if (lenfHaftaIndex < 2) {
              // İlk 2 hafta (5-6): Günde 2 kez
              sabahUygulama = 'Lenf Masaji';
              aksamUygulama = 'Lenf Masaji';
            } else if (lenfHaftaIndex < 4) {
              // Sonraki 2 hafta (7-8): Günde 1 kez
              sabahUygulama = 'Lenf Masaji';
              aksamUygulama = '-';
            }
            
            tableStartX = 15;
            
            // ✅ 5. hafta masaj planı: Tüm yazılar normal siyah renkte
            doc.setTextColor(0, 0, 0);
            doc.setDrawColor(0, 0, 0);
            doc.setLineWidth(0.3);
            
            // Tarih sütunu - sadece basit tablo, check yok
            doc.rect(tableStartX, currentY, colWidths[0], 5);
            doc.text(tarihStr, tableStartX + 2, currentY + 3.5);
            tableStartX += colWidths[0];
            
            // Gün sütunu
            doc.rect(tableStartX, currentY, colWidths[1], 5);
            doc.text(gun, tableStartX + 2, currentY + 3.5);
            tableStartX += colWidths[1];
            
            // Sabah sütunu
            doc.rect(tableStartX, currentY, colWidths[2], 5);
            doc.text(sabahUygulama, tableStartX + 2, currentY + 3.5);
            tableStartX += colWidths[2];
            
            // Akşam sütunu
            doc.rect(tableStartX, currentY, colWidths[3], 5);
            doc.text(aksamUygulama, tableStartX + 2, currentY + 3.5);
            
            currentY += 5;
          }
          
          currentY += 8;
        }
        
        // PDF'i blob olarak döndür
        const pdfBlob = doc.output('blob');
        console.log('✅ 5. hafta masaj PDF blob oluşturuldu, boyut:', pdfBlob.size);
        return pdfBlob;
        
      } catch (error) {
        console.error('❌ 5. hafta masaj PDF oluşturma hatası:', error);
        return null;
      }
    }

    // 5. hafta için Lenf Masaj PDF'si oluştur ve ZIP'e ekle
    async function createAndAddLenfMasajPDF(zip, hasta, haftalar, klasorYolu = '') {
      try {
        console.log('🤲 5. hafta Lenf Masaj PDF oluşturuluyor...', { hasta: hasta.isim });
        
        // Kütüphane kontrolü
        if (!window.jspdf) {
          console.error('❌ jsPDF kütüphanesi yüklenmemiş');
          return;
        }
        
        console.log('✅ jsPDF kütüphanesi bulundu:', typeof window.jspdf);
        
        // JSON verisinden doğrudan 5. hafta başlangıç tarihini al
        let haftaBaslangici = new Date();
        
        if (haftalar.length >= 5 && haftalar[4]?.baslangic) {
            console.log('  5. HAFTA RAW VERİ:', haftalar[4].baslangic, typeof haftalar[4].baslangic);
            // ⚡ ÖNEMLİ: Tab'ın başlangıç tarihi zaten doğru hesaplanmış, ek hizalama yapma!
            haftaBaslangici = new Date(haftalar[4].baslangic + 'T00:00:00'); // Timezone safe parsing
            console.log('  5. HAFTA PARSED TARİH:', haftaBaslangici.toISOString(), '|', haftaBaslangici.toLocaleDateString('tr-TR'));
        } else {
            console.log('⚠️ 5. hafta verisi bulunamadı, güncel tarih kullanılıyor');
            console.log('🔍 Toplam hafta sayısı:', haftalar.length);
            console.log('🔍 5. hafta verisi (index 4):', haftalar[4]);
            
            // Sadece veri yoksa pazartesi hizalaması yap
            const gunIndex = haftaBaslangici.getDay();
            const pazartesiyeKadarGun = gunIndex === 0 ? -6 : 1 - gunIndex;
            haftaBaslangici.setDate(haftaBaslangici.getDate() + pazartesiyeKadarGun);
        }
        
        console.log('🗓️ MASAJ PDF BAŞLANGIÇ TARİHİ:', haftaBaslangici.toLocaleDateString('tr-TR'), '(gün:', haftaBaslangici.getDay(), ')');

        // PDF oluştur - tekli tab versiyonuyla aynı format
        const { jsPDF } = window.jspdf;
        if (!jsPDF) {
          console.error('❌ jsPDF constructor bulunamadı');
          return;
        }
        
        console.log('✅ jsPDF constructor bulundu, PDF oluşturuluyor...');
        
        const doc = new jsPDF('p', 'mm', 'a4'); // Tekli tab versiyonuyla aynı format
        
        // Hasta adını ASCII'ye çevir (tekli tab versiyonuyla aynı)
        console.log('🔍 Orijinal hasta adı:', hasta.isim);
        const asciiHastaAdi = hasta.isim
            .replace(/Ş/g, 'S').replace(/ş/g, 's')
            .replace(/Ğ/g, 'G').replace(/ğ/g, 'g')
            .replace(/Ü/g, 'U').replace(/ü/g, 'u')
            .replace(/İ/g, 'I').replace(/ı/g, 'i')
            .replace(/Ö/g, 'O').replace(/ö/g, 'o')
            .replace(/Ç/g, 'C').replace(/ç/g, 'c')
            .replace(/Ə/g, 'E').replace(/ə/g, 'e');
        console.log('🔍 ASCII hasta adı:', asciiHastaAdi);
        
        // Başlık - tekli tab versiyonuyla aynı
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(14);
        doc.setTextColor(0, 0, 0);
        
        const title = `${asciiHastaAdi.toUpperCase()}`;
        const titleWidth = doc.getTextWidth(title);
        doc.text(title, (210 - titleWidth) / 2, 20);
        
        doc.setFontSize(12);
        doc.setTextColor(0, 0, 0);
        
        // Lenf masaj başlığı - ASCII karakterlerle
        const subtitle = 'LENF DRENAJ MASAJI PROGRAMI';
        const programBasligi = '8 Haftalik Lenf Drenaj Masaji Uygulama Programi';
        
        const subtitleWidth = doc.getTextWidth(subtitle);
        doc.text(subtitle, (210 - subtitleWidth) / 2, 28);
        
        // Açıklama kutusu - tekli tab versiyonuyla aynı
        doc.setFontSize(8);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(0, 0, 0);
        doc.rect(15, 32, 170, 10);
        doc.text(programBasligi, 20, 36);
        doc.text(turkceKarakterDuzelt('(5. Haftadan itibaren) - Yesil check isareti tamamlanan gunler'), 20, 40);
        
        // 5. haftanın başlangıcı
        let currentY = 50;
        const gunler = ['Pazartesi', 'Sali', 'Carsamba', 'Persembe', 'Cuma', 'Cumartesi', 'Pazar'].map(gun => turkceKarakterDuzelt(gun));
        
        // 8 haftalık program (5-12. haftalar) - tekli tab versiyonuyla aynı
        console.log('  PDF OLUŞTURMA: Ana tarih:', haftaBaslangici.toLocaleDateString('tr-TR'));
        
        for (let lenfHaftaIndex = 0; lenfHaftaIndex < 8; lenfHaftaIndex++) {
          const gercekHaftaNo = lenfHaftaIndex + 5; // 5. haftadan başlar
          const haftaBaslangic = new Date(haftaBaslangici.getTime() + (lenfHaftaIndex * 7 * 24 * 60 * 60 * 1000));
          
          if (lenfHaftaIndex === 0) { // Sadece ilk hafta (5. hafta) için log
            console.log('🟢 PDF İLK HAFTA:', haftaBaslangic.toLocaleDateString('tr-TR'));
          }
          
          // Sayfa sonu kontrolü - hafta başlığı için yer var mı?
          if (currentY > 270) {
            doc.addPage();
            currentY = 20;
          }
          
          // Hafta başlığı
          doc.setTextColor(0, 0, 0);
          doc.setFont('helvetica', 'bold');
          doc.setFontSize(9);
          doc.rect(15, currentY, 170, 6);
          
          const haftaBaslangicStr = haftaBaslangic.toLocaleDateString('tr-TR');
          const haftaBitisStr = new Date(haftaBaslangic.getTime() + (6 * 24 * 60 * 60 * 1000)).toLocaleDateString('tr-TR');
          
          // 5. hafta PDF'si için 9-12. haftalar soluk renkte olsun
          if (gercekHaftaNo >= 9) {
            doc.setTextColor(150, 150, 150); // Soluk gri renk
          } else {
            doc.setTextColor(0, 0, 0); // Normal siyah renk
          }
          
          doc.text(turkceKarakterDuzelt(`${gercekHaftaNo}. HAFTA (${haftaBaslangicStr} - ${haftaBitisStr})`), 20, currentY + 4);
          currentY += 8;
          
          // Tablo başlıkları - tekli tab versiyonuyla aynı
          doc.setTextColor(0, 0, 0);
          doc.setFont('helvetica', 'bold');
          doc.setFontSize(9);
          doc.setDrawColor(0, 0, 0);
          doc.setLineWidth(0.3);
          
          const colWidths = [30, 40, 50, 50]; // Tarih, Gün, Sabah, Akşam
          let zipTableStartX = 15;
          
          // Başlık satırı
          doc.rect(zipTableStartX, currentY, colWidths[0], 6);
          doc.text('TARIH', zipTableStartX + 2, currentY + 4);
          zipTableStartX += colWidths[0];
          
          doc.rect(zipTableStartX, currentY, colWidths[1], 6);
          doc.text('GUN', zipTableStartX + 2, currentY + 4);
          zipTableStartX += colWidths[1];
          
          doc.rect(zipTableStartX, currentY, colWidths[2], 6);
          doc.text('SABAH', zipTableStartX + 2, currentY + 4);
          zipTableStartX += colWidths[2];
          
          doc.rect(zipTableStartX, currentY, colWidths[3], 6);
          doc.text('AKSAM', zipTableStartX + 2, currentY + 4);
          currentY += 6;
          
          // Her gün için satır - tekli tab versiyonuyla aynı
          doc.setFont('helvetica', 'normal');
          doc.setFontSize(8);
          
          for (let gunIndex = 0; gunIndex < 7; gunIndex++) {
            // Sayfa sonu kontrolü - satır için yer var mı?
            if (currentY > 280) {
              doc.addPage();
              currentY = 20;
              
              // Yeni sayfada tablo başlıklarını tekrar oluştur
              doc.setTextColor(0, 0, 0);
              doc.setFont('helvetica', 'bold');
              doc.setFontSize(9);
              doc.setDrawColor(0, 0, 0);
              doc.setLineWidth(0.3);
              
              let newPageTableStartX = 15;
              
              // Başlık satırı
              doc.rect(newPageTableStartX, currentY, colWidths[0], 6);
              doc.text('TARIH', newPageTableStartX + 2, currentY + 4);
              newPageTableStartX += colWidths[0];
              
              doc.rect(newPageTableStartX, currentY, colWidths[1], 6);
              doc.text('GUN', newPageTableStartX + 2, currentY + 4);
              newPageTableStartX += colWidths[1];
              
              doc.rect(newPageTableStartX, currentY, colWidths[2], 6);
              doc.text('SABAH', newPageTableStartX + 2, currentY + 4);
              newPageTableStartX += colWidths[2];
              
              doc.rect(newPageTableStartX, currentY, colWidths[3], 6);
              doc.text('AKSAM', newPageTableStartX + 2, currentY + 4);
              currentY += 6;
              
              doc.setFont('helvetica', 'normal');
              doc.setFontSize(8);
            }
            
            const gunTarihi = new Date(haftaBaslangic.getTime() + (gunIndex * 24 * 60 * 60 * 1000));
            const tarihStr = gunTarihi.toLocaleDateString('tr-TR');
            const gun = gunler[gunIndex];
            
            // Uygulama kontrolü - lenf masajı versiyonu (tekli tab versiyonuyla aynı mantık)
            let sabahUygulama = '-';
            let aksamUygulama = '-';
            
            if (lenfHaftaIndex < 2) {
              // İlk 2 hafta (5-6): Günde 2 kez lenf masajı
              sabahUygulama = turkceKarakterDuzelt('Lenf Masaji');
              aksamUygulama = turkceKarakterDuzelt('Lenf Masaji');
            } else if (lenfHaftaIndex < 4) {
              // Sonraki 2 hafta (7-8): Günde 1 kez lenf masajı (sabah)
              sabahUygulama = turkceKarakterDuzelt('Lenf Masaji');
              aksamUygulama = '-';
            } else {
              // 9-12. haftalar: lenf masajı yok (egzersiz başlamış)
              sabahUygulama = '-';
              aksamUygulama = '-';
            }
            
            zipTableStartX = 15;
            
            // 5. hafta PDF'si için 5-8. haftalar yeşil check'li olsun
            if (gercekHaftaNo <= 8) {
              doc.setTextColor(0, 0, 0); // Normal siyah renk
            } else {
              doc.setTextColor(150, 150, 150); // Soluk gri renk
            }
            
            // Tablo çizgi ayarları
            doc.setDrawColor(0, 0, 0);
            doc.setLineWidth(0.3);
            
            // Tarih sütunu
            doc.rect(zipTableStartX, currentY, colWidths[0], 5);
            
            // 5. hafta PDF'si ve aktif haftalar (5-8) yeşil check simgesi ekle
            if (gercekHaftaNo <= 8) {
              // Yeşil check kutusu çiz
              doc.setFillColor(0, 128, 0); // Yeşil dolgu
              doc.rect(zipTableStartX + 1, currentY + 1, 4, 3, 'F'); // Yeşil dikdörtgen
              
              // Beyaz check çizgisi çiz
              doc.setDrawColor(255, 255, 255); // Beyaz çizgi
              doc.setLineWidth(0.5);
              // Check işareti çizgisi (V şekli)
              doc.line(zipTableStartX + 1.5, currentY + 2.5, zipTableStartX + 2.5, currentY + 3.2);
              doc.line(zipTableStartX + 2.5, currentY + 3.2, zipTableStartX + 4.2, currentY + 1.5);
              
              // Tablo çizgi ayarlarını geri yükle
              doc.setDrawColor(0, 0, 0);
              doc.setLineWidth(0.3);
              
              // Tarihi normal renkte yaz
              doc.setTextColor(0, 0, 0);
              doc.text(tarihStr, zipTableStartX + 7, currentY + 3.5);
            } else {
              // Gelecek haftalar için tarih soluk renkte
              doc.setTextColor(150, 150, 150);
              doc.text(tarihStr, zipTableStartX + 2, currentY + 3.5);
            }
            zipTableStartX += colWidths[0];
            
            // Gün sütunu
            doc.rect(zipTableStartX, currentY, colWidths[1], 5);
            doc.text(gun, zipTableStartX + 2, currentY + 3.5);
            zipTableStartX += colWidths[1];
            
            // Sabah sütunu
            doc.rect(zipTableStartX, currentY, colWidths[2], 5);
            doc.text(sabahUygulama, zipTableStartX + 2, currentY + 3.5);
            zipTableStartX += colWidths[2];
            
            // Akşam sütunu
            doc.rect(zipTableStartX, currentY, colWidths[3], 5);
            doc.text(aksamUygulama, zipTableStartX + 2, currentY + 3.5);
            
            currentY += 5;
          }
          
          currentY += 8; // Haftalar arası boşluk
        }
        
        // PDF'i blob olarak al ve ZIP'e ekle
        const pdfBlob = doc.output('blob');
        const dosyaAdi = `${asciiHastaAdi}_Lenf_Masaj_Takvimi.pdf`;
        zip.file(klasorYolu + dosyaAdi, pdfBlob);
        
        console.log('✅ 5. hafta Lenf Masaj PDF ZIP\'e eklendi:', dosyaAdi);
        
      } catch (error) {
        console.error('❌ Lenf Masaj PDF oluşturma hatası:', error);
      }
    }

    async function createAndAddEgzersizPDF(zip, hasta, haftalar, klasorYolu = '') {
      try {
        console.log('🏃 9. hafta Egzersiz PDF oluşturuluyor...', { hasta: hasta.isim });
        
        // Kütüphane kontrolü
        if (!window.jspdf) {
          console.error('❌ jsPDF kütüphanesi yüklenmemiş');
          return;
        }
        
        console.log('✅ jsPDF kütüphanesi bulundu:', typeof window.jspdf);
        
    // 9. hafta tabındaki başlangıç ve bitiş tarihini doğrudan kullan
    let haftaBaslangici = new Date();
    let haftaBitisi = new Date();
    
    // 9. haftayı hafta numarasına göre bul (index 8 değil!)
    const dokuzuncuHafta = haftalar.find(h => h.haftaNo === 9);
    if (dokuzuncuHafta?.baslangic && dokuzuncuHafta?.bitis) {
      haftaBaslangici = new Date(dokuzuncuHafta.baslangic + 'T00:00:00');
      haftaBitisi = new Date(dokuzuncuHafta.bitis + 'T00:00:00');
      console.log('🔵 9. HAFTA TAB BAŞLANGIÇ (hafta no ile bulundu):', haftaBaslangici.toLocaleDateString('tr-TR'));
      console.log('🔵 9. HAFTA TAB BİTİŞ (hafta no ile bulundu):', haftaBitisi.toLocaleDateString('tr-TR'));
    } else if (haftalar.length >= 9 && haftalar[8]?.baslangic && haftalar[8]?.bitis) {
      // Fallback: index ile dene
      haftaBaslangici = new Date(haftalar[8].baslangic + 'T00:00:00');
      haftaBitisi = new Date(haftalar[8].bitis + 'T00:00:00');
      console.log('🔵 9. HAFTA TAB BAŞLANGIÇ (index ile):', haftaBaslangici.toLocaleDateString('tr-TR'));
      console.log('🔵 9. HAFTA TAB BİTİŞ (index ile):', haftaBitisi.toLocaleDateString('tr-TR'));
    } else if (haftalar.length >= 5 && haftalar[4]?.baslangic) {
      // 5. haftadan 4 hafta sonrasını hesapla (eski fallback)
      const besinciHafta = new Date(haftalar[4].baslangic + 'T00:00:00');
      haftaBaslangici = new Date(besinciHafta.getTime() + (4 * 7 * 24 * 60 * 60 * 1000));
      haftaBitisi = new Date(haftaBaslangici.getTime() + 6 * 24 * 60 * 60 * 1000);
      console.log('🔵 9. HAFTA HESAPLANAN:', haftaBaslangici.toLocaleDateString('tr-TR'));
    } else {
      console.log('⚠️ Hafta verisi bulunamadı, güncel tarih kullanılıyor');
      console.log('🔍 Toplam hafta sayısı:', haftalar.length);
    }

    // Pazartesi'ye hizalama kaldırıldı, tabdaki tarih doğrudan kullanılacak

        // PDF oluştur - tekli tab versiyonuyla aynı format
        const { jsPDF } = window.jspdf;
        if (!jsPDF) {
          console.error('❌ jsPDF constructor bulunamadı');
          return;
        }
        
        console.log('✅ jsPDF constructor bulundu, PDF oluşturuluyor...');
        
        const doc = new jsPDF('p', 'mm', 'a4'); // Tekli tab versiyonuyla aynı format
        
        // Hasta adını ASCII'ye çevir (tekli tab versiyonuyla aynı)
        console.log('🔍 Orijinal hasta adı:', hasta.isim);
        const asciiHastaAdi = hasta.isim
            .replace(/Ş/g, 'S').replace(/ş/g, 's')
            .replace(/Ğ/g, 'G').replace(/ğ/g, 'g')
            .replace(/Ü/g, 'U').replace(/ü/g, 'u')
            .replace(/İ/g, 'I').replace(/ı/g, 'i')
            .replace(/Ö/g, 'O').replace(/ö/g, 'o')
            .replace(/Ç/g, 'C').replace(/ç/g, 'c')
            .replace(/Ə/g, 'E').replace(/ə/g, 'e');
        console.log('🔍 ASCII hasta adı:', asciiHastaAdi);
        
        // Başlık - tekli tab versiyonuyla aynı
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(14);
        doc.setTextColor(0, 0, 0);
        
        const title = `${asciiHastaAdi.toUpperCase()}`;
        const titleWidth = doc.getTextWidth(title);
        doc.text(title, (210 - titleWidth) / 2, 20);
        
        doc.setFontSize(12);
        doc.setTextColor(0, 0, 0);
        
        // Egzersiz + lenf masaj başlığı - ASCII karakterlerle
        const subtitle = 'EGZERSIZ VE LENF DRENAJ MASAJI PROGRAMI';
        const programBasligi = '8 Haftalik Egzersiz ve Lenf Drenaj Masaji Uygulama Programi';
        
        const subtitleWidth = doc.getTextWidth(subtitle);
        doc.text(subtitle, (210 - subtitleWidth) / 2, 28);
        
        // Açıklama kutusu - tekli tab versiyonuyla aynı
        doc.setFontSize(8);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(0, 0, 0);
        doc.rect(15, 32, 170, 10);
        doc.text(programBasligi, 20, 36);
        doc.text(turkceKarakterDuzelt('(5. Haftadan itibaren) - Yesil check isareti tamamlanan gunler'), 20, 40);
        
        // 9. haftanın başlangıcı (baslangicTarihi 9. hafta başlangıcı kabul edilir)
        let currentY = 50;
        const gunler = ['Pazartesi', 'Sali', 'Carsamba', 'Persembe', 'Cuma', 'Cumartesi', 'Pazar'].map(gun => turkceKarakterDuzelt(gun));
        
        // 8 haftalık program (5-12. haftalar) - 9. hafta tabındaki tarih referans alınacak
        for (let lenfHaftaIndex = 0; lenfHaftaIndex < 8; lenfHaftaIndex++) {
          const gercekHaftaNo = lenfHaftaIndex + 5; // 5. haftadan başlar
          // 9. hafta tabındaki başlangıçtan itibaren haftaları sırala
          const haftaBaslangic = new Date(haftaBaslangici.getTime() + ((lenfHaftaIndex - 4) * 7 * 24 * 60 * 1000));
          // Sayfa sonu kontrolü - hafta başlığı için yer var mı?
          if (currentY > 270) {
            doc.addPage();
            currentY = 20;
          }
          // Hafta başlığı
          doc.setTextColor(0, 0, 0);
          doc.setFont('helvetica', 'bold');
          doc.setFontSize(9);
          doc.rect(15, currentY, 170, 6);
          const haftaBaslangicStr = haftaBaslangic.toLocaleDateString('tr-TR');
          const haftaBitisStr = new Date(haftaBaslangic.getTime() + (6 * 24 * 60 * 60 * 1000)).toLocaleDateString('tr-TR');
          // 9. hafta PDF'si için 5-8. haftalar soluk renkte olsun
          if (gercekHaftaNo <= 8) {
            doc.setTextColor(150, 150, 150); // Soluk gri renk
          } else {
            doc.setTextColor(0, 0, 0); // Normal siyah renk
          }
          doc.text(turkceKarakterDuzelt(`${gercekHaftaNo}. HAFTA (${haftaBaslangicStr} - ${haftaBitisStr})`), 20, currentY + 4);
          currentY += 8;
          
          // Tablo başlıkları - tekli tab versiyonuyla aynı
          doc.setTextColor(0, 0, 0);
          doc.setFont('helvetica', 'bold');
          doc.setFontSize(9);
          doc.setDrawColor(0, 0, 0);
          doc.setLineWidth(0.3);
          
          const colWidths = [30, 40, 50, 50]; // Tarih, Gün, Sabah, Akşam
          let zipTableStartX = 15;
          
          // Başlık satırı
          doc.rect(zipTableStartX, currentY, colWidths[0], 6);
          doc.text('TARIH', zipTableStartX + 2, currentY + 4);
          zipTableStartX += colWidths[0];
          
          doc.rect(zipTableStartX, currentY, colWidths[1], 6);
          doc.text('GUN', zipTableStartX + 2, currentY + 4);
          zipTableStartX += colWidths[1];
          
          doc.rect(zipTableStartX, currentY, colWidths[2], 6);
          doc.text('SABAH', zipTableStartX + 2, currentY + 4);
          zipTableStartX += colWidths[2];
          
          doc.rect(zipTableStartX, currentY, colWidths[3], 6);
          doc.text('AKSAM', zipTableStartX + 2, currentY + 4);
          currentY += 6;
          
          // Her gün için satır - tekli tab versiyonuyla aynı
          doc.setFont('helvetica', 'normal');
          doc.setFontSize(8);
          
          for (let gunIndex = 0; gunIndex < 7; gunIndex++) {
            // Sayfa sonu kontrolü - satır için yer var mı?
            if (currentY > 280) {
              doc.addPage();
              currentY = 20;
              
              // Yeni sayfada tablo başlıklarını tekrar oluştur
              doc.setTextColor(0, 0, 0);
              doc.setFont('helvetica', 'bold');
              doc.setFontSize(9);
              doc.setDrawColor(0, 0, 0);
              doc.setLineWidth(0.3);
              
              let newPageTableStartX = 15;
              
              // Başlık satırı
              doc.rect(newPageTableStartX, currentY, colWidths[0], 6);
              doc.text('TARIH', newPageTableStartX + 2, currentY + 4);
              newPageTableStartX += colWidths[0];
              
              doc.rect(newPageTableStartX, currentY, colWidths[1], 6);
              doc.text('GUN', newPageTableStartX + 2, currentY + 4);
              newPageTableStartX += colWidths[1];
              
              doc.rect(newPageTableStartX, currentY, colWidths[2], 6);
              doc.text('SABAH', newPageTableStartX + 2, currentY + 4);
              newPageTableStartX += colWidths[2];
              
              doc.rect(newPageTableStartX, currentY, colWidths[3], 6);
              doc.text('AKSAM', newPageTableStartX + 2, currentY + 4);
              currentY += 6;
              
              doc.setFont('helvetica', 'normal');
              doc.setFontSize(8);
            }
            
            const gunTarihi = new Date(haftaBaslangic.getTime() + (gunIndex * 24 * 60 * 60 * 1000));
            const tarihStr = gunTarihi.toLocaleDateString('tr-TR');
            const gun = gunler[gunIndex];
            
            // Uygulama kontrolü - egzersiz dahil versiyonu (tekli tab versiyonuyla aynı mantık)
            let sabahUygulama = '-';
            let aksamUygulama = '-';
            
            if (lenfHaftaIndex < 2) {
              // İlk 2 hafta (5-6): Günde 2 kez lenf masajı
              sabahUygulama = turkceKarakterDuzelt('Lenf Masaji');
              aksamUygulama = turkceKarakterDuzelt('Lenf Masaji');
            } else if (lenfHaftaIndex < 4) {
              // Sonraki 2 hafta (7-8): Günde 1 kez lenf masajı (sabah)
              sabahUygulama = turkceKarakterDuzelt('Lenf Masaji');
              aksamUygulama = '-';
            } else if (lenfHaftaIndex < 6) {
              // Sonraki 2 hafta (9-10): Günaşırı lenf masajı + egzersiz
              if (gunIndex === 0 || gunIndex === 2 || gunIndex === 4 || gunIndex === 6) {
                // Pazartesi, Çarşamba, Cuma, Pazar: Lenf masajı + akşam egzersiz
                sabahUygulama = turkceKarakterDuzelt('Lenf Masaji');
                aksamUygulama = turkceKarakterDuzelt('Egzersiz-2');
              } else {
                // Salı, Perşembe, Cumartesi: Sabah ve akşam egzersiz
                sabahUygulama = turkceKarakterDuzelt('Egzersiz-1');
                aksamUygulama = turkceKarakterDuzelt('Egzersiz-2');
              }
            } else {
              // Son 2 hafta (11-12): Haftada 2 gün lenf masajı + sürekli egzersiz
              if (gunIndex === 1 || gunIndex === 4) { // Salı, Cuma
                sabahUygulama = turkceKarakterDuzelt('Lenf Masaji');
                aksamUygulama = turkceKarakterDuzelt('Egzersiz-2');
              } else {
                sabahUygulama = turkceKarakterDuzelt('Egzersiz-1');
                aksamUygulama = turkceKarakterDuzelt('Egzersiz-2');
              }
            }
            
            zipTableStartX = 15;
            
            // 9. hafta PDF'si için 5-8. haftalar soluk renkte olsun
            if (gercekHaftaNo <= 8) {
              doc.setTextColor(150, 150, 150); // Soluk gri renk
            } else {
              doc.setTextColor(0, 0, 0); // Normal siyah renk
            }
            
            // Tablo çizgi ayarları
            doc.setDrawColor(0, 0, 0);
            doc.setLineWidth(0.3);
            
            // Tarih sütunu
            doc.rect(zipTableStartX, currentY, colWidths[0], 5);
            
            // 9. hafta PDF'si ve geçmiş haftalarda (5-8) yeşil check simgesi ekle
            if (gercekHaftaNo <= 8) {
              // Yeşil check kutusu çiz
              doc.setFillColor(0, 128, 0); // Yeşil dolgu
              doc.rect(zipTableStartX + 1, currentY + 1, 4, 3, 'F'); // Yeşil dikdörtgen
              
              // Beyaz check çizgisi çiz
              doc.setDrawColor(255, 255, 255); // Beyaz çizgi
              doc.setLineWidth(0.5);
              // Check işareti çizgisi (V şekli)
              doc.line(zipTableStartX + 1.5, currentY + 2.5, zipTableStartX + 2.5, currentY + 3.2);
              doc.line(zipTableStartX + 2.5, currentY + 3.2, zipTableStartX + 4.2, currentY + 1.5);
              
              // Tablo çizgi ayarlarını geri yükle
              doc.setDrawColor(0, 0, 0);
              doc.setLineWidth(0.3);
              
              // Tarihi soluk renkte yaz
              doc.setTextColor(150, 150, 150);
              doc.text(tarihStr, zipTableStartX + 7, currentY + 3.5);
            } else {
              // Normal tarih
              doc.setTextColor(0, 0, 0);
              doc.text(tarihStr, zipTableStartX + 2, currentY + 3.5);
            }
            zipTableStartX += colWidths[0];
            
            // Gün sütunu
            doc.rect(zipTableStartX, currentY, colWidths[1], 5);
            doc.text(gun, zipTableStartX + 2, currentY + 3.5);
            zipTableStartX += colWidths[1];
            
            // Sabah sütunu
            doc.rect(zipTableStartX, currentY, colWidths[2], 5);
            doc.text(sabahUygulama, zipTableStartX + 2, currentY + 3.5);
            zipTableStartX += colWidths[2];
            
            // Akşam sütunu
            doc.rect(zipTableStartX, currentY, colWidths[3], 5);
            doc.text(aksamUygulama, zipTableStartX + 2, currentY + 3.5);
            
            currentY += 5;
          }
          
          currentY += 8; // Haftalar arası boşluk
        }
        
        // PDF'i blob olarak al ve ZIP'e ekle
        const pdfBlob = doc.output('blob');
        const dosyaAdi = `${asciiHastaAdi}_Egzersiz_Takvimi.pdf`;
        zip.file(klasorYolu + dosyaAdi, pdfBlob);
        
        console.log('✅ 9. hafta Egzersiz PDF ZIP\'e eklendi:', dosyaAdi);
        
      } catch (error) {
        console.error('❌ Egzersiz PDF oluşturma hatası:', error);
      }
    }

    async function pdfYukleHafta(i, input) {
      const file = input.files[0];
      if (!file) return;
      console.log('🔍 PDF yükleniyor:', file.name);
      console.log('🔍 Seçili hasta:', seciliHasta);
      
      // PDF yükleme sırasında render işlemlerini durdur
      window.pdfYuklemeDevamEdiyor = true;
      console.log('🚫 PDF yükleme başladı - render işlemleri geçici olarak durduruldu');
      
      if (!seciliHasta) {
        alert('Lütfen önce bir hasta seçin!');
        window.pdfYuklemeDevamEdiyor = false;
        return;
      }
      
      const haftalar = getHaftaListesi();
      const hafta = haftalar[i];
      
      // Kilit kontrolü
      if (hafta.kilitli) {
        alert('🔒 Bu hafta kilitli! PDF yüklemek için önce kilidi açın.');
        input.value = ''; // Input'u temizle
        return;
      }
      
      // PDF dosya adından tarih ve hafta numarasını çıkar
      const parsedPdf = parseProfessionalPdfName(file.name);
      console.log('📋 PDF dosya adı parse sonucu:', parsedPdf);
      
      let haftaNo = hafta.haftaNo || (i + 1);
      
      // PDF'den hafta numarası varsa güncelle
      if (parsedPdf && parsedPdf.haftaNo) {
        console.log(`📅 PDF'den hafta numarası alındı: ${haftaNo} → ${parsedPdf.haftaNo}`);
        haftaNo = parsedPdf.haftaNo;
        haftalar[i].haftaNo = parsedPdf.haftaNo;
      }
      
      // PDF'den tarih aralığı varsa güncelle
      if (parsedPdf && parsedPdf.baslangicGun && parsedPdf.baslangicAy) {
        const parsedTarihler = parseEdilmistarihleriDateOlarak(parsedPdf);
        if (parsedTarihler) {
          console.log(`📅 ÖNCEDEN VAROLAN HAFTA TARİHLERİ:`, {
            eskiBas: haftalar[i].baslangic,
            eskiBit: haftalar[i].bitis
          });
          console.log(`📅 PDF'den tarih aralığı alındı:`, parsedTarihler);
          
          // Tarihleri zorla güncelle
          haftalar[i].baslangic = parsedTarihler.baslangic;
          haftalar[i].bitis = parsedTarihler.bitis;
          
          console.log(`📅 YENİ HAFTA TARİHLERİ:`, {
            yeniBas: haftalar[i].baslangic,
            yeniBit: haftalar[i].bitis
          });
          
          // Tab bilgilerini güncelle (7 günden uzun aralık varsa özel format)
          updateTabInfoFromPdf(i, parsedPdf, parsedTarihler);
          
          // Tab'ları yeniden render et (özel format güncellemesi için)
          console.log('🔄 Tab adları güncelleniyor...');
          gosterHaftalar();
          
          // Hafta detayını da güncelle (tarih alanları için) - ZORUNLU GÜNCELLEME
          console.log('🔄 Hafta detayı zorla güncelleniyor...');
          
          // Aktif tab'ı yeniden seç (hafta detayı yenilenmesi için)
          setTimeout(() => {
            const activeTabIndex = i;
            console.log(`🔄 Aktif tab yeniden seçiliyor: ${activeTabIndex}`);
            switchTab(activeTabIndex);
          }, 100);
          
          // localStorage'a kaydet
          saveToStorage();
          
          // Başarı mesajı göster
          const basTarih = new Date(parsedTarihler.baslangic).toLocaleDateString('tr-TR');
          const bitTarih = new Date(parsedTarihler.bitis).toLocaleDateString('tr-TR');
          console.log(`✅ Tab tarihleri güncellendi: ${basTarih} - ${bitTarih} (${parsedTarihler.gunSayisi} gün)`);
        }
      }
      
      // GitHub'a PDF yükle
      console.log('  PDF GitHub\'a yükleniyor...');
      const pdfSonuc = await pdfYukleGithub(file, seciliHasta.id, haftaNo);
      
      if (!pdfSonuc) {
        console.error('❌ PDF yükleme başarısız');
        return;
      }
      
      // Hafta verilerini güncelle
      haftalar[i].pdfFile = file; // Geçici olarak File objesi (analiz için)
      haftalar[i].pdfOrijinalIsim = pdfSonuc.orijinalAd;
      haftalar[i].pdfName = pdfSonuc.guvenliAd;
      haftalar[i].pdfYolu = pdfSonuc.dosyaYolu;
      haftalar[i].githubUrl = pdfSonuc.githubUrl;
      haftalar[i].indirmeUrl = pdfSonuc.indirmeUrl;
      haftalar[i].kayitTarihi = new Date().toISOString();
      
      // YENİ PDF YÜKLENINCE ESKİ KARTLARI TEMİZLE
      console.log('🧹 Yeni PDF yükleniyor, eski kartlar temizleniyor...');
      console.log('🔍 Temizleme öncesi hafta verileri:', {
        haftaIndex: i,
        eskiTarifKartlar: haftalar[i].tarifKartlar?.length || 0,
        eskiManuelKartlar: haftalar[i].manuelKartlar?.length || 0,
        eskiTarifler: haftalar[i].tarifler?.length || 0
      });
      
      // 1. LocalStorage'daki hafta verilerinden eski kartları temizle
      haftalar[i].tarifKartlar = []; // Otomatik eşleşen kartları sıfırla
      haftalar[i].manuelKartlar = []; // Manuel eklenen kartları sıfırla
      haftalar[i].tarifler = []; // Eski tarifleri sıfırla
      
      console.log('✅ LocalStorage hafta verileri temizlendi');
      
      console.log('✅ PDF verileri güncellendi:', {
        pdfOrijinalIsim: haftalar[i].pdfOrijinalIsim,
        pdfYolu: haftalar[i].pdfYolu,
        githubUrl: haftalar[i].githubUrl,
        indirmeUrl: haftalar[i].indirmeUrl
      });
      
      // Seçili hasta objesini de güncelle
      if (seciliHasta && seciliHasta.haftalar) {
        const seciliHaftaIndex = seciliHasta.haftalar.findIndex(h => (h.haftaNo || 0) === haftaNo);
        if (seciliHaftaIndex !== -1) {
          seciliHasta.haftalar[seciliHaftaIndex].pdfFile = file;
          seciliHasta.haftalar[seciliHaftaIndex].pdfOrijinalIsim = pdfSonuc.orijinalAd;
          seciliHasta.haftalar[seciliHaftaIndex].pdfName = pdfSonuc.guvenliAd;
          seciliHasta.haftalar[seciliHaftaIndex].pdfYolu = pdfSonuc.dosyaYolu;
          seciliHasta.haftalar[seciliHaftaIndex].githubUrl = pdfSonuc.githubUrl;
          seciliHasta.haftalar[seciliHaftaIndex].indirmeUrl = pdfSonuc.indirmeUrl;
          seciliHasta.haftalar[seciliHaftaIndex].kayitTarihi = haftalar[i].kayitTarihi;
          
          // YENİ PDF YÜKLENINCE ESKİ KARTLARI HASTA JSON'UNDAN DA TEMİZLE
          console.log('🔍 Hasta JSON temizleme öncesi:', {
            haftaIndex: seciliHaftaIndex,
            eskiTarifKartlar: seciliHasta.haftalar[seciliHaftaIndex].tarifKartlar?.length || 0,
            eskiManuelKartlar: seciliHasta.haftalar[seciliHaftaIndex].manuelKartlar?.length || 0,
            eskiTarifler: seciliHasta.haftalar[seciliHaftaIndex].tarifler?.length || 0
          });
          
          seciliHasta.haftalar[seciliHaftaIndex].tarifKartlar = []; // Otomatik eşleşen kartları sıfırla
          seciliHasta.haftalar[seciliHaftaIndex].manuelKartlar = []; // Manuel eklenen kartları sıfırla
          seciliHasta.haftalar[seciliHaftaIndex].tarifler = []; // Eski tarifleri sıfırla
          
          console.log('🧹 Hasta JSON\'undan da eski kartlar temizlendi');
        }
      }

      // PDF dosya adından hafta numarasını ve tarih aralığını otomatik tespit et
      const parsed = parseProfessionalPdfName(file.name);
      if (parsed) {
        console.log('📋 PDF parse sonucu:', parsed);
        
        const eskiHaftaNo = haftalar[i].haftaNo || (i + 1);
        haftalar[i].haftaNo = parsed.haftaNo;
        
        // Tarih aralığını da güncelle
        if (parsed.tarihAraligi) {
          const tarihBilgisi = parseTarihAraligi(parsed.tarihAraligi);
          haftalar[i].baslangic = tarihBilgisi.baslangic;
          haftalar[i].bitis = tarihBilgisi.bitis;
          console.log('📅 Hafta tarihleri güncellendi:', tarihBilgisi);
          
          // Seçili hasta objesinde de güncelle
          if (seciliHasta && seciliHasta.haftalar) {
            const seciliHaftaIndex = seciliHasta.haftalar.findIndex(h => (h.haftaNo || 0) === parsed.haftaNo);
            if (seciliHaftaIndex !== -1) {
              seciliHasta.haftalar[seciliHaftaIndex].baslangic = tarihBilgisi.baslangic;
              seciliHasta.haftalar[seciliHaftaIndex].bitis = tarihBilgisi.bitis;
            }
          }
        }
        
        setTimeout(() => {
          const haftaNoInput = document.getElementById('haftaNo_' + i);
          if (haftaNoInput) {
            haftaNoInput.value = parsed.haftaNo;
            haftaNoInput.style.backgroundColor = '#d4edda';
            haftaNoInput.style.borderColor = '#28a745';
            setTimeout(() => {
              haftaNoInput.style.backgroundColor = '';
              haftaNoInput.style.borderColor = '';
            }, 2000);
          }
          
          // Tarih inputlarını da güncelle
          if (parsed.tarihAraligi) {
            const tarihBilgisi = parseTarihAraligi(parsed.tarihAraligi);
            const baslangicInput = document.getElementById('baslangic_' + i);
            const bitisInput = document.getElementById('bitis_' + i);
            
            if (baslangicInput) {
              baslangicInput.value = tarihBilgisi.baslangic;
              baslangicInput.style.backgroundColor = '#d4edda';
              baslangicInput.style.borderColor = '#28a745';
              setTimeout(() => {
                baslangicInput.style.backgroundColor = '';
                baslangicInput.style.borderColor = '';
              }, 2000);
            }
            
            if (bitisInput) {
              bitisInput.value = tarihBilgisi.bitis;
              bitisInput.style.backgroundColor = '#d4edda';
              bitisInput.style.borderColor = '#28a745';
              setTimeout(() => {
                bitisInput.style.backgroundColor = '';
                bitisInput.style.borderColor = '';
              }, 2000);
            }
          }
        }, 100);
      } else {
        // Fallback: Sadece hafta numarasını çıkarmaya çalış
        const dosyaAdindenHaftaNo = pdfDosyaAdindenHaftaNoAl(file.name);
        if (dosyaAdindenHaftaNo) {
          haftalar[i].haftaNo = dosyaAdindenHaftaNo;
          setTimeout(() => {
            const haftaNoInput = document.getElementById('haftaNo_' + i);
            if (haftaNoInput) {
              haftaNoInput.value = dosyaAdindenHaftaNo;
              haftaNoInput.style.backgroundColor = '#fff3cd';
              haftaNoInput.style.borderColor = '#ffc107';
              setTimeout(() => {
                haftaNoInput.style.backgroundColor = '';
                haftaNoInput.style.borderColor = '';
              }, 2000);
            }
          }, 100);
        }
      }

      // Hasta verisini GitHub'a kaydet (yeni sisteme göre)
      if (seciliHasta) {
        await hastayiAyriKaydet(seciliHasta);
      }

      // Otomatik kaydetme - hasta verileri değişti
      autoSaveHastaData(seciliHasta);
      
      renderHastalar();
      // gosterHaftalar(); // PDF yükleme sırasında hafta render yapmıyoruz (günler kayboluyor)

      // Eğer bu hafta şu anda aktif hafta ise, ekrandan da eski kartları temizle
      const aktifTab = document.querySelector('.hafta-tab.active');
      const aktifHaftaIndex = aktifTab ? parseInt(aktifTab.dataset.haftaIndex) : null;
      
      if (aktifTab && aktifHaftaIndex === i) {
        console.log('🧹 Aktif haftada PDF yenileniyor, ekrandaki kartlar temizleniyor...');
        const currentDiv = document.getElementById('eslesenContent');
        if (currentDiv) {
          currentDiv.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">PDF analiz ediliyor...</div>';
        }
      }

      // PDF'i analiz et ve tarifleri çıkar
      const reader = new FileReader();
      reader.onload = async function(e) {
        const bytes = new Uint8Array(e.target.result);
        const pdf = await pdfjsLib.getDocument({ data: bytes }).promise;
        let fullText = '';
        for (let p = 1; p <= pdf.numPages; p++) {
          const page = await pdf.getPage(p);
          const content = await page.getTextContent();
          const strings = content.items.map(item => item.str);
          fullText += strings.join('\n') + '\n';
        }

        // PDF içeriğinden hafta numarasını kontrol et
        const iceriktenHaftaNo = pdfIcerigindenhaftaNoAl(fullText);
        if (iceriktenHaftaNo && !pdfDosyaAdindenHaftaNoAl(haftalar[i].pdfName)) {
          const eskiHaftaNo = haftalar[i].haftaNo || (i + 1);
          haftalar[i].haftaNo = iceriktenHaftaNo;
          setTimeout(() => {
            const haftaNoInput = document.getElementById('haftaNo_' + i);
            if (haftaNoInput) {
              haftaNoInput.value = iceriktenHaftaNo;
              haftaNoInput.style.backgroundColor = '#d1ecf1';
              haftaNoInput.style.borderColor = '#17a2b8';
              setTimeout(() => {
                haftaNoInput.style.backgroundColor = '';
                haftaNoInput.style.borderColor = '';
              }, 2000);
            }
          }, 100);
        }

        haftalar[i].tarifler = extractTariflerDetay(fullText);
        
        // Eşleştirme yap ve sonuçları kaydet
        const eslestirmeSonucu = await otomatikEsleHafta(i);
        
        // JSON'a sadece eşleşen kartları kaydet (eşleşmeyenleri kaydetme)
        if (eslestirmeSonucu) {
          console.log('✅ Eşleştirme sonuçları hafta verilerine kaydediliyor...');
          haftalar[i].tarifKartlar = eslestirmeSonucu.eslesenKartlar || [];
          // Eşleşmeyen tarifleri JSON'a kaydetmiyoruz - sadece UI'da göstereceğiz
          console.log('📝 JSON\'a kaydedilecek eşleşen kart sayısı:', eslestirmeSonucu.eslesenKartlar?.length || 0);
          console.log('📝 Eşleşmeyen tarifler JSON\'a kaydedilmiyor (sadece UI\'da görünür)');
        }
        
        // Hasta JSON dosyasını güncelle
        if (seciliHasta) {
          const seciliHaftaIndex = seciliHasta.haftalar.findIndex(h => (h.haftaNo || 0) === (haftalar[i].haftaNo || (i + 1)));
          if (seciliHaftaIndex !== -1) {
            seciliHasta.haftalar[seciliHaftaIndex].tarifler = haftalar[i].tarifler;
            seciliHasta.haftalar[seciliHaftaIndex].tarifKartlar = haftalar[i].tarifKartlar || [];
            // Eşleşmeyen tarifleri JSON'a kaydetmiyoruz - JSON boyutunu küçük tutmak için
            // seciliHasta.haftalar[seciliHaftaIndex].eslesmeyenTarifler = haftalar[i].eslesmeyenTarifler || [];
            
            // Mevcut JSON'da eslesmeyenTarifler varsa sil (temizlik)
            if (seciliHasta.haftalar[seciliHaftaIndex].eslesmeyenTarifler) {
              delete seciliHasta.haftalar[seciliHaftaIndex].eslesmeyenTarifler;
              console.log('🧹 Eski eslesmeyenTarifler verisi JSON\'dan temizlendi');
            }
          }
          
          // Hasta verilerini GitHub'a kaydet
          await hastayiAyriKaydet(seciliHasta);
          console.log('💾 PDF analizi sonrası hasta verileri JSON\'a kaydedildi (sadece eşleşenler)');
        }
        
        saveToStorage();
        
        // Eğer bu hafta şu anda aktif hafta ise, kartları hemen göster
        const aktifTab = document.querySelector('.hafta-tab.active');
        const aktifHaftaIndex = aktifTab ? parseInt(aktifTab.dataset.haftaIndex) : null;
        
        console.log('🔍 PDF analizi sonrası kart güncelleme kontrolü:', {
          pdfYuklenenHaftaIndex: i,
          aktifHaftaIndex: aktifHaftaIndex,
          aktifTabVar: !!aktifTab,
          eslestirmeSonucu: eslestirmeSonucu ? 'var' : 'yok'
        });
        
        // Verileri kaydet
        saveToStorage();
        
        // YENİ SİSTEM: GitHub'a da kaydet
        if (seciliHasta) {
          hastayiAyriKaydet(seciliHasta).then(basarili => {
            if (basarili) {
              console.log('✅ PDF güncellenen hafta verileri GitHub\'a kaydedildi');
            }
          }).catch(error => {
            console.error('❌ GitHub kaydetme hatası:', error);
          });
        }
        
        // Tab başlığını ve tarihlerini güncelleme yapmıyoruz (günler kayboluyor)
        // gosterHaftalar(); // PDF sonrası bu çağrı günlerin kaybolmasına neden oluyor
        
        // Aktif tab'ı koru
        setTimeout(() => {
          switchTab(i);
          if (aktifTab && aktifHaftaIndex === i) {
            console.log('🎯 PDF yüklenen hafta aktif hafta, kartları güncelleniyor...');
            setTimeout(() => {
              gosterEslesenKartlarSidebar(i);
            }, 500); // Kısa bir gecikme ile güncelle
          } else {
            console.log('🔍 PDF yüklenen hafta aktif hafta değil, kart güncelleme yapılmıyor');
          }
          
          // PDF yükleme işlemi tamamlandı, koruma flag'ini temizle
          setTimeout(() => {
            window.pdfYuklemeDevamEdiyor = false;
            console.log('✅ PDF yükleme koruması kaldırıldı');
            
            // PDF yükleme sonrasında günleri tespit et ve render'ı güncelle
            setTimeout(() => {
              console.log('🔄 PDF sonrası günleri tespit etmek için render güncelleniyor...');
              updateYemekVeritabaniAnalizi();
            }, 500);
          }, 1000); // Tüm işlemler bittiğinden emin olmak için 1 saniye bekle
        }, 200);
      };
      
      // Hata durumunda da koruma flag'ini temizle
      reader.onerror = function() {
        console.error('❌ PDF okuma hatası');
        window.pdfYuklemeDevamEdiyor = false;
        console.log('🔄 PDF hata durumunda koruma flag\'i temizlendi');
        
        // Hata durumunda da günleri tespit etmeye çalış
        setTimeout(() => {
          console.log('🔄 PDF hata sonrası günleri tespit etmek için render güncelleniyor...');
          updateYemekVeritabaniAnalizi();
        }, 500);
      };
      
      reader.readAsArrayBuffer(file);
    }

    // PDF'den otomatik tara ve eşleştir
    async function pdfOkuVeEsleHafta(i) {
      try {
        const hafta = getHaftaListesi()[i];
        if (!hafta.pdf) {
          console.log(`⚠️ ${i}. hafta için PDF bulunamadı`);
          return;
        }
        
        // Base64 verisini kontrol et ve temizle
        let base64Data = hafta.pdf;
        if (base64Data.includes(',')) {
          base64Data = base64Data.split(',')[1];
        }
        
        // Base64 verisini doğrula
        if (!base64Data || base64Data.length === 0) {
          console.error(`❌ ${i}. hafta için geçersiz PDF verisi`);
          return;
        }
        
        // Base64 karakterlerini temizle (sadece geçerli karakterler)
        base64Data = base64Data.replace(/[^A-Za-z0-9+/=]/g, '');
        
        console.log(`🔍 ${i}. hafta PDF analizi başlıyor...`);
        
        const binary = atob(base64Data);
        const len = binary.length;
        const bytes = new Uint8Array(len);
        for (let j = 0; j < len; j++) bytes[j] = binary.charCodeAt(j);
        
        const pdf = await pdfjsLib.getDocument({ data: bytes }).promise;
        let fullText = '';
        for (let p = 1; p <= pdf.numPages; p++) {
          const page = await pdf.getPage(p);
          const content = await page.getTextContent();
          const strings = content.items.map(item => item.str);
          fullText += strings.join('\n') + '\n';
        }
        
        console.log(`✅ ${i}. hafta PDF metni çıkarıldı: ${fullText.length} karakter`);
        
        // PDF içeriğinden de hafta numarasını kontrol et (dosya adından tespit edilmediyse)
      const haftalar = getHaftaListesi();
      const iceriktenHaftaNo = pdfIcerigindenhaftaNoAl(fullText);
      if (iceriktenHaftaNo && !pdfDosyaAdindenHaftaNoAl(hafta.pdfName)) {
        const eskiHaftaNo = haftalar[i].haftaNo || (i + 1);
        haftalar[i].haftaNo = iceriktenHaftaNo;
        
        console.log(`📄 PDF içeriğinden hafta numarası güncellendi: ${eskiHaftaNo}. hafta → ${iceriktenHaftaNo}. hafta`);
        
        // UI'da görsel feedback göster
        setTimeout(() => {
          const haftaNoInput = document.getElementById('haftaNo_' + i);
          if (haftaNoInput) {
            haftaNoInput.value = iceriktenHaftaNo;
            haftaNoInput.style.backgroundColor = '#d1ecf1';
            haftaNoInput.style.borderColor = '#17a2b8';
            setTimeout(() => {
              haftaNoInput.style.backgroundColor = '';
              haftaNoInput.style.borderColor = '';
            }, 2000);
          }
        }, 100);
      }
      
      hafta.tarifler = extractTariflerDetay(fullText);
      saveToStorage();
      // Otomatik eşleştir
      otomatikEsleHafta(i);
      
      } catch (error) {
        console.error(`❌ ${i}. hafta PDF analizi hatası:`, error);
        console.error('PDF veri uzunluğu:', hafta.pdf ? hafta.pdf.length : 'N/A');
      }
    }

    // pdfOkuHafta fonksiyonu artık kullanılmıyor (otomatikleştirildi)

    // Test fonksiyonu - PDF yapısını analiz etmek için
    async function testPdfAnalyze(fileInput) {
      const file = fileInput.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = async function(e) {
        const bytes = new Uint8Array(e.target.result);
        const pdf = await pdfjsLib.getDocument({ data: bytes }).promise;
        let fullText = '';
        
        console.log('📄 PDF Analiz Raporu:');
        console.log('- Sayfa sayısı:', pdf.numPages);
        
        for (let p = 1; p <= pdf.numPages; p++) {
          const page = await pdf.getPage(p);
          const content = await page.getTextContent();
          const strings = content.items.map(item => item.str);
          const pageText = strings.join('\n');
          fullText += pageText + '\n';
          
          console.log(`- Sayfa ${p}:`, pageText.substring(0, 200) + '...');
        }
        
        console.log('📝 Tam İçerik:', fullText);
        
        // PDF format analizi
        const lines = fullText.split('\n').filter(line => line.trim());
        console.log('📊 İçerik analizi:');
        console.log('- Toplam satır:', lines.length);
        console.log('- İlk 10 satır:', lines.slice(0, 10));
        
        // Hasta adı, tarih, hafta bilgisi arama
        const hastaPattern = /([A-ZÇĞİÖŞÜ][a-zçğıöşü]+\s+[A-ZÇĞİÖŞÜ][a-zçğıöşü]+)/g;
        const tarihPattern = /(\d{1,2}[\.\/\-]\d{1,2}[\.\/\-]\d{2,4})/g;
        const haftaPattern = /(\d+)\.\s*hafta/gi;
        
        console.log('🔍 Tespit edilen veriler:');
        console.log('- Hasta adları:', fullText.match(hastaPattern));
        console.log('- Tarihler:', fullText.match(tarihPattern));
        console.log('- Hafta bilgileri:', fullText.match(haftaPattern));
      };
      reader.readAsArrayBuffer(file);
    }

    // PDF Generator - Hasta Takip Tablosu Oluştur
    function generatePatientPDF() {
      console.log('🎯 PDF Generator başlatılıyor...');
      
      if (!seciliHasta) {
        alert('Lütfen önce bir hasta seçin!');
        console.log('❌ Hasta seçilmemiş');
        return;
      }
      
      console.log('✅ Seçili hasta:', seciliHasta.isim);
      
      const haftalar = getHaftaListesi();
      if (haftalar.length === 0) {
        alert('Bu hasta için hiç hafta kaydı bulunamadı!');
        console.log('❌ Hafta kaydı bulunamadı');
        return;
      }
      
      console.log('✅ Hafta sayısı:', haftalar.length);
      
      // Sadece 5. haftada lenf drenaj programı oluşturulacak
      const mevcutHaftaNo = haftalar.length;
      if (mevcutHaftaNo === 5) {
        console.log('✅ 5. hafta tespit edildi, Lenf Drenaj Masajı programı hazırlanıyor');
      } else {
        console.log(`📋 ${mevcutHaftaNo}. hafta - Genel takip PDF\'i oluşturuluyor`);
      }
      
      // Sabit 12 haftalık program 
      const haftaSayisi = 12;
      console.log('✅ PDF için hafta sayısı:', haftaSayisi);
      
      // Türkçe karakter düzeltme uygula
      const duzeltilenHastaAdi = turkceKarakterDuzelt(seciliHasta.isim);
      
      if (mevcutHaftaNo === 5) {
        generateLenfDrenajPDF(duzeltilenHastaAdi, haftalar, haftaSayisi);
      } else {
        generateGenelTakipPDF(duzeltilenHastaAdi, haftalar, haftaSayisi);
      }
    }
    
    function generateLenfDrenajPDF(hastaAdi, mevcutHaftalar, toplamHaftaSayisi) {
      console.log('📄 Lenf Drenaj Masajı PDF oluşturuluyor...', { hastaAdi, toplamHaftaSayisi });
      
      // jsPDF kütüphanesini kontrol et
      console.log('jsPDF kontrol:', typeof window.jspdf, typeof jsPDF);
      
      let jsPDFLib;
      if (typeof window.jspdf !== 'undefined') {
        jsPDFLib = window.jspdf.jsPDF;
        console.log('✅ jsPDF window.jspdf.jsPDF üzerinden yüklendi');
      } else if (typeof jsPDF !== 'undefined') {
        jsPDFLib = jsPDF;
        console.log('✅ jsPDF global jsPDF üzerinden yüklendi');
      } else {
        console.log('❌ jsPDF bulunamadı, dinamik yükleme yapılıyor...');
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
        script.onload = () => {
          console.log('✅ jsPDF dinamik olarak yüklendi');
          setTimeout(() => generateLenfDrenajPDF(hastaAdi, mevcutHaftalar, toplamHaftaSayisi), 100);
        };
        script.onerror = () => {
          console.log('❌ jsPDF yüklenemedi');
          alert('PDF kütüphanesi yüklenemedi. Lütfen internet bağlantınızı kontrol edin.');
        };
        document.head.appendChild(script);
        return;
      }
      
      try {
        console.log('📝 Lenf Drenaj Masajı PDF dökümanı oluşturuluyor...');
        const doc = new jsPDFLib('p', 'mm', 'a4'); // Portrait format
        
        // Türkçe karakter desteği
        doc.setFont('helvetica');
        
        // Başlık
        doc.setFontSize(16);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(0, 0, 0);
        
        // Hasta adını Türkçe karakter düzeltme ile hazırla
        const temizHastaAdi = turkceKarakterDuzelt(hastaAdi);
        const title = `${temizHastaAdi.toUpperCase()}`;
        const titleWidth = doc.getTextWidth(title);
        doc.text(title, (210 - titleWidth) / 2, 20);
        
        // Alt başlık
        doc.setFontSize(12);
        doc.setTextColor(0, 0, 0);
        const subtitle = 'EGZERSIZ VE LENF DRENAJ MASAJI PROGRAMI';
        const subtitleWidth = doc.getTextWidth(subtitle);
        doc.text(subtitle, (210 - subtitleWidth) / 2, 28);
        
        // Program açıklaması
        doc.setFontSize(9);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(0, 0, 0);
        doc.rect(15, 32, 170, 10);
        doc.text(window.fixTurkishChars('8 Haftalik Egzersiz ve Lenf Drenaj Masaji Uygulama Programi (5. Haftadan itibaren)'), 20, 38);
        
        // Seçili haftayı al - geçmiş haftalarda soluk renk için
        const seciliHaftaIndex = parseInt(document.getElementById('haftaSelect').value);
        const seciliHaftaNo = seciliHaftaIndex + 1;
        
        // 5. haftanın pazartesi tarihini hesapla
        const besinciHafta = mevcutHaftalar[4];
        if (!besinciHafta || !besinciHafta.baslangic) {
          throw new Error('5. hafta bilgisi bulunamadi!');
        }
        
        const besinciHaftaBaslangic = new Date(besinciHafta.baslangic);
        
        // 5. hafta başlangıç tarihinin pazartesi olmasını garanti altına al
        const haftaGunu = besinciHaftaBaslangic.getDay(); // 0=Pazar, 1=Pazartesi, ... 6=Cumartesi
        if (haftaGunu !== 1) { // Eğer pazartesi değilse
          const gunFarki = haftaGunu === 0 ? 1 : (1 - haftaGunu); // Pazartesiye kadar olan gün farkı
          besinciHaftaBaslangic.setDate(besinciHaftaBaslangic.getDate() + gunFarki);
        }
        
        console.log('✅ 5. hafta başlangıcı (Pazartesi):', besinciHaftaBaslangic);
        
        let currentY = 50;
        const gunler = ['Pazartesi', 'Sali', 'Carsamba', 'Persembe', 'Cuma', 'Cumartesi', 'Pazar'];
        
        // Her hafta için basit tablo
        for (let lenfHaftaIndex = 0; lenfHaftaIndex < 8; lenfHaftaIndex++) {
          const gercekHaftaNo = lenfHaftaIndex + 5;
          const haftaBaslangic = new Date(besinciHaftaBaslangic.getTime() + (lenfHaftaIndex * 7 * 24 * 60 * 60 * 1000));
          
          // Hafta başlığı
          // Seçili haftadan önceki haftalar soluk renkte olsun
          if (gercekHaftaNo < seciliHaftaNo) {
            doc.setTextColor(150, 150, 150); // Soluk gri renk
          } else {
            doc.setTextColor(0, 0, 0); // Normal siyah renk
          }
          doc.setFont('helvetica', 'bold');
          doc.setFontSize(10);
          doc.rect(15, currentY, 170, 6);
          
          const haftaBaslangicStr = haftaBaslangic.toLocaleDateString('tr-TR');
          const haftaBitisStr = new Date(haftaBaslangic.getTime() + (6 * 24 * 60 * 60 * 1000)).toLocaleDateString('tr-TR');
          doc.text(window.fixTurkishChars(`${gercekHaftaNo}. HAFTA (${haftaBaslangicStr} - ${haftaBitisStr})`), 20, currentY + 4);
          currentY += 8;
          
          // Tablo başlıkları - 4 sütun
          doc.setTextColor(0, 0, 0);
          doc.setFont('helvetica', 'bold');
          doc.setFontSize(9);
          
          const colWidths = [30, 40, 50, 50]; // Tarih, Gün, Sabah, Akşam
          let tableStartX = 15;
          
          // Başlık satırı
          doc.rect(tableStartX, currentY, colWidths[0], 6);
          doc.text('TARIH', tableStartX + 2, currentY + 4);
          tableStartX += colWidths[0];
          
          doc.rect(tableStartX, currentY, colWidths[1], 6);
          doc.text('GUN', tableStartX + 2, currentY + 4);
          tableStartX += colWidths[1];
          
          doc.rect(tableStartX, currentY, colWidths[2], 6);
          doc.text('SABAH', tableStartX + 2, currentY + 4);
          tableStartX += colWidths[2];
          
          doc.rect(tableStartX, currentY, colWidths[3], 6);
          doc.text('AKSAM', tableStartX + 2, currentY + 4);
          currentY += 6;
          
          // Her gün için satır
          doc.setFont('helvetica', 'normal');
          doc.setFontSize(8);
          
          for (let gunIndex = 0; gunIndex < 7; gunIndex++) {
            const gunTarihi = new Date(haftaBaslangic.getTime() + (gunIndex * 24 * 60 * 60 * 1000));
            const tarihStr = gunTarihi.toLocaleDateString('tr-TR');
            const gun = gunler[gunIndex];
            
            // Uygulama kontrolü
            let sabahUygulama = '-';
            let aksamUygulama = '-';
            
            if (lenfHaftaIndex < 2) {
              // İlk 2 hafta (5-6): Günde 2 kez lenf masajı
              sabahUygulama = 'Lenf Masaji';
              aksamUygulama = 'Lenf Masaji';
            } else if (lenfHaftaIndex < 4) {
              // Sonraki 2 hafta (7-8): Günde 1 kez lenf masajı (sabah)
              sabahUygulama = 'Lenf Masaji';
              aksamUygulama = '-';
            } else if (lenfHaftaIndex < 6) {
              // Sonraki 2 hafta (9-10): Günaşırı lenf masajı + sürekli akşam egzersiz
              if (gunIndex === 0 || gunIndex === 2 || gunIndex === 4 || gunIndex === 6) {
                // Pazartesi, Çarşamba, Cuma, Pazar: Lenf masajı + akşam egzersiz
                sabahUygulama = 'Lenf Masaji';
                aksamUygulama = 'Egzersiz-2';
              } else {
                // Salı, Perşembe, Cumartesi: Sabah ve akşam egzersiz
                sabahUygulama = 'Egzersiz-1';
                aksamUygulama = 'Egzersiz-2';
              }
            } else {
              // Son 2 hafta (11-12): Salı, Cuma lenf masajı + sürekli akşam egzersiz
              if (gunIndex === 1 || gunIndex === 4) {
                // Salı, Cuma: Lenf masajı + akşam egzersiz
                sabahUygulama = 'Lenf Masaji';
                aksamUygulama = 'Egzersiz-2';
              } else {
                // Diğer günler: Sabah ve akşam egzersiz
                sabahUygulama = 'Egzersiz-1';
                aksamUygulama = 'Egzersiz-2';
              }
            }
            
            tableStartX = 15;
            
            // Seçili haftadan önceki haftalar soluk renkte olsun
            if (gercekHaftaNo < seciliHaftaNo) {
              doc.setTextColor(150, 150, 150); // Soluk gri renk
            } else {
              doc.setTextColor(0, 0, 0); // Normal siyah renk
            }
            
            // Tarih sütunu
            doc.rect(tableStartX, currentY, colWidths[0], 5);
            doc.text(tarihStr, tableStartX + 2, currentY + 3.5);
            tableStartX += colWidths[0];
            
            // Gün sütunu
            doc.rect(tableStartX, currentY, colWidths[1], 5);
            doc.text(gun, tableStartX + 2, currentY + 3.5);
            tableStartX += colWidths[1];
            
            // Sabah sütunu
            doc.rect(tableStartX, currentY, colWidths[2], 5);
            doc.text(sabahUygulama, tableStartX + 2, currentY + 3.5);
            tableStartX += colWidths[2];
            
            // Akşam sütunu
            doc.rect(tableStartX, currentY, colWidths[3], 5);
            doc.text(aksamUygulama, tableStartX + 2, currentY + 3.5);
            
            currentY += 5;
          }
          
          currentY += 5; // Haftalar arası boşluk
          
          // Sayfa sonu kontrolü
          if (currentY > 240 && lenfHaftaIndex < 7) {
            doc.addPage('p');
            currentY = 20;
          }
        }
        
        
        console.log('✅ Basit lenf drenaj tablosu tamamlandı, PDF indiriliyor...');
        
        // PDF'yi indir
        const tarih = new Date().toISOString().slice(0, 10);
        const dosyaAdi = `${hastaAdi}_Lenf_Drenaj_Programi_${tarih}.pdf`;
        doc.save(dosyaAdi);
        
        console.log('✅ Lenf Drenaj PDF başarıyla oluşturuldu:', dosyaAdi);
        alert(`Lenf Drenaj Masajı Programı PDF'i başarıyla oluşturuldu!\n\nDosya: ${dosyaAdi}\n\n8 haftalık program 5. haftanızın pazartesi günü (${besinciHaftaBaslangic.toLocaleDateString('tr-TR')}) başlayacak şekilde hazırlandı.`);
        
      } catch (error) {
        console.error('❌ Lenf Drenaj PDF oluşturma hatası:', error);
        alert('Lenf Drenaj PDF oluştururken hata oluştu: ' + error.message);
      }
    }

    function generateGenelTakipPDF(hastaAdi, mevcutHaftalar, toplamHaftaSayisi) {
      console.log('📄 Genel Takip PDF oluşturuluyor...', { hastaAdi, toplamHaftaSayisi });
      alert('Henüz 5. hafta kaydınız yok. Genel takip PDF\'i oluşturuluyor.\n5. hafta sonrası Lenf Drenaj Masajı programı otomatik eklenecektir.');
      
      // Basit takip PDF oluştur (eski sistem)
      try {
        const doc = new jsPDF('l', 'mm', 'a4');
        doc.setFont('helvetica');
        doc.setFontSize(16);
        doc.setFont('helvetica', 'bold');
        const temizHastaAdi = turkceKarakterDuzelt(hastaAdi);
        
        // jsPDF için Türkçe karakterleri ASCII'ye çevir
        const pdfUygunHastaAdi = temizHastaAdi
          .replace(/Ş/g, 'S').replace(/ş/g, 's')
          .replace(/Ğ/g, 'G').replace(/ğ/g, 'g')
          .replace(/İ/g, 'I').replace(/ı/g, 'i')
          .replace(/Ç/g, 'C').replace(/ç/g, 'c')
          .replace(/Ö/g, 'O').replace(/ö/g, 'o')
          .replace(/Ü/g, 'U').replace(/ü/g, 'u');
        
        doc.text(`${pdfUygunHastaAdi.toUpperCase()} - GENEL TAKIP`, 20, 20);
        
        doc.setFontSize(10);
        doc.setFont('helvetica', 'normal');
        doc.text('Hasta takip tablosu (Lenf drenaj programı 5. hafta sonrası eklenecektir)', 20, 30);
        
        // Basit tablo
        const startY = 45;
        let currentY = startY;
        
        doc.setFontSize(9);
        doc.text('Hafta', 20, currentY);
        doc.text('Durum', 60, currentY);
        doc.text('Notlar', 120, currentY);
        currentY += 10;
        
        for (let i = 0; i < Math.min(mevcutHaftalar.length, toplamHaftaSayisi); i++) {
          const hafta = mevcutHaftalar[i];
          doc.text(`${i + 1}. Hafta`, 20, currentY);
          doc.text(hafta ? 'Tamamlandı' : 'Beklemede', 60, currentY);
          doc.text(hafta && hafta.aciklama ? hafta.aciklama.substring(0, 30) : '', 120, currentY);
          currentY += 8;
        }
        
        const tarih = new Date().toISOString().slice(0, 10);
        const dosyaAdi = `${hastaAdi}_Genel_Takip_${tarih}.pdf`;
        doc.save(dosyaAdi);
        
        console.log('✅ Genel Takip PDF başarıyla oluşturuldu:', dosyaAdi);
        
      } catch (error) {
        console.error('❌ Genel Takip PDF hatası:', error);
        alert('PDF oluştururken hata oluştu: ' + error.message);
      }
    }

    // ZIP için Lenf Drenaj PDF Blob oluşturucu (indirmeden, sadece memory'de)
    async function generateLenfDrenajPDFBlob(belirliHaftaNo = null, belirliHaftaIndex = null) {
      try {
        console.log('📄 Lenf Drenaj PDF Blob oluşturuluyor...');
        
        if (!seciliHasta) {
          console.warn('❌ Seçili hasta yok');
          return null;
        }
        
        const haftalar = getHaftaListesi();
        console.log('🔍 Hafta listesi uzunluğu:', haftalar.length);
        
        // Hasta ve hafta bilgilerini detaylı kontrol et
        if (!haftalar || haftalar.length === 0) {
          console.warn('❌ Hiç hafta verisi yok');
          return null;
        }
        
        console.log('🔍 Hasta bilgileri:', {
          id: seciliHasta.id,
          isim: seciliHasta.isim,
          haftaSayisi: haftalar.length,
          belirliHaftaNo: belirliHaftaNo,
          belirliHaftaIndex: belirliHaftaIndex
        });
        
        // Hafta sayısı kontrolünü kaldır - tek hafta bile olsa masaj takvimi oluşturulabilir
        // if (haftalar.length < 5) return null; // KALDIRILDI
        
        // Seçili haftayı al - eğer belirli hafta belirtilmişse onu kullan
        let egzersizDahilMi;
        let dokuzuncuHaftaOzelModu = false; // 9. hafta için özel mod
        
        if (belirliHaftaNo !== null) {
          // ZIP için belirli bir hafta belirtilmiş
          egzersizDahilMi = belirliHaftaNo >= 9; // 9. hafta ve sonrası için egzersiz dahil
          dokuzuncuHaftaOzelModu = belirliHaftaNo === 9; // 9. hafta özel modu
          console.log(`🎯 ZIP için ${belirliHaftaNo}. hafta PDF'i oluşturuluyor, egzersiz dahil: ${egzersizDahilMi}, 9. hafta özel mod: ${dokuzuncuHaftaOzelModu}`);
        } else {
          // Normal PDF indirme için seçili haftayı kullan
          const seciliHaftaIndex = parseInt(document.getElementById('haftaSelect').value);
          egzersizDahilMi = seciliHaftaIndex >= 8; // 9. hafta ve sonrası için egzersiz dahil
        }
        
        console.log('🔍 jsPDF kontrolü başlıyor...');
        // jsPDF kontrolü
        let jsPDFLib;
        if (typeof window.jspdf !== 'undefined') {
          jsPDFLib = window.jspdf.jsPDF;
          console.log('✅ window.jspdf bulundu');
        } else if (typeof jsPDF !== 'undefined') {
          jsPDFLib = jsPDF;
          console.log('✅ global jsPDF bulundu');
        } else {
          console.warn('❌ jsPDF bulunamadı');
          return null;
        }
        
        console.log('🔍 Hasta adı alınıyor...');
        const hastaAdi = turkceKarakterDuzelt(seciliHasta.isim);
        console.log('🔍 Hasta adı:', hastaAdi);
        
        console.log('🔍 PDF dokümanı oluşturuluyor...');
        const doc = new jsPDFLib('p', 'mm', 'a4'); // Portrait - mobil uyumlu
        
        console.log('🔍 PDF ayarları yapılıyor...');
        // PDF içeriğini oluştur (yeni mobil dostu stil ile)
        
        // 🔧 Türkçe karakter sorunu için özel encoding
        console.log('🔧 Türkçe karakter encoding ayarları...');
        
        // Ham hasta adını al (türkce düzeltme yapmadan)
        const rawHastaAdi = seciliHasta.isim;
        console.log('🔍 Ham hasta adı:', rawHastaAdi);
        console.log('🔍 seciliHasta objesi:', seciliHasta);
        
        // Türkçe karakterleri ASCII'ye çevir - KEKesin çözüm
        const asciiHastaAdi = rawHastaAdi
            .replace(/Ş/g, 'S').replace(/ş/g, 's')
            .replace(/Ğ/g, 'G').replace(/ğ/g, 'g')
            .replace(/Ü/g, 'U').replace(/ü/g, 'u')
            .replace(/İ/g, 'I').replace(/ı/g, 'i')
            .replace(/Ö/g, 'O').replace(/ö/g, 'o')
            .replace(/Ç/g, 'C').replace(/ç/g, 'c')
            .replace(/Ə/g, 'E').replace(/ə/g, 'e'); // Azerbaijan karakteri de varsa
            
        console.log('🔍 ASCII hasta adı:', asciiHastaAdi);
        
        doc.setFont('helvetica');
        doc.setLanguage('tr');
        
        // Başlık - Merkezi
        doc.setFontSize(16);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(0, 0, 0);
        const title = `${asciiHastaAdi.toUpperCase()}`;
        const titleWidth = doc.getTextWidth(title);
        doc.text(title, (210 - titleWidth) / 2, 20);
        console.log('✅ PDF başlığında ASCII kullanıldı:', title);
        
        doc.setFontSize(12);
        doc.setTextColor(0, 0, 0);
        
        // Hangi hafta için PDF oluşturulduğuna göre farklı başlık
        let subtitle, programBasligi;
        if (egzersizDahilMi) {
          subtitle = 'EGZERSIZ VE LENF DRENAJ MASAJI PROGRAMI';
          programBasligi = '8 Haftalik Egzersiz ve Lenf Drenaj Masaji Uygulama Programi';
        } else {
          subtitle = 'LENF DRENAJ MASAJI PROGRAMI';
          programBasligi = '8 Haftalik Lenf Drenaj Masaji Uygulama Programi';
        }
        
        const subtitleWidth = doc.getTextWidth(subtitle);
        doc.text(subtitle, (210 - subtitleWidth) / 2, 28);
        
        // Açıklama kutusu
        doc.setFontSize(8);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(0, 0, 0);
        doc.rect(15, 32, 170, 10);
        doc.text(programBasligi, 20, 36);
        if (egzersizDahilMi) {
          doc.text('(5. Haftadan itibaren) - Yesil check isareti tamamlanan gunler', 20, 40);
        } else {
          doc.text('(5. Haftadan itibaren)', 20, 40);
        }
        
        console.log('🔍 Hafta verilerini belirleniyor...');
        // Başlangıç haftasını belirle
        let baslangicHaftaIndex;
        let baslangicHafta;
        
        if (belirliHaftaIndex !== null) {
          // ⚡ ÖNCELIK: Eğer hafta index'i belirtilmişse onu kullan (ZIP için)
          baslangicHaftaIndex = belirliHaftaIndex;
          console.log('🎯 Belirtilen hafta index\'i kullanılıyor:', baslangicHaftaIndex);
        } else if (dokuzuncuHaftaOzelModu) {
          // 9. hafta özel modu: 9. haftayı referans al
          const dokuzuncuHaftaIndex = haftalar.findIndex(h => h.haftaNo === 9);
          if (dokuzuncuHaftaIndex !== -1) {
            baslangicHaftaIndex = dokuzuncuHaftaIndex; // 9. haftanın gerçek index'i
            console.log('🎯 9. hafta özel modu: 9. hafta tabındaki tarihten başlayacak, index:', dokuzuncuHaftaIndex);
          } else {
            baslangicHaftaIndex = 4; // fallback: 5. hafta
            console.log('⚠️ 9. hafta bulunamadı, 5. hafta fallback kullanılıyor');
          }
        } else {
          // Normal mod
          baslangicHaftaIndex = belirliHaftaNo ? belirliHaftaNo - 1 : 4; // 5. hafta = index 4
        }
        
        if (baslangicHaftaIndex < haftalar.length) {
          // Belirtilen hafta mevcut
          baslangicHafta = haftalar[baslangicHaftaIndex];
          console.log('✅ Belirtilen hafta bulundu:', baslangicHafta);
        } else {
          // Belirtilen hafta yok, mevcut ilk haftayı kullan
          baslangicHafta = haftalar[0];
          console.log('⚠️ Belirtilen hafta yok, ilk hafta kullanılıyor:', baslangicHafta);
        }
        
        console.log('🔍 Başlangıç tarihi hesaplanıyor...');
        const baslangicTarihi = new Date(baslangicHafta.baslangic);
        
        // Tab başlangıç tarihini olduğu gibi kullan - zaten doğru tarihlendirilmiş
        console.log('✅ Başlangıç tarihi (tab tarihinden):', baslangicTarihi);
        
        let currentY = 50;
        const gunler = ['Pazartesi', 'Sali', 'Carsamba', 'Persembe', 'Cuma', 'Cumartesi', 'Pazar'];
        
        // Kompakt tablo (Blob için)
        const haftaSayisi = dokuzuncuHaftaOzelModu ? 8 : 8; // 9. hafta özel modunda 8 hafta (5-12), normal modda 8 hafta
        for (let lenfHaftaIndex = 0; lenfHaftaIndex < haftaSayisi; lenfHaftaIndex++) {
          // 9. hafta özel modunda 5. haftadan başla (5,6,7,8,9,10,11,12), normal modda belirtilen haftadan
          const gercekHaftaNo = dokuzuncuHaftaOzelModu ? (lenfHaftaIndex + 5) : (lenfHaftaIndex + (belirliHaftaNo || 5));
          
          // Tarih hesaplaması düzeltildi
          let haftaBaslangic;
          if (dokuzuncuHaftaOzelModu) {
            // 9. hafta özel modu: 5. haftadan başlayarak 8 hafta göster
            // baslangicTarihi = 9. hafta başlangıç tarihi
            // 5. hafta = 9. haftadan 4 hafta önce
            // 6. hafta = 9. haftadan 3 hafta önce
            // ...
            // 9. hafta = 9. haftadan 0 hafta önce
            // 10. hafta = 9. haftadan 1 hafta sonra
            const haftaFarki = (lenfHaftaIndex + 5) - 9; // 5. hafta=-4, 6. hafta=-3, ..., 9. hafta=0, 10. hafta=+1
            haftaBaslangic = new Date(baslangicTarihi.getTime() + (haftaFarki * 7 * 24 * 60 * 60 * 1000));
          } else {
            // Normal mod: başlangıç tarihinden itibaren hafta hafta ilerle
            haftaBaslangic = new Date(baslangicTarihi.getTime() + (lenfHaftaIndex * 7 * 24 * 60 * 60 * 1000));
          }
          
          // Hafta başlığı
          doc.setTextColor(0, 0, 0);
          doc.setFont('helvetica', 'bold');
          doc.setFontSize(9);
          doc.rect(15, currentY, 170, 6);
          
          const haftaBaslangicStr = haftaBaslangic.toLocaleDateString('tr-TR');
          const haftaBitisStr = new Date(haftaBaslangic.getTime() + (6 * 24 * 60 * 60 * 1000)).toLocaleDateString('tr-TR');
          
          // 9. hafta PDF'si için 5-8. haftalar soluk renkte olsun, 9-12. haftalar normal
          const eskiHaftaMi = dokuzuncuHaftaOzelModu && gercekHaftaNo >= 5 && gercekHaftaNo <= 8; // Sadece 5-8. haftalar
          if (eskiHaftaMi) {
            doc.setTextColor(150, 150, 150); // Soluk gri renk
          } else {
            doc.setTextColor(0, 0, 0); // Normal siyah renk
          }
          
          doc.text(`${gercekHaftaNo}. HAFTA (${haftaBaslangicStr} - ${haftaBitisStr})`, 20, currentY + 4);
          
          // 9. hafta özel modunda 5-8. haftalar için tamamlandı işareti
          if (eskiHaftaMi) {
            doc.setTextColor(0, 128, 0); // Yeşil renk
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(10);
            doc.text('✓ TAMAMLANDI', 120, currentY + 4);
            doc.setFont('helvetica', 'normal');
          }
          currentY += 8;
          
          // Tablo başlıkları - 4 sütun
          doc.setTextColor(0, 0, 0);
          doc.setFont('helvetica', 'bold');
          doc.setFontSize(9);
          doc.setDrawColor(0, 0, 0);
          doc.setLineWidth(0.3);
          
          const colWidths = [30, 40, 50, 50]; // Tarih, Gün, Sabah, Akşam
          let zipTableStartX = 15;
          
          // Başlık satırı
          doc.rect(zipTableStartX, currentY, colWidths[0], 6);
          doc.text('TARIH', zipTableStartX + 2, currentY + 4);
          zipTableStartX += colWidths[0];
          
          doc.rect(zipTableStartX, currentY, colWidths[1], 6);
          doc.text('GUN', zipTableStartX + 2, currentY + 4);
          zipTableStartX += colWidths[1];
          
          doc.rect(zipTableStartX, currentY, colWidths[2], 6);
          doc.text('SABAH', zipTableStartX + 2, currentY + 4);
          zipTableStartX += colWidths[2];
          
          doc.rect(zipTableStartX, currentY, colWidths[3], 6);
          doc.text('AKSAM', zipTableStartX + 2, currentY + 4);
          currentY += 6;
          
          // Her gün için satır
          doc.setFont('helvetica', 'normal');
          doc.setFontSize(8);
          
          for (let gunIndex = 0; gunIndex < 7; gunIndex++) {
            const gunTarihi = new Date(haftaBaslangic.getTime() + (gunIndex * 24 * 60 * 60 * 1000));
            const tarihStr = gunTarihi.toLocaleDateString('tr-TR');
            const gun = gunler[gunIndex];
            
            // Uygulama kontrolü - seçili haftaya göre egzersiz dahil edilir
            let sabahUygulama = '-';
            let aksamUygulama = '-';
            
            if (lenfHaftaIndex < 2) {
              // İlk 2 hafta (5-6): Günde 2 kez lenf masajı
              sabahUygulama = 'Lenf Masaji';
              aksamUygulama = 'Lenf Masaji';
            } else if (lenfHaftaIndex < 4) {
              // Sonraki 2 hafta (7-8): Günde 1 kez lenf masajı (sabah)
              sabahUygulama = 'Lenf Masaji';
              aksamUygulama = '-';
            } else if (lenfHaftaIndex < 6) {
              // Sonraki 2 hafta (9-10): Günaşırı lenf masajı
              if (egzersizDahilMi) {
                // Egzersiz dahil versiyonu (9. hafta seçiliyse)
                if (gunIndex === 0 || gunIndex === 2 || gunIndex === 4 || gunIndex === 6) {
                  // Pazartesi, Çarşamba, Cuma, Pazar: Lenf masajı + akşam egzersiz
                  sabahUygulama = 'Lenf Masaji';
                  aksamUygulama = 'Egzersiz-2';
                } else {
                  // Salı, Perşembe, Cumartesi: Sabah ve akşam egzersiz
                  sabahUygulama = 'Egzersiz-1';
                  aksamUygulama = 'Egzersiz-2';
                }
              } else {
                // Sadece lenf masajı versiyonu (5-8. hafta seçiliyse)
                if (gunIndex === 0 || gunIndex === 2 || gunIndex === 4 || gunIndex === 6) {
                  sabahUygulama = 'Lenf Masaji';
                } else {
                  sabahUygulama = '-';
                }
                aksamUygulama = '-';
              }
            } else {
              // Son 2 hafta (11-12): Salı, Cuma lenf masajı
              if (egzersizDahilMi) {
                // Egzersiz dahil versiyonu (9+ hafta seçiliyse)
                if (gunIndex === 1 || gunIndex === 4) {
                  // Salı, Cuma: Lenf masajı + akşam egzersiz
                  sabahUygulama = 'Lenf Masaji';
                  aksamUygulama = 'Egzersiz-2';
                } else {
                  // Diğer günler: Sabah ve akşam egzersiz
                  sabahUygulama = 'Egzersiz-1';
                  aksamUygulama = 'Egzersiz-2';
                }
              } else {
                // Sadece lenf masajı versiyonu (5-8. hafta seçiliyse)
                if (gunIndex === 1 || gunIndex === 4) {
                  sabahUygulama = 'Lenf Masaji';
                } else {
                  sabahUygulama = '-';
                }
                aksamUygulama = '-';
              }
            }
            
            zipTableStartX = 15;
            
            // 9. hafta PDF'si için 5-8. haftalar soluk renkte olsun, 9-12. haftalar normal
            const eskiHaftaMi = dokuzuncuHaftaOzelModu && gercekHaftaNo >= 5 && gercekHaftaNo <= 8; // Sadece 5-8. haftalar
            if (eskiHaftaMi) {
              doc.setTextColor(150, 150, 150); // Soluk gri renk
            } else {
              doc.setTextColor(0, 0, 0); // Normal siyah renk
            }
            
            // Tablo çizgi ayarları
            doc.setDrawColor(0, 0, 0);
            doc.setLineWidth(0.3);
            
            // Tarih sütunu
            doc.rect(zipTableStartX, currentY, colWidths[0], 5);
            
            // 9. hafta PDF'si ve geçmiş haftalarda (5-8) yeşil check simgesi ekle
            if (egzersizDahilMi && gercekHaftaNo <= 8) {
              // Yeşil check kutusu çiz
              doc.setFillColor(0, 128, 0); // Yeşil dolgu
              doc.rect(zipTableStartX + 1, currentY + 1, 4, 3, 'F'); // Yeşil dikdörtgen
              
              // Beyaz check çizgisi çiz
              doc.setDrawColor(255, 255, 255); // Beyaz çizgi
              doc.setLineWidth(0.5);
              // Check işareti çizgisi (V şekli)
              doc.line(zipTableStartX + 1.5, currentY + 2.5, zipTableStartX + 2.5, currentY + 3.2);
              doc.line(zipTableStartX + 2.5, currentY + 3.2, zipTableStartX + 4.2, currentY + 1.5);
              
              // Tablo çizgi ayarlarını geri yükle
              doc.setDrawColor(0, 0, 0);
              doc.setLineWidth(0.3);
              
              // Tarihi soluk renkte yaz
              doc.setTextColor(150, 150, 150);
              doc.text(tarihStr, zipTableStartX + 7, currentY + 3.5);
            } else {
              // Normal tarih
              doc.setTextColor(0, 0, 0);
              doc.text(tarihStr, zipTableStartX + 2, currentY + 3.5);
            }
            zipTableStartX += colWidths[0];
            
            // Gün sütunu
            doc.rect(zipTableStartX, currentY, colWidths[1], 5);
            doc.text(gun, zipTableStartX + 2, currentY + 3.5);
            zipTableStartX += colWidths[1];
            
            // Sabah sütunu
            doc.rect(zipTableStartX, currentY, colWidths[2], 5);
            doc.text(sabahUygulama, zipTableStartX + 2, currentY + 3.5);
            zipTableStartX += colWidths[2];
            
            // Akşam sütunu
            doc.rect(zipTableStartX, currentY, colWidths[3], 5);
            doc.text(aksamUygulama, zipTableStartX + 2, currentY + 3.5);
            
            currentY += 5;
          }
          
          currentY += 5; // Haftalar arası boşluk
          
          // Sayfa kontrolü
          if (currentY > 250 && lenfHaftaIndex < 7) {
            doc.addPage('p');
            currentY = 20;
          }
        }
        
        // Blob olarak döndür (indirmeden)
        const pdfBlob = doc.output('blob');
        console.log('✅ Basit Lenf Drenaj PDF Blob oluşturuldu');
        return pdfBlob;
        
      } catch (error) {
        console.error('❌ Lenf Drenaj PDF Blob hatası:', error);
        console.error('❌ Hata detayları:', {
          message: error.message,
          stack: error.stack,
          belirliHaftaNo: belirliHaftaNo,
          seciliHasta: seciliHasta ? seciliHasta.isim : 'null'
        });
        return null;
      }
    }

    // Lenf Drenaj Masajı Takvimi PDF Oluşturucu
    function generateLenfDrenajTakvimi() {
      console.log('🏥 Lenf Drenaj Masajı Takvimi PDF oluşturuluyor...');
      
      if (!seciliHasta) {
        alert('Lütfen önce bir hasta seçin!');
        return;
      }
      
      const haftalar = getHaftaListesi();
      if (haftalar.length < 5) {
        alert('En az 5 hafta kaydı olmalı! Mevcut hafta sayısı: ' + haftalar.length);
        return;
      }
      
      // 5. haftanın başlangıç tarihini al
      const besinciHafta = haftalar[4]; // 5. hafta (index 4)
      if (!besinciHafta || !besinciHafta.baslangic) {
        alert('5. hafta başlangıç tarihi bulunamadı!');
        return;
      }
      
      const baslangicTarihi = new Date(besinciHafta.baslangic);
      
      // 5. hafta başlangıç tarihinin pazartesi olmasını garanti altına al
      const haftaGunu = baslangicTarihi.getDay(); // 0=Pazar, 1=Pazartesi, ... 6=Cumartesi
      if (haftaGunu !== 1) { // Eğer pazartesi değilse
        const gunFarki = haftaGunu === 0 ? 1 : (1 - haftaGunu); // Pazartesiye kadar olan gün farkı
        baslangicTarihi.setDate(baslangicTarihi.getDate() + gunFarki);
      }
      
      try {
        const doc = new jsPDFLib('p', 'mm', 'a4'); // Portrait format
        
        // Türkçe karakter desteği için font encoding ayarla
        doc.setFont('helvetica');
        doc.setLanguage('tr-TR');
        
        // Başlık
        doc.setFontSize(16);
        doc.setFont('helvetica', 'bold');
        const hastaAdi = turkceKarakterDuzelt(seciliHasta.isim);
        console.log('🎯 PDF için hasta adı düzeltmesi:', seciliHasta.isim, ' → ', hastaAdi);
        
        // Manuel ASCII dönüştürme - Kesin Çalışan Versiyon
        const asciiHastaAdi = hastaAdi
          .replace(/Ş/g, 'S').replace(/ş/g, 's')
          .replace(/Ğ/g, 'G').replace(/ğ/g, 'g')  
          .replace(/İ/g, 'I').replace(/ı/g, 'i')
          .replace(/Ç/g, 'C').replace(/ç/g, 'c')
          .replace(/Ö/g, 'O').replace(/ö/g, 'o')
          .replace(/Ü/g, 'U').replace(/ü/g, 'u');
        
        console.log('🔍 FINAL ASCII:', hastaAdi, ' → ', asciiHastaAdi);
        doc.text(asciiHastaAdi.toUpperCase(), 20, 20);
        
        // Debug: Hem orijinal hem ASCII versiyonu deneyelim
        console.log('🔍 Debug - orijinal isim:', hastaAdi);
        const pdfUygunHastaAdi = window.fixTurkishChars(hastaAdi);
        console.log('  Debug - ASCII isim:', pdfUygunHastaAdi);
        
        // İki versiyon da deneyelim
        try {
          // Önce ASCII versiyonu dene
          doc.text(pdfUygunHastaAdi.toUpperCase(), 20, 20);
          console.log('✅ ASCII versiyon kullanıldı');
        } catch (e) {
          // ASCII başarısız olursa orijinali dene
          doc.text(hastaAdi.toUpperCase(), 20, 20);
          console.log('⚠️ Orijinal versiyon kullanıldı');
        }
        
        doc.setFontSize(14);
        doc.text(window.fixTurkishChars('LENF DRENAJ MASAJI TAKVIMI'), 20, 35);
        
        // Açıklama
        doc.setFontSize(10);
        doc.setFont('helvetica', 'normal');
        doc.text('5. hafta başlangıcından itibaren 8 haftalık program', 20, 50);
        
        // Tablo parametreleri
        const startX = 20;
        const startY = 65;
        const rowHeight = 12;
        const colWidths = [15, 50, 50, 50]; // Hafta, Tarih, Sabah, Akşam
        const tableWidth = colWidths.reduce((a, b) => a + b, 0);
        
        // Tablo başlıkları
        doc.setFontSize(10);
        doc.setFont('helvetica', 'bold');
        
        // Başlık satırı arka planı
        doc.setFillColor(230, 230, 230);
        doc.rect(startX, startY, tableWidth, rowHeight, 'F');
        
        // Başlık metinleri
        doc.setTextColor(0, 0, 0);
        doc.text('Hafta', startX + 5, startY + 8);
        doc.text('Tarih Aralığı', startX + colWidths[0] + 5, startY + 8);
        doc.text('Sabah', startX + colWidths[0] + colWidths[1] + 5, startY + 8);
        doc.text('Akşam', startX + colWidths[0] + colWidths[1] + colWidths[2] + 5, startY + 8);
        
        // Tablo çerçevesi
        doc.setDrawColor(0, 0, 0);
        doc.setLineWidth(0.3);
        doc.rect(startX, startY, tableWidth, rowHeight);
        
        // Sütun ayırıcıları (başlık satırı için)
        let currentX = startX;
        for (let i = 0; i < colWidths.length - 1; i++) {
          currentX += colWidths[i];
          doc.line(currentX, startY, currentX, startY + rowHeight);
        }
        
        // 8 haftalık veri satırları
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(9);
        
        for (let hafta = 1; hafta <= 8; hafta++) {
          const currentY = startY + (hafta * rowHeight);
          
          // Hafta başlangıç tarihini hesapla
          const haftaBaslangic = new Date(baslangicTarihi);
          haftaBaslangic.setDate(haftaBaslangic.getDate() + ((hafta - 1) * 7));
          
          const haftaSonu = new Date(haftaBaslangic);
          haftaSonu.setDate(haftaSonu.getDate() + 6);
          
          // Tarih formatı
          const baslangicStr = haftaBaslangic.toLocaleDateString('tr-TR');
          const bitisStr = haftaSonu.toLocaleDateString('tr-TR');
          const tarihAraligi = `${baslangicStr} - ${bitisStr}`;
          
          // Lenf drenaj programına göre metin
          let sabahMetin = '';
          let aksamMetin = '';
          
          if (hafta === 1) {
            // 1. hafta: Günde 2 kez (sabah + akşam)
            sabahMetin = '✓ Uygulanacak';
            aksamMetin = '✓ Uygulanacak';
          } else if (hafta === 2 || hafta === 3) {
            // 2-3. hafta: Sadece sabahları
            sabahMetin = '✓ Uygulanacak';
            aksamMetin = '-';
          } else if (hafta === 4 || hafta === 5) {
            // 4-5. hafta: Günaşırı sabahları
            sabahMetin = '✓ Günaşırı';
            aksamMetin = '-';
          } else if (hafta === 6 || hafta === 7 || hafta === 8) {
            // 6-7-8. hafta: Haftada 2 gün (Salı-Cuma)
            sabahMetin = '✓ Salı-Cuma';
            aksamMetin = '-';
          }
          
          // Satır arka planı (her iki satırda bir)
          if (hafta % 2 === 0) {
            doc.setFillColor(248, 248, 248);
            doc.rect(startX, currentY, tableWidth, rowHeight, 'F');
          }
          
          // Satır çerçevesi
          doc.setDrawColor(0, 0, 0);
          doc.setLineWidth(0.3);
          doc.rect(startX, currentY, tableWidth, rowHeight);
          
          // Sütun ayırıcıları
          currentX = startX;
          for (let i = 0; i < colWidths.length - 1; i++) {
            currentX += colWidths[i];
            doc.line(currentX, currentY, currentX, currentY + rowHeight);
          }
          
          // Metinleri ekle
          doc.setTextColor(0, 0, 0);
          doc.text(`${hafta}. Hafta`, startX + 3, currentY + 8);
          doc.text(tarihAraligi, startX + colWidths[0] + 3, currentY + 8);
          doc.text(sabahMetin, startX + colWidths[0] + colWidths[1] + 3, currentY + 8);
          doc.text(aksamMetin, startX + colWidths[0] + colWidths[1] + colWidths[2] + 3, currentY + 8);
        }
        
        // Alt açıklama
        const aciklamaY = startY + (9 * rowHeight) + 10;
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(10);
        doc.text('UYGULAMA TALİMATI:', startX, aciklamaY);
        
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(9);
        doc.text('• 1. hafta: Günde 2 kez (sabah + akşam) uygulanacak', startX, aciklamaY + 12);
        doc.text('• 2-3. hafta: Sadece sabahları uygulanacak', startX, aciklamaY + 22);
        doc.text('• 4-5. hafta: Günaşırı sabahları uygulanacak', startX, aciklamaY + 32);
        doc.text('• 6-7-8. hafta: Haftada 2 gün (Salı-Cuma) sabahları uygulanacak', startX, aciklamaY + 42);
        
        // PDF'yi kaydet
        const tarih = new Date().toISOString().slice(0, 10);
        const dosyaAdi = `${hastaAdi}_Lenf_Drenaj_Takvimi_${tarih}.pdf`;
        doc.save(dosyaAdi);
        
        console.log('✅ Lenf Drenaj Takvimi PDF oluşturuldu:', dosyaAdi);
        alert(`✅ Lenf Drenaj Masajı Takvimi PDF oluşturuldu!\n\nDosya: ${dosyaAdi}`);
        
      } catch (error) {
        console.error('❌ Lenf Drenaj Takvimi PDF hatası:', error);
        alert('PDF oluştururken hata oluştu: ' + error.message);
      }
    }

    // Özelleştirilebilir Lenf Masaj Takvimi
    async function generateCustomLenfMasajTakvimi() {
      try {
        // Default değerleri hazırla
        let defaultHastaAdi = '';
        let defaultBaslangicTarihi = '';
        
        // Mevcut seçili hasta varsa al
        if (seciliHasta) {
          defaultHastaAdi = seciliHasta.isim || '';
        }
        
        // 5. hafta başlangıç tarihini bulmaya çalış
        try {
          const haftalar = getHaftaListesi();
          if (haftalar.length >= 5 && haftalar[4].baslangic) {
            const besinciHaftaTarihi = new Date(haftalar[4].baslangic);
            // Pazartesi kontrolü
            const gunNo = besinciHaftaTarihi.getDay();
            if (gunNo !== 1) {
              const gunFarki = gunNo === 0 ? 1 : (1 - gunNo);
              besinciHaftaTarihi.setDate(besinciHaftaTarihi.getDate() + gunFarki);
            }
            defaultBaslangicTarihi = besinciHaftaTarihi.toISOString().slice(0, 10);
          } else {
            // Bugünden itibaren bir sonraki pazartesi
            const bugun = new Date();
            const gelecekPazartesi = new Date(bugun.getFullYear(), bugun.getMonth(), bugun.getDate() - bugun.getDay() + 8);
            defaultBaslangicTarihi = gelecekPazartesi.toISOString().slice(0, 10);
          }
        } catch (e) {
          // Hata durumunda bir sonraki pazartesi
          const bugun = new Date();
          const gelecekPazartesi = new Date(bugun.getFullYear(), bugun.getMonth(), bugun.getDate() - bugun.getDay() + 8);
          defaultBaslangicTarihi = gelecekPazartesi.toISOString().slice(0, 10);
        }
        
        // Kullanıcıdan bilgileri al
        const hastaAdi = prompt('Hasta Adı:', defaultHastaAdi);
        if (!hastaAdi) {
          alert('Hasta adı girilmedi, işlem iptal edildi.');
          return;
        }
        
        const baslangicTarihi = prompt('Başlangıç Tarihi (YYYY-MM-DD):', defaultBaslangicTarihi);
        if (!baslangicTarihi) {
          alert('Başlangıç tarihi girilmedi, işlem iptal edildi.');
          return;
        }
        
        // Tarih kontrolü
        const tarihObj = new Date(baslangicTarihi);
        if (isNaN(tarihObj.getTime())) {
          alert('Geçersiz tarih formatı! YYYY-MM-DD formatında giriniz.');
          return;
        }
        
        // Pazartesi kontrolü
        const gunNo = tarihObj.getDay();
        if (gunNo !== 1) {
          const gunIsimleri = ['Pazar', 'Pazartesi', 'Salı', 'Çarşamba', 'Perşembe', 'Cuma', 'Cumartesi'];
          const mevcutGun = gunIsimleri[gunNo];
          if (!confirm(`Seçilen tarih ${mevcutGun} günü. Lenf masaj programı pazartesi günleri başlar.\n\nEn yakın pazartesi gününe otomatik ayarlansın mı?`)) {
            return;
          }
          
          // En yakın pazartesiye ayarla
          const gunFarki = gunNo === 0 ? 1 : (1 - gunNo);
          tarihObj.setDate(tarihObj.getDate() + gunFarki);
        }
        
        // Özel lenf masaj PDF'i oluştur (5. hafta benzeri)
        await generateCustomLenfMasajPDF(hastaAdi, tarihObj);
        
      } catch (error) {
        console.error('❌ Özel Lenf Masaj Takvimi hatası:', error);
        alert('PDF oluştururken hata oluştu: ' + error.message);
      }
    }

    // Özelleştirilebilir Egzersiz Takvimi 
    async function generateCustomEgzersizTakvimi() {
      try {
        // Default değerleri hazırla
        let defaultHastaAdi = '';
        let defaultBaslangicTarihi = '';
        
        // Mevcut seçili hasta varsa al
        if (seciliHasta) {
          defaultHastaAdi = seciliHasta.isim || '';
        }
        
        // 9. hafta başlangıç tarihini bulmaya çalış (5. haftadan 4 hafta sonra)
        try {
          const haftalar = getHaftaListesi();
          if (haftalar.length >= 5 && haftalar[4].baslangic) {
            const besinciHaftaTarihi = new Date(haftalar[4].baslangic);
            // Pazartesi kontrolü
            const gunNo = besinciHaftaTarihi.getDay();
            if (gunNo !== 1) {
              const gunFarki = gunNo === 0 ? 1 : (1 - gunNo);
              besinciHaftaTarihi.setDate(besinciHaftaTarihi.getDate() + gunFarki);
            }
            // 9. hafta = 5. haftadan 4 hafta (28 gün) sonra
            const dokuzuncuHaftaTarihi = new Date(besinciHaftaTarihi.getTime() + (4 * 7 * 24 * 60 * 60 * 1000));
            defaultBaslangicTarihi = dokuzuncuHaftaTarihi.toISOString().slice(0, 10);
          } else {
            // Bugünden itibaren bir sonraki pazartesi
            const bugun = new Date();
            const gelecekPazartesi = new Date(bugun.getFullYear(), bugun.getMonth(), bugun.getDate() - bugun.getDay() + 8);
            defaultBaslangicTarihi = gelecekPazartesi.toISOString().slice(0, 10);
          }
        } catch (e) {
          // Hata durumunda bir sonraki pazartesi
          const bugun = new Date();
          const gelecekPazartesi = new Date(bugun.getFullYear(), bugun.getMonth(), bugun.getDate() - bugun.getDay() + 8);
          defaultBaslangicTarihi = gelecekPazartesi.toISOString().slice(0, 10);
        }
        
        // Kullanıcıdan bilgileri al
        const hastaAdi = prompt('Hasta Adı:', defaultHastaAdi);
        if (!hastaAdi) {
          alert('Hasta adı girilmedi, işlem iptal edildi.');
          return;
        }
        
        const baslangicTarihi = prompt('Başlangıç Tarihi (YYYY-MM-DD):', defaultBaslangicTarihi);
        if (!baslangicTarihi) {
          alert('Başlangıç tarihi girilmedi, işlem iptal edildi.');
          return;
        }
        
        // Tarih kontrolü
        const tarihObj = new Date(baslangicTarihi);
        if (isNaN(tarihObj.getTime())) {
          alert('Geçersiz tarih formatı! YYYY-MM-DD formatında giriniz.');
          return;
        }
        
        // Pazartesi kontrolü
        const gunNo = tarihObj.getDay();
        if (gunNo !== 1) {
          const gunIsimleri = ['Pazar', 'Pazartesi', 'Salı', 'Çarşamba', 'Perşembe', 'Cuma', 'Cumartesi'];
          const mevcutGun = gunIsimleri[gunNo];
          if (!confirm(`Seçilen tarih ${mevcutGun} günü. Egzersiz programı pazartesi günleri başlar.\n\nEn yakın pazartesi gününe otomatik ayarlansın mı?`)) {
            return;
          }
          
          // En yakın pazartesiye ayarla
          const gunFarki = gunNo === 0 ? 1 : (1 - gunNo);
          tarihObj.setDate(tarihObj.getDate() + gunFarki);
        }
        
        // Özel egzersiz + lenf masaj PDF'i oluştur (9. hafta benzeri)
        await generateCustomEgzersizPDF(hastaAdi, tarihObj);
        
      } catch (error) {
        console.error('❌ Özel Egzersiz Takvimi hatası:', error);
        alert('PDF oluştururken hata oluştu: ' + error.message);
      }
    }

    function gosterTariflerHafta(i) {
      const hafta = getHaftaListesi()[i];
      const ul = document.getElementById('haftaTarifListesi_' + i);
      if (!ul) return;
      ul.innerHTML = '';
      (hafta.tarifler||[]).forEach(t => {
        const li = document.createElement('li');
        li.textContent = t;
        ul.appendChild(li);
      });
    }

    function tarifKartYukleHafta(i, input) {
      const hafta = getHaftaListesi()[i];
      hafta.tarifKartlar = [];
      const gorselDiv = document.getElementById('haftaKartGorsel_' + i);
      gorselDiv.innerHTML = '';
      Array.from(input.files).forEach(file => {
        const reader = new FileReader();
        reader.onload = function (e) {
          hafta.tarifKartlar.push({ name: file.name, data: e.target.result });
          const img = document.createElement('img');
          img.src = e.target.result;
          img.alt = file.name;
          img.style.width = '100px';
          img.style.margin = '4px';
          gorselDiv.appendChild(img);
          saveToStorage();
          
          console.log('✅ Tarif kartı eklendi:', file.name, 'hafta:', i + 1);
          
          // Otomatik GitHub kaydetme kaldırıldı (çakışmaları önlemek için)
          // Manuel kaydetme için GitHub'a Kaydet butonunu kullanın
        };
        reader.readAsDataURL(file);
      });
    }

    function gosterKartlarHafta(i) {
      const hafta = getHaftaListesi()[i];
      const gorselDiv = document.getElementById('haftaKartGorsel_' + i);
      if (!gorselDiv) return;
      gorselDiv.innerHTML = '';
      (hafta.tarifKartlar||[]).forEach(kart => {
        const img = document.createElement('img');
        // Güvenli src atama - undefined hatası önleme
        img.src = kart.data || kart.kartData || `https://mustafasacar35.github.io/lipodem-takip-paneli-4/tarifler/${kart.kartResmi || 'default.jpg'}`;
        img.alt = kart.name || kart.tarifAdi || 'Tarif kartı';
        img.style.width = '100px';
        img.style.margin = '4px';
        gorselDiv.appendChild(img);
      });
    }

    async function otomatikEsleHafta(i) {
  // Tarif satırından alternatifli yemek adlarını ayıkla
  function extractYemekAdlari(satir) {
    // Baştaki * ve miktarları temizle
    let s = satir.replace(/^\*+\s*/, '');
    // Parantez içini, + ile eklenenleri, miktarları temizle
    s = s.replace(/\(.*?\)/g, '');
    s = s.replace(/\+.*$/, '');
    s = s.replace(/([0-9]+\s*(gram|gr|adet|yemek\s*kaşığı|tatlı\s*kaşığı|su\s*bardağı|dilim|kase|çay\s*bardağı|bardak|kaşık|tbsp|tsp|ml|kg|g))($|\s)/gi, '');
    s = s.replace(/(istenilen baharatlarla|istenirse|isteğe bağlı|arzuya göre|isteğe göre|isteğe bağlı olarak|isteğe göre baharat|isteğe göre malzeme|isteğe göre eklenebilir)/gi, '');
    
    // Önce "ya da", "veya" ile ayrılmış alternatifleri ayır
    let alternatifler = s.split(/\s*(ya da|veya)\s*/i).map(a => a.trim()).filter(a => a.length > 0);
    let tumAdlar = [];
    
    // Her alternatif için ayrı işlem yap
    alternatifler.forEach(alt => {
      // "ile", "için", "ve" kelimelerini temizle
      alt = alt.replace(/\b(ile|için|ve)\b/gi, '');
      // "/" ve "," ile ayrılmış alt seçenekleri de ayır - YENİ: / işaretini de dahil et
      let adlar = alt.split(/\s*[\/|,]\s*/).map(a => a.trim()).filter(a => a.length > 0);
      // Sadece ana yemek adını ayıkla: baştaki ve sondaki boşlukları, miktarları, "için" ve fazlalıkları sil
      adlar = adlar.map(a => a.replace(/^[0-9]+\s*/, '').replace(/\s*[0-9]+\s*(gram|gr|adet|dilim|kase|bardak|ml|kg|tsp|tbsp)?\s*$/i, '').replace(/\s*icin?$/i, '').replace(/\s*ile$/i, '').trim());
      // Çok kısa olanları atma - sadece boş olanları at
      adlar = adlar.filter(a => a.length > 0);
      tumAdlar = tumAdlar.concat(adlar);
    });
    
    return tumAdlar;
  }

  // Manuel eşleştirme kontrolü
  function manuelEslestirmeKontrol(tarifSatir) {
    // Normalize fonksiyonu burada da tanımla
    function normalizeLocal(str) {
      return str
        .toLowerCase()
        .replace(/ç/g, 'c').replace(/ğ/g, 'g').replace(/ş/g, 's')
        .replace(/ü/g, 'u').replace(/ö/g, 'o').replace(/ı/g, 'i')
        .replace(/i̇/g, 'i')
        .replace(/[_*\/()]/g, ' ')  // Sembolleri boşlukla değiştir
        .replace(/\s+/g, ' ')       // Çoklu boşlukları tek boşluğa çevir
        .replace(/[^a-z0-9\s]/g, '') // Sadece harf, rakam ve boşluk bırak
        .trim();
    }
    
    const normalizeEdilmis = normalizeLocal(tarifSatir);
    
    if (manuelEslestirmeler[normalizeEdilmis]) {
      const eslestirme = manuelEslestirmeler[normalizeEdilmis];
      return eslestirme.kartlar.map(kartAdi => {
        const kart = tumKartlar.find(k => k.name === kartAdi);
        return kart || null;
      }).filter(k => k !== null);
    }
    
    return null;
  }

  // Eşleşme yasağı kontrolü
  function eslesmemeKontrolu(tarifSatir, kartAdi) {
    // Normalize fonksiyonu
    function normalizeLocal(str) {
      return str
        .toLowerCase()
        .replace(/ç/g, 'c').replace(/ğ/g, 'g').replace(/ş/g, 's')
        .replace(/ü/g, 'u').replace(/ö/g, 'o').replace(/ı/g, 'i')
        .replace(/i̇/g, 'i')
        .replace(/[_*\/()]/g, ' ')
        .replace(/\s+/g, ' ')
        .replace(/[^a-z0-9\s]/g, '')
        .trim();
    }
    
    const normalizeEdilmis = normalizeLocal(tarifSatir);
    
    if (eslesmemeKurallari[normalizeEdilmis]) {
      const yasak = eslesmemeKurallari[normalizeEdilmis];
      return yasak.yasakliKartlar.includes(kartAdi);
    }
    
    return false; // Yasak yok, eşleşebilir
  }
  // Dosya adındaki miktar ve açıklama kelimelerini temizle
  function temizleDosyaAdi(ad) {
    if (!ad || typeof ad !== 'string') return ''; // Güvenlik kontrolü
    let s = ad.replace(/\.(jpg|jpeg|png)$/i, '');
    s = s.replace(/_\d+(gr|gram|adet|dilim|kase|bardak|ml|kg|tsp|tbsp)?/gi, '');
    s = s.replace(/\(.*?\)/g, '');
    s = s.replace(/_?(istenilen_baharatlarla|istenirse|istege_bagli|arzuya_gore|istege_gore|istege_bagli_olarak|istege_gore_baharat|istege_gore_malzeme|istege_gore_eklenebilir)/gi, '');
    s = s.replace(/_+/g, '_');
    s = s.replace(/\s+/g, '_');
    s = s.replace(/\+.*$/, '');
    return s.trim();
  }
   // Normalize fonksiyonu - sembolleri ve Türkçe karakterleri temizle
  function normalize(str) {
    return str
      .toLowerCase()
      .replace(/ç/g, 'c').replace(/ğ/g, 'g').replace(/ş/g, 's')
      .replace(/ü/g, 'u').replace(/ö/g, 'o').replace(/ı/g, 'i')
      .replace(/i̇/g, 'i')
      .replace(/[_*\/()]/g, ' ')  // Sembolleri boşlukla değiştir
      .replace(/\s+/g, ' ')       // Çoklu boşlukları tek boşluğa çevir
      .replace(/[^a-z0-9\s]/g, '') // Sadece harf, rakam ve boşluk bırak
      .trim();
  }

  // Tarif kartındaki TÜM kelimelerin PDF yemeğinde ardışık olarak bulunup bulunmadığını kontrol et
  function kartKelimeleriniKontrolEt(kartKelimeler, tarifKelimeler) {
    if (kartKelimeler.length === 0) return false;
    
    // Kart kelimelerini birleştir (ardışık arama için)
    const kartMetni = kartKelimeler.join(' ');
    const tarifMetni = tarifKelimeler.join(' ');
    
    // Kart metninin tarif metninde ardışık olarak bulunup bulunmadığını kontrol et
    return tarifMetni.includes(kartMetni);
  }
 // Eğer görseller henüz yüklenmediyse, önce yükle
  if (tariflerKlasoruGorselleri.length === 0) {
    await tariflerKlasoruGorselleriniYukle();
  }

  const hafta = getHaftaListesi()[i];
  const eslesenDiv = document.getElementById('eslesenKartlar_' + i);
  
  // DOM element kontrolü - çoklu PDF işleminde element olmayabilir
  const domElementMevcut = eslesenDiv !== null;
  if (domElementMevcut) {
    eslesenDiv.innerHTML = '';
  }

  if (!hafta.tarifler.length) {
    if (domElementMevcut) {
      eslesenDiv.innerHTML = '<i>Önce PDF yükleyin ve tarifleri çıkarın.</i>';
    }
    return [];
  }

  // Hem manuel yüklenen hem tarifler klasörü görsellerini birleştir
  const tumKartlar = [].concat(
    hafta.tarifKartlar || [],
    tariflerKlasoruGorselleri.map(g => ({ name: g.name, data: g.url, url: g.url }))
  ).filter(kart => kart && kart.name); // Null/undefined kartları filtrele

  if (!tumKartlar.length) {
    // Daha detaylı hata mesajı ve çözüm önerileri
    const hataDiv = document.createElement('div');
    hataDiv.style.padding = '15px';
    hataDiv.style.border = '2px solid #dc3545';
    hataDiv.style.borderRadius = '8px';
    hataDiv.style.backgroundColor = '#f8d7da';
    hataDiv.style.color = '#721c24';
    hataDiv.innerHTML = `
      <h4 style="margin-top:0; color:#721c24;">❌ Tarif kartları bulunamadı</h4>
      <p><strong>Sebep:</strong> Bu hafta için eşleşme yapılabilecek hiçbir tarif kartı bulunamadı.</p>
      <div style="margin-top:15px;">
        <p><strong>Çözüm seçenekleri:</strong></p>
        <ol style="margin-left:20px;">
          <li><strong>Manuel görsel yükle:</strong> Bu hafta için "Tarif Kartları" bölümünden görsel dosyaları yükleyin</li>
          <li><strong>Tarifler klasörü oluştur:</strong> Web sitenizin ana dizininde "tarifler/" klasörü oluşturun ve içine görsel dosyalarını ekleyin</li>
          <li><strong>list.json dosyası:</strong> "tarifler/" klasöründe dosya listesini içeren "list.json" dosyası oluşturun</li>
        </ol>
      </div>
      <div style="margin-top:15px; padding:10px; background:#fff3cd; border:1px solid #ffeaa7; border-radius:5px;">
        <strong>💡 İpucu:</strong> Tarifler klasörü durumu: 
        <span style="color:${tariflerKlasoruGorselleri.length > 0 ? 'green' : 'red'};">
          ${tariflerKlasoruGorselleri.length} görsel bulundu
        </span>
        <br>
        Manuel yüklenen kartlar: 
        <span style="color:${(hafta.tarifKartlar && hafta.tarifKartlar.length > 0) ? 'green' : 'red'};">
          ${(hafta.tarifKartlar && hafta.tarifKartlar.length) || 0} adet
        </span>
      </div>
      <div style="margin-top:15px; text-align:center;">
        <button onclick="yeniBirDenemeEt(${i})" style="background:#28a745; color:white; padding:10px 20px; border:none; border-radius:5px; cursor:pointer; margin-right:10px;">
          🔄 Tarifler Klasörünü Yeniden Yükle
        </button>
        <button onclick="debugTariflerKlasoru()" style="background:#17a2b8; color:white; padding:10px 20px; border:none; border-radius:5px; cursor:pointer;">
          🔍 Detaylı Debug
        </button>
      </div>
    `;
    if (domElementMevcut) {
      eslesenDiv.appendChild(hataDiv);
    }
    return [];
  }

  // Normalize fonksiyonu - sembolleri ve Türkçe karakterleri temizle
  function normalize(str) {
    return str
      .toLowerCase()
      .replace(/ç/g, 'c').replace(/ğ/g, 'g').replace(/ş/g, 's')
      .replace(/ü/g, 'u').replace(/ö/g, 'o').replace(/ı/g, 'i')
      .replace(/i̇/g, 'i')
      .replace(/[_*\/()]/g, ' ')  // Sembolleri boşlukla değiştir
      .replace(/\s+/g, ' ')       // Çoklu boşlukları tek boşluğa çevir
      .replace(/[^a-z0-9\s]/g, '') // Sadece harf, rakam ve boşluk bırak
      .trim();
  }

  // Basit Levenshtein mesafesi (benzerlik için)
  function levenshtein(a, b) {
    const matrix = Array(a.length + 1).fill(null).map(() => Array(b.length + 1).fill(null));
    for (let i = 0; i <= a.length; i++) matrix[i][0] = i;
    for (let j = 0; j <= b.length; j++) matrix[0][j] = j;
    for (let i = 1; i <= a.length; i++) {
      for (let j = 1; j <= b.length; j++) {
        const cost = a[i - 1] === b[j - 1] ? 0 : 1;
        matrix[i][j] = Math.min(
          matrix[i - 1][j] + 1,
          matrix[i][j - 1] + 1,
          matrix[i - 1][j - 1] + cost
        );
      }
    }
    return matrix[a.length][b.length];
  }

  const kullanilanKartlar = new Set();
  let eslesenKartlarListesi = [];
  let eslesmeyenTarifler = [];
  let eslesmeyenOneriler = [];

  // Her tarif için eşleştirme yap
  hafta.tarifler.forEach(tarif => {
    let tarifSatir = tarif.replace(/^\*+\s*/, '').trim();
    let eslesen = null;
    let eslesenKartlar = [];
    let eslesenTip = '';

    // Debug: mantarlı tavuk sote için özel çıktı
    if (tarifSatir.toLowerCase().includes('mantarlı tavuk sote') || tarifSatir.toLowerCase().includes('mantarli tavuk sote')) {
      console.log('DEBUG - Mantarlı tavuk sote analizi:');
      console.log('Orijinal tarif:', tarifSatir);
      console.log('DEBUG - Toplam kart sayısı:', tumKartlar.length);
      console.log('DEBUG - mantarli_tavuk_sote.jpg var mı?', tumKartlar.some(k => k.name === 'mantarli_tavuk_sote.jpg'));
    }

    // 1. Önce manuel eşleştirme kontrol et
    const manuelEslesenler = manuelEslestirmeKontrol(tarif);
    if (manuelEslesenler && manuelEslesenler.length > 0) {
      // Manuel eşleştirme bulundu
      const kullanilamayacaklar = manuelEslesenler.filter(kart => kullanilanKartlar.has(kart.name));
      const kullanilabilirler = manuelEslesenler.filter(kart => !kullanilanKartlar.has(kart.name));
      
      if (kullanilabilirler.length > 0) {
        eslesenKartlar = kullanilabilirler;
        eslesenTip = 'manuel eşleştirme';
        kullanilabilirler.forEach(kart => kullanilanKartlar.add(kart.name));
      }
    } else {
      // 2. Otomatik eşleştirme dene
      let yemekAdlari = extractYemekAdlari(tarifSatir);

      // Her yemek adı için eşleştirme dene
      for (let yemekAdi of yemekAdlari) {
        const tarifNorm = normalize(yemekAdi);
        const tarifKelimeler = tarifNorm.split(' ').filter(k => k.length > 0);

        // Kullanılmayan kartlar arasında ara
        for (let kart of tumKartlar) {
          if (kullanilanKartlar.has(kart.name)) continue;

          // Eşleşme yasağı kontrolü - ÖNCE BU KONTROL EDİLİR
          if (eslesmemeKontrolu(tarif, kart.name)) {
            continue; // Bu kart yasaklı, sonrakine geç
          }

          const kartNorm = normalize(temizleDosyaAdi(kart.name));
          const kartKelimeler = kartNorm.split(' ').filter(k => k.length > 0);

          // 1. Önce tam eşleşme kontrol et
          if (tarifNorm === kartNorm) {
            eslesen = kart;
            eslesenKartlar = [kart];
            eslesenTip = 'tam eşleşme';
            break;
          }

          // 2. Kart kelimelerinin tarif içinde ardışık olarak bulunup bulunmadığını kontrol et
          if (kartKelimeleriniKontrolEt(kartKelimeler, tarifKelimeler)) {
            eslesen = kart;
            eslesenKartlar = [kart];
            eslesenTip = 'ardışık eşleşme';
            break;
          }
        }

        // Eşleşme bulunursa bu yemek adı için dur
        if (eslesen) {
          kullanilanKartlar.add(eslesen.name);
          break;
        }
      }
    }

    // Eşleşme bulunduysa kaydet
    if (eslesenKartlar.length > 0) {
      eslesenKartlar.forEach(kart => {
        eslesenKartlarListesi.push({ 
          tarif: tarif, 
          kart: kart, 
          tip: eslesenTip 
        });
      });
    } else {
      eslesmeyenTarifler.push(tarif);
    }
  });

  // Sonuçları göster (sadece DOM element varsa)
  if (domElementMevcut) {
    if (eslesenKartlarListesi.length === 0) {
      eslesenDiv.innerHTML = '<p>Eşleşme bulunamadı.</p>';
    } else {
      // Tarifleri grupla ve göster
      const tarifGruplari = {};
      eslesenKartlarListesi.forEach(({ tarif, kart, tip }) => {
        if (!tarifGruplari[tarif]) {
          tarifGruplari[tarif] = { kartlar: [], tip: tip };
        }
        tarifGruplari[tarif].kartlar.push(kart);
      });

      Object.keys(tarifGruplari).forEach(tarif => {
        const grup = tarifGruplari[tarif];
        const p = document.createElement('p');
        const kartIsimleri = grup.kartlar.map(k => k.name).join(', ');
        
        // Tarif adını tıklanabilir span içine al
        const tarifSpan = document.createElement('span');
        tarifSpan.innerHTML = `<b>${tarif}</b>`;
        tarifSpan.style.cursor = 'pointer';
        tarifSpan.style.textDecoration = 'underline';
        tarifSpan.style.color = '#007bff';
        tarifSpan.title = 'Tıkla ve manuel eşleştirme panelini aç';
        
        // Tıklama olayı - Manuel eşleştirme panelini aç ve bilgileri doldur
        tarifSpan.onclick = () => {
          console.log('🔧 Eşleşen tarif adına tıklandı:', tarif, grup.kartlar);
          try {
            if (typeof eslesenTarifManuelEslestir === 'function') {
              eslesenTarifManuelEslestir(tarif, grup.kartlar);
            } else {
              console.error('❌ eslesenTarifManuelEslestir fonksiyonu bulunamadı!');
              alert('Manuel eşleştirme fonksiyonu yüklenemedi. Sayfayı yenileyin.');
            }
          } catch (error) {
            console.error('❌ Eşleşen tarif tıklama hatası:', error);
            alert('Hata: ' + error.message);
          }
        };
        
        // Full p elementi oluştur (innerHTML += kullanmadan)
        p.appendChild(tarifSpan);
        
        const okSpan = document.createElement('span');
        okSpan.innerHTML = ` → <span style="color:green;">${kartIsimleri}</span> <small style="color:blue;">(${grup.tip})</small>`;
        p.appendChild(okSpan);
        
        eslesenDiv.appendChild(p);
        
        // Her kart için görsel ekle
        grup.kartlar.forEach(kart => {
          const img = document.createElement('img');
          // Güvenli src atama - undefined hatası önleme
          img.src = kart.data || kart.kartData || `https://mustafasacar35.github.io/lipodem-takip-paneli-4/tarifler/${kart.kartResmi || kart.name || 'default.jpg'}`;
          img.alt = tarif;
          img.title = kart.name || kart.tarifAdi || 'Tarif kartı';
          img.style.width = '120px';
          img.style.margin = '4px';
          eslesenDiv.appendChild(img);
        });
      });
      
      // İndir butonları ekle
      const indirDiv = document.createElement('div');
      indirDiv.style.marginTop = '15px';
      indirDiv.style.display = 'flex';
      indirDiv.style.gap = '10px';
      indirDiv.style.flexWrap = 'wrap';
      
      // ZIP olarak indir butonu
      const zipBtn = document.createElement('button');
      zipBtn.textContent = '📦 Tüm Dosyaları ZIP İndir';
      zipBtn.style.background = '#28a745';
      zipBtn.style.color = 'white';
      zipBtn.style.border = 'none';
      zipBtn.style.padding = '10px 15px';
      zipBtn.style.borderRadius = '5px';
    zipBtn.style.cursor = 'pointer';
    zipBtn.style.marginBottom = '10px';
    zipBtn.title = 'Haftalık PDF, eşleşen tarif kartları ve GPT mesajını tek ZIP dosyasında indirir';
    zipBtn.onclick = function() { 
      console.log('🔍 ZIP butonuna tıklandı, hafta index:', i);
      zipEslesenGorseller(i); 
    };
    
    // PDF Takip Tablosu oluştur butonu
    const pdfBtn = document.createElement('button');
    pdfBtn.textContent = '📄 Takip Tablosu PDF';
    pdfBtn.style.background = '#dc3545';
    pdfBtn.style.color = 'white';
    pdfBtn.style.border = 'none';
    pdfBtn.style.padding = '10px 15px';
    pdfBtn.style.borderRadius = '5px';
    pdfBtn.style.cursor = 'pointer';
    pdfBtn.onclick = function() { generatePatientPDF(); };
    
    // ZIP + PDF Combo butonu
    const comboBtn = document.createElement('button');
    comboBtn.textContent = '🎯 Kartlar + PDF Tablosu';
    comboBtn.style.background = '#6f42c1';
    comboBtn.style.color = 'white';
    comboBtn.style.border = 'none';
    comboBtn.style.padding = '10px 15px';
    comboBtn.style.borderRadius = '5px';
    comboBtn.style.cursor = 'pointer';
    comboBtn.onclick = function() { 
      zipEslesenGorseller(i); 
      setTimeout(() => generatePatientPDF(), 1000); 
    };
    
    // Sidebar butonları artık GPT alanında olduğu için kaldırıldı
  }
  } // domElementMevcut kapanışı

  // Eşleşmeyen tarifleri yeni accordion sistemine ekle (sadece DOM varsa)
  if (domElementMevcut && eslesmeyenTarifler.length > 0) {
    const eslesmeyenlerContent = document.getElementById('eslesmeyenlerContent');
    const eslesmeyenlerBaslik = document.getElementById('eslesmeyenlerBaslik');
    
    if (eslesmeyenlerContent && eslesmeyenlerBaslik) {
      // Başlığı güncelle
      eslesmeyenlerBaslik.textContent = `🚫 Eşleşmeyen Tarifler (${eslesmeyenTarifler.length})`;
      
      // İçeriği temizle ve yeniden doldur
      eslesmeyenlerContent.innerHTML = '';
      
      eslesmeyenTarifler.forEach(tarif => {
        const p = document.createElement('p');
        p.textContent = tarif;
        p.style.color = '#dc3545';
        p.style.margin = '6px 0';
        p.style.padding = '4px 8px';
        p.style.background = '#fff5f5';
        p.style.borderLeft = '3px solid #dc3545';
        p.style.borderRadius = '4px';
        p.style.cursor = 'pointer';
        p.style.transition = 'background-color 0.2s';
        p.title = 'Tıkla ve manuel eşleştirme yap';
        
        // Hover efekti
        p.onmouseenter = () => p.style.background = '#ffe6e6';
        p.onmouseleave = () => p.style.background = '#fff5f5';
        
        // Tıklama olayı - Manuel eşleştirme panelini aç ve tarif adını doldur
        p.onclick = () => {
          eslesmeyenTarifManuelEslestir(tarif);
        };
        
        eslesmeyenlerContent.appendChild(p);
      });
    }
  } else if (domElementMevcut) {
    // Eşleşmeyen tarif yoksa başlığı sıfırla
    const eslesmeyenlerBaslik = document.getElementById('eslesmeyenlerBaslik');
    const eslesmeyenlerContent = document.getElementById('eslesmeyenlerContent');
    
    if (eslesmeyenlerBaslik) {
      eslesmeyenlerBaslik.textContent = '🚫 Eşleşmeyen Tarifler';
    }
    if (eslesmeyenlerContent) {
      eslesmeyenlerContent.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">Eşleşmeyen tarif bulunamadı</div>';
    }
  }

  // Eşleşen kartları hafta verisine JSON uyumlu formatta kaydet
  hafta.tarifKartlar = eslesenKartlarListesi.map(e => ({
    tarifAdi: e.tarif,
    kartResmi: e.kart.name,
    kartData: e.kart.data || `https://mustafasacar35.github.io/lipodem-takip-paneli-4/tarifler/${e.kart.name}`,
    eslesmeTuru: e.tip
  }));
  
  // Eşleşmeyen tarifleri ayrı array'de sakla (JSON'a da kaydedilsin)
  const eslesenTarifIsimleri = eslesenKartlarListesi.map(e => e.tarif.toLowerCase());
  hafta.eslesmeyenTarifler = eslesmeyenTarifler; // JSON'a kaydet
  
  // Orijinal tarifler listesini koruyalım ama eşleşen/eşleşmeyen diye ayıralım
  hafta.eslesenTarifler = hafta.tarifler ? hafta.tarifler.filter(tarif => 
    eslesenTarifIsimleri.includes(tarif.toLowerCase())
  ) : [];
  
  console.log('📝 Eşleştirme öncesi toplam tarif:', hafta.tarifler ? hafta.tarifler.length : 0);
  console.log('📝 Eşleşen tarif isimleri:', eslesenTarifIsimleri);
  console.log('📝 Eşleşen tarif sayısı:', hafta.eslesenTarifler.length);
  console.log('🚫 Eşleşmeyen tarifler:', eslesmeyenTarifler.length, 'adet kaydedildi');
  
  // Otomatik kaydetme - hafta verileri değişti
  if (seciliHasta) {
    autoSaveHastaData(seciliHasta);
  } else {
    saveToStorage(); // Fallback
  }
  
  // Eşleştirme sonuçlarını döndür (JSON'a sadece eşleşenler kaydedilecek)
  const sonuc = {
    eslesenKartlar: hafta.tarifKartlar,
    eslesmeyenTarifler: eslesmeyenTarifler // UI için döndür ama JSON'a kaydetme
  };
  
  console.log('✅ otomatikEsleHafta tamamlandı:', {
    haftaIndex: i,
    eslesenKartSayisi: hafta.tarifKartlar ? hafta.tarifKartlar.length : 0,
    eslesmeyenTarifSayisi: eslesmeyenTarifler.length
  });
  
  // Eşleştirme sonrası yemek analizini güncelle
  setTimeout(() => {
    updateYemekAnalizi();
    
    // Fallback modu aktifse yeniden render etme - çakışmayı önle
    if (!window.fallbackHtmlProtection) {
      updateYemekVeritabaniAnalizi(); // Yeni: Food_list.json analizi (debounced)
    } else {
      console.log('🛡️ Fallback koruma: otomatikEsleHafta render atlandı');
    }
  }, 500); // Gecikmeyi artırdık - debounce ile birlikte daha stabil
  
  return sonuc;
}

// 🍽️ YEMEK VERİTABANI ANALİZİ FONKSİYONU
let updateYemekVeritabaniAnaliziTimeout = null; // Debounce mekanizması
let updateYemekVeritabaniAnaliziRunning = false; // Çakışma koruması

async function updateYemekVeritabaniAnalizi() {
  // PDF yükleme devam ediyorsa render işlemini engelle
  if (window.pdfYuklemeDevamEdiyor) {
    console.log('🚫 PDF yükleme devam ediyor, updateYemekVeritabaniAnalizi atlanıyor');
    return;
  }
  
  // Eğer zaten çalışıyor, yeni çağrıyı ertele
  if (updateYemekVeritabaniAnaliziRunning) {
    console.log('🔄 Render zaten devam ediyor, yeni çağrı ertelendi');
    
    // Eğer zaten bekleyen bir çağrı varsa, iptal et
    if (updateYemekVeritabaniAnaliziTimeout) {
      clearTimeout(updateYemekVeritabaniAnaliziTimeout);
    }
    
    // Mevcut render bittiğinde yeni bir render planla
    updateYemekVeritabaniAnaliziTimeout = setTimeout(() => {
      updateYemekVeritabaniAnaliziTimeout = null;
      updateYemekVeritabaniAnalizi(); // Rekursif çağrı
    }, 100);
    return;
  }

  // Eğer zaten bekleyen bir çağrı varsa, iptal et
  if (updateYemekVeritabaniAnaliziTimeout) {
    clearTimeout(updateYemekVeritabaniAnaliziTimeout);
    console.log('🔄 Önceki render çağrısı iptal edildi (çakışma önlendi)');
  }
  
  // Yeni çağrıyı kısa bir gecikmeyle planla
  updateYemekVeritabaniAnaliziTimeout = setTimeout(async () => {
    updateYemekVeritabaniAnaliziTimeout = null;
    updateYemekVeritabaniAnaliziRunning = true;
    try {
      await updateYemekVeritabaniAnaliziActual();
    } finally {
      updateYemekVeritabaniAnaliziRunning = false;
    }
  }, 50); // 50ms debounce
}

async function updateYemekVeritabaniAnaliziActual() {
  console.log('🍽️ Yemek veritabanı analizi başlatılıyor...', new Date().toLocaleTimeString());
  console.log('📊 Çağıran stack:', new Error().stack.split('\n').slice(1, 4));
  
  // Eğer daha önceki fallback koruma aktifse, deaktive et
  if (window.fallbackHtmlProtection) {
    console.log('⚠️ Önceki fallback koruma temizleniyor');
    window.fallbackHtmlProtection = false;
    
    // MutationObserver'ı da temizle
    if (window.htmlProtectionObserver) {
      window.htmlProtectionObserver.disconnect();
      window.htmlProtectionObserver = null;
      console.log('🔍 MutationObserver temizlendi');
    }
  }
  
  // Haftalık tekrarlanan yemekleri tespit etme fonksiyonu
  function tesbitEtHaftalikTekrarlar(eslesmeDurumu) {
    const yemekSayilari = new Map();
    const haftalikTekrarlar = new Map();
    
    // Sadece kurşun geçirmez kahve için haftalık gruplama
    const haftalikGruplanacaklar = [
      'kurşun geçirmez kahve',
      'kurşungeçirmez kahve',
      'kurşun geçirmez',
      'kurşungeçirmez'
    ];
    
    // Her yemeği say
    eslesmeDurumu.forEach(item => {
      if (item.gunOgunSatiri || item.karalistede) return;
      
      const yemekAdi = item.tarifAdi.toLowerCase();
      const sayim = yemekSayilari.get(yemekAdi) || 0;
      yemekSayilari.set(yemekAdi, sayim + 1);
    });
    
    // Sadece kurşun geçirmez kahve ve 5+ tekrarlananları haftalık grupla
    yemekSayilari.forEach((sayi, yemekAdi) => {
      if (sayi >= 5) {
        // Sadece kurşun geçirmez kahve için haftalık gruplama
        const kurşunKahveMi = haftalikGruplanacaklar.some(anahtar => 
          yemekAdi.includes(anahtar)
        );
        
        if (kurşunKahveMi) {
          haftalikTekrarlar.set(yemekAdi, {
            gunlukSayi: sayi,
            haftalikToplam: sayi,
            anahtarKelimeVar: true,
            ornekItem: eslesmeDurumu.find(item => 
              item.tarifAdi.toLowerCase() === yemekAdi && 
              !item.gunOgunSatiri && 
              !item.karalistede
            )
          });
        }
      }
    });
    
    return haftalikTekrarlar;
  }
  
  const veritabaniAnaliziContent = document.getElementById('veritabaniAnaliziContent');
  if (!veritabaniAnaliziContent) {
    console.log('⚠️ Veritabanı analizi container bulunamadı');
    return;
  }

  // Erken koruma: hasta/hafta seçilmeden analiz çağrılırsa sessizce çık
  const haftaListesi = getHaftaListesi();
  if (!seciliHasta || !haftaListesi || haftaListesi.length === 0) {
    veritabaniAnaliziContent.innerHTML = `
      <div style="text-align: center; color: #666; padding: 20px;">
        Henüz hasta/hafta seçilmedi
      </div>
    `;
    return;
  }

  const seciliHaftaIndex = getAktifHaftaIndex();
  const hafta = haftaListesi[seciliHaftaIndex];
  
  if (!hafta || !hafta.tarifler || hafta.tarifler.length === 0) {
    veritabaniAnaliziContent.innerHTML = `
      <div style="text-align: center; color: #666; padding: 20px;">
        Bu hafta için henüz tarif bulunamadı
      </div>
    `;
    return;
  }

  // Food_list.json'u getir (öncelik: lokal önbellek, aksi halde GitHub RAW)
  try {
    let foodData = null;
    if (window.lastSavedFoodData && typeof window.lastSavedFoodData === 'object') {
      console.log('🗂️ Lokal önbellekten food_list kullanılıyor');
      foodData = window.lastSavedFoodData;
    } else {
      // GitHub raw URL'sini kullan (CORS sorunları için)
      const response = await fetch(`https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli-4/refs/heads/main/food_list.json?nocache=${Date.now()}&t=${Math.random()}`);
      if (!response.ok) {
        throw new Error('Food_list.json dosyası yüklenemedi');
      }
      foodData = await response.json();
    }
    console.log('🕵️ DEBUG: GitHub RAW food_list.json yüklendi!');
    console.log('🕵️ DEBUG: İlk yemek örneği (GitHub RAW):', foodData.categories?.[0]?.items?.[0]);
    
    // Tüm yemek isimlerini çıkar - FULL DATA
    const allFoodNames = [];
    foodData.categories.forEach(category => {
      category.items.forEach(item => {
        allFoodNames.push({
          // Temel bilgiler
          name: item.name.toLowerCase(),
          originalName: item.name,
          category: item.category || category.name,
          
          // Besin değerleri
          calories: item.calories || 0,
          protein: item.protein || 0,
          carbs: item.carbs || 0,
          fat: item.fat || 0,
          
          // Tüm diğer alanları da ekle
          maxQuantity: item.maxQuantity || 1,
          minQuantity: item.minQuantity || 0.5,
          step: item.step || 0.5,
          tags: item.tags || [],
          role: item.role || 'mainDish',
          mealType: item.mealType || [],
          keto: item.keto || false,
          lowcarb: item.lowcarb || false,
          fillerLunch: item.fillerLunch || false,
          fillerDinner: item.fillerDinner || false,
          portionFixed: item.portionFixed || false,
          multiplier: item.multiplier || 1,
          seasonRange: item.seasonRange || '[1,12]',
          isReversedSeason: item.isReversedSeason || false,
          compatibilityTags: item.compatibilityTags || []
        });
      });
    });
    
    // Global flat listeyi hazırla (eşleştirme sekmesi için)
    try {
      if (typeof flattenFoodDataToGlobal === 'function') {
        flattenFoodDataToGlobal(foodData);
        console.log('✅ Global yemek listesi hazırlandı (flat):', window.globalFoodListFlat?.length || 0);
      }
    } catch (e) {
      console.warn('⚠️ Global flat liste hazırlanamadı:', e);
    }

    // PDF'deki yemekleri analiz et - HAFTA KAYNAKLARI İLE UYUMLU (eşleşen/esleşmeyen + başlıklar)
    const eslesmeDurumu = [];

    // Yardımcı: Türkçe karakter ve sembol normalize
    const normalizeTr = (str) => (str || '')
      .toString()
      .toLowerCase()
      .replace(/ç/g, 'c').replace(/ğ/g, 'g').replace(/ş/g, 's')
      .replace(/ü/g, 'u').replace(/ö/g, 'o').replace(/ı/g, 'i').replace(/i̇/g, 'i')
      .replace(/[_*\/()]/g, ' ')
      .replace(/\s+/g, ' ')
      .replace(/[^a-z0-9\s]/g, '')
      .trim();

    // Hızlı erişim için map/set hazırla
    const matchedTarifSet = new Set((hafta.eslesenTarifler || [])
      .map(t => t && t.toLowerCase()));

    // tarif -> kart mapping
    const tarifToKartMap = new Map();
    (hafta.tarifKartlar || []).forEach(k => {
      if (k && k.tarifAdi) {
        const key = k.tarifAdi.toLowerCase();
        if (!tarifToKartMap.has(key)) {
          tarifToKartMap.set(key, k);
        }
      }
    });

    // Food list araması için yardımcılar
    const findFoodMatch = (textCandidates = []) => {
      for (const cand of textCandidates) {
        const n = normalizeTr(cand);
        if (!n) continue;
        // 1) Tam eşleşme (normalize)
        const exact = allFoodNames.find(f => normalizeTr(f.originalName) === n || normalizeTr(f.name) === n);
        if (exact) return exact;
        // 2) İçeren eşleşme (daha serbest)
        const incl = allFoodNames.find(f => {
          const fn = normalizeTr(f.originalName);
          return fn.includes(n) || n.includes(fn);
        });
        if (incl) return incl;
      }
      return null;
    };

    // Daha güvenli: sadece TAM eşleşme yapan arama (kart eşleşmesi yoksa kullanılacak)
    const findFoodExactMatch = (text) => {
      const n = normalizeTr(text);
      if (!n) return null;
      return allFoodNames.find(f => normalizeTr(f.originalName) === n || normalizeTr(f.name) === n) || null;
    };

    // Birim/miktar kelimelerini ve sayıları filtreleyip token bazlı benzerlik skoru hesapla
    const unitStop = new Set([
      'adet','gr','gram','kg','yemek','kasigi','yk','tatli','cay','tk','ck',
      'yaprak','dal','orta','boy','kucuk','buyuk','olcek','fincan','bardak',
      'dilim','avuc','paket','tatli_kasigi','yemek_kasigi','cay_kasigi','yuzde',
      'yarim','ceyrek'
    ]);
    const stopFillers = new Set(['ve','veya','ile','artı','arti','plus','ya','vs','vb']);
    const tokenize = (text) => normalizeTr(text)
      .replace(/\d+/g, ' ') // sayıları kaldır
      .replace(/\b(ml|lt|cc|mg|mcg)\b/g, ' ')
      .split(/\s+/)
      .filter(t => t && t.length > 2 && !unitStop.has(t) && !stopFillers.has(t));

    const bestFoodFuzzyMatch = (rawText) => {
      if (!rawText) return null;
      // Parçaları üret
      const parts = String(rawText)
        .split(/\+|\,|\/|\(|\)|\-|\bile\b|\bve\b|\bveya\b/gi)
        .map(p => p.trim())
        .filter(Boolean);
      let best = null;
      let bestScore = 0;
      const consider = (segment) => {
        const segTokens = tokenize(segment);
        if (!segTokens.length) return;
        for (const f of allFoodNames) {
          const fTokens = tokenize(f.originalName || f.name);
          if (!fTokens.length) continue;
          // Kesişim skoru
          const setB = new Set(fTokens);
          let overlap = 0;
          let longHit = false;
          for (const t of segTokens) {
            if (setB.has(t)) {
              overlap++;
              if (t.length >= 4) longHit = true;
            }
          }
          // Kabul kriteri: en az 2 kelime eşleşmesi veya tek ama uzun kelime eşleşmesi
          const score = overlap + (longHit ? 0.5 : 0);
          if (overlap >= 2 || (overlap >= 1 && longHit)) {
            if (score > bestScore) { best = f; bestScore = score; }
          }
        }
      };
      if (!parts.length) parts.push(rawText);
      parts.forEach(consider);
      return best;
    };

  hafta.tarifler.forEach((tarif, index) => {
      const tarifLower = (tarif || '').toLowerCase();
      const tarifTemiz = tarifLower.trim();

      // Gün ve öğün isimlerini tespit et (yemek değil) - ENHANCED DETECTION
      const gunOgunFiltreleri = [
        // Günler - hem normal hem noktalı versiyonlar
        'pazartesi', 'pazartesi̇', 'sali', 'salı', 'çarşamba', 'carsamba', 
        'perşembe', 'persembe', 'cuma', 'cumartesi', 'cumartesi̇', 'pazar',
        // Öğünler
        'sabah', 'öğle', 'akşam', 'kahvaltı', 'öğlen', 'akşam yemeği',
        'ara öğün', 'ara_öğün', 'araöğün',
        // Zamanlar
        'saat 07:00', 'saat 12:00', 'hava kararınca', 'civarında',
        'tercihen saat', 'güne başlarken'
      ];
      const gunOgunMu = gunOgunFiltreleri.some(filtre =>
        tarifTemiz.includes(filtre.toLowerCase()) || tarifTemiz === filtre.toLowerCase()
      ) || /(öğle|akşam|kahvaltı|sabah|ara\s*öğün)/i.test(tarif);

    if (gunOgunMu) {
        eslesmeDurumu.push({
          tarifAdi: tarif,
      eslestiMi: false, // veritabanı eşleşmesi yok
      kartEslestiMi: false, // başlık satırı
          eslesenYemek: null,
          siraNo: index + 1,
          gunOgunSatiri: true
        });
        return; // başlık satırı
      }

      // Karaliste kontrolü (normalleştirilmiş)
      if (isBlacklisted(tarif)) {
        eslesmeDurumu.push({
          tarifAdi: tarif,
          eslestiMi: false,
          kartEslestiMi: false,
          eslesenYemek: null,
          siraNo: index + 1,
          gunOgunSatiri: false,
          karalistede: true
        });
        return;
      }

      // Bu satır, otomatik/manuel eşleşen tarifler arasında mı?
  const kartEslestiMi = matchedTarifSet.has(tarifLower);

      let eslesenYemek = null;
      if (kartEslestiMi) {
        // Öncelik: kart adından food_list eşleşmesi (daha güvenilir)
        const kart = tarifToKartMap.get(tarifLower);
        if (kart && (kart.kartResmi || kart.name)) {
          const kartBase = (kart.kartResmi || kart.name)
            .replace(/\.(jpg|jpeg|png)$/i, '')
            .replace(/_/g, ' ');
          eslesenYemek = findFoodMatch([kartBase, tarif]);
        } else {
          // Fallback: tarif satırından arama
          eslesenYemek = findFoodMatch([tarif]);
        }
      } else {
        // Kart eşleşmesi yoksa: önce TAM eşleşme, olmazsa bulanık (token tabanlı) eşleşme dene
        eslesenYemek = findFoodExactMatch(tarif) || bestFoodFuzzyMatch(tarif);
      }

      eslesmeDurumu.push({
        tarifAdi: tarif,
        eslestiMi: !!eslesenYemek, // veritabanı (food_list) eşleşmesi varsa makrolar gösterilir
        kartEslestiMi: !!kartEslestiMi, // kart (görsel) eşleşmesi varsa ikon yeşil
        eslesenYemek: eslesenYemek,
        siraNo: index + 1,
        gunOgunSatiri: false
      });
    });
    
  // Sonuçları görüntüle
  const normalSatirlar = eslesmeDurumu.filter(item => !item.gunOgunSatiri && !item.karalistede);
  // Bir satır yeşil tik ise ya kart ya da veritabanı eşleşmesi vardır
  const eslesenSayisi = normalSatirlar.filter(item => item.kartEslestiMi || item.eslestiMi).length;
  const eslesmeyenSayisi = normalSatirlar.length - eslesenSayisi;
    
    // Global değişkende sakla (buton tıklamaları için)
    window.currentFoodAnalysisData = eslesmeDurumu;
    
    // Haftalık tekrarlanan yemekleri tespit et ve grupla
    const haftalikTekrarlananlari = tesbitEtHaftalikTekrarlar(eslesmeDurumu);
    
    // Başlığı güncelle
    const veritabaniAnaliziBaslik = document.getElementById('veritabaniAnaliziBaslik');
    if (veritabaniAnaliziBaslik) {
      veritabaniAnaliziBaslik.textContent = `🍽️ Yemek Veritabanı Analizi (${eslesenSayisi}/${normalSatirlar.length})`;
    }
    
    // İçeriği oluştur - Makro değerleri ile tablo formatı
    
    // İçeriği oluştur - Makro değerleri ile tablo formatı
    let htmlContent = `
      <div style="margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
          <strong>📊 Özet:</strong>
          <div>
            <span style="color: #28a745; font-weight: bold;">✓ ${eslesenSayisi}</span> / 
            <span style="color: #dc3545; font-weight: bold;">✗ ${eslesmeyenSayisi}</span> / 
            <span style="font-weight: bold;">Toplam ${normalSatirlar.length} yemek</span>
          </div>
        </div>
        <div style="font-size: 12px; color: #666;">
          Toplam ${normalSatirlar.length} yemek analiz edildi
        </div>
      </div>
      
      <!-- Makro Değerleri Tablosu -->
      <div style="overflow-x: auto; margin-bottom: 15px; background: white; border-radius: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
  <table style="width: 100%; border-collapse: separate; border-spacing: 0; table-layout: auto; font-size: 11px; background: white;">
          <colgroup>
            <col style="width: auto;">
            <col style="width: 64px;">
            <col style="width: 64px;">
            <col style="width: 64px;">
            <col style="width: 64px;">
            <col style="width: auto;">
          </colgroup>
          ${(() => {
            // Hasta ismi ve tarih bilgisini bul (genellikle ilk satırda)
            let hastaBaslikSatiri = '';
            if (normalSatirlar.length > 0) {
              const ilkSatir = normalSatirlar[0];
              // Eğer ilk satır yemek değilse (❌ ile başlayıp - - - - değerleri varsa), hasta bilgisi olabilir
              if (!ilkSatir.eslestiMi && ilkSatir.tarifAdi && 
                  !ilkSatir.tarifAdi.includes('🍽️') && 
                  !ilkSatir.tarifAdi.includes('📅')) {
                
                // Hasta ismi ve tarih içeren satırı beyaz arkaplan ile göster
                const hastaBilgisi = ilkSatir.tarifAdi;
                
                // İsim ve tarihi ayır (/ işareti varsa)
                const parts = hastaBilgisi.split('/');
                let isimKismi = hastaBilgisi.trim().toUpperCase(); // Tüm metni büyük harfe çevir
                let tarihKismi = '';
                
                if (parts.length >= 2) {
                  isimKismi = parts[0].trim().toUpperCase();
                  tarihKismi = parts.slice(1).join('/').trim().toUpperCase();
                }
                
                hastaBaslikSatiri = `
                  <thead>
                    <tr style="background: white; border: 2px solid #007bff;">
                      <td colspan="6" style="padding: 15px 20px; border: 1px solid #ddd; font-size: 14px; font-weight: bold;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                          <span style="color: #007bff; font-size: 16px;">📋 ${isimKismi}</span>
                          <span style="color: #666; font-size: 14px;">${tarihKismi}</span>
                        </div>
                      </td>
                    </tr>
                  </thead>
                `;
              }
            }
            return hastaBaslikSatiri;
          })()}
          <thead>
            <tr style="background: linear-gradient(135deg, #007bff, #0056b3); color: white;">
              <th style="padding: 6px 8px; text-align: left; border: 1px solid #ddd; font-size: 12px;">Yemek Adı</th>
              <th style="padding: 6px; text-align: center; border: 1px solid #ddd; width: 64px; font-size: 11px;">Kalori</th>
              <th style="padding: 6px; text-align: center; border: 1px solid #ddd; width: 64px; font-size: 11px;">Karb</th>
              <th style="padding: 6px; text-align: center; border: 1px solid #ddd; width: 64px; font-size: 11px;">Protein</th>
              <th style="padding: 6px; text-align: center; border: 1px solid #ddd; width: 64px; font-size: 11px;">Yağ</th>
              <th style="padding: 6px; text-align: center; border: 1px solid #ddd; white-space: nowrap; font-size: 11px; width: auto;" title="İşlemler">⚙️</th>
            </tr>
          </thead>
          <tbody>
    `;
    
    let toplamKalori = 0;
    let toplamProtein = 0;
    let toplamKarb = 0;
    let toplamYag = 0;
    
    // Gün/öğün makro toplamlarını hesaplamak için yardımcı değişkenler
    let gunOgunMakroToplam = new Map(); // key: gün/öğün adı, value: {kalori, protein, karb, yag}
    let currentGun = '';
    let currentOgun = '';
    
    // Önceki render'dan gün bilgilerini koru (eğer varsa)
    if (window.lastDetectedGuns && window.lastDetectedGuns.size > 0) {
      console.log('🔄 Önceki render\'dan gün bilgileri geri yükleniyor:', Array.from(window.lastDetectedGuns.keys()));
      gunOgunMakroToplam = new Map(window.lastDetectedGuns);
    }
    
    // İlk geçiş: gün/öğün makro toplamlarını hesapla
  eslesmeDurumu.forEach((item, index) => {
      if (item.karalistede) return;
      
      // Gün/öğün satırı kontrolü - hem gunOgunSatiri hem de manuel tespit
      const gunlerList = ['pazartesi', 'sali', 'çarşamba', 'perşembe', 'cuma', 'cumartesi', 'pazar'];
      const tarifAdiLower = item.tarifAdi.toLowerCase();
      const isManuelGun = gunlerList.some(gun => tarifAdiLower.includes(gun));
      const isManuelOgun = /(öğle|akşam|kahvaltı|sabah|ara\s*öğün)/i.test(item.tarifAdi);
      
  if (item.gunOgunSatiri || isManuelGun || isManuelOgun) {
        if (isManuelGun || (item.gunOgunSatiri && gunlerList.some(gun => tarifAdiLower.includes(gun)))) {
          // Gün satırı
          currentGun = item.tarifAdi.toUpperCase();
          currentOgun = '';
          if (!gunOgunMakroToplam.has(currentGun)) {
            gunOgunMakroToplam.set(currentGun, {kalori: 0, protein: 0, karb: 0, yag: 0});
          }
          console.log('🗓️ Gün tespit edildi:', currentGun, '(manuel:', isManuelGun, ', gunOgunSatiri:', !!item.gunOgunSatiri, ')');
        } else {
          // Öğün satırı
          currentOgun = item.tarifAdi;
          const ogunKey = `${currentGun}_${currentOgun}`;
          if (!gunOgunMakroToplam.has(ogunKey)) {
            gunOgunMakroToplam.set(ogunKey, {kalori: 0, protein: 0, karb: 0, yag: 0});
          }
          console.log('🍽️ Öğün tespit edildi:', currentOgun, '(manuel:', isManuelOgun, ', gunOgunSatiri:', !!item.gunOgunSatiri, ')');
        }
  } else if (item.eslestiMi && item.eslesenYemek) {
        // Normal yemek satırı - mevcut gün/öğüne ekle
        const kalori = item.eslesenYemek.calories || 0;
        const protein = item.eslesenYemek.protein || 0;
        const karb = item.eslesenYemek.carbs || 0;
        const yag = item.eslesenYemek.fat || 0;
        
        if (currentGun) {
          const gunToplam = gunOgunMakroToplam.get(currentGun);
          gunToplam.kalori += kalori;
          gunToplam.protein += protein;
          gunToplam.karb += karb;
          gunToplam.yag += yag;
        }
        
        if (currentOgun) {
          const ogunKey = `${currentGun}_${currentOgun}`;
          const ogunToplam = gunOgunMakroToplam.get(ogunKey);
          if (ogunToplam) {
            ogunToplam.kalori += kalori;
            ogunToplam.protein += protein;
            ogunToplam.karb += karb;
            ogunToplam.yag += yag;
          }
        }
      }
    });
    
    // İkinci geçiş: tabloyu oluştur
    currentGun = '';
    currentOgun = '';
    const processedWeeklyItems = new Set(); // Haftalık grupladığımız öğeleri takip et
    
  eslesmeDurumu.forEach((item, index) => {
      // Karalistede olan satırları tabloda hiç göstermeyelim
  if (item.karalistede) return;

  // "Her sabah güne" ve benzer öğün açıklamalarını gizle - gereksiz metinler
  if (item.satir && item.satir.toLowerCase().includes('her sabah güne')) {
    console.log('🚫 "Her sabah güne" içeren satır gizlendi:', item.satir);
    return;
  }
  
  // Diğer yaygın öğün açıklamalarını da gizle
  const ogunAciklamalari = [
    'her sabah güne',
    'tercihen saat',
    'hava kararınca',
    'öğle civarında',
    'akşam saatlerinde'
  ];
  
  if (item.satir) {
    const satirLower = item.satir.toLowerCase();
    for (const aciklama of ogunAciklamalari) {
      if (satirLower.includes(aciklama)) {
        console.log(`🚫 Öğün açıklaması gizlendi (${aciklama}):`, item.satir);
        return;
      }
    }
  }

  // Öğün bilgilerinin downstream kullanımına yardımcı olacak etiketler
  item.belongToGun = currentGun;
  item.belongToOgun = currentOgun;
      
      // İlk satır hasta bilgisi ise ve yukarıda başlık olarak gösterildiyse atla
      if (index === 0 && !item.eslestiMi && item.tarifAdi && 
          !item.tarifAdi.includes('🍽️') && 
          !item.tarifAdi.includes('📅')) {
        return; // Bu satırı tabloda gösterme, zaten başlıkta var
      }
      
      // Haftalık tekrarlanan yemek kontrol et
      const yemekAdiLower = item.tarifAdi.toLowerCase();
      const haftalikBilgi = haftalikTekrarlananlari.get(yemekAdiLower);
      
      // Eğer bu yemek haftalık gruplanacaksa ve daha önce işlenmemişse
      if (haftalikBilgi && !processedWeeklyItems.has(yemekAdiLower)) {
        processedWeeklyItems.add(yemekAdiLower);
        
        // Haftalık gruplama - "x7 gün" formatında göster
        const ornekItem = haftalikBilgi.ornekItem;
        const gunlukSayi = haftalikBilgi.gunlukSayi;
        
        let kalori = 0, protein = 0, karb = 0, yag = 0;
        
        if (ornekItem.eslestiMi && ornekItem.eslesenYemek) {
          // Haftalık toplam makrolar (günlük x haftalık sayi)
          kalori = (ornekItem.eslesenYemek.calories || 0) * gunlukSayi;
          protein = (ornekItem.eslesenYemek.protein || 0) * gunlukSayi;
          karb = (ornekItem.eslesenYemek.carbs || 0) * gunlukSayi;
          yag = (ornekItem.eslesenYemek.fat || 0) * gunlukSayi;
          
          // Toplam makrolara ekle
          toplamKalori += kalori;
          toplamProtein += protein;
          toplamKarb += karb;
          toplamYag += yag;
        }
        
        // İkon ve renk
        const ikon = ornekItem.kartEslestiMi ? '✅' : (ornekItem.eslestiMi ? '✅' : '❌');
        const renk = (ornekItem.kartEslestiMi || ornekItem.eslestiMi) ? '#28a745' : '#dc3545';
        
        // Haftalık gruplama satırı
        htmlContent += `
          <tr style="cursor: pointer; transition: background 0.2s; background: #fff8dc;" 
              onmouseover="this.style.background='#fff5cd'" onmouseout="this.style.background='#fff8dc'"
              title="Haftalık Gruplama: ${gunlukSayi} kez tekrarlandı">
            <td style="padding: 4px 6px; border: 1px solid #ddd; text-align: left;">
              <span style="color: ${renk}; margin-right: 6px; font-size: 14px;">${ikon}</span>
              <span style="font-weight: bold; color: #8b5a2b;">
                🔄 ${ornekItem.tarifAdi} (x${gunlukSayi} gün)
              </span>
            </td>
            <td style="padding: 4px; text-align: center; border: 1px solid #ddd; font-weight: bold; color: #8b5a2b;">
              ${ornekItem.eslestiMi ? kalori.toFixed(0) : '-'}
            </td>
            <td style="padding: 4px; text-align: center; border: 1px solid #ddd; font-weight: bold; color: #8b5a2b;">
              ${ornekItem.eslestiMi ? karb.toFixed(1) : '-'}
            </td>
            <td style="padding: 4px; text-align: center; border: 1px solid #ddd; font-weight: bold; color: #8b5a2b;">
              ${ornekItem.eslestiMi ? protein.toFixed(1) : '-'}
            </td>
            <td style="padding: 4px; text-align: center; border: 1px solid #ddd; font-weight: bold; color: #8b5a2b;">
              ${ornekItem.eslestiMi ? yag.toFixed(1) : '-'}
            </td>
            <td style="padding: 4px; text-align: center; border: 1px solid #ddd; color: #8b5a2b;">
              📊 Haftalık
            </td>
          </tr>
        `;
        
        return; // Bu yemeği tekil olarak gösterme
      }
      
      // Eğer bu yemek haftalık gruplanmışsa ve daha önce işlendiyse atla
      if (haftalikBilgi && processedWeeklyItems.has(yemekAdiLower)) {
        return;
      }
      
      // İkon ve renk: Kart veya veritabanı eşleşmesi varsa yeşil göster
      const ikon = item.kartEslestiMi ? '✅' : (item.eslestiMi ? '✅' : '❌');
      const renk = (item.kartEslestiMi || item.eslestiMi) ? '#28a745' : '#dc3545';
      
      let kalori = 0, protein = 0, karb = 0, yag = 0;
      
      if (item.eslestiMi && item.eslesenYemek) {
        kalori = item.eslesenYemek.calories || 0;
        protein = item.eslesenYemek.protein || 0;
        karb = item.eslesenYemek.carbs || 0;
        yag = item.eslesenYemek.fat || 0;
        
        toplamKalori += kalori;
        toplamProtein += protein;
        toplamKarb += karb;
        toplamYag += yag;
      }
      
      // Gün/öğün satırları için özel stil - İLK GEÇİŞLE UYUMLU MANUEL DETECTION
      const gunlerList = ['pazartesi', 'pazartesi̇', 'sali', 'salı', 'çarşamba', 'carsamba', 'perşembe', 'persembe', 'cuma', 'cumartesi', 'cumartesi̇', 'pazar'];
      const gunlerListEng = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
      const tarifAdiLower = item.tarifAdi.toLowerCase();
      const isManuelGun = gunlerList.some(gun => tarifAdiLower.includes(gun));
      const isManuelOgun = /(öğle|akşam|kahvaltı|sabah|ara\s*öğün)/i.test(item.tarifAdi);
      
      if (item.gunOgunSatiri || isManuelGun || isManuelOgun) {
        // Günler için özel stil (BÜYÜK HARF)
        const isGunTr = gunlerList.some(gun => tarifAdiLower.includes(gun));
        const isGunEng = gunlerListEng.some(gun => tarifAdiLower.includes(gun));
        
        // Daha esnek gün algılama - rakamla gün formatları için
        const isGunNumber = /\b(\d+\.?\s*(gün|gun|day)|gün\s*\d+|day\s*\d+)\b/i.test(tarifAdiLower);
        
        const isGun = isGunTr || isGunEng || isGunNumber || isManuelGun;
        
        console.log('🔍 Gün kontrol ediliyor (render):', item.tarifAdi, 'isGun:', isGun, 'TR:', isGunTr, 'ENG:', isGunEng, 'NUM:', isGunNumber, 'Manuel:', isManuelGun);
        console.log('🆔 DEBUG RENDER - gunOgunSatiri:', !!item.gunOgunSatiri, 'isManuelGun:', isManuelGun, 'isManuelOgun:', isManuelOgun);
        
        if (isGun) {
          currentGun = item.tarifAdi.toUpperCase();
          currentOgun = '';
          window.lastKnownGun = currentGun; // Scope koruma için kaydet
          console.log('✅ Gün bulundu ve set edildi (RENDER):', currentGun);
          const gunToplam = gunOgunMakroToplam.get(currentGun) || {kalori: 0, protein: 0, karb: 0, yag: 0};
          
          const gunHtmlSatir = `
            <tr style="background: linear-gradient(135deg, #007bff, #0056b3); color: white; cursor: default;" 
                title="Gün başlığı - Günlük Toplam: ${gunToplam.kalori.toFixed(0)} kcal">
              <td style="padding: 8px; border: 1px solid #ddd; text-align: left; font-weight: bold; font-size: 14px; text-transform: uppercase; letter-spacing: 1px;">
                📅 ${currentGun}
              </td>
              <td style="padding: 8px; border: 1px solid #ddd; text-align: center; font-weight: bold; font-size: 12px;">
                ${gunToplam.kalori > 0 ? gunToplam.kalori.toFixed(0) : '-'}
              </td>
              <td style="padding: 8px; border: 1px solid #ddd; text-align: center; font-weight: bold; font-size: 12px;">
                ${gunToplam.karb > 0 ? gunToplam.karb.toFixed(1) : '-'}
              </td>
              <td style="padding: 8px; border: 1px solid #ddd; text-align: center; font-weight: bold; font-size: 12px;">
                ${gunToplam.protein > 0 ? gunToplam.protein.toFixed(1) : '-'}
              </td>
              <td style="padding: 8px; border: 1px solid #ddd; text-align: center; font-weight: bold; font-size: 12px;">
                ${gunToplam.yag > 0 ? gunToplam.yag.toFixed(1) : '-'}
              </td>
              <td style="padding: 8px; border: 1px solid #ddd; text-align: center; font-size: 10px; color: rgba(255,255,255,0.7);">📊</td>
            </tr>
          `;
          
          console.log('🎯 DEBUG - Gün HTML satırı ekleniyor:', gunHtmlSatir.substring(0, 100) + '...');
          // GÜN satırı - Sol hizalı, sağda günlük makro toplamları
          htmlContent += gunHtmlSatir;
        } else {
          currentOgun = item.tarifAdi;
          console.log('🍽️ Öğün bulundu ve set edildi:', currentOgun, 'currentGun:', currentGun);
          
          // currentGun boşsa fallback gün kullan - scope'un en başında tanımla
          const safeCurrentGun = currentGun || window.lastKnownGun || 'VARSAYILAN GÜN';
          console.log('🔄 Güvenli gün değeri tanımlandı:', safeCurrentGun, '(orijinal:', currentGun, ')');
          
          const ogunKey = `${currentGun}_${currentOgun}`;
          const ogunToplam = gunOgunMakroToplam.get(ogunKey) || {kalori: 0, protein: 0, karb: 0, yag: 0};
          
          // Sabah rutini kontrolü - bu tür öğünlerde kaydet butonu gösterme
          const isSabahRutini = item.tarifAdi.toLowerCase().includes('her sabah') || 
                                item.tarifAdi.toLowerCase().includes('güne başlarken') ||
                                item.tarifAdi.toLowerCase().includes('gune baslarken');
          
          // ÖĞÜN satırı - Sol hizalı, sağda öğün makro toplamları
          const ogunAdi = item.tarifAdi.charAt(0).toUpperCase() + item.tarifAdi.slice(1).toLowerCase();
          // Bu öğünde alternatif şablon uygulanmış mı? (hafif işaret)
          let altBadgeHtml = '';
          try {
            const haftalarState = (typeof getHaftaListesi === 'function') ? getHaftaListesi() : null;
            const aktifIndex = (typeof getAktifHaftaIndex === 'function') ? getAktifHaftaIndex() : 0;
            const haftaAct = Array.isArray(haftalarState) ? haftalarState[aktifIndex] : null;
            const key = `orig_meal_${normalizeGunAdi(currentGun)}_${normalizeOgunAdi(currentOgun)}`;
            const isAltApplied = !!(haftaAct && haftaAct._uygulananOgunSablonlari && haftaAct._uygulananOgunSablonlari[key]);
            if (isAltApplied) {
              altBadgeHtml = `<span style="margin-left:8px; font-size:10px; color:#0d47a1; background:#bbdefb; padding:2px 6px; border-radius:8px;">🔄 Alt</span>`;
            }
          } catch {}

          // Öğün işlem butonlarını hazırla (Kaydet + Ekle + Alternatifler)
          // Alternatif butonları tüm öğünlerde göster
          console.log('🔄 Butonlar render ediliyor - currentGun:', currentGun, 'currentOgun:', currentOgun);
          
          // Gün veya öğün boşsa butonları disable et  
          const hasValidParams = (currentGun || safeCurrentGun) && safeCurrentGun.trim() && currentOgun && currentOgun.trim();
          console.log('🔄 Geçerli parametreler var mı?', hasValidParams, 'currentGun:', currentGun, 'safeCurrentGun:', safeCurrentGun, 'currentOgun:', currentOgun);
          
          const altBtns = hasValidParams ? `
                  <button onclick="showSimilarityMealAlternativeModal('${encodeURIComponent(safeCurrentGun)}', '${encodeURIComponent(currentOgun)}')" 
                          style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px; cursor: pointer; margin-left: 4px;" 
                          title="🔄 Benzerlik tabanlı: Makro benzerliğine göre alternatif öğün şablonlarını modal ile göster">
                    🔄 Alt
                  </button>
                  <button onclick="applyBestSimilarityMealAlternative('${encodeURIComponent(safeCurrentGun)}', '${encodeURIComponent(currentOgun)}')" 
                          style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px; cursor: pointer; margin-left: 4px;" 
                          title="🔄⚡ Benzerlik tabanlı: En benzer makrolu şablonu doğrudan uygula (modal açmadan)">
                    ⚡ En İyi
                  </button>
                  <button onclick="showTargetMealAlternatives('${encodeURIComponent(safeCurrentGun)}', '${encodeURIComponent(currentOgun)}')" 
                          style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px; cursor: pointer; margin-left: 4px;" 
                          title="🎯 Hedef kalori tabanlı: Delta hesabıyla hedef kaloriye göre alternatif şablonları modal ile göster">
                    🎯 Hedef
                  </button>
                  <button onclick="applyBestTargetMealAlternative('${encodeURIComponent(safeCurrentGun)}', '${encodeURIComponent(currentOgun)}')" 
                          style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px; cursor: pointer; margin-left: 4px;" 
                          title="🎯⚡ Hedef kalori tabanlı: Hedef kaloriye en yakın şablonu doğrudan uygula (modal açmadan)">
                    🎯⚡ Hızlı
                  </button>
                  <button onclick="revertMealToOriginal('${encodeURIComponent(safeCurrentGun)}', '${encodeURIComponent(currentOgun)}')" 
                          style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px; cursor: pointer; margin-left: 4px;" 
                          title="Orijinal öğüne geri dön">
                    ↩ Orij
                  </button>
                ` : `
                  <span style="color: #ffcccc; font-size: 10px; margin-left: 4px;">
                    (Gün/öğün bulunamadı - butonlar devre dışı: gün='${currentGun}', öğün='${currentOgun}')
                  </span>
                `;
          let ogunActionButtonsHtml = '';
    // Ekle butonu (öğüne yeni satır ekle)
    const addBtnHtml = `
      <button onclick="openAddRowToMeal('${encodeURIComponent(safeCurrentGun)}', '${encodeURIComponent(currentOgun)}')" 
        style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px; cursor: pointer; margin-left: 4px;" 
        title="Bu öğüne yeni yemek satırı ekle">
        ➕ Ekle
      </button>`;

    if (!isSabahRutini) {
            // Kaydet butonu (kopya şablon kontrolü ile) — Sabah Rutini hariç
            let kaydetBtnHtml = '';
            try {
              const ogunTipi = currentOgun;
              // Modal ile aynı: gün/öğün sınırlarını structure üzerinden al ve o aralıktaki yemekleri topla
              let ogunFoods = [];
              try {
                const structure = (typeof buildWeekStructureFromAnalysis === 'function') 
                  ? buildWeekStructureFromAnalysis(window.currentFoodAnalysisData || [])
                  : null;
                const targetDay = structure ? structure.find(d => d.normalized === normalizeGunAdi(safeCurrentGun)) : null;
                const targetMeal = targetDay ? targetDay.meals.find(m => m.normalizedMeal === normalizeOgunAdi(currentOgun)) : null;
                if (targetMeal) {
                  const start = Math.max(0, targetMeal.start || (targetMeal.headerIndex + 1));
                  const end = Math.min((window.currentFoodAnalysisData || []).length, targetMeal.end || start);
                  for (let i = start; i < end; i++) {
                    const row = (window.currentFoodAnalysisData || [])[i];
                    if (row && row.eslestiMi && row.eslesenYemek) {
                      ogunFoods.push({ foodName: row.eslesenYemek.originalName || row.eslesenYemek.name, originalText: row.tarifAdi || row.text });
                    }
                  }
                }
                // Yedek: eğer structure bulunamazsa eski yönteme geri dön
                if (!ogunFoods.length) {
                  ogunFoods = (window.currentFoodAnalysisData || [])
                    .filter(r => r && !r.gunOgunSatiri && !r.karalistede && r.belongToGun === currentGun && r.belongToOgun === currentOgun && r.eslestiMi && r.eslesenYemek)
                    .map(r => ({ foodName: r.eslesenYemek.originalName || r.eslesenYemek.name, originalText: r.tarifAdi || r.text }));
                }
              } catch {
                ogunFoods = (window.currentFoodAnalysisData || [])
                  .filter(r => r && !r.gunOgunSatiri && !r.karalistede && r.belongToGun === currentGun && r.belongToOgun === currentOgun && r.eslestiMi && r.eslesenYemek)
                  .map(r => ({ foodName: r.eslesenYemek.originalName || r.eslesenYemek.name, originalText: r.tarifAdi || r.text }));
              }
              // Türkçe karakterleri sadeleştirerek normalize et (modal ile aynı mantık)
              const norm = (txt) => {
                if (typeof normalizeTrSimple === 'function') return normalizeTrSimple(txt);
                return String(txt || '')
                  .toLowerCase()
                  .replace(/i̇/g, 'i')
                  .replace(/ı/g, 'i')
                  .replace(/ğ/g, 'g')
                  .replace(/ü/g, 'u')
                  .replace(/ş/g, 's')
                  .replace(/ö/g, 'o')
                  .replace(/ç/g, 'c')
                  .replace(/[^a-z0-9\s]/g, ' ')
                  .replace(/\s+/g, ' ')
                  .trim();
              };
              const foodsSig = ogunFoods.map(f => norm(f.foodName || f.originalText)).filter(Boolean).sort().join('||');
              const hedefType = norm(normalizeOgunAdi(ogunTipi));
              let matched = null;
              if (Array.isArray(mevcutSablonlar)) {
                for (const s of mevcutSablonlar) {
                  if (!s || !s.type) continue;
                  const tip = norm(normalizeOgunAdi(s.type));
                  if (tip !== hedefType) continue;
                  const sSig = (s.foods||[]).map(ff => norm(ff.foodName || ff.name || ff.originalText)).filter(Boolean).sort().join('||');
                  if (sSig === foodsSig) { matched = s; break; }
                }
              }
              if (matched) {
                // Minimal rozet: çok yer kaplamadan kaydedildi bilgisini göster
                kaydetBtnHtml = `
                  <span
                    style="display:inline-flex; align-items:center; justify-content:center; height:16px; min-width:16px; padding:0 4px; background:#0d6efd; border:1px solid #0a58ca; color:#fff; border-radius:10px; font-size:10px; line-height:16px; cursor: default;"
                    title="Zaten arşivde: ${matched.displayName || matched.name}"
                  >✓</span>`;
              } else {
                kaydetBtnHtml = `
                  <button onclick="kaydetOgunSablonu('${safeCurrentGun}', '${currentOgun}')" 
                          style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px; cursor: pointer;" 
                          title="Bu öğünü şablon olarak kaydet">
                    💾 Kaydet
                  </button>`;
              }
            } catch {
              kaydetBtnHtml = `
                  <button onclick="kaydetOgunSablonu('${safeCurrentGun}', '${currentOgun}')" 
                          style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px; cursor: pointer;" 
                          title="Bu öğünü şablon olarak kaydet">
                    💾 Kaydet
                  </button>`;
            }
            ogunActionButtonsHtml = kaydetBtnHtml + addBtnHtml + altBtns;
          } else {
            // Sabah rutini: Kaydet gösterme, sadece alternatif butonları + ufak Rutin etiketi
            ogunActionButtonsHtml = `
              <span style="color: rgba(255,255,255,0.6); font-size: 9px; margin-right: 6px;">Rutin</span>
            ` + addBtnHtml + altBtns;
          }
          htmlContent += `
            <tr style="background: linear-gradient(135deg, #28a745, #20c997); color: white; cursor: default;" 
                title="Öğün başlığı - Öğün Toplam: ${ogunToplam.kalori.toFixed(0)} kcal">
              <td style="padding: 6px; border: 1px solid #ddd; text-align: left; font-weight: bold; font-size: 12px;">
                <div style="display:flex; align-items:center; justify-content:space-between; gap:8px;">
                  <div style="min-width:0; flex:1 1 auto; overflow:hidden; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical;">
                    🍽️ ${ogunAdi} ${altBadgeHtml}
                  </div>
                  <div style="flex:0 1 auto; display:flex; flex-wrap:wrap; gap:4px; align-items:center; justify-content:flex-end; max-width:50%; min-width:0;">
                    ${ogunActionButtonsHtml}
                  </div>
                </div>
              </td>
              <td style="padding: 6px; border: 1px solid #ddd; text-align: center; font-weight: bold; font-size: 11px;">
                ${ogunToplam.kalori > 0 ? ogunToplam.kalori.toFixed(0) : '-'}
              </td>
              <td style="padding: 6px; border: 1px solid #ddd; text-align: center; font-weight: bold; font-size: 11px;">
                ${ogunToplam.karb > 0 ? ogunToplam.karb.toFixed(1) : '-'}
              </td>
              <td style="padding: 6px; border: 1px solid #ddd; text-align: center; font-weight: bold; font-size: 11px;">
                ${ogunToplam.protein > 0 ? ogunToplam.protein.toFixed(1) : '-'}
              </td>
              <td style="padding: 6px; border: 1px solid #ddd; text-align: center; font-weight: bold; font-size: 11px;">
                ${ogunToplam.yag > 0 ? ogunToplam.yag.toFixed(1) : '-'}
              </td>
              <td style="padding: 6px; border: 1px solid #ddd; text-align: center; font-size: 9px; color: rgba(255,255,255,0.7);"></td>
            </tr>
          `;
        }
        return; // Gün/öğün satırları için erken dön
      }
      
      // Butonları ayarla - Index kullan (sadece normal yemek satırları için)
  // ✂️ Bölme butonu: sadece normal yemek satırlarında görünsün
  const splitBtn = `<button onclick="event.stopPropagation(); openSplitModal(${index})" 
         style="background: #6f42c1; color: white; border: none; padding: 1px 4px; border-radius: 3px; font-size: 9px; margin-right: 2px; cursor: pointer;"
         title="Satırı Böl">✂️</button>`;

  const karalisteBtn = `<button onclick="event.stopPropagation(); toggleBlacklistForRow(${index})" 
    style="background: #343a40; color: white; border: none; padding: 1px 4px; border-radius: 3px; font-size: 9px; margin-right: 2px; cursor: pointer;"
    title="Karalisteye al/çıkar">🚫</button>`;

  const butonlar = item.eslestiMi ? 
  `<button onclick="event.stopPropagation(); showFoodDetailByIndex(${index})" 
     style="background: #ffc107; color: #212529; border: none; padding: 1px 4px; border-radius: 3px; font-size: 9px; margin-right: 2px; cursor: pointer;"
                 title="Düzenle">✏️</button>
         <button onclick="event.stopPropagation(); yemekSilByIndex(${index})" 
   style="background: #dc3545; color: white; border: none; padding: 1px 4px; border-radius: 3px; font-size: 9px; margin-right: 2px; cursor: pointer;"
         title="Sil">🗑️</button>
     <button onclick="event.stopPropagation(); smartHedefeGoreSec(${index})" 
   style="background: #007bff; color: white; border: none; padding: 1px 4px; border-radius: 3px; font-size: 9px; margin-right: 2px; cursor: pointer;"
     title="Hedefe göre en iyi alternatifi uygula">🎯</button>
         <button onclick="event.stopPropagation(); alternatifYemekAc(${index})" 
   style="background: #17a2b8; color: white; border: none; padding: 1px 4px; border-radius: 3px; font-size: 9px; margin-right: 2px; cursor: pointer;"
         title="Alternatif Yemekler">🔄</button>${karalisteBtn}${splitBtn}` :
  `<button onclick="event.stopPropagation(); showFoodDetailByIndex(${index})" 
     style="background: #28a745; color: white; border: none; padding: 1px 4px; border-radius: 3px; font-size: 9px; margin-right: 2px; cursor: pointer;"
                 title="Ekle">➕</button>
         <button onclick="event.stopPropagation(); eslestirmeModeAc(${index})" 
   style="background: #20c997; color: white; border: none; padding: 1px 4px; border-radius: 3px; font-size: 9px; margin-right: 2px; cursor: pointer;"
         title="Eşleştir">🔗</button>${karalisteBtn}${splitBtn}`;
      
      htmlContent += `
        <tr data-sira-no="${item.siraNo || index + 1}" onclick="showFoodDetailByIndex(${index})" style="cursor: pointer; transition: background 0.2s;" 
            onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='white'">
          <td style="padding: 4px 6px; border: 1px solid #ddd; text-align: left; display:flex; align-items:flex-start; gap:6px; min-width:0;">
            <span style="color: ${renk}; font-size: 14px; flex:0 0 auto;">${ikon}</span>
            <span style="font-weight: ${item.eslestiMi ? 'normal' : 'bold'}; color: ${item.eslestiMi ? '#333' : '#dc3545'}; flex:1 1 auto; min-width:0; overflow:hidden; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; line-clamp:2; word-break: break-word;">
              ${item.tarifAdi}
            </span>
          </td>
          <td style="padding: 4px; text-align: center; border: 1px solid #ddd; font-weight: bold;">
            ${item.eslestiMi ? kalori : '-'}
          </td>
          <td style="padding: 4px; text-align: center; border: 1px solid #ddd; font-weight: bold;">
            ${item.eslestiMi ? karb.toFixed(1) : '-'}
          </td>
          <td style="padding: 4px; text-align: center; border: 1px solid #ddd; font-weight: bold;">
            ${item.eslestiMi ? protein.toFixed(1) : '-'}
          </td>
          <td style="padding: 4px; text-align: center; border: 1px solid #ddd; font-weight: bold;">
            ${item.eslestiMi ? yag.toFixed(1) : '-'}
          </td>
          <td style="padding: 4px; text-align: right; border: 1px solid #ddd; white-space: nowrap; width:auto;">
            <div style="display:inline-flex; flex-wrap:nowrap; gap:4px; justify-content:flex-end; align-items:center; flex-shrink:0;">
              ${butonlar}
            </div>
          </td>
        </tr>
      `;
    });
    
    // 🔧 YENİ PDF FORMAT DESTEĞİ: Eğer hiç gün tespit edilmemişse fallback uygula
    const gunSayisi = Array.from(gunOgunMakroToplam.keys()).filter(key => !key.includes('_')).length;
    const toplamYemekSayisi = eslesmeDurumu.length;
    const eslesenYemekSayisi = eslesmeDurumu.filter(item => item.eslestiMi).length;
    
    console.log('📅 Tespit edilen gün sayısı:', gunSayisi, 'Gün listesi:', Array.from(gunOgunMakroToplam.keys()).filter(key => !key.includes('_')));
    console.log('📊 Toplam yemek:', toplamYemekSayisi, 'Eşleşen:', eslesenYemekSayisi);
    
    // Gün bilgilerini gelecek render'lar için sakla (eğer gün tespit edildiyse)
    if (gunSayisi > 0) {
      window.lastDetectedGuns = new Map(gunOgunMakroToplam);
      console.log('💾 Gün bilgileri gelecek render için saklandı:', gunSayisi, 'gün');
    } else if (window.lastDetectedGuns && window.lastDetectedGuns.size > 0) {
      console.log('🔄 Önceki gün bilgileri korunuyor:', Array.from(window.lastDetectedGuns.keys()).filter(key => !key.includes('_')).length, 'gün');
    }
    
    // Fallback sistemi sadece şu durumlarda çalışsın:
    // 1. Hiç gün tespit edilmemiş VE
    // 2. Önceki render'lardan da gün bilgisi yok VE  
    // 3. Toplam yemek sayısı az (örneğin 10'dan az) - bu yeni PDF formatının işareti
    const oncekiGunSayisi = window.lastDetectedGuns ? Array.from(window.lastDetectedGuns.keys()).filter(key => !key.includes('_')).length : 0;
    const fallbackGerekmeMi = (gunSayisi === 0 && oncekiGunSayisi === 0 && toplamYemekSayisi < 10);
    
    console.log('🔍 Fallback kontrolü:', { 
      gunSayisi, 
      oncekiGunSayisi, 
      toplamYemekSayisi, 
      fallbackGerekmeMi 
    });
    
    if (fallbackGerekmeMi) {
      console.log('⚠️ YENİ PDF FORMATI TESPİT EDİLDİ! Fallback uygula (Az yemek + 0 gün)');
      // Varsayılan gün ata
      const defaultGun = 'VARSAYILAN GÜN';
      window.lastKnownGun = defaultGun;
      console.log('✅ Fallback gün atandı:', defaultGun);
      
      // Yeni PDF formatı için başlık bilgisi ekle
      const fallbackBaslik = `
        <div style="margin-bottom: 10px; padding: 10px; background: linear-gradient(135deg, #e3f2fd, #bbdefb); border-radius: 5px; border-left: 4px solid #2196f3;">
          <div style="font-weight: bold; font-size: 14px; color: #1565c0;">📋 YENİ PDF FORMATI</div>
          <div style="font-size: 12px; color: #424242; margin-top: 4px;">
            📅 Tarih: ${new Date().toLocaleDateString('tr-TR')} • 🆔 Gün yapısı: Otomatik tespit
          </div>
        </div>
      `;
      
      // htmlContent'in başına bu başlığı ekle
      const ozet = htmlContent.indexOf('<div style="margin-bottom: 15px; padding: 10px; background: #f8f9fa;');
      if (ozet !== -1) {
        htmlContent = htmlContent.slice(0, ozet) + fallbackBaslik + htmlContent.slice(ozet);
        console.log('✅ Fallback başlık eklendi - HTML uzunluğu:', htmlContent.length);
      } else {
        console.log('⚠️ Özet div bulunamadı, fallback başlık eklenemedi');
      }
      
      // Tablo başlığından sonra varsayılan gün satırı ekle
      const tabloBasligi = htmlContent.indexOf('<thead');
      console.log('🔍 Tablo başlığı arama:', tabloBasligi !== -1 ? `BULUNDU (${tabloBasligi})` : 'BULUNAMADI');
      if (tabloBasligi !== -1) {
        const theadSonu = htmlContent.indexOf('</thead>', tabloBasligi) + 8;
        console.log('🔍 Thead sonu pozisyonu:', theadSonu);
        const defaultGunSatiri = `
          <tr style="background: linear-gradient(135deg, #007bff, #0056b3); color: white; cursor: default;" 
              title="Gün başlığı - Fallback modu">
            <td style="padding: 8px; border: 1px solid #ddd; text-align: left; font-weight: bold; font-size: 14px; text-transform: uppercase; letter-spacing: 1px;">
              📅 ${defaultGun}
            </td>
            <td style="padding: 8px; border: 1px solid #ddd; text-align: center; font-weight: bold; font-size: 12px;">-</td>
            <td style="padding: 8px; border: 1px solid #ddd; text-align: center; font-weight: bold; font-size: 12px;">-</td>
            <td style="padding: 8px; border: 1px solid #ddd; text-align: center; font-weight: bold; font-size: 12px;">-</td>
            <td style="padding: 8px; border: 1px solid #ddd; text-align: center; font-weight: bold; font-size: 12px;">-</td>
            <td style="padding: 8px; border: 1px solid #ddd; text-align: center; font-size: 10px; color: rgba(255,255,255,0.7);">📊</td>
          </tr>
        `;
        htmlContent = htmlContent.slice(0, theadSonu) + defaultGunSatiri + htmlContent.slice(theadSonu);
        console.log('✅ Fallback gün satırı eklendi - HTML uzunluğu:', htmlContent.length);
        console.log('📍 Eklenen gün satırı uzunluğu:', defaultGunSatiri.length);
      } else {
        console.log('⚠️ Tablo thead bulunamadı, fallback gün satırı eklenemedi');
        console.log('🔍 HTML içinde thead var mı?', htmlContent.includes('<thead') ? 'VAR' : 'YOK');
        console.log('🔍 HTML uzunluğu:', htmlContent.length);
      }
      
      // Fallback HTML koruması - DOM'a yazıldıktan sonra değişim takibi
      window.fallbackHtmlProtection = true;
      console.log('🛡️ Fallback HTML koruma modu aktif');
    } else {
      // Normal PDF format - fallback korumasını kapat
      window.fallbackHtmlProtection = false;
      console.log('📄 Normal PDF formatı tespit edildi - fallback koruma kapalı');
    }
    
    // Günlük ortalama makrolar hesapla (haftalık toplam ÷ gün sayısı)
    const gercekGunSayisi = Math.max(gunSayisi, oncekiGunSayisi); // Önceki veya mevcut günleri kullan
    const gunlukOrtalamaKalori = gercekGunSayisi > 0 ? toplamKalori / gercekGunSayisi : 0;
    const gunlukOrtalamaProtein = gercekGunSayisi > 0 ? toplamProtein / gercekGunSayisi : 0;
    const gunlukOrtalamaKarb = gercekGunSayisi > 0 ? toplamKarb / gercekGunSayisi : 0;
    const gunlukOrtalamaYag = gercekGunSayisi > 0 ? toplamYag / gercekGunSayisi : 0;
    
    console.log('📊 Günlük ortalama hesaplama:', { 
      gercekGunSayisi, 
      gunlukOrtalamaKalori: Math.round(gunlukOrtalamaKalori) 
    });
    
    // Header rozetinde 'Ort' değerini güncelle (varsa)
    try {
      const ortBadge = document.getElementById('gercekKcalBadgeValue');
      if (ortBadge) {
        const ortNum = Math.round(Number(gunlukOrtalamaKalori));
        ortBadge.textContent = (isFinite(ortNum) && ortNum > 0) ? String(ortNum) : '—';
        
        // Aktif hafta için cache'le
        try {
          const aktif = getCurrentHasta();
          const haftaListesi = (typeof getHaftaListesi === 'function') ? getHaftaListesi() : [];
          const idx = (typeof getAktifHaftaIndex === 'function') ? getAktifHaftaIndex() : (haftaListesi.length ? haftaListesi.length - 1 : 0);
          const haftaNo = (haftaListesi?.[idx]?.haftaNo) || (idx + 1);
          
          if (aktif && isFinite(haftaNo) && isFinite(ortNum) && ortNum > 0) {
            if (!window.__weeklyRealizedAvg) window.__weeklyRealizedAvg = {};
            if (!window.__weeklyRealizedAvg[aktif.id]) window.__weeklyRealizedAvg[aktif.id] = {};
            window.__weeklyRealizedAvg[aktif.id][String(haftaNo)] = ortNum;
            
            // Haftanın objesine de yaz
            try {
              const h = haftaListesi.find(hh => hh.haftaNo === haftaNo);
              if (h) h.realizedAvgKcal = ortNum;
            } catch {}
            console.log('📊 PDF Render: Haftalık ort. kcal cache\'lendi:', { hastaId: aktif.id, hafta: haftaNo, ortKalori: ortNum });
          }
        } catch {}
        
        updateKcalDelta();
      }
    } catch {}

    htmlContent += `
          <tr style="background: linear-gradient(135deg, #28a745, #20c997); color: white; font-weight: bold;">
            <td style="padding: 6px; border: 1px solid #ddd; text-align: left; font-size: 12px;">
              <div style="display: flex; align-items: center; justify-content: space-between; gap: 8px;">
                <span>📊 GÜNLÜK ORTALAMA (${gunSayisi} gün)</span>
                <div style="display: flex; gap: 4px;">
                  <button onclick="gunIcindeDengele('satir')" 
                          style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px; cursor: pointer;" 
                          title="Satır bazlı: Her satırı hedefe göre optimize et">
                    🎯 Satır Dengele
                  </button>
                  <button onclick="gunIcindeDengele('ogun')" 
                          style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px; cursor: pointer;" 
                          title="Öğün bazlı: Öğün şablonlarından en uygununu uygula">
                    🍽️ Öğün Dengele
                  </button>
                </div>
              </div>
            </td>
            <td style="padding: 6px; text-align: center; border: 1px solid #ddd; font-size: 12px;">
              ${gunlukOrtalamaKalori.toFixed(0)}
            </td>
            <td style="padding: 6px; text-align: center; border: 1px solid #ddd; font-size: 12px;">
              ${gunlukOrtalamaKarb.toFixed(1)}
            </td>
            <td style="padding: 6px; text-align: center; border: 1px solid #ddd; font-size: 12px;">
              ${gunlukOrtalamaProtein.toFixed(1)}
            </td>
            <td style="padding: 6px; text-align: center; border: 1px solid #ddd; font-size: 12px;">
              ${gunlukOrtalamaYag.toFixed(1)}
            </td>
            <td style="padding: 6px; border: 1px solid #ddd;"></td>
          </tr>
        </tbody>
      </table>
    </div>`;
    console.log('📝 HTML DOM\'a yazılmadan HEMEN ÖNCE - uzunluk:', htmlContent.length);
    console.log('📝 HTML son 200 karakter:', htmlContent.slice(-200));
    
    // SAFER DOM WRITE - try textContent first, then innerHTML
    try {
      veritabaniAnaliziContent.innerHTML = htmlContent;
      console.log('📝 innerHTML BAŞARILI');
    } catch (error) {
      console.error('❌ innerHTML hatası:', error);
      veritabaniAnaliziContent.textContent = 'HTML render hatası: ' + error.message;
    }
    
    console.log('📝 DOM SET EDİLDİ - hemen sonra kontrol');
    
    // 🔍 HTML YAZILDI - DEBUGGING VE KORUMA SİSTEMİ
    console.log('📝 HTML DOM\'a yazıldı:', new Date().toLocaleTimeString());
    console.log('🔍 DEBUG - HTML Content gunler var mi?', htmlContent.includes('📅') ? 'VAR' : 'YOK');
    console.log('🔍 DEBUG - HTML uzunlugu:', htmlContent.length);
    
    // DOM'da günlerin gerçekten var olup olmadığını kontrol et
    setTimeout(() => {
      const domContent = veritabaniAnaliziContent.innerHTML;
      console.log('🎯 DEBUG - DOM\'da gunler var mi?', domContent.includes('📅') ? 'VAR' : 'YOK');
      console.log('🎯 DEBUG - DOM uzunlugu:', domContent.length);
      
      if (htmlContent.length !== domContent.length) {
        console.warn('⚠️ WARNING - HTML ve DOM uzunlukları farklı!', 'HTML:', htmlContent.length, 'DOM:', domContent.length);
        
        // Detaylı analiz: kaybolan kısım nerede?
        console.log('🔍 HTML\'de 📅 sayısı:', (htmlContent.match(/📅/g) || []).length);
        console.log('🔍 DOM\'da 📅 sayısı:', (domContent.match(/📅/g) || []).length);
        console.log('🔍 HTML\'de <tr sayısı:', (htmlContent.match(/<tr/g) || []).length);
        console.log('🔍 DOM\'da <tr sayısı:', (domContent.match(/<tr/g) || []).length);
        
        // İlk farklı karakteri bul
        let firstDiff = -1;
        for (let i = 0; i < Math.min(htmlContent.length, domContent.length); i++) {
          if (htmlContent[i] !== domContent[i]) {
            firstDiff = i;
            break;
          }
        }
        if (firstDiff >= 0) {
          console.log('🎯 İlk fark pozisyonu:', firstDiff);
          console.log('🎯 HTML o noktada:', htmlContent.slice(firstDiff, firstDiff + 100));
          console.log('🎯 DOM o noktada:', domContent.slice(firstDiff, firstDiff + 100));
        }
      }
    }, 100);
    
    // Fallback sistemi aktifse koruma modu
    if (window.fallbackHtmlProtection) {
      console.log('🛡️ Fallback koruma aktif - HTML değişim takibi başlatılıyor');
      
      // DOM'da fallback başlığının varlığını kontrol et - daha güvenilir selector'lar
      const fallbackBaslik = veritabaniAnaliziContent.querySelector('div') && 
                             veritabaniAnaliziContent.textContent.includes('YENİ PDF FORMATI');
      const fallbackGun = veritabaniAnaliziContent.querySelector('tr[title="Gün başlığı - Fallback modu"]');
      
      console.log('🔍 DOM kontrolü:', {
        fallbackBaslik: !!fallbackBaslik,
        fallbackGun: !!fallbackGun,
        toplamTr: veritabaniAnaliziContent.querySelectorAll('tr').length,
        textContent: veritabaniAnaliziContent.textContent.substring(0, 100) + '...'
      });
      
      // MutationObserver ile DOM değişimlerini takip et
      if (!window.htmlProtectionObserver) {
        window.htmlProtectionObserver = new MutationObserver((mutations) => {
          mutations.forEach((mutation) => {
            if (mutation.type === 'childList' && mutation.target === veritabaniAnaliziContent) {
              console.log('⚠️ DOM DEĞİŞİMİ TESPİT EDİLDİ!', {
                time: new Date().toLocaleTimeString(),
                addedNodes: mutation.addedNodes.length,
                removedNodes: mutation.removedNodes.length,
                fallbackModeActive: window.fallbackHtmlProtection
              });
              
              // Eğer fallback başlığı silindiyse alarm ver
              const currentBaslik = veritabaniAnaliziContent.textContent.includes('YENİ PDF FORMATI');
              if (!currentBaslik && window.fallbackHtmlProtection) {
                console.error('🚨 FALLBACK BAŞLIĞI SİLİNDİ! Bir başka kod HTML\'i yeniden yazıyor');
              }
            }
          });
        });
        
        window.htmlProtectionObserver.observe(veritabaniAnaliziContent, {
          childList: true,
          subtree: true
        });
        
        console.log('🔍 MutationObserver başlatıldı - DOM değişimleri takip ediliyor');
      }
      
      // 1 saniye sonra tekrar kontrol et
      setTimeout(() => {
        const afterBaslik = veritabaniAnaliziContent.textContent.includes('YENİ PDF FORMATI');
        const afterGun = veritabaniAnaliziContent.querySelector('tr[title="Gün başlığı - Fallback modu"]');
        
        console.log('🔍 1 saniye sonra kontrol:', {
          fallbackBaslik: !!afterBaslik,
          fallbackGun: !!afterGun,
          kaybolduMu: !afterBaslik || !afterGun,
          currentText: veritabaniAnaliziContent.textContent.substring(0, 100) + '...'
        });
        
        if (!afterBaslik || !afterGun) {
          console.error('🚨 FALLBACK ÖĞELERİ KAYBOLDU! Timing problemi tespit edildi');
        }
      }, 1000);
    }
    
    console.log('✅ Yemek veritabanı analizi tamamlandı:', {
      toplam: eslesmeDurumu.length,
      eslesen: eslesenSayisi,
      eslemeyen: eslesmeyenSayisi
    });
    
  } catch (error) {
    console.error('❌ Food_list.json yüklenirken hata:', error);
    veritabaniAnaliziContent.innerHTML = `
      <div style="text-align: center; color: #dc3545; padding: 20px;">
        <div style="font-weight: bold;">❌ Hata</div>
        <div style="font-size: 12px; margin-top: 5px;">
          Yemek veritabanı yüklenemedi: ${error.message}
        </div>
      </div>
    `;
  }
}

// Yemek detaylarını göster
function showFoodDetail(tarifAdi, eslestiMi, eslesenYemek) {
  console.log('🔍 Yemek detayı gösteriliyor:', tarifAdi, eslestiMi, eslesenYemek);
  console.log('🔍 eslesenYemek tipi:', typeof eslesenYemek);
  console.log('🔍 eslesenYemek içeriği:', JSON.stringify(eslesenYemek, null, 2));
  
  if (eslestiMi && eslesenYemek) {
    // Eşleşen yemek - düzenleme modalı aç
    yemekDuzenleModalAc(eslesenYemek, 'duzenle');
  } else {
    // Eşleşmeyen yemek - ekleme modalı aç
    yemekDuzenleModalAc({name: tarifAdi}, 'ekle');
  }
}

// Index kullanarak yemek detayı göster
function showFoodDetailByIndex(index) {
  console.log('🔍 Index ile yemek detayı gösteriliyor:', index);
  
  if (!window.currentFoodAnalysisData || !window.currentFoodAnalysisData[index]) {
    console.error('❌ Yemek verisi bulunamadı, index:', index);
    alert('Yemek verisi bulunamadı. Sayfayı yenileyin.');
    return;
  }
  
  const item = window.currentFoodAnalysisData[index];
  console.log('🔍 Bulunan item:', JSON.stringify(item, null, 2));
  
  if (item.eslestiMi && item.eslesenYemek) {
    // Eşleşen yemek - düzenleme modalı aç
    yemekDuzenleModalAc(item.eslesenYemek, 'duzenle');
  } else {
    // Eşleşmeyen yemek - ekleme modalı aç
    yemekDuzenleModalAc({name: item.tarifAdi}, 'ekle');
  }
}

// Index kullanarak eşleştirme modunu aç
function eslestirmeModeAc(index) {
  console.log('🔗 Index ile eşleştirme modu açılıyor:', index);
  
  if (!window.currentFoodAnalysisData || !window.currentFoodAnalysisData[index]) {
    console.error('❌ Yemek verisi bulunamadı, index:', index);
    alert('Yemek verisi bulunamadı. Sayfayı yenileyin.');
    return;
  }
  
  const item = window.currentFoodAnalysisData[index];
  console.log('🔗 Eşleştirme için item:', JSON.stringify(item, null, 2));
  
  // Eşleştirme modalını aç (String olarak yemek adını gönder)
  yemekDuzenleModalAc(item.tarifAdi, 'eslestir');
}

// Index kullanarak yemek sil
function yemekSilByIndex(index) {
  console.log('🗑️ Index ile yemek siliniyor:', index);
  
  if (!window.currentFoodAnalysisData || !window.currentFoodAnalysisData[index]) {
    console.error('❌ Yemek verisi bulunamadı, index:', index);
    alert('Yemek verisi bulunamadı. Sayfayı yenileyin.');
    return;
  }
  
  const item = window.currentFoodAnalysisData[index];
  if (item.eslesenYemek) {
    yemekSil(item.eslesenYemek);
  }
}

// Global fonksiyonları window objesine ata
window.showFoodDetailByIndex = showFoodDetailByIndex;
window.yemekSilByIndex = yemekSilByIndex;
window.eslestirmeModeAc = eslestirmeModeAc;

// 🍽️ YEMEK EKLEME/DÜZENLEME MODAL FONKSİYONLARI
function yemekDuzenleModalAc(yemekData, mod = 'ekle') {
  console.log('🔍 Modal açılıyor, gelen data:', yemekData);
  console.log('🔍 Modal modu:', mod);
  
  const modal = document.getElementById('yemekDuzenleModal');
  const baslik = document.getElementById('yemekModalBaslik');
  const kaydetBtn = document.getElementById('yemekKaydetBtn');
  const eslestirBtn = document.getElementById('eslestirKaydetBtn');
  const silBtn = document.getElementById('yemekSilBtn');
  
  // Eğer yemekData string ise (PDF'den gelen), eşleştirme modunda aç
  if (typeof yemekData === 'string') {
    // Eşleştirme modunda başlat
    baslik.textContent = '🔗 Yemek Eşleştirme';
    eslestirBtn.style.display = 'inline-block';
    kaydetBtn.style.display = 'none';
    silBtn.style.display = 'none'; // Eşleştirmede silme yok
    
    // Eşleştirme tab'ını aktif et
    tabAc('eslestir');
    
    // PDF yemek adını göster
    document.getElementById('eslestirYemekAdi').textContent = yemekData;
    document.getElementById('pdfYemekAdi').textContent = yemekData;
    
  // Yemek listesini yükle
  try { yemekListesiniYukle(); } catch (e) { console.warn('⚠️ Liste yükleme hatası:', e); }
    
  } else {
    // Normal ekleme/düzenleme modu
    if (mod === 'ekle' || mod === 'yeni') {
      baslik.textContent = '🍽️ Yeni Yemek Ekle';
      kaydetBtn.textContent = '➕ Ekle';
      kaydetBtn.style.background = '#28a745';
      silBtn.style.display = 'none'; // Yeni ekleme modunda silme yok
    } else {
      baslik.textContent = '🍽️ Yemek Düzenle';
      kaydetBtn.textContent = '💾 Güncelle';
      kaydetBtn.style.background = '#ffc107';
      silBtn.style.display = 'inline-block'; // Düzenleme modunda silme butonu göster
    }
    
    kaydetBtn.style.display = 'inline-block';
    eslestirBtn.style.display = 'none';
    
    // Yeni yemek tab'ını aktif et
    tabAc('yeniYemek');
    
  // Formu doldur
  yemekFormDoldur(yemekData);
  }
  
  // Modalı göster
  modal.style.display = 'block';
  
  // Modal modunu sakla
  modal.dataset.mod = mod;
  modal.dataset.originalData = JSON.stringify(yemekData);

  // Akıllı arama/suggestion bağla (soldaki "Yemek Adı" inputu için)
  try { 
    // Önce global food list kontrolü
    if (!window.globalFoodListFlat || !Array.isArray(window.globalFoodListFlat) || window.globalFoodListFlat.length === 0) {
      console.log('⚠️ Global yemek listesi henüz yüklenmemiş');
      // Yine de akıllı arama'yı init et, boş liste ile çalışsın
      initYemekAdiSmartSearch(); 
    } else {
      console.log('✅ Global yemek listesi mevcut, adet:', window.globalFoodListFlat.length);
      initYemekAdiSmartSearch();
    }
  } catch (e) { 
    console.warn('Akıllı arama init hatası:', e); 
  }
}

// TAB FONKSİYONLARI
function tabAc(tabName) {
  console.log('🔄 Tab değiştiriliyor:', tabName);
  
  // Tab butonlarını güncelle
  const yeniYemekTab = document.getElementById('yeniYemekTab');
  const eslestirTab = document.getElementById('eslestirTab');
  
  // Tab içeriklerini güncelle
  const yeniYemekContent = document.getElementById('yeniYemekContent');
  const eslestirContent = document.getElementById('eslestirContent');
  
  if (tabName === 'yeniYemek') {
    // Yeni Yemek tab'ını aktif et
    yeniYemekTab.classList.add('tab-button', 'active');
    eslestirTab.classList.remove('active');
    eslestirTab.classList.add('tab-button');
    
    yeniYemekContent.style.display = 'block';
    eslestirContent.style.display = 'none';
    
  } else if (tabName === 'eslestir') {
    // Eşleştir tab'ını aktif et
    eslestirTab.classList.add('tab-button', 'active');
    yeniYemekTab.classList.remove('active');
    yeniYemekTab.classList.add('tab-button');
    
    yeniYemekContent.style.display = 'none';
    eslestirContent.style.display = 'block';

    // PDF'den gelen ya da formdaki yemek adını başlığa yansıt
    try {
      const formYemekAdi = (document.getElementById('yemekAdi')?.value || '').trim();
      if (formYemekAdi) {
        const hedef1 = document.getElementById('eslestirYemekAdi');
        const hedef2 = document.getElementById('pdfYemekAdi');
        if (hedef1) hedef1.textContent = formYemekAdi;
        if (hedef2) hedef2.textContent = formYemekAdi;
      }
    } catch (e) {
      console.warn('⚠️ Eşleştirme sekmesinde yemek adı set edilemedi:', e);
    }

    // İlk açılışta listeyi yükle
    try { yemekListesiniYukle(); } catch (e) { console.warn('⚠️ Liste yükleme hatası:', e); }
  }
}

// ✂️ SATIR BÖLME FONKSİYONLARI
let splitContext = { index: null, original: '' };

function openSplitModal(index) {
  if (!window.currentFoodAnalysisData || !currentFoodAnalysisData[index]) return;
  const item = currentFoodAnalysisData[index];
  if (item.gunOgunSatiri) return; // başlık satırı
  splitContext.index = index;
  splitContext.original = item.tarifAdi;
  document.getElementById('splitModalOrjText').textContent = `Orijinal: ${item.tarifAdi}`;
  const ta = document.getElementById('splitLinesTextarea');
  ta.value = smartSplitSuggest(item.tarifAdi).join('\n');
  document.getElementById('satirBolModal').style.display = 'block';
}

function splitModalKapat(e) {
  if (e && e.target && e.currentTarget && e.target !== e.currentTarget) return;
  document.getElementById('satirBolModal').style.display = 'none';
  splitContext = { index: null, original: '' };
}

function smartSplitSuggest(text) {
  // Bazı yaygın ayırıcıların kombinasyonu ile öneri
  const raw = (text || '').trim();
  if (!raw) return [];
  // Önce ' + ' ve ' , ' ile parçalar (salata vb. + yağ ifadeleri ayrı kalabilir)
  let parts = raw
    .replace(/\s\+\s/g, ' | ') // + yerine güvenli ayracı koy
    .split(/\s\|\s|\s{2,}/g)
    .map(s => s.trim())
    .filter(Boolean);
  // 'Kollajen' gibi takviyeleri ayrı parçalara çekmeye çalış
  const splitKeywords = ['kollajen', 'protein', 'magnesium', 'omega', 'balık yağı'];
  parts = parts.flatMap(p => {
    const lower = p.toLowerCase();
    const hit = splitKeywords.find(k => lower.includes(k));
    if (!hit) return [p];
    // anahtar kelime öncesi/sonrası böl
    const idx = lower.indexOf(hit);
    const left = p.slice(0, idx).trim();
    const right = p.slice(idx).trim();
    return [left, right].filter(Boolean);
  });
  return parts;
}

function splitQuickSuggest(mode) {
  const src = splitContext.original || '';
  let suggestion = [];
  if (mode === 'kollajen') {
    suggestion = smartSplitSuggest(src);
  } else if (mode === 'doubleSpace') {
    suggestion = src.split(/\s{2,}/).map(s => s.trim()).filter(Boolean);
  } else if (mode === 'comma') {
    suggestion = src.split(',').map(s => s.trim()).filter(Boolean);
  }
  document.getElementById('splitLinesTextarea').value = suggestion.join('\n');
}

async function applySplitFromModal() {
  try {
    const ta = document.getElementById('splitLinesTextarea');
    const lines = ta.value.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
    if (!lines.length) { showToast('En az bir öğe girin', 'warning'); return; }
    const seciliIndex = getAktifHaftaIndex();
    const haftalar = getHaftaListesi();
    const hafta = haftalar[seciliIndex];
    if (!hafta || !Array.isArray(hafta.tarifler)) { showToast('Hafta verisi bulunamadı', 'error'); return; }

    // Orijinal satırı bul ve yerine yeni satırları koy
    const original = splitContext.original;
    const pos = hafta.tarifler.findIndex(t => (t||'').toLowerCase() === (original||'').toLowerCase());
    const insertAt = pos >= 0 ? pos : hafta.tarifler.length;
    if (pos >= 0) { hafta.tarifler.splice(pos, 1, ...lines); }
    else { hafta.tarifler.push(...lines); }

    // Kural olarak kaydet (kalıcı)
    try {
      splitKuraliEkle(original, lines);
    } catch(e) { console.warn('Split kuralı eklenemedi:', e); }

    // Eşleşmeleri yeniden çalıştır ve UI güncelle
    await otomatikEsleHafta(seciliIndex);
    eslesmeyenlerListesiniGuncelle();
    updateYemekVeritabaniAnalizi();
    // Hasta JSON'unu da kaydet (GitHub'a)
    try {
      if (seciliHasta) {
        await hastayiAyriKaydet(seciliHasta);
      }
    } catch (e) { console.warn('Split sonrası hasta kaydı atlandı:', e?.message || e); }
    showToast('Satır bölündü ve yeniden analiz edildi', 'success');
  } catch (e) {
    console.error('Satır bölme hatası:', e);
    showToast('Satır bölünemedi', 'error');
  } finally {
    splitModalKapat();
  }
}

// Global erişim
window.openSplitModal = openSplitModal;
window.applySplitFromModal = applySplitFromModal;
window.splitModalKapat = splitModalKapat;
window.splitQuickSuggest = splitQuickSuggest;

// YEMEK LİSTESİ FONKSİYONLARI
let mevcutYemekListesi = [];
let secilenYemek = null;
let aktifFiltre = 'all';

// Global, normalize edilmiş yemek listesi (food_list.json'dan)
window.globalFoodListFlat = window.globalFoodListFlat || null;

// Türkçe karakterleri ASCII'ye indirgeme (ID ve arama için)
function turkishToAscii(str) {
  return (str || '')
    .replace(/ç/g, 'c').replace(/Ç/g, 'c')
    .replace(/ğ/g, 'g').replace(/Ğ/g, 'g')
    .replace(/ş/g, 's').replace(/Ş/g, 's')
    .replace(/ü/g, 'u').replace(/Ü/g, 'u')
    .replace(/ö/g, 'o').replace(/Ö/g, 'o')
    .replace(/ı/g, 'i').replace(/İ/g, 'i');
}

// === Karaliste (render dışı satırlar) ===
const BLACKLIST_KEY = 'pdf_line_blacklist_v1';
const BLACKLIST_GITHUB_PATH = 'data/karaliste_satirlari.json';
let blacklistGitHubKaydetmeDevamEdiyor = false;
function getBlacklist() {
  try { return JSON.parse(localStorage.getItem(BLACKLIST_KEY)) || []; } catch { return []; }
}
function saveBlacklist(list) {
  try { localStorage.setItem(BLACKLIST_KEY, JSON.stringify(Array.from(new Set(list)))); } catch {}
}
function normalizeForBlacklist(str) {
  return normalizeTrSimple(str).replace(/\s+/g,' ').trim();
}
function addToBlacklist(raw) {
  const norm = normalizeForBlacklist(raw);
  if (!norm) return;
  const list = getBlacklist();
  if (!list.includes(norm)) {
    list.push(norm);
    saveBlacklist(list);
    console.log('🚫 Karaliste: eklendi ->', norm, `(toplam: ${list.length})`);
    showToast('Satır karalisteye eklendi', 'success');
    try { karalisteGitHubKaydet(true); } catch {}
  }
}
function removeFromBlacklist(raw) {
  const norm = normalizeForBlacklist(raw);
  const list = getBlacklist().filter(x => x !== norm);
  saveBlacklist(list);
  console.log('🚫 Karaliste: kaldırıldı ->', norm, `(toplam: ${list.length})`);
  try { karalisteGitHubKaydet(true); } catch {}
}
function isBlacklisted(raw) {
  const norm = normalizeForBlacklist(raw);
  return getBlacklist().includes(norm);
}
function openBlacklistModal() {
  renderBlacklistModal();
  const m = document.getElementById('karalisteModal');
  if (m) m.style.display = 'block';
}
function closeBlacklistModal(e) {
  if (e && e.target && e.currentTarget && e.target !== e.currentTarget) return;
  const m = document.getElementById('karalisteModal');
  if (m) m.style.display = 'none';
}
function renderBlacklistModal() {
  const listDiv = document.getElementById('karalisteListesi');
  const emptyDiv = document.getElementById('karalisteBos');
  if (!listDiv) return;
  const list = getBlacklist();
  if (!list.length) {
    if (emptyDiv) emptyDiv.style.display = 'block';
    listDiv.innerHTML = '';
    return;
  }
  if (emptyDiv) emptyDiv.style.display = 'none';
  listDiv.innerHTML = list.map((norm, i) => `
    <label style="display:flex; align-items:center; gap:8px; padding:6px 8px; border-bottom:1px dashed #eee;">
      <input type="checkbox" checked onchange="toggleBlacklistByNorm('${norm.replace(/'/g,"&#39;")}')">
      <span style="font-family:monospace;">${norm}</span>
      <button onclick="toggleBlacklistByNorm('${norm.replace(/'/g,"&#39;")}')" style="margin-left:auto; background:#dc3545; color:#fff; border:none; padding:4px 8px; border-radius:4px; cursor:pointer; font-size:12px;">Kaldır</button>
    </label>
  `).join('');
}
function toggleBlacklistByNorm(norm) {
  const list = getBlacklist();
  const idx = list.indexOf(norm);
  if (idx >= 0) list.splice(idx,1); else list.push(norm);
  saveBlacklist(list);
  console.log('🚫 Karaliste: toggle ->', norm, `(artık listede mi?: ${list.includes(norm)}) (toplam: ${list.length})`);
  renderBlacklistModal();
  updateYemekVeritabaniAnalizi();
  try { karalisteGitHubKaydet(true); } catch {}
}
function clearBlacklist() {
  saveBlacklist([]);
  console.log('🚫 Karaliste: tümü temizlendi');
  renderBlacklistModal();
  updateYemekVeritabaniAnalizi();
  try { karalisteGitHubKaydet(true); } catch {}
}

// Tablo satırı için hızlı karaliste toggle
function toggleBlacklistForRow(index) {
  try {
    const data = window.currentFoodAnalysisData || [];
    const item = data[index];
    if (!item || !item.tarifAdi) return;
    const norm = normalizeForBlacklist(item.tarifAdi);
    const list = getBlacklist();
    const exists = list.includes(norm);
    if (exists) {
      saveBlacklist(list.filter(x => x !== norm));
  console.log('🚫 Karaliste (tablo): kaldırıldı ->', norm);
      showToast('Karalisteden çıkarıldı', 'warning');
    } else {
      list.push(norm);
      saveBlacklist(list);
  console.log('🚫 Karaliste (tablo): eklendi ->', norm);
      showToast('Karalisteye eklendi', 'success');
    }
    // UI güncelle
    renderBlacklistModal();
    updateYemekVeritabaniAnalizi();
  try { karalisteGitHubKaydet(true); } catch {}
  } catch (e) {
    console.warn('toggleBlacklistForRow hatası:', e);
  }
}
// Global erişim
window.openBlacklistModal = openBlacklistModal;
window.closeBlacklistModal = closeBlacklistModal;
window.clearBlacklist = clearBlacklist;
window.toggleBlacklistByNorm = toggleBlacklistByNorm;
window.toggleBlacklistForRow = toggleBlacklistForRow;

// --- Karaliste GitHub entegrasyonu ---
async function karalisteGitHubKaydet(sessizKaydetme = false) {
  if (blacklistGitHubKaydetmeDevamEdiyor) return;
  const token = document.getElementById('githubToken')?.value?.trim();
  if (!token) { if (!sessizKaydetme) alert('GitHub API token gerekli!'); return; }
  blacklistGitHubKaydetmeDevamEdiyor = true;
  const owner = 'mustafasacar35';
  const repo = 'lipodem-takip-paneli-4';
  const path = BLACKLIST_GITHUB_PATH;
  const branch = 'main';
  try {
    let sha;
    try {
      const resp = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}?ref=${branch}`, { headers: { Authorization: `token ${token}` } });
      if (resp.ok) { const data = await resp.json(); sha = data.sha; }
    } catch {}
    const list = getBlacklist();
    const kayitVerisi = { version: '1.0', sonGuncelleme: new Date().toISOString(), karaliste: list };
    const content = encodeUTF8ToBase64(kayitVerisi);
    const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, {
      method: 'PUT', headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
      body: JSON.stringify({ message: 'Karaliste güncellendi', content, branch, sha })
    });
    if (!res.ok) {
      const errText = await res.text();
      // SHA conflict retry
      if (/expected/i.test(errText) || /sha/i.test(errText)) {
        try {
          const getResp = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}?ref=${branch}`, { headers: { Authorization: `token ${token}` } });
          if (getResp.ok) {
            const getData = await getResp.json();
            const retrySha = getData.sha;
            const retryRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, {
              method: 'PUT', headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
              body: JSON.stringify({ message: 'Karaliste güncellendi (retry)', content, branch, sha: retrySha })
            });
            if (!retryRes.ok) throw new Error(await retryRes.text());
          } else {
            throw new Error(errText);
          }
        } catch (retryErr) {
          throw retryErr;
        }
      } else {
        throw new Error(errText);
      }
    }
  localStorage.setItem('lastGithubUpdate', Date.now().toString());
  console.log('✅ Karaliste GitHub\'a kaydedildi:', getBlacklist().length, 'öğe');
  if (!sessizKaydetme) showToast('Karaliste GitHub\'a kaydedildi', 'success');
  } catch (e) {
    console.error('Karaliste GitHub kaydetme hatası:', e);
    if (!sessizKaydetme) showToast('Karaliste GitHub kaydetme hatası', 'error');
  } finally { blacklistGitHubKaydetmeDevamEdiyor = false; }
}

async function karalisteGitHubYukle(sessizYukleme = false) {
  const token = document.getElementById('githubToken')?.value?.trim();
  if (!token) { if (!sessizYukleme) alert('GitHub API token gerekli!'); return; }
  const owner = 'mustafasacar35';
  const repo = 'lipodem-takip-paneli-4';
  const path = BLACKLIST_GITHUB_PATH;
  const branch = 'main';
  try {
    const resp = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}?ref=${branch}`, { headers: { Authorization: `token ${token}` } });
    if (resp.ok) {
      const data = await resp.json();
      const jsonContent = decodeBase64UTF8(data.content);
      const kayitVerisi = JSON.parse(jsonContent);
      const remote = kayitVerisi.karaliste || kayitVerisi || [];
      // Not: GitHub yüklemesi otoritatif olsun (overwrite) ki silmeler de senkron olsun
      const temiz = Array.isArray(remote) ? remote : [];
      saveBlacklist(temiz);
      localStorage.setItem('lastGithubUpdate', Date.now().toString());
      console.log('📥 Karaliste GitHub\'dan yüklendi:', temiz.length, 'öğe (overwrite)');
      if (!sessizYukleme) showToast(`GitHub'dan karaliste yüklendi (${temiz.length})`, 'success');
      try { updateYemekVeritabaniAnalizi(); } catch {}
      try { renderBlacklistModal(); } catch {}
    } else if (resp.status === 404) {
      if (!sessizYukleme) showToast('GitHub\'da karaliste dosyası yok', 'warning');
    } else {
      throw new Error('GitHub okuma hatası: ' + resp.status);
    }
  } catch (e) {
    console.error('Karaliste GitHub yükleme hatası:', e);
    if (!sessizYukleme) showToast('Karaliste GitHub yükleme hatası', 'error');
  }
}

async function karalistePublicYukle() {
  try {
    const url = 'https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli-4/main/data/karaliste_satirlari.json';
    const resp = await fetch(url + `?t=${Date.now()}`);
    if (resp.ok) {
      const data = await resp.json();
      const remote = data.karaliste || data || [];
      const union = Array.from(new Set([...(getBlacklist() || []), ...(Array.isArray(remote) ? remote : [])]));
      saveBlacklist(union);
      try { updateYemekVeritabaniAnalizi(); } catch {}
    }
  } catch {}
}

window.karalisteGitHubKaydet = karalisteGitHubKaydet;
window.karalisteGitHubYukle = karalisteGitHubYukle;

// Basit ama stabil bir hash (ID çakışmalarını önlemek için suffix)
function simpleHash(str) {
  let h = 0;
  for (let i = 0; i < (str || '').length; i++) {
    h = ((h << 5) - h) + str.charCodeAt(i);
    h |= 0; // 32-bit
  }
  return Math.abs(h).toString(36);
}

// UI araması için normalize (boşluk/işaret sadeleştirme)
function normalizeTrSimple(str) {
  return turkishToAscii((str || '').toString().toLowerCase())
    .replace(/[_*\/()\[\],.]/g, ' ')
    .replace(/\s+/g, ' ')
    .trim();
}

function generateStableId(name, kategori) {
  try {
    const n = turkishToAscii((name || '').toLowerCase());
    const k = turkishToAscii((kategori || '').toLowerCase());
    const base = `${n}_${k}`
      .replace(/\s+/g, '_')
      .replace(/[^a-z0-9_\-]/g, '');
    const suffix = simpleHash(`${name}::${kategori}`);
    return 'db_' + base + '_' + suffix;
  } catch { return 'db_' + Math.random().toString(36).slice(2); }
}

function flattenFoodDataToGlobal(foodData) {
  if (!foodData || !Array.isArray(foodData.categories)) return [];
  const flat = [];
  foodData.categories.forEach(cat => {
    const kategori = cat?.name || 'GENEL';
    (cat?.items || []).forEach(item => {
      flat.push({
        id: generateStableId(item.name, kategori),
        ad: item.name,
        kategori: item.category || kategori,
        kalori: item.calories || 0,
        protein: item.protein || 0,
        karbonhidrat: item.carbs || 0,
        yag: item.fat || 0,
        role: item.role || 'mainDish',  // ROL EKLENDİ
        mealType: item.mealType || [],  // ÖĞÜN TİPLERİ EKLENDİ
        keto: item.keto || false,
        lowcarb: item.lowcarb || false,
        fillerLunch: item.fillerLunch || false,
        fillerDinner: item.fillerDinner || false,
        compatibilityTags: item.compatibilityTags || [],
        incompatibilityTags: item.incompatibilityTags || [],
        etiketler: item.tags || []
      });
    });
  });
  window.globalFoodListFlat = flat;
  return flat;
}

function yemekListesiniYukle() {
  console.log('📋 Yemek listesi yükleniyor...');
  
  // Önce global, normalize edilmiş listeyi kullan
  if (window.globalFoodListFlat && Array.isArray(window.globalFoodListFlat) && window.globalFoodListFlat.length) {
    console.log('🕵️ DEBUG: Global flat listeden yükleniyor, adet:', window.globalFoodListFlat.length);
    console.log('🕵️ DEBUG: İlk yemek örneği (global):', window.globalFoodListFlat[0]);
    mevcutYemekListesi = [...window.globalFoodListFlat];
  } else {
    // 🚨 LOKAL FALLBACK DEVRE DIŞI - SADECE GITHUB'DAN
    console.log('❌ Global liste bulunamadı! SADECE GitHub\'dan yükleme aktif.');
    console.log('ℹ️ Lütfen GitHub token\'ınızı kontrol edin ve internet bağlantınızı doğrulayın.');
    mevcutYemekListesi = [];
  }
  
  // Toplam sayıyı güncelle
  if (document.getElementById('toplamYemekSayisi')) {
    document.getElementById('toplamYemekSayisi').textContent = mevcutYemekListesi.length || 0;
  }
  
  // Listeyi göster
  if (mevcutYemekListesi && mevcutYemekListesi.length) {
    yemekListesiniGoster(mevcutYemekListesi);
  }
}

function yemekListesiniGoster(liste) {
  const container = document.getElementById('yemekListesiContainer');
  
  if (!liste || liste.length === 0) {
    container.innerHTML = `
      <div style="text-align: center; padding: 40px; color: #666;">
        <i class="fas fa-search" style="font-size: 32px; margin-bottom: 10px; opacity: 0.5;"></i>
        <p style="margin: 0; font-size: 14px;">Aramanızla eşleşen yemek bulunamadı.</p>
      </div>
    `;
    return;
  }
  
  const html = liste.map(yemek => {
    const kategoriIcon = getKategoriIcon(yemek.kategori);
    const rolIcon = getRolIcon(yemek.role); // ROL İKONU EKLENDİ
    const rolAdi = getRolAdi(yemek.role); // ROL ADI EKLENDİ
    const makrolar = `P:${yemek.protein || 0}g, K:${yemek.karbonhidrat || 0}g, Y:${yemek.yag || 0}g`;
    
    return `
      <div class="yemek-kart" onclick="yemekSec('${yemek.ad}', ${JSON.stringify(yemek).replace(/"/g, '&quot;')})" style="border: 1px solid #e9ecef; border-radius: 8px; padding: 12px; margin-bottom: 10px; cursor: pointer; transition: all 0.2s;">
        <div class="yemek-kart-header">
          <div style="display: flex; justify-content: space-between; align-items: start;">
            <div style="flex: 1;">
              <h6 style="margin: 0; color: #333; font-weight: 600; font-size: 14px;">
                ${kategoriIcon} ${yemek.ad}
              </h6>
              <div style="font-size: 12px; color: #666; margin-top: 2px;">
                ${yemek.kategori} • ${rolIcon} ${rolAdi}
              </div>
            </div>
            <div style="font-size: 12px; color: #28a745; font-weight: bold;">
              ${yemek.kalori || 0} kcal
            </div>
          </div>
        </div>
        <div class="yemek-kart-body">
          <div style="margin-bottom: 5px; font-size: 12px; color: #555;">${makrolar}</div>
          ${yemek.etiketler ? `<div style="font-size: 11px; color: #888;">🏷️ ${Array.isArray(yemek.etiketler) ? yemek.etiketler.join(', ') : yemek.etiketler}</div>` : ''}
        </div>
      </div>
    `;
  }).join('');
  
  container.innerHTML = html;
}

function getKategoriIcon(kategori) {
  const iconMap = {
    'KAHVALTI': '🌅',
    'OGLE': '🌞', 
    'AKSAM': '🌙',
    'TATLI': '🍰',
    'ICECEK': '🥤',
    'SALATA': '🥗',
    'CORBALAR': '🍲',
    'SEBZE': '🥬',
    'ET': '🥩',
    'BALIK': '🐟',
    'TAVUK': '🐔',
    'APERATIF': '🥨'
  };
  return iconMap[kategori] || '🍽️';
}

function yemekSec(yemekId) {
  console.log('🎯 Yemek seçildi:', yemekId);
  
  // Önceki seçimi temizle
  const oncekiSecim = document.querySelector('.yemek-kart.selected');
  if (oncekiSecim) {
    oncekiSecim.classList.remove('selected');
  }
  
  // Yeni seçimi işaretle
  const yeniSecim = document.querySelector(`[data-yemek-id="${yemekId}"]`);
  if (yeniSecim) {
    yeniSecim.classList.add('selected');
  }
  
  // Seçilen yemeği bul
  secilenYemek = mevcutYemekListesi.find(y => y.id === yemekId);
  
  if (secilenYemek) {
    // Seçilen yemek bilgisini göster
    const bilgiDiv = document.getElementById('secilenYemekBilgi');
    const detayDiv = document.getElementById('secilenYemekDetay');
    
    const makrolar = `Protein: ${secilenYemek.protein || 0}g, Karbonhidrat: ${secilenYemek.karbonhidrat || 0}g, Yağ: ${secilenYemek.yag || 0}g`;
    
    detayDiv.innerHTML = `
      <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 15px; margin-bottom: 10px;">
        <div>
          <strong>${getKategoriIcon(secilenYemek.kategori)} ${secilenYemek.ad}</strong>
          <div style="margin-top: 5px; font-size: 13px;">${makrolar}</div>
        </div>
        <div style="text-align: right;">
          <div style="font-size: 16px; font-weight: bold; color: #28a745;">${secilenYemek.kalori || 0} kcal</div>
          <div style="font-size: 12px; color: #20c997;">${secilenYemek.kategori}</div>
        </div>
      </div>
      
      <!-- 🏷️ TAGS & LABELS SECTION -->
      <div style="background: #f8f9fa; padding: 10px; border-radius: 6px; margin-bottom: 8px;">
        ${secilenYemek.etiketler ? `
          <div style="margin-bottom: 8px;">
            <span style="font-weight: bold; color: #495057; font-size: 12px;">🏷️ Etiketler (Tags):</span>
            <div style="margin-top: 4px;">
              ${(Array.isArray(secilenYemek.etiketler) ? secilenYemek.etiketler : [secilenYemek.etiketler]).map(tag => 
                `<span style="display: inline-block; background: #e9ecef; color: #495057; padding: 2px 6px; border-radius: 3px; font-size: 11px; margin: 1px;">${tag}</span>`
              ).join('')}
            </div>
          </div>
        ` : ''}
        
        ${secilenYemek.compatibilityTags ? `
          <div style="margin-bottom: 8px;">
            <span style="font-weight: bold; color: #28a745; font-size: 12px;">🤝 Uyumluluk:</span>
            <div style="margin-top: 4px;">
              ${(Array.isArray(secilenYemek.compatibilityTags) ? secilenYemek.compatibilityTags : [secilenYemek.compatibilityTags]).map(tag => 
                `<span style="display: inline-block; background: #d4edda; color: #155724; padding: 2px 6px; border-radius: 3px; font-size: 11px; margin: 1px;">${tag}</span>`
              ).join('')}
            </div>
          </div>
        ` : ''}
        
        ${secilenYemek.incompatibilityTags && secilenYemek.incompatibilityTags.length > 0 ? `
          <div style="margin-bottom: 8px;">
            <span style="font-weight: bold; color: #dc3545; font-size: 12px;">🚫 Uyumsuzluk:</span>
            <div style="margin-top: 4px;">
              ${(Array.isArray(secilenYemek.incompatibilityTags) ? secilenYemek.incompatibilityTags : [secilenYemek.incompatibilityTags]).map(tag => 
                `<span style="display: inline-block; background: #f8d7da; color: #721c24; padding: 2px 6px; border-radius: 3px; font-size: 11px; margin: 1px;">${tag}</span>`
              ).join('')}
            </div>
          </div>
        ` : ''}
      </div>
      
      <!-- ⚙️ TECHNICAL DETAILS SECTION -->
      <div style="background: #e3f2fd; padding: 10px; border-radius: 6px; font-size: 11px; color: #1565c0;">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
          <div><strong>Rol:</strong> ${secilenYemek.role || 'mainDish'}</div>
          <div><strong>Porsiyon:</strong> ${secilenYemek.minQuantity || 0.5}-${secilenYemek.maxQuantity || 1} (${secilenYemek.step || 0.5})</div>
          <div><strong>Keto:</strong> ${secilenYemek.keto ? '✅' : '❌'}</div>
          <div><strong>Düşük Karb:</strong> ${secilenYemek.lowcarb ? '✅' : '❌'}</div>
          <div><strong>Öğün Türü:</strong> ${(secilenYemek.mealType || []).join(', ') || 'Belirtilmemiş'}</div>
          <div><strong>Sezon:</strong> ${secilenYemek.seasonRange || '[1,12]'} ${secilenYemek.isReversedSeason ? '(Ters)' : ''}</div>
        </div>
      </div>
    `;
    
    bilgiDiv.style.display = 'block';
  }
}

function yemekListesiniFiltrele() {
  const aramaHam = document.getElementById('yemekAramaInput').value || '';
  const aramaMetni = normalizeTrSimple(aramaHam);

  let filtrelenmisListe = [...mevcutYemekListesi];

  // Kategori filtresi uygula
  if (aktifFiltre !== 'all') {
    filtrelenmisListe = filtrelenmisListe.filter(yemek => yemek.kategori === aktifFiltre);
  }

  // Arama filtresi uygula (Türkçe karakter duyarlı normalize)
  if (aramaMetni) {
    filtrelenmisListe = filtrelenmisListe.filter(yemek => {
      const adNorm = normalizeTrSimple(yemek.ad);
      let etiketNorm = '';
      if (yemek.etiketler) {
        etiketNorm = Array.isArray(yemek.etiketler)
          ? normalizeTrSimple(yemek.etiketler.join(' '))
          : normalizeTrSimple(String(yemek.etiketler));
      }
      return adNorm.includes(aramaMetni) || (etiketNorm && etiketNorm.includes(aramaMetni));
    });
  }

  yemekListesiniGoster(filtrelenmisListe);
  console.log(`🔍 Filtreleme: "${aramaHam}" => "${aramaMetni}" + kategori:"${aktifFiltre}" = ${filtrelenmisListe.length} sonuç`);
}

function hizliFiltre(kategori) {
  console.log('⚡ Hızlı filtre:', kategori);
  
  aktifFiltre = kategori;
  
  // Buton stillerini güncelle
  const tümButonlar = document.querySelectorAll('.hizli-filtre');
  tümButonlar.forEach(btn => {
    btn.classList.remove('active');
    if (btn.dataset.filtre === kategori) {
      btn.classList.add('active');
    }
  });
  
  // Filtrelemeyi uygula
  yemekListesiniFiltrele();
}

function aliasEklemeToggle() {
  const checkbox = document.getElementById('aliasEkleCheckbox');
  const alan = document.getElementById('aliasEklemeAlani');
  
  if (checkbox.checked) {
    alan.style.display = 'block';
  } else {
    alan.style.display = 'none';
  }
}

function yemekEslestir() {
  if (!secilenYemek) {
    showToast('Lütfen eşleştirmek için bir yemek seçin!', 'warning');
    return;
  }
  
  const aliasEkle = document.getElementById('aliasEkleCheckbox').checked;
  const pdfYemekAdi = document.getElementById('pdfYemekAdi').textContent;
  
  console.log('🔗 Yemek eşleştiriliyor:', {
    pdfAdi: pdfYemekAdi,
    secilenYemek: secilenYemek.ad,
    aliasEkle: aliasEkle
  });
  
  if (aliasEkle && pdfYemekAdi && pdfYemekAdi !== secilenYemek.ad) {
    // Alias oluştur - seçilen yemeğin kopyasını yeni isimle ekle
    const yeniYemek = { ...secilenYemek };
    yeniYemek.id = generateId();
    yeniYemek.ad = pdfYemekAdi;
    yeniYemek.aliasOf = secilenYemek.id;
    yeniYemek.createdDate = new Date().toISOString();
    
    // Yemek listesine ekle
    foodList.push(yeniYemek);
    
    // GitHub'a kaydet
    yemekGithubKaydet()
      .then(() => {
        showToast(`"${pdfYemekAdi}" ismiyle alias oluşturuldu ve "${secilenYemek.ad}" ile eşleştirildi!`, 'success');
        yemekModalKapat();
      })
      .catch(error => {
        console.error('❌ Alias kaydetme hatası:', error);
        showToast('Alias kaydedilirken hata oluştu: ' + error.message, 'error');
      });
  } else {
    // Sadece eşleştirme yap
    showToast(`"${pdfYemekAdi}" "${secilenYemek.ad}" ile eşleştirildi!`, 'success');
    yemekModalKapat();
  }
}

// Global fonksiyonları window objesine ata
window.tabAc = tabAc;
window.yemekListesiniFiltrele = yemekListesiniFiltrele;
window.hizliFiltre = hizliFiltre;
window.aliasEklemeToggle = aliasEklemeToggle;
window.yemekEslestir = yemekEslestir;

// 🔄 ALTERNATİF YEMEK SİSTEMİ
let alternativeModeActive = false;
let currentAlternativeIndex = -1;
let originalFoodData = null;
let alternativeFoods = [];
let currentAlternativeStep = 0;

// Bu ilk fonksiyon devre dışı - üçüncü fonksiyon kullanılıyor
function alternatifYemekAc_ILKVERSIYON(index) {
  
  if (!window.currentFoodAnalysisData || !window.currentFoodAnalysisData[index]) {
    console.error('❌ Yemek verisi bulunamadı, index:', index);
    showToast('Yemek verisi bulunamadı!', 'error');
    return;
  }
  
  const item = window.currentFoodAnalysisData[index];
  
  if (!item.eslestiMi || !item.eslesenYemek) {
    showToast('Sadece eşleşen yemekler için alternatif önerileri yapılabilir!', 'warning');
    return;
  }
  
  console.log('🎯 Alternatif aranacak yemek:', item.eslesenYemek);
  
  // Mevcut durumu kaydet
  originalFoodData = { ...item.eslesenYemek };
  currentAlternativeIndex = index;
  currentAlternativeStep = 0;
  
  // Alternatif yemekleri bulup uygula
  alternatifleriBaslat(item.eslesenYemek);
}

async function alternatifleriBaslat(currentFood, options) {
  console.log('🚀 alternatifleriBaslat çağrıldı! currentFood:', currentFood?.name, 'options:', options);
  
  // Hedef-bazlı mod mu kontrol et
  const isTargetBasedMode = (options && options.noAutoApply);
  console.log('🎯 HEDEF BAZLI MOD:', isTargetBasedMode ? 'AÇIK ✅' : 'KAPALI ❌');
  
  try {
    // Hangi butondan çağrıldığını kaydet
    window.lastAlternativeCallType = isTargetBasedMode ? 'smart' : 'normal';
    
    showToast('🔍 Alternatif yemekler aranıyor...', 'info');

    // Aktif satır ve öğün bağlamını al
    const rowIndex = window.currentAlternativeIndex;
    const rowItem = (Array.isArray(window.currentFoodAnalysisData) && rowIndex >= 0) ? window.currentFoodAnalysisData[rowIndex] : null;
    const ogunRaw = rowItem?.belongToOgun || '';
    const gunRaw = rowItem?.belongToGun || '';

    // Hedef makroları (gün/öğün) hesapla
    const aktifHasta = (typeof getCurrentHasta === 'function') ? getCurrentHasta() : null;
    let mealTarget = null;
    try {
      if (!aktifHasta) throw new Error('Aktif hasta bulunamadı');
      const eff = await computeEffectiveSettingsFor(aktifHasta);
      let keys = getPresentMealKeysInActiveWeek();
      if (!keys || keys.length === 0) keys = ['kahvalti','ogle','aksam','ara'];
      keys = orderMealKeys(keys);
      const distForKeys = (keys.length === 4) ? eff.dist : renormalizeDistributionForKeys(eff.dist, keys);
      const t = calcTargetsFromSettings(eff);
      const parts = calcMealBreakdown(t, distForKeys);
      const ogunKey = normalizedMealToKey(normalizeOgunAdi(ogunRaw));
      mealTarget = parts[ogunKey] || null;
      console.log('🎯 DEBUG: Hedef makro hesaplama - ogunRaw:', ogunRaw, 'ogunKey:', ogunKey);
      console.log('🎯 DEBUG: mealTarget:', mealTarget);
    } catch (e) {
      console.warn('SMART_ALT: Hedef makro hesaplanamadı, basit benzerlik kullanılacak.', e);
    }

    // Mevcut öğün toplamlarını hesapla (değişim etkisini ölçmek için)
    const currentMealTotals = (mealTarget && rowItem)
      ? computeMealTotalsFor(rowItem.belongToGun, rowItem.belongToOgun)
      : null;
    
    console.log('🎯 DEBUG: currentMealTotals:', currentMealTotals);
    console.log('🎯 DEBUG: Hedef-mevcut karşılaştırma yapılacak mı?', !!(mealTarget && currentMealTotals));

    // 🎯 YENİ: Hedef-bazlı modda haftalık fark hesapla
    let weeklyTargetGap = null;
    if (isTargetBasedMode) {
      try {
        // Günlük hedef kaloriyi badge'den al
        const hedefKcalElement = document.getElementById('hedefKcalBadgeValue');
        const dailyTargetKcal = hedefKcalElement ? parseInt(hedefKcalElement.textContent) : null;
        
        // Haftalık gerçekleşen ortalama al
        const activeWeekStats = getActiveWeekAverageStats();
        
        if (activeWeekStats && activeWeekStats.kalori && dailyTargetKcal) {
          const targetKcal = dailyTargetKcal;
          const actualKcal = activeWeekStats.kalori;
          const gapPercent = ((actualKcal - targetKcal) / targetKcal) * 100;
          
          weeklyTargetGap = {
            targetKcal,
            actualKcal, 
            gapPercent,
            isOverTarget: gapPercent > 0,
            description: gapPercent > 0 ? `%${Math.abs(gapPercent).toFixed(1)} FAZLA` : `%${Math.abs(gapPercent).toFixed(1)} EKSİK`
          };
          
          console.log('📊 HAFTALIK HEDEF ANALIZI:');
          console.log('   🎯 Günlük hedef kalori:', targetKcal);
          console.log('   📈 Haftalık gerçekleşen ort:', actualKcal.toFixed(1));
          console.log('   📊 Fark:', weeklyTargetGap.description);
          console.log('   � Gap detayı:', weeklyTargetGap);
          console.log('   ✅ Hedef-bazlı algoritma hazır!');
        } else {
          console.warn('⚠️ Haftalık istatistik verileri eksik:', {
            activeWeekStats: !!activeWeekStats,
            kalori: activeWeekStats?.kalori,
            dailyTargetKcal,
            hedefElement: !!hedefKcalElement
          });
        }
      } catch (e) {
        console.warn('⚠️ Haftalık hedef farkı hesaplanamadı:', e);
      }
    }

    // Yemek veritabanını yükle (önbellek varsa kullan)
    let foodData = null;
    if (window.lastSavedFoodData && typeof window.lastSavedFoodData === 'object') {
      foodData = window.lastSavedFoodData;
    } else {
      const response = await fetch(`https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli-4/refs/heads/main/food_list.json?nocache=${Date.now()}`);
      if (!response.ok) throw new Error('Yemek veritabanı yüklenemedi');
      foodData = await response.json();
    }

    // Tüm yemekleri zengin alanlarla düz listeye çevir
    const allFoods = [];
    (foodData?.categories || []).forEach(category => {
      (category?.items || []).forEach(item => {
        allFoods.push({
          id: item.id || generateId(),
          name: item.name,
          originalName: item.name,
          category: item.category || category.name,
          calories: item.calories || 0,
          protein: item.protein || 0,
          carbs: item.carbs || 0,
          fat: item.fat || 0,
          tags: item.tags || [],
          role: item.role || 'mainDish',
          mealType: item.mealType || [],
          keto: item.keto || false,
          lowcarb: item.lowcarb || false,
          fillerLunch: item.fillerLunch || false,
          fillerDinner: item.fillerDinner || false,
          portionFixed: item.portionFixed || false,
          compatibilityTags: item.compatibilityTags || [],
          incompatibilityTags: item.incompatibilityTags || []
        });
      });
    });

    console.log('📊 Toplam yemek sayısı:', allFoods.length);

    // 🔍 ZATEN SEÇİLMİŞ YEMEKLERİ BUL (Aynı öğünde)
    const currentMealFoods = [];
    if (rowItem) {
      const sameGun = rowItem.belongToGun;
      const sameOgun = rowItem.belongToOgun;
      
      // Aynı gün ve öğündeki tüm yemekleri bul
      (window.currentFoodAnalysisData || []).forEach(item => {
        if (!item.gunOgunSatiri && !item.karalistede && 
            item.belongToGun === sameGun && 
            item.belongToOgun === sameOgun &&
            item.eslestiMi && item.eslesenYemek) {
          currentMealFoods.push({
            name: item.eslesenYemek.name || item.eslesenYemek.originalName,
            originalName: item.eslesenYemek.originalName || item.eslesenYemek.name,
            tags: item.eslesenYemek.tags || [],
            compatibilityTags: item.eslesenYemek.compatibilityTags || [],
            incompatibilityTags: item.eslesenYemek.incompatibilityTags || [],
            role: item.eslesenYemek.role || 'mainDish'
          });
        }
      });
      
      console.log('🍽️ ÖĞÜN ANALİZİ:', {
        gun: sameGun,
        ogun: sameOgun, 
        mevcutYemekler: currentMealFoods.map(f => f.name),
        currentFood: currentFood?.name
      });
    }
    
    // Ana yemek (mainDish) bilgilerini bul
    const mainDish = currentMealFoods.find(f => f.role === 'mainDish');
    const mainDishTags = mainDish ? (mainDish.tags || []) : [];
    const mainDishCompatibility = mainDish ? (mainDish.compatibilityTags || []) : [];
    
    console.log('🍖 ANA YEMEK ANALİZİ:', {
      anaYemek: mainDish?.name,
      anaYemekTaglar: mainDishTags,
      uyumlulukKelimeleri: mainDishCompatibility
    });

    // Adayları filtrele (katı kurallar + kendisini hariç tut + karaliste + gelişmiş kurallar)
    const cfg = window.SMART_ALT || window.SMART_ALT_DEFAULTS || {};
    const context = { ogun: ogunRaw, gun: gunRaw };
    const normCurrentName = String(currentFood?.originalName || currentFood?.name || '').toLowerCase();
    const candidatePool = allFoods.filter(food => {
      const nm = String(food.name || '').toLowerCase();
      
      // Temel kontroller
      if (!nm || nm === normCurrentName) return false;
      
      // 🚫 ZATEN SEÇİLMİŞ YEMEK KONTROLÜ
      const alreadySelected = currentMealFoods.some(mf => 
        (mf.name && mf.name.toLowerCase() === nm) ||
        (mf.originalName && mf.originalName.toLowerCase() === nm)
      );
      if (alreadySelected) {
        console.log('🚫 ZATEN SEÇİLMİŞ:', food.name);
        return false;
      }
      
      // 🏷️ TAG ÇAKIŞMA KONTROLÜ (Ana yemek ile diğer roller arasında)
      if (mainDishTags.length > 0 && food.role !== 'mainDish') {
        const foodTags = food.tags || [];
        const hasTagConflict = mainDishTags.some(mainTag => 
          foodTags.some(foodTag => 
            foodTag.toLowerCase().includes(mainTag.toLowerCase()) ||
            mainTag.toLowerCase().includes(foodTag.toLowerCase())
          )
        );
        
        if (hasTagConflict) {
          console.log('🏷️ TAG ÇAKIŞMASI:', {
            yemek: food.name,
            anaYemekTaglar: mainDishTags,
            yemekTaglar: foodTags
          });
          return false;
        }
      }
      
      // 🤝 UYUMLULUK KELİME ÖNCELİKLENDİRME (Score artırımı için işaretleme)
      if (mainDishCompatibility.length > 0) {
        const foodTags = food.tags || [];
        const hasCompatibilityMatch = mainDishCompatibility.some(compTag =>
          foodTags.some(foodTag =>
            foodTag.toLowerCase().includes(compTag.toLowerCase()) ||
            compTag.toLowerCase().includes(foodTag.toLowerCase())
          )
        );
        
        if (hasCompatibilityMatch) {
          food._compatibilityBonus = true; // Skorlamada kullanılacak
          console.log('🤝 UYUMLULUK BONUSU:', {
            yemek: food.name,
            uyumluKelimeler: mainDishCompatibility,
            yemekTaglar: foodTags
          });
        }
      }
      
      // 🚫 UYUMSUZLUK KELİME KONTROLÜ
      const allCurrentIncompatibilityTags = [];
      currentMealFoods.forEach(mf => {
        if (mf.incompatibilityTags && mf.incompatibilityTags.length > 0) {
          allCurrentIncompatibilityTags.push(...mf.incompatibilityTags);
        }
      });
      
      if (allCurrentIncompatibilityTags.length > 0) {
        const foodIncompatibilityTags = food.incompatibilityTags || [];
        const foodTags = food.tags || [];
        
        // Mevcut öğündeki yemeklerin uyumsuzluk kelimeleri ile bu yemeğin tagları çakışıyor mu?
        const hasIncompatibilityConflict = allCurrentIncompatibilityTags.some(incTag =>
          foodTags.some(foodTag =>
            foodTag.toLowerCase().includes(incTag.toLowerCase()) ||
            incTag.toLowerCase().includes(foodTag.toLowerCase())
          )
        );
        
        // Bu yemeğin uyumsuzluk kelimeleri ile mevcut öğündeki yemeklerin tagları çakışıyor mu?
        const currentMealTags = [];
        currentMealFoods.forEach(mf => {
          if (mf.tags && mf.tags.length > 0) {
            currentMealTags.push(...mf.tags);
          }
        });
        
        const hasReverseIncompatibilityConflict = foodIncompatibilityTags.some(incTag =>
          currentMealTags.some(mealTag =>
            mealTag.toLowerCase().includes(incTag.toLowerCase()) ||
            incTag.toLowerCase().includes(mealTag.toLowerCase())
          )
        );
        
        if (hasIncompatibilityConflict || hasReverseIncompatibilityConflict) {
          console.log('🚫 UYUMSUZLUK ÇAKIŞMASI:', {
            yemek: food.name,
            mevcutUyumsuzluklar: allCurrentIncompatibilityTags,
            yemekTaglar: foodTags,
            yemekUyumsuzluklar: foodIncompatibilityTags,
            mevcutTaglar: currentMealTags
          });
          return false;
        }
      }
      
      // Diğer standart kontroller
      if (typeof window.isSmartAltCandidateCompliant === 'function') {
        return window.isSmartAltCandidateCompliant(food, currentFood, context);
      }
      return true;
    });

    // Skorla: hedef-bazlı modda farklı algoritma, normal modda eski sistem
    const scoredFoods = candidatePool.map(food => {
      let score = 0;
      
      if (isTargetBasedMode && weeklyTargetGap) {
        // 🎯 YENİ HEDEF-BAZLI SKORLAMA
        console.log('🎯 DEBUG: Hedef-bazlı skorlama - food:', food.name);
        score = calculateTargetBasedScore(currentFood, food, weeklyTargetGap);
        
      } else if (mealTarget && currentMealTotals) {
        // ESKİ SİSTEM: Öğün hedefli skorlama
        console.log('🎯 DEBUG: Öğün hedefli skorlama kullanılıyor - food:', food.name);
        score = calculateSmartAltScore(
          currentMealTotals,
          mealTarget,
          currentFood,
          food,
          cfg
        );
      } else {
        // FALLBACK: Basit benzerlik
        console.log('⚠️ DEBUG: Basit benzerlik skorlaması kullanılıyor - food:', food.name);
        score = calculateSimilarityScore({
          calories: currentFood.calories || 0,
          protein: currentFood.protein || 0,
          carbs: currentFood.carbs || 0,
          fat: currentFood.fat || 0
        }, {
          calories: food.calories || 0,
          protein: food.protein || 0,
          carbs: food.carbs || 0,
          fat: food.fat || 0
        });
      }
      
      // 🤝 UYUMLULUK BONUSU UYGULA
      if (food._compatibilityBonus) {
        const bonusAmount = score * 0.15; // %15 bonus
        score += bonusAmount;
        console.log('🤝 UYUMLULUK BONUSU UYGULANDI:', {
          yemek: food.name,
          eskiSkor: (score - bonusAmount).toFixed(1),
          bonus: bonusAmount.toFixed(1),
          yeniSkor: score.toFixed(1)
        });
      }
      
      return { ...food, similarityScore: score };
    })
    .sort((a, b) => b.similarityScore - a.similarityScore)
    .slice(0, (window.SUGGESTION_LIMIT || 10));

    alternativeFoods = scoredFoods;
    window.alternativeFoods = alternativeFoods; // Global erişim için
    console.log('🔄 Bulunan alternatifler:', alternativeFoods.length);
    console.log('✅ alternatifleriBaslat başarıyla tamamlandı! Yeni alternativeFoods.length:', alternativeFoods.length);
    
    if (alternativeFoods.length === 0) {
      showToast('Bu yemeğe benzer alternatif bulunamadı!', 'warning');
      return;
    }
    
    // Alternatif modunu başlat
    alternativeModeActive = true;
    updateAlternativeControls();
    if (!options || !options.noAutoApply) {
      sonrakiAlternatifeGec();
    }
    
    if (!options || !options.noAutoApply) {
      showToast(`🔄 Alternatif mod başladı! ${alternativeFoods.length} seçenek bulundu. Sidebar'dan seçebilirsiniz.`, 'success', 4000);
    }
    
  } catch (error) {
    console.error('❌ Alternatif yemek hatası:', error);
    showToast('Alternatif yemekler yüklenirken hata: ' + error.message, 'error');
  }
}

function calculateSimilarityScore(macro1, macro2) {
  // Weighted similarity score - kalori ağırlığı daha yüksek
  const calorieWeight = 0.4;
  const proteinWeight = 0.25;
  const carbWeight = 0.2;
  const fatWeight = 0.15;
  
  // Normalize edilmiş farkları hesapla (0-100 arası)
  const calorieDiff = Math.abs(macro1.calories - macro2.calories);
  const proteinDiff = Math.abs(macro1.protein - macro2.protein);
  const carbDiff = Math.abs(macro1.carbs - macro2.carbs);
  const fatDiff = Math.abs(macro1.fat - macro2.fat);
  
  // Maksimum farklar (normalize etmek için)
  const maxCalorie = Math.max(macro1.calories, macro2.calories, 1);
  const maxProtein = Math.max(macro1.protein, macro2.protein, 1);
  const maxCarb = Math.max(macro1.carbs, macro2.carbs, 1);
  const maxFat = Math.max(macro1.fat, macro2.fat, 1);
  
  // Benzerlik skorları (1 = tamamen benzer, 0 = tamamen farklı)
  const calorieScore = 1 - (calorieDiff / maxCalorie);
  const proteinScore = 1 - (proteinDiff / maxProtein);
  const carbScore = 1 - (carbDiff / maxCarb);
  const fatScore = 1 - (fatDiff / maxFat);
  
  // Ağırlıklı toplam skor
  const totalScore = (
    calorieScore * calorieWeight +
    proteinScore * proteinWeight +
    carbScore * carbWeight +
    fatScore * fatWeight
  ) * 100;
  
  return Math.max(0, totalScore); // Negatif değerleri önle
}

// SMART_ALT: Öğün toplamlarını hesapla (mevcut tablo verisinden)
function computeMealTotalsFor(gun, ogun) {
  try {
    const rows = Array.isArray(window.currentFoodAnalysisData) ? window.currentFoodAnalysisData : [];
    let tCal = 0, tP = 0, tC = 0, tF = 0;
    for (const r of rows) {
      if (!r || r.gunOgunSatiri) continue;
      if (r.karalistede) continue;
      if (r.belongToGun !== gun || r.belongToOgun !== ogun) continue;
      if (!r.eslestiMi || !r.eslesenYemek) continue;
      const f = r.eslesenYemek;
      tCal += Number(f.calories || 0);
      tP += Number(f.protein || 0);
      tC += Number(f.carbs || 0);
      tF += Number(f.fat || 0);
    }
    return { calories: tCal, protein: tP, carbs: tC, fat: tF };
  } catch { return { calories: 0, protein: 0, carbs: 0, fat: 0 }; }
}

// SMART_ALT: Skor hesapla (hedefe yaklaşım) — kcal öncelikli; F>P>C ağırlıklandırma
function calculateSmartAltScore(currentTotals, mealTarget, currentFood, candidate, cfg) {
  try {
    const weights = (cfg && cfg.weights) || { kcal: 0.5, fat: 0.25, protein: 0.15, carbs: 0.10 };
    // Değişim sonrası yeni toplamlar
    const newTotals = {
      calories: (currentTotals.calories - (currentFood.calories || 0)) + (candidate.calories || 0),
      protein: (currentTotals.protein - (currentFood.protein || 0)) + (candidate.protein || 0),
      carbs: (currentTotals.carbs - (currentFood.carbs || 0)) + (candidate.carbs || 0),
      fat: (currentTotals.fat - (currentFood.fat || 0)) + (candidate.fat || 0)
    };
    // Hedefe göre relatif sapmalar (0 iyi, 1 kötü)
    const rel = (cur, tgt) => {
      const t = Number(tgt || 0); const c = Number(cur || 0);
      if (t <= 0) return 0;
      return Math.abs(c - t) / t;
    };
    const kcalRel = rel(newTotals.calories, mealTarget.kcal);
    const pRel = rel(newTotals.protein, mealTarget.p);
    const cRel = rel(newTotals.c, mealTarget.c);
    const fRel = rel(newTotals.fat, mealTarget.f);
    // Benzerlik skoru (1 = mükemmel)
    let score = (1 - kcalRel) * weights.kcal + (1 - fRel) * weights.fat + (1 - pRel) * weights.protein + (1 - cRel) * weights.carbs;
    // Toleransları aşanlara ceza uygula (kcal öncelikli)
    try {
      const kcalTol = cfg?.kcalTolerance ?? 0.10;
      const mTol = cfg?.macroTolerance || { protein: 0.15, fat: 0.15, carbs: 0.20 };
      const tolFail = (kcalRel > kcalTol) || (pRel > (mTol.protein ?? 0.15)) || (fRel > (mTol.fat ?? 0.15)) || (cRel > (mTol.carbs ?? 0.20));
      if (tolFail) score -= 0.5;
    } catch {}
    // Tercihlere ufak ayar (etiketler üzerinden basit örnek)
    try {
      const tags = Array.isArray(candidate.tags) ? candidate.tags.map(String) : [];
      if (tags.includes('like')) score += (cfg?.likesBoost || 0);
      if (tags.includes('dislike')) score -= (cfg?.dislikesPenalty || 0);
    } catch {}
    // 0-100 aralığına çevir ve sınırla
    return Math.max(0, Math.min(100, score * 100));
  } catch { return 0; }
}

// 📊 YENİ: Aktif haftanın ortalama istatistiklerini hesapla
function getActiveWeekAverageStats() {
    console.log('📊 HAFTALIK ORTALAMA STAT HESAPLANIYIR...');
    
    if (!window.currentFoodAnalysisData) {
        console.error('❌ currentFoodAnalysisData bulunamadı!');
        return null;
    }

    // Tablo satırlarını analiz et
    const tableRows = document.querySelectorAll('#veritabaniAnaliziContent table tbody tr');
    let gunMakrolari = new Map();
    let currentGun = null;

    // Her satırı analiz et - updateTotalRows mantığını kullan
    tableRows.forEach((row, rowIndex) => {
        const firstCell = row.querySelector('td');
        if (!firstCell) return;
        
        const cellText = firstCell.textContent.trim();
        const siraNo = row.getAttribute('data-sira-no');
        
        // Gün satırı mı kontrol et
        const isGunRow1 = cellText.includes('📅') && (
            cellText.includes('PAZARTESİ') || cellText.includes('SALI') || 
            cellText.includes('ÇARŞAMBA') || cellText.includes('PERŞEMBE') || 
            cellText.includes('CUMA') || cellText.includes('CUMARTESİ') || 
            cellText.includes('PAZAR')
        );
        
        const isGunRow2 = cellText.includes('Gün') && (
            cellText.includes('Pazartesi') || cellText.includes('Salı') || 
            cellText.includes('Çarşamba') || cellText.includes('Perşembe') || 
            cellText.includes('Cuma') || cellText.includes('Cumartesi') || 
            cellText.includes('Pazar')
        );
        
        if (isGunRow1 || isGunRow2) {
            currentGun = cellText;
            if (!gunMakrolari.has(currentGun)) {
                gunMakrolari.set(currentGun, { kalori: 0, protein: 0, karb: 0, yag: 0 });
            }
            return;
        }
        
        // Öğün satırı atlama
        if (cellText.includes('🍽️')) {
            return;
        }
        
        // Normal yemek satırı - sıra numarası varsa
        if (siraNo && siraNo !== 'null') {
            const item = window.currentFoodAnalysisData.find(data => data.siraNo == siraNo);
            
            if (item && item.eslestiMi && item.eslesenYemek && !item.gunOgunSatiri) {
                const kalori = item.eslesenYemek.calories || 0;
                const protein = item.eslesenYemek.protein || 0;
                const karb = item.eslesenYemek.carbs || 0;
                const yag = item.eslesenYemek.fat || 0;
                
                // Günlük toplama ekle
                if (currentGun && gunMakrolari.has(currentGun)) {
                    const gunTotal = gunMakrolari.get(currentGun);
                    gunTotal.kalori += kalori;
                    gunTotal.protein += protein;
                    gunTotal.karb += karb;
                    gunTotal.yag += yag;
                }
            }
        }
    });

    // Haftalık ortalama hesapla
    const gunSayisi = gunMakrolari.size;
    if (gunSayisi === 0) {
        console.warn('⚠️ Hiç gün verisi bulunamadı!');
        return null;
    }

    let toplamKalori = 0, toplamProtein = 0, toplamKarb = 0, toplamYag = 0;
    gunMakrolari.forEach((makro) => {
        toplamKalori += makro.kalori;
        toplamProtein += makro.protein;
        toplamKarb += makro.karb;
        toplamYag += makro.yag;
    });

    const weeklyAverages = {
        kalori: toplamKalori / gunSayisi,
        protein: toplamProtein / gunSayisi,
        karb: toplamKarb / gunSayisi,
        yag: toplamYag / gunSayisi,
        gunSayisi: gunSayisi
    };

    console.log('📊 HAFTALIK ORTALAMA HESAPLANDI:', weeklyAverages);
    return weeklyAverages;
}

// 🎯 YENİ: Hedef-bazlı skorlama algoritması
function calculateTargetBasedScore(currentFood, candidate, weeklyTargetGap) {
  try {
    console.log('🎯 calculateTargetBasedScore çağrıldı:', {
      currentFood: currentFood.name,
      candidate: candidate.name,
      gap: weeklyTargetGap.description
    });
    
    const currentCalories = currentFood.calories || 0;
    const candidateCalories = candidate.calories || 0;
    
    // ✅ KULLANICI İSTEĞİ: Haftalık gap % = Yemek değişim %
    // Eğer haftalık %20 eksikse → yemek %20 fazla olmalı
    // Eğer haftalık %15 fazlaysa → yemek %15 az olmalı
    
    const gapPercent = weeklyTargetGap.gapPercent; // pozitif = fazla, negatif = eksik
    
    // Hedef kaloriye göre ideal yemek kalori hesapla
    // Eksik ise (-) → daha fazla kalori (+)
    // Fazla ise (+) → daha az kalori (-)
    const idealCalories = currentCalories * (1 - (gapPercent / 100));
    
    console.log('📊 YENİ MANTIK - Hedef hesaplama:', {
      orijinalYemek: currentCalories,
      haftalikGap: `${gapPercent.toFixed(1)}%`,
      idealYemekKalori: idealCalories.toFixed(1),
      adayYemek: candidateCalories,
      mantik: gapPercent > 0 ? 'FAZLA → Daha az kalorili yemek ara' : 'EKSİK → Daha fazla kalorili yemek ara'
    });
    
    // İdeal kaloriye ne kadar yakın?
    const idealDistance = Math.abs(candidateCalories - idealCalories);
    const referenceCalorie = Math.max(currentCalories, idealCalories);
    const normalizedDistance = idealDistance / referenceCalorie;
    
    // Skor: 0-100 arası (yakın olması = yüksek skor)
    const proximityScore = Math.max(0, 100 - (normalizedDistance * 100));
    
    // Doğru yön bonusu
    let directionBonus = 0;
    const isMovingCorrectDirection = 
      (gapPercent > 0 && candidateCalories < currentCalories) || // Fazla → düşük kalori
      (gapPercent < 0 && candidateCalories > currentCalories);   // Eksik → yüksek kalori
    
    if (isMovingCorrectDirection) {
      directionBonus = 15; // Doğru yöne hareket bonusu
    }
    
    const finalScore = Math.min(100, proximityScore + directionBonus);
    
    console.log('📊 SKOR HESAPLAMA:', {
      idealDistance: idealDistance.toFixed(1),
      normalizedDistance: normalizedDistance.toFixed(3),
      proximityScore: proximityScore.toFixed(1),
      directionBonus,
      finalScore: finalScore.toFixed(1)
    });
    
    return finalScore;
    
    console.log('🎯 Skor hesaplaması:', {
      caloriesDiff,
      calorieScore: calorieScore.toFixed(1),
      directionBonus,
      finalScore: finalScore.toFixed(1)
    });
    
    return finalScore;
    
  } catch (e) {
    console.error('❌ calculateTargetBasedScore hata:', e);
    return 0;
  }
}

function sonrakiAlternatifeGec() {
  if (!alternativeModeActive || alternativeFoods.length === 0) {
    return;
  }
  
  // Döngüsel olarak sonraki alternatife geç
  const alternative = alternativeFoods[currentAlternativeStep % alternativeFoods.length];
  currentAlternativeStep++;
  
  console.log(`🔄 Alternatif ${currentAlternativeStep}/${alternativeFoods.length}:`, alternative);
  
  // Mevcut yemek verisini güncelle
  const currentItem = window.currentFoodAnalysisData[currentAlternativeIndex];
  currentItem.eslesenYemek = {
    ...alternative,
    originalName: alternative.name
  };
  
  // Sidebar kontrollerini güncelle
  updateAlternativeControls();
  
  // Sadece ilgili satırı güncelle (tüm tabloyu yeniden render etme)
  updateFoodTableRow(currentAlternativeIndex, currentItem);
  
  // Bilgi mesajı göster
  const scoreText = alternative.similarityScore ? ` (Benzerlik: ${alternative.similarityScore.toFixed(1)}%)` : '';
  showToast(`🔄 ${alternative.name}${scoreText}`, 'info', 2000);
}

function alternatifleriDurdur() {
  if (!alternativeModeActive) {
    return;
  }
  
  console.log('⏹️ Alternatif mod durduruluyor');
  
  alternativeModeActive = false;
  currentAlternativeIndex = -1;
  alternativeFoods = [];
  currentAlternativeStep = 0;
  
  updateAlternativeControls();
  showToast('⏹️ Alternatif mod durduruldu', 'info');
}

function orijinalYemegiGeriYukle() {
  if (!originalFoodData || currentAlternativeIndex === -1) {
    showToast('Geri yüklenecek orijinal yemek bulunamadı!', 'warning');
    return;
  }
  
  console.log('↩️ Orijinal yemek geri yükleniyor:', originalFoodData);
  
  // Orijinal veriyi geri yükle
  const currentItem = window.currentFoodAnalysisData[currentAlternativeIndex];
  currentItem.eslesenYemek = { ...originalFoodData };
  
  // Alternatif modu durdur
  alternatifleriDurdur();
  
  // Sadece ilgili satırı güncelle (tüm tabloyu yeniden render etme)
  updateFoodTableRow(currentAlternativeIndex, currentItem);
  
  showToast('↩️ Orijinal yemek geri yüklendi', 'success');
  
  // Veriyi temizle
  originalFoodData = null;
}

// 🎯 Satır için hedefe göre alternatifleri sidebar'da göster ve kullanıcının seçmesini bekle
async function smartHedefeGoreSec(index) {
  console.log('🚀 YENI smartHedefeGoreSec çağrıldı! Timestamp:', Date.now(), 'index:', index);
  try {
    console.log('🔍 smartHedefeGoreSec çağrıldı, index:', index, ', alternativeModeActive:', alternativeModeActive, ', currentAlternativeIndex:', currentAlternativeIndex);
    
    if (!Array.isArray(window.currentFoodAnalysisData)) return;
    const item = window.currentFoodAnalysisData[index];
    if (!item || !item.eslestiMi || !item.eslesenYemek) {
      showToast('Bu satırda eşleşen yemek yok. Önce eşleştirin.', 'warning');
      return;
    }
    
    // Eğer zaten bu satır için alternatif mod aktifse, sıradaki alternatifi uygula
    if (alternativeModeActive && currentAlternativeIndex === index && Array.isArray(window.alternativeFoods) && window.alternativeFoods.length > 0) {
      console.log('🔍 DEBUG: currentAlternativeStep =', currentAlternativeStep, ', alternativeFoods.length =', window.alternativeFoods.length);
      
      // 🚫 ZATEN SEÇİLMİŞ YEMEKLERİ ATLAYAN AKILLI DÖNGÜ
      let attempts = 0;
      const maxAttempts = window.alternativeFoods.length + 2; // Orijinal + tüm alternatifleri döngüde en fazla 1 kez dene
      let foundValidAlternative = false;
      
      while (!foundValidAlternative && attempts < maxAttempts) {
        currentAlternativeStep = (currentAlternativeStep) % (window.alternativeFoods.length + 1);
        console.log('🔍 DEBUG: Denenen step =', currentAlternativeStep, ', attempt =', attempts + 1);
        
        if (currentAlternativeStep === 0) {
          // Orijinal yemek kontrolü
          foundValidAlternative = true; // Orijinal yemeği her zaman geçerli kabul et
        } else {
          // Alternatif yemek kontrolü - zaten seçilmiş mi?
          const altIndex = currentAlternativeStep - 1;
          const candidate = window.alternativeFoods[altIndex];
          
          if (candidate) {
            // Aynı öğünde bu yemek zaten seçili mi kontrol et
            const currentItem = window.currentFoodAnalysisData[currentAlternativeIndex];
            if (currentItem) {
              const sameGun = currentItem.belongToGun;
              const sameOgun = currentItem.belongToOgun;
              
              const alreadySelected = (window.currentFoodAnalysisData || []).some(item => {
                if (!item.gunOgunSatiri && !item.karalistede && 
                    item.belongToGun === sameGun && 
                    item.belongToOgun === sameOgun &&
                    item.eslestiMi && item.eslesenYemek) {
                  const itemName = (item.eslesenYemek.name || item.eslesenYemek.originalName || '').toLowerCase();
                  const candidateName = (candidate.name || candidate.originalName || '').toLowerCase();
                  return itemName === candidateName;
                }
                return false;
              });
              
              if (!alreadySelected) {
                foundValidAlternative = true;
                console.log('✅ Geçerli alternatif bulundu:', candidate.name);
              } else {
                console.log('🚫 Atlanan (zaten seçili):', candidate.name);
              }
            }
          }
        }
        
        attempts++;
        if (!foundValidAlternative) {
          currentAlternativeStep++;
        }
      }
      
      // Geçerli alternatif bulunamadıysa orijinale dön
      if (!foundValidAlternative) {
        currentAlternativeStep = 0;
        console.log('⚠️ Hiçbir geçerli alternatif bulunamadı, orijinale dönülüyor');
      }
      
      if (currentAlternativeStep === 0) {
        // Orijinal yemeği seç
        alternatifSec('original');
        const currentItem = window.currentFoodAnalysisData[currentAlternativeIndex];
        console.log('🔍 DEBUG döngü - currentItem (orijinal):', currentItem);
        console.log('🔍 DEBUG döngü - currentAlternativeIndex:', currentAlternativeIndex);
        updateFoodTableRow(currentAlternativeIndex, currentItem);
        console.log('🔄 Otomatik döngü: Orijinal yemek seçildi');
        
        // Orijinal için yeni alternatifler hesapla
        console.log('🔄 Orijinal yemek için alternatifler yeniden hesaplanıyor...');
        try {
          await alternatifleriBaslat(currentItem.eslesenYemek, { noAutoApply: true });
          console.log('✅ Orijinal için yeni alternatifler hesaplandı, sayı:', window.alternativeFoods?.length || 0);
        } catch (e) {
          console.error('❌ Orijinal için yeni alternatifler hesaplanamadı:', e);
        }
        
        showToast('↩️ Orijinal yemek geri yüklendi! Tekrar tıklayın → 1. alternatif', 'success', 3000);
      } else {
        // Alternatifi seç (currentAlternativeStep - 1 çünkü index 0'dan başlar)
        const altIndex = currentAlternativeStep - 1;
        const selectedAlt = window.alternativeFoods[altIndex];
        alternatifSec(altIndex);
        const currentItem = window.currentFoodAnalysisData[currentAlternativeIndex];
        console.log('🔍 DEBUG döngü - currentItem (alternatif):', currentItem);
        console.log('🔍 DEBUG döngü - currentAlternativeIndex:', currentAlternativeIndex);
        updateFoodTableRow(currentAlternativeIndex, currentItem);
        console.log('🔄 Otomatik döngü: Alternatif', altIndex, 'seçildi:', selectedAlt?.name);
        
        // Seçilen alternatif için yeni alternatifler hesapla
        console.log('🔄 Yeni seçilen yemek için alternatifler yeniden hesaplanıyor...');
        try {
          await alternatifleriBaslat(currentItem.eslesenYemek, { noAutoApply: true });
          console.log('✅ Yeni alternatifler hesaplandı, sayı:', window.alternativeFoods?.length || 0);
        } catch (e) {
          console.error('❌ Yeni alternatifler hesaplanamadı:', e);
        }
        
        const kalan = window.alternativeFoods.length - currentAlternativeStep;
        showToast(`🔄 Alternatif ${currentAlternativeStep}/${window.alternativeFoods.length} uygulandı! ${kalan} alternatif kaldı`, 'info', 2500);
      }
      
      // Döngü için step'i artır
      currentAlternativeStep++;
      
      return;
    }
    
    // İlk kez çağrılıyorsa, alternatif mod durumunu ayarla ve adayları hazırla
    originalFoodData = { ...item.eslesenYemek };
    currentAlternativeIndex = index;
    currentAlternativeStep = 0; // Step sıfırla
    alternativeModeActive = true; // Alternatif mod aktif
    
    console.log('🔍 DEBUG: Alternatif mod başlatıldı, alternativeModeActive:', alternativeModeActive);
    console.log('🔍 DEBUG: Yeni satır için mod başlatıldı, currentAlternativeStep sıfırlandı:', currentAlternativeStep);
    
    // Hedefe göre alternatifleri başlat (sidebar gösterecek)
    await alternatifleriBaslat(item.eslesenYemek, { noAutoApply: true });
    
    if (!Array.isArray(window.alternativeFoods) || window.alternativeFoods.length === 0) {
      showToast('Uygun alternatif bulunamadı.', 'warning');
      return;
    }
    
    // İlk alternatifi otomatik uygula
    alternatifSec(0);
    const currentItem = window.currentFoodAnalysisData[currentAlternativeIndex];
    console.log('🔍 DEBUG ilk alternatif - currentItem:', currentItem);
    console.log('🔍 DEBUG ilk alternatif - currentAlternativeIndex:', currentAlternativeIndex);
    updateFoodTableRow(currentAlternativeIndex, currentItem); // Item parametresi ile tablo güncelle
    currentAlternativeStep = 1; // İlk alternatif uygulandı, bir sonraki tıklamada 2. alternatif gelecek
    console.log('🔍 DEBUG: İlk alternatif uygulandı, currentAlternativeStep =', currentAlternativeStep);
    showToast(`🎯 ${window.alternativeFoods.length} hedefe uygun alternatif bulundu! İlk alternatif uygulandı (Tekrar tıklayın → sonraki)`, 'success', 4000);
    
  } catch (e) {
    console.error('smartHedefeGoreSec error:', e);
    showToast('Hedefe göre alternatifler yüklenemedi: ' + (e?.message || e), 'error');
  }
}

// 🌟 Gün içinde dengeleme: Satır veya öğün bazlı
async function gunIcindeDengele(mode) {
  try {
    showToast(`🔄 ${mode === 'satir' ? 'Satır' : 'Öğün'} bazlı dengeleme başlatılıyor...`, 'info');
    
    if (mode === 'satir') {
      // Satır bazlı: Her eşleşen satırı hedefe göre optimize et
      if (!Array.isArray(window.currentFoodAnalysisData)) {
        showToast('Analiz verisi bulunamadı.', 'warning');
        return;
      }
      
      let degisikenSayisi = 0;
      const rows = window.currentFoodAnalysisData.filter(item => 
        item && !item.gunOgunSatiri && !item.karalistede && item.eslestiMi && item.eslesenYemek
      );
      
      for (let i = 0; i < rows.length; i++) {
        const item = rows[i];
        const index = window.currentFoodAnalysisData.indexOf(item);
        if (index === -1) continue;
        
        try {
          // Her satır için hedefe göre en iyi alternatifi bul
          const oldFood = { ...item.eslesenYemek };
          originalFoodData = oldFood;
          currentAlternativeIndex = index;
          currentAlternativeStep = 0;
          
          await alternatifleriBaslat(item.eslesenYemek, { noAutoApply: true });
          
          if (Array.isArray(window.alternativeFoods) && window.alternativeFoods.length > 0) {
            const best = window.alternativeFoods[0];
            
            // Sadece gerçekten daha iyi skorsa değiştir
            if (best.similarityScore > 50) { // Minimum kalite eşiği
              item.eslesenYemek = { ...best, originalName: best.name };
              degisikenSayisi++;
              
              // Undo snapshot
              try {
                if (typeof window.pushSmartAltUndo === 'function') {
                  window.pushSmartAltUndo({
                    type: 'batchReplace',
                    index,
                    gun: item.belongToGun,
                    ogun: item.belongToOgun,
                    before: oldFood,
                    after: { ...best },
                    ts: Date.now()
                  });
                }
              } catch {}
            }
          }
        } catch (e) {
          console.warn(`Satır ${index} optimize edilemedi:`, e);
        }
      }
      
      // Alternatif modu kapat ve tabloyu yenile
      alternatifleriDurdur();
      await analizYap(); // Tabloyu tamamen yenile
      showToast(`✅ ${degisikenSayisi} satır optimize edildi.`, 'success');
      
    } else if (mode === 'ogun') {
      // Öğün bazlı: Her öğün için en uygun şablonu uygula
      const presentMeals = getPresentMealKeysInActiveWeek();
      const gunAdi = 'Pazartesi'; // İlk günü varsayılan al - geliştirilecek
      let uygulananagunSayisi = 0;
      
      for (const ogunKey of presentMeals) {
        const ogunAdi = mealKeyToLabel(ogunKey);
        try {
          // Mevcut applyBestMealAlternative fonksiyonunu kullan
          if (typeof window.applyBestMealAlternative === 'function') {
            await window.applyBestMealAlternative(gunAdi, ogunAdi);
            uygulananagunSayisi++;
          }
        } catch (e) {
          console.warn(`${ogunAdi} optimize edilemedi:`, e);
        }
      }
      
      await analizYap(); // Tabloyu tamamen yenile
      showToast(`✅ ${uygulananagunSayisi} öğün optimize edildi.`, 'success');
    }
    
  } catch (e) {
    console.error('gunIcindeDengele error:', e);
    showToast('Dengeleme sırasında hata: ' + (e?.message || e), 'error');
  }
}

function updateAlternativeControls() {
  const controlsDiv = document.getElementById('alternativeControls');
  const infoDiv = document.getElementById('alternativeInfo');
  const listDiv = document.getElementById('alternativeList');
  const araclarBolumu = document.getElementById('araclarBolumu');
  const rightSidebar = document.querySelector('.right-sidebar');
  
  if (!controlsDiv || !infoDiv || !listDiv || !araclarBolumu || !rightSidebar) {
    return;
  }
  
  if (alternativeModeActive) {
    // Alternatif mod aktif: kontrolleri göster ve araçları alta taşı
    controlsDiv.style.display = 'block';
    listDiv.style.display = 'block';
    
    // Araçlar bölümünü alternatif kontrollerinin altına taşı
    if (controlsDiv.nextElementSibling !== araclarBolumu) {
      controlsDiv.parentNode.insertBefore(araclarBolumu, controlsDiv.nextElementSibling);
    }
    
    const currentItem = window.currentFoodAnalysisData[currentAlternativeIndex];
    const currentFood = currentItem ? currentItem.eslesenYemek : null;
    
    if (currentFood) {
      // Hangi butondan geldiğini belirle (global flag)
      const isSmartMode = window.lastAlternativeCallType === 'smart';
      const modeIcon = isSmartMode ? '🎯' : '🔄';
      const modeText = isSmartMode ? 'HEDEFE GÖRE' : 'BENZER YEMEKLER';
      
      infoDiv.innerHTML = `
        <div style="padding: 4px 8px; background: ${isSmartMode ? '#e3f2fd' : '#f3e5f5'}; border-radius: 4px; margin-bottom: 8px; border-left: 3px solid ${isSmartMode ? '#2196f3' : '#9c27b0'};">
          <small style="font-weight: bold; color: ${isSmartMode ? '#1976d2' : '#7b1fa2'};">${modeIcon} ${modeText}</small>
        </div>
        <strong>Aktif Yemek:</strong><br>
        ${currentFood.name}<br>
        <small>Adım: ${currentAlternativeStep}/${alternativeFoods.length}</small><br>
        <small>${currentFood.calories || 0} kcal</small>
      `;
      
      // Alternatif liste oluştur
      renderAlternativeList();
    } else {
      infoDiv.innerHTML = 'Alternatif mod aktif';
      listDiv.innerHTML = '';
    }
  } else {
    // Alternatif mod kapalı: kontrolleri gizle ve araçları orijinal yerine taşı
    controlsDiv.style.display = 'none';
    listDiv.style.display = 'none';
    infoDiv.innerHTML = 'Alternatif mod aktif değil';
    
    // Araçlar bölümünü alternatif kontrollerinden önceye taşı (orijinal konum)
    const islemlerSection = rightSidebar.children[0]; // İlk child (⚡ İşlemler)
    if (islemlerSection && araclarBolumu.previousElementSibling !== islemlerSection) {
      rightSidebar.insertBefore(araclarBolumu, controlsDiv);
    }
  }
}

function renderAlternativeList() {
  console.log('🎨 YENI renderAlternativeList çağrıldı! Timestamp:', Date.now());
  const listDiv = document.getElementById('alternativeList');
  if (!listDiv || !alternativeFoods || alternativeFoods.length === 0) {
    console.log('❌ renderAlternativeList: listDiv, alternativeFoods veya length eksik');
    return;
  }
  
  console.log('🎨 renderAlternativeList: alternativeFoods.length =', alternativeFoods.length);
  
  const currentItem = window.currentFoodAnalysisData[currentAlternativeIndex];
  const currentFoodName = currentItem ? currentItem.eslesenYemek.name : '';
  console.log('🎨 renderAlternativeList: currentFoodName =', currentFoodName);
  
  // Mevcut öğün hedeflerini hesapla
  let mealTargets = null;
  if (currentItem && currentItem.gunOgunSatiri) {
    try {
      const [gun, ogun] = currentItem.gunOgunSatiri.split('_');
      if (gun && ogun) {
        const mealData = computeMealTotalsFor(gun, ogun);
        if (mealData && mealData.targets) {
          mealTargets = mealData.targets;
        }
      }
    } catch (e) {
      console.warn('Öğün hedefleri hesaplanamadı:', e);
    }
  }
  
  let html = '';
  
  // Orijinal yemeği en üste ekle
  if (originalFoodData) {
    const isActive = currentFoodName === originalFoodData.originalName;
    
    // Kalori farkı hesapla
    let caloriesDiffText = '';
    if (mealTargets && mealTargets.kcal) {
      const caloriesDiff = (originalFoodData.calories || 0) - mealTargets.kcal;
      const diffSign = caloriesDiff >= 0 ? '+' : '';
      const diffColor = caloriesDiff > 0 ? '#dc3545' : '#28a745';
      caloriesDiffText = ` • <span style="color: ${diffColor}; font-weight: bold;">${diffSign}${caloriesDiff.toFixed(0)} kcal</span>`;
    }
    
    html += `
      <div onclick="alternatifSec('original')" 
           style="padding: 8px; border-bottom: 1px solid #eee; cursor: pointer; background: ${isActive ? '#e8f5e8' : 'white'}; font-size: 10px; transition: background 0.2s;"
           onmouseover="this.style.background='#f0f8ff'" 
           onmouseout="this.style.background='${isActive ? '#e8f5e8' : 'white'}'">
        <div style="font-weight: bold; color: #28a745; margin-bottom: 2px;">
          ${isActive ? '✅ ' : ''}🔄 ${originalFoodData.originalName} (ORİJİNAL)
        </div>
        <div style="color: #666; font-size: 9px;">
          ${originalFoodData.calories || 0} kcal • P:${originalFoodData.protein || 0}g • K:${originalFoodData.carbs || 0}g • Y:${originalFoodData.fat || 0}g${caloriesDiffText}
        </div>
      </div>
    `;
  }
  
  // Alternatif yemekleri ekle
  alternativeFoods.forEach((food, index) => {
    const isActive = currentFoodName === food.name;
    const scoreText = food.similarityScore ? ` • ${food.similarityScore.toFixed(0)}%` : '';
    
    // 🚫 ZATEN SEÇİLMİŞ YEMEK KONTROLÜ (sidebar görünümü için)
    let alreadySelectedInMeal = false;
    if (currentItem) {
      const sameGun = currentItem.belongToGun;
      const sameOgun = currentItem.belongToOgun;
      const currentRowIndex = currentAlternativeIndex; // Şu anda aktif olan satır
      
      alreadySelectedInMeal = (window.currentFoodAnalysisData || []).some((item, itemIndex) => {
        // Şu anda aktif düzenlenen satırı hariç tut
        if (itemIndex === currentRowIndex) return false;
        
        if (!item.gunOgunSatiri && !item.karalistede && 
            item.belongToGun === sameGun && 
            item.belongToOgun === sameOgun &&
            item.eslestiMi && item.eslesenYemek) {
          const itemName = (item.eslesenYemek.name || item.eslesenYemek.originalName || '').toLowerCase();
          const foodName = (food.name || food.originalName || '').toLowerCase();
          return itemName === foodName;
        }
        return false;
      });
    }
    
    // Kalori farkı hesapla - SMART mode'da orijinal ile karşılaştır
    let caloriesDiffText = '';
    const isSmartMode = window.lastAlternativeCallType === 'smart';
    
    if (isSmartMode && originalFoodData) {
      // Hedefe göre modda: orijinal yemek ile karşılaştır
      const caloriesDiff = (food.calories || 0) - (originalFoodData.calories || 0);
      const diffSign = caloriesDiff >= 0 ? '+' : '';
      const diffColor = caloriesDiff > 0 ? '#dc3545' : caloriesDiff < 0 ? '#28a745' : '#6c757d';
      caloriesDiffText = ` • <span style="color: ${diffColor}; font-weight: bold;">(${diffSign}${caloriesDiff.toFixed(0)} kcal)</span>`;
    } else if (mealTargets && mealTargets.kcal) {
      // Normal modda: hedef ile karşılaştır
      const caloriesDiff = (food.calories || 0) - mealTargets.kcal;
      const diffSign = caloriesDiff >= 0 ? '+' : '';
      const diffColor = caloriesDiff > 0 ? '#dc3545' : '#28a745';
      caloriesDiffText = ` • <span style="color: ${diffColor}; font-weight: bold;">${diffSign}${caloriesDiff.toFixed(0)} kcal</span>`;
    }
    
    // Üstü çizili stil ve tıklama engellemesi
    const strikethroughStyle = alreadySelectedInMeal ? 'text-decoration: line-through; opacity: 0.6;' : '';
    const clickAction = alreadySelectedInMeal ? '' : `onclick="alternatifSec(${index})"`;
    const cursorStyle = alreadySelectedInMeal ? 'cursor: not-allowed;' : 'cursor: pointer;';
    const backgroundHover = alreadySelectedInMeal ? '' : `onmouseover="this.style.background='#f0f8ff'" onmouseout="this.style.background='${isActive ? '#e8f5e8' : 'white'}'"`;
    const statusIcon = alreadySelectedInMeal ? '🚫 ' : (food._compatibilityBonus ? '🤝 ' : '');
    
    html += `
      <div ${clickAction} 
           style="padding: 8px; border-bottom: 1px solid #eee; ${cursorStyle} background: ${isActive ? '#e8f5e8' : 'white'}; font-size: 10px; transition: background 0.2s; ${strikethroughStyle}"
           ${backgroundHover}>
        <div style="font-weight: bold; color: ${alreadySelectedInMeal ? '#6c757d' : '#17a2b8'}; margin-bottom: 2px;">
          ${isActive ? '✅ ' : ''}${statusIcon}${food.name}${scoreText}
          ${alreadySelectedInMeal ? ' (Zaten seçili)' : ''}
        </div>
        <div style="color: #666; font-size: 9px;">
          ${food.calories || 0} kcal • P:${food.protein || 0}g • K:${food.carbs || 0}g • Y:${food.fat || 0}g${caloriesDiffText}
        </div>
        <div style="color: #888; font-size: 8px; margin-top: 1px;">
          ${food.category || 'Kategori yok'}
        </div>
      </div>
    `;
  });
  
  listDiv.innerHTML = html;
}

function updateFoodTableRow(index, item) {
  console.log('🔄 Sadece tablo satırı güncelleniyor, index:', index);
  
  // Güvenlik kontrolü: item parametresi var mı?
  if (!item) {
    console.error('❌ updateFoodTableRow: item parametresi undefined!', { index, item });
    return;
  }
  
  // tarifAdi özelliği var mı kontrol et
  if (!item.tarifAdi) {
    console.error('❌ updateFoodTableRow: item.tarifAdi undefined!', { index, item });
    return;
  }
  
  console.log('🔍 İtem details:', {
    tarifAdi: item.tarifAdi,
    siraNo: item.siraNo,
    gunOgunSatiri: item.gunOgunSatiri
  });
  
  // Sıra numarasına göre doğru satırı bul (data-sira-no attribute kullanarak)
  const targetRow = document.querySelector(`#veritabaniAnaliziContent table tbody tr[data-sira-no="${item.siraNo}"]`);
  
  if (!targetRow) {
    console.warn('⚠️ Sıra numarası ile tablo satırı bulunamadı:', item.siraNo);
    
    // Alternatif: tüm satırları kontrol et
    const allRows = document.querySelectorAll('#veritabaniAnaliziContent table tbody tr');
    console.log('🔍 Tablo satır sayısı:', allRows.length);
    allRows.forEach((row, i) => {
      const siraNo = row.getAttribute('data-sira-no');
      console.log(`🔍 Satır ${i}: data-sira-no="${siraNo}"`);
    });
    return;
  }
  
  console.log('✅ Doğru satır bulundu:', targetRow);
  
  // Sadece makro değerleri güncelle
  const cells = targetRow.querySelectorAll('td');
  if (cells.length >= 6) {
    let kalori = 0, protein = 0, karb = 0, yag = 0;
    
    if (item.eslestiMi && item.eslesenYemek) {
      kalori = item.eslesenYemek.calories || 0;
      protein = item.eslesenYemek.protein || 0;
      karb = item.eslesenYemek.carbs || 0;
      yag = item.eslesenYemek.fat || 0;
    }
    
    // Yemek adını güncelle (0. sütun)
    const nameCell = cells[0];
    if (nameCell && item.eslesenYemek) {
      const nameSpan = nameCell.querySelector('span:last-child');
      if (nameSpan) {
        nameSpan.innerHTML = `<span style="font-weight: normal; color: #333;">
          🔄 ${item.eslesenYemek.name || item.eslesenYemek.originalName} (ALTERNATİF)
        </span>`;
      }
    }
    
    // Kalori (1. sütun)
    cells[1].innerHTML = `<span style="font-weight: bold;">${kalori}</span>`;
    
    // Karbonhidrat (2. sütun) 
    cells[2].innerHTML = `<span style="font-weight: bold;">${karb.toFixed(1)}</span>`;
    
    // Protein (3. sütun)
    cells[3].innerHTML = `<span style="font-weight: bold;">${protein.toFixed(1)}</span>`;
    
    // Yağ (4. sütun)
    cells[4].innerHTML = `<span style="font-weight: bold;">${yag.toFixed(1)}</span>`;
    
    // Satırın rengini değiştir (alternatif göstergesi)
    targetRow.style.background = 'linear-gradient(90deg, #e8f5e8 0%, #f0f8f0 100%)';
    targetRow.style.borderLeft = '4px solid #17a2b8';
    
    console.log('✅ Tablo satırı güncellendi:', {
      siraNo: item.siraNo,
      yemek: item.eslesenYemek.name,
      kalori,
      protein,
      karb,
      yag
    });
    
    // Toplam satırlarını da güncelle
    updateTotalRows();
  } else {
    console.warn('⚠️ Yeterli sütun bulunamadı:', cells.length);
  }
}

function updateTotalRows() {
  console.log('📊 Toplam satırları güncelleniyor...');
  console.log('📊 currentFoodAnalysisData uzunluk:', window.currentFoodAnalysisData?.length);
  
  if (!window.currentFoodAnalysisData) {
    console.error('❌ currentFoodAnalysisData bulunamadı!');
    return;
  }

  // Tablo satırlarını sırasıyla analiz et
  const tableRows = document.querySelectorAll('#veritabaniAnaliziContent table tbody tr');
  console.log('📊 Toplam tablo satır sayısı:', tableRows.length);
  
  let currentGun = null;
  let currentOgun = null;
  let gunMakrolari = new Map(); // Gun adı -> makrolar
  let ogunMakrolari = new Map(); // Öğün satır index -> makrolar
  
  // Her satırı analiz et
  tableRows.forEach((row, rowIndex) => {
    const firstCell = row.querySelector('td');
    if (!firstCell) return;
    
    const cellText = firstCell.textContent.trim();
    const siraNo = row.getAttribute('data-sira-no');
    
    // Gün satırı mı kontrol et - iki format destekle
    // Format 1: "📅 PAZARTESİ", "📅 SALI" vb.
    // Format 2: "1. Gün (Pazartesi)" vb.
    const isGunRow1 = cellText.includes('📅') && (
      cellText.includes('PAZARTESİ') || cellText.includes('SALI') || 
      cellText.includes('ÇARŞAMBA') || cellText.includes('PERŞEMBE') || 
      cellText.includes('CUMA') || cellText.includes('CUMARTESİ') || 
      cellText.includes('PAZAR')
    );
    
    const isGunRow2 = cellText.includes('Gün') && (
      cellText.includes('Pazartesi') || cellText.includes('Salı') || 
      cellText.includes('Çarşamba') || cellText.includes('Perşembe') || 
      cellText.includes('Cuma') || cellText.includes('Cumartesi') || 
      cellText.includes('Pazar')
    );
    
    // Fallback gün kontrolü (VARSAYILAN GÜN)
    const isFallbackGun = cellText.includes('VARSAYILAN GÜN');
    
    if (isGunRow1 || isGunRow2 || isFallbackGun) {
      currentGun = cellText;
      currentOgun = null;
      
      if (!gunMakrolari.has(currentGun)) {
        gunMakrolari.set(currentGun, { kalori: 0, protein: 0, karb: 0, yag: 0, rowIndex });
      }
      console.log('🗓️ Yeni gün tespit edildi:', currentGun, 'rowIndex:', rowIndex);
      return;
    }
    
    // Öğün satırı mı kontrol et (🍽️ ile başlayan)
    if (cellText.includes('🍽️')) {
      currentOgun = rowIndex;
      ogunMakrolari.set(currentOgun, { kalori: 0, protein: 0, karb: 0, yag: 0 });
      console.log('🍽️ Yeni öğün tespit edildi:', cellText, 'Row:', rowIndex);
      return;
    }
    
    // Normal yemek satırı - sıra numarası varsa
    if (siraNo && siraNo !== 'null') {
      const item = window.currentFoodAnalysisData.find(data => data.siraNo == siraNo);
      
      if (item && item.eslestiMi && item.eslesenYemek && !item.gunOgunSatiri) {
        const kalori = item.eslesenYemek.calories || 0;
        const protein = item.eslesenYemek.protein || 0;
        const karb = item.eslesenYemek.carbs || 0;
        const yag = item.eslesenYemek.fat || 0;
        
        console.log('🍎 Yemek verisi ekleniyor:', {
          siraNo,
          yemek: item.eslesenYemek.name,
          kalori, protein, karb, yag,
          currentGun, currentOgun
        });
        
        // Günlük toplama ekle
        if (currentGun && gunMakrolari.has(currentGun)) {
          const gunTotal = gunMakrolari.get(currentGun);
          gunTotal.kalori += kalori;
          gunTotal.protein += protein;
          gunTotal.karb += karb;
          gunTotal.yag += yag;
          console.log('📅 Gün toplamına eklendi:', currentGun, 'yeni toplam:', gunTotal);
        } else {
          console.warn('⚠️ Gün bulunamadı veya mevcut değil:', currentGun);
        }
        
        // Öğün toplama ekle
        if (currentOgun !== null && ogunMakrolari.has(currentOgun)) {
          const ogunTotal = ogunMakrolari.get(currentOgun);
          ogunTotal.kalori += kalori;
          ogunTotal.protein += protein;
          ogunTotal.karb += karb;
          ogunTotal.yag += yag;
          console.log('🍽️ Öğün toplamına eklendi:', currentOgun, 'yeni toplam:', ogunTotal);
        } else {
          console.warn('⚠️ Öğün bulunamadı veya mevcut değil:', currentOgun);
        }
      } else {
        if (!item) {
          console.log('⚪ Sıra numarası için veri yok:', siraNo);
        } else if (!item.eslestiMi) {
          console.log('⚪ Eşleşmemiş yemek:', siraNo);
        } else if (item.gunOgunSatiri) {
          console.log('⚪ Gün/öğün satırı:', siraNo);
        }
      }
    } else {
      console.log('⚪ Sıra numarası yok:', cellText.substring(0, 50));
    }
  });

  // Gün satırlarını güncelle
  console.log('🔄 Gün satırları güncelleniyor, toplam gün:', gunMakrolari.size);
  gunMakrolari.forEach((makro, gunAdi) => {
    console.log('📅 Güncellenen gün:', gunAdi, 'rowIndex:', makro.rowIndex, 'makrolar:', makro);
    const gunRow = tableRows[makro.rowIndex];
    if (gunRow) {
      const cells = gunRow.querySelectorAll('td');
      console.log('📅 Gün satırında hücre sayısı:', cells.length);
      if (cells.length >= 5) {
        cells[1].innerHTML = `<strong style="color: #2196F3;">${makro.kalori.toFixed(0)}</strong>`;
        cells[2].innerHTML = `<strong style="color: #2196F3;">${makro.karb.toFixed(1)}</strong>`;
        cells[3].innerHTML = `<strong style="color: #2196F3;">${makro.protein.toFixed(1)}</strong>`;
        cells[4].innerHTML = `<strong style="color: #2196F3;">${makro.yag.toFixed(1)}</strong>`;
        console.log(`✅ ${gunAdi} günü güncellendi:`, makro);
      } else {
        console.warn('⚠️ Gün satırında yeterli hücre yok:', cells.length);
      }
    } else {
      console.warn('⚠️ Gün satırı bulunamadı, rowIndex:', makro.rowIndex);
    }
  });

  // Öğün satırlarını güncelle
  ogunMakrolari.forEach((makro, ogunRowIndex) => {
    const ogunRow = tableRows[ogunRowIndex];
    if (ogunRow) {
      const cells = ogunRow.querySelectorAll('td');
      if (cells.length >= 5) {
        cells[1].innerHTML = `<strong style="color: #FF9800;">${makro.kalori.toFixed(0)}</strong>`;
        cells[2].innerHTML = `<strong style="color: #FF9800;">${makro.karb.toFixed(1)}</strong>`;
        cells[3].innerHTML = `<strong style="color: #FF9800;">${makro.protein.toFixed(1)}</strong>`;
        cells[4].innerHTML = `<strong style="color: #FF9800;">${makro.yag.toFixed(1)}</strong>`;
      }
    }
  });

  // GÜNLÜK ORTALAMA satırını güncelle
  console.log('📊 Günlük ortalama satırı aranıyor...');
  
  // SADECE "GÜNLÜK ORTALAMA" text'i içeren satırı bul
  let totalRow = null;
  const allRows = document.querySelectorAll('#veritabaniAnaliziContent table tbody tr');
  
  for (const row of allRows) {
    const firstCell = row.querySelector('td');
    if (firstCell && firstCell.textContent.includes('📊 GÜNLÜK ORTALAMA')) {
      totalRow = row;
      console.log('📊 GERÇEK günlük ortalama satırı bulundu:', firstCell.textContent);
      break;
    }
  }
  
  // Kaç tane gradient satırı var kontrol et (debug için)
  const allGradientRows = document.querySelectorAll('tr[style*="background: linear-gradient(135deg, #28a745, #20c997)"]');
  console.log('📊 Toplam gradient satır sayısı:', allGradientRows.length);
  
  console.log('📊 Günlük ortalama satırı bulundu mu?', !!totalRow);
  if (totalRow) {
    console.log('📊 Günlük ortalama satırının style:', totalRow.getAttribute('style'));
  }
  
  if (totalRow) {
    const cells = totalRow.querySelectorAll('td');
    console.log('📊 Günlük ortalama satırında hücre sayısı:', cells.length);
    if (cells.length >= 5) {
      const gunSayisi = gunMakrolari.size;
      console.log('📊 Hesaplanacak gün sayısı:', gunSayisi);
      
      // Tüm günlerin toplamını hesapla
      let toplamKalori = 0, toplamProtein = 0, toplamKarb = 0, toplamYag = 0;
      gunMakrolari.forEach((makro) => {
        toplamKalori += makro.kalori;
        toplamProtein += makro.protein;
        toplamKarb += makro.karb;
        toplamYag += makro.yag;
      });
      console.log('📊 Toplam değerler:', { toplamKalori, toplamProtein, toplamKarb, toplamYag });
      
      if (gunSayisi > 0) {
        const ortKalori = (toplamKalori / gunSayisi).toFixed(0);
        const ortKarb = (toplamKarb / gunSayisi).toFixed(1);
        const ortProtein = (toplamProtein / gunSayisi).toFixed(1);
        const ortYag = (toplamYag / gunSayisi).toFixed(1);
        
        cells[0].innerHTML = `📊 GÜNLÜK ORTALAMA (${gunSayisi} gün)`;
        cells[1].innerHTML = ortKalori;
        cells[2].innerHTML = ortKarb;
        cells[3].innerHTML = ortProtein;
        cells[4].innerHTML = ortYag;
        
        // Hücreleri force update et
        cells.forEach((cell, index) => {
          cell.style.backgroundColor = ''; // Renk sıfırla
          cell.style.backgroundColor = '#28a745'; // Yeniden ata
        });
        
        console.log('✅ Günlük ortalama hücreler güncellendi:', {
          gunSayisi,
          hucre0: cells[0].innerHTML,
          hucre1: cells[1].innerHTML,
          hucre2: cells[2].innerHTML,
          hucre3: cells[3].innerHTML,
          hucre4: cells[4].innerHTML,
          ortalama: { kalori: ortKalori, protein: ortProtein, karb: ortKarb, yag: ortYag }
        });
        
        console.log('📊 DETAY: Kalori=' + ortKalori + ', Karb=' + ortKarb + ', Protein=' + ortProtein + ', Yağ=' + ortYag);

        // Header rozetini de güncelle
        try {
          const ortBadge = document.getElementById('gercekKcalBadgeValue');
          if (ortBadge) {
            const ortNum = Math.round(Number(ortKalori));
            ortBadge.textContent = (isFinite(ortNum) && ortNum > 0) ? String(ortNum) : '—';
            // Delta hesaplama fonksiyonunu çağır
            if (typeof updateKcalDelta === 'function') updateKcalDelta();
            console.log('📊 Header rozeti güncellendi:', ortNum);
          }
        } catch (e) {
          console.warn('⚠️ Header rozeti güncellenemedi:', e?.message || e);
        }

        // Aktif haftanın gerçekleşen günlük ort. kcal değerini cache'le (Kilo Seyri için)
        try {
          const haftaListesi = (typeof getHaftaListesi === 'function') ? getHaftaListesi() : [];
          const aktifIdx = (typeof getAktifHaftaIndex === 'function') ? getAktifHaftaIndex() : (haftaListesi.length ? haftaListesi.length - 1 : 0);
          const aktifHaftaNo = haftaListesi?.[aktifIdx]?.haftaNo;
          const aktifHasta = (typeof getCurrentHasta === 'function') ? getCurrentHasta() : null;
          if (aktifHasta && isFinite(aktifHaftaNo)) {
            const ortNum = Math.round(Number(ortKalori));
            if (isFinite(ortNum) && ortNum > 0) {
              if (!window.__weeklyRealizedAvg) window.__weeklyRealizedAvg = {};
              if (!window.__weeklyRealizedAvg[aktifHasta.id]) window.__weeklyRealizedAvg[aktifHasta.id] = {};
              window.__weeklyRealizedAvg[aktifHasta.id][String(aktifHaftaNo)] = ortNum;
              // Haftanın objesine de yaz (runtime), kalıcı kayıt değil
              try {
                const h = haftaListesi.find(hh => hh.haftaNo === aktifHaftaNo);
                if (h) h.realizedAvgKcal = ortNum;
              } catch {}
              console.log('💾 Haftalık gerçekleşen ort. kcal cachelendi:', { hastaId: aktifHasta.id, hafta: aktifHaftaNo, ortKalori: ortNum });
            } else {
              console.log('ℹ️ Ort. kcal 0 olduğu için cache/persist atlandı');
            }

            // Kalıcılık: hasta verisini localStorage ve GitHub'a yaz (mümkünse)
            try {
              // seciliHasta mevcutsa onun haftalar dizisindeki haftayı güncelle
              if (typeof seciliHasta !== 'undefined' && seciliHasta && Array.isArray(seciliHasta.haftalar)) {
                const idx = seciliHasta.haftalar.findIndex(h => h.haftaNo === aktifHaftaNo);
                if (idx >= 0) {
                  seciliHasta.haftalar[idx].realizedAvgKcal = Math.round(Number(ortKalori));
                  if (typeof saveToStorage === 'function') saveToStorage();
                  // GitHub'a da yazmayı dene
                  const gh = getGithubRepoAndToken();
                  if (gh) {
                    try { hastayiAyriKaydet(seciliHasta).catch(e => console.warn('GitHub persiste uyarı:', e?.message || e)); } catch(e) { console.warn('GitHub persiste uyarı:', e?.message || e); }
                  }
                }
              }
            } catch (e) {
              console.warn('⚠️ realizedAvgKcal persist uyarısı:', e?.message || e);
            }
          }
        } catch (e) {
          console.warn('⚠️ Haftalık gerçekleşen ort. kcal cache hatası:', e?.message || e);
        }
      } else {
        console.warn('⚠️ Gün sayısı 0, ortalama hesaplanamıyor');
      }
    } else {
      console.warn('⚠️ Günlük ortalama satırında yeterli hücre yok:', cells.length);
    }
  } else {
    console.warn('⚠️ Günlük ortalama satırı bulunamadı! Selector: tr[style*="background: linear-gradient(135deg, #28a745, #20c997)"]');
    
    // Alternatif selector'lar deneyeceğiz
    const alternativeSelectors = [
      'tr[style*="background: linear-gradient(135deg, #28a745, #20c997)"]',
      'tr[style*="#28a745"]',
      'tr:contains("GÜNLÜK ORTALAMA")',
      'tr td:contains("GÜNLÜK ORTALAMA")'
    ];
    
    alternativeSelectors.forEach((selector, index) => {
      const row = document.querySelector(selector);
      console.log(`📊 Alternatif selector ${index + 1}:`, selector, '→', !!row);
    });
  }
}

function alternatifYemekAc(index) {
  console.log('� Toplam satırları güncelleniyor...');
  
  if (!window.currentFoodAnalysisData) {
    return;
  }
  
  // Sadece eşleşen yemeklerin makrolarını topla
  let toplamKalori = 0;
  let toplamProtein = 0;
  let toplamKarb = 0;
  let toplamYag = 0;
  let eslesenSayisi = 0;
  
  window.currentFoodAnalysisData.forEach(item => {
    if (item.eslestiMi && item.eslesenYemek && !item.gunOgunSatiri) {
      const kalori = item.eslesenYemek.calories || 0;
      const protein = item.eslesenYemek.protein || 0;
      const karb = item.eslesenYemek.carbs || 0;
      const yag = item.eslesenYemek.fat || 0;
      
      toplamKalori += kalori;
      toplamProtein += protein;
      toplamKarb += karb;
      toplamYag += yag;
      eslesenSayisi++;
    }
  });
  
  // GÜNLÜK ORTALAMA satırını bul ve güncelle
  const totalRow = document.querySelector('tr[style*="linear-gradient(135deg, #28a745, #20c997)"]');
  if (totalRow) {
    const cells = totalRow.querySelectorAll('td');
    if (cells.length >= 5) {
      // Gün sayısını hesapla - eğer günlük veriler varsa onları kullan
      const gunSayisi = 1; // Basitleştirilmiş versiyon
      
      cells[0].innerHTML = `📊 GÜNLÜK ORTALAMA (${gunSayisi} gün)`;
      cells[1].innerHTML = `${(toplamKalori / gunSayisi).toFixed(0)}`;
      cells[2].innerHTML = `${(toplamKarb / gunSayisi).toFixed(1)}`;
      cells[3].innerHTML = `${(toplamProtein / gunSayisi).toFixed(1)}`;
      cells[4].innerHTML = `${(toplamYag / gunSayisi).toFixed(1)}`;
      
      console.log('✅ Toplam satırları güncellendi:', {
        toplamKalori,
        toplamProtein,
        toplamKarb,
        toplamYag,
        eslesenSayisi,
        gunSayisi
      });
    }
  }
  
  // Öğün toplam satırlarını da bul ve güncelle
  const ogunRows = document.querySelectorAll('tr[style*="background: #ffc107"]');
  ogunRows.forEach(ogunRow => {
    const cells = ogunRow.querySelectorAll('td');
    if (cells.length >= 5 && cells[0].textContent.includes('🍽️')) {
      // Bu öğünün yemeklerini topla - burada basit bir hesaplama yapıyoruz
      // Gerçek implementasyonda öğün bazında detaylı hesaplama yapılabilir
      let ogunKalori = 0, ogunProtein = 0, ogunKarb = 0, ogunYag = 0;
      
      // Bu öğünle ilgili yemekleri bul (öğün adını parse ederek)
      const ogunText = cells[0].textContent;
      window.currentFoodAnalysisData.forEach(item => {
        if (item.eslestiMi && item.eslesenYemek && !item.gunOgunSatiri) {
          // Öğün eşleştirmesi için basit kontrol
          ogunKalori += (item.eslesenYemek.calories || 0) * 0.25; // Geçici hesaplama
          ogunProtein += (item.eslesenYemek.protein || 0) * 0.25;
          ogunKarb += (item.eslesenYemek.carbs || 0) * 0.25;
          ogunYag += (item.eslesenYemek.fat || 0) * 0.25;
        }
      });
      
      cells[1].innerHTML = `<strong>${ogunKalori.toFixed(0)}</strong>`;
      cells[2].innerHTML = `<strong>${ogunKarb.toFixed(1)}</strong>`;
      cells[3].innerHTML = `<strong>${ogunProtein.toFixed(1)}</strong>`;
      cells[4].innerHTML = `<strong>${ogunYag.toFixed(1)}</strong>`;
    }
  });
}

// Alternatif mod açıkken yeniden tıklanırsa sonraki alternatife geç
function alternatifYemekAc(index) {
  // Eğer aynı yemek için alternatif mod zaten aktifse, sonraki alternatife geç
  if (alternativeModeActive && currentAlternativeIndex === index) {
    sonrakiAlternatifeGec();
    
    // Seçimi hemen uygula (otomatik seçim modu)
    if (alternativeFoods && alternativeFoods.length > 0) {
      const currentStep = (currentAlternativeStep - 1) % alternativeFoods.length;
      alternatifSec(currentStep);
    }
    return;
  }
  
  // Başka bir yemek için alternatif mod başlatılıyorsa, öncekini durdur
  if (alternativeModeActive && currentAlternativeIndex !== index) {
    alternatifleriDurdur();
  }
  
  // Yeni alternatif mod başlat - orijinal kodu çağır
  console.log('🔄 Alternatif yemek sistemi başlatılıyor, index:', index);
  
  if (!window.currentFoodAnalysisData || !window.currentFoodAnalysisData[index]) {
    console.error('❌ Yemek verisi bulunamadı, index:', index);
    showToast('Yemek verisi bulunamadı!', 'error');
    return;
  }
  
  const item = window.currentFoodAnalysisData[index];
  
  if (!item.eslestiMi || !item.eslesenYemek) {
    showToast('Sadece eşleşen yemekler için alternatif önerileri yapılabilir!', 'warning');
    return;
  }
  
  console.log('🎯 Alternatif aranacak yemek:', item.eslesenYemek);
  
  // Mevcut durumu kaydet
  originalFoodData = { ...item.eslesenYemek };
  currentAlternativeIndex = index;
  currentAlternativeStep = 0;
  
  // Alternatif yemekleri bulup uygula
  alternatifleriBaslat(item.eslesenYemek);
}

function alternatifSec(index) {
  if (!alternativeModeActive) {
    console.warn('⚠️ Alternatif mod aktif değil!');
    return;
  }
  
  console.log('🎯 Alternatif seçildi:', index);
  console.log('🔍 currentAlternativeIndex:', currentAlternativeIndex);
  console.log('🔍 window.currentFoodAnalysisData uzunluğu:', window.currentFoodAnalysisData?.length);
  
  const currentItem = window.currentFoodAnalysisData[currentAlternativeIndex];
  if (!currentItem) {
    console.error('❌ currentItem bulunamadı! currentAlternativeIndex:', currentAlternativeIndex);
    return;
  }
  
  console.log('🔍 İşlenecek item:', currentItem);
  
  // 🚫 ZATEN SEÇİLMİŞ YEMEK KONTROLÜ (alternatif seçim sırasında)
  if (index !== 'original') {
    const selectedFood = alternativeFoods[index];
    if (selectedFood && currentItem) {
      const sameGun = currentItem.belongToGun;
      const sameOgun = currentItem.belongToOgun;
      
      const alreadySelected = (window.currentFoodAnalysisData || []).some(item => {
        if (!item.gunOgunSatiri && !item.karalistede && 
            item.belongToGun === sameGun && 
            item.belongToOgun === sameOgun &&
            item.eslestiMi && item.eslesenYemek) {
          const itemName = (item.eslesenYemek.name || item.eslesenYemek.originalName || '').toLowerCase();
          const selectedName = (selectedFood.name || selectedFood.originalName || '').toLowerCase();
          return itemName === selectedName;
        }
        return false;
      });
      
      if (alreadySelected) {
        showToast(`🚫 "${selectedFood.name}" bu öğünde zaten seçili! Farklı bir alternatif seçin.`, 'warning', 3000);
        console.log('🚫 Seçim engellendi - zaten seçili yemek:', selectedFood.name);
        return;
      }
    }
  }
  
  if (index === 'original') {
    // Orijinal yemeği seç
    if (originalFoodData) {
      currentItem.eslesenYemek = { ...originalFoodData };
      currentAlternativeStep = 0; // Orijinal için step sıfırla
      console.log('↩️ Orijinal yemek seçildi:', originalFoodData.originalName);
      showToast(`↩️ ORİJİNAL: ${originalFoodData.originalName}`, 'success', 2000);
    }
  } else {
    // Alternatif yemek seç
    const selectedFood = alternativeFoods[index];
    if (selectedFood) {
      currentItem.eslesenYemek = {
        ...selectedFood,
        originalName: selectedFood.name
      };
      currentAlternativeStep = index + 1;
      console.log('🔄 Alternatif yemek seçildi:', selectedFood.name);
      console.log('🔍 Güncellenen currentItem:', currentItem);
      console.log('🍎 Yeni makrolar: Kalori=' + selectedFood.calories + ', Protein=' + selectedFood.protein + ', Karb=' + selectedFood.carbs + ', Yağ=' + selectedFood.fat);
      
      const scoreText = selectedFood.similarityScore ? ` (${selectedFood.similarityScore.toFixed(1)}% benzer)` : '';
      const alternatifSirasi = index + 1;
      const toplamAlternatif = alternativeFoods.length;
      showToast(`🎯 ALTERNATİF ${alternatifSirasi}/${toplamAlternatif}: ${selectedFood.name}${scoreText}`, 'info', 2000);
    }
  }
  
  // UI'yi güncelle - sadece sidebar'ı güncelle, tablo yeniden render edilmesin
  updateAlternativeControls();
  
  // Tablo güncelleme işi smartHedefeGoreSec tarafından yapılacak
  // updateFoodTableRow çağrısı kaldırıldı (çift çağrı sorununu önlemek için)
  
  // Günlük ortalama güncellenmesini zorunlu kıl
  setTimeout(() => {
    console.log('🔄 Alternatif seçimi sonrası günlük ortalama zorla güncelleniyor...');
    updateTotalRows();
  }, 100);
}

// Global fonksiyonları ekle
window.alternatifYemekAc = alternatifYemekAc;
window.alternatifleriDurdur = alternatifleriDurdur;
window.orijinalYemegiGeriYukle = orijinalYemegiGeriYukle;
window.updateAlternativeControls = updateAlternativeControls;
window.alternatifSec = alternatifSec;

// Global fonksiyonları window objesine ata
window.yemekDuzenleModalAc = yemekDuzenleModalAc;
window.yemekSil = yemekSil;
window.alternatifleriGosterOgun = alternatifleriGosterOgun;
window.selectMealAlternative = selectMealAlternative;
window.showTargetMealAlternatives = showTargetMealAlternatives;
window.applyBestTargetMealAlternative = applyBestTargetMealAlternative;
window.closeMealAlternativeModal = closeMealAlternativeModal;

// 🧮 KALORİ HESAPLAMA FONKSİYONU
function hesaplaKalori() {
  // Besin değerlerini al
  const protein = parseFloat(document.getElementById('yemekProtein').value) || 0;
  const karb = parseFloat(document.getElementById('yemekKarb').value) || 0;
  const yag = parseFloat(document.getElementById('yemekYag').value) || 0;
  
  // Kalori hesapla: Protein=4kcal/g, Karb=4kcal/g, Yağ=9kcal/g
  const proteinKalori = protein * 4;
  const karbKalori = karb * 4;
  const yagKalori = yag * 9;
  const toplam = proteinKalori + karbKalori + yagKalori;
  
  // Kalori input'unu güncelle
  const kaloriInput = document.getElementById('yemekKalori');
  kaloriInput.value = toplam.toFixed(1);
  
  // Visual feedback - hesaplama animasyonu (açık yeşil tema)
  kaloriInput.style.background = '#a8d8a8';
  kaloriInput.style.borderColor = '#28a745';
  setTimeout(() => {
    kaloriInput.style.background = '#d4f4dd';
    kaloriInput.style.borderColor = '#28a745';
  }, 500);
  
  // Detaylı hesaplama bilgisi için title tooltip
  kaloriInput.title = `Hesaplama Detayı:\n` +
    `• Protein: ${protein}g × 4 = ${proteinKalori.toFixed(1)} kcal\n` +
    `• Karbonhidrat: ${karb}g × 4 = ${karbKalori.toFixed(1)} kcal\n` +
    `• Yağ: ${yag}g × 9 = ${yagKalori.toFixed(1)} kcal\n` +
    `• TOPLAM: ${toplam.toFixed(1)} kcal`;
  
  console.log(`🧮 Kalori hesaplandı: P:${protein}g (${proteinKalori.toFixed(1)}kcal) + K:${karb}g (${karbKalori.toFixed(1)}kcal) + Y:${yag}g (${yagKalori.toFixed(1)}kcal) = ${toplam.toFixed(1)}kcal`);
}

// Etiket ekleme fonksiyonu
function etiketEkle(inputId, etiket) {
  const input = document.getElementById(inputId);
  const mevcutDeger = input.value.trim();
  
  // Eğer etiket zaten varsa ekleme
  const mevcutEtiketler = mevcutDeger.split(',').map(e => e.trim()).filter(e => e.length > 0);
  if (mevcutEtiketler.includes(etiket)) {
    showToast(`"${etiket}" etiketi zaten ekli!`, 'warning');
    return;
  }
  
  // Etiket ekle
  if (mevcutDeger) {
    input.value = mevcutDeger + ', ' + etiket;
  } else {
    input.value = etiket;
  }
  
  showToast(`"${etiket}" etiketi eklendi!`, 'success');
}

// Global fonksiyonlar yap
window.hesaplaKalori = hesaplaKalori;
window.etiketEkle = etiketEkle;

function yemekFormDoldur(data) {
  console.log('🔍 Form dolduruluyor, data:', data);
  
  // Temel bilgiler
  const isim = data.name || data.ad || data.originalName || '';
  document.getElementById('yemekAdi').value = isim;
  // Eşleştirme sekmesi açıkken başlıkları da güncel tut
  try {
    if (isim) {
      const hedef1 = document.getElementById('eslestirYemekAdi');
      const hedef2 = document.getElementById('pdfYemekAdi');
      if (hedef1) hedef1.textContent = isim;
      if (hedef2) hedef2.textContent = isim;
    }
  } catch {}
  
  // Kategori debug
  console.log('🔍 Gelen kategori:', data.category || 'undefined');
  
  // Kategori eşleştirme tablosu
  const kategoriEslestirme = {
    'ÖĞLEN': 'OGLE',
    'KAHVALTI': 'KAHVALTI',
    'AKŞAM': 'AKSAM',
    'APERATIF': 'APERATIF',
    'TATLI': 'TATLI',
    'İÇECEK': 'ICECEK',
    'SALATA': 'SALATA',
    'ÇORBALAR': 'CORBALAR',
    'SEBZE': 'SEBZE',
    'ET': 'ET',
    'BALIK': 'BALIK',
    'TAVUK': 'TAVUK'
  };
  
  const kategoriSelect = document.getElementById('yemekKategori');
  const gelenKategori = data.category || 'OGLE'; // Default kategori
  const eslesmisKategori = kategoriEslestirme[gelenKategori] || gelenKategori;
  
  kategoriSelect.value = eslesmisKategori;
  console.log('🔍 Gelen kategori:', gelenKategori);
  console.log('🔍 Eşleşmiş kategori:', eslesmisKategori);
  console.log('🔍 Select value set to:', kategoriSelect.value);
  console.log('🔍 Select selectedIndex:', kategoriSelect.selectedIndex);
  
  // Besin değerleri - Önce makroları set et, sonra kaloriyi hesapla
  document.getElementById('yemekProtein').value = data.protein || 0;
  document.getElementById('yemekKarb').value = data.carbs || 0;
  document.getElementById('yemekYag').value = data.fat || 0;
  
  // Eğer kalori verisi varsa onu kullan, yoksa hesapla
  if (data.calories && data.calories > 0) {
    document.getElementById('yemekKalori').value = data.calories;
  } else {
    // Kaloriyi makrolardan hesapla (timeout ile DOM güncellemesini bekle)
    setTimeout(() => {
      hesaplaKalori();
    }, 100);
  }
  
  // Porsiyon bilgileri
  document.getElementById('yemekMinMiktar').value = data.minQuantity || 0.5;
  document.getElementById('yemekMaxMiktar').value = data.maxQuantity || 1;
  document.getElementById('yemekAdim').value = data.step || 0.5;
  document.getElementById('yemekCarpan').value = data.multiplier || 1;
  
  // Rol
  document.getElementById('yemekRol').value = data.role || 'mainDish';
  
  // Öğün türleri - hem sabit hem dinamik
  const mealTypes = data.mealType || [];
  console.log('🔍 MealTypes:', mealTypes);
  document.getElementById('yemekBreakfast').checked = mealTypes.includes('breakfast');
  document.getElementById('yemekLunch').checked = mealTypes.includes('lunch');
  document.getElementById('yemekDinner').checked = mealTypes.includes('dinner');
  document.getElementById('yemekDessert').checked = mealTypes.includes('dessert');
  document.getElementById('yemekDrink').checked = mealTypes.includes('drink');
  document.getElementById('yemekSnack').checked = mealTypes.includes('snack');
  
  // Dinamik öğün tiplerini de doldur
  const userMealTypes = JSON.parse(localStorage.getItem('userMealTypes') || '[]');
  userMealTypes.forEach(meal => {
    const checkbox = document.getElementById(`yemek${meal.kod.charAt(0).toUpperCase() + meal.kod.slice(1)}`);
    if (checkbox) {
      checkbox.checked = mealTypes.includes(meal.kod);
    }
  });
  
  // Diyet özellikleri - undefined kontrolü eklendi
  console.log('🔍 Keto:', data.keto || false, 'LowCarb:', data.lowcarb || false);
  document.getElementById('yemekKeto').checked = data.keto || false;
  document.getElementById('yemekLowCarb').checked = data.lowcarb || false;
  document.getElementById('yemekPorsiyonSabit').checked = data.portionFixed || false;
  
  // Filler özellikleri - undefined kontrolü eklendi
  console.log('🔍 FillerLunch:', data.fillerLunch || false, 'FillerDinner:', data.fillerDinner || false);
  document.getElementById('yemekFillerOgle').checked = data.fillerLunch || false;
  document.getElementById('yemekFillerAksam').checked = data.fillerDinner || false;
  
  // Etiketler - undefined kontrolü eklendi
  console.log('🔍 Tags:', data.tags || [], 'CompatibilityTags:', data.compatibilityTags || [], 'IncompatibilityTags:', data.incompatibilityTags || []);
  document.getElementById('yemekEtiketler').value = (data.tags || []).join(', ');
  document.getElementById('yemekUyumluluk').value = (data.compatibilityTags || []).join(', ');
  // 🚫 Uyumsuzluk etiketlerini de doldur
  document.getElementById('yemekUyumsuzluk').value = (data.incompatibilityTags || []).join(', ');
  
  // Sezon bilgileri
  document.getElementById('yemekSezon').value = data.seasonRange || '[1,12]';
  document.getElementById('yemekTersSezon').checked = data.isReversedSeason || false;
}

// Sol (düzenleme) tabında Yemek Adı alanına akıllı arama/suggestion ekle
let yemekAdiSuggestState = { mounted: false, container: null, docBound: false };
function initYemekAdiSmartSearch() {
  const input = document.getElementById('yemekAdi');
  const modal = document.getElementById('yemekDuzenleModal');
  if (!input || !modal) return;

  // Seçim bilgisini sıfırla
  delete modal.dataset.selectedDbId;
  delete modal.dataset.selectedDbName;

  // Container oluştur (bir kere)
  if (!yemekAdiSuggestState.mounted) {
    const wrap = document.createElement('div');
    wrap.id = 'yemekAdiSuggestions';
    wrap.style.position = 'absolute';
    wrap.style.zIndex = '10010';
    wrap.style.background = '#fff';
    wrap.style.border = '1px solid #ddd';
    wrap.style.borderRadius = '6px';
    wrap.style.boxShadow = '0 8px 24px rgba(0,0,0,0.12)';
    wrap.style.maxHeight = '240px';
    wrap.style.overflowY = 'auto';
    wrap.style.display = 'none';
    wrap.style.minWidth = '320px';
    // Modal köküne ekle ki overflow altında kalmasın
    modal.appendChild(wrap);
    yemekAdiSuggestState.container = wrap;
    yemekAdiSuggestState.mounted = true;

    // Modal kapanınca gizle
    // Modal içinde scroll olursa sadece konumu güncelle (gizleme yapma)
    modal.addEventListener('scroll', () => { try { positionContainer(); } catch {} }, true);
  }

  const container = yemekAdiSuggestState.container;

  function positionContainer() {
    const rect = input.getBoundingClientRect();
    const modalRect = modal.getBoundingClientRect();
    container.style.left = (rect.left - modalRect.left) + 'px';
    container.style.top = (rect.bottom - modalRect.top + 6) + 'px';
    container.style.width = rect.width + 'px';
  }

  // Dışarı tıklayınca kapat (içeride tıklarken asla kapatma)
  function onDocPointerDown(e) {
    const t = e.target;
    const inside = (t === input) || (input.contains && input.contains(t)) || (container.contains && container.contains(t));
    if (!inside) { container.style.display = 'none'; }
  }
  if (!yemekAdiSuggestState.docBound) {
    document.addEventListener('mousedown', onDocPointerDown);
    document.addEventListener('touchstart', onDocPointerDown, { passive: true });
    yemekAdiSuggestState.docBound = true;
  }

  function renderSuggestions(list) {
    if (!list || !list.length) { container.style.display = 'none'; return; }
    positionContainer();
    container.innerHTML = list.map(item => {
      const icon = getKategoriIcon(item.kategori);
      const macro = `P:${(item.protein||0)}g • K:${(item.karbonhidrat||0)}g • Y:${(item.yag||0)}g • ${(item.kalori||0)} kcal`;
      return `
        <div class="yemek-adi-suggestion" data-id="${item.id}" style="padding:8px 10px; border-bottom:1px solid #f0f0f0; cursor:pointer; display:flex; align-items:center; gap:8px;">
          <span style="width:20px; text-align:center;">${icon}</span>
          <div style="flex:1;">
            <div style="font-weight:600; color:#333; font-size:13px;">${item.ad}</div>
            <div style="font-size:11px; color:#666;">${item.kategori} • ${macro}</div>
          </div>
        </div>`;
    }).join('');
    container.style.display = 'block';

    // Click bağla
    Array.from(container.querySelectorAll('.yemek-adi-suggestion')).forEach(el => {
      el.addEventListener('click', () => {
        const id = el.getAttribute('data-id');
        const dbItem = (window.globalFoodListFlat || []).find(x => x.id === id);
        if (!dbItem) return;
        // Seçim: formu DB makrolarıyla doldur (ismi KORU)
        try {
          // İsmi koru
          const typedName = input.value.trim();
          // Kategori
          const kategoriSelect = document.getElementById('yemekKategori');
          kategoriSelect.value = dbItem.kategori || '';
          // Makrolar
          document.getElementById('yemekProtein').value = dbItem.protein || 0;
          document.getElementById('yemekKarb').value = dbItem.karbonhidrat || 0;
          document.getElementById('yemekYag').value = dbItem.yag || 0;
          document.getElementById('yemekKalori').value = dbItem.kalori || 0;
          // Etiketler (varsa)
          if (dbItem.etiketler && Array.isArray(dbItem.etiketler)) {
            document.getElementById('yemekEtiketler').value = dbItem.etiketler.join(', ');
          }
          // İsim alanını eski haliyle bırak
          document.getElementById('yemekAdi').value = typedName || dbItem.ad || '';
          // Eşleştirme sekmesi başlıklarını da güncelle
          const hedef1 = document.getElementById('eslestirYemekAdi');
          const hedef2 = document.getElementById('pdfYemekAdi');
          if (hedef1) hedef1.textContent = (typedName || dbItem.ad || '').trim();
          if (hedef2) hedef2.textContent = (typedName || dbItem.ad || '').trim();
          // Seçim meta
          modal.dataset.selectedDbId = dbItem.id;
          modal.dataset.selectedDbName = dbItem.ad || '';
          // Kalori tekrar hesap tooltips
          try { hesaplaKalori(); } catch {}
          showToast('📚 Veritabanından makrolar yüklendi', 'success');
        } catch (e) { console.warn('Suggestion apply hatası:', e); }
        container.style.display = 'none';
      });
    });
  }

  function findSuggestions(q) {
    const src = (window.globalFoodListFlat || []);
    if (!src.length) return [];
    const normQ = normalizeTrSimple(q);
    if (!normQ) return [];
    const scored = src.map(it => {
      const name = normalizeTrSimple(it.ad);
      const tags = Array.isArray(it.etiketler) ? normalizeTrSimple(it.etiketler.join(' ')) : '';
      let score = 0;
      if (name.startsWith(normQ)) score += 100;
      if (name.includes(normQ)) score += 60;
      if (tags && tags.includes(normQ)) score += 30;
      // küçük uzunluk farkı bonusu
      score += Math.max(0, 20 - Math.abs(name.length - normQ.length));
      return { it, score };
    }).filter(x => x.score > 0)
      .sort((a,b) => b.score - a.score)
  .slice(0, (window.SUGGESTION_LIMIT || 10))
      .map(x => x.it);
    return scored;
  }

  function onInput() {
    // Her input değişiminde seçimi sıfırla
    delete modal.dataset.selectedDbId;
    delete modal.dataset.selectedDbName;

    const val = input.value || '';
    if (val.trim().length < 2) { container.style.display = 'none'; return; }
    const list = findSuggestions(val);
    renderSuggestions(list);
  }

  // Event bind
  input.removeEventListener('input', onInput);
  input.addEventListener('input', onInput);
  input.addEventListener('focus', () => {
    if ((input.value||'').trim().length >= 2) {
      const list = findSuggestions(input.value);
      renderSuggestions(list);
    }
  });
  // Not: blur ile kapatma yok; dışarı tıklama ile kapatıyoruz
}

// 🗑️ YEMEK SİLME FONKSİYONU
async function yemekSil() {
  const modal = document.getElementById('yemekDuzenleModal');
  const yemekAdi = document.getElementById('yemekAdi').value.trim();
  
  if (!yemekAdi) {
    alert('⚠️ Silinecek yemek adı bulunamadı.');
    return;
  }
  
  // Onay isteği
  if (!confirm(`⚠️ "${yemekAdi}" yemeğini kalıcı olarak silmek istediğinizden emin misiniz?\n\n🔄 Bu işlem yemeği hem yerel listeden hem de GitHub'dan silecek.\n\n⚠️ Bu işlem geri alınamaz!`)) {
    return;
  }
  
  try {
    // Yerel listeden sil
    if (window.foodList && Array.isArray(window.foodList)) {
      const originalIndex = window.foodList.findIndex(y => y.ad === yemekAdi || y.name === yemekAdi);
      if (originalIndex !== -1) {
        const silinenYemek = window.foodList.splice(originalIndex, 1)[0];
        console.log(`🗑️ "${yemekAdi}" yemeği yerel listeden silindi:`, silinenYemek);
      }
    }
    
    // GitHub'a kaydet
    const yemekData = { name: yemekAdi, ad: yemekAdi };
    const success = await yemekGithubKaydet(yemekData, 'sil', yemekData);
    
    if (success) {
      alert(`✅ "${yemekAdi}" yemeği başarıyla silindi!\n\n🔄 Değişiklik GitHub'a kaydedildi.`);
      
      // Modal'ı kapat
      yemekModalKapat();
      
      // Veritabanı paneli açıksa yenile
      const veriPanel = document.getElementById('yemekVeriTabaniPanel');
      if (veriPanel && veriPanel.style.display !== 'none') {
        yemekVeriTabaniFiltrele();
      }
      
      // Ana yemek listesini de yenile
      try {
        if (typeof yemekListesiniFiltrele === 'function') {
          yemekListesiniFiltrele();
        }
      } catch (e) {
        console.warn('⚠️ Ana liste yenileme hatası:', e);
      }
      
    } else {
      alert('❌ Yemek silinirken bir hata oluştu. GitHub kaydetme işlemi başarısız.');
    }
    
  } catch (error) {
    console.error('❌ Yemek silme hatası:', error);
    alert('❌ Yemek silinirken bir hata oluştu: ' + error.message);
  }
}

function yemekModalKapat(event) {
  if (event && event.target !== event.currentTarget) return;
  
  const modal = document.getElementById('yemekDuzenleModal');
  modal.style.display = 'none';
  
  // Modal state'ini temizle
  secilenYemek = null;
  aktifFiltre = 'all';
  
  // Seçimleri temizle
  const secilenKart = document.querySelector('.yemek-kart.selected');
  if (secilenKart) {
    secilenKart.classList.remove('selected');
  }
  
  // Seçilen yemek bilgisini gizle
  document.getElementById('secilenYemekBilgi').style.display = 'none';
  
  // Alias checkbox'ını sıfırla
  document.getElementById('aliasEkleCheckbox').checked = false;
  document.getElementById('aliasEklemeAlani').style.display = 'none';
  
  // Arama alanını temizle
  document.getElementById('yemekAramaInput').value = '';
  
  // Filtreleri sıfırla
  const tümButonlar = document.querySelectorAll('.hizli-filtre');
  tümButonlar.forEach(btn => {
    btn.classList.remove('active');
    if (btn.dataset.filtre === 'all') {
      btn.classList.add('active');
    }
  });
}

// ID GENERATOR FONKSİYONU
function generateId() {
  return 'food_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
}

async function yemekKaydet() {
  const modal = document.getElementById('yemekDuzenleModal');
  const mod = modal.dataset.mod;
  // Orijinal veri (duzenle modunda güncelleme için gerekli)
  let originalData = {};
  try { originalData = JSON.parse(modal.dataset.originalData || '{}'); } catch {}
  
  try {
    // Form verilerini topla
    const yemekData = yemekFormVerileriniAl();
    const selectedDbName = (modal.dataset.selectedDbName || '').trim();
    const norm = s => normalizeTrSimple(s||'');
    
    if (!yemekData.name.trim()) {
      alert('Yemek adı boş olamaz!');
      return;
    }
    
    if (!yemekData.category) {
      alert('Kategori seçilmelidir!');
      return;
    }
    
    // Eğer ekle modunda ve kullanıcı veritabanından bir yemek seçtiyse
    // 1) Yazılan isim seçilen DB adının aynısıysa: DB'ye tekrar ekleme yapmadan eşleştirme say
    // 2) Farklıysa: Seçilen makrolarla yeni kayıt (alias gibi) oluştur ve ekle
    if (mod === 'ekle' && selectedDbName) {
      if (norm(yemekData.name) === norm(selectedDbName)) {
        // Yeni kayıt eklemeye gerek yok, sadece analizi tazele ve kapat
        showToast(`"${yemekData.name}" veritabanıyla eşleşti`, 'success');
        yemekModalKapat();
        try { updateYemekVeritabaniAnalizi(); } catch {}
        try { eslesmeyenlerListesiniGuncelle(); } catch {}
        try { if (typeof window.seciliHasta !== 'undefined' && window.seciliHasta) { otomatikEsleHafta(); } } catch {}
        try { if (typeof window.aktifHaftaIndex !== 'undefined' && window.aktifHaftaIndex !== null) { gosterEslesenKartlarSidebar(window.aktifHaftaIndex); } } catch {}
        return;
      } else {
        // Alias tarzı: formdaki isimle yeni kayıt ekle (makrolar zaten seçilen DB'den dolduruldu)
        // mod zaten 'ekle' olduğu için aşağıdaki akış normal şekilde kaydedecek
      }
    }
    
  // GitHub'a kaydet (orijinal veri ile)
  const basarili = await yemekGithubKaydet(yemekData, mod, originalData);
    
    if (basarili) {
      showToast(mod === 'ekle' ? 'Yemek başarıyla eklendi!' : 'Yemek başarıyla güncellendi!', 'success');
      yemekModalKapat();
      
      // Hemen render'ı güncelle - yeni yemek verileri ile
      console.log('🔄 Yemek kaydedildi, render güncelleniyor...');
      
      // 1. Yemek veritabanı analizini ve eşleşmeyenler listesini hemen güncelle
      try { updateYemekVeritabaniAnalizi(); } catch {}
      try { eslesmeyenlerListesiniGuncelle(); } catch {}

      // 2. Aktif hafta için eşleşmeyi ve sidebar'ı tazele (varsalar)
      try { if (typeof window.seciliHasta !== 'undefined' && window.seciliHasta) { otomatikEsleHafta(); } } catch {}
      try { if (typeof window.aktifHaftaIndex !== 'undefined' && window.aktifHaftaIndex !== null) { gosterEslesenKartlarSidebar(window.aktifHaftaIndex); } } catch {}
      
      // 3. Veritabanı paneli açıksa tabloyu yenile
      try {
        const veriPanel = document.getElementById('yemekVeriTabaniPanel');
        if (veriPanel && veriPanel.style.display !== 'none') {
          console.log('🔄 Yemek veritabanı tablosu yenileniyor...');
          // Hem veritabanı listesini hem de filtreyi güncelle
          if (typeof yemekVeriTabaniYukle === 'function') {
            await yemekVeriTabaniYukle(); // Veritabanı listesini güncel data ile yeniden yükle
          } else {
            yemekVeriTabaniFiltrele(); // Sadece filtrele
          }
        }
      } catch (e) {
        console.warn('⚠️ Veritabanı tablosu yenilenemedi:', e);
      }
      
      // 4. Ana yemek listesini de yenile
      try {
        if (typeof yemekListesiniFiltrele === 'function') {
          yemekListesiniFiltrele();
        }
      } catch (e) {
        console.warn('⚠️ Ana liste yenileme hatası:', e);
      }
      
    } else {
      showToast('Kaydetme işlemi başarısız!', 'error');
    }
    
  } catch (error) {
    console.error('❌ Yemek kaydetme hatası:', error);
    showToast('Beklenmeyen bir hata oluştu!', 'error');
  }
}

function yemekFormVerileriniAl() {
  // Öğün türlerini topla - hem sabit hem dinamik
  const mealTypes = [];
  if (document.getElementById('yemekBreakfast').checked) mealTypes.push('breakfast');
  if (document.getElementById('yemekLunch').checked) mealTypes.push('lunch');
  if (document.getElementById('yemekDinner').checked) mealTypes.push('dinner');
  if (document.getElementById('yemekDessert').checked) mealTypes.push('dessert');
  if (document.getElementById('yemekDrink').checked) mealTypes.push('drink');
  if (document.getElementById('yemekSnack').checked) mealTypes.push('snack');
  
  // Dinamik öğün tiplerini de kontrol et
  const userMealTypes = JSON.parse(localStorage.getItem('userMealTypes') || '[]');
  userMealTypes.forEach(meal => {
    const checkbox = document.getElementById(`yemek${meal.kod.charAt(0).toUpperCase() + meal.kod.slice(1)}`);
    if (checkbox && checkbox.checked) {
      mealTypes.push(meal.kod);
    }
  });
  
  // Etiketleri işle
  const tags = document.getElementById('yemekEtiketler').value
    .split(',')
    .map(tag => tag.trim())
    .filter(tag => tag.length > 0);
    
  const compatibilityTags = document.getElementById('yemekUyumluluk').value
    .split(',')
    .map(tag => tag.trim())
    .filter(tag => tag.length > 0);
    
  // 🚫 Uyumsuzluk etiketlerini al
  const incompatibilityTags = document.getElementById('yemekUyumsuzluk').value
    .split(',')
    .map(tag => tag.trim())
    .filter(tag => tag.length > 0);
  
  return {
    name: document.getElementById('yemekAdi').value.trim(),
    category: document.getElementById('yemekKategori').value,
    calories: parseFloat(document.getElementById('yemekKalori').value) || 0,
    protein: parseFloat(document.getElementById('yemekProtein').value) || 0,
    carbs: parseFloat(document.getElementById('yemekKarb').value) || 0,
    fat: parseFloat(document.getElementById('yemekYag').value) || 0,
    minQuantity: parseFloat(document.getElementById('yemekMinMiktar').value) || 0.5,
    maxQuantity: parseFloat(document.getElementById('yemekMaxMiktar').value) || 1,
    step: parseFloat(document.getElementById('yemekAdim').value) || 0.5,
    multiplier: parseFloat(document.getElementById('yemekCarpan').value) || 1,
    role: document.getElementById('yemekRol').value,
    mealType: mealTypes,
    keto: document.getElementById('yemekKeto').checked,
    lowcarb: document.getElementById('yemekLowCarb').checked,
    portionFixed: document.getElementById('yemekPorsiyonSabit').checked,
    fillerLunch: document.getElementById('yemekFillerOgle').checked,
    fillerDinner: document.getElementById('yemekFillerAksam').checked,
    tags: tags,
    compatibilityTags: compatibilityTags,
    incompatibilityTags: incompatibilityTags, // 🚫 Yeni alan eklendi
    seasonRange: document.getElementById('yemekSezon').value || '[1,12]',
    isReversedSeason: document.getElementById('yemekTersSezon').checked
  };
}

// 🆕 DYNAMIC OPTION FUNCTIONS - Kategori, Rol ve Öğün Ekleme Fonksiyonları

// Kategori yönetimi
function rolDegisti() {
  const select = document.getElementById('yemekRol');
  if (select.value === '__YENI__') {
    rolEkleModal();
    select.value = ''; // Reset selection
  }
}

function kategoriDegisti() {
  const select = document.getElementById('yemekKategori');
  if (select.value === '__YENI__') {
    kategoriEkleModal();
    select.value = ''; // Reset selection
  }
}

function kategoriEkleModal() {
  document.getElementById('yeniKategoriAlani').style.display = 'block';
  document.getElementById('yeniKategoriKodu').focus();
}

function yeniKategoriKaydet() {
  const kod = document.getElementById('yeniKategoriKodu').value.trim().toLowerCase();
  const aciklama = document.getElementById('yeniKategoriAciklama').value.trim();
  
  if (!kod || !aciklama) {
    alert('⚠️ Lütfen hem kod hem açıklama girin!');
    return;
  }
  
  // Kod validasyonu
  if (!/^[a-z]+$/.test(kod)) {
    alert('⚠️ Kod sadece küçük harflerden oluşmalı! (örn: yenimeyve)');
    return;
  }
  
  // Mevcut kategorilerde kontrol et
  const select = document.getElementById('yemekKategori');
  const existingOptions = Array.from(select.options);
  const exists = existingOptions.some(opt => opt.value === kod);
  
  if (exists) {
    alert('⚠️ Bu kod zaten mevcut! Farklı bir kod deneyin.');
    return;
  }
  
  // Yeni kategoriyi ekle
  const newOption = document.createElement('option');
  newOption.value = kod;
  newOption.textContent = `${kod} (${aciklama})`;
  
  // "Yeni Kategori Ekle" seçeneğinden önce ekle
  const yeniEkleOption = select.querySelector('option[value="__YENI__"]');
  select.insertBefore(newOption, yeniEkleOption);
  
  // LocalStorage'a kaydet
  let userCategories = JSON.parse(localStorage.getItem('userCategories') || '[]');
  userCategories.push({kod, aciklama});
  localStorage.setItem('userCategories', JSON.stringify(userCategories));
  
  // Yeni kategoriyi seç
  select.value = kod;
  
  // Formu temizle ve gizle
  yeniKategoriIptal();
  
  console.log(`✅ Yeni kategori eklendi: ${kod} (${aciklama})`);
}

function yeniKategoriIptal() {
  document.getElementById('yeniKategoriAlani').style.display = 'none';
  document.getElementById('yeniKategoriKodu').value = '';
  document.getElementById('yeniKategoriAciklama').value = '';
}

// Rol yönetimi
function rolEkleModal() {
  document.getElementById('yeniRolAlani').style.display = 'block';
  document.getElementById('yeniRolKodu').focus();
}

function yeniRolKaydet() {
  const kod = document.getElementById('yeniRolKodu').value.trim().toLowerCase();
  const aciklama = document.getElementById('yeniRolAciklama').value.trim();
  
  if (!kod || !aciklama) {
    alert('⚠️ Lütfen hem kod hem açıklama girin!');
    return;
  }
  
  // Kod validasyonu
  if (!/^[a-z]+$/.test(kod)) {
    alert('⚠️ Kod sadece küçük harflerden oluşmalı! (örn: pasta)');
    return;
  }
  
  // Mevcut rollerde kontrol et
  const select = document.getElementById('yemekRol');
  const existingOptions = Array.from(select.options);
  const exists = existingOptions.some(opt => opt.value === kod);
  
  if (exists) {
    alert('⚠️ Bu kod zaten mevcut! Farklı bir kod deneyin.');
    return;
  }
  
  // Yeni rolü ekle
  const newOption = document.createElement('option');
  newOption.value = kod;
  newOption.textContent = `${kod} (${aciklama})`;
  
  // "+ YENİ ROL EKLE" seçeneğinden önce ekle
  const yeniEkleOption = select.querySelector('option[value="__YENI__"]');
  select.insertBefore(newOption, yeniEkleOption);
  
  // LocalStorage'a kaydet
  let userRoles = JSON.parse(localStorage.getItem('userRoles') || '[]');
  userRoles.push({kod, aciklama});
  localStorage.setItem('userRoles', JSON.stringify(userRoles));
  
  // Yeni rolü seç
  select.value = kod;
  
  // Formu temizle ve gizle
  yeniRolIptal();
  
  console.log(`✅ Yeni rol eklendi: ${kod} (${aciklama})`);
}

function yeniRolIptal() {
  document.getElementById('yeniRolAlani').style.display = 'none';
  document.getElementById('yeniRolKodu').value = '';
  document.getElementById('yeniRolAciklama').value = '';
}

// Öğün tipi yönetimi
function ogunEkleModal() {
  document.getElementById('yeniOgunAlani').style.display = 'block';
  document.getElementById('yeniOgunKodu').focus();
}

function yeniOgunKaydet() {
  const kod = document.getElementById('yeniOgunKodu').value.trim().toLowerCase();
  const aciklama = document.getElementById('yeniOgunAciklama').value.trim();
  
  if (!kod || !aciklama) {
    alert('⚠️ Lütfen hem kod hem açıklama girin!');
    return;
  }
  
  // Kod validasyonu
  if (!/^[a-z]+$/.test(kod)) {
    alert('⚠️ Kod sadece küçük harflerden oluşmalı! (örn: brunch)');
    return;
  }
  
  // Mevcut öğün tiplerinde kontrol et
  const existingCheckbox = document.getElementById(`yemek${kod.charAt(0).toUpperCase() + kod.slice(1)}`);
  if (existingCheckbox) {
    alert('⚠️ Bu öğün tipi zaten mevcut!');
    return;
  }
  
  // Yeni checkbox oluştur
  const dinamikContainer = document.getElementById('dinamikOgunler');
  const label = document.createElement('label');
  label.style.cssText = 'display: flex; align-items: center; gap: 5px; font-size: 13px;';
  
  const checkbox = document.createElement('input');
  checkbox.type = 'checkbox';
  checkbox.id = `yemek${kod.charAt(0).toUpperCase() + kod.slice(1)}`;
  checkbox.value = kod;
  
  label.appendChild(checkbox);
  label.appendChild(document.createTextNode(` ${kod.charAt(0).toUpperCase() + kod.slice(1)} (${aciklama})`));
  
  dinamikContainer.appendChild(label);
  
  // LocalStorage'a kaydet
  let userMealTypes = JSON.parse(localStorage.getItem('userMealTypes') || '[]');
  userMealTypes.push({kod, aciklama});
  localStorage.setItem('userMealTypes', JSON.stringify(userMealTypes));
  
  // Yeni öğün tipini seç
  checkbox.checked = true;
  
  // Formu temizle ve gizle
  yeniOgunIptal();
  
  console.log(`✅ Yeni öğün tipi eklendi: ${kod} (${aciklama})`);
}

function yeniOgunIptal() {
  document.getElementById('yeniOgunAlani').style.display = 'none';
  document.getElementById('yeniOgunKodu').value = '';
  document.getElementById('yeniOgunAciklama').value = '';
}

// Sayfa yüklendiğinde kullanıcı seçeneklerini yükle
function dinamikSecenekleriYukle() {
  // Kategoriler
  const userCategories = JSON.parse(localStorage.getItem('userCategories') || '[]');
  const categorySelect = document.getElementById('yemekKategori');
  const yeniKategoriOption = categorySelect.querySelector('option[value="__YENI__"]');
  
  userCategories.forEach(cat => {
    const option = document.createElement('option');
    option.value = cat.kod;
    option.textContent = `${cat.kod} (${cat.aciklama})`;
    categorySelect.insertBefore(option, yeniKategoriOption);
  });
  
  // Roller
  const userRoles = JSON.parse(localStorage.getItem('userRoles') || '[]');
  const roleSelect = document.getElementById('yemekRol');
  const yeniRolOption = roleSelect.querySelector('option[value="__YENI__"]');
  
  userRoles.forEach(role => {
    const option = document.createElement('option');
    option.value = role.kod;
    option.textContent = `${role.kod} (${role.aciklama})`;
    roleSelect.insertBefore(option, yeniRolOption);
  });
  
  // Öğün tipleri
  const userMealTypes = JSON.parse(localStorage.getItem('userMealTypes') || '[]');
  const dinamikContainer = document.getElementById('dinamikOgunler');
  
  userMealTypes.forEach(meal => {
    const label = document.createElement('label');
    label.style.cssText = 'display: flex; align-items: center; gap: 5px; font-size: 13px;';
    
    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.id = `yemek${meal.kod.charAt(0).toUpperCase() + meal.kod.slice(1)}`;
    checkbox.value = meal.kod;
    
    label.appendChild(checkbox);
    label.appendChild(document.createTextNode(` ${meal.kod.charAt(0).toUpperCase() + meal.kod.slice(1)} (${meal.aciklama})`));
    
    dinamikContainer.appendChild(label);
  });
}

// Sayfa yüklendiğinde dinamik seçenekleri yükle
document.addEventListener('DOMContentLoaded', function() {
  setTimeout(dinamikSecenekleriYukle, 100); // Modal tamamen yüklendikten sonra
});

async function yemekGithubKaydet(yemekData, mod, originalData = {}) {
  try {
    const token = document.getElementById('githubToken').value.trim();
    
    if (!token) {
      alert('⚠️ GitHub token gerekli!\nSağ üst köşeden GitHub token\'ınızı girin.');
      return false;
    }

    // GitHub'dan mevcut food_list.json'ı al
    console.log('📥 GitHub\'dan mevcut food_list.json alınıyor...');
    
    // 🔄 Raw URL kullan encoding sorunları için
    const rawResponse = await fetch(`https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli-4/refs/heads/main/food_list.json?nocache=${Date.now()}&t=${Math.random()}`);
    if (!rawResponse.ok) {
      throw new Error('food_list.json dosyası GitHub\'dan alınamadı (raw)');
    }
    const currentContent = await rawResponse.json();
    console.log('  Raw food_list.json yüklendi:', Object.keys(currentContent));
    console.log('🕵️ DEBUG: Raw ilk yemek:', currentContent.categories?.[0]?.items?.[0]);
    // Optimistic UI için önceki state'i sakla
    let prevSaved = null;
    try {
      prevSaved = window.lastSavedFoodData ? JSON.parse(JSON.stringify(window.lastSavedFoodData)) : null;
    } catch {}
    
    // GitHub API'dan sadece SHA al
    const getResponse = await fetch('https://api.github.com/repos/mustafasacar35/lipodem-takip-paneli-4/contents/food_list.json', {
      headers: {
        'Authorization': `token ${token}`,
        'Accept': 'application/vnd.github.v3+json'
      }
    });

    if (!getResponse.ok) {
      throw new Error('food_list.json SHA bilgisi alınamadı');
    }

  const fileData = await getResponse.json();
  console.log('🕵️ DEBUG: GitHub API dosya SHA:', fileData.sha);

    // Yardımcı: TR normalize (eşleştirme için)
    const normTr = (s) => (s || '')
      .toString()
      .toLowerCase()
      .replace(/ç/g, 'c').replace(/ğ/g, 'g').replace(/ş/g, 's')
      .replace(/ü/g, 'u').replace(/ö/g, 'o').replace(/ı/g, 'i').replace(/i̇/g, 'i')
      .replace(/\s+/g, ' ') // iç boşlukları sadeleştir
      .trim();

    // Yeni yemeği uygun kategoriye ekle/güncelle
    let kategoriIndex = currentContent.categories.findIndex(cat => cat.name === yemekData.category);
    
    if (kategoriIndex === -1) {
      // Kategori yoksa oluştur
      currentContent.categories.push({
        name: yemekData.category,
        items: []
      });
      kategoriIndex = currentContent.categories.length - 1;
      console.log('➕ Yeni kategori oluşturuldu:', yemekData.category);
    }

    if (mod === 'ekle') {
      // Yeni yemek ekle
      currentContent.categories[kategoriIndex].items.push(yemekData);
      console.log('➕ Yeni yemek eklendi:', yemekData.name);
    } else if (mod === 'sil') {
      // Yemek sil - tüm kategorilerde ara ve sil
      let silindi = false;
      const silinecekIsim = yemekData.name || yemekData.ad;
      const normTrName = normTr(silinecekIsim);
      
      for (let ci = 0; ci < currentContent.categories.length; ci++) {
        const items = currentContent.categories[ci].items;
        for (let ii = items.length - 1; ii >= 0; ii--) {
          const itemName = items[ii]?.name || items[ii]?.ad || '';
          if (normTr(itemName) === normTrName) {
            items.splice(ii, 1);
            console.log(`🗑️ Yemek silindi: "${itemName}" (${currentContent.categories[ci].name} kategorisinden)`);
            silindi = true;
          }
        }
      }
      
      if (!silindi) {
        console.warn(`⚠️ Silinecek yemek bulunamadı: "${silinecekIsim}"`);
      }
    } else {
      // Mevcut yemeği güncelle: isim-normalize ile TÜM kategorilerde bul ve TEKİL hale getir
      const originalName = originalData.originalName || originalData.name || yemekData.name;
      const originalCategory = originalData.category || yemekData.category;
      const targetCategoryName = currentContent.categories[kategoriIndex].name;
      const isSameNorm = (a, b) => normTr(a) === normTr(b);

      // Eşleşen tüm pozisyonları topla (hem orijinal isim hem yeni isim)
      const matches = [];
      for (let ci = 0; ci < currentContent.categories.length; ci++) {
        const items = currentContent.categories[ci].items;
        for (let ii = 0; ii < items.length; ii++) {
          const nm = items[ii]?.name || '';
          if (isSameNorm(nm, originalName) || isSameNorm(nm, yemekData.name)) {
            matches.push({ ci, ii });
          }
        }
      }

      // Öncelik: orijinal kategorideki eşleşme; yoksa ilk bulunan
      let primary = null;
      if (matches.length) {
        primary = matches.find(m => currentContent.categories[m.ci].name === originalCategory) || matches[0];
      }

      if (primary) {
        // Diğer kopyaları sil (index kaymaması için büyük -> küçük sırala)
        const others = matches.filter(m => !(m.ci === primary.ci && m.ii === primary.ii))
                              .sort((a,b) => a.ci === b.ci ? b.ii - a.ii : b.ci - a.ci);
        for (const m of others) {
          currentContent.categories[m.ci].items.splice(m.ii, 1);
        }

        // Primary öğeyi güncelle veya hedef kategoriye taşı
        if (currentContent.categories[primary.ci].name !== targetCategoryName) {
          const [removed] = currentContent.categories[primary.ci].items.splice(primary.ii, 1);
          currentContent.categories[kategoriIndex].items.unshift({ ...yemekData, category: targetCategoryName });
          console.log(`🔀 Yemek kategori değişti: ${currentContent.categories[primary.ci].name} → ${targetCategoryName}`);
        } else {
          currentContent.categories[primary.ci].items[primary.ii] = { ...yemekData, category: targetCategoryName };
          console.log('💾 Yemek güncellendi (tekil):', yemekData.name);
        }
      } else {
        // Bulunamadı → hedef kategoride ad eşleşmesi varsa onu güncelle; yoksa ekle
        const items = currentContent.categories[kategoriIndex].items;
        const idx = items.findIndex(it => isSameNorm(it.name, yemekData.name));
        if (idx !== -1) {
          items[idx] = { ...yemekData, category: targetCategoryName };
          console.log('💾 Yemek güncellendi (hedef kategoride ad ile):', yemekData.name);
        } else {
          items.unshift({ ...yemekData, category: targetCategoryName });
          console.warn('➕ Güncellenemedi, yeni olarak eklendi (hedef kategori başına):', yemekData.name);
        }
      }
    }

    // 🔄 OPTIMISTIC UI: GitHub yanıtını beklemeden UI'ı güncelle
    try {
      window.lastSavedFoodData = currentContent; // tam JSON
      window.lastSavedFoodDataTs = Date.now();
      if (typeof flattenFoodDataToGlobal === 'function') {
        flattenFoodDataToGlobal(currentContent);
      }
      
      // window.allFoods'u da güncel data ile güncelle
      try {
        if (window.allFoods && Array.isArray(window.allFoods)) {
          // Flat liste oluştur
          const flatList = [];
          if (currentContent.categories && Array.isArray(currentContent.categories)) {
            currentContent.categories.forEach(cat => {
              const kategori = cat?.name || 'GENEL';
              if (cat?.items && Array.isArray(cat.items)) {
                cat.items.forEach(item => {
                  flatList.push({
                    ad: item.name || '',
                    kategori: item.category || kategori,
                    kalori: item.calories || 0,
                    protein: item.protein || 0,
                    karbonhidrat: item.carbs || 0,
                    yag: item.fat || 0,
                    role: item.role || 'mainDish',
                    mealType: item.mealType || [],
                    keto: item.keto || false,
                    lowcarb: item.lowcarb || false,
                    fillerLunch: item.fillerLunch || false,
                    fillerDinner: item.fillerDinner || false,
                    etiketler: item.tags || [],
                    compatibilityTags: item.compatibilityTags || [],
                    incompatibilityTags: item.incompatibilityTags || []
                  });
                });
              }
            });
          }
          window.allFoods = flatList;
          console.log('🔄 window.allFoods güncellendi:', flatList.length, 'yemek');
        }
      } catch (e) {
        console.warn('⚠️ window.allFoods güncellenemedi:', e);
      }
      
      // Tabloyu ve listeleri anında tazele
      try { updateYemekVeritabaniAnalizi(); } catch {}
      try { eslesmeyenlerListesiniGuncelle(); } catch {}
      
      // Veritabanı tablosunu da güncelle
      try {
        const veriPanel = document.getElementById('yemekVeriTabaniPanel');
        if (veriPanel && veriPanel.style.display !== 'none') {
          console.log('🔄 Optimistic UI: Veritabanı tablosu güncelleniyor...');
          // Veritabanı listesini yeniden yükle
          if (typeof yemekVeriTabaniYukle === 'function') {
            yemekVeriTabaniYukle();
          } else {
            yemekVeriTabaniFiltrele();
          }
        }
      } catch {}
      
    } catch (e) {
      console.warn('⚠️ Optimistic UI güncellenemedi:', e);
    }

    // Güncellenmiş içeriği GitHub'a gönder (Türkçe karakter uyumlu)
    const updatedContent = encodeUTF8ToBase64(currentContent);
    
    const updateResponse = await fetch('https://api.github.com/repos/mustafasacar35/lipodem-takip-paneli-4/contents/food_list.json', {
      method: 'PUT',
      headers: {
        'Authorization': `token ${token}`,
        'Accept': 'application/vnd.github.v3+json',
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        message: mod === 'ekle' ? 
          `🍽️ Yeni yemek eklendi: ${yemekData.name}` : 
          mod === 'sil' ?
          `🗑️ Yemek silindi: ${yemekData.name}` :
          `💾 Yemek güncellendi: ${yemekData.name}`,
        content: updatedContent,
        sha: fileData.sha
      })
    });

    if (!updateResponse.ok) {
      const errorData = await updateResponse.json();
      throw new Error(`GitHub güncelleme hatası: ${errorData.message}`);
    }

  console.log('✅ food_list.json GitHub\'a başarıyla kaydedildi');
    
    // 🔄 Lokal önbelleği güncelle: en güncel food_list'i hafızaya al ve düz listeyi tazele
    try {
      window.lastSavedFoodData = currentContent; // tam JSON
      window.lastSavedFoodDataTs = Date.now();
      if (typeof flattenFoodDataToGlobal === 'function') {
        flattenFoodDataToGlobal(currentContent);
      }
    } catch (e) {
      console.warn('⚠️ Lokal food_list önbelleğe alınamadı:', e);
    }
    
    // 🕵️ DEBUG: Kaydetme sonrası RAW URL'den kontrol et
    setTimeout(async () => {
      try {
        console.log('🕵️ DEBUG: Kaydetme sonrası RAW URL kontrolü yapılıyor...');
        const checkResponse = await fetch(`https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli-4/refs/heads/main/food_list.json?check=${Date.now()}`);
        
        if (checkResponse.ok) {
          const checkContent = await checkResponse.json();
          console.log('🕵️ DEBUG: Kaydetme sonrası RAW ilk yemek:', checkContent.categories?.[0]?.items?.[0]);
          
          // Kaydedilen yemeği bul
          let bulunan = false;
          checkContent.categories.forEach(cat => {
            cat.items.forEach(item => {
              if (item.name === yemekData.name) {
                console.log('✅ DEBUG: Kaydedilen yemek RAW URL\'de BULUNDU:', item);
                bulunan = true;
              }
            });
          });
          
          if (!bulunan) {
            console.error('🚨 DEBUG: Kaydedilen yemek RAW URL\'de BULUNAMADI!');
          }
        }
      } catch (err) {
        // Network errors ve GitHub API hatalarını daha iyi handle et
        if (err.name === 'TypeError' && err.message.includes('Failed to fetch')) {
          console.error('🚨 DEBUG: Ağ bağlantı hatası - internet bağlantısını kontrol edin:', err.message);
        } else if (err.message && err.message.includes('ERR_NETWORK_CHANGED')) {
          console.error('🚨 DEBUG: Ağ değişikliği hatası - bağlantı kesintisi oldu:', err.message);
        } else {
          console.error('🚨 DEBUG: Kaydetme sonrası RAW kontrol hatası:', err);
        }
      }
    }, 3000);
    
  // Otomatik senkronizasyon tetikle ve UI'ı anında güncelle
  try { updateYemekVeritabaniAnalizi(); } catch {}
  try { eslesmeyenlerListesiniGuncelle(); } catch {}
  yemekKaydetSonrasiSenkronizasyon();
    
    return true;
    
  } catch (error) {
    console.error('❌ GitHub kaydetme hatası:', error);
    // Optimistic UI'ı geri al
    try {
      if (typeof window !== 'undefined' && window.lastSavedFoodData && typeof flattenFoodDataToGlobal === 'function') {
        // prevSaved varsa geri dön
        if (typeof prevSaved !== 'undefined' && prevSaved) {
          window.lastSavedFoodData = prevSaved;
          window.lastSavedFoodDataTs = Date.now();
          flattenFoodDataToGlobal(prevSaved);
          try { updateYemekVeritabaniAnalizi(); } catch {}
          try { eslesmeyenlerListesiniGuncelle(); } catch {}
        }
      }
    } catch (revertErr) {
      console.warn('⚠️ Optimistic UI geri alınamadı:', revertErr);
    }
    
    // Hata detaylarını kullanıcıya göster
    if (error.message.includes('404')) {
      alert('❌ Dosya bulunamadı!\nRepo adresini kontrol edin: mustafasacar35/lipodem-takip-paneli-4');
    } else if (error.message.includes('401') || error.message.includes('403')) {
      alert('❌ Yetki hatası!\nGitHub token\'ınızı kontrol edin.');
    } else {
      alert(`❌ Beklenmeyen hata:\n${error.message}`);
    }
    
    return false;
  }
}

// 🗑️ YEMEK SİLME FONKSİYONU
async function yemekSil(yemekData) {
  const onay = confirm(`⚠️ "${yemekData.originalName}" yemeğini silmek istediğinizden emin misiniz?\n\nBu işlem geri alınamaz!`);
  
  if (!onay) return;
  
  try {
    const token = document.getElementById('githubToken').value.trim();
    
    if (!token) {
      alert('⚠️ GitHub token gerekli!\nSağ üst köşeden GitHub token\'ınızı girin.');
      return;
    }

    console.log('🗑️ Yemek siliniyor:', yemekData);

    // GitHub'dan mevcut food_list.json'ı al
    const getResponse = await fetch('https://api.github.com/repos/mustafasacar35/lipodem-takip-paneli-4/contents/food_list.json', {
      headers: {
        'Authorization': `token ${token}`,
        'Accept': 'application/vnd.github.v3+json'
      }
    });

    if (!getResponse.ok) {
      throw new Error('food_list.json dosyası GitHub\'dan alınamadı');
    }

  const fileData = await getResponse.json();
  const currentContent = JSON.parse(decodeBase64UTF8(fileData.content));
    
    // Yemeği bul ve sil
    let silindi = false;
    
    for (let kategori of currentContent.categories) {
      const itemIndex = kategori.items.findIndex(item => 
        item.name === yemekData.originalName || item.name === yemekData.name
      );
      
      if (itemIndex !== -1) {
        kategori.items.splice(itemIndex, 1);
        silindi = true;
        console.log('🗑️ Yemek silindi:', yemekData.originalName || yemekData.name);
        break;
      }
    }

    if (!silindi) {
      alert('❌ Silinecek yemek bulunamadı!');
      return;
    }

    // Güncellenmiş içeriği GitHub'a gönder (Türkçe karakter uyumlu)
  const updatedContent = encodeUTF8ToBase64(currentContent);
    
    const updateResponse = await fetch('https://api.github.com/repos/mustafasacar35/lipodem-takip-paneli-4/contents/food_list.json', {
      method: 'PUT',
      headers: {
        'Authorization': `token ${token}`,
        'Accept': 'application/vnd.github.v3+json',
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        message: `🗑️ Yemek silindi: ${yemekData.originalName || yemekData.name}`,
        content: updatedContent,
        sha: fileData.sha
      })
    });

    if (!updateResponse.ok) {
      const errorData = await updateResponse.json();
      throw new Error(`GitHub güncelleme hatası: ${errorData.message}`);
    }

    showToast('Yemek başarıyla silindi!', 'success');
    console.log('✅ Yemek GitHub\'dan başarıyla silindi');
    
    // Veritabanı analizini güncelle
    setTimeout(() => {
      updateYemekVeritabaniAnalizi();
    }, 1000);
    
  } catch (error) {
    console.error('❌ Yemek silme hatası:', error);
    
    if (error.message.includes('404')) {
      alert('❌ Dosya bulunamadı!\nRepo adresini kontrol edin.');
    } else if (error.message.includes('401') || error.message.includes('403')) {
      alert('❌ Yetki hatası!\nGitHub token\'ınızı kontrol edin.');
    } else {
      alert(`❌ Silme hatası:\n${error.message}`);
    }
  }
}

    function gptMesajKaydet(i) {
      const hafta = getHaftaListesi()[i];
      
      // Kilit kontrolü
      if (hafta.kilitli) {
        alert('🔒 Bu hafta kilitli! GPT mesajını değiştirmek için önce kilidi açın.');
        return;
      }
      
      hafta.gptMesaj = document.getElementById('gptMesaj_' + i).value;
      saveToStorage();
      
      console.log('✅ GPT mesajı kaydedildi hafta:', i + 1);
      
      // YENİ SİSTEM: GitHub'a da kaydet
      if (seciliHasta) {
        hastayiAyriKaydet(seciliHasta).then(basarili => {
          if (basarili) {
            console.log('✅ GPT mesajı GitHub\'a da kaydedildi');
          } else {
            console.warn('⚠️ GPT mesajı localStorage\'a kaydedildi ama GitHub kaydı başarısız');
          }
        }).catch(error => {
          console.error('❌ GitHub kaydetme hatası:', error);
        });
      }
      
      showToast('💾 Hafta mesajı kaydedildi!');
    }
    // --- JSON dışa aktar/yükle fonksiyonları ---
    function exportData() {
      // Kullanıcıya seçenek sun
      const tariflerDahil = confirm('Tarif verilerini de dahil etmek istiyor musunuz?\n\n✅ EVET: Tam veri (daha büyük dosya)\n❌ HAYIR: Sadece önemli veriler (küçük dosya, GitHub ile uyumlu)');
      
      let dataToExport;
      
      if (tariflerDahil) {
        // Tüm veriler dahil
        dataToExport = hastalar;
        console.log('📤 Tam veriler (tarifler dahil) JSON olarak hazırlanıyor...');
      } else {
        // Tarifler olmadan
        dataToExport = hastalar.map(hasta => {
          return {
            ...hasta,
            haftalar: (hasta.haftalar || []).map(hafta => {
              const { tarifler, ...haftaWithoutTarifler } = hafta;
              return haftaWithoutTarifler;
            })
          };
        });
        console.log('📤 Kompakt veriler (tarifler hariç) JSON olarak hazırlanıyor...');
      }
      
      const dataStr = JSON.stringify(dataToExport, null, 2);
      const blob = new Blob([dataStr], {type: 'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = tariflerDahil ? 'hasta_kayitlari_tam.json' : 'hasta_kayitlari.json';
      document.body.appendChild(a);
      a.click();
      setTimeout(() => { document.body.removeChild(a); URL.revokeObjectURL(url); }, 100);
      
      console.log('📤 Hasta verileri JSON olarak indirildi:', tariflerDahil ? '(tam veri)' : '(kompakt veri)');
      console.log('💾 Data klasörüne kaydetmek için indirilen dosyayı ./data/hasta_kayitlari.json olarak kaydedin');
    }

    function importData(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = JSON.parse(e.target.result);
          if (Array.isArray(data)) {
            hastalar = data;
            
            // Hasta listesini otomatik sırala (isim sırası)
            hastalar.sort((a, b) => a.isim.localeCompare(b.isim, 'tr'));
            
            saveToStorage();
            renderHastalar();
            alert('Veriler başarıyla yüklendi ve sıralandı!');
          } else {
            alert('Geçersiz JSON formatı!');
          }
        } catch(err) {
          alert('JSON okuma hatası: ' + err);
        }
      };
      reader.readAsText(file);
      event.target.value = '';
    }

    function kopyalaGptMesaj(i) {
      const textarea = document.getElementById('gptMesaj_' + i);
      textarea.select();
      textarea.setSelectionRange(0, 99999); // mobile uyumlu
      document.execCommand('copy');
      alert('GPT mesajı kopyalandı!');
    }
    window.kopyalaGptMesaj = kopyalaGptMesaj;

    // Ortak fonksiyonlar
    
    // Tüm hasta JSON'larından eslesmeyenTarifler verilerini temizle
    async function temizleEslesmeyenTarifleriJSON() {
      console.log('🧹 Tüm hasta JSON\'larından eslesmeyenTarifler verileri temizleniyor...');
      
      const hastalar = getHastaListesi();
      let temizlenenSayisi = 0;
      
      for (const hasta of hastalar) {
        let temizlemeYapildi = false;
        
        if (hasta.haftalar) {
          hasta.haftalar.forEach(hafta => {
            if (hafta.eslesmeyenTarifler) {
              delete hafta.eslesmeyenTarifler;
              temizlemeYapildi = true;
            }
          });
        }
        
        if (temizlemeYapildi) {
          await hastayiAyriKaydet(hasta);
          temizlenenSayisi++;
          console.log(`✅ ${hasta.isim} - eslesmeyenTarifler verileri temizlendi`);
        }
      }
      
      console.log(`🎯 Toplam ${temizlenenSayisi} hasta JSON'u temizlendi`);
      
      if (temizlenenSayisi > 0) {
        alert(`✅ ${temizlenenSayisi} hasta JSON dosyasından eşleşmeyen tarif verileri temizlendi!\n\nArtık JSON dosyaları daha küçük ve hızlı olacak.`);
      } else {
        alert('✅ Tüm JSON dosyaları zaten temiz!');
      }
    }
    
    // Global olarak erişilebilir yap
    window.temizleEslesmeyenTarifleriJSON = temizleEslesmeyenTarifleriJSON;

  function extractTariflerDetay(text) {
      console.log('🔍 extractTariflerDetay başlıyor...');
      console.log('📄 Ham metin uzunluğu:', text.length);
      
      // Her satırı temizle, başında * veya miktar varsa da al
      let lines = text.split('\n').map(line => line.trim()).filter(l => l.length > 1);

      // 1) PDF başındaki isim/tarih ve genel talimatları atla: İlk görünen GÜN ismine kadar kırp
      try {
        const dayNames = ['pazartesi','sali','carsamba','persembe','cuma','cumartesi','pazar'];
        const findFirstDayIndex = () => {
          for (let i = 0; i < lines.length; i++) {
            const norm = turkishToAscii(lines[i] || '').toLowerCase();
            for (const g of dayNames) {
              // Kelime sınırı benzeri: satırın herhangi yerinde gün adı geçsin
              if (new RegExp(`(^|[^a-z])${g}([^a-z]|$)`).test(norm)) {
                return i;
              }
            }
          }
          return -1;
        };
        const firstDayIdx = findFirstDayIndex();
        if (firstDayIdx > 0) {
          console.log(`✂️ Baş kısım atlandı: ${firstDayIdx} satır (ilk gün: ${lines[firstDayIdx]})`);
          lines = lines.slice(firstDayIdx);
        }

        // 2) GÜN başlıklarını ve gereksiz üstbilgi satırlarını tamamen filtrele
        const isPureDayHeader = (s) => {
          const n = turkishToAscii((s || '')).toLowerCase().replace(/[^a-z0-9\s:]/g, '').trim();
          // Not: RegExp ctor kullanırken \s kaçışı çift yazılmalı
          return dayNames.some(g => new RegExp('^' + g + '\\s*:?$').test(n));
        };
        lines = lines.filter(l => {
          const n = turkishToAscii(l).toLowerCase();
          // "hafta" içeren başlıkları at
          if (/\bhafta\b/.test(n)) return false;
          // genelde sabah rutini talimatı: "her sabah", "gune baslarken"
          if (n.includes('her sabah') || n.includes('gune baslarken')) return false;
          // Salt gün başlıklarını at
          if (isPureDayHeader(l)) return false;
          return true;
        });
      } catch (e) {
        console.warn('⚠️ Gün kırpma/başlık filtreleme sırasında hata:', e);
      }
      console.log('📝 Toplam satır sayısı (>1 karakter):', lines.length);
      
      // * ile başlayan satırları özel olarak logla
      const yildizliSatirlar = lines.filter(l => /^\*/.test(l));
      console.log('⭐ * ile başlayan satırlar:', yildizliSatirlar);
      
      // Avokado içeren satırları bul
      const avokadoSatirlar = lines.filter(l => l.toLowerCase().includes('avokado'));
      console.log('🥑 "avokado" içeren satırlar:', avokadoSatirlar);
      
      // Tavuk içeren satırları bul
      const tavukSatirlar = lines.filter(l => l.toLowerCase().includes('tavuk'));
      console.log('🐔 "tavuk" içeren satırlar:', tavukSatirlar);
      
      // Pirzola içeren satırları bul
      const pirzolaSatirlar = lines.filter(l => l.toLowerCase().includes('pirzola'));
      console.log('🥩 "pirzola" içeren satırlar:', pirzolaSatirlar);
      
      // Satır başında rakam, *, miktar, FRAKSİYON/ONDALIK, büyük harf, veya yemek adı olabilecek her şeyi al
      const filtered = lines.filter(l =>
        /^[0-9]+\./.test(l) || // 1. ...
        /^\*/.test(l) || // * ...
        // miktar ile başlayan (nokta, virgül, boşluk veya satır sonu ile biter)
        /^[0-9]+[\.,]?\s*(gram|gr|adet|yemek\s*kaşığı|tatlı\s*kaşığı|su\s*bardağı|dilim|kase|çay\s*bardağı|bardak|kaşık|tbsp|tsp|ml|kg|g)(\s|\.|\,|$)/i.test(l) ||
        // fraksiyon (1/2, 3/4), unicode fraksiyon (½), veya ondalık (0.5) ile başlayıp ardından kelime gelen satırlar
        /^([0-9]+\/[0-9]+)\s+\S+/.test(l) ||
        /^[¼½¾⅓⅔⅛⅜⅝⅞]\s+\S+/.test(l) ||
        /^[0-9]+[\.,][0-9]+\s+\S+/.test(l) ||
        // düz sayı + kelime (örn: "1 avokado")
        /^[0-9]+\s+\S+/.test(l) ||
        /^[A-ZİIıĞğÜüŞşÖöÇç]/.test(l) // büyük/özel Türkçe harf ile başlayan
      );
      
      console.log('🔍 Filtrelenmiş satır sayısı:', filtered.length);
      console.log('📋 Filtrelenmiş satırlar:', filtered);
      
      // Baştaki numara, * işareti ve miktar kısmını temizle, ama yemek adını koru
      const result = filtered.map(line => {
        let temizlenmis = line;
        
        // Baştaki numara temizle
        temizlenmis = temizlenmis.replace(/^[0-9]+\.\s*/, '');
        
        // Baştaki yıldız temizle
        temizlenmis = temizlenmis.replace(/^\*+\s*/, '');

        // NOT: Görselde "1/2 avokado" gibi ifadeleri KORU. Sadece baştaki miktar bir ÜNİT ile birlikteyse kaldır.
        // Örn: "150 gr tavuk" → miktarı kaldır; "1/2 avokado" → bırak.
        const unitGroup = '(gram|gr|adet|yemek\\s*kaşığı|tatlı\\s*kaşığı|su\\s*bardağı|dilim|kase|çay\\s*bardağı|bardak|kaşık|tbsp|tsp|ml|kg|g)';
        const leadingFractionWithUnit = new RegExp('^((?:[0-9]+\\/[0-9]+)|(?:[¼½¾⅓⅔⅛⅜⅝⅞])|(?:[0-9]+[\\.,][0-9]+))\\s*' + unitGroup + '(?:[\\.,]?\\s*)', 'i');
        const leadingWordQtyWithUnit = new RegExp('^(yarım|yarim|çeyrek|ceyrek)\\s+' + unitGroup + '(?:[\\.,]?\\s*)', 'i');
        if (leadingFractionWithUnit.test(temizlenmis)) {
          const once = temizlenmis;
          temizlenmis = temizlenmis.replace(leadingFractionWithUnit, '');
          console.log(`🧮 FRAKSİYON+ÜNİT BAŞLANGIÇ TEMİZLENDİ: "${once}" → "${temizlenmis}"`);
        }
        if (leadingWordQtyWithUnit.test(temizlenmis)) {
          const once = temizlenmis;
          temizlenmis = temizlenmis.replace(leadingWordQtyWithUnit, '');
          console.log(`🧮 KELİME MİKTAR+ÜNİT BAŞLANGIÇ TEMİZLENDİ: "${once}" → "${temizlenmis}"`);
        }
        
        // Miktar kısmını akıllıca temizle - sadece başındakini al, ortadakini bırak
        // "150 gr. Tavuk pirzola" → "Tavuk pirzola"
        // "150gr Köfte" → "Köfte" 
        // "100 gram Et" → "Et"
        // "150 gr." → "" (sadece miktar varsa boş döner)
  const miktarRegex = /^([0-9]+[\.,]?\s*)(gram|gr|adet|yemek\s*kaşığı|tatlı\s*kaşığı|su\s*bardağı|dilim|kase|çay\s*bardağı|bardak|kaşık|tbsp|tsp|ml|kg|g)[\.,]?\s*/i;
        temizlenmis = temizlenmis.replace(miktarRegex, '');
        
        // Fazla boşlukları temizle
        temizlenmis = temizlenmis.replace(/\s+/g, ' ').trim().toLowerCase();
        
        // Miktar içeren satırları özel logla
        if (line.match(/^[0-9]+\s*(gram|gr|adet|yemek\s*kaşığı|tatlı\s*kaşığı|su\s*bardağı|dilim|kase|çay\s*bardağı|bardak|kaşık|tbsp|tsp|ml|kg|g)/i)) {
          console.log(`⚖️ MIKTAR SATIRI: "${line}" → "${temizlenmis}"`);
        }
        
        // Avokado içeren satırları özel logla
        if (line.toLowerCase().includes('avokado')) {
          console.log(`🥑 AVOKADO SATIRI: "${line}" → "${temizlenmis}"`);
        }
        
        // Tavuk içeren satırları özel logla
        if (line.toLowerCase().includes('tavuk')) {
          console.log(`🐔 TAVUK SATIRI: "${line}" → "${temizlenmis}"`);
        }
        
        // Pirzola içeren satırları özel logla
        if (line.toLowerCase().includes('pirzola')) {
          console.log(`🥩 PIRZOLA SATIRI: "${line}" → "${temizlenmis}"`);
        }
        
        return temizlenmis;
      });
      
  // Split kurallarını otomatik uygula
  const autoApplied = applySplitKurallariToList(result);
  console.log('✅ Final tarif listesi (split kuralları uygulandı):', autoApplied);
  console.log('🥑 Final listede avokado var mı?', autoApplied.filter(r => r.includes('avokado')));
  console.log('🐔 Final listede tavuk var mı?', autoApplied.filter(r => r.includes('tavuk')));
  console.log('🥩 Final listede pirzola var mı?', autoApplied.filter(r => r.includes('pirzola')));
      
  return autoApplied;
    }

    function normalizeNameDetay(name) {
      return name
        .toLowerCase()
        .replace(/ç/g, 'c').replace(/ğ/g, 'g').replace(/ş/g, 's')
        .replace(/ü/g, 'u').replace(/ö/g, 'o').replace(/ı/g, 'i')
        .replace(/\s+/g, '_')
        .replace(/[^a-z0-9_]/g, '');
    }

    // Sayfa açılışında storage'dan yükle ve listele
    renderHastalar();

    // Özel Lenf Masaj PDF oluşturucu (5. hafta ZIP benzeri)
    async function generateCustomLenfMasajPDF(hastaAdi, baslangicTarihi) {
      try {
        console.log('💆 Özel Lenf Masaj PDF oluşturuluyor...', { hastaAdi, baslangicTarihi });
        
        // jsPDF kütüphane kontrolü
        let jsPDFLib;
        if (typeof window.jspdf !== 'undefined') {
          jsPDFLib = window.jspdf.jsPDF;
          console.log('✅ jsPDF window.jspdf.jsPDF üzerinden yüklendi');
        } else if (typeof jsPDF !== 'undefined') {
          jsPDFLib = jsPDF;
          console.log('✅ jsPDF global jsPDF üzerinden yüklendi');
        } else {
          console.log('❌ jsPDF bulunamadı, dinamik yükleme yapılıyor...');
          
          // Dinamik jsPDF yükleme
          const script = document.createElement('script');
          script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
          script.onload = () => {
            console.log('✅ jsPDF dinamik olarak yüklendi');
            setTimeout(() => generateCustomLenfMasajPDF(hastaAdi, baslangicTarihi), 100);
          };
          script.onerror = () => {
            console.log('❌ jsPDF yüklenemedi');
            alert('PDF kütüphanesi yüklenemedi. Lütfen internet bağlantınızı kontrol edin.');
          };
          document.head.appendChild(script);
          return; // Fonksiyondan çık, yükleme sonrası tekrar çalışacak
        }
        
        const doc = new jsPDFLib('p', 'mm', 'a4'); // ZIP sistemiyle ayn  format
        
        // Hasta adını ASCII'ye çevir (ZIP sistemiyle aynı)
        console.log('🔍 Orijinal hasta adı:', hastaAdi);
        const asciiHastaAdi = hastaAdi
            .replace(/Ş/g, 'S').replace(/ş/g, 's')
            .replace(/Ğ/g, 'G').replace(/ğ/g, 'g')
            .replace(/Ü/g, 'U').replace(/ü/g, 'u')
            .replace(/İ/g, 'I').replace(/ı/g, 'i')
            .replace(/Ö/g, 'O').replace(/ö/g, 'o')
            .replace(/Ç/g, 'C').replace(/ç/g, 'c')
            .replace(/Ə/g, 'E').replace(/ə/g, 'e');
        console.log('🔍 ASCII hasta adı:', asciiHastaAdi);
        
        // Başlık - ZIP sistemindeki gibi
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(14);
        doc.setTextColor(0, 0, 0);
        
        const title = `${asciiHastaAdi.toUpperCase()}`;
        const titleWidth = doc.getTextWidth(title);
        doc.text(title, (210 - titleWidth) / 2, 20);
        
        doc.setFontSize(12);
        doc.setTextColor(0, 0, 0);
        
        // Lenf masaj başlığı - ASCII karakterlerle
        const subtitle = 'LENF DRENAJ MASAJI PROGRAMI';
        const programBasligi = '8 Haftalik Lenf Drenaj Masaji Uygulama Programi';
        
        const subtitleWidth = doc.getTextWidth(subtitle);
        doc.text(subtitle, (210 - subtitleWidth) / 2, 28);
        
        // Açıklama kutusu
        doc.setFontSize(8);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(0, 0, 0);
        doc.rect(15, 32, 170, 10);
        doc.text(programBasligi, 20, 36);
        doc.text(turkceKarakterDuzelt('(5. Haftadan itibaren)'), 20, 40);
        
        // Tab başlangıç tarihi zaten pazartesi olarak planlanmış, değiştirme
        console.log('🔍 Tekli lenf masaj - 5. hafta tab başlangıç tarihi (pazartesi olarak kabul):', baslangicTarihi.toLocaleDateString('tr-TR'));
        
        // Tab tarihi direkt kullan - zaten hafta başı olarak planlanmış
        const hizalanmisBaslangic = baslangicTarihi;
        
        // 5. haftanın başlangıcı
        let currentY = 50;
        const gunler = ['Pazartesi', 'Sali', 'Carsamba', 'Persembe', 'Cuma', 'Cumartesi', 'Pazar'].map(gun => turkceKarakterDuzelt(gun));
        
        // 8 haftalık lenf masaj programı (ZIP sistemindeki gibi)
        for (let lenfHaftaIndex = 0; lenfHaftaIndex < 8; lenfHaftaIndex++) {
          const gercekHaftaNo = lenfHaftaIndex + 5; // 5. haftadan başlar
          const haftaBaslangic = new Date(hizalanmisBaslangic.getTime() + (lenfHaftaIndex * 7 * 24 * 60 * 60 * 1000));
          
          // Sayfa sonu kontrolü - hafta başlığı için yer var mı?
          if (currentY > 270) {
            doc.addPage();
            currentY = 20;
          }
          
          // Hafta başlığı
          doc.setTextColor(0, 0, 0);
          doc.setFont('helvetica', 'bold');
          doc.setFontSize(9);
          doc.rect(15, currentY, 170, 6);
          
          const haftaBaslangicStr = haftaBaslangic.toLocaleDateString('tr-TR');
          const haftaBitisStr = new Date(haftaBaslangic.getTime() + (6 * 24 * 60 * 60 * 1000)).toLocaleDateString('tr-TR');
          
          doc.text(turkceKarakterDuzelt(`${gercekHaftaNo}. HAFTA (${haftaBaslangicStr} - ${haftaBitisStr})`), 20, currentY + 4);
          currentY += 8;
          
          // Tablo başlıkları - ZIP sistemindeki gibi
          doc.setTextColor(0, 0, 0);
          doc.setFont('helvetica', 'bold');
          doc.setFontSize(9);
          doc.setDrawColor(0, 0, 0);
          doc.setLineWidth(0.3);
          
          const colWidths = [30, 40, 50, 50]; // Tarih, Gün, Sabah, Akşam
          let zipTableStartX = 15;
          
          // Başlık satırı
          doc.rect(zipTableStartX, currentY, colWidths[0], 6);
          doc.text('TARIH', zipTableStartX + 2, currentY + 4);
          zipTableStartX += colWidths[0];
          
          doc.rect(zipTableStartX, currentY, colWidths[1], 6);
          doc.text('GUN', zipTableStartX + 2, currentY + 4);
          zipTableStartX += colWidths[1];
          
          doc.rect(zipTableStartX, currentY, colWidths[2], 6);
          doc.text('SABAH', zipTableStartX + 2, currentY + 4);
          zipTableStartX += colWidths[2];
          
          doc.rect(zipTableStartX, currentY, colWidths[3], 6);
          doc.text('AKSAM', zipTableStartX + 2, currentY + 4);
          currentY += 6;
          
          // Her gün için satır - ZIP sistemindeki gibi
          doc.setFont('helvetica', 'normal');
          doc.setFontSize(8);
          
          for (let gunIndex = 0; gunIndex < 7; gunIndex++) {
            // Sayfa sonu kontrolü - satır için yer var mı?
            if (currentY > 280) {
              doc.addPage();
              currentY = 20;
              
              // Yeni sayfada tablo başlıklarını tekrar oluştur
              doc.setTextColor(0, 0, 0);
              doc.setFont('helvetica', 'bold');
              doc.setFontSize(9);
              doc.setDrawColor(0, 0, 0);
              doc.setLineWidth(0.3);
              
              let newPageTableStartX = 15;
              
              // Başlık satırı
              doc.rect(newPageTableStartX, currentY, colWidths[0], 6);
              doc.text('TARIH', newPageTableStartX + 2, currentY + 4);
              newPageTableStartX += colWidths[0];
              
              doc.rect(newPageTableStartX, currentY, colWidths[1], 6);
              doc.text('GUN', newPageTableStartX + 2, currentY + 4);
              newPageTableStartX += colWidths[1];
              
              doc.rect(newPageTableStartX, currentY, colWidths[2], 6);
              doc.text('SABAH', newPageTableStartX + 2, currentY + 4);
              newPageTableStartX += colWidths[2];
              
              doc.rect(newPageTableStartX, currentY, colWidths[3], 6);
              doc.text('AKSAM', newPageTableStartX + 2, currentY + 4);
              currentY += 6;
              
              doc.setFont('helvetica', 'normal');
              doc.setFontSize(8);
            }
            
            const gunTarihi = new Date(haftaBaslangic.getTime() + (gunIndex * 24 * 60 * 60 * 1000));
            const tarihStr = gunTarihi.toLocaleDateString('tr-TR');
            const gun = gunler[gunIndex];
            
            // Lenf masaj uygulama kontrolü (ZIP sistemindeki aynı mantık)
            let sabahUygulama = '-';
            let aksamUygulama = '-';
            
            if (lenfHaftaIndex < 2) {
              // İlk 2 hafta (5-6): Günde 2 kez lenf masajı
              sabahUygulama = turkceKarakterDuzelt('Lenf Masaji');
              aksamUygulama = turkceKarakterDuzelt('Lenf Masaji');
            } else if (lenfHaftaIndex < 4) {
              // Sonraki 2 hafta (7-8): Günde 1 kez lenf masajı (sabah)
              sabahUygulama = turkceKarakterDuzelt('Lenf Masaji');
              aksamUygulama = '-';
            } else if (lenfHaftaIndex < 6) {
              // Sonraki 2 hafta (9-10): Günaşırı lenf masajı
              if (gunIndex === 0 || gunIndex === 2 || gunIndex === 4 || gunIndex === 6) {
                sabahUygulama = turkceKarakterDuzelt('Lenf Masaji');
                aksamUygulama = '-';
              } else {
                sabahUygulama = '-';
                aksamUygulama = '-';
              }
            } else {
              // Son 2 hafta (11-12): Haftada 2 gün (Salı-Cuma)
              if (gunIndex === 1 || gunIndex === 4) { // Salı, Cuma
                sabahUygulama = turkceKarakterDuzelt('Lenf Masaji');
                aksamUygulama = '-';
              } else {
                sabahUygulama = '-';
                aksamUygulama = '-';
              }
            }
            
            zipTableStartX = 15;
            
            // Tablo çizgi ayarları
            doc.setDrawColor(0, 0, 0);
            doc.setLineWidth(0.3);
            
            // Tarih sütunu
            doc.rect(zipTableStartX, currentY, colWidths[0], 5);
            doc.setTextColor(0, 0, 0);
            doc.text(tarihStr, zipTableStartX + 2, currentY + 3.5);
            zipTableStartX += colWidths[0];
            
            // Gün sütunu
            doc.rect(zipTableStartX, currentY, colWidths[1], 5);
            doc.text(gun, zipTableStartX + 2, currentY + 3.5);
            zipTableStartX += colWidths[1];
            
            // Sabah sütunu
            doc.rect(zipTableStartX, currentY, colWidths[2], 5);
            doc.text(sabahUygulama, zipTableStartX + 2, currentY + 3.5);
            zipTableStartX += colWidths[2];
            
            // Akşam sütunu
            doc.rect(zipTableStartX, currentY, colWidths[3], 5);
            doc.text(aksamUygulama, zipTableStartX + 2, currentY + 3.5);
            
            currentY += 5;
          }
          
          currentY += 8; // Haftalar arası boşluk
        }
        
        // PDF'yi kaydet
        const tarih = new Date().toISOString().slice(0, 10);
        const dosyaAdi = `${asciiHastaAdi}_Lenf_Masaj_Takvimi_${tarih}.pdf`;
        doc.save(dosyaAdi);
        
        console.log('✅ Özel Lenf Masaj Takvimi PDF oluşturuldu:', dosyaAdi);
        alert(`✅ Lenf Masaj Takvimi PDF oluşturuldu!\n\nDosya: ${dosyaAdi}\n\nBaşlangıç Tarihi: ${baslangicTarihi.toLocaleDateString('tr-TR')}`);
        
      } catch (error) {
        console.error('❌ Özel Lenf Masaj PDF hatası:', error);
        throw error;
      }
    }

    // Özel Egzersiz + Lenf Masaj PDF oluşturucu (9. hafta ZIP benzeri)
    async function generateCustomEgzersizPDF(hastaAdi, baslangicTarihi) {
      try {
        console.log('🏃 Özel Egzersiz + Lenf Masaj PDF oluşturuluyor...', { hastaAdi, baslangicTarihi });
        
        // jsPDF kütüphane kontrolü
        let jsPDFLib;
        if (typeof window.jspdf !== 'undefined') {
          jsPDFLib = window.jspdf.jsPDF;
          console.log('✅ jsPDF window.jspdf.jsPDF üzerinden yüklendi');
        } else if (typeof jsPDF !== 'undefined') {
          jsPDFLib = jsPDF;
          console.log('✅ jsPDF global jsPDF üzerinden yüklendi');
        } else {
          console.log('❌ jsPDF bulunamadı, dinamik yükleme yapılıyor...');
          
          // Dinamik jsPDF yükleme
          const script = document.createElement('script');
          script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
          script.onload = () => {
            console.log('✅ jsPDF dinamik olarak yüklendi');
            setTimeout(() => generateCustomEgzersizPDF(hastaAdi, baslangicTarihi), 100);
          };
          script.onerror = () => {
            console.log('❌ jsPDF yüklenemedi');
            alert('PDF kütüphanesi yüklenemedi. Lütfen internet bağlantınızı kontrol edin.');
          };
          document.head.appendChild(script);
          return; // Fonksiyondan çık, yükleme sonrası tekrar çalışacak
        }
        
        const doc = new jsPDFLib('p', 'mm', 'a4'); // ZIP sistemiyle ayn  format
        
        // Hasta adını ASCII'ye çevir (ZIP sistemiyle aynı)
        console.log('🔍 Orijinal hasta adı:', hastaAdi);
        const asciiHastaAdi = hastaAdi
            .replace(/Ş/g, 'S').replace(/ş/g, 's')
            .replace(/Ğ/g, 'G').replace(/ğ/g, 'g')
            .replace(/Ü/g, 'U').replace(/ü/g, 'u')
            .replace(/İ/g, 'I').replace(/ı/g, 'i')
            .replace(/Ö/g, 'O').replace(/ö/g, 'o')
            .replace(/Ç/g, 'C').replace(/ç/g, 'c')
            .replace(/Ə/g, 'E').replace(/ə/g, 'e');
        console.log('🔍 ASCII hasta adı:', asciiHastaAdi);
        
        // Başlık - ZIP sistemindeki gibi
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(14);
        doc.setTextColor(0, 0, 0);
        
        const title = `${asciiHastaAdi.toUpperCase()}`;
        const titleWidth = doc.getTextWidth(title);
        doc.text(title, (210 - titleWidth) / 2, 20);
        
        doc.setFontSize(12);
        doc.setTextColor(0, 0, 0);
        
        // Egzersiz + lenf masaj başlığı - ASCII karakterlerle
        const subtitle = 'EGZERSIZ VE LENF DRENAJ MASAJI PROGRAMI';
        const programBasligi = '8 Haftalik Egzersiz ve Lenf Drenaj Masaji Uygulama Programi';
        
        const subtitleWidth = doc.getTextWidth(subtitle);
        doc.text(subtitle, (210 - subtitleWidth) / 2, 28);
        
        // Açıklama kutusu
        doc.setFontSize(8);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(0, 0, 0);
        doc.rect(15, 32, 170, 10);
        doc.text(programBasligi, 20, 36);
        doc.text(turkceKarakterDuzelt('(5. Haftadan itibaren) - Yesil check isareti tamamlanan gunler'), 20, 40);
        
        // Tab başlangıç tarihi zaten pazartesi olarak planlanmış, değiştirme
        console.log('🔍 Tekli egzersiz - 9. hafta tab başlangıç tarihi (pazartesi olarak kabul):', baslangicTarihi.toLocaleDateString('tr-TR'));
        
        // Tab tarihi direkt kullan - zaten hafta başı olarak planlanmış
        const hizalanmisBaslangic = baslangicTarihi;
        
        // 9. haftanın başlangıcı (baslangicTarihi 9. hafta başlangıcı kabul edilir)
        let currentY = 50;
        const gunler = ['Pazartesi', 'Sali', 'Carsamba', 'Persembe', 'Cuma', 'Cumartesi', 'Pazar'].map(gun => turkceKarakterDuzelt(gun));
        
        // 8 haftalık program (5-12. haftalar) - ZIP sistemindeki gibi
        for (let lenfHaftaIndex = 0; lenfHaftaIndex < 8; lenfHaftaIndex++) {
          const gercekHaftaNo = lenfHaftaIndex + 5; // 5. haftadan başlar
          
          // 9. haftayı referans alarak diğer hafta başlangıçlarını hesapla
          // 5. hafta: 9. haftadan 4 hafta önce (-4 * 7 gün)
          // 6. hafta: 9. haftadan 3 hafta önce (-3 * 7 gün)
          // ...
          // 9. hafta: 9. haftadan 0 hafta önce (0 * 7 gün)
          // 10. hafta: 9. haftadan 1 hafta sonra (+1 * 7 gün)
          const haftaFarki = gercekHaftaNo - 9; // 5. hafta=-4, 6. hafta=-3, ..., 9. hafta=0, 10. hafta=+1
          const haftaBaslangic = new Date(hizalanmisBaslangic.getTime() + (haftaFarki * 7 * 24 * 60 * 60 * 1000));
          
          // Sayfa sonu kontrolü - hafta başlığı için yer var mı?
          if (currentY > 270) {
            doc.addPage();
            currentY = 20;
          }
          
          // Hafta başlığı
          doc.setTextColor(0, 0, 0);
          doc.setFont('helvetica', 'bold');
          doc.setFontSize(9);
          doc.rect(15, currentY, 170, 6);
          
          const haftaBaslangicStr = haftaBaslangic.toLocaleDateString('tr-TR');
          const haftaBitisStr = new Date(haftaBaslangic.getTime() + (6 * 24 * 60 * 60 * 1000)).toLocaleDateString('tr-TR');
          
          // 9. hafta PDF'si için 5-8. haftalar soluk renkte olsun
          if (gercekHaftaNo <= 8) {
            doc.setTextColor(150, 150, 150); // Soluk gri renk
          } else {
            doc.setTextColor(0, 0, 0); // Normal siyah renk
          }
          
          doc.text(turkceKarakterDuzelt(`${gercekHaftaNo}. HAFTA (${haftaBaslangicStr} - ${haftaBitisStr})`), 20, currentY + 4);
          currentY += 8;
          
          // Tablo başlıkları - ZIP sistemindeki gibi
          doc.setTextColor(0, 0, 0);
          doc.setFont('helvetica', 'bold');
          doc.setFontSize(9);
          doc.setDrawColor(0, 0, 0);
          doc.setLineWidth(0.3);
          
          const colWidths = [30, 40, 50, 50]; // Tarih, Gün, Sabah, Akşam
          let zipTableStartX = 15;
          
          // Başlık satırı
          doc.rect(zipTableStartX, currentY, colWidths[0], 6);
          doc.text('TARIH', zipTableStartX + 2, currentY + 4);
          zipTableStartX += colWidths[0];
          
          doc.rect(zipTableStartX, currentY, colWidths[1], 6);
          doc.text('GUN', zipTableStartX + 2, currentY + 4);
          zipTableStartX += colWidths[1];
          
          doc.rect(zipTableStartX, currentY, colWidths[2], 6);
          doc.text('SABAH', zipTableStartX + 2, currentY + 4);
          zipTableStartX += colWidths[2];
          
          doc.rect(zipTableStartX, currentY, colWidths[3], 6);
          doc.text('AKSAM', zipTableStartX + 2, currentY + 4);
          currentY += 6;
          
          // Her gün için satır - ZIP sistemindeki gibi
          doc.setFont('helvetica', 'normal');
          doc.setFontSize(8);
          
          for (let gunIndex = 0; gunIndex < 7; gunIndex++) {
            // Sayfa sonu kontrolü - satır için yer var mı?
            if (currentY > 280) {
              doc.addPage();
              currentY = 20;
              
              // Yeni sayfada tablo başlıklarını tekrar oluştur
              doc.setTextColor(0, 0, 0);
              doc.setFont('helvetica', 'bold');
              doc.setFontSize(9);
              doc.setDrawColor(0, 0, 0);
              doc.setLineWidth(0.3);
              
              let newPageTableStartX = 15;
              
              // Başlık satırı
              doc.rect(newPageTableStartX, currentY, colWidths[0], 6);
              doc.text('TARIH', newPageTableStartX + 2, currentY + 4);
              newPageTableStartX += colWidths[0];
              
              doc.rect(newPageTableStartX, currentY, colWidths[1], 6);
              doc.text('GUN', newPageTableStartX + 2, currentY + 4);
              newPageTableStartX += colWidths[1];
              
              doc.rect(newPageTableStartX, currentY, colWidths[2], 6);
              doc.text('SABAH', newPageTableStartX + 2, currentY + 4);
              newPageTableStartX += colWidths[2];
              
              doc.rect(newPageTableStartX, currentY, colWidths[3], 6);
              doc.text('AKSAM', newPageTableStartX + 2, currentY + 4);
              currentY += 6;
              
              doc.setFont('helvetica', 'normal');
              doc.setFontSize(8);
            }
            
            const gunTarihi = new Date(haftaBaslangic.getTime() + (gunIndex * 24 * 60 * 60 * 1000));
            const tarihStr = gunTarihi.toLocaleDateString('tr-TR');
            const gun = gunler[gunIndex];
            
            // Uygulama kontrolü - egzersiz dahil versiyonu (ZIP sistemindeki aynı mantık)
            let sabahUygulama = '-';
            let aksamUygulama = '-';
            
            if (lenfHaftaIndex < 2) {
              // İlk 2 hafta (5-6): Günde 2 kez lenf masajı
              sabahUygulama = turkceKarakterDuzelt('Lenf Masaji');
              aksamUygulama = turkceKarakterDuzelt('Lenf Masaji');
            } else if (lenfHaftaIndex < 4) {
              // Sonraki 2 hafta (7-8): Günde 1 kez lenf masajı (sabah)
              sabahUygulama = turkceKarakterDuzelt('Lenf Masaji');
              aksamUygulama = '-';
            } else if (lenfHaftaIndex < 6) {
              // Sonraki 2 hafta (9-10): Günaşırı lenf masajı + egzersiz
              if (gunIndex === 0 || gunIndex === 2 || gunIndex === 4 || gunIndex === 6) {
                // Pazartesi, Çarşamba, Cuma, Pazar: Lenf masajı + akşam egzersiz
                sabahUygulama = turkceKarakterDuzelt('Lenf Masaji');
                aksamUygulama = turkceKarakterDuzelt('Egzersiz-2');
              } else {
                // Salı, Perşembe, Cumartesi: Sabah ve akşam egzersiz
                sabahUygulama = turkceKarakterDuzelt('Egzersiz-1');
                aksamUygulama = turkceKarakterDuzelt('Egzersiz-2');
              }
            } else {
              // Son 2 hafta (11-12): Haftada 2 gün lenf masajı + sürekli egzersiz
              if (gunIndex === 1 || gunIndex === 4) { // Salı, Cuma
                sabahUygulama = turkceKarakterDuzelt('Lenf Masaji');
                aksamUygulama = turkceKarakterDuzelt('Egzersiz-2');
              } else {
                sabahUygulama = turkceKarakterDuzelt('Egzersiz-1');
                aksamUygulama = turkceKarakterDuzelt('Egzersiz-2');
              }
            }
            
            zipTableStartX = 15;
            
            // 9. hafta PDF'si için 5-8. haftalar soluk renkte olsun
            if (gercekHaftaNo <= 8) {
              doc.setTextColor(150, 150, 150); // Soluk gri renk
            } else {
              doc.setTextColor(0, 0, 0); // Normal siyah renk
            }
            
            // Tablo çizgi ayarları
            doc.setDrawColor(0, 0, 0);
            doc.setLineWidth(0.3);
            
            // Tarih sütunu
            doc.rect(zipTableStartX, currentY, colWidths[0], 5);
            
            // 9. hafta PDF'si ve geçmiş haftalarda (5-8) yeşil check simgesi ekle
            if (gercekHaftaNo <= 8) {
              // Yeşil check kutusu çiz
              doc.setFillColor(0, 128, 0); // Yeşil dolgu
              doc.rect(zipTableStartX + 1, currentY + 1, 4, 3, 'F'); // Yeşil dikdörtgen
              
              // Beyaz check çizgisi çiz
              doc.setDrawColor(255, 255, 255); // Beyaz çizgi
              doc.setLineWidth(0.5);
              // Check işareti çizgisi (V şekli)
              doc.line(zipTableStartX + 1.5, currentY + 2.5, zipTableStartX + 2.5, currentY + 3.2);
              doc.line(zipTableStartX + 2.5, currentY + 3.2, zipTableStartX + 4.2, currentY + 1.5);
              
              // Tablo çizgi ayarlarını geri yükle
              doc.setDrawColor(0, 0, 0);
              doc.setLineWidth(0.3);
              
              // Tarihi soluk renkte yaz
              doc.setTextColor(150, 150, 150);
              doc.text(tarihStr, zipTableStartX + 7, currentY + 3.5);
            } else {
              // Normal tarih
              doc.setTextColor(0, 0, 0);
              doc.text(tarihStr, zipTableStartX + 2, currentY + 3.5);
            }
            zipTableStartX += colWidths[0];
            
            // Gün sütunu
            doc.rect(zipTableStartX, currentY, colWidths[1], 5);
            doc.text(gun, zipTableStartX + 2, currentY + 3.5);
            zipTableStartX += colWidths[1];
            
            // Sabah sütunu
            doc.rect(zipTableStartX, currentY, colWidths[2], 5);
            doc.text(sabahUygulama, zipTableStartX + 2, currentY + 3.5);
            zipTableStartX += colWidths[2];
            
            // Akşam sütunu
            doc.rect(zipTableStartX, currentY, colWidths[3], 5);
            doc.text(aksamUygulama, zipTableStartX + 2, currentY + 3.5);
            
            currentY += 5;
          }
          
          currentY += 8; // Haftalar arası boşluk
        }
        
        // PDF'yi kaydet
        const tarih = new Date().toISOString().slice(0, 10);
        const dosyaAdi = `${asciiHastaAdi}_Egzersiz_Takvimi_${tarih}.pdf`;
        doc.save(dosyaAdi);
        
        console.log('✅ Özel Egzersiz + Lenf Masaj Takvimi PDF oluşturuldu:', dosyaAdi);
        alert(`✅ Egzersiz + Lenf Masaj Takvimi PDF oluşturuldu!\n\nDosya: ${dosyaAdi}\n\nBaşlangıç Tarihi: ${baslangicTarihi.toLocaleDateString('tr-TR')}`);
        
      } catch (error) {
        console.error('❌ Özel Egzersiz PDF hatası:', error);
        throw error;
      }
    }

    async function zipEslesenGorseller(i) {
      try {
        console.log('🎯 ZIP fonksiyonu başlatıldı, hafta indeksi:', i);
        
        // Hemen scope test edelim
        console.log('🔍 Scope test - i değeri:', i);
        
        // GitHub değişkenlerini input'lardan al - null check ile
        const tokenElement = document.getElementById('githubToken');
        const repoElement = document.getElementById('githubRepo');
        
        const GITHUB_TOKEN = tokenElement ? tokenElement.value.trim() : '';
        const GITHUB_REPO = repoElement ? repoElement.value.trim() || 'mustafasacar35/lipodem-takip-paneli' : 'mustafasacar35/lipodem-takip-paneli';
        
        if (!GITHUB_TOKEN) {
          console.warn('⚠️ GitHub token bulunamadı');
          alert('GitHub token ayarlanmamış. PDF dosyaları eklenemeyecek.');
        } else {
          console.log('✅ GitHub token mevcut');
        }
        
        console.log('🔍 GITHUB_REPO:', GITHUB_REPO);
        
        // Kütüphane kontrolü
        if (typeof JSZip === 'undefined') {
          console.error('❌ JSZip kütüphanesi yüklenmemiş!');
          alert('JSZip kütüphanesi yüklenmemiş! Sayfayı yenileyin.');
          return;
        }
        
        if (typeof saveAs === 'undefined') {
          console.error('❌ FileSaver kütüphanesi yüklenmemiş!');
          alert('FileSaver kütüphanesi yüklenmemiş! Sayfayı yenileyin.');
          return;
        }
        
        console.log('✅ Kütüphaneler yüklü: JSZip:', typeof JSZip, 'saveAs:', typeof saveAs);
        
      const haftalar = getHaftaListesi();
      console.log('🔍 Hafta listesi alındı, uzunluk:', haftalar ? haftalar.length : 'null');
      
      const hafta = haftalar[i];
      console.log('  Hafta objesi alındı:', hafta);
      
      console.log('🔍 Hafta objesi tamamı:', JSON.stringify(hafta, null, 2));
      
      // haftaNo tanımından önce hafta objesi kontrolü
      if (!hafta) {
        console.error('❌ Hafta objesi bulunamadı, index:', i);
        alert('Hafta bilgisi bulunamadı!');
        return;
      }
      
      console.log('🔍 hafta.haftaNo değeri:', hafta.haftaNo);
      console.log('🔍 i + 1 değeri:', i + 1);
      
      // Hafta numarasını önce tanımla - DEBUG ile
      console.log('🔍 haftaNo tanımlanmadan önce...');
      const haftaNo = hafta.haftaNo || (i + 1);
      console.log('🔍 haftaNo tanımlandı:', haftaNo);
      
      // Eğer PDF varsa ama pdfName yoksa, bunu düzelt
      if (hafta.pdf && !hafta.pdfName) {
        console.log('🔧 PDF var ama pdfName yok, düzeltiliyor...');
        // Hasta adından PDF adı oluştur (Türkçe karakter düzeltme ile)
        const hastaAdi = seciliHasta && seciliHasta.isim ? turkceKarakterDuzelt(seciliHasta.isim).replace(/\s+/g, '_') : 'Hasta';
        const tarih = new Date().toISOString().slice(0,10);
        hafta.pdfName = `${hastaAdi}_Hafta_${haftaNo}_${tarih}.pdf`;
        saveToStorage(); // Değişikliği kaydet
        console.log('✅ PDF adı oluşturuldu:', hafta.pdfName);
      }
      
      const eslesenDiv = document.getElementById('eslesenKartlar_' + i);
      const imgs = eslesenDiv.querySelectorAll('img');
      
      // İçerik kontrolü
      const hasPdf = hafta.pdf;
      const hasGptMessage = hafta.gptMesaj && hafta.gptMesaj.trim();
      const hasImages = imgs.length > 0;
      
      if (!hasImages && !hasPdf && !hasGptMessage) {
        alert('İndirilecek içerik yok!\n\n• PDF dosyası\n• Eşleşen tarif kartları\n• GPT mesajı');
        return;
      }
      
      const zip = new JSZip();
      let fileCount = 0;      let baseName, zipName, pdfFileName, txtFileName;
      
      console.log('🔍 Debug - hafta objesi:', hafta);
      console.log('🔍 Debug - hafta.pdfName:', hafta.pdfName);
      console.log('🔍 Debug - hafta indeksi:', i);
      console.log('🔍 Debug - tüm hafta listesi:', getHaftaListesi().map(h => ({haftaNo: h.haftaNo, pdfName: h.pdfName})));
      
      if (hafta.pdfName && hafta.pdfName.trim()) {
        // Yüklenen PDF dosyasının adını kullan - Türkçe karakterleri düzelt
        const duzeltilmisPdfName = turkceKarakterDuzelt(hafta.pdfName);
        baseName = duzeltilmisPdfName.replace(/\.[^.]+$/, '');  // Uzantısız ad
        zipName = duzeltilmisPdfName.replace(/\.pdf$/i, '.zip');  // PDF uzantısını ZIP ile değiştir
        pdfFileName = duzeltilmisPdfName;  // Düzeltilmiş PDF adını kullan
        txtFileName = baseName + '.txt';
        console.log('✅ PDF adı kullanılıyor (düzeltilmiş):', duzeltilmisPdfName);
      } else {
        // PDF adı yoksa, PDF içeriğinden veya hasta adından türetelim
        console.log('⚠️ PDF adı yok, alternatif çözüm arıyor...');
        
        // Hasta adından ve hafta numarasından dosya adı oluştur (Türkçe karakter düzeltme ile)
        const hastaAdi = seciliHasta && seciliHasta.isim ? turkceKarakterDuzelt(seciliHasta.isim).replace(/\s+/g, '_') : 'Hasta';
        const tarih = new Date().toISOString().slice(0,10);
        
        baseName = `${hastaAdi}_Hafta_${haftaNo}_${tarih}`;
        zipName = baseName + '.zip';
        pdfFileName = baseName + '.pdf';
        txtFileName = baseName + '.txt';
        console.log('📝 Oluşturulan dosya adı:', baseName);
      }
      
      console.log('📦 ZIP oluşturuluyor:', {
        hasPdf,
        hasGptMessage,
        hasImages,
        pdfName: hafta.pdfName,
        zipName: zipName,
        pdfFileName: pdfFileName,
        txtFileName: txtFileName
      });
      
      // 2. Eşleşen tarif kartlarını ana dizine ekle
      for (let img of imgs) {
        try {
          const url = img.src;
          const name = img.title || img.alt || `eslesen_kart_${fileCount + 1}.jpg`;
          const response = await fetch(url);
          const blob = await response.blob();
          zip.file(name, blob);  // Ana dizine ekle
          fileCount++;
          console.log('✅ Eşleşen kart eklendi:', name);
        } catch (e) {
          console.warn('⚠️ Eşleşen kart eklenemedi:', img.alt, e);
        }
      }
      
      // 2b. Manuel eklenen kartları da ana dizine ekle
      if (hafta.manuelKartlar && hafta.manuelKartlar.length > 0) {
        console.log('📝 Manuel kartlar ZIP\'e ekleniyor...', hafta.manuelKartlar);
        for (let manuelKart of hafta.manuelKartlar) {
          try {
            const response = await fetch(manuelKart.data);
            const blob = await response.blob();
            const manuelName = `MANUEL_${manuelKart.name}`;
            zip.file(manuelName, blob);  // Ana dizine ekle, MANUEL_ prefix ile
            fileCount++;
            console.log('✅ Manuel kart eklendi:', manuelName);
          } catch (e) {
            console.warn('⚠️ Manuel kart eklenemedi:', manuelKart.name, e);
          }
        }
      }
      
      // 2c. Çoklu PDF'den eklenen kartları da ana dizine ekle
      if (hafta.cokluPdfVerileri && hafta.cokluPdfVerileri.length > 0) {
        console.log('📁 Çoklu PDF kartları ZIP\'e ekleniyor...', hafta.cokluPdfVerileri);
        for (let veri of hafta.cokluPdfVerileri) {
          if (veri.tarifKartlar && veri.tarifKartlar.length > 0) {
            for (let cokluKart of veri.tarifKartlar) {
              try {
                const response = await fetch(cokluKart.data);
                const blob = await response.blob();
                const cokluName = `COKLU_PDF_${cokluKart.name}`;
                zip.file(cokluName, blob);  // Ana dizine ekle, COKLU_PDF_ prefix ile
                fileCount++;
                console.log('✅ Çoklu PDF kartı eklendi:', cokluName);
              } catch (e) {
                console.warn('⚠️ Çoklu PDF kartı eklenemedi:', cokluKart.name, e);
              }
            }
          }
        }
      }
      
      // 3. PDF dosyasını ekle
      if (hasPdf) {
        try {
          const base64 = hafta.pdf.split(',')[1];
          if (base64 && base64.length > 0) {
            // Base64 string boyutunu kontrol et (minimum 100 karakter olmalı - çok küçük PDF'leri engelle)
            if (base64.length < 100) {
              console.warn('⚠️ PDF çok küçük (100 karakterden az), eklenmedi:', base64.length, 'karakter');
            } else {
              zip.file(pdfFileName, base64, {base64: true});
              fileCount++;
              console.log('✅ PDF eklendi:', pdfFileName, 'boyut:', base64.length, 'karakter');
            }
          } else {
            console.warn('⚠️ PDF base64 verisi boş');
          }
        } catch (e) {
          console.warn('⚠️ PDF eklenemedi:', e);
        }
      }
      
      // 5. GPT mesajını txt dosyası olarak ekle (sadece içerik)
      if (hasGptMessage) {
        try {
          const mesajIcerigi = hafta.gptMesaj.trim();  // Sadece GPT mesajı içeriği
          
          zip.file(txtFileName, mesajIcerigi);
          fileCount++;
          console.log('✅ GPT mesajı eklendi:', txtFileName);
        } catch (e) {
          console.warn('⚠️ GPT mesajı eklenemedi:', e);
        }
      }
      
      // MENÜ PDF'Si EKLEME (TÜM HAFTALAR İÇİN)
      if ((hafta.pdfName || hafta.pdfOrijinalIsim) && GITHUB_TOKEN) {
        try {
          console.log(`🔍 ${haftaNo}. hafta Menü PDF ekleniyor...`);
          console.log('🔍 PDF bilgileri:', {
            pdfName: hafta.pdfName,
            pdfOrijinalIsim: hafta.pdfOrijinalIsim,
            hastaId: seciliHasta.id,
            haftaNo: haftaNo
          });
          
          const pdfFileName = hafta.pdfName || hafta.pdfOrijinalIsim;
          
          // pdfYolu varsa önce onu dene
          let pdfUrl;
          if (hafta.pdfYolu) {
            pdfUrl = `https://api.github.com/repos/${GITHUB_REPO}/contents/${hafta.pdfYolu}`;
            console.log('🔍 İlk denenen PDF URL (pdfYolu):', pdfUrl);
          } else {
            // Önce patients klasöründe dene
            pdfUrl = `https://api.github.com/repos/${GITHUB_REPO}/contents/patients/${seciliHasta.id}/hafta_${haftaNo}_${pdfFileName}`;
            console.log('🔍 İlk denenen PDF URL (patients):', pdfUrl);
          }
          
          let pdfResponse = await fetch(pdfUrl, {
            headers: { 'Authorization': `token ${GITHUB_TOKEN}` }
          });
          
          console.log('🔍 İlk PDF response status:', pdfResponse.status);
          
          // Eğer bulunamazsa pdfs klasörünü dene
          if (!pdfResponse.ok && !hafta.pdfYolu) {
            console.log('🔍 patients klasöründe bulunamadı, pdfs klasörünü deniyor...');
            pdfUrl = `https://api.github.com/repos/${GITHUB_REPO}/contents/pdfs/${pdfFileName}`;
            
            console.log('🔍 İkinci denenen PDF URL (pdfs):', pdfUrl);
            
            pdfResponse = await fetch(pdfUrl, {
              headers: { 'Authorization': `token ${GITHUB_TOKEN}` }
            });
            
            console.log('🔍 İkinci PDF response status:', pdfResponse.status);
          }
          
          if (pdfResponse.ok) {
            const pdfData = await pdfResponse.json();
            const pdfBlob = base64ToBlob(pdfData.content, 'application/pdf');
            
            // PDF boyutunu kontrol et (minimum 1KB olmalı)
            if (pdfBlob && pdfBlob.size > 1024) {
              const menuPdfName = `MENU_PDF_${hafta.pdfOrijinalIsim || hafta.pdfName || 'menu.pdf'}`;
              zip.file(menuPdfName, pdfBlob);
              fileCount++;
              console.log(`✅ ${haftaNo}. hafta Menü PDF eklendi:`, menuPdfName, 'boyut:', pdfBlob.size, 'bytes');
            } else {
              console.warn(`⚠️ ${haftaNo}. hafta Menü PDF çok küçük (1KB altı), eklenmedi:`, pdfBlob ? pdfBlob.size : 'null', 'bytes');
            }
          } else {
            const errorText = await pdfResponse.text();
            console.warn(`❌ ${haftaNo}. hafta PDF yanıtı başarısız:`, pdfResponse.status, errorText);
            
            // API yanıtını detaylı logla
            console.warn('❌ PDF API yanıt detayları:', {
              url: pdfUrl,
              status: pdfResponse.status,
              statusText: pdfResponse.statusText,
              errorText: errorText
            });
          }
        } catch (error) {
          console.warn(`❌ ${haftaNo}. hafta Menü PDF eklenemedi:`, error);
          console.warn('❌ PDF ekleme hatası detayları:', {
            errorMessage: error.message,
            errorStack: error.stack,
            pdfUrl: pdfUrl
          });
        }
      } else {
        console.warn(`ℹ️ ${haftaNo}. hafta PDF bilgisi bulunamadı`, {
          haftaNo: haftaNo,
          pdfName: hafta.pdfName,
          pdfOrijinalIsim: hafta.pdfOrijinalIsim,
          hasToken: !!GITHUB_TOKEN
        });
      }

      // 6. Eğer bu hafta "5. hafta" ise masaj takvimi oluştur
      if (haftaNo === 5) {
        try {
          console.log('🏥 5. hafta tespit edildi, Masaj Takvim PDF\'i oluşturuluyor...');
          console.log('🔍 Bu hafta bilgileri:', { index: i, haftaNo: haftaNo, baslangic: hafta.baslangic, bitis: hafta.bitis });
          
          // ⚡ ÖNEMLİ: Bu 5. hafta tab'ının tarihini kullan
          const masajTakvimBlob = await generate5HaftaMasajPDF(hafta);
          console.log('🔍 generate5HaftaMasajPDF sonucu:', masajTakvimBlob ? 'Blob var' : 'Blob yok');
          
          if (masajTakvimBlob && masajTakvimBlob.size > 0) {
            const masajTakvimFileName = `${baseName}_Masaj_Takvimi.pdf`;
            console.log('🔍 Masaj PDF boyutu:', masajTakvimBlob.size, 'bytes');
            console.log('🔍 Masaj PDF dosya adı:', masajTakvimFileName);
            zip.file(masajTakvimFileName, masajTakvimBlob);
            fileCount++;
            console.log('✅ Masaj Takvim PDF\'i ZIP\'e eklendi:', masajTakvimFileName);
          } else {
            console.warn('❌ Masaj Takvim PDF Blob oluşturulamadı veya boyutu 0 KB:', masajTakvimBlob ? masajTakvimBlob.size : 'null');
          }
        } catch (e) {
          console.warn('⚠️ Masaj Takvim PDF\'i eklenemedi:', e);
          console.warn('❌ Masaj PDF hatası detayları:', e.stack);
        }
      }
      
      // 7. Sadece 9. haftada "Masaj + Egzersiz" Takvim PDF'ini ekle
      if (haftaNo === 9) {
        try {
          console.log('🏋️ 9. hafta tespit edildi, Masaj + Egzersiz Takvim PDF\'i oluşturuluyor...');
          
          // Masaj + egzersiz içeren takvim PDF'ini oluştur (9. hafta için, egzersiz dahil)
          const masajEgzersizTakvimBlob = await generateLenfDrenajPDFBlob(9);
          if (masajEgzersizTakvimBlob && masajEgzersizTakvimBlob.size > 0) {
            const masajEgzersizTakvimFileName = `${baseName}_Masaj_Egzersiz_Takvimi.pdf`;
            console.log('🔍 Masaj+Egzersiz PDF boyutu:', masajEgzersizTakvimBlob.size, 'bytes');
            zip.file(masajEgzersizTakvimFileName, masajEgzersizTakvimBlob);
            fileCount++;
            console.log('✅ Masaj + Egzersiz Takvim PDF\'i ZIP\'e eklendi:', masajEgzersizTakvimFileName);
          } else {
            console.warn('❌ Masaj + Egzersiz Takvim PDF Blob oluşturulamadı veya boyutu 0 KB:', masajEgzersizTakvimBlob ? masajEgzersizTakvimBlob.size : 'null');
          }
        } catch (e) {
          console.warn('⚠️ Masaj + Egzersiz Takvim PDF\'i eklenemedi:', e);
        }
      }
      
      // 8. ZIP dosyasını oluştur ve indir
      if (fileCount === 0) {
        alert('Hiçbir dosya eklenemedi!');
        return;
      }
      
      console.log(`📦 ZIP hazırlanıyor: ${fileCount} dosya, adı: ${zipName}`);
      
      zip.generateAsync({type:'blob'}).then(function(content) {
        saveAs(content, zipName);
        console.log('✅ ZIP indirildi:', zipName);
        alert(`ZIP dosyası hazırlandı!\n\n📁 ${zipName}\n📄 ${fileCount} dosya dahil`);
      }).catch(function(error) {
        console.error('❌ ZIP oluşturma hatası:', error);
        alert('ZIP dosyası oluşturulurken hata oluştu: ' + error.message);
      });
      
    } catch (error) {
        console.error('❌ ZIP fonksiyonu genel hatası:', error);
        alert('ZIP oluşturma hatası: ' + error.message);
      }
    }
    
    window.zipEslesenGorseller = zipEslesenGorseller;
    window.generatePatientPDF = generatePatientPDF;
    
    // PDF Test fonksiyonu
    function testPDFGenerator() {
      console.log('🧪 PDF Test başlatılıyor...');
      console.log('jsPDF kontrol:', typeof window.jspdf, typeof jsPDF);
      
      if (typeof window.jspdf !== 'undefined') {
        console.log('✅ jsPDF mevcut, test PDF oluşturuluyor...');
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.text('Test PDF - Türkçe karakter: çğıöşüÇĞIÖŞÜ', 10, 10);
        doc.save('test.pdf');
        console.log('✅ Test PDF oluşturuldu!');
      } else {
        console.log('❌ jsPDF bulunamadı');
        alert('jsPDF kütüphanesi yüklenmemiş');
      }
    }
    window.testPDFGenerator = testPDFGenerator;

    // Debug fonksiyonu - Tarifler klasörü durumunu kontrol et
    async function debugTariflerKlasoru() {
      console.log('🔍 Tarifler Klasörü Debug Başlıyor...');
      
      // Mevcut durum
      console.log('📊 Mevcut tariflerKlasoruGorselleri:', tariflerKlasoruGorselleri);
      console.log('📊 Görsel sayısı:', tariflerKlasoruGorselleri.length);
      
      // Yol hesaplama
      let basePath = window.location.pathname;
      if (!basePath.endsWith('/')) basePath = basePath.substring(0, basePath.lastIndexOf('/') + 1);
      const tariflerPath = window.location.origin + basePath + 'tarifler/';
      console.log('🌐 Hesaplanan tarifler yolu:', tariflerPath);
      
      // list.json kontrolü
      try {
        console.log('📂 list.json dosyası kontrol ediliyor...');
        const resp = await fetch(tariflerPath + 'list.json');
        console.log('📄 list.json response status:', resp.status);
        
        if (resp.ok) {
          const responseText = await resp.text();
          console.log('📄 Ham list.json içeriği (ilk 500 karakter):', responseText.substring(0, 500));
          
          try {
            const files = JSON.parse(responseText);
            console.log('✅ list.json başarıyla okundu:', files);
            console.log('📁 Dosya sayısı:', files.length);
            
            // Her dosyanın erişilebilirliğini test et
            for (let fileName of files.slice(0, 3)) { // İlk 3 dosyayı test et
              try {
                const fileResp = await fetch(tariflerPath + fileName);
                console.log(`🖼️ ${fileName}: ${fileResp.ok ? '✅ Erişilebilir' : '❌ Erişilemez'} (${fileResp.status})`);
              } catch (e) {
                console.log(`🖼️ ${fileName}: ❌ Hata - ${e.message}`);
              }
            }
          } catch (jsonError) {
            console.log('❌ JSON parsing hatası:', jsonError.message);
            console.log('📄 Hatalı JSON içeriği:', responseText);
            
            // JSON'u satır satır kontrol et
            const lines = responseText.split('\n');
            console.log('📊 Toplam satır sayısı:', lines.length);
            
            // 200-210 arası satırları göster (hata 204. satırda)
            for (let i = 200; i < Math.min(210, lines.length); i++) {
              console.log(`Satır ${i + 1}: "${lines[i]}"`);
            }
          }
        } else {
          console.log('❌ list.json bulunamadı');
        }
      } catch (e) {
        console.log('❌ list.json okuma hatası:', e.message);
      }
      
      // Hasta verilerini kontrol et
      console.log('👥 Toplam hasta sayısı:', hastalar.length);
      
      if (hastalar.length > 0) {
        const mevcutSeciliHasta = hastalar.find(h => h.secili);
        if (mevcutSeciliHasta) {
          console.log('👤 Seçili hasta:', mevcutSeciliHasta.ad);
          const haftalar = mevcutSeciliHasta.haftalar || [];
          console.log('📅 Hafta sayısı:', haftalar.length);
          
          haftalar.forEach((hafta, index) => {
            const manuelKartSayisi = (hafta.tarifKartlar && hafta.tarifKartlar.length) || 0;
            const tarifSayisi = (hafta.tarifler && hafta.tarifler.length) || 0;
            const haftaNo = hafta.haftaNo || (index + 1);
            const pdfDurum = hafta.pdf ? '✅ PDF var' : '❌ PDF yok';
            console.log(`📅 Hafta ${haftaNo} (sıra: ${index + 1}): ${manuelKartSayisi} manuel kart, ${tarifSayisi} tarif, ${pdfDurum}`);
          });
        } else {
          console.log('⚠️ Seçili hasta yok');
        }
      }
      
      // Sonuç özeti
      alert(`🔍 Debug Sonuçları (Konsolu kontrol edin):
      
📊 Tarifler klasörü görsel sayısı: ${tariflerKlasoruGorselleri.length}
🌐 Tarifler yolu: ${tariflerPath}
👥 Hasta sayısı: ${hastalar.length}

Detaylı bilgiler için tarayıcı konsolunu (F12) açın.`);
    }
    window.debugTariflerKlasoru = debugTariflerKlasoru;

    // Tarifler klasörünü yeniden yükleme ve eşleştirme fonksiyonu
    async function yeniBirDenemeEt(haftaIndex) {
      console.log('🔄 Yeniden deneme başlıyor...');
      
      // Önce tarifler klasörünü sıfırla ve yeniden yükle
      tariflerKlasoruGorselleri = [];
      await tariflerKlasoruGorselleriniYukle();
      
      // Durum güncelle
      durumGuncelle();
      
      // Sonra o hafta için eşleştirmeyi yeniden çalıştır
      await otomatikEsleHafta(haftaIndex);
      
      console.log('✅ Yeniden deneme tamamlandı');
    }
    window.yeniBirDenemeEt = yeniBirDenemeEt;

    // GitHub'tan fresh yükleme (cache'i temizle ve GitHub'tan yükle)
    async function githubdanYenileVeYukle() {
      const token = document.getElementById('githubToken').value.trim();
      if (!token) {
        alert('❌ GitHub token gerekli!\n\nÖnce GitHub API token\'ınızı girin.');
        return;
      }
      
      if (!confirm('🔄 FRESH YÜKLEME\n\nBu işlem:\n• Yerel cache\'i temizleyecek\n• GitHub\'tan en güncel verileri yükleyecek\n• Tarifler klasörünü yeniden tarayacak\n\nDevam etmek istiyor musunuz?')) {
        return;
      }
      
      try {
        console.log('🔄 GitHub\'tan fresh yükleme başlıyor...');
        
        // Sadece veri cache'lerini temizle (hasta kayıtlarını tutmak için)
        manuelEslestirmeler = {};
        eslesmemeKurallari = {};
        tariflerKlasoruGorselleri = [];
        
        // GitHub'tan yükle
  await manuelEslestirmeleriGitHubYukle(false); // sessiz değil
  await eslesmemeKurallariniGitHubYukle(false); // sessiz değil
  await karalisteGitHubYukle(false); // karaliste de
        
        // Tarifler klasörünü yeniden yükle
        await tariflerKlasoruGorselleriniYukle();
        
        // Durumu güncelle
        durumGuncelle();
        
  alert('✅ GitHub\'tan fresh yükleme tamamlandı!\n\n' +
              `• Manuel eşleştirmeler: ${Object.keys(manuelEslestirmeler).length} adet\n` +
              `• Eşleşme yasakları: ${Object.keys(eslesmemeKurallari).length} adet\n` +
              `• Tarifler klasörü: ${tariflerKlasoruGorselleri.length} görsel`);
              
      } catch (error) {
        console.error('GitHub fresh yükleme hatası:', error);
        alert('❌ GitHub\'tan yükleme hatası:\n\n' + error.message);
      }
    }
    window.githubdanYenileVeYukle = githubdanYenileVeYukle;

    // Sadece tarifler klasörünü yenile
    async function sadeceTariflerKlasoruYenile() {
      try {
        console.log('📁 Tarifler klasörü yenileniyor...');
        
        // Cache'i temizle
        tariflerKlasoruGorselleri = [];
        
        // Yeniden yükle
        await tariflerKlasoruGorselleriniYukle();
        
        // Durumu güncelle
        durumGuncelle();
        
        alert(`✅ Tarifler klasörü yenilendi!\n\n${tariflerKlasoruGorselleri.length} görsel bulundu.`);
        
      } catch (error) {
        console.error('Tarifler klasörü yenileme hatası:', error);
        alert('❌ Tarifler klasörü yenileme hatası:\n\n' + error.message);
      }
    }
    window.sadeceTariflerKlasoruYenile = sadeceTariflerKlasoruYenile;

    // ========================
    // YENİ SIDEBAR LAYOUT FONKSİYONLARI
    // ========================

    // Aktif hastayı seçtiğimizde eşleşen kartları göster
    function hastaSecildiginde(hastaIndex) {
      console.log(`👤 Hasta seçildi: ${hastaIndex}`);
      
      // PDF butonunu göster/gizle
      togglePdfButton();
      
      // Hedef kcal rozetini güncelle
      try {
        updateHedefKcalBadgeForSelectedPatient();
      } catch (e) {
        console.warn('⚠️ Hasta seçildiğinde rozet güncellenemedi:', e?.message || e);
      }
      
      // Mevcut aktif hafta için eşleşen kartları sidebar'da göster
      const actTab = document.querySelector('.hafta-tab.active');
      if (actTab) {
        const haftaIndex = parseInt(actTab.dataset.haftaIndex);
        if (!isNaN(haftaIndex)) {
          gosterEslesenKartlarSidebar(haftaIndex);
        }
      }
      
      // Hasta seçildiğinde yemek analizini güncelle
      setTimeout(() => {
        updateYemekAnalizi();
      }, 500); // Hasta verilerinin yüklenmesi için kısa gecikme
    }
    window.hastaSecildiginde = hastaSecildiginde;

    // Hafta tab'ı seçildiğinde sidebar'ları güncelle
  async function haftaTabSecildiginde(haftaIndex) {
      console.log(`🔄 Hafta tab'ı seçildi: ${haftaIndex}`);
      window.aktifHaftaIndex = haftaIndex;
      gosterEslesenKartlarSidebar(haftaIndex);
      
      // Yemek analizini her hafta değişiminde otomatik güncelle
      updateYemekAnalizi();
      
      // Yemek veritabanı analizini de güncelle - Fallback koruma ile
      if (!window.fallbackHtmlProtection) {
        updateYemekVeritabaniAnalizi();
      } else {
        console.log('🛡️ Fallback koruma: haftaTabSecildiginde render atlandı');
      }

      // Hedef kcal rozeti ve plan yüzdesini aktif haftaya göre tazele
      try { updateHedefKcalBadgeForSelectedPatient(); } catch {}
      // Açık ayarlar modalında temizle butonunu güncelle
      try {
        const modal = document.getElementById('hastaAyarModal');
        if (modal && modal.style.display !== 'none') {
          const aktif = getCurrentHasta();
          if (aktif?.id) {
            const gh = getGithubRepoAndToken();
            let remoteHasta = null;
            if (gh) { try { remoteHasta = await githubGetFileJson(`patients/${aktif.id}/settings.json`, true); } catch {} }
            const localHasta = (typeof loadUserSettingsLocal === 'function') ? loadUserSettingsLocal(aktif.id) : null;
            const etkinHastaRaw = remoteHasta || localHasta || {};
            let haftaNo = null;
            try {
              const haftaListesi = (typeof getHaftaListesi === 'function') ? getHaftaListesi() : [];
              const idx = (typeof getAktifHaftaIndex === 'function') ? getAktifHaftaIndex() : (haftaListesi.length ? haftaListesi.length - 1 : 0);
              haftaNo = (haftaListesi?.[idx]?.haftaNo) || (idx + 1);
            } catch {}
            const hasWeekOverride = !!(etkinHastaRaw?.weeklyOverrides?.[String(haftaNo)] || etkinHastaRaw?.weeklyOverrides?.[haftaNo]);
            const clr = document.getElementById('clearWeekOverrideBtn');
            if (clr) clr.style.display = hasWeekOverride ? 'inline-block' : 'none';
          }
        }
      } catch {}
      
      // Eşleşmeyen tarifleri hafta tabına göre güncelle
      updateEslesmeyenTariflerHaftaTabina(haftaIndex);
    }
    window.haftaTabSecildiginde = haftaTabSecildiginde;

    // Eşleşmeyen tarifleri hafta tabına göre güncelle
    function updateEslesmeyenTariflerHaftaTabina(haftaIndex) {
      console.log(`🔄 Eşleşmeyen tarifler güncelleniyor, hafta: ${haftaIndex}`);
      
      const eslesmeyenlerContent = document.getElementById('eslesmeyenlerContent');
      const eslesmeyenlerBaslik = document.getElementById('eslesmeyenlerBaslik');
      
      if (!eslesmeyenlerContent || !eslesmeyenlerBaslik) {
        console.log('🔍 Eşleşmeyenler DOM elementleri bulunamadı');
        return;
      }
      
      const haftaListesi = getHaftaListesi();
      const hafta = haftaListesi[haftaIndex];
      
      if (!hafta || !hafta.tarifler || hafta.tarifler.length === 0) {
        eslesmeyenlerBaslik.textContent = '🚫 Eşleşmeyen Tarifler';
        eslesmeyenlerContent.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">Bu hafta için tarif bulunamadı</div>';
        return;
      }
      
      let eslesmeyenTarifler = [];
      
      // Önce JSON'dan kaydedilmiş eşleşmeyen tarifleri al
      if (hafta.eslesmeyenTarifler && hafta.eslesmeyenTarifler.length > 0) {
        eslesmeyenTarifler = [...hafta.eslesmeyenTarifler];
      } else {
        // JSON'da yoksa hesapla
        hafta.tarifler.forEach(tarif => {
          // Normalize et
          function normalizeLocal(str) {
            return str
              .toLowerCase()
              .replace(/ç/g, 'c').replace(/ğ/g, 'g').replace(/ş/g, 's')
              .replace(/ü/g, 'u').replace(/ö/g, 'o').replace(/ı/g, 'i')
              .replace(/i̇/g, 'i')
              .replace(/[_*\/()]/g, ' ')
              .replace(/\s+/g, ' ')
              .replace(/[^a-z0-9\s]/g, '')
              .trim();
          }
          
          const normalizedTarif = normalizeLocal(tarif);
          
          // Otomatik eşleşme kontrolü
          const otomatikEslesen = tariflerKlasoruGorselleri.some(kart => {
            const normalizedKart = normalizeLocal(kart.name.replace(/\.[^/.]+$/, ''));
            return normalizedKart.includes(normalizedTarif) || 
                   normalizedTarif.includes(normalizedKart) ||
                   normalizedKart === normalizedTarif;
          });
          
          // Manuel eşleşme kontrolü  
          const manuelEslesen = manuelEslestirmeler[normalizedTarif];
          
          // Yasak kural kontrolü
          const yasakMi = eslesmemeKurallari[normalizedTarif];
          
          // Eğer hiçbir yerde eşleşmiyor ve yasaklanmamışsa eşleşmeyen listesine ekle
          if (!otomatikEslesen && !manuelEslesen && !yasakMi && !eslesmeyenTarifler.includes(tarif)) {
            eslesmeyenTarifler.push(tarif);
          }
        });
      }
      
      // UI'ı güncelle
      if (eslesmeyenTarifler.length > 0) {
        eslesmeyenlerBaslik.textContent = `🚫 Eşleşmeyen Tarifler (${eslesmeyenTarifler.length})`;
        eslesmeyenlerContent.innerHTML = '';
        
        eslesmeyenTarifler.forEach(tarif => {
          const p = document.createElement('p');
          p.textContent = tarif;
          p.style.color = '#dc3545';
          p.style.margin = '6px 0';
          p.style.padding = '4px 8px';
          p.style.background = '#fff5f5';
          p.style.borderLeft = '3px solid #dc3545';
          p.style.borderRadius = '4px';
          p.style.cursor = 'pointer';
          p.style.transition = 'background-color 0.2s';
          p.title = 'Tıkla ve manuel eşleştirme yap';
          
          p.onmouseenter = () => p.style.background = '#ffe6e6';
          p.onmouseleave = () => p.style.background = '#fff5f5';
          p.onclick = () => {
            console.log('🔗 Eşleşmeyen tarif adına tıklandı:', tarif);
            try {
              if (typeof eslesmeyenTarifManuelEslestir === 'function') {
                eslesmeyenTarifManuelEslestir(tarif);
              } else {
                console.error('❌ eslesmeyenTarifManuelEslestir fonksiyonu bulunamadı!');
                alert('Manuel eşleştirme fonksiyonu yüklenemedi. Sayfayı yenileyin.');
              }
            } catch (error) {
              console.error('❌ Eşleşmeyen tarif tıklama hatası:', error);
              alert('Hata: ' + error.message);
            }
          };
          
          eslesmeyenlerContent.appendChild(p);
        });
      } else {
        eslesmeyenlerBaslik.textContent = '🚫 Eşleşmeyen Tarifler';
        eslesmeyenlerContent.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">🎉 Tüm tarifler eşleştirildi!</div>';
      }
      
      console.log(`🔄 Hafta ${haftaIndex + 1} eşleşmeyen tarifleri güncellendi:`, eslesmeyenTarifler.length, 'adet');
    }

    // Eşleşen kartları sağ sidebar'da göster
    function gosterEslesenKartlarSidebar(haftaIndex) {
      console.log(`🔍 gosterEslesenKartlarSidebar çağrıldı, hafta index: ${haftaIndex}`);
      
      const currentDiv = document.getElementById('eslesenContent');
      if (!currentDiv) {
        console.log('❌ eslesenContent div bulunamadı!');
        return;
      }
      
      const eskiDiv = document.getElementById(`eslesenKartlar_${haftaIndex}`);
      console.log(`🔍 eslesenKartlar_${haftaIndex} div:`, eskiDiv);
      console.log(`🔍 eskiDiv children count:`, eskiDiv ? eskiDiv.children.length : 'div null');
      
      // Önce temizle
      currentDiv.innerHTML = '';
      
      // Eşleşen kartlar başlığını güncelle
      const eslesenBaslik = document.getElementById('eslesenBaslik');
      
      let kartVarMi = false;
      
      // 1. Otomatik eşleşen kartları ekle
      if (eskiDiv && eskiDiv.children.length > 0) {
        console.log('✅ Otomatik eşleşen kartlar bulundu, sidebar\'a klonlanıyor...');
        
        // Her child elementi klonla ve onclick eventleri yeniden ekle
        Array.from(eskiDiv.children).forEach(child => {
          const clonedChild = child.cloneNode(true);
          
          // Klonlanan element içindeki tıklanabilir span'ları bul ve onclick ekle
          const clickableSpans = clonedChild.querySelectorAll('span[style*="cursor: pointer"]');
          clickableSpans.forEach(span => {
            const tarifText = span.textContent.replace(/^[^:]*:\s*/, '').trim(); // "Tarif: xyz" formatından "xyz" al
            console.log('🔧 Sidebar klonuna onclick ekleniyor:', tarifText);
            
            span.onclick = () => {
              console.log('🔧 Sidebar\'dan eşleşen tarif adına tıklandı:', tarifText);
              try {
                if (typeof eslesenTarifManuelEslestir === 'function') {
                  // Orjinal kartları bul
                  const aktifHaftaIndex = getAktifHaftaIndex();
                  const hafta = seciliHasta?.haftalar?.[aktifHaftaIndex];
                  if (hafta?.tarifKartlar) {
                    const eslesmeTarifKartlari = hafta.tarifKartlar.filter(kart => 
                      kart.tarifAdi.toLowerCase() === tarifText.toLowerCase()
                    );
                    eslesenTarifManuelEslestir(tarifText, eslesmeTarifKartlari);
                  }
                } else {
                  console.error('❌ eslesenTarifManuelEslestir fonksiyonu bulunamadı!');
                  alert('Manuel eşleştirme fonksiyonu yüklenemedi. Sayfayı yenileyin.');
                }
              } catch (error) {
                console.error('❌ Sidebar eşleşen tarif tıklama hatası:', error);
                alert('Hata: ' + error.message);
              }
            };
          });
          
          currentDiv.appendChild(clonedChild);
        });
        
        kartVarMi = true;
      }
      
      // 2. Manuel eklenen kartları ekle
      if (seciliHasta && seciliHasta.haftalar && seciliHasta.haftalar[haftaIndex]) {
        const hafta = seciliHasta.haftalar[haftaIndex];
        if (hafta.manuelKartlar && hafta.manuelKartlar.length > 0) {
          console.log('✅ Manuel kartlar bulundu, ekleniyor...', hafta.manuelKartlar);
          
          hafta.manuelKartlar.forEach(kart => {
            const kartDiv = document.createElement('div');
            kartDiv.style.cssText = 'display: inline-block; margin: 10px; position: relative; vertical-align: top;';
            kartDiv.className = 'manuel-kart';
            
            // Kart adını düzenle
            const kartBaslik = kart.name.replace('.jpg', '').replace(/_/g, ' ');
            
            kartDiv.innerHTML = `
              <div style="background: white; border: 3px solid #ffd700; border-radius: 12px; padding: 15px; width: 200px; box-shadow: 0 4px 8px rgba(255,215,0,0.3);">
                <img src="${kart.data}" alt="${kart.name}" title="${kartBaslik}" 
                     style="width: 100%; height: 120px; object-fit: cover; object-position: top; border-radius: 8px; margin-bottom: 10px;">
                
                <div style="font-size: 13px; font-weight: bold; color: #333; margin-bottom: 5px; text-align: center;">
                  ${kartBaslik}
                </div>
                
                <div style="background: #ffd700; color: #333; text-align: center; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: bold; margin-bottom: 8px;">
                  🖐️ MANUEL EKLENEN
                </div>
                
                <div style="text-align: center;">
                  <button onclick="manuelKartSil('${kart.name}', ${haftaIndex})" 
                          style="background: #dc3545; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 11px;">
                    🗑️ Sil
                  </button>
                </div>
              </div>
            `;
            
            currentDiv.appendChild(kartDiv);
          });
          
          kartVarMi = true;
        }
        
        // 3. Çoklu PDF'den eklenen kartları ekle
        if (hafta.cokluPdfVerileri && hafta.cokluPdfVerileri.length > 0) {
          console.log('✅ Çoklu PDF kartları bulundu, ekleniyor...', hafta.cokluPdfVerileri);
          
          hafta.cokluPdfVerileri.forEach((veri, veriIndex) => {
            if (veri.tarifKartlar && veri.tarifKartlar.length > 0) {
              veri.tarifKartlar.forEach(kart => {
                const kartDiv = document.createElement('div');
                kartDiv.style.cssText = 'display: inline-block; margin: 10px; position: relative; vertical-align: top;';
                kartDiv.className = 'coklu-pdf-kart';
                kartDiv.setAttribute('data-kart-name', kart.name);
                
                // Kart adını düzenle
                const kartBaslik = kart.name.replace('.jpg', '').replace(/_/g, ' ');
                
                kartDiv.innerHTML = `
                  <div style="background: white; border: 3px solid #17a2b8; border-radius: 12px; padding: 15px; width: 200px; box-shadow: 0 4px 8px rgba(23,162,184,0.3);">
                    <img src="${kart.data}" alt="${kart.name}" title="${kartBaslik}" 
                         style="width: 100%; height: 120px; object-fit: cover; object-position: top; border-radius: 8px; margin-bottom: 10px;">
                    
                    <div style="font-size: 13px; font-weight: bold; color: #333; margin-bottom: 5px; text-align: center;">
                      ${kartBaslik}
                    </div>
                    
                    <div style="background: #17a2b8; color: white; text-align: center; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: bold; margin-bottom: 8px;">
                      📁 ÇOKLU PDF'DEN
                    </div>
                    
                    <div style="text-align: center;">
                      <button onclick="cokluPdfKartSil('${kart.name}', ${haftaIndex}, ${veriIndex})" 
                              style="background: #dc3545; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 11px;">
                        🗑️ Sil
                      </button>
                    </div>
                  </div>
                `;
                
                currentDiv.appendChild(kartDiv);
              });
            }
          });
          
          kartVarMi = true;
        }
      }
      
      // 3. Eğer hiç kart yoksa mesaj göster
      if (!kartVarMi) {
        console.log('❌ Hiç kart bulunamadı');
        currentDiv.innerHTML = '<div style="text-align: center; color: #666; padding: 40px; font-size: 12px;">Bu hafta için henüz eşleşme yok.</div>';
        if (eslesenBaslik) {
          eslesenBaslik.textContent = '📋 Eşleşen Kartlar';
        }
      } else {
        console.log('✅ Kartlar sidebar\'a başarıyla eklendi');
        
        // Benzersiz yemek çeşidi sayısını hesapla
        const benzersizYemekler = new Set();
        
        // Tüm kartlardaki yemek isimlerini topla
        const tumKartlar = currentDiv.querySelectorAll('[data-kart-name]');
        tumKartlar.forEach(kart => {
          const kartName = kart.getAttribute('data-kart-name');
          if (kartName) {
            // .jpg uzantısını kaldır ve normalize et
            const yemekAdi = kartName.replace('.jpg', '').replace(/_/g, ' ').toLowerCase();
            benzersizYemekler.add(yemekAdi);
          }
        });
        
        // Eğer data-kart-name yoksa, görsel isimlerden çıkar
        if (benzersizYemekler.size === 0) {
          const gorselKartlari = currentDiv.querySelectorAll('img');
          gorselKartlari.forEach(img => {
            if (img.src && img.src.includes('/')) {
              const dosyaAdi = img.src.split('/').pop();
              const yemekAdi = dosyaAdi.replace('.jpg', '').replace(/_/g, ' ').toLowerCase();
              benzersizYemekler.add(yemekAdi);
            }
          });
        }
        
        const benzersizSayisi = benzersizYemekler.size;
        console.log('🍽️ Benzersiz yemek çeşidi sayısı:', benzersizSayisi, 'Toplam kart:', currentDiv.children.length);
        
        // Başlık güncelle - benzersiz yemek çeşidi sayısı ile
        if (eslesenBaslik) {
          eslesenBaslik.textContent = `📋 Eşleşen Kartlar (${benzersizSayisi})`;
        }
        
        // Sadece güvenlik için onclick'leri yeniden ata (otomatik kartlar için)
        const tumButonlar = currentDiv.querySelectorAll('button:not(.manuel-kart-silme-btn)');
        console.log('🔍 Sidebar\'da bulunan buton sayısı:', tumButonlar.length);
        
        tumButonlar.forEach((btn, index) => {
          if (btn.textContent.includes('ZIP İndir')) {
            console.log('🔍 ZIP butonu bulundu, onclick kontrol ediliyor...');
            if (!btn.onclick) {
              console.log('🔧 ZIP butonu onclick eksik, yeniden atanıyor...');
              btn.onclick = function(e) { 
                e.preventDefault();
                console.log('🎯 ZIP butonuna tıklandı (sidebar), hafta index:', haftaIndex);
                zipEslesenGorseller(haftaIndex); 
              };
            }
          }
        });
      }
    }
    window.gosterEslesenKartlarSidebar = gosterEslesenKartlarSidebar;

    // ========================
    // SAYFA BAŞLATMA
    // ========================
    
    // Sayfa yüklendiğinde çalışacak başlatma fonksiyonu - SADECE YENİ SİSTEM
    async function sayfaBaslat() {
      console.log('🚀 YENİ SİSTEM BAŞLATILIYOR - Eski sistem devre dışı');
      
      // Sadece yeni sistemi yükle
      console.log('📋 SADECE YENİ SİSTEM: hasta listesi yükleniyor...');
      
      // Token kontrolü
      const token = document.getElementById('githubToken').value.trim();
      if (!token) {
        console.log('ℹ️ GitHub token yok - Offline modda başlatılıyor');
        
        // Boş yeni sistem başlat
        hastaListesi = [];
        renderHastalarYeniSistem();
        
        // Kullanıcıya bilgi ver
        const durum = document.getElementById('githubDurumu');
        if (durum) {
          durum.innerHTML = '⚠️ GitHub token gerekli - Token girin';
        }
        
        return;
      }
      
      // Token varsa direkt yeni sistemi yükle
      try {
        console.log('🔄 GitHub token mevcut, yeni sistem yükleniyor...');
        await loadHastaDataFromGitHub(true); // sessiz yükleme
        console.log('✅ Yeni sistem başarıyla yüklendi');
      } catch (error) {
        console.warn('⚠️ Yeni sistem yüklenemedi, boş sistem başlatılıyor:', error.message);
        hastaListesi = [];
        renderHastalarYeniSistem();
      }
      
      // Toplu ZIP butonunu ekle
      ekleTopluZipButonu();
    }
    
    // Toplu ZIP butonunu sidebar'a ekle
    function ekleTopluZipButonu() {
      const sidebarButtons = document.getElementById('sidebarButtons');
      if (sidebarButtons) {
        // Eğer buton zaten varsa tekrar ekleme
        if (sidebarButtons.querySelector('.toplu-zip-button')) {
          return;
        }
        
        const topluZipButton = document.createElement('button');
        topluZipButton.className = 'toplu-zip-button';
        topluZipButton.innerHTML = '🗜️ TOPLU ZIP İNDİR';
        topluZipButton.title = 'Tüm aktif hastaların en son hafta tablarını tek ZIP dosyasında indir';
        topluZipButton.style.cssText = `
          width: 100%; 
          padding: 12px; 
          font-size: 14px; 
          font-weight: bold; 
          background: linear-gradient(45deg, #ff6b6b, #ee5a24); 
          color: white; 
          border: none; 
          border-radius: 6px; 
          cursor: pointer; 
          margin-bottom: 10px;
          box-shadow: 0 2px 4px rgba(0,0,0,0.2);
          transition: all 0.3s ease;
        `;
        
        // Hover efekti için
        topluZipButton.addEventListener('mouseenter', function() {
          this.style.transform = 'translateY(-2px)';
          this.style.boxShadow = '0 4px 8px rgba(0,0,0,0.3)';
        });
        
        topluZipButton.addEventListener('mouseleave', function() {
          this.style.transform = 'translateY(0)';
          this.style.boxShadow = '0 2px 4px rgba(0,0,0,0.2)';
        });
        
        topluZipButton.onclick = function() {
          topluZipIndir();
        };
        
        // Butonu sidebar'a ekle
        sidebarButtons.appendChild(topluZipButton);
        console.log('✅ Toplu ZIP butonu eklendi');
      }
    }
    
    // === MİGRATION COMPLETED - YENİ SİSTEM AKTİF ===
    // ARTIK SADECE YENİ JSON SİSTEMİ KULLANILIYOR
    // - data/hasta_kayitlari.json kullanılmıyor
    // - Tüm hastalar patients/ klasöründe ayrı JSON dosyaları
    // - Hasta listesi patients/hastalar_listesi.json dosyasında
    // - Eski sistem fonksiyonları yeni sisteme yönlendiriliyor
    
    // ========================
    // MANUEL KART EKLEME SİSTEMİ
    // ========================
    
    let aktifHaftaIndex = null;
    let secilenManuelKartlar = [];
    
    // YEMEK ANALİZİ DEĞİŞKENLERİ
    let yemekAnaliziAcikMi = false;
    let yemekAnaliziSiralama = 'cok'; // 'cok', 'az', 'alfabetik'
    
    function manuelKartEklemeModalAc() {
      // Hasta kontrolü
      if (!seciliHasta) {
        alert('Önce bir hasta seçin!');
        return;
      }
      
      // Önce aktif hafta tab'ını bul
      const aktifTab = document.querySelector('.hafta-tab.active');
      if (!aktifTab) {
        alert('Önce bir hafta seçin!');
        return;
      }
      
      aktifHaftaIndex = parseInt(aktifTab.dataset.haftaIndex);
      if (isNaN(aktifHaftaIndex)) {
        alert('Hafta bilgisi alınamadı!');
        return;
      }
      
      // Hafta verisi kontrolü
      if (!seciliHasta.haftalar || !seciliHasta.haftalar[aktifHaftaIndex]) {
        alert('Bu hafta için veri bulunamadı!');
        return;
      }
      
      const hafta = seciliHasta.haftalar[aktifHaftaIndex];
      
      console.log('🔍 Manuel kart ekleme başlatıldı:', {
        hastaId: seciliHasta.id,
        hastaAdi: seciliHasta.isim,
        haftaIndex: aktifHaftaIndex,
        haftaNo: hafta.haftaNo || 'belirsiz'
      });
      
      // Modal'ı aç
      document.getElementById('manuelKartModal').style.display = 'block';
      document.getElementById('manuelKartArama').value = '';
      secilenManuelKartlar = [];
      
      // Tüm kartları yükle (arama boş bırakılmış gibi)
      manuelKartAramaYap('');
      
      // Modal başlığını güncelle
      const modalBaslik = document.querySelector('#manuelKartModal h3');
      if (modalBaslik) {
        modalBaslik.textContent = `Manuel Kart Ekleme - ${seciliHasta.isim} (${hafta.haftaNo || aktifHaftaIndex + 1}. Hafta)`;
      }
    }
    
    function manuelKartModalKapat(event) {
      if (event && event.target !== document.getElementById('manuelKartModal')) return;
      
      console.log('🔒 Manuel kart modal kapatılıyor');
      
      document.getElementById('manuelKartModal').style.display = 'none';
      secilenManuelKartlar = [];
      aktifHaftaIndex = null; // State'i temizle
      
      // Modal başlığını sıfırla
      const modalBaslik = document.querySelector('#manuelKartModal h3');
      if (modalBaslik) {
        modalBaslik.textContent = 'Manuel Kart Ekleme';
      }
    }
    
    function manuelKartAramaYap(aramaMetni) {
      const liste = document.getElementById('manuelKartListe');
      
      console.log('🔍 Manuel kart arama debug:', {
        aramaMetni,
        windowTarifKartlari: window.tarifKartlari,
        tarifKartlariLength: window.tarifKartlari ? window.tarifKartlari.length : 'undefined'
      });
      
      // Tarif kartları listesinden ara
      if (!window.tarifKartlari || window.tarifKartlari.length === 0) {
        console.log('❌ Tarif kartları yüklenmemiş veya boş!');
        liste.innerHTML = '<div style="text-align: center; color: #dc3545; padding: 20px;">Tarif kartları yüklenmemiş!</div>';
        return;
      }
      
      // Mevcut kartları kategorize et
      const mevcutOtomatikKartlar = [];
      const mevcutManuelKartlar = [];
      
      if (seciliHasta && seciliHasta.haftalar && aktifHaftaIndex !== null && seciliHasta.haftalar[aktifHaftaIndex]) {
        const hafta = seciliHasta.haftalar[aktifHaftaIndex];
        
        // Otomatik eşleşen kartlar
        if (hafta.tarifKartlar) {
          hafta.tarifKartlar.forEach(kart => {
            if (kart.name) {
              mevcutOtomatikKartlar.push(kart.name);
            }
          });
        }
        
        // Manuel eklenen kartlar
        if (hafta.manuelKartlar) {
          hafta.manuelKartlar.forEach(kart => {
            if (kart.name) {
              mevcutManuelKartlar.push(kart.name);
            }
          });
        }
      }
      
      // Tüm kartları filtrele (arama kriterlerine göre)
      let tumKartlar = window.tarifKartlari;
      
      // Arama metni varsa filtreleme yap
      if (aramaMetni && aramaMetni.trim().length > 0) {
        const aramaKelimeler = aramaMetni.toLowerCase().trim().split(/\s+/)
          .map(kelime => karakterDuzelt(kelime));
        
        console.log('🔍 Arama kelimeleri (normalize edilmiş):', aramaKelimeler);
        
        tumKartlar = tumKartlar.filter(kart => {
          const kartAdi = karakterDuzelt(kart.replace('.jpg', '').replace(/_/g, ' ').toLowerCase());
          
          console.log(`🔎 Test edilen kart: "${kart}" → normalize: "${kartAdi}"`);
          
          // Tüm arama kelimelerinin kart adında bulunması gerekiyor
          const eslesiyor = aramaKelimeler.every(kelime => {
            const bulundu = kartAdi.includes(kelime);
            console.log(`  ✓ "${kelime}" kelimesi "${kartAdi}" içinde: ${bulundu}`);
            return bulundu;
          });
          
          console.log(`📊 "${kart}" filtreleme sonucu: ${eslesiyor}`);
          return eslesiyor;
        });
        
        console.log(`📋 Filtreleme sonrası kart sayısı: ${tumKartlar.length}`);
      }
      
      // Sonuçları eşleşme skoruna göre sırala
      if (aramaMetni && aramaMetni.trim().length > 0) {
        const aramaKelimeler = aramaMetni.toLowerCase().trim().split(/\s+/)
          .map(kelime => karakterDuzelt(kelime));
        
        tumKartlar.sort((a, b) => {
          const aAdi = karakterDuzelt(a.replace('.jpg', '').replace(/_/g, ' ').toLowerCase());
          const bAdi = karakterDuzelt(b.replace('.jpg', '').replace(/_/g, ' ').toLowerCase());
          
          // Tam arama metni eşleşmesi
          const aramaTam = aramaKelimeler.join(' ');
          const aIceriyor = aAdi.includes(aramaTam);
          const bIceriyor = bAdi.includes(aramaTam);
          
          if (aIceriyor && !bIceriyor) return -1;
          if (!aIceriyor && bIceriyor) return 1;
          
          // Başlangıç eşleşmesi
          const aBaslangic = aramaKelimeler.some(kelime => aAdi.startsWith(kelime));
          const bBaslangic = aramaKelimeler.some(kelime => bAdi.startsWith(kelime));
          
          if (aBaslangic && !bBaslangic) return -1;
          if (!aBaslangic && bBaslangic) return 1;
          
          // Alfabetik sıralama
          return a.localeCompare(b, 'tr-TR');
        });
      }
      
      if (tumKartlar.length === 0) {
        liste.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">Sonuç bulunamadı</div>';
        return;
      }
      
      // Sonuçları liste olarak göster
      let html = '<div style="max-height: 300px; overflow-y: auto;">';
      
      tumKartlar.forEach(kart => {
        const kartAdi = kart.replace('.jpg', '').replace(/_/g, ' ');
        const otomatikMi = mevcutOtomatikKartlar.includes(kart);
        const manuelMi = mevcutManuelKartlar.includes(kart);
        const seciliMi = secilenManuelKartlar.includes(kart);
        const pasifMi = otomatikMi || manuelMi;
        
        let backgroundColor, hoverColor, textColor, prefix, icon;
        
        if (manuelMi) {
          // Manuel eklenen - Sarı marker
          backgroundColor = 'rgba(255, 215, 0, 0.2)'; // Transparan sarı
          hoverColor = 'rgba(255, 215, 0, 0.3)';
          textColor = '#666';
          prefix = '🖐️ ';
          icon = '';
        } else if (otomatikMi) {
          // Otomatik eşleşen - Yeşil marker  
          backgroundColor = 'rgba(40, 167, 69, 0.2)'; // Transparan yeşil
          hoverColor = 'rgba(40, 167, 69, 0.3)';
          textColor = '#666';
          prefix = '🔗 ';
          icon = '';
        } else if (seciliMi) {
          // Yeni seçilen
          backgroundColor = '#e8f5e8';
          hoverColor = '#d4edda';
          textColor = '#333';
          prefix = '';
          icon = '';
        } else {
          // Henüz eklenmemiş
          backgroundColor = 'white';
          hoverColor = '#f8f9fa';
          textColor = '#333';
          prefix = '';
          icon = '';
        }
        
        html += `
          <div ${pasifMi ? '' : `onclick="manuelKartToggle('${kart}')"`} style="
            cursor: ${pasifMi ? 'not-allowed' : 'pointer'}; 
            padding: 8px 12px; 
            border-bottom: 1px solid #eee;
            background: ${backgroundColor};
            display: flex;
            align-items: center;
            transition: background 0.2s;
            opacity: ${pasifMi ? '0.7' : '1'};
          " ${pasifMi ? '' : `onmouseover="this.style.background='${hoverColor}'" onmouseout="this.style.background='${backgroundColor}'"`}>
            ${pasifMi ? 
              `<span style="margin-right: 10px; color: #999;">●</span>` : 
              `<input type="checkbox" ${seciliMi ? 'checked' : ''} style="margin-right: 10px; pointer-events: none;" />`
            }
            <span style="font-size: 14px; color: ${textColor}; flex: 1;">${prefix}${kartAdi}</span>
            ${manuelMi ? '<span style="font-size: 11px; color: #856404; background: rgba(255, 215, 0, 0.3); padding: 2px 6px; border-radius: 10px; margin-left: 8px;">MANUEL</span>' : ''}
            ${otomatikMi ? '<span style="font-size: 11px; color: #155724; background: rgba(40, 167, 69, 0.3); padding: 2px 6px; border-radius: 10px; margin-left: 8px;">OTOMATİK</span>' : ''}
          </div>
        `;
      });
      
      html += '</div>';
      liste.innerHTML = html;
    }
    
    function manuelKartToggle(kartAdi) {
      const index = secilenManuelKartlar.indexOf(kartAdi);
      if (index > -1) {
        secilenManuelKartlar.splice(index, 1);
      } else {
        secilenManuelKartlar.push(kartAdi);
      }
      
      // Listeyi güncelle (mevcut arama metnini koru)
      const aramaMetni = document.getElementById('manuelKartArama').value;
      manuelKartAramaYap(aramaMetni);
    }
    
    function getMevcutHaftaKartlari() {
      if (!seciliHasta || !seciliHasta.haftalar || aktifHaftaIndex === null || !seciliHasta.haftalar[aktifHaftaIndex]) {
        return [];
      }
      
      const hafta = seciliHasta.haftalar[aktifHaftaIndex];
      const kartlar = [];
      
      console.log('🔍 Mevcut hafta kartları kontrol ediliyor:', {
        hastaId: seciliHasta.id,
        hastaAdi: seciliHasta.isim,
        haftaIndex: aktifHaftaIndex,
        haftaNo: hafta.haftaNo
      });
      
      // Otomatik eşleşen kartlar
      if (hafta.tarifKartlar) {
        hafta.tarifKartlar.forEach(kart => {
          if (kart.name) {
            kartlar.push(kart.name);
            console.log('📄 Otomatik kart bulundu:', kart.name);
          }
        });
      }
      
      // Manuel eklenen kartlar (sadece bu hafta için)
      if (hafta.manuelKartlar) {
        hafta.manuelKartlar.forEach(kart => {
          if (kart.name) {
            kartlar.push(kart.name);
            console.log('🖐️ Manuel kart bulundu:', kart.name);
          }
        });
      }
      
      console.log('✅ Toplam mevcut kartlar:', kartlar);
      return kartlar;
    }
    
    function secilenManuelKartlariEkle() {
      if (secilenManuelKartlar.length === 0) {
        alert('Hiç kart seçilmedi!');
        return;
      }
      
      if (!seciliHasta) {
        alert('Hasta seçilmemiş!');
        return;
      }
      
      console.log('📝 Manuel kartlar ekleniyor:', secilenManuelKartlar);
      
      // Hasta verilerine manuel kartları ekle
      if (!seciliHasta.haftalar[aktifHaftaIndex]) {
        alert('Hafta verisi bulunamadı!');
        return;
      }
      
      const hafta = seciliHasta.haftalar[aktifHaftaIndex];
      if (!hafta.manuelKartlar) {
        hafta.manuelKartlar = [];
      }
      
      // Yeni kartları ekle
      secilenManuelKartlar.forEach(kartAdi => {
        hafta.manuelKartlar.push({
          name: kartAdi,
          data: `https://mustafasacar35.github.io/lipodem-takip-paneli-4/tarifler/${kartAdi}`,
          eklenmeTarihi: new Date().toISOString()
        });
      });
      
      console.log('✅ Manuel kartlar hafta verisine eklendi');
      
      // Alert için kart sayısını sakla (modal kapatılmadan önce)
      const eklenenKartSayisi = secilenManuelKartlar.length;
      
      // Verileri kaydet
      saveToStorage();
      hastayiAyriKaydet(seciliHasta);
      
      // Sidebar'ı güncelle
      haftaTabSecildiginde(aktifHaftaIndex);
      
      // Modal'ı kapat
      manuelKartModalKapat();
      
      // Yemek analizini güncelle
      updateYemekAnalizi();
      
      alert(`✅ ${eklenenKartSayisi} kart başarıyla eklendi!`);
    }
    
    // Manuel kart silme fonksiyonu
    function manuelKartSil(kartAdi, haftaIndex) {
      if (!seciliHasta || !seciliHasta.haftalar[haftaIndex]) {
        alert('Hasta veya hafta verisi bulunamadı!');
        return;
      }
      
      const hafta = seciliHasta.haftalar[haftaIndex];
      if (!hafta.manuelKartlar) return;
      
      // Kartı listeden çıkar
      hafta.manuelKartlar = hafta.manuelKartlar.filter(kart => kart.name !== kartAdi);
      
      console.log('🗑️ Manuel kart silindi:', kartAdi);
      
      // Verileri kaydet
      saveToStorage();
      hastayiAyriKaydet(seciliHasta);
      
      // Sidebar'ı güncelle
      haftaTabSecildiginde(haftaIndex);
      
      // Yemek analizini güncelle
      updateYemekAnalizi();
    }
    
    // Çoklu PDF kartını silme fonksiyonu
    function cokluPdfKartSil(kartAdi, haftaIndex, veriIndex) {
      if (!seciliHasta || !seciliHasta.haftalar[haftaIndex]) {
        alert('Hasta veya hafta verisi bulunamadı!');
        return;
      }
      
      const hafta = seciliHasta.haftalar[haftaIndex];
      if (!hafta.cokluPdfVerileri || !hafta.cokluPdfVerileri[veriIndex]) return;
      
      const pdfVeri = hafta.cokluPdfVerileri[veriIndex];
      if (!pdfVeri.tarifKartlar) return;
      
      // Kartı listeden çıkar
      pdfVeri.tarifKartlar = pdfVeri.tarifKartlar.filter(kart => kart.name !== kartAdi);
      
      console.log('🗑️ Çoklu PDF kartı silindi:', kartAdi);
      
      // Verileri kaydet
      saveToStorage();
      hastayiAyriKaydet(seciliHasta);
      
      // Sidebar'ı güncelle
      haftaTabSecildiginde(haftaIndex);
      
      // Yemek analizini güncelle
      updateYemekAnalizi();
    }
    
    // Global olarak erişilebilir yap
    window.manuelKartEklemeModalAc = manuelKartEklemeModalAc;
    window.manuelKartModalKapat = manuelKartModalKapat;
    window.manuelKartAramaYap = manuelKartAramaYap;
    window.manuelKartToggle = manuelKartToggle;
    window.secilenManuelKartlariEkle = secilenManuelKartlariEkle;
    window.manuelKartSil = manuelKartSil;
    window.cokluPdfKartSil = cokluPdfKartSil;

    // ========================
    // SÜRÜKLENEBİLİR SIDEBAR
    // ========================
    
    function initResizableSidebars() {
      const container = document.querySelector('.main-container');
      const leftHandle = document.getElementById('leftHandle');
      const rightHandle = document.getElementById('rightHandle');
      
      let isResizing = false;
      let currentHandle = null;
      
      // Sol ayırıcı için
      leftHandle.addEventListener('mousedown', (e) => {
        isResizing = true;
        currentHandle = 'left';
        document.body.style.cursor = 'ew-resize';
        document.body.style.userSelect = 'none';
        e.preventDefault();
      });
      
      // Sağ ayırıcı için
      rightHandle.addEventListener('mousedown', (e) => {
        isResizing = true;
        currentHandle = 'right';
        document.body.style.cursor = 'ew-resize';
        document.body.style.userSelect = 'none';
        e.preventDefault();
      });
      
      // Mouse move
      document.addEventListener('mousemove', (e) => {
        if (!isResizing) return;
        
        const containerRect = container.getBoundingClientRect();
        const mouseX = e.clientX - containerRect.left;
        
        if (currentHandle === 'left') {
          // Sol sidebar genişliğini ayarla (min: 200px, max: 400px)
          const newLeftWidth = Math.max(200, Math.min(400, mouseX));
          container.style.gridTemplateColumns = `${newLeftWidth}px 4px 1fr 4px 200px`;
        } else if (currentHandle === 'right') {
          // Sağ sidebar genişliğini ayarla (min: 200px, max: 500px)
          const newRightWidth = Math.max(200, Math.min(500, containerRect.width - mouseX));
          container.style.gridTemplateColumns = `280px 4px 1fr 4px ${newRightWidth}px`;
        }
      });
      
      // Mouse up
      document.addEventListener('mouseup', () => {
        if (isResizing) {
          isResizing = false;
          currentHandle = null;
          document.body.style.cursor = '';
          document.body.style.userSelect = '';
        }
      });
    }
    
    // Sayfa yüklendiğinde başlat
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
    // === YEMEK KULLANIM ANALİZİ FONKSIYONLARI ===
    
    function siralaYemekAnalizi(tip) {
      yemekAnaliziSiralama = tip;
      updateYemekAnalizi();
    }
    
    // Sıralama fonksiyonunu global yap
    window.siralaYemekAnalizi = siralaYemekAnalizi;
    
    function updateYemekAnalizi() {
      console.log('📊 updateYemekAnalizi fonksiyonu çağrıldı');
      
      if (!seciliHasta || !seciliHasta.haftalar) {
        document.getElementById('yemekAnaliziListe').innerHTML = 
          '<div style="text-align: center; color: #666; padding: 20px;">Hasta seçilmemiş</div>';
        return;
      }
      
      // aktifHaftaIndex null ise en son haftayı al
      if (aktifHaftaIndex === null || aktifHaftaIndex === undefined) {
        aktifHaftaIndex = seciliHasta.haftalar.length - 1;
        console.log('ℹ️ aktifHaftaIndex null/undefined idi, en son hafta atandı:', aktifHaftaIndex);
      }
      
      // Hafta index sınırlarını kontrol et
      if (aktifHaftaIndex < 0 || aktifHaftaIndex >= seciliHasta.haftalar.length) {
        aktifHaftaIndex = seciliHasta.haftalar.length - 1;
        console.log('⚠️ aktifHaftaIndex sınır dışı, düzeltildi:', aktifHaftaIndex);
      }
      
      // Tüm tarif kartları yoksa veya yüklenmediyse yeniden yükleme dene
      if (!window.tarifKartlari || window.tarifKartlari.length === 0) {
        console.log('⚠️ Tarif kartları yüklenmemiş, yeniden yükleme deneniyor...');
        
        // Tarif kartlarını yeniden yükleme dene
        if (typeof loadTarifKartlariFromGitHub === 'function') {
          loadTarifKartlariFromGitHub().then(() => {
            console.log('✅ Tarif kartları yeniden yüklendi, analiz tekrar deneniyor');
            setTimeout(() => updateYemekAnalizi(), 1000); // 1 saniye sonra tekrar dene
          }).catch(err => {
            console.error('❌ Tarif kartları yeniden yüklenemedi:', err);
          });
        }
        
        document.getElementById('yemekAnaliziListe').innerHTML = 
          '<div style="text-align: center; color: #dc3545; padding: 20px;">Tarif kartları yüklenmeyi bekliyor... <br><small>GitHub\'dan tarif kartları çekiliyor</small></div>';
        return;
      }
      
      const aktifHafta = seciliHasta.haftalar[aktifHaftaIndex];
      const aktifHaftaNo = aktifHafta ? (aktifHafta.haftaNo || (aktifHaftaIndex + 1)) : 1;
      
      console.log('📊 Yemek analizi başlatılıyor:', {
        hastaId: seciliHasta.id,
        aktifHaftaIndex,
        aktifHaftaNo,
        toplamTarifKartSayisi: window.tarifKartlari.length
      });
      
      // TÜM tarif kartları için kullanım sayacı başlat
      const yemekKullanimlari = {};
      
      // Önce tüm tarif kartlarını 0 ile başlat
      window.tarifKartlari.forEach(kart => {
        const yemekAdi = kart.replace('.jpg', '').replace(/_/g, ' ');
        yemekKullanimlari[yemekAdi] = { sayac: 0, haftalar: [] };
      });
      
      console.log('🔄 Yemek analizi başlatıldı:', {
        hasta: seciliHasta.ad || seciliHasta.name || 'Bilinmeyen Hasta',
        haftaSayisi: seciliHasta.haftalar.length,
        aktifHafta: aktifHaftaNo,
        analizEdilenHaftalar: seciliHasta.haftalar.filter((_, index) => (index + 1) <= aktifHaftaNo).length
      });
      
      // Seçili haftaya kadar olan tüm haftaları kontrol et
      seciliHasta.haftalar.forEach((hafta, index) => {
        const haftaNo = hafta.haftaNo || (index + 1);
        
        // Sadece seçili haftaya kadar olan haftaları say
        if (haftaNo <= aktifHaftaNo) {
          const haftaninYemekleri = new Set(); // Aynı hafta içinde tekrar saymaması için Set kullan
          
          console.log(`🔍 Hafta ${haftaNo} analiz ediliyor:`, {
            tarifKartlar: hafta.tarifKartlar?.length || 0,
            manuelKartlar: hafta.manuelKartlar?.length || 0,
            cokluPdfVerileri: hafta.cokluPdfVerileri?.length || 0,
            tarifKartlarVeriTipi: hafta.tarifKartlar && hafta.tarifKartlar.length > 0 ? typeof hafta.tarifKartlar[0] : 'empty_array',
            tarifKartlarOrnek: hafta.tarifKartlar ? hafta.tarifKartlar.slice(0, 2) : [],
            manuelKartlarOrnek: hafta.manuelKartlar ? hafta.manuelKartlar.slice(0, 2) : []
          });
          
          // 1. Otomatik eşleşen kartlar (Manuel PDF yükleme + Çoklu PDF otomatik eşleştirme)
          if (hafta.tarifKartlar && hafta.tarifKartlar.length > 0) {
            hafta.tarifKartlar.forEach(kart => {
              let kartAdi = null;
              
              // Farklı veri yapılarını kontrol et
              if (typeof kart === 'string') {
                kartAdi = kart; // Direkt string
              } else if (kart.name) {
                kartAdi = kart.name; // {name: "kart_adi.jpg"}
              } else if (kart.kartResmi) {
                kartAdi = kart.kartResmi; // {kartResmi: "kart_adi.jpg"}
              }
              
              if (kartAdi) {
                const yemekAdi = kartAdi.replace('.jpg', '').replace(/_/g, ' ');
                haftaninYemekleri.add(yemekAdi);
                console.log(`✅ Otomatik eşleşen: ${yemekAdi}`);
              }
            });
          }
          
          // 2. Manuel eklenen kartlar (Sidebar'dan manuel ekleme)
          if (hafta.manuelKartlar && hafta.manuelKartlar.length > 0) {
            hafta.manuelKartlar.forEach(kart => {
              let kartAdi = null;
              
              // Farklı veri yapılarını kontrol et
              if (typeof kart === 'string') {
                kartAdi = kart; // Direkt string
              } else if (kart.name) {
                kartAdi = kart.name; // {name: "kart_adi.jpg"}
              }
              
              if (kartAdi) {
                const yemekAdi = kartAdi.replace('.jpg', '').replace(/_/g, ' ');
                haftaninYemekleri.add(yemekAdi);
                console.log(`✅ Manuel eklenen: ${yemekAdi}`);
              }
            });
          }
          
          // 3. Çoklu PDF'den eklenen kartlar (Eski yapı - geriye uyumluluk)
          if (hafta.cokluPdfVerileri && hafta.cokluPdfVerileri.length > 0) {
            hafta.cokluPdfVerileri.forEach(veri => {
              if (veri.tarifKartlar && veri.tarifKartlar.length > 0) {
                veri.tarifKartlar.forEach(kart => {
                  let kartAdi = null;
                  
                  // Farklı veri yapılarını kontrol et
                  if (typeof kart === 'string') {
                    kartAdi = kart; // Direkt string
                  } else if (kart.name) {
                    kartAdi = kart.name; // {name: "kart_adi.jpg"}
                  } else if (kart.kartResmi) {
                    kartAdi = kart.kartResmi; // {kartResmi: "kart_adi.jpg"}
                  }
                  
                  if (kartAdi) {
                    const yemekAdi = kartAdi.replace('.jpg', '').replace(/_/g, ' ');
                    haftaninYemekleri.add(yemekAdi);
                    console.log(`✅ Çoklu PDF (eski): ${yemekAdi}`);
                  }
                });
              }
            });
          }
          
          // Her hafta için toplam eşsiz yemek sayısını raporla  
          console.log(`📊 Hafta ${haftaNo} toplam eşsiz yemek: ${haftaninYemekleri.size}`);
          
          // Bu haftada kullanılan her benzersiz yemeği kaydet
          haftaninYemekleri.forEach(yemekAdi => {
            if (yemekKullanimlari[yemekAdi]) {
              yemekKullanimlari[yemekAdi].sayac++;
              yemekKullanimlari[yemekAdi].haftalar.push(haftaNo);
            }
          });
        }
      });
      
      console.log('📊 Toplam analiz edilen yemek sayısı:', Object.keys(yemekKullanimlari).length);
      console.log('📋 Analiz edilen yemekler:', Object.keys(yemekKullanimlari));
      
      // Debug: Hasta verilerinin yapısını incele
      console.log('🔍 Hasta veri yapısı analizi:', {
        hastalar: Object.keys(window.hastalar || {}),
        seciliHasta: seciliHasta?.ad || 'Seçili değil',
        haftaSayisi: seciliHasta?.haftalar?.length || 0,
        aktifHafta: aktifHaftaNo
      });
      
      // Sonuçları diziye çevir ve sırala
      let yemekListesi = Object.keys(yemekKullanimlari).map(yemekAdi => ({
        ad: yemekAdi,
        sayac: yemekKullanimlari[yemekAdi].sayac,
        haftalar: yemekKullanimlari[yemekAdi].haftalar.sort((a,b) => a-b)
      }));
      
      // Sıralama yap
      if (yemekAnaliziSiralama === 'cok') {
        yemekListesi.sort((a, b) => b.sayac - a.sayac || a.ad.localeCompare(b.ad));
      } else if (yemekAnaliziSiralama === 'az') {
        yemekListesi.sort((a, b) => a.sayac - b.sayac || a.ad.localeCompare(b.ad));
      } else if (yemekAnaliziSiralama === 'hic') {
        // Önce hiç kullanılmayanlar (0), sonra kullanılanlar az->çok
        yemekListesi.sort((a, b) => {
          if (a.sayac === 0 && b.sayac === 0) return a.ad.localeCompare(b.ad);
          if (a.sayac === 0) return -1;
          if (b.sayac === 0) return 1;
          return a.sayac - b.sayac || a.ad.localeCompare(b.ad);
        });
      } else { // alfabetik
        yemekListesi.sort((a, b) => a.ad.localeCompare(b.ad));
      }
      
      // Aktif buton stilini güncelle
      document.querySelectorAll('[id^="btn"]').forEach(btn => {
        btn.style.background = '#6c757d';
      });
      
      if (yemekAnaliziSiralama === 'cok') document.getElementById('btnCok').style.background = '#28a745';
      else if (yemekAnaliziSiralama === 'az') document.getElementById('btnAz').style.background = '#dc3545';
      else if (yemekAnaliziSiralama === 'hic') document.getElementById('btnHic').style.background = '#6c757d';
      else document.getElementById('btnAlfabetik').style.background = '#17a2b8';
      
      // HTML oluştur
      const listeDiv = document.getElementById('yemekAnaliziListe');
      const kullanilmayanSayisi = yemekListesi.filter(y => y.sayac === 0).length;
      const kullanilanSayisi = yemekListesi.filter(y => y.sayac > 0).length;
      
      let html = `<div style="background: #f8f9fa; padding: 10px; margin-bottom: 10px; font-weight: bold; color: #333; border-bottom: 1px solid #ddd;">
        ${aktifHaftaNo}. haftaya kadar • Toplam: ${yemekListesi.length} tarif • Kullanılan: ${kullanilanSayisi} • Kullanılmayan: ${kullanilmayanSayisi}
      </div>`;
      
      yemekListesi.forEach(yemek => {
        let renkKodu, durum;
        if (yemek.sayac === 0) {
          renkKodu = '#6c757d';
          durum = 'KULLANILMADI';
        } else if (yemek.sayac >= 5) {
          renkKodu = '#28a745';
          durum = 'ÇOK KULLANILDI';
        } else if (yemek.sayac >= 3) {
          renkKodu = '#ffc107';
          durum = 'ORTA SEVİYE';
        } else {
          renkKodu = '#dc3545';
          durum = 'AZ KULLANILDI';
        }
        
        const haftalarStr = yemek.sayac > 0 ? yemek.haftalar.join('-') : '';
        
        html += `
          <div style="display: flex; align-items: center; padding: 8px 12px; border-bottom: 1px solid #f0f0f0; background: white; margin-bottom: 1px;">
            <span style="background: ${renkKodu}; color: white; border-radius: 50%; width: 30px; height: 30px; display: inline-flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; margin-right: 12px; min-width: 30px;">
              ${yemek.sayac}
            </span>
            <span style="flex: 1; font-weight: 500; color: #333; margin-right: 10px;">
              ${yemek.ad}
            </span>
            ${yemek.sayac > 0 ? 
              `<span style="font-size: 11px; color: #666; background: #e9ecef; padding: 3px 8px; border-radius: 12px; margin-right: 8px;">
                ${haftalarStr}
              </span>` : ''
            }
            <span style="font-size: 10px; color: ${renkKodu}; font-weight: bold; min-width: 80px; text-align: right;">
              ${durum}
            </span>
          </div>
        `;
      });
      
      listeDiv.innerHTML = html;
      
      // Accordion başlığını güncelle
      const analizBaslik = document.getElementById('analizBaslik');
      if (analizBaslik) {
        analizBaslik.textContent = `📊 Yemek Kullanım Analizi (${kullanilanSayisi}/${yemekListesi.length})`;
      }
      
      // Toplam bilgi elementi artık accordion sisteminde yok, kaldırıldı
      // document.getElementById('analizToplamBilgi').textContent = 
      //   `${yemekListesi.length} tarif • ${kullanilanSayisi} kullanılan`;
    }
    
    // Analiz fonksiyonunu da global yap
    window.updateYemekAnalizi = updateYemekAnalizi;

    // 🎯 ACCORDION SİSTEMİ
    function toggleAccordion(section) {
      const sections = ['eslesen', 'eslesmeyenler', 'analiz', 'veritabaniAnalizi'];
      
      sections.forEach(s => {
        const content = document.getElementById(s + 'Content');
        const icon = document.getElementById(s + 'Icon');
        
        if (s === section) {
          // Seçilen bölümü aç/kapat
          const isOpen = content.style.display === 'block';
          content.style.display = isOpen ? 'none' : 'block';
          icon.textContent = isOpen ? '▶' : '▼';
        } else {
          // Diğer bölümleri kapat
          content.style.display = 'none';
          icon.textContent = '▶';
        }
      });
    }
    
    // Global accordion fonksiyonu
    window.toggleAccordion = toggleAccordion;

    // GitHub Token fonksiyonları
    function saveTokenToStorage() {
      const token = document.getElementById('githubToken').value;
      if (token) {
        // Save to both legacy and canonical keys
        try { localStorage.setItem('githubToken', token); } catch {}
        try { localStorage.setItem('github_api_token', token); } catch {}
        console.log('🔑 GitHub token kaydedildi');
      }
    }

    async function testGitHubToken() {
      const token = document.getElementById('githubToken').value;
      const repo = document.getElementById('githubRepo').value;
      
      if (!token) {
        alert('GitHub token giriniz!');
        return;
      }
      
      if (!repo) {
        alert('GitHub repo giriniz!');
        return;
      }
      
      try {
        const response = await fetch(`https://api.github.com/repos/${repo}`, {
          headers: {
            'Authorization': `token ${token}`,
            'Accept': 'application/vnd.github.v3+json'
          }
        });
        
        if (response.ok) {
          const data = await response.json();
          alert(`✅ Token başarılı! Repo: ${data.full_name}\nStar: ${data.stargazers_count}\nFork: ${data.forks_count}`);
          console.log('✅ GitHub token test başarılı:', data);
        } else {
          alert(`❌ Token hatalı! HTTP ${response.status}: ${response.statusText}`);
          console.error('❌ GitHub token test başarısız:', response.status, response.statusText);
        }
      } catch (error) {
        alert(`❌ Bağlantı hatası: ${error.message}`);
        console.error('❌ GitHub token test hatası:', error);
      }
    }

    // Global fonksiyonları ekle
    window.saveTokenToStorage = saveTokenToStorage;
    window.testGitHubToken = testGitHubToken;

    // 📁 ÇOKLU PDF UPLOAD SİSTEMİ
    function parseProfessionalPdfName(fileName) {
      // Türkçe karakterleri normalize et
      fileName = fileName.replace(/[İıĞğÜüŞşÖöÇç]/g, (match) => {
        const map = {'İ': 'I', 'ı': 'i', 'Ğ': 'G', 'ğ': 'g', 'Ü': 'U', 'ü': 'u', 'Ş': 'S', 'ş': 's', 'Ö': 'O', 'ö': 'o', 'Ç': 'C', 'ç': 'c'};
        return map[match] || match;
      });

      // Türkçe ay isimleri mapping
      const aylar = {
        'OCAK': 1, 'SUBAT': 2, 'MART': 3, 'NISAN': 4,
        'MAYIS': 5, 'HAZIRAN': 6, 'TEMMUZ': 7, 'AGUSTOS': 8,
        'EYLUL': 9, 'EKIM': 10, 'KASIM': 11, 'ARALIK': 12
      };

      // Regex pattern - Birden fazla format desteği
      const patterns = [
        // ESİN KARAKUŞ 28 TEMMUZ -3 AĞUSTOS 17. HAFTA
        /^(.+?)\s+(\d{1,2})\s+(\w+)\s*-\s*(\d{1,2})\s+(\w+)\s+(\d+)\.\s*HAFTA/i,
        // DERYA BAYINDIR 9-15 HAZİRAN 11. HAFTA
        /^(.+?)\s+(\d{1,2})\s*-\s*(\d{1,2})\s+(\w+)\s+(\d+)\.\s*HAFTA/i,
        // DERYA BAYINDIR 2-8 HAZİRAN 10.HAFTA (boşluksuz)
        /^(.+?)\s+(\d{1,2})\s*-\s*(\d{1,2})\s+(\w+)\s+(\d+)\.HAFTA/i
      ];
      
      for (let pattern of patterns) {
        const match = fileName.replace('.pdf', '').match(pattern);
        
        if (match) {
          if (match.length === 7) {
            // Format: HASTA ADI GUN1 AY1 - GUN2 AY2 HAFTA
            const [_, hastaAdi, gun1, ay1, gun2, ay2, haftaNo] = match;
            return {
              hastaAdi: hastaAdi.trim(),
              baslangicTarihi: `${gun1} ${ay1}`,
              bitisTarihi: `${gun2} ${ay2}`,
              haftaNo: parseInt(haftaNo),
              tarihAraligi: `${gun1} ${ay1} - ${gun2} ${ay2}`
            };
          } else if (match.length === 6) {
            // Format: HASTA ADI GUN1-GUN2 AY HAFTA
            const [_, hastaAdi, gun1, gun2, ay, haftaNo] = match;
            return {
              hastaAdi: hastaAdi.trim(),
              baslangicTarihi: `${gun1} ${ay}`,
              bitisTarihi: `${gun2} ${ay}`,
              haftaNo: parseInt(haftaNo),
              tarihAraligi: `${gun1}-${gun2} ${ay}`
            };
          }
        }
      }
      
      return null;
    }

    function findOrCreateHasta(hastaAdi) {
      // Null/undefined check
      if (!hastaAdi || typeof hastaAdi !== 'string') {
        console.error('❌ Geçersiz hasta adı:', hastaAdi);
        return null;
      }

      // hastalar array kontrol
      if (!hastalar || !Array.isArray(hastalar)) {
        console.error('❌ hastalar array tanımlı değil, boş array oluşturuluyor');
        window.hastalar = [];
      }

      console.log('🔍 findOrCreateHasta çağrıldı:', hastaAdi, 'Mevcut hasta sayısı:', hastalar.length);

      // Mevcut hastalar arasında ara
      let mevcutHasta = hastalar.find(h => {
        console.log('🔍 Hasta kontrol:', h);
        return h && h.ad && h.ad.toLowerCase() === hastaAdi.toLowerCase();
      });
      
      if (!mevcutHasta) {
        // Yeni hasta oluştur
        const yeniHastaId = 'hasta_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        mevcutHasta = {
          id: yeniHastaId,
          ad: hastaAdi,
          haftalar: []
        };
        hastalar.push(mevcutHasta);
        console.log('✅ Yeni hasta oluşturuldu:', hastaAdi);
      }
      
      return mevcutHasta;
    }

    function findOrCreateHafta(hasta, haftaNo, tarihAraligi) {
      // Mevcut hafta var mı kontrol et
      let mevcutHafta = hasta.haftalar.find(h => h.haftaNo === haftaNo);
      
      if (!mevcutHafta) {
        // Yeni hafta oluştur
        mevcutHafta = {
          haftaNo: haftaNo,
          tarihAraligi: tarihAraligi,
          tarifler: [],
          tarifKartlar: [],
          manuelKartlar: [],
          gptMesaj: '',
          aciklama: ''
        };
        hasta.haftalar.push(mevcutHafta);
        
        // Hafta sırasına göre sırala
        hasta.haftalar.sort((a, b) => a.haftaNo - b.haftaNo);
        
        console.log(`✅ ${hasta.ad} için ${haftaNo}. hafta oluşturuldu (${tarihAraligi})`);
      }
      
      return mevcutHafta;
    }

    // 🔧 YARDIMCI FONKSİYONLAR
    function extractTariflerFromText(pdfText) {
      if (!pdfText) return [];
      
      // Basit tarif çıkarma - satırları al ve temizle
      const satirlar = pdfText.split('\n').filter(satir => 
        satir.trim().length > 2 && 
        !satir.includes('HAFTA') && 
        !satir.includes('TEMMUZ') &&
        !satir.includes('AĞUSTOS')
      );
      
      console.log('📝 PDF\'den çıkarılan tarifler:', satirlar.length);
      return satirlar.slice(0, 20); // İlk 20 satırı al
    }

    async function extractPdfText(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = async function(e) {
          try {
            const typedarray = new Uint8Array(e.target.result);
            const pdf = await pdfjsLib.getDocument(typedarray).promise;
            let fullText = '';
            
            for (let i = 1; i <= pdf.numPages; i++) {
              const page = await pdf.getPage(i);
              const textContent = await page.getTextContent();
              const pageText = textContent.items.map(item => item.str).join(' ');
              fullText += pageText + '\n';
            }
            
            resolve(fullText);
          } catch (error) {
            reject(error);
          }
        };
        reader.onerror = () => reject(new Error('PDF okuma hatası'));
        reader.readAsArrayBuffer(file);
      });
    }

    async function performTarifEslestirmesi(hafta, hasta) {
      if (!hafta.tarifler || hafta.tarifler.length === 0) {
        return;
      }

      console.log(`🔗 ${hasta.ad} ${hafta.haftaNo}. hafta: tarif eşleştirmesi başlatıldı`);
      
      // Basit eşleştirme - mevcut tarif kartları ile karşılaştır
      if (window.tarifKartlari && window.tarifKartlari.length > 0) {
        hafta.tarifKartlar = [];
        
        // Her tarifi kontrol et
        hafta.tarifler.forEach(tarif => {
          const eslesen = window.tarifKartlari.find(kart => {
            const kartAdi = kart.replace('.jpg', '').replace(/_/g, ' ').toLowerCase();
            return tarif.toLowerCase().includes(kartAdi) || kartAdi.includes(tarif.toLowerCase());
          });
          
          if (eslesen) {
            hafta.tarifKartlar.push({ name: eslesen });
          }
        });
        
        console.log(`🔗 ${hasta.ad} ${hafta.haftaNo}. hafta: ${hafta.tarifKartlar.length} tarif eşleşti`);
      }
    }

    // Çoklu PDF sonuçlarını göster
    function showCokluPdfSonuclari(sonuclar, basarili, hatali) {
      const mesajlar = [];
      
      sonuclar.forEach(sonuc => {
        if (sonuc.durum === 'BAŞARILI') {
          mesajlar.push(`✅ ${sonuc.dosya} → ${sonuc.hasta} (${sonuc.hafta}. hafta) - ${sonuc.tarifSayisi || 0} tarif, ${sonuc.eslesmeSayisi || 0} eşleşme`);
        } else {
          mesajlar.push(`❌ ${sonuc.dosya} → ${sonuc.mesaj}`);
        }
      });
      
      const rapor = `
📁 ÇOKLU PDF İŞLEME RAPORU

✅ Başarılı: ${basarili}
❌ Hatalı: ${hatali}
📊 Toplam: ${sonuclar.length}

DETAYLAR:
${mesajlar.join('\n')}
      `;
      
      // Raporu modal olarak göster
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.5); z-index: 10000;
        display: flex; align-items: center; justify-content: center;
      `;
      
      modal.innerHTML = `
        <div style="background: white; padding: 20px; border-radius: 8px; max-width: 600px; max-height: 80vh; overflow-y: auto;">
          <h3>📁 PDF İşleme Sonuçları</h3>
          <pre style="background: #f5f5f5; padding: 15px; border-radius: 4px; white-space: pre-wrap; font-size: 12px;">${rapor}</pre>
          <button onclick="this.closest('.modal').remove()" style="margin-top: 15px; padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">Kapat</button>
        </div>
      `;
      
      modal.className = 'modal';
      document.body.appendChild(modal);
      
      // Modal dışına tıklanırsa kapat
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.remove();
        }
      });
      
      console.log('📊 PDF işleme raporu gösterildi');
    }

    // Global erişim için
    window.showCokluPdfSonuclari = showCokluPdfSonuclari;

    // Hasta listesini güncelle (sidebar'ı yenile)
    function updateHastaListesi() {
      console.log('🔄 Hasta listesi güncelleniyor...');
      
      // Yeni sistem hasta listesini kullan
      if (typeof renderHastalarYeniSistem === 'function') {
        console.log('✅ Yeni sisteme yönlendiriliyor...');
        renderHastalarYeniSistem();
        return;
      }
      
      // Fallback: Eski sistem
      const hastaListesiDiv = document.getElementById('hastaListesi');
      if (!hastaListesiDiv) {
        console.warn('⚠️ hastaListesi elementi bulunamadı');
        return;
      }
      
      // GitHub'dan gelen hasta listesini kullan
      const aktifHastalar = window.hastalar || [];
      console.log(`✅ Hasta listesi güncellendi: ${aktifHastalar.length} hasta`);
      
      // Bu fonksiyon artık renderHastalarYeniSistem'e yönlendiriyor
      // Detaylar o fonksiyonda işleniyor
    }

    // Global erişim için
    window.updateHastaListesi = updateHastaListesi;

    // Hasta seçildiğinde çağrılan fonksiyon
    async function hastaSecildi(index) {
      seciliHasta = hastalar[index];
      console.log('👤 Hasta seçildi:', seciliHasta.isim);
      
      // UI'ı güncelle
      updateHastaListesi(); // Seçimi güncelle
      if (typeof renderHastalarYeniSistem === 'function') {
        await renderHastalarYeniSistem(); // Ana içeriği güncelle
      }
    }

    // Global erişim için
    window.hastaSecildi = hastaSecildi;

    //  ️ TOPLU ZIP FONKSİYONU
    async function topluZipIndir() {
      try {
        console.log('🚀 Toplu ZIP indirme başlatıldı');
        
        // GitHub token kontrolü
        const tokenElement = document.getElementById('githubToken');
        const repoElement = document.getElementById('githubRepo');
        
        const GITHUB_TOKEN = tokenElement ? tokenElement.value.trim() : '';
        const GITHUB_REPO = repoElement ? repoElement.value.trim() || 'mustafasacar35/lipodem-takip-paneli' : 'mustafasacar35/lipodem-takip-paneli';
        
        if (!GITHUB_TOKEN) {
          alert('GitHub token ayarlanmamış. Lütfen önce GitHub token\'ınızı girin.');
          return;
        }
        
        // Hasta listesini al (GitHub'dan direkt yükle)
        console.log('📋 Hasta listesi yükleniyor...');
        const tumHastalar = await hastaListesiYukle();
        
        if (!tumHastalar || tumHastalar.length === 0) {
          alert('Hasta listesi yüklenmemiş! Lütfen GitHub token\'ınızı kontrol edin.');
          return;
        }
        
        const aktifHastalar = tumHastalar.filter(hasta => !hasta.arsiv);
        
        if (aktifHastalar.length === 0) {
          alert('Aktif hasta bulunamadı!');
          return;
        }
        
        console.log(`📊 ${aktifHastalar.length} aktif hasta bulundu`);
        
        // Ana ZIP dosyasını oluştur
        const anaZip = new JSZip();
        const bugununTarihi = new Date().toISOString().slice(0,10);
        const anaZipAdi = `TOPLU_HASTA_ZIP_${bugununTarihi}.zip`;
        
        // Progress gösterimi
        const progressDiv = document.createElement('div');
        progressDiv.style.cssText = `
          position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
          background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);
          z-index: 10000; min-width: 400px; text-align: center;
        `;
        progressDiv.innerHTML = `
          <h3>🗜️ Toplu ZIP Hazırlanıyor...</h3>
          <div id="progressBar" style="width: 100%; height: 20px; background: #f0f0f0; border-radius: 10px; overflow: hidden; margin: 10px 0;">
            <div id="progressFill" style="width: 0%; height: 100%; background: linear-gradient(45deg, #667eea, #764ba2); transition: width 0.3s;"></div>
          </div>
          <div id="progressText">0 / ${aktifHastalar.length}</div>
          <div id="currentHasta" style="margin-top: 10px; font-weight: bold; color: #666;"></div>
        `;
        document.body.appendChild(progressDiv);
        
        let basariliHastalar = 0;
        let hataliHastalar = 0;
        
        // Her hasta için işlem yap
        for (let i = 0; i < aktifHastalar.length; i++) {
          const hasta = aktifHastalar[i];
          
          // Progress güncelle
          const progress = ((i + 1) / aktifHastalar.length) * 100;
          document.getElementById('progressFill').style.width = progress + '%';
          document.getElementById('progressText').textContent = `${i + 1} / ${aktifHastalar.length}`;
          document.getElementById('currentHasta').textContent = `İşleniyor: ${hasta.isim}`;
          
          try {
            console.log(`👤 ${hasta.isim} işleniyor...`);
            
            // Hasta verilerini al
            const hastaData = await getHastaData(hasta.id, GITHUB_REPO, GITHUB_TOKEN, hasta.isim);
            if (!hastaData || !hastaData.haftalar) {
              console.warn(`⚠️ ${hasta.isim} için veri bulunamadı`);
              hataliHastalar++;
              continue;
            }
            
            // En büyük hafta numarasını bul
            const haftalar = hastaData.haftalar || [];
            let enBuyukHafta = null;
            let enBuyukHaftaNo = 0;
            
            haftalar.forEach(hafta => {
              const haftaNo = hafta.haftaNo || 0;
              if (haftaNo > enBuyukHaftaNo) {
                enBuyukHaftaNo = haftaNo;
                enBuyukHafta = hafta;
              }
            });
            
            if (!enBuyukHafta) {
              console.warn(`⚠️ ${hasta.isim} için hafta verisi bulunamadı`);
              hataliHastalar++;
              continue;
            }
            
            console.log(`📅 ${hasta.isim} - En büyük hafta: ${enBuyukHaftaNo}`);
            
            // Hasta klasörü oluştur - menü PDF adını kullan
            let hastaKlasorAdi = hasta.isim.toUpperCase().replace(/\s/g, '_').replace(/[İıÇçĞğÜüŞşÖö]/g, match => {
              const trMap = {'İ': 'I', 'ı': 'i', 'Ç': 'C', 'ç': 'c', 'Ğ': 'G', 'ğ': 'g', 'Ü': 'U', 'ü': 'u', 'Ş': 'S', 'ş': 's', 'Ö': 'O', 'ö': 'o'};
              return trMap[match] || match;
            });
            
            // Sadece en büyük hafta için menü PDF'sini ekle
            if (enBuyukHafta.githubUrl || enBuyukHafta.indirmeUrl || (enBuyukHafta.pdf && (enBuyukHafta.pdfName || enBuyukHafta.pdfOrijinalIsim))) {
              try {
                let pdfFileName = enBuyukHafta.pdfName || enBuyukHafta.pdfOrijinalIsim;
                
                // Klasör adını menü PDF adıyla değiştir (MENU_ prefix'i olmadan)
                if (pdfFileName) {
                  hastaKlasorAdi = pdfFileName.replace('.pdf', '');
                }
                
                console.log(`📄 ${hasta.isim} - En büyük hafta (${enBuyukHaftaNo}) menü PDF'i indiriliyor`);
                
                // Raw GitHub URL'sini kullan
                let pdfUrl;
                if (enBuyukHafta.githubUrl) {
                  // githubUrl varsa raw formatına çevir
                  pdfUrl = enBuyukHafta.githubUrl
                    .replace('github.com', 'raw.githubusercontent.com')
                    .replace('/blob/', '/');
                  // PDF dosya adını URL'den çıkar
                  if (!pdfFileName) {
                    pdfFileName = decodeURIComponent(pdfUrl.split('/').pop());
                  }
                } else if (enBuyukHafta.indirmeUrl) {
                  // indirmeUrl varsa raw formatına çevir
                  pdfUrl = enBuyukHafta.indirmeUrl
                    .replace('github.com', 'raw.githubusercontent.com')
                    .replace('/blob/', '/');
                  // PDF dosya adını URL'den çıkar
                  if (!pdfFileName) {
                    pdfFileName = decodeURIComponent(pdfUrl.split('/').pop());
                  }
                } else {
                  // Standart raw format ile dene
                  const encodedFileName = encodeURIComponent(pdfFileName);
                  pdfUrl = `https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli/main/pdfs/${encodedFileName}`;
                }
                
                console.log(`  PDF URL: ${pdfUrl}`);
                
                const pdfResponse = await fetch(pdfUrl);
                
                if (pdfResponse.ok) {
                  const pdfBlob = await pdfResponse.blob();
                  anaZip.file(`${hastaKlasorAdi}/MENU_PDF_${pdfFileName}`, pdfBlob);
                  console.log(`✅ ${hasta.isim} - Menü PDF eklendi: ${pdfFileName}`);
                } else {
                  console.warn(`❌ ${hasta.isim} - Menü PDF indirilemedi (${pdfResponse.status}): ${pdfUrl}`);
                }
              } catch (error) {
                console.warn(`❌ ${hasta.isim} - Menü PDF eklenemedi:`, error);
              }
            } else {
              console.log(`ℹ️ ${hasta.isim} - En büyük hafta için PDF verisi yok (githubUrl: ${!!enBuyukHafta.githubUrl}, indirmeUrl: ${!!enBuyukHafta.indirmeUrl}, pdf: ${!!enBuyukHafta.pdf}, pdfName: ${!!enBuyukHafta.pdfName})`);
            }
            
            // Tarif kartlarını ekle
            if (enBuyukHafta.tarifKartlar && enBuyukHafta.tarifKartlar.length > 0) {
              console.log(`🔍 ${hasta.isim} - Tarif kartları:`, enBuyukHafta.tarifKartlar);
              for (const kart of enBuyukHafta.tarifKartlar) {
                try {
                  console.log(`🔍 ${hasta.isim} - Kart objesi:`, kart);
                  // Doğru özellik adını kullan: kartData
                  const kartUrl = kart.kartData || kart.data;
                  if (!kartUrl) {
                    console.warn(`⚠️ ${hasta.isim} - Kart URL'si bulunamadı:`, kart);
                    continue;
                  }
                  const response = await fetch(kartUrl);
                  if (response.ok) {
                    const blob = await response.blob();
                    const fileName = kartUrl.split('/').pop() || `tarif_${kart.tarifAdi || 'kart'}.jpg`;
                    anaZip.file(`${hastaKlasorAdi}/${fileName}`, blob);
                    console.log(`✅ ${hasta.isim} - Tarif kartı eklendi:`, fileName);
                  }
                } catch (error) {
                  console.warn(`❌ ${hasta.isim} - Tarif kartı eklenemedi:`, kart.tarifAdi || 'bilinmeyen', error);
                }
              }
            }
            
            // Manuel kartları ekle
            if (enBuyukHafta.manuelKartlar && enBuyukHafta.manuelKartlar.length > 0) {
              console.log(`🔍 ${hasta.isim} - Manuel kartlar:`, enBuyukHafta.manuelKartlar);
              for (const kart of enBuyukHafta.manuelKartlar) {
                try {
                  // Doğru özellik adını kullan: kartData
                  const kartUrl = kart.kartData || kart.data;
                  if (!kartUrl) {
                    console.warn(`⚠️ ${hasta.isim} - Manuel kart URL'si bulunamadı:`, kart);
                    continue;
                  }
                  const response = await fetch(kartUrl);
                  if (response.ok) {
                    const blob = await response.blob();
                    const fileName = kartUrl.split('/').pop() || `manuel_${kart.tarifAdi || 'kart'}.jpg`;
                    anaZip.file(`${hastaKlasorAdi}/${fileName}`, blob);
                    console.log(`✅ ${hasta.isim} - Manuel kart eklendi:`, fileName);
                  }
                } catch (error) {
                  console.warn(`❌ ${hasta.isim} - Manuel kart eklenemedi:`, kart.tarifAdi || 'bilinmeyen', error);
                }
              }
            }
            
            // Çoklu PDF kartlarını ekle
            if (enBuyukHafta.cokluPdfVerileri && enBuyukHafta.cokluPdfVerileri.length > 0) {
              console.log(`🔍 ${hasta.isim} - Çoklu PDF verileri:`, enBuyukHafta.cokluPdfVerileri);
              for (const veri of enBuyukHafta.cokluPdfVerileri) {
                if (veri.tarifKartlar && veri.tarifKartlar.length > 0) {
                  for (const kart of veri.tarifKartlar) {
                    try {
                      // Doğru özellik adını kullan: kartData
                      const kartUrl = kart.kartData || kart.data;
                      if (!kartUrl) {
                        console.warn(`⚠️ ${hasta.isim} - Çoklu PDF kart URL'si bulunamadı:`, kart);
                        continue;
                      }
                      const response = await fetch(kartUrl);
                      if (response.ok) {
                        const blob = await response.blob();
                        const fileName = kartUrl.split('/').pop() || `coklu_${kart.tarifAdi || 'kart'}.jpg`;
                        anaZip.file(`${hastaKlasorAdi}/${fileName}`, blob);
                        console.log(`✅ ${hasta.isim} - Çoklu PDF kartı eklendi:`, fileName);
                      }
                    } catch (error) {
                      console.warn(`❌ ${hasta.isim} - Çoklu PDF kartı eklenemedi:`, kart.tarifAdi || 'bilinmeyen', error);
                    }
                  }
                }
              }
            }
            
            // GPT mesajını ekle
            if (enBuyukHafta.gptMesaj && enBuyukHafta.gptMesaj.trim()) {
              anaZip.file(`${hastaKlasorAdi}/GPT_MESAJI.txt`, enBuyukHafta.gptMesaj.trim());
            }
            
            // Lenf masajı planını ekle (5. hafta için)
            if (enBuyukHaftaNo === 5) {
              try {
                await createAndAddLenfMasajPDF(anaZip, hastaData, haftalar, `${hastaKlasorAdi}/`);
              } catch (error) {
                console.warn(`❌ ${hasta.isim} - Lenf masajı planı eklenemedi:`, error);
              }
            }
            
            // Egzersiz planını ekle (9. hafta için)
            if (enBuyukHaftaNo === 9) {
              try {
                await createAndAddEgzersizPDF(anaZip, hastaData, haftalar, `${hastaKlasorAdi}/`);
              } catch (error) {
                console.warn(`❌ ${hasta.isim} - Egzersiz planı eklenemedi:`, error);
              }
            }
            
            basariliHastalar++;
            console.log(`✅ ${hasta.isim} başarıyla işlendi`);
            
          } catch (error) {
            console.error(`❌ ${hasta.isim} işlenirken hata:`, error);
            hataliHastalar++;
          }
          
          // Küçük delay (performans için)
          await new Promise(resolve => setTimeout(resolve, 100));
        }
        
        // Progress'i kapat
        document.body.removeChild(progressDiv);
        
        if (basariliHastalar === 0) {
          alert('Hiçbir hasta başarıyla işlenemedi!');
          return;
        }
        
        // ZIP dosyasını oluştur ve indir
        console.log('🗜️ ZIP dosyası oluşturuluyor...');
        const zipBlob = await anaZip.generateAsync({type: 'blob'});
        
        // İndirme işlemi
        const link = document.createElement('a');
        link.href = URL.createObjectURL(zipBlob);
        link.download = anaZipAdi;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        // Başarı mesajı
        alert(`🎉 Toplu ZIP başarıyla oluşturuldu!\n\n` +
              `✅ Başarılı: ${basariliHastalar} hasta\n` +
              `❌ Hatalı: ${hataliHastalar} hasta\n\n` +
              `Dosya adı: ${anaZipAdi}`);
        
        console.log('🎉 Toplu ZIP işlemi tamamlandı!');
        
      } catch (error) {
        console.error('❌ Toplu ZIP hatası:', error);
        alert('Toplu ZIP oluşturulurken hata oluştu: ' + error.message);
      }
    }
    
    // Global erişim için
    window.topluZipIndir = topluZipIndir;

    //  📁 ANA ÇOKLU PDF FONKSİYONU
    async function processCokluPdf(files) {
      if (!files || files.length === 0) {
        alert('Lütfen en az bir PDF dosyası seçin.');
        return;
      }

      console.log('📁 Çoklu PDF işlemi başlatıldı:', files.length, 'dosya');
      
      const sonuclar = [];
      let basarili = 0;
      let hatali = 0;

      // Progress gösterimi
      const progressDiv = document.createElement('div');
      progressDiv.style.cssText = `
        position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
        background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        z-index: 10000; min-width: 300px; text-align: center;
      `;
      progressDiv.innerHTML = `
        <h3>📁 PDF'ler İşleniyor...</h3>
        <div id="progressBar" style="width: 100%; height: 20px; background: #f0f0f0; border-radius: 10px; overflow: hidden; margin: 10px 0;">
          <div id="progressFill" style="width: 0%; height: 100%; background: linear-gradient(45deg, #667eea, #764ba2); transition: width 0.3s;"></div>
        </div>
        <div id="progressText">0 / ${files.length}</div>
      `;
      document.body.appendChild(progressDiv);

      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        const progress = ((i + 1) / files.length) * 100;
        
        // Progress güncelle
        document.getElementById('progressFill').style.width = progress + '%';
        document.getElementById('progressText').textContent = `${i + 1} / ${files.length}`;
        
        try {
          console.log(`🔍 ${i + 1}/${files.length} - "${file.name}" analiz ediliyor...`);
          
          // Dosya adını parse et
          const parsed = parseProfessionalPdfName(file.name);
          
          if (!parsed) {
            console.warn('⚠️ Dosya adı format hatası:', file.name);
            sonuclar.push({ dosya: file.name, durum: 'HATA', mesaj: 'Dosya adı formatı tanınmadı' });
            hatali++;
            continue;
          }

          // Hasta oluştur/bul
          const hasta = findOrCreateHasta(parsed.hastaAdi);
          
          // Hafta oluştur/bul
          const hafta = findOrCreateHafta(hasta, parsed.haftaNo, parsed.tarihAraligi);
          
          // PDF'i Base64'e çevir ve sakla
          const pdfBase64 = await fileToBase64(file);
          hafta.pdf = pdfBase64;
          hafta.pdfName = file.name;
          hafta.pdfOrijinalIsim = file.name;
          hafta.pdfYolu = `pdfs/${file.name}`;
          hafta.kayitTarihi = new Date().toISOString();
          hafta.pdfFile = {
            name: file.name,
            size: file.size,
            type: file.type
          };
          
          // PDF'i analiz et ve tarifleri çıkar
          let pdfText = '';
          let tarifler = [];
          let eslesenKartlar = [];
          let recipeCount = 0;
          let matchCount = 0;
          
          try {
            // PDF içeriğini çıkar
            const loadingTask = pdfjsLib.getDocument({data: atob(pdfBase64)});
            const pdf = await loadingTask.promise;
            
            for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
              const page = await pdf.getPage(pageNum);
              const textContent = await page.getTextContent();
              const pageText = textContent.items.map(item => item.str).join(' ');
              pdfText += pageText + ' ';
            }
            
            // Tarifleri analiz et
            if (typeof window.tarifKartlari !== 'undefined' && Array.isArray(window.tarifKartlari)) {
              window.tarifKartlari.forEach(kart => {
                const tarifAdi = kart.querySelector('.card-title')?.textContent?.trim();
                if (tarifAdi && pdfText.toLowerCase().includes(tarifAdi.toLowerCase())) {
                  tarifler.push(tarifAdi);
                  eslesenKartlar.push({
                    id: kart.id,
                    name: tarifAdi,
                    kategori: kart.dataset.kategori || 'Genel',
                    type: 'auto',
                    eklenmeTarihi: new Date().toISOString()
                  });
                  matchCount++;
                }
              });
            }
            
            // Toplam tarif sayısını tahmin et
            const tarifMatches = pdfText.match(/tarif|yemek|öğün/gi);
            recipeCount = tarifMatches ? tarifMatches.length : 0;
            
          } catch (pdfError) {
            console.warn('PDF içerik çıkarma hatası:', pdfError);
          }
          
          // Hafta verilerini güncelle
          hafta.tarifler = tarifler;
          hafta.tarifKartlar = eslesenKartlar;
          hafta.pdfText = pdfText.substring(0, 2000); // İlk 2000 karakter
          hafta.gptMesaj = `PDF analizi: ${recipeCount} tarif tespit edildi, ${matchCount} eşleşme bulundu.`;
          
          sonuclar.push({ 
            dosya: file.name, 
            durum: 'BAŞARILI', 
            hasta: parsed.hastaAdi,
            hafta: parsed.haftaNo,
            tarifSayisi: recipeCount,
            eslesmeSayisi: matchCount
          });
          basarili++;
          
          console.log(`✅ ${file.name} başarıyla işlendi - ${recipeCount} tarif, ${matchCount} eşleşme`);
          
        } catch (error) {
          console.error('❌ PDF işleme hatası:', file.name, error);
          sonuclar.push({ dosya: file.name, durum: 'HATA', mesaj: error.message });
          hatali++;
        }
        
        // Küçük bir delay (UI donmaması için)
        await new Promise(resolve => setTimeout(resolve, 100));
      }

      // Progress dialog'u kapat
      document.body.removeChild(progressDiv);
      
      // Sonuçları kaydet
      localStorage.setItem('lipedem_hasta_kayitlari', JSON.stringify(hastalar));
      
      // Otomatik kaydetme - hasta verileri değişti
      if (seciliHasta) {
        autoSaveHastaData(seciliHasta);
      }
      
      // UI'ı güncelle ve sidebar'ı yenile
      if (typeof renderHastalarYeniSistem === 'function') {
        await renderHastalarYeniSistem();
      }
      updateHastaListesi(); // Sidebar'daki hasta listesini güncelle
      
      // Sonuç raporu göster
      showCokluPdfSonuclari(sonuclar, basarili, hatali);
      
      console.log('🎉 Çoklu PDF işlemi tamamlandı! Başarılı:', basarili, 'Hatalı:', hatali);
    }
    
    // === EMNİYET KİLİDİ FONKSİYONLARI ===
    
    // Hafta kaydet ve kilitle
    async function haftaKaydet(haftaIndex) {
      if (!seciliHasta || !seciliHasta.haftalar[haftaIndex]) {
        showToast('❌ Geçersiz hafta!', 'error');
        return;
      }
      
      const hafta = seciliHasta.haftalar[haftaIndex];
      const haftaNo = hafta.haftaNo || (haftaIndex + 1);
      
      try {
        // ÖNEMLİ: GPT mesajını kaydet (eğer textarea'da yazılı metin varsa ve henüz kaydedilmemişse)
        const gptTextarea = document.getElementById('gptMesaj_' + haftaIndex);
        if (gptTextarea && gptTextarea.value !== (hafta.gptMesaj || '')) {
          console.log('📝 GPT mesajı hafta kilitleme sırasında otomatik kaydediliyor...');
          hafta.gptMesaj = gptTextarea.value;
        }
        
        // Hafta verilerini kilitle
        hafta.kilitli = true;
        hafta.kayitTarihi = new Date().toISOString();
        
        // localStorage'a kaydet
        saveToStorage();
        
        // GitHub'a kaydet
        const kaydedildi = await hastayiAyriKaydet(seciliHasta);
        
        if (kaydedildi) {
          console.log(`✅ ${haftaNo}. hafta başarıyla kaydedildi ve kilitlendi`);
          
          // UI'ı güncelle
          gosterHaftalar();
          
          // Başarı mesajı
          showToast(`🔒 ${haftaNo}. hafta kilitlendi!`);
          
        } else {
          // GitHub kaydetme başarısız
          hafta.kilitli = false; // Kilidi geri aç
          hafta.kayitTarihi = null;
          saveToStorage();
          
          showToast('❌ GitHub\'a kaydetme başarısız!', 'error');
        }
        
      } catch (error) {
        console.error('❌ Hafta kaydetme hatası:', error);
        
        // Hata durumunda kilidi geri aç
        hafta.kilitli = false;
        hafta.kayitTarihi = null;
        saveToStorage();
        
        showToast(`❌ Hafta kaydetme hatası: ${error.message}`, 'error');
      }
    }
    
    // Hafta kilidini aç
    async function haftaKilidiAc(haftaIndex) {
      if (!seciliHasta || !seciliHasta.haftalar[haftaIndex]) {
        showToast('❌ Geçersiz hafta!', 'error');
        return;
      }
      
      const hafta = seciliHasta.haftalar[haftaIndex];
      const haftaNo = hafta.haftaNo || (haftaIndex + 1);
      
      try {
        // Hafta kilidini aç
        hafta.kilitli = false;
        
        // localStorage'a kaydet
        saveToStorage();
        
        // GitHub'a kaydet
        const kaydedildi = await hastayiAyriKaydet(seciliHasta);
        
        if (kaydedildi) {
          console.log(`🔓 ${haftaNo}. hafta kilidi açıldı`);
          
          // UI'ı güncelle
          gosterHaftalar();
          
          // Başarı mesajı
          showToast(`🔓 ${haftaNo}. hafta kilidi açıldı!`);
          
        } else {
          // GitHub kaydetme başarısız
          hafta.kilitli = true; // Kilidi geri koy
          saveToStorage();
          
          showToast('❌ GitHub\'a kaydetme başarısız!', 'error');
        }
        
      } catch (error) {
        console.error('❌ Kilit açma hatası:', error);
        
        // Hata durumunda kilidi geri koy
        hafta.kilitli = true;
        saveToStorage();
        
        showToast(`❌ Kilit açma hatası!`, 'error');
      }
    }
    
    // Global fonksiyonlar
    window.haftaKaydet = haftaKaydet;
    window.haftaKilidiAc = haftaKilidiAc;

        sayfaBaslat();
        initResizableSidebars();
      });
    } else {
      sayfaBaslat();
      initResizableSidebars();
    }
    
    // Global fonksiyon yap
    window.processCokluPdf = processCokluPdf;

    // ===== EMNİYET KİLİDİ SİSTEMİ FONKSIYONLARI =====
    
    // Hafta kaydet ve kilitle
    async function haftaKaydet(i) {
      if (!seciliHasta) {
        showToast('❌ Lütfen önce bir hasta seçin!', 'error');
        return;
      }
      
      const haftalar = getHaftaListesi();
      const hafta = haftalar[i];
      
      if (hafta.kilitli) {
        showToast('⚠️ Bu hafta zaten kilitli!', 'warning');
        return;
      }
      
      try {
        // 0. ÖNEMLİ: GPT mesajını kaydet (eğer textarea'da yazılı metin varsa ve henüz kaydedilmemişse)
        const gptTextarea = document.getElementById('gptMesaj_' + i);
        if (gptTextarea && gptTextarea.value !== (hafta.gptMesaj || '')) {
          console.log('📝 GPT mesajı hafta kilitleme sırasında otomatik kaydediliyor...');
          hafta.gptMesaj = gptTextarea.value;
        }
        
        // 1. Hafta verilerini güncelle
        hafta.kilitli = true;
        hafta.kilitlenmeTarihi = new Date().toISOString();
        
        // 2. LocalStorage'a kaydet
        saveToStorage();
        
        // 3. GitHub'a kaydet
        const githubBasarili = await hastayiAyriKaydet(seciliHasta);
        
        if (githubBasarili) {
          console.log(`✅ ${hafta.haftaNo}. hafta kaydedildi ve kilitlendi`);
          showToast(`🔒 ${hafta.haftaNo}. hafta kilitlendi!`);
        } else {
          console.warn(`⚠️ ${hafta.haftaNo}. hafta kilitlendi ama GitHub kaydı başarısız`);
          showToast(`🔒 ${hafta.haftaNo}. hafta kilitlendi (GitHub kayıt hatası)`, 'warning');
        }
        
        // 4. UI'ı güncelle
        gosterHaftalar();
        
        // 5. Aktif tab'ı koru
        setTimeout(() => switchTab(i), 100);
        
      } catch (error) {
        console.error('❌ Hafta kaydetme ve kilitleme hatası:', error);
        showToast(`❌ Hafta kaydetme başarısız!`, 'error');
      }
    }
    
    // Hafta kilidini aç
    async function haftaKilidiAc(i) {
      if (!seciliHasta) {
        showToast('❌ Lütfen önce bir hasta seçin!', 'error');
        return;
      }
      
      const haftalar = getHaftaListesi();
      const hafta = haftalar[i];
      
      if (!hafta.kilitli) {
        showToast('⚠️ Bu hafta zaten kilitli değil!', 'warning');
        return;
      }
      
      try {
        // 1. Hafta verilerini güncelle
        hafta.kilitli = false;
        hafta.kilitAcmaTarihi = new Date().toISOString();
        
        // 2. LocalStorage'a kaydet
        saveToStorage();
        
        // 3. GitHub'a kaydet
        const githubBasarili = await hastayiAyriKaydet(seciliHasta);
        
        if (githubBasarili) {
          console.log(`🔓 ${hafta.haftaNo}. hafta kilidi açıldı`);
          showToast(`🔓 ${hafta.haftaNo}. hafta kilidi açıldı!`);
        } else {
          console.warn(`⚠️ ${hafta.haftaNo}. hafta kilidi açıldı ama GitHub kaydı başarısız`);
          showToast(`🔓 ${hafta.haftaNo}. hafta kilidi açıldı (GitHub kayıt hatası)`, 'warning');
        }
        
        // 4. UI'ı güncelle
        gosterHaftalar();
        
        // 5. Aktif tab'ı koru
        setTimeout(() => switchTab(i), 100);
        
      } catch (error) {
        console.error('❌ Hafta kilit açma hatası:', error);
        showToast(`❌ Kilit açma başarısız!`, 'error');
      }
    }
    
    // Global fonksiyonlar
    window.haftaKaydet = haftaKaydet;
    window.haftaKilidiAc = haftaKilidiAc;

    // PDF ÖNIZLEME FONKSİYONLARI
    function pdfOnizlemeAc() {
      console.log('📄 PDF önizleme açılıyor...');
      
      let hasta, hafta, aktifHaftaIndex;
      
      if (!seciliHasta) {
        // Test verisi oluştur
        console.log('⚠️ Hasta seçili değil, test verisi oluşturuluyor...');
        hasta = {
          isim: 'ÖRNEK HASTA',
          id: 'test-123'
        };
        aktifHaftaIndex = 0;
        hafta = {
          tarihAraligi: '1-7 EYLÜL',
          tarifler: [
            'Haşlanmış Yumurta (1 adet) + 1 Tatlı Kaşığı Tereyağı',
            'Beyaz Peynir (30 gr) + Domates ve Salatalık',
            'Izgara Tavuk Göğsü (100 gr)',
            'Yeşil Salata + Zeytinyağı',
            'Mercimek Çorbası (1 kase)',
            'Bulgur Pilavı (2 yemek kaşığı)',
            'Yoğurt (1 su bardağı)',
            'Elma (1 adet)',
            'Fındık (10 adet)',
            'Çilek (5-6 adet)',
            'Kırmızı Et (80 gr)',
            'Şehriye Çorbası',
            'Marul + Havuç Salatası',
            'Tam Buğday Ekmeği (1 dilim)'
          ]
        };
      } else {
        aktifHaftaIndex = getAktifHaftaIndex();
        const haftaListesi = getHaftaListesi();
        hafta = haftaListesi[aktifHaftaIndex];
        hasta = seciliHasta;
        
        if (!hafta) {
          alert('Bu hafta için veri bulunamadı!');
          return;
        }
      }
      
      // PDF içeriği oluştur (geçici olarak makro verisi olmadan)
      const pdfContent = createPdfContent(hasta, hafta, aktifHaftaIndex);
      
      // Modal'ı aç
      const modal = document.getElementById('pdfOnizlemeModal');
      const content = document.getElementById('pdfOnizlemeContent');
      const baslik = document.getElementById('pdfModalBaslik');
      const hastaInfo = document.getElementById('pdfHastaInfo');
      
      baslik.textContent = `${hasta.isim.toUpperCase()} - ${aktifHaftaIndex + 1}. Hafta Diyet Listesi`;
      hastaInfo.textContent = `${hasta.isim.toUpperCase()} • ${hafta.tarihAraligi || 'Tarih bilgisi yok'} • ${aktifHaftaIndex + 1}. Hafta`;
      content.innerHTML = pdfContent;
      
      modal.style.display = 'block';
    }
    
    // PDF için makro verilerini hazırla
    async function prepareMacroDataForPdf(tarifler) {
      try {
        // Eğer food data yoksa GitHub'dan al
        if (!window.foodData || window.foodData.length === 0) {
          console.log('Food data yükleniyor...');
          await loadFoodData();
        }
        
        if (!window.foodData || window.foodData.length === 0) {
          console.log('Food data yüklenemedi, PDF basit görünümde oluşturulacak');
          window.currentFoodAnalysisData = [];
          return;
        }
        
        // Tarifleri analiz et
        const analysisData = [];
        tarifler.forEach((tarif, index) => {
          const normalizedTarif = tarif.toLowerCase()
            .replace(/ı/g, 'i')
            .replace(/ğ/g, 'g')
            .replace(/ü/g, 'u')
            .replace(/ş/g, 's')
            .replace(/ö/g, 'o')
            .replace(/ç/g, 'c');
          
          // Yemek veritabanında ara
          const eslesenYemek = window.foodData.find(food => {
            const normalizedFoodName = food.name.toLowerCase()
              .replace(/ı/g, 'i')
              .replace(/ğ/g, 'g')
              .replace(/ü/g, 'u')
              .replace(/ş/g, 's')
              .replace(/ö/g, 'o')
              .replace(/ç/g, 'c');
            
            return normalizedFoodName.includes(normalizedTarif) || 
                   normalizedTarif.includes(normalizedFoodName);
          });
          
          analysisData.push({
            index: index,
            tarif: tarif,
            eslestiMi: !!eslesenYemek,
            eslesenYemek: eslesenYemek || null
          });
        });
        
        // Global değişkene kaydet
        window.currentFoodAnalysisData = analysisData;
        
      } catch (error) {
        console.error('Makro verisi hazırlama hatası:', error);
        window.currentFoodAnalysisData = [];
      }
    }
    
    function createPdfContent(hasta, hafta, haftaIndex) {
      const tarihBilgisi = hafta.tarihAraligi || `${haftaIndex + 1}. HAFTA`;
      
      let html = `
        <!-- PDF Header -->
        <div style="text-align: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px solid #333;">
          <h1 style="margin: 0; font-size: 24px; font-weight: bold; color: #333;">BESLENME UZMANLIGI</h1>
          <h2 style="margin: 10px 0; font-size: 20px; color: #666;">${hasta.isim.toUpperCase()}</h2>
          <h3 style="margin: 10px 0; font-size: 16px; color: #888;">${tarihBilgisi} ${haftaIndex + 1}. HAFTA</h3>
        </div>
      `;
      
      if (!hafta.tarifler || hafta.tarifler.length === 0) {
        html += `
          <div style="text-align: center; padding: 40px; color: #666; font-style: italic;">
            Bu hafta için henüz yemek verisi bulunmuyor.
          </div>
        `;
        return html;
      }
      
      // Yemek veritabanından makro bilgileri al
      let allFoodNames = [];
      try {
        // Bu fonksiyon sadece PDF içinde kullanılacak basit makro hesaplaması yapar
        // Gerçek veritabanı analizi için updateYemekVeritabaniAnalizi kullanılmalı
        allFoodNames = window.currentFoodAnalysisData || [];
      } catch (error) {
        console.log('Makro verileri alınamadı, basit görünüm kullanılacak');
      }
      
      // Günleri oluştur
      const gunler = ['PAZARTESİ', 'SALI', 'ÇARŞAMBA', 'PERŞEMBE', 'CUMA', 'CUMARTESİ', 'PAZAR'];
      const ogunler = [
        { ad: 'SABAH', saat: '(saat 07:00 civarında)', ikon: '🌅' },
        { ad: 'ÖĞLE', saat: '(saat 12:00 civarında)', ikon: '☀️' },
        { ad: 'AKŞAM', saat: '(hava kararınca)', ikon: '🌙' }
      ];
      
      // Haftalık toplam makrolar
      let haftalikToplamKalori = 0;
      let haftalikToplamProtein = 0;
      let haftalikToplamKarb = 0;
      let haftalikToplamYag = 0;
      
      // Tarifleri günlere dağıt (basit dağıtım)
      const gunBasiTarif = Math.ceil(hafta.tarifler.length / 7);
      
      gunler.forEach((gun, gunIndex) => {
        // Günlük makro toplamları
        let gunlukKalori = 0;
        let gunlukProtein = 0;
        let gunlukKarb = 0;
        let gunlukYag = 0;

        // Gün içeriğini önce oluştur (öğünleri ve öğe listelerini toplayalım)
        let gunIcerikHtml = '';

        ogunler.forEach(ogun => {
          // Bu öğün için tarifleri ekle (basit dağıtım)
          const baslangicIndex = (gunIndex * gunBasiTarif + ogunler.indexOf(ogun)) % hafta.tarifler.length;
          const bitis = Math.min(baslangicIndex + 2, hafta.tarifler.length);

          // Öğün makro toplamları
          let ogunKalori = 0;
          let ogunProtein = 0;
          let ogunKarb = 0;
          let ogunYag = 0;

          let ogunItemsHtml = '';
          for (let i = baslangicIndex; i < bitis && i < hafta.tarifler.length; i++) {
            const tarif = hafta.tarifler[i];

            // Makro bilgilerini bul
            let kalori = 0, protein = 0, karb = 0, yag = 0;
            if (allFoodNames[i] && allFoodNames[i].eslestiMi) {
              const yemek = allFoodNames[i].eslesenYemek;
              kalori = yemek.calories || 0;
              protein = yemek.protein || 0;
              karb = yemek.carbs || 0;
              yag = yemek.fat || 0;
            }

            ogunKalori += kalori;
            ogunProtein += protein;
            ogunKarb += karb;
            ogunYag += yag;

            ogunItemsHtml += `
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; padding: 6px 10px; background: white; border-radius: 3px; border: 1px solid #dee2e6;">
                <span style="flex: 1; color: #333; font-weight: 500; text-align: left;">${tarif}</span>
                ${kalori > 0 ? `
                  <div style="display: flex; gap: 8px; font-size: 11px; color: #666; margin-left: 10px;">
                    <span style="background: #fff3cd; padding: 2px 6px; border-radius: 3px;">🔥 ${kalori}</span>
                    <span style="background: #d4edda; padding: 2px 6px; border-radius: 3px;">P: ${protein.toFixed(1)}g</span>
                    <span style="background: #cce7ff; padding: 2px 6px; border-radius: 3px;">K: ${karb.toFixed(1)}g</span>
                    <span style="background: #f8c2c2; padding: 2px 6px; border-radius: 3px;">Y: ${yag.toFixed(1)}g</span>
                  </div>
                ` : ''}
              </div>
            `;
          }

          // Öğün toplamlarını günlük toplama ekle
          gunlukKalori += ogunKalori;
          gunlukProtein += ogunProtein;
          gunlukKarb += ogunKarb;
          gunlukYag += ogunYag;

          // Öğün başlık satırı: sola yaslı metin + sağda makro toplamları
          gunIcerikHtml += `
            <div style="margin-bottom: 15px; margin-left: 20px;">
              <div style="display: flex; align-items: center; justify-content: space-between; border-bottom: 2px solid #dee2e6; padding: 6px 0;">
                <h4 style="margin: 0; font-size: 16px; font-weight: bold; color: #495057; text-transform: uppercase; text-align: left;">
                  ${ogun.ikon} <strong>${ogun.ad}</strong> ${ogun.saat}
                </h4>
                ${ogunKalori > 0 ? `
                  <div style="display: flex; gap: 8px; font-size: 12px; color: #333;">
                    <span style="background: #fff3cd; padding: 3px 8px; border-radius: 4px;">🔥 ${ogunKalori.toFixed(0)} kcal</span>
                    <span style="background: #d4edda; padding: 3px 8px; border-radius: 4px;">P: ${ogunProtein.toFixed(1)}g</span>
                    <span style="background: #cce7ff; padding: 3px 8px; border-radius: 4px;">K: ${ogunKarb.toFixed(1)}g</span>
                    <span style="background: #f8c2c2; padding: 3px 8px; border-radius: 4px;">Y: ${ogunYag.toFixed(1)}g</span>
                  </div>
                ` : ''}
              </div>
              <div style="background: #f8f9fa; padding: 10px; border-radius: 5px; border-left: 3px solid #28a745;">
                ${ogunItemsHtml}
              </div>
            </div>
          `;
        });

        // Gün kapsayıcı: başlık satırı (sola yaslı) + sağda günlük toplam makrolar
        html += `
          <div style="margin-bottom: 25px; page-break-inside: avoid;">
            <div style="display: flex; align-items: center; justify-content: space-between; background: linear-gradient(135deg, #007bff, #0056b3); color: white; padding: 12px 16px; margin: 0 0 15px 0; border-radius: 5px; font-size: 18px; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; box-shadow: 0 2px 4px rgba(0,123,255,0.3);">
              <h3 style="margin: 0; font-size: 18px; font-weight: bold; text-align: left;">${gun}</h3>
              ${gunlukKalori > 0 ? `
                <div style="display: flex; gap: 10px; font-size: 12px; color: #fff;">
                  <span style="background: rgba(255,255,255,0.15); padding: 4px 10px; border-radius: 4px;">🔥 ${gunlukKalori.toFixed(0)} kcal</span>
                  <span style="background: rgba(255,255,255,0.15); padding: 4px 10px; border-radius: 4px;">P: ${gunlukProtein.toFixed(1)}g</span>
                  <span style="background: rgba(255,255,255,0.15); padding: 4px 10px; border-radius: 4px;">K: ${gunlukKarb.toFixed(1)}g</span>
                  <span style="background: rgba(255,255,255,0.15); padding: 4px 10px; border-radius: 4px;">Y: ${gunlukYag.toFixed(1)}g</span>
                </div>
              ` : ''}
            </div>
            ${gunIcerikHtml}
          </div>
        `;

        // Haftalık toplama ekle
        haftalikToplamKalori += gunlukKalori;
        haftalikToplamProtein += gunlukProtein;
        haftalikToplamKarb += gunlukKarb;
        haftalikToplamYag += gunlukYag;
      });
      
      // Haftalık ortalama makrolar (yalnızca ortalamalar gösterilir)
      if (haftalikToplamKalori > 0) {
        const gunSayisi = 7;
        html += `
          <div style="margin-top: 30px; padding: 20px; background: linear-gradient(135deg, #6f42c1, #5a2d91); color: white; border-radius: 10px; text-align: center; box-shadow: 0 4px 8px rgba(111,66,193,0.4);">
            <h3 style="margin: 0 0 15px 0; font-size: 20px; font-weight: bold;">📈 GÜNLÜK ORTALAMA MAKROLAR</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 15px;">
              <div style="background: rgba(255,255,255,0.1); padding: 12px; border-radius: 8px;">
                <div style="font-size: 14px; margin-bottom: 5px;">🔥 Günlük Ortalama Kalori</div>
                <div style="font-size: 24px; font-weight: bold;">${(haftalikToplamKalori / gunSayisi).toFixed(0)}</div>
              </div>
              <div style="background: rgba(255,255,255,0.1); padding: 12px; border-radius: 8px;">
                <div style="font-size: 14px; margin-bottom: 5px;">🥩 Günlük Ortalama Protein</div>
                <div style="font-size: 24px; font-weight: bold;">${(haftalikToplamProtein / gunSayisi).toFixed(1)}g</div>
              </div>
              <div style="background: rgba(255,255,255,0.1); padding: 12px; border-radius: 8px;">
                <div style="font-size: 14px; margin-bottom: 5px;">🍞 Günlük Ortalama Karbonhidrat</div>
                <div style="font-size: 24px; font-weight: bold;">${(haftalikToplamKarb / gunSayisi).toFixed(1)}g</div>
              </div>
              <div style="background: rgba(255,255,255,0.1); padding: 12px; border-radius: 8px;">
                <div style="font-size: 14px; margin-bottom: 5px;">🥑 Günlük Ortalama Yağ</div>
                <div style="font-size: 24px; font-weight: bold;">${(haftalikToplamYag / gunSayisi).toFixed(1)}g</div>
              </div>
            </div>
          </div>
        `;
      }
      
      // Footer
      html += `
        <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd; text-align: center; color: #666; font-size: 12px;">
          <p>Bu diyet listesi ${hasta.isim} için özel olarak hazırlanmıştır.</p>
          <p>Oluşturulma Tarihi: ${new Date().toLocaleDateString('tr-TR')}</p>
        </div>
      `;
      
      return html;
    }
    
    function pdfModalKapat(event) {
      if (event && event.target !== event.currentTarget) return;
      
      const modal = document.getElementById('pdfOnizlemeModal');
      modal.style.display = 'none';
    }
    
    function pdfYazdir() {
      const content = document.getElementById('pdfOnizlemeContent').innerHTML;
      const printWindow = window.open('', '_blank');
      printWindow.document.write(`
        <html>
          <head>
            <title>Diyet Listesi</title>
            <style>
              body { font-family: 'Times New Roman', serif; line-height: 1.4; margin: 20px; }
              @page { margin: 2cm; }
              @media print { 
                body { margin: 0; }
                .no-print { display: none; }
              }
            </style>
          </head>
          <body>
            ${content}
          </body>
        </html>
      `);
      printWindow.document.close();
      printWindow.print();
    }
    
    function pdfIndir() {
      alert('PDF indirme özelliği yakında eklenecek!');
    }
    
    // Hasta seçildiğinde PDF butonunu göster/gizle
    function togglePdfButton() {
      const pdfBtn = document.getElementById('pdfOnizlemeBtn');
      if (seciliHasta) {
        pdfBtn.style.display = 'flex';
      } else {
        pdfBtn.style.display = 'none';
      }
    }
    
    //   OTOMATİK SENKRONIZASYON SİSTEMİ
    
    // Senkronizasyon durumu göstergesi güncelle
    function senkronizasyonDurumuGuncelle(durum, mesaj) {
      const gosterge = document.querySelector('[title*="Otomatik GitHub senkronizasyonu"]');
      if (gosterge) {
        switch (durum) {
          case 'syncing':
            gosterge.textContent = '🔄 Syncing...';
            gosterge.style.color = '#ffc107';
            break;
          case 'success':
            gosterge.textContent = '✅ Synced';
            gosterge.style.color = '#28a745';
            setTimeout(() => {
              gosterge.textContent = '🔄 Auto-Sync';
              gosterge.style.color = '#28a745';
            }, 3000);
            break;
          case 'error':
            gosterge.textContent = '❌ Error';
            gosterge.style.color = '#dc3545';
            setTimeout(() => {
              gosterge.textContent = '🔄 Auto-Sync';
              gosterge.style.color = '#28a745';
            }, 5000);
            break;
          case 'offline':
            gosterge.textContent = '📴 Offline';
            gosterge.style.color = '#6c757d';
            break;
        }
        if (mesaj) {
          gosterge.title = mesaj;
        }
      }
    }
    
    // GitHub token alma fonksiyonu
    function getGithubToken() {
      return document.getElementById('githubToken')?.value?.trim() || null;
    }
    
    // Otomatik GitHub senkronizasyonu
    async function otomatikGithubSenkronizasyon() {
      const token = getGithubToken();
      if (!token) {
        console.log('ℹ️ GitHub token yok, otomatik senkronizasyon devre dışı');
        senkronizasyonDurumuGuncelle('offline', 'GitHub token gerekli');
        return;
      }
      
      try {
        console.log('🔄 Otomatik GitHub senkronizasyonu başlıyor...');
        senkronizasyonDurumuGuncelle('syncing', 'Senkronizasyon devam ediyor...');
        
        // GitHub'dan son versiyonu kontrol et
        const githubResponse = await fetch('https://api.github.com/repos/mustafasacar35/lipodem-takip-paneli-4/contents/food_list.json', {
          headers: {
            'Authorization': `token ${token}`,
            'Accept': 'application/vnd.github.v3+json'
          }
        });
        
        if (!githubResponse.ok) {
          console.log('⚠️ GitHub dosyası kontrol edilemedi');
          senkronizasyonDurumuGuncelle('error', 'GitHub erişim hatası');
          return;
        }
        
        console.log('✅ GitHub ile bağlantı başarılı, sistem güncel');
        senkronizasyonDurumuGuncelle('success', 'GitHub ile senkronize');
        
      } catch (error) {
        console.error('❌ Otomatik senkronizasyon hatası:', error);
        senkronizasyonDurumuGuncelle('error', `Hata: ${error.message}`);
      }
    }
    
    // Otomatik GitHub bağlantı kontrolü
    async function otomatikGithubKontrol() {
      const token = getGithubToken();
      try {
        console.log('🔍 GitHub bağlantısı kontrol ediliyor...');
        senkronizasyonDurumuGuncelle('syncing', 'GitHub kontrolü...');
        
        const response = await fetch('https://api.github.com/repos/mustafasacar35/lipodem-takip-paneli-4/contents/food_list.json', {
          headers: {
            'Authorization': `token ${token}`,
            'Accept': 'application/vnd.github.v3+json'
          }
        });
        
        if (response.ok) {
          console.log('✅ GitHub bağlantısı başarılı');
          senkronizasyonDurumuGuncelle('success', 'GitHub erişimi aktif');
          
          // 🚨 DEBUG: GitHub'daki food_list.json'u kontrol et
          const githubData = await response.json();
          const githubContent = JSON.parse(atob(githubData.content));
          console.log('🕵️ GITHUB DEBUG - food_list.json SHA:', githubData.sha);
          console.log('🕵️ GITHUB DEBUG - İlk yemek örneği:', githubContent.categories?.[0]?.items?.[0]);
          
        } else {
          console.log('❌ GitHub bağlantı hatası');
          senkronizasyonDurumuGuncelle('error', 'GitHub erişim hatası');
        }
      } catch (error) {
        // Network errors ve GitHub API hatalarını daha iyi handle et
        if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
          console.error('❌ GitHub kontrolü ağ hatası - internet bağlantısını kontrol edin:', error.message);
          senkronizasyonDurumuGuncelle('error', 'İnternet bağlantı hatası');
        } else if (error.message && error.message.includes('ERR_NETWORK_CHANGED')) {
          console.error('❌ GitHub kontrolü ağ değişikliği hatası:', error.message);
          senkronizasyonDurumuGuncelle('error', 'Ağ bağlantısı değişti');
        } else {
          console.error('❌ GitHub kontrolü hatası:', error);
          senkronizasyonDurumuGuncelle('error', `GitHub hatası: ${error.message}`);
        }
      }
    }
    
    // Yemek kaydetme işleminden sonra otomatik senkronizasyon tetikleme
    function yemekKaydetSonrasiSenkronizasyon() {
      // 1 saniye sonra GitHub kontrolü başlat (modal kapanması için)
      setTimeout(() => {
        otomatikGithubKontrol();
      }, 1000);
    }
    
    // Periyodik senkronizasyon (her 5 dakikada bir kontrol)
    function periyodikSenkronizasyonBaslat() {
      setInterval(() => {
        otomatikGithubKontrol();
      }, 5 * 60 * 1000); // 5 dakika
    }
    
    //  🚀 LOKAL FOOD_LIST.JSON'U GITHUB'A YÜKLEME FONKSİYONU
    async function lokalFoodListGithubYukle() {
      console.log('🚀 Lokal food_list.json GitHub\'a yükleniyor...');
      
      const token = getGithubToken();
      if (!token) {
        alert('❌ GitHub token bulunamadı! Yükleme işlemi iptal edildi.');
        return;
      }
      
      try {
        // Lokal food_list.json dosyasını oku
        const response = await fetch('./food_list.json');
        if (!response.ok) {
          throw new Error('Lokal food_list.json dosyası okunamadı');
        }
        const lokalData = await response.json();
        console.log('📄 Lokal food_list.json okundu:', Object.keys(lokalData));
        
        // GitHub'daki mevcut dosyayı al
        const gitHubResponse = await fetch('https://api.github.com/repos/mustafasacar35/lipodem-takip-paneli-4/contents/food_list.json', {
          headers: {
            'Authorization': `token ${token}`,
            'Accept': 'application/vnd.github.v3+json'
          }
        });
        
        if (!gitHubResponse.ok) {
          throw new Error('GitHub dosyası alınamadı');
        }
        
        const gitHubData = await gitHubResponse.json();
        console.log('📄 GitHub food_list.json SHA:', gitHubData.sha);
        
        // Lokal dosyayı encode et
        const encodedContent = encodeUTF8ToBase64(lokalData);
        
        // GitHub'a yükle
        const uploadResponse = await fetch('https://api.github.com/repos/mustafasacar35/lipodem-takip-paneli-4/contents/food_list.json', {
          method: 'PUT',
          headers: {
            'Authorization': `token ${token}`,
            'Accept': 'application/vnd.github.v3+json',
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            message: '🍽️ Lokal food_list.json güncellemeleri GitHub\'a yüklendi',
            content: encodedContent,
            sha: gitHubData.sha
          })
        });
        
        if (!uploadResponse.ok) {
          const errorText = await uploadResponse.text();
          throw new Error(`GitHub yükleme hatası: ${errorText}`);
        }
        
        console.log('✅ Lokal food_list.json başarıyla GitHub\'a yüklendi!');
        alert('✅ Lokal food_list.json başarıyla GitHub\'a yüklendi!');
        
        // Yükleme sonrası yemek veritabanı analizini güncelle
        updateYemekVeritabaniAnalizi();
        
      } catch (error) {
        console.error('❌ Lokal food_list.json GitHub\'a yüklenirken hata:', error);
        alert(`❌ Hata: ${error.message}`);
      }
    }
    
    // Global fonksiyonları ekle
    window.pdfOnizlemeAc = pdfOnizlemeAc;
    window.pdfModalKapat = pdfModalKapat;
    window.pdfYazdir = pdfYazdir;
    window.pdfIndir = pdfIndir;
    window.lokalFoodListGithubYukle = lokalFoodListGithubYukle;

    // ==================== ÖĞÜN ŞABLON SİSTEMİ ====================
    
    // GitHub Raw URL'leri (mevcut repository kullanılıyor)
    const GITHUB_MEAL_TEMPLATES_URL = 'https://raw.githubusercontent.com/mustafasacar/lipodem-takip-paneli-4/main/meal-templates.json';
    const GITHUB_DAY_TEMPLATES_URL = 'https://raw.githubusercontent.com/mustafasacar/lipodem-takip-paneli-4/main/day-templates.json';
    
    async function kaydetOgunSablonu(gunAdi, ogunAdi) {
      console.log('💾 Öğün şablonu kaydetme başlatıldı:', gunAdi, ogunAdi);
      
      // Bu öğün altındaki tüm yemek satırlarını bul
      const ogunYemekleri = [];
      let eslesmemisYemekSayisi = 0;
      
      // Sınırları yapıdan al
      const structure = buildWeekStructureFromAnalysis(window.currentFoodAnalysisData || []);
      const day = structure.find(d => d.normalized === normalizeGunAdi(gunAdi));
      const meal = day ? day.meals.find(m => m.normalizedMeal === normalizeOgunAdi(ogunAdi)) : null;
      if (!day || !meal) {
        showToast('❌ Gün/öğün başlıkları güvenle tespit edilemedi.', 'error');
        return;
      }
      const start = Math.max(0, meal.start);
      const end = Math.min(window.currentFoodAnalysisData.length, meal.end || start);
      for (let i = start; i < end; i++) {
        const item = window.currentFoodAnalysisData[i];
        const itemText = item?.text || item?.tarifAdi || '';
        if (!item || item.gunOgunSatiri || item.karalistede) continue;
        if (!item.eslestiMi) {
          eslesmemisYemekSayisi++;
          continue;
        }
        if (item.eslesenYemek) {
          ogunYemekleri.push({
            foodName: item.eslesenYemek.originalName || item.eslesenYemek.name,
            originalText: itemText,
            calories: item.eslesenYemek.calories || 0,
            protein: item.eslesenYemek.protein || 0,
            carbs: item.eslesenYemek.carbs || 0,
            fat: item.eslesenYemek.fat || 0
          });
        }
      }
      
      console.log(`📊 Sonuç: ogunYemekleri=${ogunYemekleri.length}, eslesmemis=${eslesmemisYemekSayisi}, hedef=${gunAdi}/${ogunAdi}, bulunanYemekler=${ogunYemekleri.map(y => y.originalText).join(' | ')}`);
      
      console.log('🔍 EslesmemisYemekSayisi kontrol:', eslesmemisYemekSayisi, '> 0 =', eslesmemisYemekSayisi > 0);
      console.log('🔍 OgunYemekleri length kontrol:', ogunYemekleri.length, '=== 0 =', ogunYemekleri.length === 0);
      
      // Güvenlik kontrolü
      if (eslesmemisYemekSayisi > 0) {
        console.log('❌ Eşleşmemiş yemek nedeniyle durduruluyor');
        showToast(`❌ Bu öğün kaydedilemez! ${eslesmemisYemekSayisi} yemek eşleşmemiş. Önce tüm yemekleri eşleştirin.`, 'error', 5000);
        return;
      }
      
      if (ogunYemekleri.length === 0) {
        console.log('❌ Yemek bulunamadığı için durduruluyor');
        showToast('❌ Bu öğünde kaydetmeye uygun yemek bulunamadı!', 'error');
        return;
      }
      
      console.log('✅ Tüm kontroller geçildi, şablon modal açılıyor...');
      
      // Hasta bilgilerini PDF'den topla
      let hastaBilgileri = null;
      
      if (seciliHasta && aktifHaftaIndex !== null && seciliHasta.haftalar[aktifHaftaIndex]) {
        const aktifHafta = seciliHasta.haftalar[aktifHaftaIndex];
        
        // PDF'den isim ve tarih bilgisini al
        let pdfIsim = null;
        let pdfTarihAraligi = null;
        let pdfHaftaNo = null;
        
        // PDF orijinal isminden bilgileri çıkar
        if (aktifHafta.pdfOrijinalIsim) {
          const pdfAdi = aktifHafta.pdfOrijinalIsim;
          console.log('🔍 PDF adından bilgi çıkarılıyor:', pdfAdi);
          
          // "AYŞEGÜL FAROOQ 8-14 EYLÜL 2. HAFTA.pdf" formatından parse et
          // Regex'i daha esnek yap - isim kısmında özel karakterler olabilir
          const pdfMatch = pdfAdi.match(/^(.+?)\s+(\d{1,2}-\d{1,2}\s+[A-ZÜÇĞÖŞİ]+(?:\s+\d{4})?)\s+(\d+)\.\s*HAFTA\.pdf$/i);
          
          console.log('🔍 Regex test sonucu:', pdfMatch);
          
          if (pdfMatch) {
            pdfIsim = pdfMatch[1].trim().toUpperCase();
            pdfTarihAraligi = pdfMatch[2].trim().toUpperCase();
            pdfHaftaNo = parseInt(pdfMatch[3]);
            console.log('✅ PDF bilgileri başarıyla çıkarıldı:', { pdfIsim, pdfTarihAraligi, pdfHaftaNo });
          } else {
            console.log('⚠️ PDF adı beklenilen formatta değil, alternatif parse dene');
            
            // Alternatif parse - boşluklarla ayır
            const parts = pdfAdi.replace('.pdf', '').split(/\s+/);
            console.log('🔍 PDF adı parçalara ayrıldı:', parts);
            
            // Son kısımda "X. HAFTA" ara
            let haftaIndex = -1;
            for (let i = parts.length - 2; i >= 0; i--) {
              if (parts[i].match(/^\d+\.$/) && parts[i + 1] && parts[i + 1].toUpperCase() === 'HAFTA') {
                haftaIndex = i;
                break;
              }
            }
            
            if (haftaIndex > 0) {
              pdfHaftaNo = parseInt(parts[haftaIndex].replace('.', ''));
              
              // İsim kısmını al (hafta bilgisinden önceki kısım)
              let isimParts = [];
              let tarihParts = [];
              let tarihBasladi = false;
              
              for (let i = 0; i < haftaIndex; i++) {
                const part = parts[i];
                // Tarih pattern'i kontrol et (sayı-sayı formatı)
                if (part.match(/^\d{1,2}-\d{1,2}$/) || tarihBasladi) {
                  tarihBasladi = true;
                  tarihParts.push(part);
                } else {
                  isimParts.push(part);
                }
              }
              
              pdfIsim = isimParts.join(' ').toUpperCase();
              pdfTarihAraligi = tarihParts.join(' ').toUpperCase();
              
              console.log('✅ Alternatif parse başarılı:', { pdfIsim, pdfTarihAraligi, pdfHaftaNo });
            } else {
              console.log('❌ Hafta bilgisi bulunamadı, varsayılan değerleri kullan');
              pdfIsim = seciliHasta.isim;
              pdfTarihAraligi = aktifHafta.tarihAraligi;
              pdfHaftaNo = aktifHaftaIndex + 1;
            }
          }
        } else {
          // PDF bilgisi yoksa mevcut bilgileri kullan
          pdfIsim = seciliHasta.isim;
          pdfTarihAraligi = aktifHafta.tarihAraligi;
          pdfHaftaNo = aktifHaftaIndex + 1;
        }
        
        hastaBilgileri = {
          isim: pdfIsim,
          tarihAraligi: pdfTarihAraligi,
          haftaNo: pdfHaftaNo,
          gunAdi: gunAdi // Hangi günden alındığını ekle
        };
        
        console.log('📋 Hasta bilgileri hazırlandı:', hastaBilgileri);
      }
      
      // Modal ile şablon kaydetme
      await sablonKaydetModalAc(ogunAdi, ogunYemekleri, hastaBilgileri);
    }
    
    // GitHub'a şablon kaydetme fonksiyonu
  async function githubaSablonKaydet(dosyaAdi, yeniSablon) {
      const token = document.getElementById('githubToken').value.trim();
      if (!token) {
        throw new Error('GitHub token bulunamadı');
      }
      
      const repoOwner = 'mustafasacar35';
      const repoName = 'lipodem-takip-paneli-4';
      const apiUrl = `https://api.github.com/repos/${repoOwner}/${repoName}/contents/${dosyaAdi}`;
      
      try {
        // Önce mevcut dosyayı al
        let mevcutIcerik = [];
        let sha = null;
        
        const mevcutResponse = await fetch(apiUrl, {
          headers: { 'Authorization': `token ${token}` }
        });
        
        if (mevcutResponse.ok) {
          const mevcutData = await mevcutResponse.json();
          // UTF-8 decode kullan (atob yerine)
          const cleanBase64 = mevcutData.content.replace(/\s/g, '');
          const content = decodeBase64UTF8(cleanBase64);
          mevcutIcerik = JSON.parse(content);
          sha = mevcutData.sha;
          console.log('✅ Mevcut şablonlar yüklendi:', mevcutIcerik.length, 'adet');
          console.log('🔍 İlk şablon adı:', mevcutIcerik[0]?.name?.substring(0, 50));
        } else if (mevcutResponse.status === 404) {
          console.log('📄 meal-templates.json dosyası yok, yeni oluşturulacak');
          mevcutIcerik = [];
          sha = null;
        } else {
          throw new Error(`GitHub API dosya okuma hatası: ${mevcutResponse.status}`);
        }
        
        // Kayıttan önce DUPLICATE KONTROLÜ
        const normSimple = (txt) => {
          try { if (typeof normalizeTrSimple === 'function') return normalizeTrSimple(txt); } catch {}
          return String(txt || '')
            .toLowerCase()
            .replace(/ç/g,'c').replace(/ğ/g,'g').replace(/ş/g,'s').replace(/ı/g,'i').replace(/ö/g,'o').replace(/ü/g,'u')
            .replace(/[^a-z0-9\s]/g,' ')
            .replace(/\s+/g,' ')
            .trim();
        };
        const foodsToSignature = (foods) => {
          const arr = (foods || []).map(f => normSimple(f.foodName || f.name || f.originalText)).filter(Boolean);
          arr.sort();
          return arr.join('||');
        };
        const hedefType = normSimple(normalizeOgunAdi(yeniSablon.type));
        const hedefSig = foodsToSignature(yeniSablon.foods || []);
        let dupMatch = null;
        for (const s of (mevcutIcerik || [])) {
          try {
            const tip = normSimple(normalizeOgunAdi(s.type));
            if (tip !== hedefType) continue;
            const sig = foodsToSignature(s.foods || []);
            if (sig === hedefSig) { dupMatch = s; break; }
          } catch {}
        }
        if (dupMatch) {
          const name = dupMatch.displayName || dupMatch.name || '(isim yok)';
          const err = new Error(`DUPLICATE_TEMPLATE:${name}`);
          err.code = 'DUPLICATE_TEMPLATE';
          throw err;
        }

        // Benzersiz ID'yi garantiye al (kayıttan önce çatışmayı önle)
        const ensureId = (s) => {
          if (!s || !s.id) return { ...s, id: `${Date.now()}-${Math.random().toString(36).slice(2,10)}` };
          return s;
        };
        const safeYeni = ensureId(yeniSablon);
        // Dosyada var olan id'lerle çakışma varsa yeni id üret
        const existingIds = new Set((mevcutIcerik || []).map(x => x && x.id).filter(Boolean));
        let finalSablon = { ...safeYeni };
        while (existingIds.has(finalSablon.id)) {
          finalSablon.id = `${Date.now()}-${Math.random().toString(36).slice(2,10)}`;
        }
        // Yeni şablonu her zaman yeni bir eleman olarak ekle (birleştirme yok)
        mevcutIcerik.push(finalSablon);
        
        // Türkçe karakter desteği için UTF-8 encoding
        const jsonString = JSON.stringify(mevcutIcerik, null, 2);
        console.log('🔍 JSON string uzunluğu:', jsonString.length);
        
        // UTF-8 string'i base64'e çevir - daha güvenli yöntem
        const base64String = btoa(unescape(encodeURIComponent(jsonString)));
        console.log('🔍 Base64 string uzunluğu:', base64String.length);
        
        const kaydetPayload = {
          message: `Yeni öğün şablonu eklendi: ${finalSablon.name}`,
          content: base64String
        };
        
        // Eğer dosya zaten varsa SHA ekle
        if (sha) {
          kaydetPayload.sha = sha;
        }
        
        const kaydetResponse = await fetch(apiUrl, {
          method: 'PUT',
          headers: {
            'Authorization': `token ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(kaydetPayload)
        });
        
        console.log('🔍 GitHub kaydet response status:', kaydetResponse.status);
        console.log('🔍 GitHub kaydet response headers:', Object.fromEntries(kaydetResponse.headers.entries()));
        
        if (!kaydetResponse.ok) {
          let errorMessage = `GitHub API hatası: ${kaydetResponse.status} ${kaydetResponse.statusText}`;
          try {
            const errorData = await kaydetResponse.json();
            console.log('🔍 GitHub error detail:', errorData);
            if (errorData.message) {
              errorMessage = `GitHub API hatası: ${errorData.message}`;
            }
          } catch (e) {
            console.log('🔍 JSON parse error:', e.message);
            // JSON parse error, use status message
          }
          throw new Error(errorMessage);
        }
        
        console.log('✅ GitHub kaydetme başarılı!');
        try {
          // Oturum içi tekrar yüklemeden duplicate kontrolünün çalışması için yerelde listeyi güncelle
          if (Array.isArray(mevcutSablonlar)) mevcutSablonlar.push(finalSablon);
          // Kaydetme sonrası öğün satırlarını tazele ki Kaydet/Kaydedildi butonu anında güncellensin
          try { if (typeof updateYemekAnalizi === 'function') updateYemekAnalizi(); } catch {}
          try { if (typeof updateYemekVeritabaniAnalizi === 'function') updateYemekVeritabaniAnalizi(); } catch {}
        } catch {}
      } catch (error) {
        console.error('❌ GitHub kaydetme hatası:', error);
        throw error;
      }
    }
    
    async function alternatifleriGosterOgun(gunAdi, ogunAdi) {
      console.log('🔄 Öğün alternatifleri gösteriliyor (BENZERLIK TABANLI):', gunAdi, ogunAdi);
      
      try {
        // Şablonları yükle
        if (!mevcutSablonlar || mevcutSablonlar.length === 0) {
          console.log('📋 Şablonlar yükleniyor...');
          await sablonlariYukle();
        }
        
        if (!mevcutSablonlar || mevcutSablonlar.length === 0) {
          showToast('⚠️ Henüz öğün şablonu yok! Önce bir öğünü 💾 Kaydet butonuyla şablon olarak kaydedin.', 'warning', 4000);
          return;
        }
        
        // 🎯 HEDEF KALORI DURUMU KONTROL ET
        const hedefDurumu = calculateWeeklyCalorieStatus();
        let hedefToastEk = '';
        if (hedefDurumu.durum !== 'neutral' && hedefDurumu.durum !== 'hata') {
          if (hedefDurumu.durum === 'fazla') {
            hedefToastEk = ` (⚠️ Hedef: ${hedefDurumu.yuzde.toFixed(1)}% fazla kalori - Az kalorili alternatifler önerilecek)`;
          } else if (hedefDurumu.durum === 'eksik') {
            hedefToastEk = ` (📈 Hedef: ${Math.abs(hedefDurumu.yuzde).toFixed(1)}% eksik kalori - Yüksek kalorili alternatifler önerilecek)`;
          } else if (hedefDurumu.durum === 'ideal') {
            hedefToastEk = ` (✅ Hedef: İdeal aralık - Benzer kalorili alternatifler önerilecek)`;
          }
        }
        
        // Mevcut öğünün makrolarını hesapla
        const mevcutOgunMakrolari = getCurrentMealMacros(gunAdi, ogunAdi);
        if (!mevcutOgunMakrolari) {
          showToast('❌ Mevcut öğünün makroları hesaplanamadı! Önce öğündeki yemekleri eşleştirin.', 'error', 4000);
          return;
        }
        
        if (mevcutOgunMakrolari.foods.length === 0) {
          showToast('⚠️ Bu öğünde henüz eşleştirilmiş yemek yok! Önce yemekleri eşleştirin.', 'warning', 4000);
          return;
        }
        
        // Uygun öğün şablonlarını bul ve HEDEF KALORI DELTA skoruna göre sırala
        const uygunSablonlar = findCompatibleMealTemplates(ogunAdi, mevcutOgunMakrolari);
        
        if (uygunSablonlar.length === 0) {
          const normalizedOgun = normalizeOgunAdi(ogunAdi);
          showToast(`⚠️ ${normalizedOgun} türünde şablon bulunamadı! Önce aynı öğün türünde şablon kaydedin.${hedefToastEk}`, 'warning', 4000);
          return;
        }
        
        // 🎯 HEDEF KALORI ODAKLI TOAST MESAJI
        const enIyiSablon = uygunSablonlar[0];
        const kaloriDegisimi = enIyiSablon.templateMacros.calories - mevcutOgunMakrolari.calories;
        const kaloriYon = kaloriDegisimi > 0 ? '📈' : kaloriDegisimi < 0 ? '📉' : '➡️';
        const kaloriText = kaloriDegisimi > 0 ? `+${kaloriDegisimi.toFixed(0)}` : 
                         kaloriDegisimi < 0 ? `${kaloriDegisimi.toFixed(0)}` : '±0';
        
        let toastMesaj = `🎯 ${uygunSablonlar.length} hedef odaklı alternatif bulundu!${hedefToastEk}`;
        if (uygunSablonlar.length > 0) {
          toastMesaj += ` En iyi: ${enIyiSablon.name} (${kaloriYon} ${kaloriText} kcal)`;
        }
        
        console.log('🎯 Toast mesajı:', toastMesaj);
        showToast(toastMesaj, 'info', 5000);
        
        // Öğün alternatif modalını göster
        showMealAlternativeModal(gunAdi, ogunAdi, mevcutOgunMakrolari, uygunSablonlar);
        
      } catch (error) {
        console.error('❌ Öğün alternatifleri gösterme hatası:', error);
        showToast(`❌ Hata: ${error.message}`, 'error');
      }
    }

    // 🔄 BENZERLIK TABANLI: En benzer öğün şablonunu doğrudan uygula (modalsız)
    async function applyBestSimilarMealAlternative(gunAdi, ogunAdi) {
      try { gunAdi = decodeURIComponent(gunAdi); } catch {}
      try { ogunAdi = decodeURIComponent(ogunAdi); } catch {}
      console.log('⚡ En benzer alternatif uygulanıyor:', gunAdi, ogunAdi);

      // Şablonları yükle
      if (!mevcutSablonlar || mevcutSablonlar.length === 0) {
        await sablonlariYukle();
      }
      if (!mevcutSablonlar || mevcutSablonlar.length === 0) {
        showToast('⚠️ Henüz öğün şablonu yok! Önce bir öğünü 💾 Kaydet butonuyla şablon olarak kaydedin.', 'warning', 4000);
        return;
      }

      // Mevcut öğün makroları
      const mevcutOgunMakrolari = getCurrentMealMacros(gunAdi, ogunAdi);
      if (!mevcutOgunMakrolari || mevcutOgunMakrolari.foods.length === 0) {
        showToast('⚠️ Bu öğünde henüz eşleştirilmiş yemek yok! Önce yemekleri eşleştirin.', 'warning', 4000);
        return;
      }

      // Uygun şablonları BENZERLIK skoruna göre sırala
      const uygunSablonlar = findSimilarMealTemplates(ogunAdi, mevcutOgunMakrolari);
      if (!uygunSablonlar || uygunSablonlar.length === 0) {
        const normalizedOgun = normalizeOgunAdi(ogunAdi);
        showToast(`⚠️ ${normalizedOgun} türünde şablon bulunamadı!`, 'warning', 3000);
        return;
      }

      // Eğer daha önce bu öğüne bir şablon uygulanmışsa, sıradakini seç (döngüsel)
      let nextIndex = 0;
      try {
        const haftalar = (typeof getHaftaListesi === 'function') ? getHaftaListesi() : null;
        const seciliIndex = (typeof getAktifHaftaIndex === 'function') ? getAktifHaftaIndex() : 0;
        const hafta = Array.isArray(haftalar) ? haftalar[seciliIndex] : null;
        const key = `sim_meal_${normalizeGunAdi(gunAdi)}_${normalizeOgunAdi(ogunAdi)}`;
        const appliedId = hafta && hafta._uygulananOgunSablonlari ? hafta._uygulananOgunSablonlari[key] : null;
        const topCount = Math.min(10, uygunSablonlar.length);
        if (appliedId) {
          const curIdx = uygunSablonlar.findIndex(s => s.id === appliedId);
          if (curIdx >= 0 && curIdx < topCount) {
            nextIndex = (curIdx + 1) % topCount;
          } else {
            nextIndex = 0;
          }
        } else {
          nextIndex = 0;
        }
      } catch {}

      const secilecek = uygunSablonlar[nextIndex];
      
      // 🔄 BENZERLIK ODAKLI TOAST MESAJI
      const kaloriDegisimi = secilecek.templateMacros.calories - mevcutOgunMakrolari.calories;
      const kaloriYon = kaloriDegisimi > 0 ? '📈' : kaloriDegisimi < 0 ? '📉' : '➡️';
      const kaloriText = kaloriDegisimi > 0 ? `+${kaloriDegisimi.toFixed(0)}` : 
                       kaloriDegisimi < 0 ? `${kaloriDegisimi.toFixed(0)}` : '±0';
      
      const benzerlikBilgi = secilecek.similarityScore ? 
        ` 🔄 Benzerlik: ${(secilecek.similarityScore * 100).toFixed(0)}%` : 
        ' 🔄 Makro benzeri';
      
      // Benzerlik sistemi için ayrı tracking key kullan
      await replaceMealWithTemplate(gunAdi, ogunAdi, secilecek, 'sim_meal');
      showToast(`✅ ${ogunAdi}: ${secilecek.displayName || secilecek.name} (${kaloriYon} ${kaloriText} kcal)${benzerlikBilgi} [${(nextIndex+1)}/${Math.min(10, uygunSablonlar.length)}]`, 'success', 4000);
    }

    // 🎯 HEDEF KALORI TABANLI: En iyi eşleşen öğün şablonunu doğrudan uygula (modalsız)
    async function applyBestMealAlternative(gunAdi, ogunAdi) {
      try { gunAdi = decodeURIComponent(gunAdi); } catch {}
      try { ogunAdi = decodeURIComponent(ogunAdi); } catch {}
      console.log('⚡ En iyi alternatif uygulanıyor:', gunAdi, ogunAdi);

      // Şablonları yükle
      if (!mevcutSablonlar || mevcutSablonlar.length === 0) {
        await sablonlariYukle();
      }
      if (!mevcutSablonlar || mevcutSablonlar.length === 0) {
        showToast('⚠️ Henüz öğün şablonu yok! Önce bir öğünü 💾 Kaydet butonuyla şablon olarak kaydedin.', 'warning', 4000);
        return;
      }

      // Mevcut öğün makroları
      const mevcutOgunMakrolari = getCurrentMealMacros(gunAdi, ogunAdi);
      if (!mevcutOgunMakrolari || mevcutOgunMakrolari.foods.length === 0) {
        showToast('⚠️ Bu öğünde henüz eşleştirilmiş yemek yok! Önce yemekleri eşleştirin.', 'warning', 4000);
        return;
      }

      // Uygun şablonları HEDEF KALORI DELTA skoruna göre sırala
      const uygunSablonlar = findCompatibleMealTemplates(ogunAdi, mevcutOgunMakrolari);
      if (!uygunSablonlar || uygunSablonlar.length === 0) {
        const normalizedOgun = normalizeOgunAdi(ogunAdi);
        showToast(`⚠️ ${normalizedOgun} türünde şablon bulunamadı!`, 'warning', 3000);
        return;
      }

      // 🎯 HEDEF KALORI DURUMU KONTROL ET
      const hedefDurumu = calculateWeeklyCalorieStatus();

      // Eğer daha önce bu öğüne bir şablon uygulanmışsa, sıradakini seç (döngüsel)
      let nextIndex = 0;
      try {
        const haftalar = (typeof getHaftaListesi === 'function') ? getHaftaListesi() : null;
        const seciliIndex = (typeof getAktifHaftaIndex === 'function') ? getAktifHaftaIndex() : 0;
        const hafta = Array.isArray(haftalar) ? haftalar[seciliIndex] : null;
  const key = `target_meal_${normalizeGunAdi(gunAdi)}_${normalizeOgunAdi(ogunAdi)}`;
        const appliedId = hafta && hafta._uygulananOgunSablonlari ? hafta._uygulananOgunSablonlari[key] : null;
        const topCount = Math.min(10, uygunSablonlar.length);
        if (appliedId) {
          const curIdx = uygunSablonlar.findIndex(s => s.id === appliedId);
          if (curIdx >= 0 && curIdx < topCount) {
            nextIndex = (curIdx + 1) % topCount;
          } else {
            nextIndex = 0;
          }
        } else {
          nextIndex = 0;
        }
      } catch {}

      const secilecek = uygunSablonlar[nextIndex];
      
      // 🎯 HEDEF KALORI ODAKLI TOAST MESAJI
      const kaloriDegisimi = secilecek.templateMacros.calories - mevcutOgunMakrolari.calories;
      const kaloriYon = kaloriDegisimi > 0 ? '📈' : kaloriDegisimi < 0 ? '📉' : '➡️';
      const kaloriText = kaloriDegisimi > 0 ? `+${kaloriDegisimi.toFixed(0)}` : 
                       kaloriDegisimi < 0 ? `${kaloriDegisimi.toFixed(0)}` : '±0';
      
      let hedefBilgi = '';
      if (hedefDurumu.durum !== 'neutral' && hedefDurumu.durum !== 'hata') {
        if (hedefDurumu.durum === 'fazla' && kaloriDegisimi < 0) {
          hedefBilgi = ' 🎯 Hedefe uygun: Kalori azaltıldı!';
        } else if (hedefDurumu.durum === 'eksik' && kaloriDegisimi > 0) {
          hedefBilgi = ' 🎯 Hedefe uygun: Kalori artırıldı!';
        } else if (hedefDurumu.durum === 'ideal' && Math.abs(kaloriDegisimi) < 50) {
          hedefBilgi = ' 🎯 Hedefe uygun: İdeal aralıkta!';
        } else {
          hedefBilgi = ` 🎯 Yakınlık: ${(secilecek.targetProximity||0).toFixed(0)} kcal`;
        }
      }
      
  await replaceMealWithTemplate(gunAdi, ogunAdi, secilecek, 'target_meal');
      showToast(`✅ ${ogunAdi}: ${secilecek.displayName || secilecek.name} (${kaloriYon} ${kaloriText} kcal)${hedefBilgi} [${(nextIndex+1)}/${Math.min(10, uygunSablonlar.length)}]`, 'success', 4000);
    }

    // 🎯 Modal üzerinden seçim: target_meal izleme anahtarıyla uygula ve modalı kapat
    async function selectTargetMealAlternative(gunAdi, ogunAdi, sablonId) {
      try { gunAdi = decodeURIComponent(gunAdi); } catch {}
      try { ogunAdi = decodeURIComponent(ogunAdi); } catch {}
      try {
        const sablon = Array.isArray(mevcutSablonlar) ? mevcutSablonlar.find(s => s.id === sablonId) : null;
        if (!sablon) { showToast('❌ Şablon bulunamadı!', 'error', 3000); return; }
        await replaceMealWithTemplate(gunAdi, ogunAdi, sablon, 'target_meal');
        // Cycle state index'i seçilen id'ye hizala ki hızlı tuş bir sonrakinden devam etsin
        try {
          const state = _loadHedefCycleState();
          const ownerKey = _makeOwnerKey(gunAdi, ogunAdi);
          if (state[ownerKey] && Array.isArray(state[ownerKey].ids)) {
            const idx = state[ownerKey].ids.findIndex(x => x === (sablon.id || sablon.name || sablon.displayName));
            if (idx >= 0) { state[ownerKey].index = idx; _saveHedefCycleState(state); }
          }
        } catch {}
        try { const m = document.getElementById('hedefOgunAlternatifModal'); if (m) m.style.display = 'none'; } catch {}
        showToast(`✅ ${ogunAdi} öğünü güncellendi.`, 'success', 2500);
      } catch (e) {
        console.error('selectTargetMealAlternative error:', e);
        showToast('❌ Şablon uygulanamadı.', 'error', 3000);
      }
    }

    // Mevcut öğünün makrolarını hesapla
    function getCurrentMealMacros(gunAdi, ogunAdi) {
      console.log('🧮 Mevcut öğün makroları hesaplanıyor:', gunAdi, ogunAdi);
      
      if (!window.currentFoodAnalysisData || window.currentFoodAnalysisData.length === 0) {
        console.warn('⚠️ currentFoodAnalysisData bulunamadı!');
        return null;
      }
      
      console.log('🔍 currentFoodAnalysisData uzunluğu:', window.currentFoodAnalysisData.length);
      console.log('🔍 İlk 3 öğe örneği:', window.currentFoodAnalysisData.slice(0, 3));
      
      let totalCalories = 0;
      let totalProtein = 0;
      let totalCarbs = 0;
      let totalFat = 0;
      const mealFoods = [];
      // Day/Meal sınırlarını yapıdan bul
      console.log('🧮 getCurrentMealMacros debug:', { gunAdi, ogunAdi });
      console.log('🧮 normalizeGunAdi sonucu:', normalizeGunAdi(gunAdi));
      console.log('🧮 normalizeOgunAdi sonucu:', normalizeOgunAdi(ogunAdi));
      
      const structure = buildWeekStructureFromAnalysis(window.currentFoodAnalysisData || []);
      console.log('🧮 Hafta yapısı:', structure.map(d => ({ original: d.original, normalized: d.normalized, mealsCount: d.meals.length })));
      
      // Fallback gün için özel kontrol
      let targetDay;
      if (gunAdi === 'VARSAYILAN GÜN' && structure.length > 0) {
        // Fallback gün için ilk gün kullan veya yeni gün oluştur
        targetDay = structure[0];
        console.log('✅ Fallback gün için ilk gün kullanılıyor:', targetDay.original);
      } else if (normalizeGunAdi(gunAdi) === 'varsayilan_gun' && structure.length > 0) {
        // Normalize edilmiş fallback gün kontrolü
        targetDay = structure[0];
        console.log('✅ Normalize fallback gün için ilk gün kullanılıyor:', targetDay.original);
      } else {
        targetDay = structure.find(d => d.normalized === normalizeGunAdi(gunAdi));
      }
      
      if (!targetDay) { 
        console.warn('Gün bulunamadı:', gunAdi); 
        console.warn('Mevcut günler:', structure.map(d => d.normalized));
        return null; 
      }
      const targetMeal = targetDay.meals.find(m => m.normalizedMeal === normalizeOgunAdi(ogunAdi));
      if (!targetMeal) { console.warn('Öğün bulunamadı:', ogunAdi, 'gün:', gunAdi); return null; }
      const start = Math.max(0, targetMeal.start || (targetMeal.headerIndex + 1));
      const end = Math.min(window.currentFoodAnalysisData.length, targetMeal.end || start);
      for (let i = start; i < end; i++) {
        const item = window.currentFoodAnalysisData[i];
        if (!item) continue;
        if (item.eslestiMi && item.eslesenYemek) {
          const f = item.eslesenYemek;
          const calories = parseFloat(f.calories) || 0;
          const protein = parseFloat(f.protein) || 0;
          const carbs = parseFloat(f.carbs) || 0;
          const fat = parseFloat(f.fat) || 0;
          totalCalories += calories;
          totalProtein += protein;
          totalCarbs += carbs;
          totalFat += fat;
          mealFoods.push({ name: f.name || f.originalName, calories, protein, carbs, fat });
        }
      }
      
      console.log('📊 Mevcut öğün makroları:', {
        gun: gunAdi,
        ogun: ogunAdi,
        totalCalories: totalCalories.toFixed(1),
        totalProtein: totalProtein.toFixed(1),
        totalCarbs: totalCarbs.toFixed(1),
        totalFat: totalFat.toFixed(1),
        yemekSayisi: mealFoods.length
      });
      
      return {
        calories: totalCalories,
        protein: totalProtein,
        carbs: totalCarbs,
        fat: totalFat,
        foods: mealFoods
      };
    }
    
    // Öğün adını normalize et (karşılaştırma için)
    function normalizeOgunAdi(ogunAdi) {
      if (!ogunAdi) return '';
      
      console.log('🔧 Normalize ediliyor:', ogunAdi);
      
      const adi = ogunAdi.toLowerCase()
        .replace(/🍽️/g, '')
        .replace(/tercihen.*?\)/g, '')
        .replace(/\(.*?\)/g, '')
        .replace(/saat.*?civarında/g, '')
        .replace(/saat.*?-.*?civarında/g, '')
        .trim();
      
      console.log('🔧 Temizlenmiş ad:', adi);
      
  if (adi.includes('öğle')) return 'öğle';
  if (adi.includes('akşam') || adi.includes('aksam')) return 'akşam';
  if (adi.includes('kahvaltı') || adi.includes('kahvalti') || adi.includes('sabah')) return 'kahvaltı';
      if (adi.includes('ara öğün') || adi.includes('ara ogun') || adi.includes('ara')) return 'ara';
      
      console.log('🔧 Normalize sonuç:', adi);
      return adi;
    }
    
    // Gün adını normalize et (karşılaştırma için)
    function normalizeGunAdi(gunAdi) {
      if (!gunAdi) return '';
      
      console.log('🔧 Gün normalize ediliyor:', gunAdi);
      
      // Fallback gün özel kontrolü
      if (gunAdi.includes('VARSAYILAN GÜN')) {
        console.log('🔧 Fallback gün tespit edildi: VARSAYILAN GÜN');
        return 'varsayilan_gun';
      }
      
      const adi = gunAdi.toLowerCase()
        .replace(/📅/g, '')
        .replace(/\s+/g, ' ')
        .trim();
      
      console.log('🔧 Gün temizlenmiş ad:', adi);
      
  // Gün isimlerini standartlaştır (çakışmalara dikkat: 'cumartesi' 'cuma' içerir)
  if (adi.includes('pazartesi')) return 'pazartesi';
  if (adi.includes('sali') || adi.includes('salı')) return 'sali';
  if (adi.includes('çarşamba') || adi.includes('carsamba')) return 'çarşamba';
  if (adi.includes('perşembe') || adi.includes('persembe')) return 'perşembe';
  if (adi.includes('cumartesi')) return 'cumartesi';
  if (adi.includes('cuma')) return 'cuma';
  if (adi.includes('pazar')) return 'pazar';
      
      console.log('🔧 Gün normalize sonuç:', adi);
      return adi;
    }
    // Metin satırlarının türünü saptamak için dayanıklı yardımcılar
    function isDayHeaderText(text) {
      if (!text) return false;
      const t = String(text).toLowerCase().replace(/📅/g,'').trim();
      if (!t) return false;
      // Ör: "1. Gün (Pazartesi)" veya direkt gün adı ile başlayan satırlar
      const reNumGun = /^\d+\.\s*gün\s*\([^)]+\)/i;
      const days = ['pazartesi','salı','sali','çarşamba','carsamba','perşembe','persembe','cuma','cumartesi','pazar'];
      if (reNumGun.test(t)) return true;
      for (const d of days) {
        if (t.startsWith(d)) return true;
      }
      // Gün satırı bazen "PAZARTESİ" gibi çıplak olabilir
      for (const d of days) {
        if (t === d) return true;
      }
      return false;
    }

    function isMealHeaderText(text) {
      if (!text) return false;
      const raw = String(text);
      const t = raw.toLowerCase();
      // Yanlış pozitifleri ele: sabah rutini/başlangıç notları meal değildir
      if (t.includes('her sabah') || t.includes('güne başlarken') || t.includes('gune baslarken')) return false;
      // Anahtar kelime gerekir
      const hasKeyword = /(öğle|ogle|akşam|aksam|kahvaltı|kahvalti|sabah|ara\s*öğün|ara\s*ogun)/i.test(t);
      if (!hasKeyword) return false;
      // Parantez zorunlu (zaman bilgisi)
      if (!(raw.includes('(') && raw.includes(')'))) return false;
      // Parantez içinde saat/tercih ibaresi var mı? (esneklik)
      const inside = raw.substring(raw.indexOf('(') + 1, raw.lastIndexOf(')')).toLowerCase();
      const timeLike = /(\d|:|saat|civarında|civarinda|tercihen|\-)/.test(inside);
      return timeLike;
    }

    // Tüm tabloyu (currentFoodAnalysisData) gün/öğün/yemek bloklarına ayır
    function buildWeekStructureFromAnalysis(data) {
      const outDays = [];
      if (!Array.isArray(data) || data.length === 0) return outDays;
      let curDay = null;
      let curMeal = null;
      const pushMealIfAny = () => {
        if (curMeal) {
          // meal end index will be set before pushing
          curDay.meals.push(curMeal);
          curMeal = null;
        }
      };
      const pushDayIfAny = () => {
        if (curDay) {
          // close last meal
          if (curMeal) {
            curMeal.end = curMeal.end ?? (curMeal.headerIndex + 1); // safe guard
            pushMealIfAny();
          }
          // close day end
          curDay.end = curDay.end ?? (curDay.start + 1);
          outDays.push(curDay);
          curDay = null;
        }
      };
      for (let i = 0; i < data.length; i++) {
        const row = data[i];
        const text = row?.tarifAdi || row?.text || '';
        // Gün başlığı
        if (isDayHeaderText(text)) {
          // mevcut gün/öğünü kapat
          if (curMeal) { curMeal.end = i; pushMealIfAny(); }
          if (curDay) { curDay.end = i; pushDayIfAny(); }
          curDay = {
            label: text,
            normalized: normalizeGunAdi(text),
            start: i,
            end: null,
            meals: []
          };
          continue;
        }
        // Öğün başlığı
        if (isMealHeaderText(text)) {
          if (!curDay) {
            // Şüpheli durum: gün başlamadan meal; yeni gün olmayan blokları yok sayıyoruz
            continue;
          }
          if (curMeal) { curMeal.end = i; pushMealIfAny(); }
          curMeal = {
            header: text,
            normalizedMeal: normalizeOgunAdi(text),
            headerIndex: i,
            start: i + 1,
            end: null
          };
          continue;
        }
        // Yemek satırı
        // Eğer bir gün ve aktif meal varsa bu satır o öğüne aittir; aksi halde serbest satır ve atlanır
        // End'i meal kapanırken atanır.
      }
      // dosya sonu
      if (curMeal) { curMeal.end = data.length; pushMealIfAny(); }
      if (curDay) { curDay.end = data.length; pushDayIfAny(); }
      return outDays;
    }

    // Global yemek listelerinden (var olanlardan) bir yemek adı için makroları bulur
    function findFoodMacrosByName(foodName) {
      try {
        if (!foodName) return null;
        const norm = (typeof normalizeTrSimple === 'function') ? normalizeTrSimple(foodName) : String(foodName).toLowerCase().trim();

        // 1) window.globalFoodList (name, calories, protein, carbs, fat)
        if (Array.isArray(window.globalFoodList) && window.globalFoodList.length) {
          const hit = window.globalFoodList.find(db => {
            const dbName = (typeof normalizeTrSimple === 'function') ? normalizeTrSimple(db.name) : String(db.name || '').toLowerCase();
            return dbName === norm || dbName.includes(norm) || norm.includes(dbName);
          });
          if (hit) {
            return {
              name: hit.name,
              calories: parseFloat(hit.calories) || 0,
              protein: parseFloat(hit.protein) || 0,
              carbs: parseFloat(hit.carbs) || 0,
              fat: parseFloat(hit.fat) || 0
            };
          }
        }

        // 2) window.globalFoodListFlat (ad, kalori, protein, karbonhidrat, yag)
        if (Array.isArray(window.globalFoodListFlat) && window.globalFoodListFlat.length) {
          const hit2 = window.globalFoodListFlat.find(db => {
            const dbName = (typeof normalizeTrSimple === 'function') ? normalizeTrSimple(db.ad) : String(db.ad || '').toLowerCase();
            return dbName === norm || dbName.includes(norm) || norm.includes(dbName);
          });
          if (hit2) {
            return {
              name: hit2.ad,
              calories: parseFloat(hit2.kalori) || 0,
              protein: parseFloat(hit2.protein) || 0,
              carbs: parseFloat(hit2.karbonhidrat) || 0,
              fat: parseFloat(hit2.yag) || 0
            };
          }
        }

        return null;
      } catch (e) {
        console.warn('findFoodMacrosByName hatası:', e);
        return null;
      }
    }

    // 🎯 Haftalık kalori durumunu hesapla (hedef vs gerçekleşen)
    function calculateWeeklyCalorieStatus() {
      console.log('🎯 Haftalık kalori durumu hesaplanıyor...');
      
      try {
        // Hedef kaloriyi badge'den al
        let hedefKalori = 0;
        const hedefBadge = document.getElementById('hedefKcalBadge');
        if (hedefBadge) {
          const hedefText = hedefBadge.textContent || '';
          const hedefMatch = hedefText.match(/(\d+)/);
          if (hedefMatch) {
            hedefKalori = parseInt(hedefMatch[1]);
          }
        }
        
        // Gerçekleşen kaloriyi badge'den al
        let gerceklesenKalori = 0;
        const gercekBadge = document.getElementById('gercekKcalBadgeValue');
        if (gercekBadge) {
          const gercekText = gercekBadge.textContent || '';
          if (gercekText !== '—' && gercekText.trim()) {
            gerceklesenKalori = parseInt(gercekText) || 0;
          }
        }
        
        console.log('🎯 Hedef kalori:', hedefKalori, 'kcal/gün');
        console.log('🎯 Gerçekleşen ortalama:', gerceklesenKalori, 'kcal/gün');
        
        if (hedefKalori === 0) {
          console.log('⚠️ Hedef kalori bulunamadı, neutral durum döndürülüyor');
          return {
            hedefKalori: 0,
            gerceklesenKalori: 0,
            fark: 0,
            yuzde: 0,
            durum: 'neutral',
            aciklama: 'Hedef kalori tanımlanmamış'
          };
        }
        
        const fark = gerceklesenKalori - hedefKalori;
        const yuzde = hedefKalori > 0 ? (fark / hedefKalori) * 100 : 0;
        
        let durum = 'neutral';
        let aciklama = '';
        
        if (yuzde > 10) {
          durum = 'fazla';
          aciklama = `Hedefe göre %${yuzde.toFixed(1)} FAZLA kalori alınıyor`;
        } else if (yuzde < -10) {
          durum = 'eksik';
          aciklama = `Hedefe göre %${Math.abs(yuzde).toFixed(1)} EKSİK kalori alınıyor`;
        } else {
          durum = 'ideal';
          aciklama = `Hedef aralığında (%${yuzde.toFixed(1)})`;
        }
        
        const result = {
          hedefKalori,
          gerceklesenKalori,
          fark,
          yuzde,
          durum,
          aciklama
        };
        
        console.log('🎯 Kalori durumu analizi:', result);
        return result;
        
      } catch (error) {
        console.error('❌ calculateWeeklyCalorieStatus hata:', error);
        return {
          hedefKalori: 0,
          gerceklesenKalori: 0,
          fark: 0,
          yuzde: 0,
          durum: 'hata',
          aciklama: 'Kalori durumu hesaplanamadı'
        };
      }
    }

    // 🎯 Öğün için hedef kalori hesapla (Eski/Haftalık duruma göre) - OBJECT döndürür
    // Not: Hedef bazlı yeni sistemde sayı döndüren aşağıdaki calculateTargetMealCalories kullanılır.
    function calculateTargetMealCaloriesWeekly(mevcutOgunKalorisi) {
      console.log('🎯 Öğün hedef kalori hesaplanıyor. Mevcut öğün:', mevcutOgunKalorisi, 'kcal');
      
      try {
        const haftalikDurum = calculateWeeklyCalorieStatus();
        console.log('🎯 Haftalık durum:', haftalikDurum);
        
        if (haftalikDurum.durum === 'neutral' || haftalikDurum.durum === 'hata') {
          console.log('🎯 Haftalık durum belirsiz, mevcut kalori döndürülüyor');
          return {
            hedefOgunKalorisi: mevcutOgunKalorisi,
            deltaYuzdesi: 0,
            aciklama: 'Haftalık durum belirsiz'
          };
        }
        
        // DOĞRU HESAPLAMA: (Hedef Kalori - Gerçekleşen Kalori) / Gerçekleşen Kalori = Delta Yüzdesi
        const hedefKalori = haftalikDurum.hedefKalori;
        const gerceklesenKalori = haftalikDurum.gerceklesenKalori;
        
        if (gerceklesenKalori === 0) {
          console.log('🎯 Gerçekleşen kalori 0, mevcut kalori döndürülüyor');
          return {
            hedefOgunKalorisi: mevcutOgunKalorisi,
            deltaYuzdesi: 0,
            aciklama: 'Gerçekleşen kalori 0'
          };
        }
        
        const gunlukFark = hedefKalori - gerceklesenKalori;
        const deltaYuzdesi = (gunlukFark / gerceklesenKalori) * 100;
        
        // Öğün hedef kalori = Mevcut öğün kalori × (1 + delta yüzdesi)
        const hedefOgunKalorisi = mevcutOgunKalorisi * (1 + (deltaYuzdesi / 100));
        
        console.log('🎯 Hesaplama detayları:');
        console.log(`   📊 Hedef günlük: ${hedefKalori} kcal`);
        console.log(`   📊 Gerçekleşen günlük: ${gerceklesenKalori} kcal`);
        console.log(`   📊 Günlük fark: ${gunlukFark} kcal`);
        console.log(`   📊 Delta yüzdesi: ${deltaYuzdesi.toFixed(1)}%`);
        console.log(`   📊 Mevcut öğün: ${mevcutOgunKalorisi} kcal`);
        console.log(`   📊 Hedef öğün: ${hedefOgunKalorisi.toFixed(0)} kcal`);
        
        return {
          hedefOgunKalorisi: hedefOgunKalorisi,
          deltaYuzdesi: deltaYuzdesi,
          gunlukFark: gunlukFark,
          aciklama: `${deltaYuzdesi > 0 ? 'Artış' : 'Azalış'} gerekli: %${Math.abs(deltaYuzdesi).toFixed(1)}`
        };
        
      } catch (error) {
        console.error('❌ calculateTargetMealCalories hata:', error);
        return {
          hedefOgunKalorisi: mevcutOgunKalorisi,
          deltaYuzdesi: 0,
          aciklama: 'Hesaplama hatası'
        };
      }
    }

    // 🎯 Yeni sistem: Hedef kalori hesapla (sayı döndürür)
    // Formül: hedefYuzde = (gunlukHedefKalori - ortalamKalori) / ortalamKalori
    //          hedefOgunKalorisi = mevcutOgunKalorisi * (1 + hedefYuzde)
    function calculateTargetMealCalories(gunlukHedefKalori, ortalamKalori, mevcutOgunKalorisi) {
      try {
        const hedefYuzde = (gunlukHedefKalori - ortalamKalori) / (ortalamKalori || 1);
        const hedef = mevcutOgunKalorisi * (1 + hedefYuzde);
        // Sayı olarak dön
        return Number.isFinite(hedef) ? hedef : mevcutOgunKalorisi;
      } catch (e) {
        console.warn('⚠️ calculateTargetMealCalories (yeni) hata, mevcut değeri döndürüyorum', e);
        return mevcutOgunKalorisi;
      }
    }

    // 🎯 Hedef kalori delta skorunu hesapla (0-100 arası)
    function calculateTargetCalorieDeltaScore(mevcutKalori, sablonKalori, hedefDurumu) {
      console.log('🎯 Delta skoru hesaplanıyor:', {
        mevcut: mevcutKalori,
        sablon: sablonKalori,
        hedefDurumu: hedefDurumu.durum,
        yuzde: hedefDurumu.yuzde
      });
      
      try {
        // Eğer hedef kalori sistemi çalışmıyorsa, makro benzerliğe göre skor ver
        if (hedefDurumu.durum === 'neutral' || hedefDurumu.durum === 'hata') {
          console.log('🎯 Hedef sistem çalışmıyor, makro benzerlik skoruna fall-back');
          const kaloriFark = Math.abs(mevcutKalori - sablonKalori);
          const benzerlikSkoru = Math.max(0, 100 - (kaloriFark / 10));
          return Math.min(100, benzerlikSkoru);
        }
        
        const kaloriDegisimi = sablonKalori - mevcutKalori; // pozitif = artış, negatif = azalış
        const hedefYuzde = hedefDurumu.yuzde; // pozitif = fazla, negatif = eksik
        
        console.log('🎯 Kalori değişimi:', kaloriDegisimi, 'kcal');
        console.log('🎯 Hedef durumu:', hedefYuzde.toFixed(1), '%');
        
        let deltaSkoru = 50; // Başlangıç skoru
        
        // HEDEF DURUMA GÖRE SKOR HESAPLAMA
        if (hedefDurumu.durum === 'fazla') {
          // Fazla kalori durumu - kalori azaltacak şablonlar tercih edilsin
          if (kaloriDegisimi < 0) {
            // Kalori azaltıyor - BONUS!
            const azalmaYuzdesi = Math.abs(kaloriDegisimi / mevcutKalori) * 100;
            deltaSkoru = 70 + Math.min(30, azalmaYuzdesi * 2); // 70-100 arası
            console.log('🎯 ✅ BONUS: Fazla kalori durumunda kalori azaltıyor +', deltaSkoru.toFixed(1));
          } else if (kaloriDegisimi > 0) {
            // Kalori artırıyor - CEZA!
            const artisYuzdesi = (kaloriDegisimi / mevcutKalori) * 100;
            deltaSkoru = Math.max(10, 50 - (artisYuzdesi * 2)); // 10-50 arası
            console.log('🎯 ❌ CEZA: Fazla kalori durumunda kalori artırıyor -', deltaSkoru.toFixed(1));
          }
        } else if (hedefDurumu.durum === 'eksik') {
          // Eksik kalori durumu - kalori artıracak şablonlar tercih edilsin
          if (kaloriDegisimi > 0) {
            // Kalori artırıyor - BONUS!
            const artisYuzdesi = (kaloriDegisimi / mevcutKalori) * 100;
            deltaSkoru = 70 + Math.min(30, artisYuzdesi * 2); // 70-100 arası
            console.log('🎯 ✅ BONUS: Eksik kalori durumunda kalori artırıyor +', deltaSkoru.toFixed(1));
          } else if (kaloriDegisimi < 0) {
            // Kalori azaltıyor - CEZA!
            const azalmaYuzdesi = Math.abs(kaloriDegisimi / mevcutKalori) * 100;
            deltaSkoru = Math.max(10, 50 - (azalmaYuzdesi * 2)); // 10-50 arası
            console.log('🎯 ❌ CEZA: Eksik kalori durumunda kalori azaltıyor -', deltaSkoru.toFixed(1));
          }
        } else if (hedefDurumu.durum === 'ideal') {
          // İdeal durumda - mevcut kaloriye yakın şablonlar tercih edilsin
          const kaloriFark = Math.abs(kaloriDegisimi);
          const tolerans = mevcutKalori * 0.15; // %15 tolerans
          if (kaloriFark <= tolerans) {
            deltaSkoru = 80 + Math.max(0, 20 - (kaloriFark / tolerans * 20)); // 80-100 arası
            console.log('🎯 ✅ İDEAL: Tolerans içinde kalori değişimi +', deltaSkoru.toFixed(1));
          } else {
            deltaSkoru = Math.max(30, 80 - (kaloriFark / tolerans * 25)); // 30-80 arası
            console.log('🎯 ⚠️ İDEAL: Tolerans dışında kalori değişimi -', deltaSkoru.toFixed(1));
          }
        }
        
        const finalSkoru = Math.max(0, Math.min(100, deltaSkoru));
        console.log('🎯 DELTA SKORU:', finalSkoru.toFixed(1), '/100');
        
        return finalSkoru;
        
      } catch (error) {
        console.error('❌ calculateTargetCalorieDeltaScore hata:', error);
        return 50; // Hata durumında orta skor
      }
    }

    // 🔄 Sadece benzerlik tabanlı şablon bulma (Hedef kalori karışmadan)
    function findSimilarMealTemplates(ogunAdi, mevcutMakrolar) {
      console.log('🔄 Benzer şablonlar aranıyor (SADECE BENZERLIK)...', ogunAdi, mevcutMakrolar);
      
      // Şablonlar yüklü değilse boş dizi döndür
      if (!Array.isArray(mevcutSablonlar) || mevcutSablonlar.length === 0) {
        console.warn('⚠️ findSimilarMealTemplates: mevcutSablonlar boş veya tanımsız');
        return [];
      }
      
      const normalizedOgun = normalizeOgunAdi(ogunAdi);
      console.log('🔄 Normalize edilmiş öğün tipi:', normalizedOgun);
      
      // Aynı öğün tipindeki şablonları filtrele
      const ayniTipSablonlar = mevcutSablonlar.filter(sablon => {
        if (!sablon.type) {
          console.log('⚠️ Şablonda type alanı yok:', sablon.name);
          return false;
        }
        const sablonTip = normalizeOgunAdi(sablon.type);
        const eslesme = sablonTip === normalizedOgun;
        if (eslesme) {
          console.log('✅ Eşleşen şablon:', sablon.name, 'Tip:', sablonTip);
        }
        return eslesme;
      });
      
      console.log(`📋 ${normalizedOgun} tipinde ${ayniTipSablonlar.length} şablon bulundu`);
      
      if (ayniTipSablonlar.length === 0) {
        console.log('🔍 Tüm şablon tipleri:', mevcutSablonlar.map(s => ({ name: s.name, type: s.type, normalizedType: normalizeOgunAdi(s.type) })));
      }
      
      // Her şablon için SADECE makro benzerlik skorunu hesapla
      const skorluSablonlar = ayniTipSablonlar.map(sablon => {
        const sablonMakrolari = calculateTemplateMacros(sablon);
        const benzerlikSkoru = calculateMacroSimilarity(mevcutMakrolar, sablonMakrolari);
        
        console.log(`📊🔄 Şablon: ${sablon.name}`);
        console.log(`   📊 Makrolar: ${sablonMakrolari.calories.toFixed(0)} kcal`);
        console.log(`   🔄 Benzerlik Skoru: ${benzerlikSkoru.toFixed(1)} (sadece makro benzerliği)`);
        
        return {
          ...sablon,
          templateMacros: sablonMakrolari,
          similarityScore: benzerlikSkoru
        };
      });
      
      // Benzerlik skoruna göre sırala (en yüksek skor önce)
      skorluSablonlar.sort((a, b) => b.similarityScore - a.similarityScore);
      
      // En iyi 10 tanesini al
      const enIyiSablonlar = skorluSablonlar.slice(0, 10);
      
      console.log('🏆🔄 En benzer şablonlar (SADECE BENZERLIK):');
      enIyiSablonlar.forEach((s, index) => {
        console.log(`${index + 1}. ${s.name}`);
        console.log(`   📊 Kalori: ${s.templateMacros.calories.toFixed(0)} kcal`);
        console.log(`   🔄 Benzerlik: ${s.similarityScore.toFixed(1)}`);
        console.log(`   🆔 ID: ${s.id || 'no-id'}`);
        console.log(`   🍽️ Yemek sayısı: ${(s.foods || []).length}`);
      });
      
      console.log('🔄 Döndürülen şablon sayısı:', enIyiSablonlar.length);
      return enIyiSablonlar;
    }
    
    // Uygun öğün şablonlarını bul (HEDEF KALORI ODAKLI)
    function findCompatibleMealTemplates(ogunAdi, mevcutMakrolar) {
      console.log('🔍🎯 Uygun şablonlar aranıyor (HEDEF KALORI DELTA SİSTEMİ)...', ogunAdi, mevcutMakrolar);
      
      // Şablonlar yüklü değilse boş dizi döndür
      if (!Array.isArray(mevcutSablonlar) || mevcutSablonlar.length === 0) {
        console.warn('⚠️ findCompatibleMealTemplates: mevcutSablonlar boş veya tanımsız');
        return [];
      }
      
      const normalizedOgun = normalizeOgunAdi(ogunAdi);
      console.log('🎯 Normalize edilmiş öğün tipi:', normalizedOgun);
      
      // 🎯 YENİ DOĞRU HEDEF KALORI HESAPLAMA (ön-koşullar zorunlu)
      try { window.__targetPreconditionError = null; } catch {}
      // Günlük hedef (badge)
      const hedefKcalElement = document.getElementById('hedefKcalBadgeValue');
      const hedefBadgeText = hedefKcalElement ? (hedefKcalElement.textContent || '') : '';
      const gunlukHedefKalori = Number(String(hedefBadgeText).replace(/[^0-9.]/g, ''));
      if (!isFinite(gunlukHedefKalori) || gunlukHedefKalori <= 0) {
        const msg = '⚠️ Günlük hedef kalori ayarlı değil. Lütfen Hasta Ayarları’ndan hedef kaloriyi girin.';
        try { window.__targetPreconditionError = msg; } catch {}
        try { showToast(msg, 'warning', 4000); } catch {}
        return [];
      }
      // Haftalık ortalama (analiz)
      const activeWeekStats = getActiveWeekAverageStats();
      const ortalamKalori = (activeWeekStats && isFinite(activeWeekStats.kalori)) ? Number(activeWeekStats.kalori) : NaN;
      if (!isFinite(ortalamKalori) || ortalamKalori <= 0) {
        const msg = '⚠️ Haftalık ortalama kalori bulunamadı. Lütfen haftayı oluşturup analizlendikten sonra tekrar deneyin.';
        try { window.__targetPreconditionError = msg; } catch {}
        try { showToast(msg, 'warning', 4000); } catch {}
        return [];
      }
      
      const hedefKalori = calculateTargetMealCalories(gunlukHedefKalori, ortalamKalori, mevcutMakrolar.calories);
      
      console.log('🎯 Hedef kalori hesaplama:', {
        gunlukHedef: gunlukHedefKalori,
        ortalama: ortalamKalori,
        mevcutOgun: mevcutMakrolar.calories,
        hedefOgun: hedefKalori,
        timestamp: Date.now() // Seed için zaman damgası
      });
      
      // Aynı öğün tipindeki şablonları filtrele
      const ayniTipSablonlar = mevcutSablonlar.filter(sablon => {
        if (!sablon.type) {
          console.log('⚠️ Şablonda type alanı yok:', sablon.name);
          return false;
        }
        const sablonTip = normalizeOgunAdi(sablon.type);
        const eslesme = sablonTip === normalizedOgun;
        if (eslesme) {
          console.log('✅ Eşleşen şablon:', sablon.name, 'Tip:', sablonTip);
        }
        return eslesme;
      });
      
      console.log(`📋 ${normalizedOgun} tipinde ${ayniTipSablonlar.length} şablon bulundu`);
      
      if (ayniTipSablonlar.length === 0) {
        console.log('🔍 Tüm şablon tipleri:', mevcutSablonlar.map(s => ({ name: s.name, type: s.type, normalizedType: normalizeOgunAdi(s.type) })));
      }
      
      // Her şablon için YENİ HEDEF KALORI YAKINNLIK SKORU hesapla
      const skorluSablonlar = ayniTipSablonlar.map(sablon => {
        const sablonMakrolari = calculateTemplateMacros(sablon);
        
        // YENİ SİSTEM: Hedef öğün kalorisine yakınlık hesapla
        const sablonKalorisi = sablonMakrolari.calories;
        const kaloriMutlakFark = Math.abs(sablonKalorisi - hedefKalori);
        
        // Yakınlık skoru: En yakın kalori = en yüksek skor
        const yakinlikSkoru = Math.max(0, 100 - (kaloriMutlakFark / 10));
        
        console.log(`📊🎯 Şablon: ${sablon.name}`);
  console.log(`   📊 Şablon kalori: ${sablonKalorisi.toFixed(0)} kcal`);
  console.log(`   🎯 Hedef öğün kalori: ${hedefKalori.toFixed(0)} kcal`);
  console.log(`   Δ Mutlak fark: ${kaloriMutlakFark.toFixed(0)} kcal`);
        console.log(`   🏆 Yakınlık skoru: ${yakinlikSkoru.toFixed(1)}`);
        console.log(`   📊 Oransal değişim: ${((gunlukHedefKalori - ortalamKalori) / ortalamKalori * 100).toFixed(1)}%`);
        
        return {
          ...sablon,
          templateMacros: sablonMakrolari,
          targetProximity: Math.abs(sablonMakrolari.calories - hedefKalori),
          percentageChange: (gunlukHedefKalori - ortalamKalori) / ortalamKalori,
          targetCalories: hedefKalori,
          actualCalories: sablonMakrolari.calories
        };
      });
      
      // 🎯 HEDEF KALORI YAKLIĞINA göre sırala (en yakın önce) - KARLI SIRALAMA
      skorluSablonlar.sort((a, b) => {
        // Önce targetProximity'ye göre sırala
        const proximityDiff = a.targetProximity - b.targetProximity;
        if (proximityDiff !== 0) return proximityDiff;
        
        // Aynı yakınlıktaysa actual calories'e göre sırala (küçükten büyüğe)
        const caloriesDiff = a.actualCalories - b.actualCalories;
        if (caloriesDiff !== 0) return caloriesDiff;
        
        // Sonra id'ye göre sırala (varsa)
        const idA = String(a.id || '');
        const idB = String(b.id || '');
        if (idA && idB && idA !== idB) return idA.localeCompare(idB, 'tr');
        
        // Son çare olarak name'e göre alfabetik sırala
        const nameA = String(a.name || a.displayName || '');
        const nameB = String(b.name || b.displayName || '');
        return nameA.localeCompare(nameB, 'tr');
      });
      
      // En iyi 10 tanesini al
      const enIyiSablonlar = skorluSablonlar.slice(0, 10);
      
      console.log('🏆🎯 En iyi şablonlar (HEDEF KALORİ - hedefe yakınlığa göre KARLI):');
      enIyiSablonlar.forEach((s, index) => {
        const kaloriDegisimi = s.templateMacros.calories - hedefKalori;
        const deltaText = kaloriDegisimi > 0 ? `+${kaloriDegisimi.toFixed(0)}` : `${kaloriDegisimi.toFixed(0)}`;
        console.log(`🔢 ${index + 1}. ${s.name} (ID: ${s.id || 'yok'})`);
        console.log(`   📊 Kalori: ${s.templateMacros.calories.toFixed(0)} kcal | Hedef: ${Number(hedefKalori).toFixed(0)} kcal (${deltaText} fark)`);
        console.log(`   🎯 Hedef Yakınlık: ${s.targetProximity.toFixed(0)} kcal fark`);
        console.log(`   📈 Oransal Değişim: ${(s.percentageChange * 100).toFixed(1)}%`);
      });
      
      return enIyiSablonlar;
    }
    
    // Şablon makrolarını hesapla
    function calculateTemplateMacros(sablon) {
      console.log('🧮 Şablon makro hesaplama:', sablon.name);
      console.log('🔍 Şablon foods array:', sablon.foods);
      
      if (!sablon.foods || !Array.isArray(sablon.foods)) {
        console.log('⚠️ Şablon foods array bulunamadı!');
        return { calories: 0, protein: 0, carbs: 0, fat: 0 };
      }
      
      console.log('🔍 Foods array uzunluğu:', sablon.foods.length);
      
      let totalCalories = 0;
      let totalProtein = 0;
      let totalCarbs = 0;
      let totalFat = 0;
      
      sablon.foods.forEach((food, index) => {
        console.log(`🍎 [${index}] Food object keys:`, Object.keys(food));
        console.log(`🍎 [${index}] Food object:`, food);
        
        // Şablon yemekleri sadece foodName içeriyor, makro bilgilerini veritabanından bulmalıyız
        const foodName = food.foodName || food.name || food.tarifAdi || food.originalName;
        console.log(`🔍 [${index}] Aranan yemek:`, foodName);
        
        let calories = 0, protein = 0, carbs = 0, fat = 0;
        
        // Global yemek veritabanında ara (her iki global listeyi de dene)
        if (foodName) {
          const found = findFoodMacrosByName(foodName);
          if (found) {
            calories = found.calories; protein = found.protein; carbs = found.carbs; fat = found.fat;
            console.log(`✅ [${index}] Yemek bulundu:`, found.name, 'Makrolar:', {calories, protein, carbs, fat});
          } else {
            console.log(`❌ [${index}] Yemek bulunamadı (global listelerde):`, foodName);
          }
        } else {
          console.log(`⚠️ [${index}] Global yemek listesi mevcut değil veya yemek adı eksik`);
        }
        
        totalCalories += calories;
        totalProtein += protein;
        totalCarbs += carbs;
        totalFat += fat;
      });
      
      const result = {
        calories: totalCalories,
        protein: totalProtein,
        carbs: totalCarbs,
        fat: totalFat
      };
      
      console.log('📊 Hesaplanan şablon makroları:', result);
      return result;
    }
    
    // Makro benzerlik skorunu hesapla (0-100 arası)
    function calculateMacroSimilarity(makro1, makro2) {
      console.log('⚖️ Benzerlik hesaplama:', { makro1, makro2 });
      
      const MAX_DIFF = 1000; // Maksimum fark toleransı
      
      // Her makro için yüzde farkını hesapla
      const kaloriFark = Math.abs(makro1.calories - makro2.calories);
      const proteinFark = Math.abs(makro1.protein - makro2.protein);
      const karbFark = Math.abs(makro1.carbs - makro2.carbs);
      const yagFark = Math.abs(makro1.fat - makro2.fat);
      
      console.log('📊 Farklar:', { kaloriFark, proteinFark, karbFark, yagFark });
      
      // Normalize et (0-1 arası)
      const kaloriSkor = Math.max(0, 1 - (kaloriFark / MAX_DIFF));
      const proteinSkor = Math.max(0, 1 - (proteinFark / 100));
      const karbSkor = Math.max(0, 1 - (karbFark / 100));
      const yagSkor = Math.max(0, 1 - (yagFark / 100));
      
      console.log('🎯 Skorlar:', { kaloriSkor, proteinSkor, karbSkor, yagSkor });
      
      // Ağırlıklı ortalama (kalori daha önemli)
      const toplamSkor = (kaloriSkor * 0.4) + (proteinSkor * 0.2) + (karbSkor * 0.2) + (yagSkor * 0.2);
      
      const finalSkor = toplamSkor * 100;
      console.log('🏆 Final benzerlik skoru:', finalSkor);
      
      return finalSkor; // 0-100 arası skor
    }

    // 🔄 Benzerlik tabanlı öğün alternatif modalını göster
    async function showSimilarityMealAlternativeModal(gunAdi, ogunAdi) {
      try { gunAdi = decodeURIComponent(gunAdi); } catch {}
      try { ogunAdi = decodeURIComponent(ogunAdi); } catch {}
      console.log('🔄 Modal açılıyor - parametreler:', { gunAdi, ogunAdi });
      
      // Boş parametreleri kontrol et
      if (!gunAdi || !ogunAdi) {
        console.error('🔄 Hata: Gün veya öğün parametresi boş!', { gunAdi, ogunAdi });
        showToast('⚠️ Gün veya öğün bilgisi eksik!', 'error', 3000);
        return;
      }
      
      // Şablonları yükle
      if (!mevcutSablonlar || mevcutSablonlar.length === 0) {
        await sablonlariYukle();
      }
      if (!mevcutSablonlar || mevcutSablonlar.length === 0) {
        showToast('⚠️ Henüz öğün şablonu yok! Önce bir öğünü 💾 Kaydet butonuyla şablon olarak kaydedin.', 'warning', 4000);
        return;
      }

      // Mevcut öğün makroları
      const mevcutMakrolar = getCurrentMealMacros(gunAdi, ogunAdi);
      if (!mevcutMakrolar || mevcutMakrolar.foods.length === 0) {
        showToast('⚠️ Bu öğünde henüz eşleştirilmiş yemek yok! Önce yemekleri eşleştirin.', 'warning', 4000);
        return;
      }

      // Benzer şablonları bul
      const uygunSablonlar = findSimilarMealTemplates(ogunAdi, mevcutMakrolar);
      if (!uygunSablonlar || uygunSablonlar.length === 0) {
        const normalizedOgun = normalizeOgunAdi(ogunAdi);
        showToast(`⚠️ ${normalizedOgun} türünde şablon bulunamadı!`, 'warning', 3000);
        return;
      }

      // En iyi 10 tanesini al
      const list = uygunSablonlar.slice(0, 10);
      
      // Bu modalın sırasını hızlı uygula için kalıcı olarak kaydet (benzerlik sistemi için)
      try {
        const state = _loadSimilarityCycleState();
        const ownerKey = _makeOwnerKey(gunAdi, ogunAdi);
        const ids = list.map(s => (s.id || s.name || s.displayName || ''));
        state[ownerKey] = state[ownerKey] || { ids: [], index: -1 };
        state[ownerKey].ids = ids;
        // Eğer uygulanmış similarity id varsa index'i hizala
        try {
          const haftalar = (typeof getHaftaListesi === 'function') ? getHaftaListesi() : null;
          const seciliIndex = (typeof getAktifHaftaIndex === 'function') ? getAktifHaftaIndex() : 0;
          const hafta = Array.isArray(haftalar) ? haftalar[seciliIndex] : null;
          const appliedKey = `sim_meal_${normalizeGunAdi(gunAdi)}_${normalizeOgunAdi(ogunAdi)}`;
          const appliedId = hafta && hafta._uygulananOgunSablonlari ? hafta._uygulananOgunSablonlari[appliedKey] : null;
          if (appliedId) {
            const curIdx = ids.findIndex(x => x === appliedId);
            if (curIdx >= 0) state[ownerKey].index = curIdx;
          }
        } catch {}
        _saveSimilarityCycleState(state);
      } catch {}
      
      const modalId = 'benzerlikOgunAlternatifModal';
      let modal = document.getElementById(modalId);
      
      // Modal yoksa oluştur
      if (!modal) {
        modal = document.createElement('div');
        modal.id = modalId;
        modal.style.cssText = `
          display: none; 
          position: fixed; 
          top: 0; 
          left: 0; 
          width: 100%; 
          height: 100%; 
          background: rgba(0,0,0,0.5); 
          z-index: 10003;
        `;
        modal.onclick = () => { modal.style.display = 'none'; };
        document.body.appendChild(modal);
      }
      
      const normalizedOgun = normalizeOgunAdi(ogunAdi);
      const normalizedGun = normalizeGunAdi(gunAdi);

      // O anda seçili şablon id'sini haftadan çek (varsa)
      let selectedTemplateId = null;
      try {
        const haftalar = (typeof getHaftaListesi === 'function') ? getHaftaListesi() : null;
        const seciliIndex = (typeof getAktifHaftaIndex === 'function') ? getAktifHaftaIndex() : 0;
        const hafta = Array.isArray(haftalar) ? haftalar[seciliIndex] : null;
        const key = `orig_meal_${normalizedGun}_${normalizedOgun}`;
        if (hafta && hafta._uygulananOgunSablonlari && hafta._uygulananOgunSablonlari[key]) {
          selectedTemplateId = hafta._uygulananOgunSablonlari[key];
        }
      } catch {}
      
      modal.innerHTML = `
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 8px; width: 95%; max-width: 900px; max-height: 90%; overflow: hidden;" onclick="event.stopPropagation()">
          <div style="padding: 20px; border-bottom: 1px solid #ddd; background: linear-gradient(135deg, #17a2b8 0%, #138496 100%); color: white;">
            <h3 style="margin: 0; font-size: 20px;">🔄 ${normalizedOgun.charAt(0).toUpperCase() + normalizedOgun.slice(1)} Öğünü Benzer Alternatifleri</h3>
            <p style="margin: 5px 0 0 0; font-size: 14px; opacity: 0.9;">${gunAdi} - Mevcut: ${mevcutMakrolar.calories.toFixed(0)} kcal, ${mevcutMakrolar.foods.length} yemek</p>
          </div>
          
          <div style="padding: 20px; max-height: 60vh; overflow-y: auto;">
            <div style="margin-bottom: 15px; padding: 12px; background: #e1f5fe; border: 1px solid #0288d1; border-radius: 6px;">
              <div style="color: #0277bd; font-weight: bold; font-size: 14px;">
                🔄 BENZERL\u0130K TABANLI SİSTEM
              </div>
              <div style="font-size: 12px; color: #01579b; margin-top: 2px;">
                Mevcut öğün makrolarına en benzer şablonlar önerilir (kalori + protein + karb + yağ benzerliği)
              </div>
            </div>
            
            <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 6px;">
              <h5 style="margin: 0 0 10px 0; color: #495057;">📊 Mevcut Öğün Makroları</h5>
              <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; font-size: 14px; margin-bottom: 10px;">
                <div><strong>Kalori:</strong> ${mevcutMakrolar.calories.toFixed(0)} kcal</div>
                <div><strong>Protein:</strong> ${mevcutMakrolar.protein.toFixed(1)} g</div>
                <div><strong>Karb:</strong> ${mevcutMakrolar.carbs.toFixed(1)} g</div>
                <div><strong>Yağ:</strong> ${mevcutMakrolar.fat.toFixed(1)} g</div>
              </div>
              <div style="font-size: 12px; color: #666;">
                <strong>Yemekler:</strong> ${mevcutMakrolar.foods.map(f => f.name).join(', ')}
              </div>
            </div>
            
            <h5 style="margin: 0 0 15px 0; color: #495057;">🏆 Benzer Alternatifler (Benzerlik Sıralaması - ${list.length} adet)</h5>
            ${list.map((sablon, index) => {
              const scoreBg = sablon.similarityScore >= 80 ? '#d4edda' : 
                           sablon.similarityScore >= 60 ? '#fff3cd' : '#f8d7da';
              const scoreColor = sablon.similarityScore >= 80 ? '#155724' : 
                               sablon.similarityScore >= 60 ? '#856404' : '#721c24';
              
              // Kalori değişimi analizi
              const kaloriDegisimi = sablon.templateMacros.calories - mevcutMakrolar.calories;
              const kaloriYon = kaloriDegisimi > 0 ? '📈' : kaloriDegisimi < 0 ? '📉' : '➡️';
              const kaloriText = kaloriDegisimi > 0 ? `+${kaloriDegisimi.toFixed(0)}` : 
                               kaloriDegisimi < 0 ? `${kaloriDegisimi.toFixed(0)}` : '±0';
              
              const safeGun = encodeURIComponent(gunAdi);
              const safeOgun = encodeURIComponent(ogunAdi);
              const isSelected = selectedTemplateId && (sablon.id === selectedTemplateId || sablon.name === selectedTemplateId);
              const rowBg = isSelected ? '#e3f2fd' : (index === 0 ? '#e8f5e8' : '#fff');
              
              return `
              <div style="border: 1px solid #ddd; border-radius: 6px; margin-bottom: 10px; overflow: hidden;">
                <div style="padding: 12px; background: ${rowBg}; border-bottom: 1px solid #eee; cursor: pointer;" onclick="selectSimilarityMealAlternative('${safeGun}', '${safeOgun}', '${sablon.id}')">
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="flex: 1;">
                      <h6 style="margin: 0; color: #333; font-size: 14px;">${sablon.displayName || sablon.name} ${isSelected ? '<span style="font-size:11px; color:#0d47a1; background:#bbdefb; padding:2px 6px; border-radius:8px; margin-left:6px;">Seçili</span>' : ''}</h6>
                      <div style="font-size: 12px; color: #666; margin-top: 4px;">
                        <span style="background: ${scoreBg}; color: ${scoreColor}; padding: 2px 6px; border-radius: 3px; font-weight: bold;">
                          🔄 %${sablon.similarityScore.toFixed(1)} benzer
                        </span>
                        <span style="margin-left: 8px;">
                          📊 ${sablon.templateMacros.calories.toFixed(0)} kcal ${kaloriYon} (${kaloriText})
                        </span>
                      </div>
                    </div>
                    <button style="background: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: bold;">
                      ✅ Seç
                    </button>
                  </div>
                </div>
                <div style="padding: 10px; background: #f9f9f9; font-size: 12px; color: #666;">
                  <strong>Yemekler (${sablon.foods ? sablon.foods.length : 0} adet):</strong> 
                  ${sablon.foods ? sablon.foods.map(f => f.foodName || f.name || f.originalText || '—').join(', ') : 'Bilgi yok'}
                </div>
              </div>
            `;}).join('')}
            
            ${uygunSablonlar.length === 0 ? `
              <div style="text-align: center; color: #6c757d; padding: 40px;">
                <i class="fas fa-search" style="font-size: 48px; margin-bottom: 15px; opacity: 0.5;"></i>
                <h4 style="margin: 0 0 10px 0;">Benzer alternatif bulunamadı</h4>
                <p style="margin: 0; font-size: 14px;">Bu öğün türünde şablon yok. Önce bazı ${normalizedOgun} öğünlerini şablon olarak kaydedin.</p>
              </div>
            ` : ''}
          </div>
          
          <div style="padding: 15px 20px; border-top: 1px solid #ddd; text-align: right; background: #f8f9fa;">
            <button onclick="document.getElementById('${modalId}').style.display='none'" style="background: #6c757d; color: white; border: none; padding: 12px 24px; border-radius: 4px; cursor: pointer;">İptal</button>
          </div>
        </div>
      `;
      
      modal.style.display = 'block';
    }
    
    // 🎯 Hedef kalori tabanlı öğün alternatif modalını göster
    function showMealAlternativeModal(gunAdi, ogunAdi, mevcutMakrolar, uygunSablonlar) {
      const modalId = 'ogunAlternatifModal';
      let modal = document.getElementById(modalId);
      
      // Modal yoksa oluştur
      if (!modal) {
        modal = document.createElement('div');
        modal.id = modalId;
        modal.style.cssText = `
          display: none; 
          position: fixed; 
          top: 0; 
          left: 0; 
          width: 100%; 
          height: 100%; 
          background: rgba(0,0,0,0.5); 
          z-index: 10003;
        `;
        modal.onclick = closeMealAlternativeModal;
        document.body.appendChild(modal);
      }
      
      const normalizedOgun = normalizeOgunAdi(ogunAdi);
      const normalizedGun = normalizeGunAdi(gunAdi);

      // 🎯 HEDEF KALORI DURUMU GÖSTER
      const hedefDurumu = calculateWeeklyCalorieStatus();
      
      let hedefBilgisi = '';
      if (hedefDurumu.durum !== 'neutral' && hedefDurumu.durum !== 'hata') {
        let hedefIcon = '🎯';
        let hedefColor = '#17a2b8';
        let hedefText = hedefDurumu.aciklama;
        
        if (hedefDurumu.durum === 'fazla') {
          hedefIcon = '⚠️';
          hedefColor = '#dc3545';
          hedefText = `FAZLA KALORİ: %${hedefDurumu.yuzde.toFixed(1)} fazla - Daha az kalorili şablonlar önerilir`;
        } else if (hedefDurumu.durum === 'eksik') {
          hedefIcon = '📈';
          hedefColor = '#fd7e14';
          hedefText = `EKSİK KALORİ: %${Math.abs(hedefDurumu.yuzde).toFixed(1)} eksik - Daha fazla kalorili şablonlar önerilir`;
        } else if (hedefDurumu.durum === 'ideal') {
          hedefIcon = '✅';
          hedefColor = '#28a745';
          hedefText = `İDEAL ARALIQ: %${hedefDurumu.yuzde.toFixed(1)} - Mevcut kaloriye yakın şablonlar önerilir`;
        }
        
        hedefBilgisi = `
          <div style="margin-bottom: 15px; padding: 12px; background: ${hedefColor}15; border: 1px solid ${hedefColor}; border-radius: 6px;">
            <div style="color: ${hedefColor}; font-weight: bold; font-size: 14px;">
              ${hedefIcon} HEDEF KALORİ DURUMU
            </div>
            <div style="font-size: 13px; color: #333; margin-top: 4px;">
              Hedef: ${hedefDurumu.hedefKalori} kcal/gün • Gerçekleşen: ${hedefDurumu.gerceklesenKalori} kcal/gün
            </div>
            <div style="font-size: 12px; color: #666; margin-top: 2px;">
              ${hedefText}
            </div>
          </div>
        `;
      }

      // O anda seçili şablon id'sini haftadan çek (varsa)
      let selectedTemplateId = null;
      try {
        const haftalar = (typeof getHaftaListesi === 'function') ? getHaftaListesi() : null;
        const seciliIndex = (typeof getAktifHaftaIndex === 'function') ? getAktifHaftaIndex() : 0;
        const hafta = Array.isArray(haftalar) ? haftalar[seciliIndex] : null;
        const key = `orig_meal_${normalizedGun}_${normalizedOgun}`;
        if (hafta && hafta._uygulananOgunSablonlari && hafta._uygulananOgunSablonlari[key]) {
          selectedTemplateId = hafta._uygulananOgunSablonlari[key];
        }
      } catch {}
      
      modal.innerHTML = `
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 8px; width: 95%; max-width: 900px; max-height: 90%; overflow: hidden;" onclick="event.stopPropagation()">
          <div style="padding: 20px; border-bottom: 1px solid #ddd; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
            <h3 style="margin: 0; font-size: 20px;">🔄 ${normalizedOgun.charAt(0).toUpperCase() + normalizedOgun.slice(1)} Öğünü Alternatifleri</h3>
            <p style="margin: 5px 0 0 0; font-size: 14px; opacity: 0.9;">${gunAdi} - Mevcut: ${mevcutMakrolar.calories.toFixed(0)} kcal, ${mevcutMakrolar.foods.length} yemek</p>
          </div>
          
          <div style="padding: 20px; max-height: 60vh; overflow-y: auto;">
            ${hedefBilgisi}
            
            <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 6px;">
              <h5 style="margin: 0 0 10px 0; color: #495057;">📊 Mevcut Öğün Makroları</h5>
              <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; font-size: 14px; margin-bottom: 10px;">
                <div><strong>Kalori:</strong> ${mevcutMakrolar.calories.toFixed(0)} kcal</div>
                <div><strong>Protein:</strong> ${mevcutMakrolar.protein.toFixed(1)} g</div>
                <div><strong>Karb:</strong> ${mevcutMakrolar.carbs.toFixed(1)} g</div>
                <div><strong>Yağ:</strong> ${mevcutMakrolar.fat.toFixed(1)} g</div>
              </div>
              <div style="font-size: 12px; color: #666;">
                <strong>Yemekler:</strong> ${mevcutMakrolar.foods.map(f => f.name).join(', ')}
              </div>
            </div>
            
            <h5 style="margin: 0 0 15px 0; color: #495057;">🏆 Önerilen Alternatifler (Hedef Kalori Odaklı - ${uygunSablonlar.length} adet)</h5>
            ${uygunSablonlar.map((sablon, index) => {
              // Hedefe göre yakınlık ve fark
              const hedefKcal = (sablon.targetCalories || hedefKalori);
              const hedefYakinlik = Math.abs((sablon.templateMacros?.calories || 0) - hedefKcal);
              
              // Kalori değişimi analizi: mevcut öğünden fark
              const kaloriDegisimi = sablon.templateMacros.calories - mevcutMakrolar.calories;
              const kaloriYon = kaloriDegisimi > 0 ? '📈' : kaloriDegisimi < 0 ? '📉' : '➡️';
              const kaloriText = kaloriDegisimi > 0 ? `+${kaloriDegisimi.toFixed(0)}` : 
                               kaloriDegisimi < 0 ? `${kaloriDegisimi.toFixed(0)}` : '±0';
              
              const safeGun = encodeURIComponent(gunAdi);
              const safeOgun = encodeURIComponent(ogunAdi);
              const isSelected = selectedTemplateId && (sablon.id === selectedTemplateId || sablon.name === selectedTemplateId);
              const rowBg = isSelected ? '#e3f2fd' : (index === 0 ? '#e8f5e8' : '#fff');
              
              return `
              <div style="border: 1px solid #ddd; border-radius: 6px; margin-bottom: 10px; overflow: hidden;">
                <div style="padding: 12px; background: ${rowBg}; border-bottom: 1px solid #eee; cursor: pointer;" onclick="selectMealAlternative('${safeGun}', '${safeOgun}', '${sablon.id}')">
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="flex: 1;">
                      <h6 style="margin: 0; color: #333; font-size: 14px;">${sablon.displayName || sablon.name} ${isSelected ? '<span style="font-size:11px; color:#0d47a1; background:#bbdefb; padding:2px 6px; border-radius:8px; margin-left:6px;">Seçili</span>' : ''}</h6>
                      <div style="font-size: 12px; color: #666; margin-top: 4px; display:flex; flex-wrap:wrap; gap:6px; align-items:center;">
                        <span style="background:#e9ecef; color:#495057; padding:2px 6px; border-radius:3px;">🎯 Hedef: ${hedefKcal.toFixed(0)} kcal</span>
                        <span style="background:#d1e7dd; color:#0f5132; padding:2px 6px; border-radius:3px;">Yakınlık: ${hedefYakinlik.toFixed(0)} kcal</span>
                        <span style="background:#fff3cd; color:#664d03; padding:2px 6px; border-radius:3px;">Oran: ${(Number.isFinite(percentageChange)?(percentageChange*100):0).toFixed(1)}%</span>
                        <span>📊 ${sablon.templateMacros.calories.toFixed(0)} kcal ${kaloriYon} (${kaloriText})</span>
                      </div>
                    </div>
                    <button style="background: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: bold;">
                      ✅ Seç
                    </button>
                  </div>
                </div>
                <div style="padding: 10px; background: #f9f9f9; font-size: 12px; color: #666;">
                  <strong>Yemekler (${sablon.foods ? sablon.foods.length : 0} adet):</strong> 
                  ${sablon.foods ? sablon.foods.map(f => f.foodName || f.name || f.originalText || '—').join(', ') : 'Bilgi yok'}
                </div>
              </div>
            `;}).join('')}
            
            ${uygunSablonlar.length === 0 ? `
              <div style="text-align: center; color: #6c757d; padding: 40px;">
                <i class="fas fa-search" style="font-size: 48px; margin-bottom: 15px; opacity: 0.5;"></i>
                <h4 style="margin: 0 0 10px 0;">Alternatif bulunamadı</h4>
                <p style="margin: 0; font-size: 14px;">Bu öğün türünde şablon yok. Önce bazı ${normalizedOgun} öğünlerini şablon olarak kaydedin.</p>
              </div>
            ` : ''}
          </div>
          
          <div style="padding: 15px 20px; border-top: 1px solid #ddd; text-align: right; background: #f8f9fa;">
            <button onclick="closeMealAlternativeModal()" style="background: #6c757d; color: white; border: none; padding: 12px 24px; border-radius: 4px; cursor: pointer;">İptal</button>
          </div>
        </div>
      `;
      
      modal.style.display = 'block';
    }
    
    // Öğün alternatif modalını kapat
    function closeMealAlternativeModal() {
      const modal = document.getElementById('ogunAlternatifModal');
      if (modal) {
        modal.style.display = 'none';
      }
    }
    
    // Öğün alternatifini seç ve uygula
    async function selectMealAlternative(gunAdi, ogunAdi, sablonId) {
      try { gunAdi = decodeURIComponent(gunAdi); } catch {}
      try { ogunAdi = decodeURIComponent(ogunAdi); } catch {}
      console.log('🔄 Öğün alternatifi seçildi:', gunAdi, ogunAdi, sablonId);
      
      try {
        // Şablonu bul
        const sablon = mevcutSablonlar.find(s => s.id === sablonId);
        if (!sablon) {
          showToast('❌ Şablon bulunamadı!', 'error');
          return;
        }

        // Öğün değişimini uygula
        await replaceMealWithTemplate(gunAdi, ogunAdi, sablon);
        
        // Modalı kapat
        closeMealAlternativeModal();
        
        showToast(`✅ ${ogunAdi} öğünü başarıyla değiştirildi!`, 'success', 3000);
        
      } catch (error) {
        console.error('❌ Öğün alternatifi seçme hatası:', error);
        showToast(`❌ Hata: ${error.message}`, 'error');
      }
    }
    
    // Öğünü şablonla değiştir
    async function replaceMealWithTemplate(gunAdi, ogunAdi, sablon, trackingPrefix = 'orig_meal') {
      try { gunAdi = decodeURIComponent(gunAdi); } catch {}
      try { ogunAdi = decodeURIComponent(ogunAdi); } catch {}
      console.log('🔄 Öğün şablonla değiştiriliyor:', gunAdi, ogunAdi, sablon.name);

      // Hafta verisini bulun ve doğrudan tarifleri güncelleyin (kalıcı olsun)
      const haftalar = (typeof getHaftaListesi === 'function') ? getHaftaListesi() : null;
      const seciliIndex = (typeof getAktifHaftaIndex === 'function') ? getAktifHaftaIndex() : 0;
      const hafta = Array.isArray(haftalar) ? haftalar[seciliIndex] : null;
      if (!hafta || !Array.isArray(hafta.tarifler)) {
        throw new Error('Hafta tarifleri bulunamadı!');
      }

      const hedefGun = normalizeGunAdi(gunAdi);
      const hedefOgun = normalizeOgunAdi(ogunAdi);

      // Yardımcı tespit fonksiyonları (normalize edilmiş değerlerle kesin eşleşme)
      const isGunRow = (t) => {
        const n = normalizeGunAdi(String(t || ''));
        return [
          'pazartesi','sali','çarşamba','perşembe','cuma','cumartesi','pazar'
        ].includes(n);
      };
      const isOgunRow = (t) => {
        const s = String(t || '');
        const lower = s.toLowerCase();
        const hasKeyword = /(öğle|ogle|akşam|aksam|kahvaltı|kahvalti|sabah|ara\s*öğün|ara\s*ogun)/i.test(lower);
        if (!hasKeyword) return false;
        // Daha esnek başlık sezgisi: ikon veya parantez veya başta öğün adı
        const hasIcon = s.includes('🍽') || s.includes('🍽️');
        const hasParen = s.includes('(') && s.includes(')');
        const startsWithMeal = /^\s*(🍽️)?\s*(kahvaltı|kahvalti|öğle|ogle|akşam|aksam|ara)/i.test(s);
        return hasIcon || hasParen || startsWithMeal;
      };

      // 1) Gün başlangıcını bul
      let gunStart = -1;
      for (let i = 0; i < hafta.tarifler.length; i++) {
        const satir = String(hafta.tarifler[i] || '');
        if (isGunRow(satir) && normalizeGunAdi(satir) === hedefGun) {
          gunStart = i;
          break;
        }
      }
      if (gunStart === -1) throw new Error('Gün satırı bulunamadı!');

      // 2) Bu günün bitişini bul (bir sonraki gün başlığı)
      let gunEnd = hafta.tarifler.length;
      for (let i = gunStart + 1; i < hafta.tarifler.length; i++) {
        if (isGunRow(String(hafta.tarifler[i] || ''))) { gunEnd = i; break; }
      }

      // 3) Gün içindeki hedef öğün başlığını bul (sadece gerçek başlık satırları)
      let ogunHeaderIndex = -1;
      for (let i = gunStart + 1; i < gunEnd; i++) {
        const satir = String(hafta.tarifler[i] || '');
        const n = normalizeOgunAdi(satir);
        if (isOgunRow(satir) && n === hedefOgun) {
          ogunHeaderIndex = i;
          break;
        }
      }
      if (ogunHeaderIndex === -1) {
        // Daha toleranslı arama: normalize eşleşmesi olan ilk satırı kabul et (başlık sezgisi aranmadan)
        for (let i = gunStart + 1; i < gunEnd; i++) {
          const satir = String(hafta.tarifler[i] || '');
          const n = normalizeOgunAdi(satir);
          if (n && hedefOgun && n === hedefOgun) {
            ogunHeaderIndex = i;
            console.warn('⚠️ Katı başlık kriteri eşleşmedi, normalize eşleşmeyle seçildi:', hafta.tarifler[i]);
            break;
          }
        }
      }
      if (ogunHeaderIndex === -1) throw new Error('Öğün satırı bulunamadı!');

      // 4) Bu öğünün sonunu bul (bir sonraki öğün veya gün başlığı)
      let ogunEnd = gunEnd;
      for (let i = ogunHeaderIndex + 1; i < gunEnd; i++) {
        const satir = String(hafta.tarifler[i] || '');
        if (isOgunRow(satir) || isGunRow(satir)) { ogunEnd = i; break; }
      }

      // 5) Mevcut öğün yemeklerini kaldırmadan önce ORİJİNALİ BİR KEZ SNAPSHOT olarak sakla
      try {
        const snapKey = `orig_meal_${hedefGun}_${hedefOgun}`;
        const mevcutOgunSatirlari = hafta.tarifler.slice(ogunHeaderIndex + 1, ogunEnd);
        // Eğer daha önce snapshot yoksa ve bu bölümde en az bir yemek satırı varsa kaydet
        if (!hafta._orijinalOgunler) hafta._orijinalOgunler = {};
        if (!hafta._orijinalOgunler[snapKey] && mevcutOgunSatirlari && mevcutOgunSatirlari.length >= 0) {
          hafta._orijinalOgunler[snapKey] = Array.from(mevcutOgunSatirlari);
          console.log('🧩 Orijinal öğün snapshot alındı:', snapKey, hafta._orijinalOgunler[snapKey]);
        }
      } catch (e) {
        console.warn('⚠️ Orijinal öğün snapshot alınamadı:', e);
      }

      // 6) Mevcut öğün yemeklerini kaldır ve şablon yemeklerini ekle
      const eskiAdet = Math.max(0, ogunEnd - (ogunHeaderIndex + 1));
      const eklenecekYemekler = (Array.isArray(sablon.foods) ? sablon.foods : []).map(f => f.foodName || f.name || f.originalText || '').filter(Boolean);
      console.log('🗑️ Silinecek yemek sayısı:', eskiAdet, '➕ Eklenecek:', eklenecekYemekler.length);
      console.log('🍽️ Mevcut öğün aralığı:', ogunHeaderIndex + 1, '→', ogunEnd);
      console.log('🗑️ Silinecek yemekler:', hafta.tarifler.slice(ogunHeaderIndex + 1, ogunEnd));
      console.log('➕ Eklenecek yemekler:', eklenecekYemekler);
      
      // 🔄 BENZERLIK SİSTEMİ İÇİN ÖZEL TEMIZLIK - Tekrarlanan yemekleri agresif olarak temizle
      if (trackingPrefix === 'sim_meal') {
        console.log('🔄 Benzerlik sistemi için agresif temizlik yapılıyor...');
        
        // Mevcut öğün yemeklerini kontrol et - tekrarlananları tespit et
        const mevcutYemekler = hafta.tarifler.slice(ogunHeaderIndex + 1, ogunEnd);
        const tekrarliYemekler = new Set();
        const seenYemekler = new Set();
        
        mevcutYemekler.forEach(yemek => {
          const temizYemek = String(yemek).trim().toLowerCase();
          if (seenYemekler.has(temizYemek)) {
            tekrarliYemekler.add(temizYemek);
          }
          seenYemekler.add(temizYemek);
        });
        
        if (tekrarliYemekler.size > 0) {
          console.log('🔄 Tespit edilen tekrarlı yemekler:', Array.from(tekrarliYemekler));
          // Agresif temizlik: Tüm öğün yemeklerini sil ve sadece yenilerini ekle
          const yeniEskiAdet = Math.max(0, ogunEnd - (ogunHeaderIndex + 1));
          console.log('🔄 Agresif temizlik: Tüm öğün temizleniyor, eski adet:', yeniEskiAdet);
          hafta.tarifler.splice(ogunHeaderIndex + 1, yeniEskiAdet, ...eklenecekYemekler);
          console.log(`📏 Agresif temizlik sonrası tarifler uzunluğu: ${hafta.tarifler.length}`);
          
          // Erken çıkış - idempotency ve normal flow'u atla
          try {
            if (!hafta._uygulananOgunSablonlari) hafta._uygulananOgunSablonlari = {};
            const key = `${trackingPrefix}_${hedefGun}_${hedefOgun}`;
            hafta._uygulananOgunSablonlari[key] = sablon.id || sablon.name || null;
          } catch {}
          try { if (typeof otomatikEsleHafta === 'function') await otomatikEsleHafta(seciliIndex); } catch {}
          try { updateYemekVeritabaniAnalizi(); } catch {}
          try { updateTotalRows(); } catch {}
          console.log('✅ Agresif temizlik tamamlandı');
          return;
        }
      }

      // Idempotency guard: aynı içerik zaten uygulanmışsa tekrar ekleme
      try {
        const mevcut = hafta.tarifler.slice(ogunHeaderIndex + 1, ogunEnd).map(s => String(s).trim());
        const hedef = eklenecekYemekler.map(s => String(s).trim());
        const ayniMi = (mevcut.length === hedef.length) && mevcut.every((v, i) => v === hedef[i]);
        if (ayniMi) {
          console.log('ℹ️ Aynı şablon içerik zaten uygulanmış, tekrar eklenmeyecek.');
          // yine de işaretlemeyi güncelle (uygulanan şablon kaydı)
          try {
            if (!hafta._uygulananOgunSablonlari) hafta._uygulananOgunSablonlari = {};
            const key = `${trackingPrefix}_${hedefGun}_${hedefOgun}`;
            hafta._uygulananOgunSablonlari[key] = sablon.id || sablon.name || null;
          } catch {}
          // Analizi tazele
          try { if (typeof updateYemekVeritabaniAnalizi === 'function') updateYemekVeritabaniAnalizi(); } catch {}
          try { if (typeof updateTotalRows === 'function') updateTotalRows(); } catch {}
          return;
        }
      } catch (e) {
        console.warn('Idempotency kontrolünde hata:', e);
      }

      // Kaldır ve ekle
  const oncekiUzunluk = hafta.tarifler.length;
  hafta.tarifler.splice(ogunHeaderIndex + 1, eskiAdet, ...eklenecekYemekler);
  console.log(`📏 Tarifler uzunluğu: ${oncekiUzunluk} → ${hafta.tarifler.length}`);

      // Uygulanan şablonu kaydet (modal vurgusu için)
      try {
        if (!hafta._uygulananOgunSablonlari) hafta._uygulananOgunSablonlari = {};
        const key = `${trackingPrefix}_${hedefGun}_${hedefOgun}`;
        hafta._uygulananOgunSablonlari[key] = sablon.id || sablon.name || null;
      } catch {}

      // 7) Eşleştirmeyi baştan çalıştır ve UI'yı güncelle
      try {
        if (typeof otomatikEsleHafta === 'function') {
          await otomatikEsleHafta(seciliIndex);
        }
      } catch (e) {
        console.warn('otonom eşleştirme çağrısı başarısız:', e?.message || e);
      }
      try { updateYemekVeritabaniAnalizi(); } catch {}
      try { updateTotalRows(); } catch {}

      // Başarı mesajı
      console.log('✅ Öğün güncellendi (tarifler güncellendi ve analiz yeniden çalıştı).');
    }

    // === HEDEF (🎯) BAZLI ÖĞÜN ALTERNATİFLERİ ===
    // Günlük hedef - gerçekleşen ortalama delta'sına ve öğün dağılımına göre istenen öğün kcal hedefini hesaplar
  function getDesiredMealKcalFromBadges(gunAdi, ogunAdi) {
      try {
        const hedefEl = document.getElementById('hedefKcalBadgeValue');
        const gercekEl = document.getElementById('gercekKcalBadgeValue');
        if (!hedefEl || !gercekEl) return null;
        const hedef = parseFloat((hedefEl.textContent || '').replace(/[^0-9.]/g, ''));
        const gercek = parseFloat((gercekEl.textContent || '').replace(/[^0-9.]/g, ''));
        if (!isFinite(hedef) || hedef <= 0) return null;
        // Not: 'gerçekleşen' badge'i isteğe bağlıdır; hedef olmadan hesap yapmayız, ancak gerçeği kullanmak zorunlu değildir.

        // Öğün dağılımını al
        const aktif = (typeof getCurrentHasta === 'function') ? getCurrentHasta() : null;
        if (!aktif) return null;
        const effPromise = (typeof computeEffectiveSettingsFor === 'function') ? computeEffectiveSettingsFor(aktif) : null;
        // computeEffectiveSettingsFor async olduğu için sync kullanımlarda mevcut dist'i headerdan türeteceğiz
        // Basit fallback: header popover mantığındaki normalizeMealDistribution
        const getDistSync = () => {
          try {
            const raw = aktif.mealDistribution || window.DEFAULT_MEAL_DISTRIBUTION || { kahvalti: 25, ogle: 35, aksam: 35, ara: 5 };
            return (typeof normalizeMealDistribution === 'function') ? normalizeMealDistribution(raw) : raw;
          } catch { return { kahvalti: 25, ogle: 35, aksam: 35, ara: 5 }; }
        };
        const ogunKey = normalizedMealToKey(normalizeOgunAdi(ogunAdi));
        const dist = getDistSync();
        const pct = (dist && ogunKey && isFinite(dist[ogunKey])) ? (Number(dist[ogunKey]) / 100) : 0.25;

        // ABSOLUTE meal target: günlük hedef × öğün yüzdesi
        const desiredMealAbs = Math.max(0, Math.round(hedef * pct));

        // Mevcut öğün kcal
        const cur = getCurrentMealMacros(gunAdi || getActiveGunLabelSafe(), ogunAdi);
        const curK = cur && isFinite(cur.calories) ? cur.calories : 0;

        // Meal-direction delta: hedef(öğün) − mevcut(öğün)
        const deltaMeal = desiredMealAbs - curK;
        window.logAlt('target calc', { gunAdi, ogunAdi, hedef, ogunKey, pct, desiredMealAbs, currentKcal: curK, deltaMeal });
        return { desiredKcal: desiredMealAbs, delta: deltaMeal, pct, currentKcal: curK };
      } catch (e) { console.warn('getDesiredMealKcalFromBadges error:', e); return null; }
    }

    // Aktif tabloda seçili gün başlığını döndürmek için yardımcı (mevcut bağlamda güvenli)
    function getActiveGunLabelSafe() {
      try {
        // Son işlenen gün başlığı çoğu renderer akışında mevcut. Alternatif: badge yakınından okunamaz.
        // Bu nedenle mevcut seçili haftadaki ilk görünen gün başlığını bulalım.
        const rows = document.querySelectorAll('#veritabaniAnaliziContent table tbody tr');
        for (const row of rows) {
          const td = row.querySelector('td');
          if (!td) continue;
          const txt = (td.textContent || '').trim();
          const isGun = /^📅\s*/.test(txt) || /\d+\.\s*Gün\s*\(/i.test(txt);
          if (isGun) return txt;
        }
      } catch {}
      return '';
    }

    // Şablonları istenen kcal'e en yakın olanlara göre sırala (aynı meal type içinde)
    function findTemplatesClosestToKcal(ogunAdi, desiredKcal) {
      if (!Array.isArray(mevcutSablonlar) || mevcutSablonlar.length === 0) return [];
      const type = normalizeOgunAdi(ogunAdi);
      const candidates = mevcutSablonlar.filter(s => normalizeOgunAdi(s.type) === type);
      const enriched = candidates.map(s => {
        const tm = calculateTemplateMacros(s);
        const diff = Math.abs((tm.calories || 0) - (desiredKcal || 0));
        return { ...s, templateMacros: tm, kcalDiff: diff };
      });
      enriched.sort((a,b) => (a.kcalDiff - b.kcalDiff));
      return enriched;
    }

    // === Hedef alternatifleri için kalıcı sıra/index helper'ları ===
    function _loadHedefCycleState() {
      try {
        const txt = (typeof localStorage !== 'undefined') ? localStorage.getItem('hedefCycleState') : null;
        if (txt) return JSON.parse(txt);
      } catch {}
      try { return (window.__hedefCycleState || {}); } catch { return {}; }
    }
    function _saveHedefCycleState(state) {
      try {
        if (typeof localStorage !== 'undefined') localStorage.setItem('hedefCycleState', JSON.stringify(state));
        else window.__hedefCycleState = state;
      } catch { try { window.__hedefCycleState = state; } catch {} }
    }

    // === Benzerlik alternatifleri için kalıcı sıra/index helper'ları ===
    function _loadSimilarityCycleState() {
      try {
        const txt = (typeof localStorage !== 'undefined') ? localStorage.getItem('similarityCycleState') : null;
        if (txt) return JSON.parse(txt);
      } catch {}
      try { return (window.__similarityCycleState || {}); } catch { return {}; }
    }
    function _saveSimilarityCycleState(state) {
      try {
        if (typeof localStorage !== 'undefined') localStorage.setItem('similarityCycleState', JSON.stringify(state));
        else window.__similarityCycleState = state;
      } catch { try { window.__similarityCycleState = state; } catch {} }
    }

    function _makeMealKey(gunAdi, ogunAdi) {
      return `${normalizeGunAdi(gunAdi)}_${normalizeOgunAdi(ogunAdi)}`;
    }
    function _makeOwnerKey(gunAdi, ogunAdi) {
      try {
        const hasta = (typeof getCurrentHasta === 'function') ? getCurrentHasta() : null;
        const haftIdx = (typeof getAktifHaftaIndex === 'function') ? getAktifHaftaIndex() : 0;
        const pid = (hasta && hasta.id) ? String(hasta.id) : 'default';
        return `${pid}|${haftIdx}|${_makeMealKey(gunAdi, ogunAdi)}`;
      } catch { return `default|0|${_makeMealKey(gunAdi, ogunAdi)}`; }
    }

    // Esnetilmiş arama: aynı tip yoksa öğle↔akşam veya kahvaltı↔ara; yine yoksa tüm tipler
    function findTemplatesClosestToKcalRelaxed(ogunAdi, desiredKcal) {
      const none = { list: [], level: 0, note: '' };
      if (!Array.isArray(mevcutSablonlar) || mevcutSablonlar.length === 0) return none;
      const type = normalizeOgunAdi(ogunAdi);
      const norm = (t) => normalizeOgunAdi(t);
      const enrichSort = (arr) => arr.map(s => { const tm = calculateTemplateMacros(s); return { ...s, templateMacros: tm, kcalDiff: Math.abs((tm.calories||0) - (desiredKcal||0)) }; }).sort((a,b)=>a.kcalDiff-b.kcalDiff);

      // 1) Aynı tip
      let c1 = mevcutSablonlar.filter(s => norm(s.type) === type);
      if (c1.length > 0) return { list: enrichSort(c1), level: 0, note: '' };

      // 2) Yakın tip eşleştirme
      const compatMap = {
        'öğle': ['öğle', 'akşam'],
        'akşam': ['akşam', 'öğle'],
        'kahvaltı': ['kahvaltı', 'ara'],
        'ara': ['ara', 'kahvaltı']
      };
      const allowed = compatMap[type] || [type];
      let c2 = mevcutSablonlar.filter(s => allowed.includes(norm(s.type)));
      // c2 includes empty if allowed contained only type; but we know type had none, so this tries the companion
      c2 = c2.filter(s => norm(s.type) !== type); // force the companion types
      if (c2.length > 0) return { list: enrichSort(c2), level: 1, note: 'Öğün tipi esnetildi (yakın tür).' };

      // 3) Tüm tipler
      const c3 = Array.from(mevcutSablonlar);
      if (c3.length > 0) return { list: enrichSort(c3), level: 2, note: 'Öğün tipi yok sayıldı (tüm şablonlar).' };

      return none;
    }

    // En yakın hedef (yön öncelikli): Aynı öğün tipi havuzunda |kcal − hedef| küçükten büyüğe,
    // ama sıralama önceliği: Mevcut↔Hedef arasında olanlar → Aynı yönde ama hedefi aşanlar → Ters yöndekiler.
    function findTemplatesForTargetDirectional(ogunAdi, targetInfo) {
      const fallback = { list: [], level: 0, note: '', stage: 'closest+direction' };
      if (!targetInfo || !isFinite(targetInfo.desiredKcal)) return fallback;

      // Şablonlar yüklü değilse boş döndür
      if (!Array.isArray(mevcutSablonlar) || mevcutSablonlar.length === 0) {
        console.warn('⚠️ findTemplatesForTargetDirectional: mevcutSablonlar boş veya tanımsız');
        return fallback;
      }

      const desired = Number(targetInfo.desiredKcal);
      const current = Number(targetInfo.currentKcal || 0);
      const delta = Number(targetInfo.delta || (desired - current));
      const wantIncrease = delta > 0;
      const typeKey = normalizedMealToKey(normalizeOgunAdi(ogunAdi));
      const normTypeKey = (t) => normalizedMealToKey(normalizeOgunAdi(t));

      // ŞABLON HAVUZU: SADECE AYNI ÖĞÜN TİPİ
      const sameType = mevcutSablonlar.filter(s => normTypeKey(s.type) === typeKey);
      if (sameType.length === 0) { window.logAlt('finder:closest', { ogunAdi, typeKey, desired, current, totalCandidates: 0 }); return fallback; }

      // Zenginleştir ve no-op (kcal eşit) olanları ele
      const enriched = sameType.map(s => {
        const tm = calculateTemplateMacros(s);
        const kcal = tm.calories || 0;
        const diff = Math.abs(kcal - desired);
        const inDirection = wantIncrease ? (kcal >= current) : (kcal <= current);
        const between = inDirection && (wantIncrease ? (kcal <= desired) : (kcal >= desired));
        const name = s.name || s.title || '';
        return { ...s, templateMacros: tm, kcal, diff, inDirection, between, name };
      }).filter(x => x.kcal !== current);

      if (enriched.length === 0) { window.logAlt('finder:closest', { ogunAdi, typeKey, desired, current, totalCandidates: 0, note: 'only-noop' }); return fallback; }

      // Grup önceliği: between(A) → inDirection&!between(B) → !inDirection(C)
      const groupA = [];
      const groupB = [];
      const groupC = [];
      for (const x of enriched) {
        if (x.between) groupA.push(x);
        else if (x.inDirection) groupB.push(x);
        else groupC.push(x);
      }

      const cmp = (a, b) => (a.diff - b.diff) || (a.kcal - b.kcal) || String(a.name||'').localeCompare(String(b.name||''), 'tr');
      groupA.sort(cmp); groupB.sort(cmp); groupC.sort(cmp);
      const result = [...groupA, ...groupB, ...groupC];

      window.logAlt('finder:closest', {
        ogunAdi,
        typeKey,
        desired,
        current,
        totalCandidates: result.length,
        counts: { between: groupA.length, directionBeyond: groupB.length, opposite: groupC.length },
        top: result.slice(0, 10).map(x => ({ id: x.id, name: x.name, kcal: x.kcal, diff: x.diff, grp: x.between ? 'A' : (x.inDirection ? 'B' : 'C') }))
      });
      return { list: result, level: 0, note: '', stage: 'closest+direction' };
    }

    // Modal: hedef bazlı alternatifleri göster
    async function showTargetMealAlternatives(gunAdi, ogunAdi) {
      try { gunAdi = decodeURIComponent(gunAdi); } catch {}
      try { ogunAdi = decodeURIComponent(ogunAdi); } catch {}
      // Şablonlar yüklü değilse yükle
      try { if (!Array.isArray(mevcutSablonlar) || mevcutSablonlar.length === 0) { if (typeof sablonlariYukle === 'function') await sablonlariYukle(); } } catch {}
      // Mevcut ve desired
      const mevcut = getCurrentMealMacros(gunAdi, ogunAdi);
      if (!mevcut || (mevcut.foods||[]).length === 0) {
        showToast('⚠️ Bu öğünde henüz eşleştirilmiş yemek yok! Önce eşleştirin.', 'warning', 3000);
        return;
      }
      // Hedef kalori temelli şablonları bul
      const uygunSablonlar = findCompatibleMealTemplates(ogunAdi, mevcut);
      if (!uygunSablonlar || uygunSablonlar.length === 0) {
        if (window.__targetPreconditionError) {
          // Ön-koşul hatası özel mesajı zaten gösterildi
          return;
        }
        const normalizedOgun = normalizeOgunAdi(ogunAdi);
        showToast(`⚠️ ${normalizedOgun} türünde şablon bulunamadı!`, 'warning', 3000);
        return;
      }
      
      // En iyi 10 tanesini al
      const list = uygunSablonlar.slice(0, 10);

      // Bu modalın sırasını hızlı uygula için kalıcı olarak kaydet (hasta/hafta/öğün bazlı)
      try {
        const state = _loadHedefCycleState();
        const ownerKey = _makeOwnerKey(gunAdi, ogunAdi);
        const ids = list.map(s => (s.id || s.name || s.displayName || ''));
        state[ownerKey] = state[ownerKey] || { ids: [], index: -1 };
        state[ownerKey].ids = ids;
        // Eğer uygulanmış id varsa index'i hizala
        try {
          const haftalar = (typeof getHaftaListesi === 'function') ? getHaftaListesi() : null;
          const seciliIndex = (typeof getAktifHaftaIndex === 'function') ? getAktifHaftaIndex() : 0;
          const hafta = Array.isArray(haftalar) ? haftalar[seciliIndex] : null;
          const appliedKey = `target_meal_${normalizeGunAdi(gunAdi)}_${normalizeOgunAdi(ogunAdi)}`;
          const appliedId = hafta && hafta._uygulananOgunSablonlari ? hafta._uygulananOgunSablonlari[appliedKey] : null;
          if (appliedId) {
            const curIdx = ids.findIndex(x => x === appliedId);
            if (curIdx >= 0) state[ownerKey].index = curIdx;
          }
        } catch {}
        _saveHedefCycleState(state);
      } catch {}
      
  // Hedef kalori bilgileri (ön-koşullar daha önce kontrol edildi)
  const hedefKcalEl2 = document.getElementById('hedefKcalBadgeValue');
  const hedefBadgeText2 = hedefKcalEl2 ? (hedefKcalEl2.textContent || '') : '';
  const gunlukHedefKalori = Number(String(hedefBadgeText2).replace(/[^0-9.]/g, ''));
  const activeWeekStats = (typeof getActiveWeekAverageStats === 'function') ? getActiveWeekAverageStats() : null;
  const ortalamKalori = (activeWeekStats && isFinite(activeWeekStats.kalori)) ? Number(activeWeekStats.kalori) : NaN;
      
      const hedefKalori = calculateTargetMealCalories(gunlukHedefKalori, ortalamKalori, mevcut.calories);
      const percentageChange = (gunlukHedefKalori - ortalamKalori) / ortalamKalori;
      
      window.logAlt('modal:list', {
        gunAdi,
        ogunAdi,
        hedefKalori: hedefKalori,
        mevcutKalori: mevcut.calories,
        percentageChange: percentageChange,
        items: list.map(s => ({ 
          id: s.id, 
          name: s.name, 
          kcal: s.templateMacros?.calories || 0, 
          targetProximity: s.targetProximity || 0
        }))
      });

      const modalId = 'hedefOgunAlternatifModal';
      let modal = document.getElementById(modalId);
      if (!modal) {
        modal = document.createElement('div');
        modal.id = modalId;
        modal.style.cssText = 'display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:10008;';
        modal.addEventListener('click', (e) => { if (e.target === modal) modal.style.display = 'none'; });
        document.body.appendChild(modal);
      }
  const header = `🎯 ${normalizeOgunAdi(ogunAdi).toUpperCase()} · Hedef: ${hedefKalori.toFixed(0)} kcal (Δ: ${(percentageChange * 100).toFixed(1)}% değişim)`;
      const safeGun = encodeURIComponent(gunAdi);
      const safeOgun = encodeURIComponent(ogunAdi);
      modal.innerHTML = `
        <div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:94%; max-width:860px; background:#fff; border-radius:10px; overflow:hidden;">
          <div style="padding:14px 16px; background:linear-gradient(135deg,#0d6efd,#20c997); color:#fff; display:flex; justify-content:space-between; align-items:center;">
            <div style="font-weight:700;">${header}</div>
            <button onclick="document.getElementById('${modalId}').style.display='none'" style="background:#00000022; color:#fff; border:none; border-radius:6px; padding:6px 10px; cursor:pointer;">Kapat</button>
          </div>
          <div style="padding:14px 16px; max-height:62vh; overflow:auto;">
            <div style="margin-bottom:10px; font-size:12px; color:#6c757d;">Mevcut: <strong>${mevcut.calories.toFixed(0)} kcal</strong> · P ${mevcut.protein.toFixed(1)} · K ${mevcut.carbs.toFixed(1)} · Y ${mevcut.fat.toFixed(1)}</div>
            ${list.map(s => {
              const kcal = s.templateMacros?.calories || 0;
              const diff = Math.round((kcal - hedefKalori));
              const diffBadge = `<span style="font-size:11px; padding:2px 6px; border-radius:10px; background:${diff===0?'#d1e7dd':(diff>0?'#fff3cd':'#f8d7da')}; color:${diff===0?'#0f5132':(diff>0?'#664d03':'#842029')};">${diff>0?`+${diff}`:diff} kcal</span>`;
              return `
                <div style="border:1px solid #e9ecef; border-radius:8px; margin:8px 0; overflow:hidden;">
                  <div style="display:flex; justify-content:space-between; align-items:center; padding:10px 12px; background:#f8f9fa;">
                    <div>
                      <div style="font-weight:600; font-size:14px;">${s.displayName || s.name}</div>
                      <div style="font-size:12px; color:#6c757d;">📊 ${kcal} kcal · P ${(s.templateMacros.protein||0).toFixed(1)} · K ${(s.templateMacros.carbs||0).toFixed(1)} · Y ${(s.templateMacros.fat||0).toFixed(1)} · ${diffBadge} · 🎯 Yakınlık: ${(s.targetProximity||0).toFixed(0)}</div>
                    </div>
                    <div>
                      <button onclick="selectTargetMealAlternative('${safeGun}','${safeOgun}','${s.id}')" style="background:#198754; color:#fff; border:none; border-radius:6px; padding:8px 12px; cursor:pointer;">Uygula</button>
                    </div>
                  </div>
                  <div style="padding:8px 12px; font-size:12px; color:#6c757d;">${(s.foods||[]).map(f=>f.foodName||f.name||f.originalText||'—').join(', ')}</div>
                </div>
              `;
            }).join('')}
          </div>
        </div>`;
      modal.style.display = 'block';
    }

    // 🎯⚡ HEDEF KALORI TABANLI: En uygun şablonu modal ile aynı sıralamada uygula (modalsız)
    async function applyBestTargetMealAlternative(gunAdi, ogunAdi) {
      // Çoklu tıklama koruması
      const key = `targetApplying_${gunAdi}_${ogunAdi}`;
      if (window[key]) {
        console.log('⚠️ Hedef alternatifi zaten uygulanıyor, bekleyin...');
        return;
      }
      window[key] = true;
      
      try {
        try { gunAdi = decodeURIComponent(gunAdi); } catch {}
        try { ogunAdi = decodeURIComponent(ogunAdi); } catch {}
        console.log('🎯⚡ Hedef kalori tabanlı hızlı alternatif uygulanıyor:', gunAdi, ogunAdi);

      // Şablonları yükle
      if (!mevcutSablonlar || mevcutSablonlar.length === 0) {
        await sablonlariYukle();
      }
      if (!mevcutSablonlar || mevcutSablonlar.length === 0) {
        showToast('⚠️ Henüz öğün şablonu yok! Önce bir öğünü 💾 Kaydet butonuyla şablon olarak kaydedin.', 'warning', 4000);
        return;
      }

      // Mevcut öğün makroları
      const mevcutOgunMakrolari = getCurrentMealMacros(gunAdi, ogunAdi);
      if (!mevcutOgunMakrolari || mevcutOgunMakrolari.foods.length === 0) {
        showToast('⚠️ Bu öğünde henüz eşleştirilmiş yemek yok! Önce yemekleri eşleştirin.', 'warning', 4000);
        return;
      }

      // Modal ile AYNI ALGORİTMA: findCompatibleMealTemplates
      const uygunSablonlar = findCompatibleMealTemplates(ogunAdi, mevcutOgunMakrolari);
      if (!uygunSablonlar || uygunSablonlar.length === 0) {
        const normalizedOgun = normalizeOgunAdi(ogunAdi);
        showToast(`⚠️ ${normalizedOgun} türünde şablon bulunamadı!`, 'warning', 3000);
        return;
      }

      // Hedef mod için persistent cycle state'i kullan: modal sırasıyla senkron ilerle
      let secilecek = null;
      let nextIndex = 0;
      let topListIds = uygunSablonlar.slice(0, 10).map(s => (s.id || s.name || s.displayName || ''));
      try {
        const state = _loadHedefCycleState();
        const ownerKey = _makeOwnerKey(gunAdi, ogunAdi);
        if (!state[ownerKey] || !Array.isArray(state[ownerKey].ids) || state[ownerKey].ids.length === 0) {
          // State yoksa oluştur
          state[ownerKey] = { ids: topListIds, index: -1 };
        } else {
          // Mevcut listedeki id'lerle modal state'i eşitle (eğer modal daha güncelse showTargetMealAlternatives zaten yazmıştır)
          topListIds = state[ownerKey].ids.slice(0);
        }
        // Bir sonrakine geç
        nextIndex = ((typeof state[ownerKey].index === 'number' ? state[ownerKey].index : -1) + 1) % topListIds.length;
        const nextId = topListIds[nextIndex];
        secilecek = uygunSablonlar.find(s => (s.id && s.id === nextId) || s.name === nextId || s.displayName === nextId) || uygunSablonlar[0];
        // Index'i kaydet
        state[ownerKey].index = nextIndex;
        _saveHedefCycleState(state);
      } catch {}

      // Eğer state mekanizması yoksa fallback
      if (!secilecek) { secilecek = uygunSablonlar[0]; nextIndex = 0; topListIds = uygunSablonlar.slice(0,10).map(s=>s.id||s.name||s.displayName||''); }
      
      // 🎯 HEDEF KALORI ODAKLI TOAST MESAJI
      const kaloriDegisimi = secilecek.templateMacros.calories - mevcutOgunMakrolari.calories;
      const kaloriYon = kaloriDegisimi > 0 ? '📈' : kaloriDegisimi < 0 ? '📉' : '➡️';
      const kaloriText = kaloriDegisimi > 0 ? `+${kaloriDegisimi.toFixed(0)}` : 
                       kaloriDegisimi < 0 ? `${kaloriDegisimi.toFixed(0)}` : '±0';
      
      const mutlakFark = Math.abs(kaloriDegisimi);
  const hedefBilgi = ` 🎯 Hedef farkı: ${mutlakFark.toFixed(0)} kcal · Yakınlık: ${(secilecek.targetProximity||mutlakFark).toFixed(0)} kcal`;
      
  await replaceMealWithTemplate(gunAdi, ogunAdi, secilecek, 'target_meal');
    showToast(`✅ ${ogunAdi}: ${secilecek.displayName || secilecek.name} (${kaloriYon} ${kaloriText} kcal)${hedefBilgi} [${(nextIndex+1)}/${Math.min(10, topListIds.length)}]`, 'success', 4000);
      } finally {
        // Çoklu tıklama korumasını sıfırla
        window[key] = false;
      }
    }

    // 🔄⚡ BENZERLİK TABANLI: En benzer makrolu şablonu modal ile aynı sıralamada uygula (modalsız)
    async function applyBestSimilarityMealAlternative(gunAdi, ogunAdi) {
      // Çoklu tıklama koruması
      const key = `similarityApplying_${gunAdi}_${ogunAdi}`;
      if (window[key]) {
        console.log('⚠️ Benzerlik alternatifi zaten uygulanıyor, bekleyin...');
        return;
      }
      window[key] = true;
      
      try {
        try { gunAdi = decodeURIComponent(gunAdi); } catch {}
        try { ogunAdi = decodeURIComponent(ogunAdi); } catch {}
        console.log('🔄⚡ En İyi butonu - parametreler:', { gunAdi, ogunAdi });
        
        // Boş parametreleri kontrol et
        if (!gunAdi || !ogunAdi) {
          console.error('🔄⚡ Hata: Gün veya öğün parametresi boş!', { gunAdi, ogunAdi });
          showToast('⚠️ Gün veya öğün bilgisi eksik!', 'error', 3000);
          return;
        }
        
        console.log('🔄⚡ Benzerlik tabanlı hızlı alternatif uygulanıyor:', gunAdi, ogunAdi);

        // Şablonları yükle
        if (!mevcutSablonlar || mevcutSablonlar.length === 0) {
          await sablonlariYukle();
        }
        if (!mevcutSablonlar || mevcutSablonlar.length === 0) {
          showToast('⚠️ Henüz öğün şablonu yok! Önce bir öğünü 💾 Kaydet butonuyla şablon olarak kaydedin.', 'warning', 4000);
          return;
        }

        // Mevcut öğün makroları
        const mevcutOgunMakrolari = getCurrentMealMacros(gunAdi, ogunAdi);
        console.log('🔄 Mevcut öğün makroları:', mevcutOgunMakrolari);
        
        if (!mevcutOgunMakrolari || mevcutOgunMakrolari.foods.length === 0) {
          showToast('⚠️ Bu öğünde henüz eşleştirilmiş yemek yok! Önce yemekleri eşleştirin.', 'warning', 4000);
          return;
        }      // Modal ile AYNI ALGORİTMA: findSimilarMealTemplates
      const benzerSablonlar = findSimilarMealTemplates(ogunAdi, mevcutOgunMakrolari);
      if (!benzerSablonlar || benzerSablonlar.length === 0) {
        const normalizedOgun = normalizeOgunAdi(ogunAdi);
        showToast(`⚠️ ${normalizedOgun} türünde şablon bulunamadı!`, 'warning', 3000);
        return;
      }

      // Benzerlik mod için persistent cycle state'i kullan: modal sırasıyla senkron ilerle
      let secilecek = null;
      let nextIndex = 0;
      let topListIds = benzerSablonlar.slice(0, 10).map(s => {
        // Template ID önceliği: id > name > displayName
        const id = s.id || s.name || s.displayName || `template_${Date.now()}_${Math.random()}`;
        console.log('🔄 Template ID oluşturuluyor:', s.name, '→', id);
        return id;
      });
      console.log('🔄 Mevcut şablon listesi:', topListIds);
      
      try {
        const state = _loadSimilarityCycleState();
        const ownerKey = _makeOwnerKey(gunAdi, ogunAdi);
        console.log('🔄 State yüklendi:', state, 'Owner key:', ownerKey);
        
        if (!state[ownerKey] || !Array.isArray(state[ownerKey].ids) || state[ownerKey].ids.length === 0) {
          // State yoksa oluştur
          state[ownerKey] = { ids: topListIds, index: -1 };
          console.log('🔄 Yeni state oluşturuldu:', state[ownerKey]);
        } else {
          // Mevcut listedeki id'lerle modal state'i eşitle - ANCAK mevcut şablon listesiyle senkronize et
          if (JSON.stringify(state[ownerKey].ids) !== JSON.stringify(topListIds)) {
            console.log('🔄 Şablon listesi değişmiş, güncelleniyor...');
            console.log('  Eski:', state[ownerKey].ids);
            console.log('  Yeni:', topListIds);
            state[ownerKey].ids = topListIds;
            state[ownerKey].index = -1; // Reset index when template list changes
          }
          console.log('🔄 Mevcut state kullanılıyor:', state[ownerKey]);
        }
        
        // Bir sonrakine geç
        const currentIndex = (typeof state[ownerKey].index === 'number' ? state[ownerKey].index : -1);
        nextIndex = (currentIndex + 1) % topListIds.length;
        console.log('🔄 Index geçişi:', currentIndex, '→', nextIndex, 'Total:', topListIds.length);
        
        const nextId = topListIds[nextIndex];
        console.log('🔄 Seçilecek ID:', nextId);
        
        // Template bulma mantığını geliştirelim
        secilecek = benzerSablonlar.find(s => {
          const templateId = s.id || s.name || s.displayName || '';
          const match = templateId === nextId;
          if (match) console.log('🔄 Template eşleşmesi bulundu:', s.name);
          return match;
        });
        
        if (!secilecek) {
          console.warn('🔄 Template ID ile eşleşme bulunamadı, fallback kullanılıyor');
          secilecek = benzerSablonlar[nextIndex] || benzerSablonlar[0];
        }
        
        console.log('🔄 Seçilen şablon:', secilecek ? secilecek.name : 'null');
        
        // Index'i kaydet
        state[ownerKey].index = nextIndex;
        _saveSimilarityCycleState(state);
        console.log('🔄 State kaydedildi:', state[ownerKey]);
      } catch (e) {
        console.error('🔄 State hatası:', e);
      }

      // Eğer state mekanizması yoksa fallback
      if (!secilecek) { secilecek = benzerSablonlar[0]; nextIndex = 0; topListIds = benzerSablonlar.slice(0,10).map(s=>s.id||s.name||s.displayName||''); }
      
      // 🔄 BENZERLİK ODAKLI TOAST MESAJI
      const kaloriDegisimi = secilecek.templateMacros.calories - mevcutOgunMakrolari.calories;
      const kaloriYon = kaloriDegisimi > 0 ? '📈' : kaloriDegisimi < 0 ? '📉' : '➡️';
      const kaloriText = kaloriDegisimi > 0 ? `+${kaloriDegisimi.toFixed(0)}` : 
                       kaloriDegisimi < 0 ? `${kaloriDegisimi.toFixed(0)}` : '±0';
      
      const benzerlikSkoru = secilecek.similarityScore || 0;
      const benzerlikBilgi = ` 🔄 Benzerlik: ${benzerlikSkoru.toFixed(1)}%`;
      
      await replaceMealWithTemplate(gunAdi, ogunAdi, secilecek, 'sim_meal');
      showToast(`✅ ${ogunAdi}: ${secilecek.displayName || secilecek.name} (${kaloriYon} ${kaloriText} kcal)${benzerlikBilgi} [${(nextIndex+1)}/${Math.min(10, topListIds.length)}]`, 'success', 4000);
      } finally {
        // Çoklu tıklama korumasını sıfırla
        window[key] = false;
      }
    }

    // 🔄 BENZERLİK TABANLI: Modal seçim fonksiyonu
    async function selectSimilarityMealAlternative(gunAdi, ogunAdi, templateId) {
      try { gunAdi = decodeURIComponent(gunAdi); } catch {}
      try { ogunAdi = decodeURIComponent(ogunAdi); } catch {}
      console.log('🔄 Benzerlik tabanlı şablon seçildi:', gunAdi, ogunAdi, templateId);

      // Şablonu bul
      const secilenSablon = mevcutSablonlar.find(s => 
        (s.id && s.id === templateId) || 
        s.name === templateId || 
        s.displayName === templateId
      );
      
      if (!secilenSablon) {
        showToast('⚠️ Seçilen şablon bulunamadı!', 'error', 3000);
        return;
      }

      // Cycle state'i güncelle
      try {
        const state = _loadSimilarityCycleState();
        const ownerKey = _makeOwnerKey(gunAdi, ogunAdi);
        if (state[ownerKey] && Array.isArray(state[ownerKey].ids)) {
          const foundIndex = state[ownerKey].ids.findIndex(id => 
            id === templateId || 
            id === secilenSablon.name || 
            id === secilenSablon.displayName
          );
          if (foundIndex >= 0) {
            state[ownerKey].index = foundIndex;
            _saveSimilarityCycleState(state);
          }
        }
      } catch {}

      // Makro bilgisi hesapla
      const mevcutOgunMakrolari = getCurrentMealMacros(gunAdi, ogunAdi);
      let toastEk = '';
      if (mevcutOgunMakrolari && secilenSablon.templateMacros) {
        const kaloriDegisimi = secilenSablon.templateMacros.calories - mevcutOgunMakrolari.calories;
        const kaloriYon = kaloriDegisimi > 0 ? '📈' : kaloriDegisimi < 0 ? '📉' : '➡️';
        const kaloriText = kaloriDegisimi > 0 ? `+${kaloriDegisimi.toFixed(0)}` : 
                         kaloriDegisimi < 0 ? `${kaloriDegisimi.toFixed(0)}` : '±0';
        toastEk = ` (${kaloriYon} ${kaloriText} kcal)`;
      }

      // Şablonu uygula
      await replaceMealWithTemplate(gunAdi, ogunAdi, secilenSablon, 'sim_meal');
      
      // Modal'ı kapat ve toast göster
      const modal = document.getElementById('similarityMealAlternativeModal');
      if (modal) modal.style.display = 'none';
      
      showToast(`✅ ${ogunAdi}: ${secilenSablon.displayName || secilenSablon.name}${toastEk}`, 'success', 3000);
    }

    // === ŞABLON KAYDETME MODAL SİSTEMİ ===
    
    // Modal'ı aç ve verilerle doldur

  // Tolerans: hedefin %4’ü veya en az 30 kcal






    // === ŞABLON KAYDETME MODAL SİSTEMİ ===
    
    // Modal'ı aç ve verilerle doldur
    async function sablonKaydetModalAc(ogunAdi, ogunYemekleri, hastaBilgileri = null) {
      const modal = document.getElementById('sablonKaydetModal');
      // Temizlik: önceki açılıştan kalma wrap ve durumları sıfırla
      try {
        modal.__duplicateTemplate = null;
        if (modal.ogunYemekleri) modal.ogunYemekleri = [];
        if (modal.ogunYemekleriSelected) modal.ogunYemekleriSelected = [];
        const oldWraps = modal.querySelectorAll('#tplSelectionWrap');
        oldWraps.forEach(el => el.remove());
      } catch {}
      // Eğer hastaBilgileri eksikse aktif sekmeden türetmeyi ve/veya tamamlamayı dene
      try {
        const idx = (typeof getAktifHaftaIndex === 'function') ? getAktifHaftaIndex() : null;
        const hasta = (typeof window !== 'undefined') ? window.seciliHasta : null;
        const hafta = (hasta && idx !== null && Array.isArray(hasta.haftalar)) ? hasta.haftalar[idx] : null;

        // Yardımcı: hafta.baslangic/bitis üzerinden "1-7 EYLÜL" veya "29 AĞUSTOS - 4 EYLÜL" üret
        const buildDateRangeFromHafta = (h) => {
          if (!h) return '';
          try {
            const bas = h.baslangic ? new Date(h.baslangic + 'T00:00:00') : null;
            const bit = h.bitis ? new Date(h.bitis + 'T00:00:00') : null;
            if (!bas || !bit || isNaN(bas) || isNaN(bit)) return '';
            const d1 = bas.getDate();
            const d2 = bit.getDate();
            const ay1 = bas.toLocaleDateString('tr-TR', { month: 'long' }).toLocaleUpperCase('tr-TR');
            const ay2 = bit.toLocaleDateString('tr-TR', { month: 'long' }).toLocaleUpperCase('tr-TR');
            if (bas.getMonth() === bit.getMonth() && bas.getFullYear() === bit.getFullYear()) {
              return `${d1}-${d2} ${ay1}`;
            } else {
              return `${d1} ${ay1} - ${d2} ${ay2}`;
            }
          } catch { return ''; }
        };

        // Yardımcı: PDF adından tarih aralığı çıkar
        const parseDateRangeFromPdf = (pdfName) => {
          if (!pdfName) return '';
          try {
            const name = String(pdfName).trim();
            // Örn: "AYŞEGÜL FAROOQ 8-14 EYLÜL 2. HAFTA.pdf"
            const m1 = name.match(/^(.+?)\s+(\d{1,2}-\d{1,2}\s+[A-ZÜÇĞÖŞİÜÇĞÖŞİ]+(?:\s+\d{4})?)\s+(\d+)\.\s*HAFTA(?:\.pdf)?$/i);
            if (m1) return m1[2].toUpperCase();
            // Alternatif: boşlukla ayrık parçalar içinden 1-7 AY formatını topla
            const core = name.replace(/\.pdf$/i, '');
            const parts = core.split(/\s+/);
            let tarihParts = [];
            let started = false;
            for (const p of parts) {
              if (/^\d{1,2}-\d{1,2}$/.test(p) || started) { started = true; tarihParts.push(p); }
            }
            return tarihParts.length ? tarihParts.join(' ').toUpperCase() : '';
          } catch { return ''; }
        };

        // Yardımcı: başka haftalardan yola çıkarak bu haftanın tarih aralığını tahmin et
        const inferDateRangeFromOtherWeeks = (hasta, targetNo) => {
          try {
            if (!hasta || !Array.isArray(hasta.haftalar) || !targetNo) return '';
            // Temel alınacak bir hafta bul (baslangic veya bitis içeren)
            const withDates = hasta.haftalar.filter(w => (w && (w.baslangic || w.bitis) && (w.haftaNo || w.haftaNo === 0)));
            if (withDates.length === 0) return '';
            // Hedefe en yakın hafta numarası olanı seç
            let base = withDates[0];
            let minDiff = Math.abs((base.haftaNo || 0) - targetNo);
            for (const w of withDates) {
              const d = Math.abs((w.haftaNo || 0) - targetNo);
              if (d < minDiff) { base = w; minDiff = d; }
            }
            const baseStart = base.baslangic ? new Date(base.baslangic + 'T00:00:00') : (base.bitis ? new Date(new Date(base.bitis + 'T00:00:00').getTime() - 6*24*60*60*1000) : null);
            if (!baseStart || isNaN(baseStart)) return '';
            const deltaWeeks = (targetNo - (base.haftaNo || targetNo));
            const start = new Date(baseStart.getTime() + deltaWeeks * 7 * 24*60*60*1000);
            const end = new Date(start.getTime() + 6*24*60*60*1000);
            const d1 = start.getDate();
            const d2 = end.getDate();
            const m1 = start.toLocaleDateString('tr-TR', { month: 'long' }).toLocaleUpperCase('tr-TR');
            const m2 = end.toLocaleDateString('tr-TR', { month: 'long' }).toLocaleUpperCase('tr-TR');
            if (start.getMonth() === end.getMonth() && start.getFullYear() === end.getFullYear()) return `${d1}-${d2} ${m1}`;
            return `${d1} ${m1} - ${d2} ${m2}`;
          } catch { return ''; }
        };

        const eksik = !hastaBilgileri || !hastaBilgileri.isim || !hastaBilgileri.tarihAraligi || !hastaBilgileri.haftaNo;
        if (eksik && hasta && hafta) {
          // Gün adını UI'dan tahmin et (varsa). Yoksa boş bırak.
          let gunFromUi = '';
          try {
            const label = (typeof getActiveGunLabelSafe === 'function') ? getActiveGunLabelSafe() : '';
            const days = ['Pazartesi','Salı','Çarşamba','Perşembe','Cuma','Cumartesi','Pazar'];
            for (const d of days) { if (label && label.toLocaleLowerCase('tr-TR').includes(d.toLocaleLowerCase('tr-TR'))) { gunFromUi = d; break; } }
          } catch {}
          // Header DOM'dan hasta adı, tarih ve hafta no çıkar
          const parseHastaHeaderDom = () => {
            try {
              const el = document.getElementById('pdfHastaInfo');
              if (!el) {
                console.log('🔍 pdfHastaInfo elementi bulunamadı');
                return null;
              }
              const raw = (el.textContent || '').trim();
              console.log('🔍 Header DOM raw text:', raw);
              const parts = raw.split('•').map(s => s.trim()).filter(Boolean);
              console.log('🔍 Header DOM parts:', parts);
              if (parts.length < 3) {
                console.log('🔍 Header DOM parça sayısı yetersiz:', parts.length);
                return null;
              }
              const isim = parts[0] || '';
              const tarih = parts[1] || '';
              const haftaStr = parts[2] || '';
              const haftaNoMatch = haftaStr.match(/(\d+)/);
              const haftaNo = haftaNoMatch ? parseInt(haftaNoMatch[1]) : null;
              console.log('🔍 Header DOM parse sonuç:', { isim, tarih, haftaNo });
              return { isim, tarihAraligi: tarih, haftaNo };
            } catch (e) { 
              console.log('🔍 Header DOM parse hatası:', e);
              return null; 
            }
          };
          // Analiz gövdesinden tarih aralığı ara
          const scanAnalysisForDateRange = () => {
            try {
              const root = document.getElementById('veritabaniAnaliziContent') || document.body;
              const txt = (root.textContent || '');
              const m = txt.match(/\b(\d{1,2})\s*[–-]\s*(\d{1,2})\s+([A-Za-zÇĞIİÖŞÜçğıöşü]+)(?:\s+(\d{4}))?\b/);
              if (!m) return '';
              const gun1 = m[1], gun2 = m[2], ay = m[3];
              const yil = m[4] ? ` ${m[4]}` : '';
              return `${gun1}-${gun2} ${ay}${yil}`.toLocaleUpperCase('tr-TR');
            } catch { return ''; }
          };
          let tarihAraligiSurekli = (hastaBilgileri && hastaBilgileri.tarihAraligi)
            ? hastaBilgileri.tarihAraligi
            : (hafta.tarihAraligi || buildDateRangeFromHafta(hafta));
          // PDF adından dene
          if (!tarihAraligiSurekli && (hafta.pdfOrijinalIsim || hafta.pdfName)) {
            tarihAraligiSurekli = parseDateRangeFromPdf(hafta.pdfOrijinalIsim || hafta.pdfName);
          }
          // Diğer haftalardan tahmin et
          if (!tarihAraligiSurekli) {
            const hedefNo = (hastaBilgileri && hastaBilgileri.haftaNo) ? hastaBilgileri.haftaNo : ((typeof idx === 'number') ? (idx + 1) : (hafta?.haftaNo || 0));
            tarihAraligiSurekli = inferDateRangeFromOtherWeeks(hasta, Number(hedefNo) || 0);
          }
          // Header DOM'dan zorla al
          const headerInfo = parseHastaHeaderDom();
          console.log('🔍 headerInfo:', headerInfo);
          if (!tarihAraligiSurekli && headerInfo && headerInfo.tarihAraligi && !/tarih bilgisi yok/i.test(headerInfo.tarihAraligi)) {
            tarihAraligiSurekli = headerInfo.tarihAraligi;
            console.log('🔍 Header DOM\'dan tarih alındı:', tarihAraligiSurekli);
          }
          // Analiz metninden bul
          if (!tarihAraligiSurekli) {
            const found = scanAnalysisForDateRange();
            if (found) {
              tarihAraligiSurekli = found;
              console.log('🔍 Analiz taramasından tarih bulundu:', found);
            }
          }

          console.log('🔍 Final tarihAraligiSurekli:', tarihAraligiSurekli);

          const birlesik = {
            ...(hastaBilgileri || {}),
            isim: (hastaBilgileri && hastaBilgileri.isim) ? hastaBilgileri.isim : ((headerInfo && headerInfo.isim) || hasta.isim || hasta.ad || ''),
            tarihAraligi: tarihAraligiSurekli,
            haftaNo: (hastaBilgileri && hastaBilgileri.haftaNo) ? hastaBilgileri.haftaNo : ((headerInfo && headerInfo.haftaNo) || ((typeof idx === 'number') ? (idx + 1) : (hafta?.haftaNo || ''))),
            gunAdi: (hastaBilgileri && hastaBilgileri.gunAdi) ? hastaBilgileri.gunAdi : gunFromUi
          };
          console.log('🔍 Final birlesik hastaBilgileri:', birlesik);
          hastaBilgileri = birlesik;
        }
      } catch {}
      // --- Yardımcı: Türkçe normalize ---
      const normTr = (txt) => {
        return String(txt || '')
          .toLowerCase()
          .replace(/i̇/g, 'i')
          .replace(/ı/g, 'i')
          .replace(/ğ/g, 'g')
          .replace(/ü/g, 'u')
          .replace(/ş/g, 's')
          .replace(/ö/g, 'o')
          .replace(/ç/g, 'c')
          .replace(/[^a-z0-9\s]/g, ' ')
          .replace(/\s+/g, ' ')
          .trim();
      };
      // --- Yardımcı: Yemek sınıfı tespiti ---
      const classifyFood = (yemek) => {
        const f = yemek || {};
        const n = normTr(f.foodName || f.originalText || '');
        const cat = normTr(f.category || f.kategori || '');
        const tags = (Array.isArray(f.tags) ? f.tags : []).map(normTr);
        const haystack = `${n} ${cat} ${tags.join(' ')}`;
        // Ekmek/hamur işi
        if (/\b(ekmek|lavash|lavas|tortilla|yufka|pide|bazlama|simit|tost|sandvic|sandwich|galeta)\b/.test(haystack)) return 'bread';
        // Çorba
        if (/\b(corba|çorba)\b/.test(haystack)) return 'soup';
        // Pilav/Makarna/Tahıl
        if (/\b(pilav|makarna|spagetti|bulgur|kinoa|karabugday|pirinc|erişte|eriste)\b/.test(haystack)) return 'carb';
        // Salata/Meze
        if (/\b(salata|meze|ezme)\b/.test(haystack)) return 'salad';
        // Süt/Yoğurt
        if (/\b(yogurt|yoğurt|ayran|kefir|sut|süt|peynir|labne|kefir)\b/.test(haystack)) return 'dairy';
        // İçecek
        if (/\b(su|cay|çay|kahve|coffee|tea)\b/.test(haystack)) return 'beverage';
        // Ana yemek: et/tavuk/balık/köfte/kebap/ızgara/sote/güveç
        if (/\b(et|tavuk|balik|balık|kofte|köfte|kebap|izgara|sote|guvec|güveç|yahni|kavurma)\b/.test(haystack)) return 'main';
        // Tatlı/Şeker
        if (/\b(tatli|tatlı|seker|şeker|brownie|pasta|kek|kurabiye|baklava|sutlac|sütlaç|kazandibi)\b/.test(haystack)) return 'dessert';
        // Meyve
        if (/\b(meyve|elma|armut|muz|cilek|çilek|portakal|mandalina|kivi|uzum|üzüm)\b/.test(haystack)) return 'fruit';
        // Varsayılan
        return 'other';
      };
      // Gelen ogunYemekleri öğelerine basit sınıf/kat ekle (görünürlük ve analiz için)
      const enrichedFoods = ogunYemekleri.map(y => ({
        ...y,
        category: y.category || y.kategori || (y.eslesenYemek && (y.eslesenYemek.category || y.eslesenYemek.kategori)) || null,
        tags: y.tags || (y.eslesenYemek && (y.eslesenYemek.tags || y.eslesenYemek.etiketler)) || [],
        cls: classifyFood(y)
      }));
      // Çakışma analizi
      const countBy = (arr, key) => arr.reduce((m, x) => (m[x[key]] = (m[x[key]]||0)+1, m), {});
      const clsCounts = countBy(enrichedFoods, 'cls');
      const hasDupMain = (clsCounts.main || 0) > 1;
      const hasDupBread = (clsCounts.bread || 0) > 1;
      const hasDupSoup = (clsCounts.soup || 0) > 1;
      // Önerilen seçim: her sınıfta ilk öğeyi tut, fazlaları pasifleştir
      const keepIndexByClass = {};
      const defaultSelected = enrichedFoods.map((f, idx) => {
        if (!keepIndexByClass[f.cls]) { keepIndexByClass[f.cls] = idx; return true; }
        // bread/main/soup sınıflarında fazlaları kapat; diğerlerini açık bırak
        if (['main','bread','soup'].includes(f.cls)) return false;
        return true;
      });
      // Yardımcılar: duplicate tespiti
      const normSimple = (txt) => {
        if (typeof normalizeTrSimple === 'function') return normalizeTrSimple(txt);
        return String(txt || '')
          .toLowerCase()
          .replace(/ç/g,'c').replace(/ğ/g,'g').replace(/ş/g,'s').replace(/ı/g,'i').replace(/ö/g,'o').replace(/ü/g,'u')
          .replace(/[^a-z0-9\s]/g,' ')
          .replace(/\s+/g,' ')
          .trim();
      };
      const foodsToSignature = (foods) => {
        const arr = (foods || []).map(f => normSimple(f.foodName || f.name || f.originalText)).filter(Boolean);
        arr.sort(); // multiset sıralı string
        return arr.join('||');
      };
      // Not: Kayıt onayı sırasında da kullanılacağı için global erişilebilir yapıyoruz
      window.checkDuplicateTemplate = (ogunTipi, foods) => {
        if (!Array.isArray(mevcutSablonlar) || mevcutSablonlar.length === 0) return null;
        const hedefType = normSimple(normalizeOgunAdi(ogunTipi));
        const hedefSig = foodsToSignature(foods);
        for (const s of mevcutSablonlar) {
          try {
            const tip = normSimple(normalizeOgunAdi(s.type));
            if (tip !== hedefType) continue;
            const sig = foodsToSignature(s.foods || []);
            if (sig === hedefSig) return s; // eşleşen şablon bulundu
          } catch {}
        }
        return null;
      };
      const setKaydetButonState = (disable, matched) => {
        const kaydetBtn = modal.querySelector('button[onclick="sablonKaydetOnay()"]');
        const aciklama = document.getElementById('sablonKaydetAciklama');
        if (kaydetBtn) {
          kaydetBtn.disabled = !!disable;
          kaydetBtn.style.opacity = disable ? '0.6' : '1';
          kaydetBtn.style.cursor = disable ? 'not-allowed' : 'pointer';
          kaydetBtn.title = disable && matched ? `Zaten arşivde: ${matched.displayName || matched.name}` : '';
        }
        if (aciklama) {
          const baseText = `${ogunYemekleri.length} yemek kaydedilecek`;
          aciklama.textContent = disable && matched ? `✅ Zaten şablon arşivinde mevcut → ${matched.displayName || matched.name}` : baseText;
        }
        // modal durum bayrağı
        modal.__duplicateTemplate = disable ? (matched?.id || matched?.name || true) : null;
      };
      
      // Önce diyet türlerini yükle
      try {
        if (!window.diyetTurleri || window.diyetTurleri.length === 0) {
          console.log('🔄 Diyet türleri yükleniyor...');
          await diyetTurleriYukle();
        }
      } catch (error) {
        console.log('⚠️ Diyet türleri yüklenemedi:', error.message);
      }
      
      // En büyük şablon numarasını bul - displayName veya name üzerinden
      let enBuyukNumara = 0;
      (mevcutSablonlar || []).forEach(sablon => {
        const ad = (sablon && (sablon.displayName || sablon.name || '')).toString().trim();
        if (!ad) return;
        const m = ad.match(/^(\d+)\./);
        if (m) {
          const n = parseInt(m[1]);
          if (isFinite(n) && n > enBuyukNumara) enBuyukNumara = n;
        }
      });
      
      // Sıradaki numara
      const yeniSablonNumarasi = enBuyukNumara + 1;
      
      console.log('🔢 Şablon numaralandırma:', {
        mevcutSablonSayisi: mevcutSablonlar.length,
        enBuyukNumara,
        yeniSablonNumarasi
      });
      
      // Öğün adını temizle/normalize et
      const temizOgunAdi = (typeof normalizeOgunAdi === 'function') ? normalizeOgunAdi(ogunAdi) : String(ogunAdi||'').toLowerCase();

      // Hasta bilgisi varsa yeni format kullan; yoksa anlamlı bir yedek isim üret
      let oncerilerinIsim;
      console.log('🔍 Ad oluşturma için hastaBilgileri kontrol:', {
        hastaBilgileri,
        isim: hastaBilgileri?.isim,
        tarihAraligi: hastaBilgileri?.tarihAraligi, 
        haftaNo: hastaBilgileri?.haftaNo
      });
      if (hastaBilgileri && hastaBilgileri.isim && hastaBilgileri.tarihAraligi && hastaBilgileri.haftaNo) {
        console.log('🔍 Zengin format dalına giriyor');
        // Tarih aralığı yıl içermiyorsa mevcut yılı ekle (hardcode yerine dinamik yıl)
        const curYear = new Date().getFullYear();
        const yilVarMi = /\b\d{4}\b/.test(String(hastaBilgileri.tarihAraligi));
        const formatliTarih = (yilVarMi ? String(hastaBilgileri.tarihAraligi) : `${hastaBilgileri.tarihAraligi} ${curYear}`).toLocaleUpperCase('tr-TR');

        // Gün adını Türkçe locale ile baş harfi büyük yap
        const gunRaw = String(hastaBilgileri.gunAdi || '').toLocaleLowerCase('tr-TR');
        const gunAdi = gunRaw ? (gunRaw.slice(0,1).toLocaleUpperCase('tr-TR') + gunRaw.slice(1)) : '';

        // Tek satırda zengin format
        const hastaIsmiUpper = String(hastaBilgileri.isim || '').toLocaleUpperCase('tr-TR');
        oncerilerinIsim = `${yeniSablonNumarasi}. 📋 ${hastaIsmiUpper} - ${formatliTarih} - ${gunAdi} - ${temizOgunAdi}. ${hastaBilgileri.haftaNo}. hafta`;
        console.log('🔍 Zengin format oluşturuldu:', oncerilerinIsim);
      } else {
        console.log('🔍 Yedek format dalına giriyor');
        // Yedek: Öğün tipi + oluşturulma tarihi (tarih bağlamı olsun)
        const todayTr = new Date().toLocaleDateString('tr-TR');
        oncerilerinIsim = `${yeniSablonNumarasi}. 📋 ${temizOgunAdi} - ${todayTr}`;
        console.log('🔍 Yedek format oluşturuldu:', oncerilerinIsim);
      }

      // Formu doldur
      document.getElementById('sablonKaydetIsim').value = oncerilerinIsim;
      document.getElementById('sablonKaydetOneri').textContent = `💡 Önerilen format: ${oncerilerinIsim}`;
      // Uyarı/Çeklist bloğu için HTML yardımcıları
      const clsBadge = (c) => {
        const map = { main: ['#0d6efd','#fff'], bread:['#fd7e14','#fff'], soup:['#20c997','#fff'], salad:['#198754','#fff'], carb:['#6f42c1','#fff'], dairy:['#0dcaf0','#000'], beverage:['#6c757d','#fff'], dessert:['#d63384','#fff'], fruit:['#198754','#fff'], other:['#adb5bd','#000'] };
        const [bg, col] = map[c] || ['#adb5bd','#000'];
        return `<span style="background:${bg}; color:${col}; padding:2px 6px; border-radius:10px; font-size:11px;">${c}</span>`;
      };
      const listHtml = enrichedFoods.map((f, i) => `
        <div data-i="${i}" style="display:flex; justify-content:space-between; align-items:center; padding:6px 8px; border:1px solid #eee; border-radius:6px; margin:6px 0; background:#fff;">
          <label style="display:flex; gap:10px; align-items:center;">
            <input type="checkbox" class="tpl-food-check" data-index="${i}" ${defaultSelected[i] ? 'checked' : ''} />
            <div>
              <div style="font-weight:600;">${f.foodName}</div>
              <div style="font-size:12px; color:#6c757d;">${clsBadge(f.cls)} · ${f.calories.toFixed(0)} kcal, P ${f.protein.toFixed(1)}, K ${f.carbs.toFixed(1)}, Y ${f.fat.toFixed(1)}</div>
            </div>
          </label>
        </div>
      `).join('');
      // Uyarı metni
      const warningMsgs = [];
      if (hasDupMain) warningMsgs.push('Birden fazla ana yemek tespit edildi.');
      if (hasDupBread) warningMsgs.push('Birden fazla ekmek/hamur işi tespit edildi.');
      if (hasDupSoup) warningMsgs.push('Birden fazla çorba tespit edildi.');
      const warnHtml = warningMsgs.length ? `<div id="tplWarn" style="background:#fff3cd; color:#664d03; border:1px solid #ffe69c; padding:8px 10px; border-radius:6px;">⚠️ ${warningMsgs.join(' ')}</div>` : '';
      // Modal üst açıklama
      document.getElementById('sablonKaydetAciklama').innerHTML = `${enrichedFoods.length} yemek algılandı. ${warningMsgs.length? 'Çakışmaları kontrol edin.' : ''}`;
      
      // Diyet türleri dropdown'ını doldur
      const diyetSelect = document.getElementById('sablonKaydetDiyetTuru');
      diyetSelect.innerHTML = '<option value="">Diyet türü seçin (isteğe bağlı)</option>';
      
      console.log('🔍 Diyet türleri kontrol:', window.diyetTurleri ? window.diyetTurleri.length : 'undefined');
      
      if (window.diyetTurleri && window.diyetTurleri.length > 0) {
        console.log('✅ Diyet türleri bulundu, dropdown dolduruluyor...');
        window.diyetTurleri.forEach(diyet => {
          const option = document.createElement('option');
          option.value = diyet.id;
          option.textContent = `${diyet.name} (${diyet.karbOrani}% K, ${diyet.proteinOrani}% P, ${diyet.yagOrani}% Y)`;
          diyetSelect.appendChild(option);
          console.log('📋 Diyet türü eklendi:', diyet.name);
        });
      } else {
        console.log('⚠️ Diyet türleri bulunamadı, varsayılan seçenekler ekleniyor...');
        // Varsayılan diyet türleri ekle
        const varsayilanDiyetler = [
          { id: 'ketogenic', name: 'Ketojenik', karbOrani: 5, proteinOrani: 25, yagOrani: 70 },
          { id: 'low-carb', name: 'Düşük Karbonhidrat', karbOrani: 20, proteinOrani: 30, yagOrani: 50 },
          { id: 'mediterranean', name: 'Akdeniz Diyeti', karbOrani: 40, proteinOrani: 20, yagOrani: 40 }
        ];
        
        varsayilanDiyetler.forEach(diyet => {
          const option = document.createElement('option');
          option.value = diyet.id;
          option.textContent = `${diyet.name} (${diyet.karbOrani}% K, ${diyet.proteinOrani}% P, ${diyet.yagOrani}% Y)`;
          diyetSelect.appendChild(option);
        });
      }
      
      // Hasta bilgilerini doldur
      const hastaBilgiDiv = document.getElementById('sablonKaydetHastaBilgi');
      if (hastaBilgileri && hastaBilgileri.isim) {
        // Hasta bilgileri varsa göster
        hastaBilgiDiv.style.display = 'block';
        document.getElementById('sablonKaydetHastaIsim').textContent = hastaBilgileri.isim.toUpperCase();
        document.getElementById('sablonKaydetHastaTarih').textContent = hastaBilgileri.tarihAraligi || 'Tarih bilgisi yok';
        document.getElementById('sablonKaydetHastaHafta').textContent = hastaBilgileri.haftaNo ? `${hastaBilgileri.haftaNo}. Hafta` : 'Hafta bilgisi yok';
        document.getElementById('sablonKaydetHastaGun').textContent = hastaBilgileri.gunAdi || 'Gün bilgisi yok';
      } else {
        // Hasta bilgileri yoksa gizle
        hastaBilgiDiv.style.display = 'none';
      }
      
      // Toplam makroları hesapla
      const toplamMakrolar = ogunYemekleri.reduce((toplam, yemek) => ({
        kalori: toplam.kalori + yemek.calories,
        protein: toplam.protein + yemek.protein,
        karb: toplam.karb + yemek.carbs,
        yag: toplam.yag + yemek.fat
      }), {kalori: 0, protein: 0, karb: 0, yag: 0});
      
      // Özet bilgilerini doldur
  document.getElementById('sablonKaydetYemekSayisi').textContent = enrichedFoods.length;
      document.getElementById('sablonKaydetKalori').textContent = toplamMakrolar.kalori.toFixed(0);
      document.getElementById('sablonKaydetOgunTipi').textContent = ogunAdi;
      document.getElementById('sablonKaydetTarih').textContent = new Date().toLocaleDateString('tr-TR');
      
      // Modal verilerini sakla
      modal.ogunAdi = ogunAdi;
  modal.ogunYemekleri = enrichedFoods;
  modal.ogunYemekleriSelected = defaultSelected.slice();
      modal.toplamMakrolar = toplamMakrolar;
      modal.hastaBilgileri = hastaBilgileri; // Hasta bilgilerini de sakla
      
      // Modal listesine seçim bloğu ekle (üst özetteki grid altına enjekte edelim)
      try {
        const gridHost = document.querySelector('#sablonKaydetModal .modal-body') || document.getElementById('sablonKaydetModal');
      } catch {}
      // Basit: mevcut modal içeriğinde bir konteynerimiz yoksa, aşağıdaki form alanlarının altındaki bir bölüme ekleyeceğiz.
      const rightPane = document.querySelector('#sablonKaydetModal .modal-right') || document.getElementById('sablonKaydetModal');
      // Güvenli ekleme: modal içindeki butonlar bölümünün üstüne yerleştir
      try {
        const btnRow = document.querySelector('#sablonKaydetModal button[onclick="sablonKaydetOnay()"]')?.parentElement?.parentElement || null;
        const insertTarget = btnRow ? btnRow : document.getElementById('sablonKaydetModal');
        // Önce kalan eski wrap'i temizle (ek güvenlik)
        const exist = document.getElementById('tplSelectionWrap');
        if (exist && exist.parentElement) exist.parentElement.removeChild(exist);
        const wrap = document.createElement('div');
        wrap.id = 'tplSelectionWrap';
        wrap.style.margin = '10px 16px';
        wrap.innerHTML = `
          ${warnHtml}
          <div style="display:flex; justify-content:space-between; align-items:center; margin:8px 0;">
            <div style="font-weight:600; color:#495057;">Şablona Dahil Edilecek Satırlar</div>
            <div style="display:flex; gap:8px;">
              <button id="tplAutoClean" type="button" style="background:#0d6efd; color:#fff; border:none; border-radius:6px; padding:6px 10px; cursor:pointer;">Oto Temizle</button>
              <button id="tplSelectAll" type="button" style="background:#6c757d; color:#fff; border:none; border-radius:6px; padding:6px 10px; cursor:pointer;">Tümünü Seç</button>
              <button id="tplSelectNone" type="button" style="background:#6c757d; color:#fff; border:none; border-radius:6px; padding:6px 10px; cursor:pointer;">Hiçbiri</button>
            </div>
          </div>
          <div id="tplList">${listHtml}</div>
        `;
        insertTarget.parentElement.insertBefore(wrap, insertTarget);
      } catch (e) {
        console.warn('Şablon seçim bloğu eklenemedi:', e);
      }

      // Etkileşim: seçim değişimini izle ve toplam makroları canlı hesapla
      const recomputeTotals = () => {
        const sel = modal.ogunYemekleriSelected;
        let tK=0,tP=0,tC=0,tF=0;
        modal.ogunYemekleri.forEach((y,i)=>{ if (sel[i]) { tK+=y.calories; tP+=y.protein; tC+=y.carbs; tF+=y.fat; }});
        document.getElementById('sablonKaydetKalori').textContent = Math.round(tK);
        // optional: could show macro breakdown elsewhere too
      };
      const updateWarn = () => {
        // Seçili öğeler için tekrar çakışma analizi
        const selFoods = modal.ogunYemekleri.filter((_,i)=>modal.ogunYemekleriSelected[i]);
        const cc = selFoods.reduce((m,x)=> (m[x.cls]=(m[x.cls]||0)+1, m), {});
        const msgs = [];
        if ((cc.main||0)>1) msgs.push('Birden fazla ana yemek seçili.');
        if ((cc.bread||0)>1) msgs.push('Birden fazla ekmek/hamur işi seçili.');
        if ((cc.soup||0)>1) msgs.push('Birden fazla çorba seçili.');
        const warnEl = document.getElementById('tplWarn');
        if (warnEl) {
          if (msgs.length) { warnEl.style.display='block'; warnEl.innerHTML = `⚠️ ${msgs.join(' ')}`; }
          else { warnEl.style.display='none'; }
        }
      };
      const bindEvents = () => {
        document.querySelectorAll('#tplList .tpl-food-check').forEach(chk => {
          chk.addEventListener('change', (e)=>{
            const idx = parseInt(e.target.getAttribute('data-index'));
            modal.ogunYemekleriSelected[idx] = e.target.checked;
            recomputeTotals();
            updateWarn();
            // Seçim değişince duplicate kontrolü yap ve Kaydet butonunu yönet
            try {
              const selFoods = modal.ogunYemekleri.filter((_,i)=>modal.ogunYemekleriSelected[i]);
              const matched = window.checkDuplicateTemplate(modal.ogunAdi, selFoods);
              setKaydetButonState(!!matched, matched);
            } catch {}
          });
        });
        const elAuto = document.getElementById('tplAutoClean');
        if (elAuto) elAuto.addEventListener('click', ()=>{
          const seen = {};
          modal.ogunYemekleri.forEach((y,i)=>{
            if (!seen[y.cls]) { seen[y.cls]=true; modal.ogunYemekleriSelected[i] = true; }
            else if (['main','bread','soup'].includes(y.cls)) { modal.ogunYemekleriSelected[i] = false; }
            else { modal.ogunYemekleriSelected[i] = true; }
          });
          document.querySelectorAll('#tplList .tpl-food-check').forEach((c,i)=>{ c.checked = modal.ogunYemekleriSelected[i]; });
          recomputeTotals();
          updateWarn();
        });
        const elAll = document.getElementById('tplSelectAll');
        if (elAll) elAll.addEventListener('click', ()=>{
          modal.ogunYemekleriSelected = modal.ogunYemekleri.map(()=>true);
          document.querySelectorAll('#tplList .tpl-food-check').forEach((c,i)=>{ c.checked = true; });
          recomputeTotals();
          updateWarn();
        });
        const elNone = document.getElementById('tplSelectNone');
        if (elNone) elNone.addEventListener('click', ()=>{
          modal.ogunYemekleriSelected = modal.ogunYemekleri.map(()=>false);
          document.querySelectorAll('#tplList .tpl-food-check').forEach((c,i)=>{ c.checked = false; });
          recomputeTotals();
          updateWarn();
        });
      };
      // Modal'ı göster
      modal.style.display = 'block';
      
      // İsim alanına focus
      document.getElementById('sablonKaydetIsim').focus();
      document.getElementById('sablonKaydetIsim').select();

      // Şablonlar yoksa yükle ve sonra duplicate kontrolü yap
      try {
        if (!Array.isArray(mevcutSablonlar) || mevcutSablonlar.length === 0) {
          if (typeof sablonlariYukle === 'function') await sablonlariYukle();
        }
        const matched = window.checkDuplicateTemplate(ogunAdi, ogunYemekleri);
        setKaydetButonState(!!matched, matched);
      } catch (e) {
        console.warn('Duplicate kontrolünde hata:', e);
      }
      // Seçim eventlerini bağla ve ilk toplamı hesapla
      try { bindEvents(); recomputeTotals(); updateWarn(); } catch (e) { console.warn('Şablon seçim etkileşimleri kurulamadı:', e); }
    }
    
    // Modal'ı kapat
    function sablonKaydetModalKapat(event) {
      if (event && event.target && event.currentTarget && event.target !== event.currentTarget) return;
      const modal = document.getElementById('sablonKaydetModal');
      // Modal kapatılırken wrap ve durumları temizle
      try {
        const wrap = document.getElementById('tplSelectionWrap');
        if (wrap && wrap.parentElement) wrap.parentElement.removeChild(wrap);
        modal.__duplicateTemplate = null;
        modal.ogunYemekleri = [];
        modal.ogunYemekleriSelected = [];
        modal.toplamMakrolar = null;
        modal.hastaBilgileri = null;
      } catch {}
      modal.style.display = 'none';
    }
    
    // Şablon kaydetme onayı
    async function sablonKaydetOnay() {
      const modal = document.getElementById('sablonKaydetModal');
      if (modal && modal.__duplicateTemplate) {
        showToast('✅ Bu öğün zaten arşivde kayıtlı. Kaydetme devre dışı.', 'info');
        return;
      }
      const sablonIsmi = document.getElementById('sablonKaydetIsim').value.trim();
      const diyetTuruId = document.getElementById('sablonKaydetDiyetTuru').value;
      
      if (!sablonIsmi) {
        showToast('❌ Şablon ismi girilmedi!', 'error');
        document.getElementById('sablonKaydetIsim').focus();
        return;
      }
      
      // Seçilen diyet türünü bul
      let seciliDiyetTuru = null;
      if (diyetTuruId && window.diyetTurleri) {
        seciliDiyetTuru = window.diyetTurleri.find(d => d.id === diyetTuruId);
      }
      
      // Güvenli benzersiz ID üretici
      const generateUniqueId = () => {
        try {
          if (window.crypto && window.crypto.randomUUID) return window.crypto.randomUUID();
        } catch {}
        try {
          if (window.crypto && window.crypto.getRandomValues) {
            const buf = new Uint32Array(4);
            window.crypto.getRandomValues(buf);
            return Array.from(buf).map(x => x.toString(16).padStart(8,'0')).join('-');
          }
        } catch {}
        return `${Date.now()}-${Math.random().toString(36).slice(2,10)}`;
      };

      // Şablon nesnesini oluştur
      // Seçili satırlara göre veri oluştur
      const selectedFoods = (modal.ogunYemekleriSelected && modal.ogunYemekleri)
        ? modal.ogunYemekleri.filter((_,i)=>modal.ogunYemekleriSelected[i])
        : modal.ogunYemekleri;
      const totalFromSel = selectedFoods.reduce((t,y)=>({
        kalori: t.kalori + (y.calories||0),
        protein: t.protein + (y.protein||0),
        karb: t.karb + (y.carbs||0),
        yag: t.yag + (y.fat||0)
      }), {kalori:0, protein:0, karb:0, yag:0});
      const yeniSablon = {
        id: generateUniqueId(),
        name: sablonIsmi,
        // Normalize type to keep archive consistent (e.g., 'öğle', 'akşam')
        type: (typeof normalizeOgunAdi === 'function') ? normalizeOgunAdi(modal.ogunAdi) : String(modal.ogunAdi||'').toLowerCase(),
        createdDate: new Date().toISOString().split('T')[0],
        dietType: seciliDiyetTuru ? seciliDiyetTuru.id : null,
        dietTypeName: seciliDiyetTuru ? seciliDiyetTuru.name : null,
        totalMacros: totalFromSel,
        foods: selectedFoods.map(yemek => ({
          foodName: yemek.foodName,
          originalText: yemek.originalText
        })),
        // Hasta bilgilerini ekle
        sourcePatient: modal.hastaBilgileri ? {
          name: modal.hastaBilgileri.isim,
          dateRange: modal.hastaBilgileri.tarihAraligi,
          weekNumber: modal.hastaBilgileri.haftaNo,
          dayName: modal.hastaBilgileri.gunAdi
        } : null
      };
      
      console.log('✅ Şablon hazırlandı:', yeniSablon);
      // Tekrarlı kayıt kontrolü (seçili satırlara göre)
      try {
        const matchedNow = (typeof checkDuplicateTemplate === 'function') ? checkDuplicateTemplate(modal.ogunAdi, selectedFoods) : null;
        if (matchedNow) {
          showToast(`ℹ️ Aynı içerikte şablon zaten var: ${matchedNow.displayName || matchedNow.name}`, 'info', 4500);
          return; // Kaydetme, mevcut şablon varken yapılmasın
        }
      } catch (e) { console.warn('Duplicate tekrar kontrolünde hata:', e); }

      // Kayıt sonrası bilgi için değerleri önceden al (modal kapanınca state temizleniyor)
      const savedFoodsCount = selectedFoods.length;
      const savedKcal = Math.round(totalFromSel.kalori);

      // Modal'ı kapat (UI temizliği)
      sablonKaydetModalKapat();
      
      // GitHub'a kaydet
      try {
        // Ekleme her zaman yeni bir öğe olarak yapılmalı: mevcutları birleştirmeden push
        await githubaSablonKaydet('meal-templates.json', yeniSablon);
        const diyetInfo = seciliDiyetTuru ? ` (${seciliDiyetTuru.name})` : '';
        showToast(`✅ "${sablonIsmi}" şablonu kaydedildi!${diyetInfo} (${savedFoodsCount} yemek, ${savedKcal} kcal)`, 'success', 4000);
      } catch (error) {
        // Duplicate özel durumu
        if (error && (error.code === 'DUPLICATE_TEMPLATE' || String(error.message||'').startsWith('DUPLICATE_TEMPLATE:'))) {
          const name = String(error.message||'').split(':')[1] || '';
          showToast(`ℹ️ Aynı içerikte şablon zaten arşivde: ${name.trim()}`, 'info', 5000);
          return;
        }
        console.error('❌ GitHub kaydetme hatası:', error);
        showToast(`⚠️ Şablon hazır ama GitHub'a kaydedilemedi: ${error.message}`, 'warning', 5000);
      }
    }

    // Orijinal öğüne geri dön
    async function revertMealToOriginal(gunAdi, ogunAdi) {
      try { gunAdi = decodeURIComponent(gunAdi); } catch {}
      try { ogunAdi = decodeURIComponent(ogunAdi); } catch {}
      const haftalar = (typeof getHaftaListesi === 'function') ? getHaftaListesi() : null;
      const seciliIndex = (typeof getAktifHaftaIndex === 'function') ? getAktifHaftaIndex() : 0;
      const hafta = Array.isArray(haftalar) ? haftalar[seciliIndex] : null;
      if (!hafta || !Array.isArray(hafta.tarifler)) {
        showToast('❌ Hafta verisi bulunamadı', 'error');
        return;
      }

      const hedefGun = normalizeGunAdi(gunAdi);
      const hedefOgun = normalizeOgunAdi(ogunAdi);
      const snapKey = `orig_meal_${hedefGun}_${hedefOgun}`;
      if (!hafta._orijinalOgunler || !hafta._orijinalOgunler[snapKey]) {
        showToast('⚠️ Bu öğünün orijinal kaydı yok', 'warning');
        return;
      }

      // Yardımcılar
      const isGunRow = (t) => {
        const n = normalizeGunAdi(String(t || ''));
        const isTurkishDay = [ 'pazartesi','sali','çarşamba','perşembe','cuma','cumartesi','pazar' ].includes(n);
        const isFallbackDay = n === 'varsayilan_gun' || String(t || '').includes('VARSAYILAN GÜN');
        return isTurkishDay || isFallbackDay;
      };
      const isOgunRow = (t) => {
        const s = String(t || '');
        return /(öğle|akşam|kahvaltı|sabah|ara\s*öğün)/i.test(s) && s.includes('(') && s.includes(')');
      };

      // Gün ve hedef öğün aralığını bul
      let gunStart = -1;
      for (let i = 0; i < hafta.tarifler.length; i++) {
        const satir = String(hafta.tarifler[i] || '');
        if (isGunRow(satir) && normalizeGunAdi(satir) === hedefGun) { gunStart = i; break; }
      }
      if (gunStart === -1) { showToast('❌ Gün bulunamadı', 'error'); return; }
      let gunEnd = hafta.tarifler.length;
      for (let i = gunStart + 1; i < hafta.tarifler.length; i++) {
        if (isGunRow(String(hafta.tarifler[i] || ''))) { gunEnd = i; break; }
      }
      let ogunHeaderIndex = -1;
      for (let i = gunStart + 1; i < gunEnd; i++) {
        const n = normalizeOgunAdi(String(hafta.tarifler[i] || ''));
        if (n === hedefOgun) { ogunHeaderIndex = i; break; }
      }
      if (ogunHeaderIndex === -1) { showToast('❌ Öğün başlığı bulunamadı', 'error'); return; }
      let ogunEnd = gunEnd;
      for (let i = ogunHeaderIndex + 1; i < gunEnd; i++) {
        const satir = String(hafta.tarifler[i] || '');
        if (isOgunRow(satir) || isGunRow(satir)) { ogunEnd = i; break; }
      }

      const orijinalSatirlar = hafta._orijinalOgunler[snapKey];
      const eskiAdet = Math.max(0, ogunEnd - (ogunHeaderIndex + 1));
      hafta.tarifler.splice(ogunHeaderIndex + 1, eskiAdet, ...orijinalSatirlar);

      // Aktif şablon işaretini temizle
      try {
        if (hafta._uygulananOgunSablonlari) delete hafta._uygulananOgunSablonlari[snapKey];
      } catch {}

      try {
        if (typeof otomatikEsleHafta === 'function') {
          await otomatikEsleHafta(seciliIndex);
        }
        if (typeof updateYemekVeritabaniAnalizi === 'function') updateYemekVeritabaniAnalizi();
        if (typeof updateTotalRows === 'function') updateTotalRows();
        showToast(`↩ ${ogunAdi} orijinale döndürüldü`, 'success');
      } catch (e) {
        console.error('⚠️ Revert sonrası güncelleme hatası:', e);
      }
    }

    // === ŞABLON ARŞİVİ SİSTEMİ ===

    // Global değişkenler
    var mevcutSablonlar = [];
    var filtrelenmisSablonlar = [];

    // === ÖĞÜNE YEMEK SATIRI EKLEME ===
    function ensureAddRowModal() {
      let modal = document.getElementById('ogunSatirEkleModal');
      if (!modal) {
        modal = document.createElement('div');
        modal.id = 'ogunSatirEkleModal';
        modal.style.cssText = 'display:none; position:fixed; inset:0; background:rgba(0,0,0,0.45); z-index:10006;';
        modal.addEventListener('click', (e) => { if (e.target === modal) closeAddRowModal(); });
        document.body.appendChild(modal);
      }
      return modal;
    }

    function openAddRowToMeal(gunAdi, ogunAdi) {
      try { gunAdi = decodeURIComponent(gunAdi); } catch {}
      try { ogunAdi = decodeURIComponent(ogunAdi); } catch {}
      const modal = ensureAddRowModal();
      const suggestions = ensureFoodSuggestionsList ? ensureFoodSuggestionsList() : [];
      modal.innerHTML = `
        <div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:92%; max-width:720px; background:#fff; border-radius:10px; overflow:hidden;">
          <div style="padding:12px 14px; background:linear-gradient(135deg,#198754,#20c997); color:#fff; display:flex; justify-content:space-between; align-items:center;">
            <div style="font-weight:700;">➕ Satır Ekle · ${gunAdi.toUpperCase()} · ${ogunAdi}</div>
            <button onclick="closeAddRowModal()" style="background:#00000022; color:#fff; border:none; border-radius:6px; padding:6px 10px; cursor:pointer;">Kapat</button>
          </div>
          <div style="padding:14px 16px; display:grid; gap:10px;">
            <div>
              <label style="display:block; font-size:12px; color:#555; margin-bottom:6px;">Yemek adı</label>
              <input id="ar_yemekAdi" type="text" placeholder="ör. Izgara tavuk" style="width:100%; padding:10px 12px; border:1px solid #dee2e6; border-radius:6px;" />
              <div id="ar_suggest" style="position:relative;">
                <div id="ar_suggestList" style="position:absolute; top:6px; left:0; right:0; background:#fff; border:1px solid #e9ecef; border-radius:6px; box-shadow:0 6px 18px rgba(0,0,0,0.08); max-height:220px; overflow:auto; display:none; z-index:10007;"></div>
              </div>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px;">
              <div>
                <label style="display:block; font-size:12px; color:#555; margin-bottom:6px;">Miktar</label>
                <input id="ar_miktar" type="number" min="0" step="0.1" placeholder="150" style="width:100%; padding:10px 12px; border:1px solid #dee2e6; border-radius:6px;" />
              </div>
              <div>
                <label style="display:block; font-size:12px; color:#555; margin-bottom:6px;">Birim</label>
                <select id="ar_birim" style="width:100%; padding:10px 12px; border:1px solid #dee2e6; border-radius:6px;">
                  <option value="gr">gr</option>
                  <option value="ml">ml</option>
                  <option value="adet">adet</option>
                  <option value="porsiyon">porsiyon</option>
                </select>
              </div>
              <div>
                <label style="display:block; font-size:12px; color:#555; margin-bottom:6px;">Porsiyon</label>
                <input id="ar_porsiyon" type="number" min="1" step="1" placeholder="1" style="width:100%; padding:10px 12px; border:1px solid #dee2e6; border-radius:6px;" />
              </div>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 2fr; gap:10px; align-items:center;">
              <label style="display:flex; align-items:center; gap:8px;">
                <input id="ar_blacklist" type="checkbox" /> Karaliste
              </label>
              <input id="ar_not" type="text" placeholder="Not (isteğe bağlı)" style="width:100%; padding:10px 12px; border:1px solid #dee2e6; border-radius:6px;" />
            </div>
            <div style="display:flex; justify-content:flex-end; gap:8px;">
              <button onclick="confirmAddRowToMeal('${encodeURIComponent(gunAdi)}', '${encodeURIComponent(ogunAdi)}')" style="background:#198754; color:#fff; border:none; border-radius:6px; padding:8px 12px; cursor:pointer;">Ekle</button>
            </div>
          </div>
        </div>`;

      // Wire suggestions
      const input = modal.querySelector('#ar_yemekAdi');
      const list = modal.querySelector('#ar_suggestList');
      let selIndex = -1;
      const norm = (t) => (typeof normalizeTrSimple === 'function') ? normalizeTrSimple(t) : String(t||'').toLowerCase().trim();
      const rank = (q) => {
        const nq = norm(q);
        return (suggestions||[]).map((name, i) => ({name, i, score: name.toLowerCase().includes(nq) ? nq.length / name.length : 0}))
          .filter(x => x.score > 0)
          .sort((a,b)=>b.score-a.score)
          .slice(0,20);
      };
      const renderList = (items) => {
        if (!items.length) { list.style.display = 'none'; list.innerHTML=''; selIndex=-1; return; }
        list.style.display = 'block';
        list.innerHTML = items.map((it, idx)=>`<div data-idx="${idx}" style="padding:8px 10px; cursor:pointer; ${idx===selIndex?'background:#e9f7ef;':''}">${it.name}</div>`).join('');
      };
      input.addEventListener('input', () => { renderList(rank(input.value)); });
      input.addEventListener('keydown', (e) => {
        const items = Array.from(list.querySelectorAll('[data-idx]'));
        if (e.key === 'ArrowDown') { selIndex = Math.min((selIndex<0?0:selIndex+1), items.length-1); e.preventDefault(); renderList(rank(input.value)); }
        else if (e.key === 'ArrowUp') { selIndex = Math.max(selIndex-1, 0); e.preventDefault(); renderList(rank(input.value)); }
        else if (e.key === 'Enter') {
          if (selIndex>=0 && items[selIndex]) { input.value = items[selIndex].textContent; list.style.display='none'; }
          confirmAddRowToMeal(gunAdi, ogunAdi);
        }
      });
      list.addEventListener('click', (e)=>{
        const d = e.target.closest('[data-idx]');
        if (d) { input.value = d.textContent; list.style.display='none'; }
      });

      modal.style.display = 'block';
      setTimeout(()=> input.focus(), 0);
    }

    function closeAddRowModal() {
      const modal = document.getElementById('ogunSatirEkleModal');
      if (modal) modal.style.display = 'none';
    }

    function insertFoodRowToMeal(gunAdi, ogunAdi, yemekAdi) {
      // hafta.tarifler içine uygun pozisyona bir yemek satırı ekler
      const haftalar = (typeof getHaftaListesi === 'function') ? getHaftaListesi() : null;
      const seciliIndex = (typeof getAktifHaftaIndex === 'function') ? getAktifHaftaIndex() : 0;
      const hafta = Array.isArray(haftalar) ? haftalar[seciliIndex] : null;
      if (!hafta || !Array.isArray(hafta.tarifler)) {
        showToast('❌ Hafta verisi bulunamadı', 'error');
        return false;
      }
      const hedefGun = normalizeGunAdi(gunAdi);
      const hedefOgun = normalizeOgunAdi(ogunAdi);
      const isGunRow = (t) => {
        const n = normalizeGunAdi(String(t || ''));
        const isTurkishDay = [ 'pazartesi','sali','çarşamba','perşembe','cuma','cumartesi','pazar' ].includes(n);
        const isFallbackDay = n === 'varsayilan_gun' || String(t || '').includes('VARSAYILAN GÜN');
        return isTurkishDay || isFallbackDay;
      };
      const isOgunRow = (t) => /(öğle|akşam|kahvaltı|sabah|ara\s*öğün)/i.test(String(t||'')) && String(t||'').includes('(') && String(t||'').includes(')');
      let gunStart = -1;
      for (let i=0;i<hafta.tarifler.length;i++) {
        const s = String(hafta.tarifler[i]||'');
        if (isGunRow(s) && normalizeGunAdi(s)===hedefGun) { gunStart=i; break; }
      }
      if (gunStart===-1) { showToast('❌ Gün bulunamadı', 'error'); return false; }
      let gunEnd = hafta.tarifler.length;
      for (let i=gunStart+1;i<hafta.tarifler.length;i++) { if (isGunRow(String(hafta.tarifler[i]||''))) { gunEnd=i; break; } }
      let ogunHeaderIndex = -1;
      for (let i=gunStart+1;i<gunEnd;i++) { const s=String(hafta.tarifler[i]||''); if (isOgunRow(s) && normalizeOgunAdi(s)===hedefOgun) { ogunHeaderIndex=i; break; } }
      if (ogunHeaderIndex===-1) { showToast('❌ Öğün bulunamadı', 'error'); return false; }
      let insertAt = gunEnd;
      for (let i=ogunHeaderIndex+1;i<gunEnd;i++) { const s=String(hafta.tarifler[i]||''); if (isOgunRow(s)) { insertAt=i; break; } }
      // Yeni satırı ekle: sade tarif metni
      hafta.tarifler.splice(insertAt, 0, yemekAdi);
      try { if (typeof otomatikEsleHafta === 'function') otomatikEsleHafta(seciliIndex); } catch {}
      try { if (typeof updateYemekVeritabaniAnalizi === 'function') updateYemekVeritabaniAnalizi(); } catch {}
      try { if (typeof updateTotalRows === 'function') updateTotalRows(); } catch {}
      return true;
    }

    function confirmAddRowToMeal(gunAdi, ogunAdi) {
      try { gunAdi = decodeURIComponent(gunAdi); } catch {}
      try { ogunAdi = decodeURIComponent(ogunAdi); } catch {}
      const input = document.querySelector('#ogunSatirEkleModal #ar_yemekAdi');
      const miktar = parseFloat((document.getElementById('ar_miktar')?.value || '').replace(',','.'));
      const birim = document.getElementById('ar_birim')?.value || '';
      const porsiyon = parseInt(document.getElementById('ar_porsiyon')?.value || '1', 10);
      const isBlacklist = !!document.getElementById('ar_blacklist')?.checked;
      const notTxt = (document.getElementById('ar_not')?.value || '').trim();
      const val = (input && input.value || '').trim();
      if (!val) { showToast('⚠️ Yemek adı girin', 'warning'); return; }
      // Satır metnini formatla: miktar + birim + ad + (porsiyon) + not
      let line = '';
      if (miktar && isFinite(miktar)) line += `${miktar} `;
      if (birim) line += `${birim} `;
      line += val;
      if (porsiyon && porsiyon > 1) line += ` (${porsiyon} porsiyon)`;
      if (notTxt) line += ` #${notTxt}`;
      if (insertFoodRowToMeal(gunAdi, ogunAdi, line)) {
        showToast(`➕ Eklendi: ${line}${isBlacklist ? ' (karaliste)' : ''}`, 'success');
        closeAddRowModal();
      }
    }

    // Dışarı aç
    window.openAddRowToMeal = openAddRowToMeal;
    window.confirmAddRowToMeal = confirmAddRowToMeal;

    // Şablon arşivini aç
    async function acSablonArsivi() {
      console.log('📋 Şablon arşivi açılıyor...');
      document.getElementById('sablonArsiviModal').style.display = 'block';
      await sablonlariYukle();
    }

    // Şablon arşivi modalını kapat
    function sablonArsiviModalKapat(event) {
      if (event && event.target !== event.currentTarget) return;
      document.getElementById('sablonArsiviModal').style.display = 'none';
    }

    // GitHub'dan şablonları yükle
    async function sablonlariYukle() {
      const token = document.getElementById('githubToken').value.trim();
      if (!token) {
        document.getElementById('sablonListesi').innerHTML = `
          <div style="text-align: center; color: #dc3545; padding: 40px;">
            <i class="fas fa-exclamation-triangle" style="font-size: 24px; margin-bottom: 10px;"></i>
            <p>GitHub token bulunamadı!</p>
            <p style="font-size: 12px; color: #666;">Şablonları görüntülemek için GitHub token'ınızı girin.</p>
          </div>`;
        return;
      }

      try {
        const repoOwner = 'mustafasacar35';
        const repoName = 'lipodem-takip-paneli-4';
        const apiUrl = `https://api.github.com/repos/${repoOwner}/${repoName}/contents/meal-templates.json`;

        console.log('🔄 GitHub\'dan şablonlar yükleniyor...');
        
        const response = await fetch(apiUrl, {
          headers: { 'Authorization': `token ${token}` }
        });

        if (response.ok) {
          const data = await response.json();
          // GitHub base64 içeriğini temizle (satır sonları ve boşlukları kaldır)
          const cleanBase64 = data.content.replace(/\s/g, '');
          const content = decodeBase64UTF8(cleanBase64);
          console.log('🕵️ DEBUG: İlk 200 karakter:', content.substring(0, 200));
          
          // Karışık encoding sorununu tespit et ve onar
          mevcutSablonlar = JSON.parse(content);
          
          // Bozuk karakterli şablonları tespit et
          let bozukSablonSayisi = 0;
          mevcutSablonlar.forEach((sablon, index) => {
            // Güvenli field erişimi
            const isim = sablon.name || sablon.isim || '';
            const aciklama = sablon.type || sablon.aciklama || '';
            
            const hasBozukChar = isim.includes('ÃÂ') || isim.includes('Ã') || aciklama.includes('ÃÂ') || aciklama.includes('Ã');
            if (hasBozukChar) {
              bozukSablonSayisi++;
              console.log(`🔧 Bozuk şablon tespit edildi [${index}]: ${isim.substring(0, 50)}...`);
            }
          });
          
          if (bozukSablonSayisi > 0) {
            console.log(`⚠️ TOPLAM ${bozukSablonSayisi} adet bozuk şablon tespit edildi!`);
            console.log('💡 Bu şablonları silip yeniden oluşturmanızı öneririz.');
          }
          
          // Şablonları tarihe göre sırala (eskiden yeniye)
          mevcutSablonlar.sort((a, b) => {
            const dateA = new Date(a.createdDate || '2024-01-01');
            const dateB = new Date(b.createdDate || '2024-01-01');
            return dateA - dateB;
          });
          
          // Otomatik numaralandırma uygula
          mevcutSablonlar.forEach((sablon, index) => {
            const yeniNumara = index + 1;
            
            // Eğer şablon isminde numara varsa, güncelle
            if (sablon.name) {
              // Mevcut numarayı kaldır ve yeni numara ekle
              let temizIsim = sablon.name;
              
              // Başındaki numarayı kaldır: "5. 📋 HASTA ADI..." → "📋 HASTA ADI..."
              temizIsim = temizIsim.replace(/^\d+\.\s*/, '');
              
              // Yeni numara ekle
              sablon.displayName = `${yeniNumara}. ${temizIsim}`;
              
              console.log(`🔢 Şablon ${index + 1}: "${sablon.name}" → "${sablon.displayName}"`);
            } else {
              sablon.displayName = sablon.name || `Şablon ${yeniNumara}`;
            }
          });
          
          filtrelenmisSablonlar = [...mevcutSablonlar];
          
          console.log('✅ Şablonlar yüklendi:', mevcutSablonlar.length, 'adet');
          diyetTuruFiltresiniGuncelle();
          sablonlariRender();
        } else if (response.status === 404) {
          mevcutSablonlar = [];
          filtrelenmisSablonlar = [];
          document.getElementById('sablonListesi').innerHTML = `
            <div style="text-align: center; color: #6c757d; padding: 40px;">
              <i class="fas fa-inbox" style="font-size: 48px; margin-bottom: 15px; opacity: 0.5;"></i>
              <h4 style="margin: 0 0 10px 0;">Henüz şablon yok</h4>
              <p style="margin: 0; font-size: 14px;">İlk şablonunuzu oluşturmak için bir öğünün yanındaki 💾 Kaydet butonunu kullanın.</p>
            </div>`;
        } else {
          throw new Error(`GitHub API hatası: ${response.status}`);
        }
      } catch (error) {
        console.error('❌ Şablon yükleme hatası:', error);
        document.getElementById('sablonListesi').innerHTML = `
          <div style="text-align: center; color: #dc3545; padding: 40px;">
            <i class="fas fa-exclamation-triangle" style="font-size: 24px; margin-bottom: 10px;"></i>
            <p>Şablon yükleme hatası!</p>
            <p style="font-size: 12px; color: #666;">${error.message}</p>
          </div>`;
      }
    }

    // Şablonları yenile
    async function sablonlariYenile() {
      document.getElementById('sablonListesi').innerHTML = `
        <div style="text-align: center; color: #666; padding: 40px;">
          <i class="fas fa-spinner fa-spin" style="font-size: 24px; margin-bottom: 10px;"></i>
          <p>Şablonlar yenileniyor...</p>
        </div>`;
      await sablonlariYukle();
    }

    // Şablonları render et
    function sablonlariRender() {
      const container = document.getElementById('sablonListesi');
      const sayiInfo = document.getElementById('sablonSayisiInfo');
      
      sayiInfo.textContent = `📊 Toplam: ${filtrelenmisSablonlar.length} şablon`;

      if (filtrelenmisSablonlar.length === 0) {
        container.innerHTML = `
          <div style="text-align: center; color: #6c757d; padding: 40px;">
            <i class="fas fa-search" style="font-size: 24px; margin-bottom: 10px; opacity: 0.5;"></i>
            <p>Filtreye uygun şablon bulunamadı.</p>
          </div>`;
        return;
      }

      let html = '';
      filtrelenmisSablonlar.forEach((sablon, index) => {
        const kaloriInfo = sablon.totalMacros ? ` (${sablon.totalMacros.kalori.toFixed(0)} kcal)` : '';
        const yemekSayisi = sablon.foods ? sablon.foods.length : 0;
        // Her yemek için makroları kısaca hesapla ve render et
        const innerFoodsHtml = (sablon.foods || []).map(yemek => {
          const ad = yemek.foodName || yemek.name || yemek.originalText || '';
          let K = null, P = null, Y = null, Cal = null;
          try {
            const hit = (typeof findFoodMacrosByName === 'function') ? findFoodMacrosByName(ad) : null;
            if (hit) {
              K = typeof hit.carbs === 'number' ? hit.carbs : parseFloat(hit.carbs);
              P = typeof hit.protein === 'number' ? hit.protein : parseFloat(hit.protein);
              Y = typeof hit.fat === 'number' ? hit.fat : parseFloat(hit.fat);
              K = isFinite(K) ? K : 0;
              P = isFinite(P) ? P : 0;
              Y = isFinite(Y) ? Y : 0;
              Cal = (K * 4) + (P * 4) + (Y * 9);
            }
          } catch {}
          const calTxt = Cal != null ? Math.round(Cal).toString() : '-';
          const kTxt = K != null ? K.toFixed(1) : '-';
          const pTxt = P != null ? P.toFixed(1) : '-';
          const yTxt = Y != null ? Y.toFixed(1) : '-';
          const macroLine = `<br><small style="color: #495057;">Cal:${calTxt} · K:${kTxt} · P:${pTxt} · Y:${yTxt}</small>`;
          return `
                  <div style="
                    padding: 8px 12px; 
                    background: #f8f9fa; 
                    border-radius: 6px; 
                    border-left: 3px solid #28a745;
                    font-size: 13px;
                  ">
                    <strong>${yemek.foodName}</strong>
                    ${yemek.originalText !== yemek.foodName ? `<br><small style=\"color: #6c757d;\">${yemek.originalText}</small>` : ''}
                    ${macroLine}
                  </div>
                `;
        }).join('');
        
        html += `
          <div style="
            border: 1px solid #ddd; 
            border-radius: 8px; 
            margin-bottom: 15px; 
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
          " 
          onmouseover="this.style.boxShadow='0 4px 8px rgba(0,0,0,0.15)'; this.style.transform='translateY(-2px)'" 
          onmouseout="this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)'; this.style.transform='translateY(0px)'">
            
            <!-- Şablon Başlığı -->
            <div style="padding: 15px 20px; border-bottom: 1px solid #f0f0f0; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
              <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 15px;">
                <!-- Sol Taraf: Başlık ve Bilgiler -->
                <div style="flex: 1;">
                  <h4 style="margin: 0 0 8px 0; color: #495057; font-size: 15px; line-height: 1.3;">${sablon.displayName || sablon.name}</h4>
                  <div style="display: flex; flex-wrap: wrap; align-items: center; gap: 12px; font-size: 12px; color: #6c757d;">
                    <span><i class="fas fa-utensils"></i> ${sablon.type}</span>
                    <span><i class="fas fa-calendar"></i> ${sablon.createdDate}</span>
                    <span><i class="fas fa-list"></i> ${yemekSayisi} yemek${kaloriInfo}</span>
                    ${sablon.dietTypeName ? `<span><i class="fas fa-chart-pie"></i> ${sablon.dietTypeName}</span>` : ''}
                  </div>
                </div>
                
                <!-- Sağ Taraf: Butonlar -->
                <div style="display: flex; gap: 6px; flex-shrink: 0;">
                  <button onclick="sablonDuzenle('${sablon.id}')" title="Düzenle" style="
                    padding: 6px 10px; 
                    background: #007bff; 
                    color: white; 
                    border: none; 
                    border-radius: 4px; 
                    cursor: pointer; 
                    font-size: 11px;
                  ">✏️</button>
                  <button onclick="sablonKopyala('${sablon.id}')" title="Kopyala" style="
                    padding: 6px 10px; 
                    background: #28a745; 
                    color: white; 
                    border: none; 
                    border-radius: 4px; 
                    cursor: pointer; 
                    font-size: 11px;
                  ">📋</button>
                  <button onclick="sablonSil('${sablon.id}')" title="Sil" style="
                    padding: 6px 10px; 
                    background: #dc3545; 
                    color: white; 
                    border: none; 
                    border-radius: 4px; 
                    cursor: pointer; 
                    font-size: 11px;
                  ">🗑️</button>
                </div>
              </div>
            </div>
            
            <!-- Yemek Listesi -->
            <div style="padding: 15px 20px;">
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 10px;">
                ${innerFoodsHtml}
              </div>
            </div>
          </div>`;
      });
      
      container.innerHTML = html;
    }

    // Şablonları filtrele
    function sablonlariFiltrele() {
      const filtre = document.getElementById('sablonFiltre').value.toLowerCase();
      const diyetFiltre = document.getElementById('diyetTuruFiltre').value;
      const aramaMetni = document.getElementById('sablonArama').value.toLowerCase();
      
      filtrelenmisSablonlar = mevcutSablonlar.filter(sablon => {
        const tipUygun = !filtre || sablon.type.toLowerCase().includes(filtre);
        
        // Diyet türü filtresi
        let diyetUygun = true;
        if (diyetFiltre) {
          if (diyetFiltre === 'no-diet') {
            diyetUygun = !sablon.dietType;
          } else {
            diyetUygun = sablon.dietType === diyetFiltre;
          }
        }
        
        const aramaUygun = !aramaMetni || 
          sablon.name.toLowerCase().includes(aramaMetni) ||
          sablon.type.toLowerCase().includes(aramaMetni) ||
          (sablon.dietTypeName && sablon.dietTypeName.toLowerCase().includes(aramaMetni)) ||
          sablon.foods.some(yemek => 
            yemek.foodName.toLowerCase().includes(aramaMetni) ||
            yemek.originalText.toLowerCase().includes(aramaMetni)
          );
        
        return tipUygun && diyetUygun && aramaUygun;
      });
      
      sablonlariRender();
    }

    // Şablonları ara
    function sablonlariAra() {
      sablonlariFiltrele();
    }
    
    // Diyet türü filtresini güncelle
    function diyetTuruFiltresiniGuncelle() {
      const diyetFiltresi = document.getElementById('diyetTuruFiltre');
      if (!diyetFiltresi) return;
      
      // Şablonlardaki benzersiz diyet türlerini bul
      const kullanililanDiyetTurleri = new Set();
      mevcutSablonlar.forEach(sablon => {
        if (sablon.dietType && sablon.dietTypeName) {
          kullanililanDiyetTurleri.add(JSON.stringify({
            id: sablon.dietType,
            name: sablon.dietTypeName
          }));
        }
      });
      
      // Mevcut seçili değeri koru
      const mevcutSecim = diyetFiltresi.value;
      
      // Dropdown'ı yeniden oluştur
      diyetFiltresi.innerHTML = `
        <option value="">Tüm Diyet Türleri</option>
        <option value="no-diet">Diyet Türü Olmayan</option>
      `;
      
      // Kullanılan diyet türlerini ekle
      Array.from(kullanililanDiyetTurleri).forEach(diyetStr => {
        const diyet = JSON.parse(diyetStr);
        const option = document.createElement('option');
        option.value = diyet.id;
        option.textContent = diyet.name;
        diyetFiltresi.appendChild(option);
      });
      
      // Önceki seçimi geri yükle
      if (mevcutSecim) {
        diyetFiltresi.value = mevcutSecim;
      }
    }

    // Şablon düzenle (gelişmiş modal)
    function sablonDuzenle(sablonId) {
      const sablon = mevcutSablonlar.find(s => s.id === sablonId);
      if (!sablon) return;
      openSablonDuzenleModal(sablon);
    }

    // Şablon kopyala
    function sablonKopyala(sablonId) {
      const sablon = mevcutSablonlar.find(s => s.id === sablonId);
      if (!sablon) return;
      
      // Aynı öğün tipindeki şablonları say ve otomatik numara oluştur
      const ogunTipi = sablon.type;
      const ayniTipteSablonlar = mevcutSablonlar.filter(s => s.type === ogunTipi);
      const sonrakiNumara = ayniTipteSablonlar.length + 1;
      const ogunAdi = ogunTipi.charAt(0).toUpperCase() + ogunTipi.slice(1); // İlk harfi büyüt
      const otomatikIsim = `${ogunAdi}-${sonrakiNumara}`;
      
      const yeniIsim = prompt(`Kopyalanan şablon için yeni ad:\n\n💡 Önerilen format: ${otomatikIsim}`, otomatikIsim);
      if (yeniIsim && yeniIsim.trim() !== '') {
        // Diyet türü seçimi
        let seciliDiyetTuru = null;
        if (window.diyetTurleri && window.diyetTurleri.length > 0) {
          const diyetSecenekleri = window.diyetTurleri.map((diyet, index) => `${index + 1}. ${diyet.name}`).join('\n');
          const diyetSecimi = prompt(
            `📋 Kopyalanan şablon için diyet türü seçin (isteğe bağlı):\n\n${diyetSecenekleri}\n\n0. Diyet türü olmadan devam et\n\nSeçiminizi girin (1-${window.diyetTurleri.length} veya 0):`,
            sablon.dietType ? (window.diyetTurleri.findIndex(d => d.id === sablon.dietType) + 1).toString() : '0'
          );
          
          if (diyetSecimi && diyetSecimi.trim() !== '' && diyetSecimi !== '0') {
            const secimIndex = parseInt(diyetSecimi) - 1;
            if (secimIndex >= 0 && secimIndex < window.diyetTurleri.length) {
              seciliDiyetTuru = window.diyetTurleri[secimIndex];
            }
          }
        }
        
        // Güçlü benzersiz ID üretimi (kopyalarda da)
        const __genId = () => {
          try { if (window.crypto && window.crypto.randomUUID) return window.crypto.randomUUID(); } catch {}
          try {
            if (window.crypto && window.crypto.getRandomValues) {
              const buf = new Uint32Array(4);
              window.crypto.getRandomValues(buf);
              return Array.from(buf).map(x => x.toString(16).padStart(8,'0')).join('-');
            }
          } catch {}
          return `${Date.now()}-${Math.random().toString(36).slice(2,10)}`;
        };
        const yeniSablon = {
          ...sablon,
          id: __genId(),
          name: yeniIsim.trim(),
          createdDate: new Date().toISOString().split('T')[0],
          dietType: seciliDiyetTuru ? seciliDiyetTuru.id : null,
          dietTypeName: seciliDiyetTuru ? seciliDiyetTuru.name : null
        };
        
        sablonEkle(yeniSablon);
      }
    }

    // Şablon sil
    function sablonSil(sablonId) {
      const sablon = mevcutSablonlar.find(s => s.id === sablonId);
      if (!sablon) return;
      
      if (confirm(`"${sablon.name}" şablonunu silmek istediğinizden emin misiniz?`)) {
        mevcutSablonlar = mevcutSablonlar.filter(s => s.id !== sablonId);
        sablonlariGithubKaydet();
      }
    }

    // Şablonu güncelle
    async function sablonuGuncelle(sablon) {
      const index = mevcutSablonlar.findIndex(s => s.id === sablon.id);
      if (index !== -1) {
        mevcutSablonlar[index] = sablon;
        await sablonlariGithubKaydet();
      }
    }

    // Yeni şablon ekle
    async function sablonEkle(yeniSablon) {
      mevcutSablonlar.push(yeniSablon);
      await sablonlariGithubKaydet();
    }

    // Şablonları GitHub'a kaydet
    async function sablonlariGithubKaydet() {
      const token = document.getElementById('githubToken').value.trim();
      if (!token) {
        alert('GitHub token bulunamadı!');
        return;
      }

      try {
        const repoOwner = 'mustafasacar35';
        const repoName = 'lipodem-takip-paneli-4';
        const apiUrl = `https://api.github.com/repos/${repoOwner}/${repoName}/contents/meal-templates.json`;

        // Önce mevcut SHA'yi al
        let sha = null;
        try {
          const getResponse = await fetch(apiUrl, {
            headers: { 'Authorization': `token ${token}` }
          });
          if (getResponse.ok) {
            const getData = await getResponse.json();
            sha = getData.sha;
          }
        } catch (e) {
          console.log('SHA alınamadı, yeni dosya oluşturulacak');
        }

        // JSON'u UTF-8 base64'e çevir (TAM veri üzerinden tek seferde)
        const jsonString = JSON.stringify(mevcutSablonlar, null, 2);
        // Güvenli yöntem: UTF-8 -> binary string -> base64
        const utf8Bytes = new TextEncoder().encode(jsonString);
        let binary = '';
        for (let i = 0; i < utf8Bytes.length; i++) {
          binary += String.fromCharCode(utf8Bytes[i]);
        }
        const base64String = btoa(binary);

        const payload = {
          message: `Şablon arşivi güncellendi: ${mevcutSablonlar.length} şablon`,
          content: base64String,
          branch: 'main'
        };

        if (sha) {
          payload.sha = sha;
        }

        const response = await fetch(apiUrl, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json',
            'Accept': 'application/vnd.github+json',
            'X-GitHub-Api-Version': '2022-11-28'
          },
          body: JSON.stringify(payload)
        });

        if (response.ok) {
          console.log('✅ Şablonlar GitHub\'a kaydedildi');
          showToast('✅ Şablonlar başarıyla güncellendi!', 'success');
          await sablonlariYukle(); // Yeniden yükle
          // Arşiv değişince öğün satırlarındaki Kaydet/Kaydedildi durumunu güncelle
          try { if (typeof updateYemekAnalizi === 'function') updateYemekAnalizi(); } catch {}
          try { if (typeof updateYemekVeritabaniAnalizi === 'function') updateYemekVeritabaniAnalizi(); } catch {}
        } else {
          let detail = '';
          try {
            const j = await response.json();
            detail = j && (j.message || j.error || j.documentation_url) ? ` - ${j.message || j.error || ''} ${j.documentation_url || ''}` : '';
          } catch {}
          throw new Error(`GitHub API hatası: ${response.status}${detail}`);
        }
      } catch (error) {
        console.error('❌ Şablon kaydetme hatası:', error);
        showToast(`⚠️ Şablon kaydetme hatası: ${error.message}`, 'error');
      }
    }

    // =============================
    // ŞABLON DÜZENLEME MODALI
    // =============================

    function ensureFoodSuggestionsList() {
      // Build a list of food name suggestions from global lists once
      if (!window.__sablonFoodSuggestions) {
        const names = new Set();
        try {
          if (Array.isArray(window.globalFoodListFlat)) {
            window.globalFoodListFlat.forEach(i => { if (i && i.ad) names.add(i.ad); });
          }
        } catch {}
        try {
          if (Array.isArray(window.globalFoodList)) {
            window.globalFoodList.forEach(i => { if (i && i.name) names.add(i.name); });
          }
        } catch {}
        // Fallback: window.foodData might be a flat array in some contexts
        try {
          if (Array.isArray(window.foodData)) {
            window.foodData.forEach(i => { if (i && i.name) names.add(i.name); });
          }
        } catch {}
        window.__sablonFoodSuggestions = Array.from(names).sort().slice(0, 1000);
      }
      return window.__sablonFoodSuggestions;
    }

    function computeTemplateTotalMacrosFromFoods(foods) {
      // Returns { kalori, protein, karb, yag }
      let kalori = 0, protein = 0, karb = 0, yag = 0;
      (foods || []).forEach(f => {
        const name = f.foodName || f.name || f.originalText || '';
        const hit = name ? (typeof findFoodMacrosByName === 'function' ? findFoodMacrosByName(name) : null) : null;
        if (hit) {
          kalori += hit.calories || 0;
          protein += hit.protein || 0;
          karb += hit.carbs || 0;
          yag += hit.fat || 0;
        }
      });
      return { kalori, protein, karb, yag };
    }

    function openSablonDuzenleModal(sablon) {
      let modal = document.getElementById('sablonDuzenleModal');
      if (!modal) {
        modal = document.createElement('div');
        modal.id = 'sablonDuzenleModal';
        modal.style.cssText = 'display:none; position:fixed; inset:0; background: rgba(0,0,0,0.45); z-index:10005;';
        modal.addEventListener('click', (e) => { if (e.target === modal) sablonDuzenleKapat(); });
        document.body.appendChild(modal);
      }

      const diyetTurleri = (window.diyetTurleri && window.diyetTurleri.length) ? window.diyetTurleri : [];
      const suggestions = ensureFoodSuggestionsList();
      const yemekListHtml = (sablon.foods || []).map((y, idx) => `
        <div style="display:flex; align-items:center; gap:8px; padding:6px 8px; background:#f8f9fa; border:1px solid #e9ecef; border-radius:6px;">
          <div style="flex:1;">
            <div style="font-weight:600; color:#333;">${y.foodName || y.name || y.originalText || '—'}</div>
            ${y.originalText && (y.originalText !== y.foodName) ? `<div style="font-size:12px; color:#6c757d;">${y.originalText}</div>` : ''}
          </div>
          <button onclick="sablondanYemekSil('${sablon.id}', ${idx})" style="background:#dc3545; color:#fff; border:none; border-radius:4px; padding:6px 10px; cursor:pointer; font-size:12px;">Sil</button>
        </div>`).join('');

      const modalInner = `
        <div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:95%; max-width:920px; background:#fff; border-radius:10px; overflow:hidden;">
          <div style="padding:14px 16px; background:linear-gradient(135deg,#0d6efd,#6610f2); color:#fff; display:flex; justify-content:space-between; align-items:center;">
            <div style="font-weight:700;">✏️ Şablon Düzenle</div>
            <button onclick="sablonDuzenleKapat()" style="background:#00000022; color:#fff; border:none; border-radius:6px; padding:6px 10px; cursor:pointer;">Kapat</button>
          </div>
          <div style="padding:16px; max-height:70vh; overflow:auto;">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-bottom:12px;">
              <div>
                <label style="font-size:12px; color:#6c757d;">Şablon Adı</label>
                <input id="sd_isim" value="${(sablon.name || '').replace(/"/g,'&quot;')}" style="width:100%; padding:8px 10px; border:1px solid #ced4da; border-radius:6px;" />
              </div>
              <div>
                <label style="font-size:12px; color:#6c757d;">Öğün Tipi</label>
                <select id="sd_tip" style="width:100%; padding:8px 10px; border:1px solid #ced4da; border-radius:6px;">
                  ${['kahvaltı','öğle','akşam','ara'].map(t => `<option value="${t}" ${String(sablon.type||'').toLowerCase().includes(t) ? 'selected' : ''}>${t}</option>`).join('')}
                </select>
              </div>
              <div>
                <label style="font-size:12px; color:#6c757d;">Diyet Türü (opsiyonel)</label>
                <select id="sd_diyet" style="width:100%; padding:8px 10px; border:1px solid #ced4da; border-radius:6px;">
                  <option value="">—</option>
                  ${diyetTurleri.map(d => `<option value="${d.id}" ${sablon.dietType===d.id ? 'selected' : ''}>${d.name || d.ad}</option>`).join('')}
                </select>
              </div>
              <div>
                <label style="font-size:12px; color:#6c757d;">Oluşturma Tarihi</label>
                <input id="sd_tarih" value="${sablon.createdDate || new Date().toISOString().split('T')[0]}" style="width:100%; padding:8px 10px; border:1px solid #ced4da; border-radius:6px;" />
              </div>
            </div>

            <div style="margin-top:6px;">
              <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:8px;">
                <div style="font-weight:600; color:#495057;">Yemekler (${(sablon.foods||[]).length})</div>
                <div style="font-size:12px; color:#6c757d;" id="sd_makro_ozet"></div>
              </div>

              <div id="sd_yemekListe" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(260px,1fr)); gap:8px;">${yemekListHtml || '<div style=\'color:#6c757d; font-size:13px;\'>Henüz yemek yok</div>'}</div>

              <div style="margin-top:12px; padding:10px; background:#f8f9fa; border:1px solid #e9ecef; border-radius:8px;">
                <div style="display:flex; gap:8px; align-items:center; position:relative;">
                  <input id="sd_yeniYemek" placeholder="Yemek adı yazın (önerilerden seçebilirsiniz)" list="sablonYemekDatalist" style="flex:1; padding:8px 10px; border:1px solid #ced4da; border-radius:6px;" oninput="sd_inputOnInput('${sablon.id}')" onkeydown="sd_inputKeydownHandler(event, '${sablon.id}')" />
                  <button onclick="sablonaYemekEkle('${sablon.id}')" style="background:#28a745; color:#fff; border:none; border-radius:6px; padding:8px 12px; cursor:pointer;">Ekle</button>
                  
                  <!-- Akıllı Sörf Önerileri -->
                  <div id="sd_suggest" style="display:none; position:absolute; left:0; right:88px; top:100%; margin-top:6px; background:#fff; border:1px solid #e9ecef; border-radius:6px; box-shadow:0 8px 20px rgba(0,0,0,0.08); max-height:280px; overflow:auto; z-index:10010;"></div>
                </div>
                <datalist id="sablonYemekDatalist">${suggestions.map(n => `<option value="${n}"></option>`).join('')}</datalist>
              </div>
            </div>
          </div>
          <div style="padding:12px 16px; border-top:1px solid #e9ecef; display:flex; justify-content:flex-end; gap:8px; background:#fff;">
            <button onclick="sablonDuzenleKapat()" style="background:#6c757d; color:#fff; border:none; border-radius:6px; padding:10px 16px; cursor:pointer;">Vazgeç</button>
            <button onclick="sablonDuzenleKaydet('${sablon.id}')" style="background:#007bff; color:#fff; border:none; border-radius:6px; padding:10px 16px; cursor:pointer; font-weight:600;">Kaydet</button>
          </div>
        </div>`;

      modal.innerHTML = modalInner;
      modal.style.display = 'block';

      // Cache the working copy on modal element
      modal.__editingTemplateId = sablon.id;
      modal.__workingFoods = (sablon.foods || []).map(f => ({ foodName: f.foodName || f.name || f.originalText, originalText: f.originalText || (f.foodName || f.name) }));
      // Update macro summary
      updateSablonMakroOzet();
    }

    function updateSablonMakroOzet() {
      const modal = document.getElementById('sablonDuzenleModal');
      if (!modal) return;
      const foods = modal.__workingFoods || [];
      const m = computeTemplateTotalMacrosFromFoods(foods);
      const el = modal.querySelector('#sd_makro_ozet');
      if (el) {
        el.textContent = `🔥 ${m.kalori.toFixed(0)} kcal • P:${m.protein.toFixed(1)}g • K:${m.karb.toFixed(1)}g • Y:${m.yag.toFixed(1)}g`;
      }
    }

    function sablonDuzenleKapat() {
      const modal = document.getElementById('sablonDuzenleModal');
      if (modal) {
        modal.style.display = 'none';
        modal.innerHTML = '';
        delete modal.__editingTemplateId;
        delete modal.__workingFoods;
      }
    }

    function rerenderSablonYemekListe() {
      const modal = document.getElementById('sablonDuzenleModal');
      if (!modal) return;
      const list = modal.querySelector('#sd_yemekListe');
      if (!list) return;
      const sablonId = modal.__editingTemplateId;
      const foods = modal.__workingFoods || [];
      list.innerHTML = foods.map((y, idx) => `
        <div style="display:flex; align-items:center; gap:8px; padding:6px 8px; background:#f8f9fa; border:1px solid #e9ecef; border-radius:6px;">
          <div style="flex:1;">
            <div style="font-weight:600; color:#333;">${y.foodName || y.name || y.originalText || '—'}</div>
            ${y.originalText && (y.originalText !== y.foodName) ? `<div style=\"font-size:12px; color:#6c757d;\">${y.originalText}</div>` : ''}
          </div>
          <button onclick="sablondanYemekSil('${sablonId}', ${idx})" style="background:#dc3545; color:#fff; border:none; border-radius:4px; padding:6px 10px; cursor:pointer; font-size:12px;">Sil</button>
        </div>`).join('') || '<div style="color:#6c757d; font-size:13px;">Henüz yemek yok</div>';
      updateSablonMakroOzet();
    }

    // ====== Akıllı Sörf: Öneri Motoru ve UI ======
    function sd_normalizeTr(str) {
      return (str || '')
        .toString()
        .toLowerCase()
        .replace(/ç/g, 'c').replace(/ğ/g, 'g').replace(/ş/g, 's').replace(/ı/g, 'i').replace(/ö/g, 'o').replace(/ü/g, 'u')
        .replace(/[^a-z0-9\s]/g, ' ')
        .replace(/\s+/g, ' ') // collapse
        .trim();
    }

    function sd_tokenize(text) {
      const unitStop = new Set([
        'adet','gr','gram','kg','yemek','kasigi','yk','tatli','cay','tk','ck',
        'yaprak','dal','orta','boy','kucuk','buyuk','olcek','fincan','bardak',
        'dilim','avuc','paket','tatli_kasigi','yemek_kasigi','cay_kasigi','yuzde',
        'yarim','ceyrek','bir','iki','uc','dort','bes','altı','alti','sekiz','dokuz','on'
      ]);
      const stopFillers = new Set(['ve','veya','ile','arti','plus','ya','vs','vb','gibi']);
      return sd_normalizeTr(text)
        .replace(/\b(ml|lt|cc|mg|mcg)\b/g, ' ')
        .replace(/\d+/g, ' ')
        .split(/\s+/)
        .filter(t => t && t.length > 2 && !unitStop.has(t) && !stopFillers.has(t));
    }

    function sd_overlapScore(a, b) {
      // token overlap score with weight for >=4 letters
      const setB = new Set(b);
      let overlap = 0;
      let longHit = false;
      for (const t of a) {
        if (setB.has(t)) {
          overlap++;
          if (t.length >= 4) longHit = true;
        }
      }
      return overlap + (longHit ? 0.5 : 0);
    }

    function sd_levenshtein(a, b) {
      // Lightweight Levenshtein for tie-breakers
      const m = a.length, n = b.length;
      if (m === 0) return n;
      if (n === 0) return m;
      const dp = Array.from({length: m+1}, (_,i)=>Array(n+1).fill(0));
      for (let i=0;i<=m;i++) dp[i][0]=i;
      for (let j=0;j<=n;j++) dp[0][j]=j;
      for (let i=1;i<=m;i++) {
        for (let j=1;j<=n;j++) {
          const cost = a[i-1] === b[j-1] ? 0 : 1;
          dp[i][j] = Math.min(
            dp[i-1][j]+1,
            dp[i][j-1]+1,
            dp[i-1][j-1]+cost
          );
        }
      }
      return dp[m][n];
    }

    function sd_rankSuggestions(query, limit=12) {
      const q = query.trim();
      if (!q) return [];
      const qTokens = sd_tokenize(q);
      const pool = ensureFoodSuggestionsList();
      const scored = [];
      for (const name of pool) {
        const tokens = sd_tokenize(name);
        if (!tokens.length) continue;
        let score = sd_overlapScore(qTokens, tokens);
        // Bonus if prefix match exists
        const qn = sd_normalizeTr(q);
        const nn = sd_normalizeTr(name);
        if (nn.startsWith(qn)) score += 1.2;
        // Small tie-breaker: shorter distance is better
        const dist = sd_levenshtein(qn.slice(0, Math.min(qn.length, 14)), nn.slice(0, Math.min(nn.length, 14)));
        const tie = Math.max(0, 3 - Math.min(3, dist)); // 0..3
        score += tie * 0.05;
        if (score > 0) {
          scored.push({ name, score });
        }
      }
      scored.sort((a,b)=> b.score - a.score);
      return scored.slice(0, limit).map(s => s.name);
    }

    function sd_renderSuggestions(names) {
      const modal = document.getElementById('sablonDuzenleModal');
      if (!modal) return;
      const wrap = modal.querySelector('#sd_suggest');
      const input = modal.querySelector('#sd_yeniYemek');
      if (!wrap || !input) return;
      if (!names || names.length === 0) { wrap.style.display='none'; wrap.innerHTML=''; modal.__sdSel=-1; return; }
      wrap.innerHTML = names.map((n,i)=>`
        <div class="sd-s-item" data-idx="${i}" style="padding:8px 10px; cursor:pointer; display:flex; align-items:center; gap:8px;">
          <span style="flex:1; color:#333;">${n}</span>
        </div>
      `).join('');
      wrap.style.display = 'block';
      modal.__sdList = names;
      modal.__sdSel = -1;
      // mouse events
      wrap.querySelectorAll('.sd-s-item').forEach(el => {
        el.addEventListener('mouseenter', ()=> {
          sd_highlightIndex(parseInt(el.getAttribute('data-idx'),10));
        });
        el.addEventListener('mouseleave', ()=> {
          sd_highlightIndex(-1);
        });
        el.addEventListener('click', ()=> {
          const idx = parseInt(el.getAttribute('data-idx'),10);
          sd_pickSuggestion(idx);
        });
      });
    }

    function sd_highlightIndex(index) {
      const modal = document.getElementById('sablonDuzenleModal');
      if (!modal) return;
      const wrap = modal.querySelector('#sd_suggest');
      if (!wrap) return;
      const items = wrap.querySelectorAll('.sd-s-item');
      items.forEach((el,i)=>{
        el.style.background = (i===index) ? '#e9f2ff' : '#fff';
      });
      modal.__sdSel = index;
    }

    function sd_hideSuggestions() {
      const modal = document.getElementById('sablonDuzenleModal');
      if (!modal) return;
      const wrap = modal.querySelector('#sd_suggest');
      if (wrap) { wrap.style.display = 'none'; }
      modal.__sdList = [];
      modal.__sdSel = -1;
    }

    function sd_pickSuggestion(index) {
      const modal = document.getElementById('sablonDuzenleModal');
      if (!modal) return;
      const list = modal.__sdList || [];
      if (index < 0 || index >= list.length) return;
      const name = list[index];
      const input = modal.querySelector('#sd_yeniYemek');
      if (input) input.value = name;
      sd_hideSuggestions();
      // Add immediately
      const sablonId = modal.__editingTemplateId;
      if (sablonId) sablonaYemekEkle(sablonId);
    }

    function sd_inputOnInput(sablonId) {
      const modal = document.getElementById('sablonDuzenleModal');
      if (!modal || modal.__editingTemplateId !== sablonId) return;
      const input = modal.querySelector('#sd_yeniYemek');
      if (!input) return;
      const q = input.value || '';
      if (q.trim().length < 2) { sd_hideSuggestions(); return; }
      const ranked = sd_rankSuggestions(q, 12);
      sd_renderSuggestions(ranked);
    }

    function sd_inputKeydownHandler(event, sablonId) {
      const modal = document.getElementById('sablonDuzenleModal');
      if (!modal || modal.__editingTemplateId !== sablonId) return;
      const list = modal.__sdList || [];
      const sel = Number.isInteger(modal.__sdSel) ? modal.__sdSel : -1;
      if (event.key === 'ArrowDown') {
        event.preventDefault();
        const next = list.length ? (sel + 1) % list.length : -1;
        sd_highlightIndex(next);
      } else if (event.key === 'ArrowUp') {
        event.preventDefault();
        const next = list.length ? (sel - 1 + list.length) % list.length : -1;
        sd_highlightIndex(next);
      } else if (event.key === 'Enter') {
        if (sel >= 0 && sel < list.length) {
          event.preventDefault();
          sd_pickSuggestion(sel);
        } else {
          // no selection -> add raw input
          // allow existing Enter handler (inline) to run
        }
      } else if (event.key === 'Escape') {
        sd_hideSuggestions();
      }
    }

    function sablonaYemekEkle(sablonId) {
      const modal = document.getElementById('sablonDuzenleModal');
      if (!modal || modal.__editingTemplateId !== sablonId) return;
      const input = modal.querySelector('#sd_yeniYemek');
      const val = (input?.value || '').trim();
      if (!val) return;
      // Add to working list
      modal.__workingFoods = modal.__workingFoods || [];
      modal.__workingFoods.push({ foodName: val, originalText: val });
      input.value = '';
      sd_hideSuggestions();
      rerenderSablonYemekListe();
    }

    function sablondanYemekSil(sablonId, idx) {
      const modal = document.getElementById('sablonDuzenleModal');
      if (!modal || modal.__editingTemplateId !== sablonId) return;
      const foods = modal.__workingFoods || [];
      if (idx < 0 || idx >= foods.length) return;
      foods.splice(idx, 1);
      rerenderSablonYemekListe();
    }

    async function sablonDuzenleKaydet(sablonId) {
      const modal = document.getElementById('sablonDuzenleModal');
      if (!modal || modal.__editingTemplateId !== sablonId) return;
      const sablon = mevcutSablonlar.find(s => s.id === sablonId);
      if (!sablon) return;

      // Read form values
      const yeniIsim = (modal.querySelector('#sd_isim')?.value || '').trim();
      const yeniTip = (modal.querySelector('#sd_tip')?.value || '').trim();
      const diyetId = (modal.querySelector('#sd_diyet')?.value || '').trim();
      const tarih = (modal.querySelector('#sd_tarih')?.value || '').trim();
      const newFoods = (modal.__workingFoods || []).map(f => ({ foodName: f.foodName, originalText: f.originalText || f.foodName }));

      if (!yeniIsim) { showToast('❌ Şablon adı gerekli', 'error'); return; }
      if (!yeniTip) { showToast('❌ Öğün tipi gerekli', 'error'); return; }

      // Update template object
      sablon.name = yeniIsim;
      sablon.type = yeniTip;
      sablon.createdDate = tarih || sablon.createdDate || new Date().toISOString().split('T')[0];
      sablon.foods = newFoods;
      if (diyetId) {
        const diyet = (window.diyetTurleri || []).find(d => d.id === diyetId);
        sablon.dietType = diyet ? diyet.id : diyetId;
        sablon.dietTypeName = diyet ? (diyet.name || diyet.ad) : (sablon.dietTypeName || null);
      } else {
        sablon.dietType = null;
        sablon.dietTypeName = null;
      }

      // Recompute totals into Turkish keys for compatibility with arşiv list
      sablon.totalMacros = computeTemplateTotalMacrosFromFoods(sablon.foods);

      try {
        await sablonuGuncelle(sablon);
        showToast('✅ Şablon güncellendi', 'success');
        sablonDuzenleKapat();
      } catch (e) {
        console.error('Şablon güncelleme hatası', e);
        showToast('❌ Şablon güncellenemedi', 'error');
      }
    }

    // Export helpers for inline handlers
    window.sablonDuzenleKapat = sablonDuzenleKapat;
    window.sablonaYemekEkle = sablonaYemekEkle;
    window.sablondanYemekSil = sablondanYemekSil;
    window.sablonDuzenleKaydet = sablonDuzenleKaydet;
  // expose smart suggest handlers
  window.sd_inputOnInput = sd_inputOnInput;
  window.sd_inputKeydownHandler = sd_inputKeydownHandler;
    
    // Global fonksiyonları window objesine ata
    window.kaydetOgunSablonu = kaydetOgunSablonu;
  window.alternatifleriGosterOgun = alternatifleriGosterOgun;
  window.applyBestMealAlternative = applyBestMealAlternative;
  window.revertMealToOriginal = revertMealToOriginal;

    // =============================
    // DİYET TÜRLERİ YÖNETİMİ FONKSİYONLARI
    // =============================
    
    let mevcutDiyetTurleri = [];
    
    // Diyet türleri modalını aç
    function acDiyetTurleri() {
      console.log('🎯 Diyet türleri paneli açılıyor...');
      document.getElementById('diyetTurleriModal').style.display = 'block';
      diyetTurleriYukle();
    }
    
    // Diyet türleri modalını kapat
    function diyetTurleriKapat(event) {
      if (event && event.target !== event.currentTarget) return;
      document.getElementById('diyetTurleriModal').style.display = 'none';
    }
    
    // Makro değerlerini güncelle
    function updateMakroValues() {
      const karb = document.getElementById('karbOrani').value;
      const protein = document.getElementById('proteinOrani').value;
      const yag = document.getElementById('yagOrani').value;
      
      document.getElementById('karbValue').textContent = karb + '%';
      document.getElementById('proteinValue').textContent = protein + '%';
      document.getElementById('yagValue').textContent = yag + '%';
      
      const toplam = parseInt(karb) + parseInt(protein) + parseInt(yag);
      const toplamSpan = document.getElementById('toplamOran');
      toplamSpan.textContent = toplam + '%';
      
      // Renk ayarla
      if (toplam === 100) {
        toplamSpan.style.color = '#28a745';
      } else if (toplam > 95 && toplam < 105) {
        toplamSpan.style.color = '#ffc107';
      } else {
        toplamSpan.style.color = '#dc3545';
      }
    }
    
    // Yeni diyet türü ekle
    function diyetTuruEkle() {
      const ad = document.getElementById('yeniDiyetAdi').value.trim();
      const aciklama = document.getElementById('yeniDiyetAciklama').value.trim();
      const karb = parseInt(document.getElementById('karbOrani').value);
      const protein = parseInt(document.getElementById('proteinOrani').value);
      const yag = parseInt(document.getElementById('yagOrani').value);
      const yasakliKelimeler = document.getElementById('yasakliKelimeler').value.trim();
      
      // Validasyon
      if (!ad) {
        alert('Diyet adı gerekli!');
        return;
      }
      
      const toplam = karb + protein + yag;
      if (Math.abs(toplam - 100) > 5) {
        alert('Makro oranları toplamı %100\'e yakın olmalı! (Şu an: %' + toplam + ')');
        return;
      }
      
      // Zorunlu özellikler
      const ozellikler = {
        ketojenik: document.getElementById('ketojenik').checked,
        glutensiz: document.getElementById('glutensiz').checked,
        vegan: document.getElementById('vegan').checked,
        vegetarian: document.getElementById('vegetarian').checked,
        dusukKalori: document.getElementById('dusukKalori').checked,
        yuksekProtein: document.getElementById('yuksekProtein').checked
      };
      
      // Yasaklı kelimeleri array'e çevir
      const yasakliArray = yasakliKelimeler ? 
        yasakliKelimeler.split(',').map(k => k.trim().toLowerCase()).filter(k => k) : [];
      
      const yeniDiyet = {
        id: Date.now().toString(),
        ad: ad,
        aciklama: aciklama,
        makroOranlari: {
          karbonhidrat: karb,
          protein: protein,
          yag: yag
        },
        yasakliKelimeler: yasakliArray,
        zorunluOzellikler: ozellikler,
        olusturmaTarihi: new Date().toISOString().split('T')[0]
      };
      
      mevcutDiyetTurleri.push(yeniDiyet);
      diyetTurleriRender();
      diyetFormTemizle();
      
      console.log('✅ Yeni diyet türü eklendi:', yeniDiyet);
    }
    
    // Diyet türlerini render et
    function diyetTurleriRender() {
      const liste = document.getElementById('diyetTurleriListesi');
      
      if (mevcutDiyetTurleri.length === 0) {
        liste.innerHTML = `
          <div style="padding: 40px; text-align: center; color: #6c757d;">
            Henüz diyet türü tanımlanmamış. Yukarıdaki formu kullanarak yeni diyet türü ekleyin.
          </div>
        `;
        return;
      }
      
      let html = '';
      mevcutDiyetTurleri.forEach(diyet => {
        const ozellikBadges = Object.entries(diyet.zorunluOzellikler)
          .filter(([key, value]) => value)
          .map(([key, value]) => {
            const labels = {
              ketojenik: 'Ketojenik',
              glutensiz: 'Glüten Siz',
              vegan: 'Vegan',
              vegetarian: 'Vejetaryen',
              dusukKalori: 'Düşük Kalori',
              yuksekProtein: 'Yüksek Protein'
            };
            return `<span style="background: #e7f3ff; color: #0066cc; padding: 2px 6px; border-radius: 3px; font-size: 11px; margin-right: 4px;">${labels[key]}</span>`;
          }).join('');
          
        html += `
          <div style="border-bottom: 1px solid #eee; padding: 15px;">
            <div style="display: flex; justify-content: between; align-items: start; margin-bottom: 10px;">
              <div style="flex: 1;">
                <h5 style="margin: 0; color: #495057; font-size: 16px;">${diyet.ad}</h5>
                <p style="margin: 5px 0 0 0; color: #6c757d; font-size: 13px;">${diyet.aciklama || 'Açıklama yok'}</p>
              </div>
              <div style="display: flex; gap: 8px;">
                <button onclick="diyetDuzenle('${diyet.id}')" style="background: #ffc107; color: #212529; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">✏️</button>
                <button onclick="diyetSil('${diyet.id}')" style="background: #dc3545; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">🗑️</button>
              </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 10px;">
              <div style="text-align: center; background: #e7f3ff; padding: 8px; border-radius: 4px;">
                <div style="font-size: 12px; color: #666;">Karbonhidrat</div>
                <div style="font-weight: bold; color: #007bff;">%${diyet.makroOranlari.karbonhidrat}</div>
              </div>
              <div style="text-align: center; background: #e8f5e8; padding: 8px; border-radius: 4px;">
                <div style="font-size: 12px; color: #666;">Protein</div>
                <div style="font-weight: bold; color: #28a745;">%${diyet.makroOranlari.protein}</div>
              </div>
              <div style="text-align: center; background: #ffe6e6; padding: 8px; border-radius: 4px;">
                <div style="font-size: 12px; color: #666;">Yağ</div>
                <div style="font-weight: bold; color: #dc3545;">%${diyet.makroOranlari.yag}</div>
              </div>
            </div>
            
            ${ozellikBadges ? `<div style="margin-bottom: 8px;">${ozellikBadges}</div>` : ''}
            
            ${diyet.yasakliKelimeler.length > 0 ? `
              <div style="font-size: 12px; color: #dc3545;">
                <strong>🚫 Yasaklı:</strong> ${diyet.yasakliKelimeler.join(', ')}
              </div>
            ` : ''}
          </div>
        `;
      });
      
      liste.innerHTML = html;
    }
    
    // Diyet formu temizle
    function diyetFormTemizle() {
      document.getElementById('yeniDiyetAdi').value = '';
      document.getElementById('yeniDiyetAciklama').value = '';
      document.getElementById('karbOrani').value = 45;
      document.getElementById('proteinOrani').value = 25;
      document.getElementById('yagOrani').value = 30;
      document.getElementById('yasakliKelimeler').value = '';
      
      // Checkboxları temizle
      ['ketojenik', 'glutensiz', 'vegan', 'vegetarian', 'dusukKalori', 'yuksekProtein'].forEach(id => {
        document.getElementById(id).checked = false;
      });
      
      updateMakroValues();
    }
    
    // Diyet sil
    function diyetSil(diyetId) {
      const diyet = mevcutDiyetTurleri.find(d => d.id === diyetId);
      if (!diyet) return;
      
      if (confirm(`"${diyet.ad}" diyet türünü silmek istediğinizden emin misiniz?`)) {
        mevcutDiyetTurleri = mevcutDiyetTurleri.filter(d => d.id !== diyetId);
        diyetTurleriRender();
        console.log('🗑️ Diyet türü silindi:', diyet.ad);
      }
    }
    
    // Diyet düzenle
    function diyetDuzenle(diyetId) {
      // TODO: Düzenleme modalı açılacak
      alert('Düzenleme özelliği yakında eklenecek!');
    }
    
    // Varsayılan diyet türleri veri sağlayıcı
    function defaultDietTypesData() {
      return [
        {
          id: 'ketojenik',
          name: 'Ketojenik',
          ad: 'Ketojenik',
          aciklama: 'Çok düşük karbonhidrat, yüksek yağ diyeti',
          karbOrani: 5,
          proteinOrani: 25,
          yagOrani: 70,
          makroOranlari: { karbonhidrat: 5, protein: 25, yag: 70 },
          yasakliKelimeler: ['ekmek', 'pilav', 'makarna', 'şeker', 'meyve', 'patates'],
          zorunluOzellikler: { ketojenik: true, glutensiz: false, vegan: false, vegetarian: false, dusukKalori: false, yuksekProtein: false },
          olusturmaTarihi: '2025-01-01'
        },
        {
          id: 'dusuk_karb',
          name: 'Düşük Karbonhidrat',
          ad: 'Düşük Karbonhidrat',
          aciklama: 'Orta düzeyde karbonhidrat kısıtlaması',
          karbOrani: 20,
          proteinOrani: 30,
          yagOrani: 50,
          makroOranlari: { karbonhidrat: 20, protein: 30, yag: 50 },
          yasakliKelimeler: ['şeker', 'tatlı', 'makarna'],
          zorunluOzellikler: { ketojenik: false, glutensiz: false, vegan: false, vegetarian: false, dusukKalori: true, yuksekProtein: true },
          olusturmaTarihi: '2025-01-01'
        },
        {
          id: 'akdeniz',
          name: 'Akdeniz Diyeti',
          ad: 'Akdeniz Diyeti',
          aciklama: 'Geleneksel Akdeniz beslenme modeli',
          karbOrani: 50,
          proteinOrani: 20,
          yagOrani: 30,
          makroOranlari: { karbonhidrat: 50, protein: 20, yag: 30 },
          yasakliKelimeler: ['işlenmiş et', 'şeker', 'trans yağ'],
          zorunluOzellikler: { ketojenik: false, glutensiz: false, vegan: false, vegetarian: false, dusukKalori: false, yuksekProtein: false },
          olusturmaTarihi: '2025-01-01'
        }
      ];
    }
    
    // Varsayılan diyet türlerini yükle
    function varsayilanDiyetTurleriYukle() {
      const varsayilanlar = defaultDietTypesData();
      mevcutDiyetTurleri = varsayilanlar;
      window.diyetTurleri = varsayilanlar; // Global değişkeni de güncelle
      console.log('✅ Varsayılan diyet türleri yüklendi:', window.diyetTurleri.length, 'adet');
    }
    
    // Diyet türlerini GitHub'dan yükle (yardımcıları kullanarak)
    async function diyetTurleriYukle() {
      try {
        const gh = getGithubRepoAndToken();
        if (!gh) {
          console.log('ℹ️ GitHub repo/token eksik, varsayılan diyet türleri yüklenecek');
          varsayilanDiyetTurleriYukle();
        } else {
          const json = await githubGetFileJson('diet-types.json', true);
          if (json && Array.isArray(json)) {
            mevcutDiyetTurleri = json;
            window.diyetTurleri = json;
            console.log('✅ Diyet türleri GitHub\'dan yüklendi:', json.length, 'adet');
          } else {
            console.log('📄 diet-types.json bulunamadı/format geçersiz, varsayılanlar yüklenecek');
            varsayilanDiyetTurleriYukle();
          }
        }
      } catch (error) {
        console.error('❌ Diyet türleri yükleme hatası:', error);
        varsayilanDiyetTurleriYukle();
      }
      diyetTurleriRender();
    }
    
    // Diyet türlerini GitHub'a kaydet (yardımcıları kullanarak)
    async function diyetTurleriKaydet() {
      const gh = getGithubRepoAndToken();
      if (!gh) { alert('GitHub repo/token bulunamadı!'); return; }
      try {
        await githubPutFileJson('diet-types.json', mevcutDiyetTurleri, `feat(diet-types): update ${mevcutDiyetTurleri.length} types`);
        console.log('✅ Diyet türleri GitHub\'a kaydedildi');
        showToast('✅ Diyet türleri başarıyla kaydedildi!', 'success');
      } catch (error) {
        console.error('❌ Diyet türleri kaydetme hatası:', error);
        showToast(`⚠️ Kaydetme hatası: ${error.message}`, 'error');
      }
    }

    // İlk Kurulum: eksik sistem dosyalarını oluştur
    async function ilkKurulumOlustur() {
      try {
        const gh = getGithubRepoAndToken();
        if (!gh) { alert('Önce GitHub repo ve token giriniz.'); return; }
        const created = [];
        const skipped = [];
        // settings/defaults.json
        try {
          const mevcut = await githubGetFileJson('settings/defaults.json', true);
          if (mevcut) {
            skipped.push('settings/defaults.json');
          } else {
            const seedDefaults = {
              dietType: 'lowcarb',
              activityLevel: 3,
              goal: 'maintain',
              weightKg: 70,
              perKg: window.DIET_PRESETS?.lowcarb || { carbsPerKg: 1.5, proteinPerKg: 1.8, fatPerKg: 1.0 },
              mealDistribution: window.DEFAULT_MEAL_DISTRIBUTION || { kahvalti: 25, ogle: 30, aksam: 35, ara: 10 }
            };
            await githubPutFileJson('settings/defaults.json', seedDefaults, 'chore(setup): seed defaults.json');
            created.push('settings/defaults.json');
          }
        } catch (e) {
          // 404 vb durumlarda oluşturmayı dene
          const seedDefaults = {
            dietType: 'lowcarb',
            activityLevel: 3,
            goal: 'maintain',
            weightKg: 70,
            perKg: window.DIET_PRESETS?.lowcarb || { carbsPerKg: 1.5, proteinPerKg: 1.8, fatPerKg: 1.0 },
            mealDistribution: window.DEFAULT_MEAL_DISTRIBUTION || { kahvalti: 25, ogle: 30, aksam: 35, ara: 10 }
          };
          await githubPutFileJson('settings/defaults.json', seedDefaults, 'chore(setup): seed defaults.json');
          created.push('settings/defaults.json');
        }
        // diet-types.json
        try {
          const mevcut = await githubGetFileJson('diet-types.json', true);
          if (mevcut && Array.isArray(mevcut)) {
            skipped.push('diet-types.json');
          } else {
            await githubPutFileJson('diet-types.json', defaultDietTypesData(), 'chore(setup): seed diet-types.json');
            created.push('diet-types.json');
          }
        } catch (e) {
          await githubPutFileJson('diet-types.json', defaultDietTypesData(), 'chore(setup): seed diet-types.json');
          created.push('diet-types.json');
        }
        const msg = [
          created.length ? `Oluşturulan: ${created.join(', ')}` : null,
          skipped.length ? `Atlanan (zaten var): ${skipped.join(', ')}` : null
        ].filter(Boolean).join(' | ');
        showToast(`🔧 İlk kurulum tamamlandı. ${msg || ''}`, 'success');
      } catch (e) {
        console.error('İlk kurulum hatası:', e);
        showToast(`⚠️ İlk kurulum hatası: ${e?.message || e}`, 'error');
      }
    }
    
    // Global fonksiyonları window objesine ata
    window.acDiyetTurleri = acDiyetTurleri;
    window.diyetTurleriKapat = diyetTurleriKapat;
    window.updateMakroValues = updateMakroValues;
    window.diyetTuruEkle = diyetTuruEkle;
    window.diyetSil = diyetSil;
    window.diyetDuzenle = diyetDuzenle;
    window.diyetTurleriKaydet = diyetTurleriKaydet;
  window.ilkKurulumOlustur = ilkKurulumOlustur;

  // === YEMEK VERİTABANI FONKSİYONLARI ===
  
  // Global değişkenler
  let yemekVeriListesi = [];
  let yemekVeriSiralamaKriteri = null;
  let yemekVeriSiralamaYonu = 'asc'; // 'asc' veya 'desc'
  let yemekVeriSayfaNo = 1;
  let yemekVeriSayfaBoyutu = 50;
  let yemekVeriFiltreliListe = [];
  
  // Yemek veritabanı panelini göster/gizle (toggle)
  function yemekVeritabaniPaneliGoster() {
    const panel = document.getElementById('yemekVeriTabaniPanel');
    const buton = document.getElementById('yemekVeritabaniBtn');
    
    // Panel açık mı kontrol et
    if (panel.style.display === 'block') {
      // Açıksa kapat
      console.log('🔄 Yemek veritabanı paneli kapatılıyor...');
      yemekVeritabaniPaneliGizle();
      
      // Buton metnini güncelle
      if (buton) {
        buton.textContent = '🍽️ Yemek Veritabanı';
        buton.style.background = '#fd7e14';
      }
    } else {
      // Kapalıysa aç
      console.log('🔄 Yemek veritabanı paneli açılıyor...');
      panel.style.display = 'block';
      
      // Buton metnini güncelle
      if (buton) {
        buton.textContent = '❌ Veritabanını Kapat';
        buton.style.background = '#dc3545';
      }
      
      // Verileri yükle ve tabloyu güncelle
      yemekVeriTabaniYukle();
    }
  }
  
  // Yemek veritabanı panelini gizle
  function yemekVeritabaniPaneliGizle() {
    const panel = document.getElementById('yemekVeriTabaniPanel');
    const buton = document.getElementById('yemekVeritabaniBtn');
    
    panel.style.display = 'none';
    
    // Buton metnini orijinal haline çevir
    if (buton) {
      buton.textContent = '🍽️ Yemek Veritabanı';
      buton.style.background = '#fd7e14';
    }
    
    // Hafta görünümünü tekrar göster gerekmiyor - akordiyon menüler zaten görünür
  }
  
  // Yemek verilerini yükle
  async function yemekVeriTabaniYukle() {
    try {
      // Önce window.allFoods kontrol et
      if (window.allFoods && window.allFoods.length > 0) {
        yemekVeriListesi = [...window.allFoods];
        console.log('✅ window.allFoods kullanıldı:', yemekVeriListesi.length, 'yemek');
      } else {
        // GitHub'dan yükle
        console.log('📥 GitHub\'dan yemek veritabanı yükleniyor...');
        const response = await fetch(`https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli-4/refs/heads/main/food_list.json?nocache=${Date.now()}&t=${Math.random()}`);
        if (!response.ok) {
          throw new Error('GitHub\'dan food_list.json alınamadı');
        }
        const foodData = await response.json();
        
        // Flat listeye çevir
        const flatList = [];
        if (foodData.categories && Array.isArray(foodData.categories)) {
          foodData.categories.forEach(cat => {
            const kategori = cat?.name || 'GENEL';
            if (cat?.items && Array.isArray(cat.items)) {
              cat.items.forEach(item => {
                flatList.push({
                  ad: item.name || '',
                  kategori: item.category || kategori,
                  kalori: item.calories || 0,
                  protein: item.protein || 0,
                  karbonhidrat: item.carbs || 0,
                  yag: item.fat || 0,
                  role: item.role || 'mainDish',
                  mealType: item.mealType || [],
                  keto: item.keto || false,
                  lowcarb: item.lowcarb || false,
                  fillerLunch: item.fillerLunch || false,
                  fillerDinner: item.fillerDinner || false,
                  etiketler: item.tags || [],
                  compatibilityTags: item.compatibilityTags || [],
                  incompatibilityTags: item.incompatibilityTags || []
                });
              });
            }
          });
        }
        yemekVeriListesi = flatList;
        console.log('✅ GitHub\'dan yemek veritabanı yüklendi:', yemekVeriListesi.length, 'yemek');
      }
      
      // Kategori ve filtreleri güncelle
      yemekVeriKategorileriGuncelle();
      
      // İlk sayfayı göster
      yemekVeriSayfaNo = 1;
      yemekVeriTabaniFiltrele();
      
    } catch (error) {
      console.error('❌ Yemek veritabanı yüklenirken hata:', error);
      showToast('Yemek veritabanı yüklenemedi!', 'error');
    }
  }
  
  // Kategori dropdown'unu güncelle
  function yemekVeriKategorileriGuncelle() {
    const select = document.getElementById('yemekVeriKategori');
    const mevcutKategoriler = [...new Set(yemekVeriListesi.map(y => y.kategori))].sort();
    
    // Mevcut seçimi koru
    const mevcutSecim = select.value;
    
    // Dropdown'u temizle ve yeniden doldur
    select.innerHTML = '<option value="">Tümü</option>';
    mevcutKategoriler.forEach(kategori => {
      const option = document.createElement('option');
      option.value = kategori;
      option.textContent = kategori;
      if (kategori === mevcutSecim) option.selected = true;
      select.appendChild(option);
    });
  }
  
  // Tabloyu filtrele ve göster
  function yemekVeriTabaniFiltrele() {
    const aramaMetni = document.getElementById('yemekVeriArama').value.toLowerCase().trim();
    const seciliKategori = document.getElementById('yemekVeriKategori').value;
    const seciliRol = document.getElementById('yemekVeriRol').value;
    const seciliOgun = document.getElementById('yemekVeriOgun').value;
    
    // Türkçe karakter normalizasyonu
    const normalizeTr = (text) => {
      return (text || '').toString().toLowerCase()
        .replace(/ç/g, 'c').replace(/ğ/g, 'g').replace(/ş/g, 's')
        .replace(/ü/g, 'u').replace(/ö/g, 'o').replace(/ı/g, 'i')
        .replace(/İ/g, 'i').replace(/i̇/g, 'i');
    };
    
    const normalizedAramaMetni = normalizeTr(aramaMetni);
    
    yemekVeriFiltreliListe = yemekVeriListesi.filter(yemek => {
      // Arama filtresi - daha kapsamlı
      let aramaEslesmesi = true;
      if (aramaMetni) {
        const yemekAdi = normalizeTr(yemek.ad || '');
        const kategori = normalizeTr(yemek.kategori || '');
        const kaloriStr = yemek.kalori ? yemek.kalori.toString() : '';
        
        // Etiketler araması
        const etiketlerStr = yemek.etiketler && Array.isArray(yemek.etiketler) 
          ? normalizeTr(yemek.etiketler.join(' '))
          : '';
        
        // Uyumluluk etiketleri - hem compatibilityTags hem de incompatibilityTags kontrolü
        const uyumlulukStr = yemek.compatibilityTags && Array.isArray(yemek.compatibilityTags)
          ? normalizeTr(yemek.compatibilityTags.join(' '))
          : '';
          
        const uyumsuzlukStr = yemek.incompatibilityTags && Array.isArray(yemek.incompatibilityTags)
          ? normalizeTr(yemek.incompatibilityTags.join(' '))
          : '';
        
        aramaEslesmesi = yemekAdi.includes(normalizedAramaMetni) ||
                        kategori.includes(normalizedAramaMetni) ||
                        kaloriStr.includes(aramaMetni) ||
                        etiketlerStr.includes(normalizedAramaMetni) ||
                        uyumlulukStr.includes(normalizedAramaMetni) ||
                        uyumsuzlukStr.includes(normalizedAramaMetni);
      }
      
      // Kategori filtresi
      const kategoriEslesmesi = !seciliKategori || yemek.kategori === seciliKategori;
      
      // Rol filtresi
      const rolEslesmesi = !seciliRol || yemek.role === seciliRol;
      
      // Öğün filtresi
      const ogunEslesmesi = !seciliOgun || 
        (yemek.mealType && Array.isArray(yemek.mealType) && yemek.mealType.includes(seciliOgun));
      
      return aramaEslesmesi && kategoriEslesmesi && rolEslesmesi && ogunEslesmesi;
    });
    
    // Sayfa numarasını sıfırla
    yemekVeriSayfaNo = 1;
    
    // Sıralama uygula
    if (yemekVeriSiralamaKriteri) {
      yemekVeriFiltreliListe.sort((a, b) => {
        let aVal = a[yemekVeriSiralamaKriteri];
        let bVal = b[yemekVeriSiralamaKriteri];
        
        // String değerler için
        if (typeof aVal === 'string') {
          aVal = aVal.toLowerCase();
          bVal = bVal ? bVal.toLowerCase() : '';
        }
        
        // Undefined değerler için
        if (aVal === undefined) aVal = '';
        if (bVal === undefined) bVal = '';
        
        let sonuc = 0;
        if (aVal < bVal) sonuc = -1;
        else if (aVal > bVal) sonuc = 1;
        
        return yemekVeriSiralamaYonu === 'desc' ? -sonuc : sonuc;
      });
    }
    
    // Sayfalama uygula ve tabloyu güncelle
    yemekVeriTablosunuGuncelle();
    yemekVeriSayfalamayiGuncelle();
  }
  
  // Tabloyu güncelle (sayfalama ile)
  function yemekVeriTablosunuGuncelle() {
    const tbody = document.getElementById('yemekVeriTablosuBody');
    
    if (!yemekVeriFiltreliListe || yemekVeriFiltreliListe.length === 0) {
      tbody.innerHTML = `
        <tr>
          <td colspan="9" style="text-align: center; padding: 40px; color: #6c757d;">
            <i class="fas fa-search" style="font-size: 24px; margin-bottom: 10px; opacity: 0.5;"></i><br>
            Filtreleme kriterlerinizle eşleşen yemek bulunamadı.
          </td>
        </tr>
      `;
      return;
    }
    
    // Sayfalama hesaplamaları
    const toplamSayfa = Math.ceil(yemekVeriFiltreliListe.length / yemekVeriSayfaBoyutu);
    const baslangic = (yemekVeriSayfaNo - 1) * yemekVeriSayfaBoyutu;
    const bitis = Math.min(baslangic + yemekVeriSayfaBoyutu, yemekVeriFiltreliListe.length);
    const sayfaVerileri = yemekVeriFiltreliListe.slice(baslangic, bitis);
    
    tbody.innerHTML = sayfaVerileri.map((yemek, index) => {
      const kategoriIcon = getKategoriIcon(yemek.kategori);
      const rolIcon = getRolIcon(yemek.role);
      
      // Debug: Tavuk Çorbası için özel log
      if (yemek.ad && yemek.ad.toLowerCase().includes('tavuk çorbası')) {
        console.log('🍲 DEBUG Tavuk Çorbası role verisi:', {
          ad: yemek.ad,
          role: yemek.role,
          rolIcon: rolIcon,
          rolAdi: getRolAdi(yemek.role),
          fullYemek: yemek
        });
      }
      
      const ozellikler = [];
      
      if (yemek.keto) ozellikler.push('<span style="background: #28a745; color: white; padding: 1px 4px; border-radius: 2px; font-size: 8px;">KETO</span>');
      if (yemek.lowcarb) ozellikler.push('<span style="background: #17a2b8; color: white; padding: 1px 4px; border-radius: 2px; font-size: 8px;">DÜŞÜK KARB</span>');
      if (yemek.fillerLunch) ozellikler.push('<span style="background: #ffc107; color: black; padding: 1px 4px; border-radius: 2px; font-size: 8px;">ÖĞLE FİLLER</span>');
      if (yemek.fillerDinner) ozellikler.push('<span style="background: #6f42c1; color: white; padding: 1px 4px; border-radius: 2px; font-size: 8px;">AKŞAM FİLLER</span>');
      
      return `
        <tr style="transition: all 0.2s; height: 20px;" onmouseover="this.style.backgroundColor='#f8f9fa'" onmouseout="this.style.backgroundColor='white'">
          <td onclick="yemekVeriTabaniDuzenle('${yemek.ad.replace(/'/g, "\\'")}', ${JSON.stringify(yemek).replace(/"/g, '&quot;')})" style="padding: 4px 6px; border-bottom: 1px solid #dee2e6; height: 20px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; cursor: pointer;">
            <div style="font-weight: 600; color: #333; font-size: 11px; line-height: 12px;">${kategoriIcon} ${yemek.ad}</div>
          </td>
          <td onclick="yemekVeriTabaniDuzenle('${yemek.ad.replace(/'/g, "\\'")}', ${JSON.stringify(yemek).replace(/"/g, '&quot;')})" style="padding: 4px; text-align: center; border-bottom: 1px solid #dee2e6; font-weight: bold; color: #fd7e14; height: 20px; font-size: 11px; cursor: pointer;">${yemek.kalori || 0}</td>
          <td onclick="yemekVeriTabaniDuzenle('${yemek.ad.replace(/'/g, "\\'")}', ${JSON.stringify(yemek).replace(/"/g, '&quot;')})" style="padding: 4px; text-align: center; border-bottom: 1px solid #dee2e6; height: 20px; font-size: 11px; cursor: pointer;">${yemek.protein || 0}g</td>
          <td onclick="yemekVeriTabaniDuzenle('${yemek.ad.replace(/'/g, "\\'")}', ${JSON.stringify(yemek).replace(/"/g, '&quot;')})" style="padding: 4px; text-align: center; border-bottom: 1px solid #dee2e6; height: 20px; font-size: 11px; cursor: pointer;">${yemek.karbonhidrat || 0}g</td>
          <td onclick="yemekVeriTabaniDuzenle('${yemek.ad.replace(/'/g, "\\'")}', ${JSON.stringify(yemek).replace(/"/g, '&quot;')})" style="padding: 4px; text-align: center; border-bottom: 1px solid #dee2e6; height: 20px; font-size: 11px; cursor: pointer;">${yemek.yag || 0}g</td>
          <td onclick="yemekVeriTabaniDuzenle('${yemek.ad.replace(/'/g, "\\'")}', ${JSON.stringify(yemek).replace(/"/g, '&quot;')})" style="padding: 4px; text-align: center; border-bottom: 1px solid #dee2e6; height: 20px; cursor: pointer;"><span style="background: #e9ecef; padding: 2px 4px; border-radius: 2px; font-size: 9px;">${yemek.kategori}</span></td>
          <td onclick="yemekVeriTabaniDuzenle('${yemek.ad.replace(/'/g, "\\'")}', ${JSON.stringify(yemek).replace(/"/g, '&quot;')})" style="padding: 4px; text-align: center; border-bottom: 1px solid #dee2e6; height: 20px; font-size: 10px; cursor: pointer;" title="Role: ${yemek.role}">${rolIcon} ${getRolAdi(yemek.role)}</td>
          <td onclick="yemekVeriTabaniDuzenle('${yemek.ad.replace(/'/g, "\\'")}', ${JSON.stringify(yemek).replace(/"/g, '&quot;')})" style="padding: 4px; text-align: center; border-bottom: 1px solid #dee2e6; height: 20px; font-size: 8px; cursor: pointer;">${ozellikler.join(' ')}</td>
          <td style="padding: 2px; text-align: center; border-bottom: 1px solid #dee2e6; height: 20px;">
            <div style="display: flex; gap: 2px; justify-content: center; align-items: center;">
              <button onclick="event.stopPropagation(); yemekVeriTabaniDuzenle('${yemek.ad.replace(/'/g, "\\'")}', ${JSON.stringify(yemek).replace(/"/g, '&quot;')})" style="background: #17a2b8; color: white; border: none; padding: 1px 4px; border-radius: 2px; cursor: pointer; font-size: 8px;" title="Düzenle">✏️</button>
              <button onclick="event.stopPropagation(); yemekVeriTabaniKopyala('${yemek.ad.replace(/'/g, "\\'")}', ${JSON.stringify(yemek).replace(/"/g, '&quot;')})" style="background: #28a745; color: white; border: none; padding: 1px 4px; border-radius: 2px; cursor: pointer; font-size: 8px;" title="Kopyala">📋</button>
              <button onclick="event.stopPropagation(); yemekVeriTabaniSil('${yemek.ad.replace(/'/g, "\\'")}', ${baslangic + index})" style="background: #dc3545; color: white; border: none; padding: 1px 4px; border-radius: 2px; cursor: pointer; font-size: 8px;" title="Sil">🗑️</button>
            </div>
          </td>
        </tr>
      `;
    }).join('');
    
    // Eğer 50'den az satır varsa, boş satırlarla tamamla
    if (sayfaVerileri.length < yemekVeriSayfaBoyutu) {
      const eksikSatir = yemekVeriSayfaBoyutu - sayfaVerileri.length;
      for (let i = 0; i < eksikSatir; i++) {
        tbody.innerHTML += `
          <tr style="height: 20px;">
            <td style="padding: 4px; border-bottom: 1px solid #dee2e6; height: 20px;">&nbsp;</td>
            <td style="padding: 4px; border-bottom: 1px solid #dee2e6; height: 20px;">&nbsp;</td>
            <td style="padding: 4px; border-bottom: 1px solid #dee2e6; height: 20px;">&nbsp;</td>
            <td style="padding: 4px; border-bottom: 1px solid #dee2e6; height: 20px;">&nbsp;</td>
            <td style="padding: 4px; border-bottom: 1px solid #dee2e6; height: 20px;">&nbsp;</td>
            <td style="padding: 4px; border-bottom: 1px solid #dee2e6; height: 20px;">&nbsp;</td>
            <td style="padding: 4px; border-bottom: 1px solid #dee2e6; height: 20px;">&nbsp;</td>
            <td style="padding: 4px; border-bottom: 1px solid #dee2e6; height: 20px;">&nbsp;</td>
            <td style="padding: 4px; border-bottom: 1px solid #dee2e6; height: 20px;">&nbsp;</td>
          </tr>
        `;
      }
    }
  }
  
  // Sayfalama kontrollerini güncelle
  function yemekVeriSayfalamayiGuncelle() {
    const toplamSayfa = Math.ceil(yemekVeriFiltreliListe.length / yemekVeriSayfaBoyutu);
    const baslangic = (yemekVeriSayfaNo - 1) * yemekVeriSayfaBoyutu + 1;
    const bitis = Math.min(yemekVeriSayfaNo * yemekVeriSayfaBoyutu, yemekVeriFiltreliListe.length);
    
    // Sayfalama bilgisini güncelle (alt bilgide)
    const altBilgi = document.querySelector('#yemekVeriTabaniPanel .alt-bilgi');
    if (altBilgi) {
      altBilgi.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <div style="color: #6c757d; font-size: 12px;">
            💡 <strong>İpucu:</strong> Satırlara tıklayarak yemekleri düzenleyebilir, sütun başlıklarına tıklayarak sıralayabilirsiniz.
          </div>
          <div style="display: flex; align-items: center; gap: 10px;">
            <span style="color: #6c757d; font-size: 12px;">
              ${baslangic}-${bitis} / ${yemekVeriFiltreliListe.length} yemek (Sayfa ${yemekVeriSayfaNo}/${toplamSayfa})
            </span>
            <div style="display: flex; gap: 5px;">
              <button onclick="yemekVeriSayfaDegistir(${yemekVeriSayfaNo - 1})" ${yemekVeriSayfaNo <= 1 ? 'disabled' : ''} style="padding: 4px 8px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 11px;" ${yemekVeriSayfaNo <= 1 ? 'style="opacity: 0.5; cursor: not-allowed;"' : ''}>◀ Önceki</button>
              <button onclick="yemekVeriSayfaDegistir(${yemekVeriSayfaNo + 1})" ${yemekVeriSayfaNo >= toplamSayfa ? 'disabled' : ''} style="padding: 4px 8px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 11px;" ${yemekVeriSayfaNo >= toplamSayfa ? 'style="opacity: 0.5; cursor: not-allowed;"' : ''}>Sonraki ▶</button>
            </div>
          </div>
        </div>
      `;
    }
  }
  
  // Sayfa değiştir
  function yemekVeriSayfaDegistir(yeniSayfa) {
    const toplamSayfa = Math.ceil(yemekVeriFiltreliListe.length / yemekVeriSayfaBoyutu);
    if (yeniSayfa >= 1 && yeniSayfa <= toplamSayfa) {
      yemekVeriSayfaNo = yeniSayfa;
      yemekVeriTablosunuGuncelle();
      yemekVeriSayfalamayiGuncelle();
    }
  }
  
  // Sıralama fonksiyonu
  function yemekVeriTabaniSirala(kriter) {
    // Aynı kritere tıklanırsa yönü değiştir
    if (yemekVeriSiralamaKriteri === kriter) {
      yemekVeriSiralamaYonu = yemekVeriSiralamaYonu === 'asc' ? 'desc' : 'asc';
    } else {
      yemekVeriSiralamaKriteri = kriter;
      yemekVeriSiralamaYonu = 'asc';
    }
    
    // Sıralama ikonlarını güncelle
    document.querySelectorAll('[id^="sort-"]').forEach(span => {
      span.textContent = '↕️';
      span.style.opacity = '0.7';
    });
    
    const aktifIcon = document.getElementById(`sort-${kriter}`);
    if (aktifIcon) {
      aktifIcon.textContent = yemekVeriSiralamaYonu === 'asc' ? '▲' : '▼';
      aktifIcon.style.opacity = '1';
    }
    
    // Tabloyu yeniden filtrele (sıralama dahil)
    yemekVeriTabaniFiltrele();
  }
  
  // Yemek düzenle modalını aç
  function yemekVeriTabaniDuzenle(yemekAdi, yemekData) {
    if (typeof yemekDuzenleModalAc === 'function') {
      // Veri formatını modalin beklediği formata dönüştür
      const modalData = {
        name: yemekData.ad || yemekData.name,
        ad: yemekData.ad || yemekData.name,
        originalName: yemekData.ad || yemekData.name,
        category: yemekData.kategori || yemekData.category,
        calories: yemekData.kalori || yemekData.calories || 0,
        protein: yemekData.protein || 0,
        carbs: yemekData.karbonhidrat || yemekData.carbs || 0,
        fat: yemekData.yag || yemekData.fat || 0,
        role: yemekData.role || 'mainDish',
        mealType: yemekData.mealType || [],
        keto: yemekData.keto || false,
        lowcarb: yemekData.lowcarb || false,
        fillerLunch: yemekData.fillerLunch || false,
        fillerDinner: yemekData.fillerDinner || false,
        tags: yemekData.etiketler || yemekData.tags || [],
        compatibilityTags: yemekData.compatibilityTags || [],
        incompatibilityTags: yemekData.incompatibilityTags || [],
        minQuantity: yemekData.minQuantity || 0.5,
        maxQuantity: yemekData.maxQuantity || 1,
        step: yemekData.step || 0.5,
        multiplier: yemekData.multiplier || 1,
        portionFixed: yemekData.portionFixed || false,
        seasonRange: yemekData.seasonRange || '[1,12]',
        isReversedSeason: yemekData.isReversedSeason || false
      };
      
      console.log('🔄 Veri tabası -> Modal dönüşümü:', {
        original: yemekData,
        transformed: modalData
      });
      
      yemekDuzenleModalAc(modalData, 'duzenle');
    } else {
      console.error('yemekDuzenleModalAc fonksiyonu bulunamadı');
    }
  }
  
  // Yemek kopyala - Yeni yemek olarak düzenleme modalını aç
  function yemekVeriTabaniKopyala(yemekAdi, yemekData) {
    if (typeof yemekDuzenleModalAc === 'function') {
      // Veri formatını modalin beklediği formata dönüştür
      const modalData = {
        name: (yemekData.ad || yemekData.name) + ' (Kopya)',
        ad: (yemekData.ad || yemekData.name) + ' (Kopya)',
        originalName: (yemekData.ad || yemekData.name) + ' (Kopya)',
        category: yemekData.kategori || yemekData.category,
        calories: yemekData.kalori || yemekData.calories || 0,
        protein: yemekData.protein || 0,
        carbs: yemekData.karbonhidrat || yemekData.carbs || 0,
        fat: yemekData.yag || yemekData.fat || 0,
        role: yemekData.role || 'mainDish',
        mealType: yemekData.mealType || [],
        keto: yemekData.keto || false,
        lowcarb: yemekData.lowcarb || false,
        fillerLunch: yemekData.fillerLunch || false,
        fillerDinner: yemekData.fillerDinner || false,
        tags: yemekData.etiketler || yemekData.tags || [],
        compatibilityTags: yemekData.compatibilityTags || [],
        incompatibilityTags: yemekData.incompatibilityTags || [],
        minQuantity: yemekData.minQuantity || 0.5,
        maxQuantity: yemekData.maxQuantity || 1,
        step: yemekData.step || 0.5,
        multiplier: yemekData.multiplier || 1,
        portionFixed: yemekData.portionFixed || false,
        seasonRange: yemekData.seasonRange || '[1,12]',
        isReversedSeason: yemekData.isReversedSeason || false
      };
      
      // Yeni yemek olarak modalı aç
      yemekDuzenleModalAc(modalData, 'yeni');
      
      // Başarı mesajı
      console.log(`✅ "${yemekAdi}" yemeği kopyalandı ve düzenleme için açıldı`);
    } else {
      console.error('yemekDuzenleModalAc fonksiyonu bulunamadı');
    }
  }
  
  // Yemek sil - Onay ile birlikte
  function yemekVeriTabaniSil(yemekAdi, yemekIndex) {
    if (confirm(`⚠️ "${yemekAdi}" yemeğini kalıcı olarak silmek istediğinizden emin misiniz?\n\nBu işlem geri alınamaz!`)) {
      try {
        // Global yemek listesinden sil
        if (window.foodList && Array.isArray(window.foodList)) {
          const originalIndex = window.foodList.findIndex(y => y.ad === yemekAdi || y.name === yemekAdi);
          if (originalIndex !== -1) {
            const silinenYemek = window.foodList.splice(originalIndex, 1)[0];
            console.log(`🗑️ "${yemekAdi}" yemeği listeden silindi:`, silinenYemek);
            
            // Tabloyu güncelle
            yemekVeriTabaniFiltrele();
            
            // Başarı mesajı
            alert(`✅ "${yemekAdi}" yemeği başarıyla silindi!\n\n💾 Değişiklikleri kalıcı yapmak için GitHub'a kaydetmeyi unutmayın.`);
          } else {
            alert(`⚠️ "${yemekAdi}" yemeği listede bulunamadı.`);
          }
        } else {
          alert('⚠️ Yemek listesi yüklenemedi. Sayfayı yenileyip tekrar deneyin.');
        }
      } catch (error) {
        console.error('❌ Yemek silme hatası:', error);
        alert('❌ Yemek silinirken bir hata oluştu: ' + error.message);
      }
    }
  }
  
  // Yardımcı fonksiyonlar
  function getRolIcon(rol) {
    const iconMap = {
      'bread': '🍞',
      'dessert': '🍰',
      'drink': '🥤',
      'fruit': '🍎',
      'mainDish': '🍽️',
      'sideDish': '🥗',
      'snack': '🍪',
      'soup': '🍲',
      'supplement': '💊'
    };
    return iconMap[rol] || '🍽️';
  }
  
  function getRolAdi(rol) {
    const adMap = {
      'bread': 'Ekmek',
      'dessert': 'Tatlı',
      'drink': 'İçecek',
      'fruit': 'Meyve',
      'mainDish': 'Ana Yemek',
      'sideDish': 'Yan Yemek',
      'snack': 'Atıştırmalık',
      'soup': 'Çorba',
      'supplement': 'Takviye'
    };
    return adMap[rol] || 'Ana Yemek';
  }

  // Global fonksiyonları window'a ekle
  window.yemekVeritabaniPaneliGoster = yemekVeritabaniPaneliGoster;
  window.yemekVeritabaniPaneliGizle = yemekVeritabaniPaneliGizle;
  window.yemekVeriTabaniFiltrele = yemekVeriTabaniFiltrele;
  window.yemekVeriTabaniSirala = yemekVeriTabaniSirala;

  // Sidebar buton tıklamalarında yemek veritabanı panelini otomatik kapat
  function initSidebarAutoClose() {
    // Sol sidebar butonları
    const leftSidebar = document.querySelector('.left-sidebar');
    if (leftSidebar) {
      leftSidebar.addEventListener('click', function(e) {
        // Yemek veritabanı butonu dışındaki tüm butonlar için
        if (e.target.tagName === 'BUTTON' && e.target.id !== 'yemekVeritabaniBtn' && !e.target.onclick?.toString().includes('yemekVeritabani')) {
          const panel = document.getElementById('yemekVeriTabaniPanel');
          if (panel && panel.style.display !== 'none') {
            console.log('🔄 Sol sidebar buton tıklandı, yemek veritabanı paneli kapatılıyor...');
            yemekVeritabaniPaneliGizle();
          }
        }
      });
    }

    // Hasta listesi özel kontrolü
    const hastaListesi = document.getElementById('hastaListesi');
    if (hastaListesi) {
      hastaListesi.addEventListener('click', function(e) {
        // Hasta ismine tıklandığında panel kapat
        const panel = document.getElementById('yemekVeriTabaniPanel');
        if (panel && panel.style.display !== 'none') {
          console.log('🔄 Hasta listesi tıklandı, yemek veritabanı paneli kapatılıyor...');
          yemekVeritabaniPaneliGizle();
        }
      });
    }

    // Sağ sidebar butonları
    const rightSidebar = document.querySelector('.right-sidebar');
    if (rightSidebar) {
      rightSidebar.addEventListener('click', function(e) {
        // Yemek veritabanı butonu dışındaki tüm butonlar için
        if (e.target.tagName === 'BUTTON' && e.target.id !== 'yemekVeritabaniBtn' && !e.target.onclick?.toString().includes('yemekVeritabani')) {
          const panel = document.getElementById('yemekVeriTabaniPanel');
          if (panel && panel.style.display !== 'none') {
            console.log('🔄 Sağ sidebar buton tıklandı, yemek veritabanı paneli kapatılıyor...');
            yemekVeritabaniPaneliGizle();
          }
        }
      });
    }

    // Orta paneldeki butonlar için de ekle (opsiyonel)
    const mainContent = document.querySelector('.main-content');
    if (mainContent) {
      mainContent.addEventListener('click', function(e) {
        // Spesifik butonlar için panel kapatma
        if (e.target.tagName === 'BUTTON' && 
            (e.target.onclick?.toString().includes('yeniHastaFormu') ||
             e.target.onclick?.toString().includes('manuelKartEkleme') ||
             e.target.onclick?.toString().includes('duzenleHasta') ||
             e.target.onclick?.toString().includes('acHastaAyarlar'))) {
          const panel = document.getElementById('yemekVeriTabaniPanel');
          if (panel && panel.style.display !== 'none') {
            console.log('🔄 Ana içerik buton tıklandı, yemek veritabanı paneli kapatılıyor...');
            yemekVeritabaniPaneliGizle();
          }
        }
      });
    }
  }

  // Sayfa yüklendiğinde sidebar auto close'u başlat
  document.addEventListener('DOMContentLoaded', function() {
    initSidebarAutoClose();
  });

  // Eğer sayfa zaten yüklenmişse hemen başlat
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initSidebarAutoClose);
  } else {
    initSidebarAutoClose();
  }

  </script>
</body>
</html>











