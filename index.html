
<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Lipodem Takip Paneli - AyrÄ± JSON DosyalarÄ± v2.0</title>
  
  <!--
  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
  â•‘                            ğŸ” KOD REFERANS DOKÃœMANTASYONU                                â•‘
  â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
  â•‘                                                                                          â•‘
  â•‘  ğŸ“Š MAKRO HESAPLAMA SÄ°STEMÄ° - SATIR YAPILARI VE BULMA YÃ–NTEMLERÄ°                       â•‘
  â•‘                                                                                          â•‘
  â•‘  ğŸ¯ YEMEK SATIRLARI:                                                                     â•‘
  â•‘     â€¢ Selector: tr[data-sira-no="${item.siraNo}"]                                       â•‘
  â•‘     â€¢ Ã–zellik: data-sira-no attribute ile kesin targeting                               â•‘
  â•‘     â€¢ GÃ¼ncelleme: updateFoodTableRow() ~line 13350                                      â•‘
  â•‘     â€¢ Ã‡aÄŸrÄ±lan yer: alternatifSec() ~line 13940                                         â•‘
  â•‘                                                                                          â•‘
  â•‘  ğŸ“… GÃœN TOPLAM SATIRLARI:                                                                â•‘
  â•‘     â€¢ Format: "ğŸ“… PAZARTESÄ°", "ğŸ“… SALI" vs.                                             â•‘
  â•‘     â€¢ Alternatif: "1. GÃ¼n (Pazartesi)" formatÄ± da desteklenir                          â•‘
  â•‘     â€¢ GÃ¼ncelleme: updateTotalRows() iÃ§inde gÃ¼n detection ~line 13580                    â•‘
  â•‘     â€¢ Pattern: /^\d+\.\s*GÃ¼n\s*\(/i veya ğŸ“… ile baÅŸlayan                               â•‘
  â•‘                                                                                          â•‘
  â•‘  ğŸ½ï¸ Ã–ÄÃœN TOPLAM SATIRLARI:                                                              â•‘
  â•‘     â€¢ Format: "ğŸ½ï¸ KahvaltÄ±", "ğŸ½ï¸ Ã–ÄŸle", "ğŸ½ï¸ AkÅŸam" vs.                                â•‘
  â•‘     â€¢ Detection: textContent.includes('ğŸ½ï¸') ~line 13588                                â•‘
  â•‘     â€¢ GÃ¼ncelleme: updateTotalRows() iÃ§inde Ã¶ÄŸÃ¼n accumulation                           â•‘
  â•‘                                                                                          â•‘
  â•‘  ğŸ“Š GÃœNLÃœK ORTALAMA SATIRI:                                                              â•‘
  â•‘     â€¢ Unique Text: "ğŸ“Š GÃœNLÃœK ORTALAMA"                                                 â•‘
  â•‘     â€¢ Selector: textContent.includes('ğŸ“Š GÃœNLÃœK ORTALAMA')                              â•‘
  â•‘     â€¢ GÃ¼ncelleme: updateTotalRows() ~line 13683                                         â•‘
  â•‘     â€¢ NOT: Style-based selector KULLANILMAZ (17 satÄ±r buluyordu)                       â•‘
  â•‘                                                                                          â•‘
  â•‘  ğŸ”„ GÃœNCELEME AKIÅI:                                                                     â•‘
  â•‘     1. alternatifSec() â†’ Alternatif yemek seÃ§imi                                        â•‘
  â•‘     2. updateFoodTableRow() â†’ Ä°lgili yemek satÄ±rÄ±nÄ± gÃ¼ncelle                           â•‘
  â•‘     3. updateTotalRows() â†’ TÃ¼m toplam satÄ±rlarÄ±nÄ± yeniden hesapla                      â•‘
  â•‘     4. setTimeout() â†’ 100ms sonra force update                                          â•‘
  â•‘                                                                                          â•‘
  â•‘  ğŸ“‚ VERÄ° YAPISI:                                                                         â•‘
  â•‘     â€¢ window.currentFoodAnalysisData[index].eslesenYemek â†’ SeÃ§ili yemek                â•‘
  â•‘     â€¢ .calories, .protein, .carbs, .fat â†’ Makro deÄŸerleri                              â•‘
  â•‘     â€¢ .siraNo â†’ Row targeting iÃ§in unique ID                                            â•‘
  â•‘                                                                                          â•‘
  â•‘  ğŸ› ï¸ DEBUG SÄ°STEMÄ°:                                                                       â•‘
  â•‘     â€¢ "ğŸ“Š DETAY: Kalori=X, Karb=Y..." â†’ GÃ¼nlÃ¼k ortalama deÄŸerleri                      â•‘
  â•‘     â€¢ "ğŸ“… GÃ¼ncellenen gÃ¼n: X" â†’ GÃ¼n totali gÃ¼ncelleme                                  â•‘
  â•‘     â€¢ "ğŸ½ï¸ Ã–ÄŸÃ¼n toplamÄ±na eklendi: X" â†’ Ã–ÄŸÃ¼n totali gÃ¼ncelleme                          â•‘
  â•‘     â€¢ "ğŸ”„ Alternatif yemek seÃ§ildi: X" â†’ SeÃ§im detaylarÄ±                               â•‘
  â•‘                                                                                          â•‘
  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  -->
  
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiByeD0iNCIgZmlsbD0iIzAwN2NmZiIvPgo8cGF0aCBkPSJNMTEgMTBoMTB2MkgxMXptMCA0aDd2MmgtN3ptMCA0aDEwdjJIMTF6IiBmaWxsPSJ3aGl0ZSIvPgo8L3N2Zz4K" />
  
  <!-- PDF.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
  
  <!-- FontAwesome Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  
  <!-- JSZip -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  
  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- TÃ¼rkÃ§e karakter desteÄŸi iÃ§in font ekle -->
  <script>
    // jsPDF font encoding dÃ¼zeltmesi
    window.fixTurkishChars = function(text) {
      if (!text || typeof text !== 'string') return text;
      return text
        .replace(/Å/g, 'S').replace(/ÅŸ/g, 's')
        .replace(/Ä/g, 'G').replace(/ÄŸ/g, 'g')
        .replace(/Ä°/g, 'I').replace(/Ä±/g, 'i')
        .replace(/Ã‡/g, 'C').replace(/Ã§/g, 'c')
        .replace(/Ã–/g, 'O').replace(/Ã¶/g, 'o')
        .replace(/Ãœ/g, 'U').replace(/Ã¼/g, 'u');
    };
  </script>
  
  <style>
    /* Tab Navigation Styles */
    .tab-button {
      transition: all 0.3s ease !important;
    }
    
    .tab-button.active {
      background: #e8f5e8 !important;
      border-bottom: 3px solid #28a745 !important;
      color: #28a745 !important;
      font-weight: 600 !important;
    }
    
    .tab-button:hover {
      background: #f8f9fa !important;
    }
    
    /* Åablon Kaydetme Modal Styles */
    #sablonKaydetModal input:focus,
    #sablonKaydetModal select:focus {
      border-color: #007bff !important;
      box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1) !important;
      outline: none !important;
    }
    
    #sablonKaydetModal input:invalid {
      border-color: #dc3545 !important;
    }
    
    #sablonKaydetModal button:hover {
      transform: translateY(-1px) !important;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2) !important;
    }
    
    /* HÄ±zlÄ± Filtre ButonlarÄ± */
    .hizli-filtre {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      color: #495057;
      padding: 6px 12px;
      border-radius: 15px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
      white-space: nowrap;
    }
    
    .hizli-filtre:hover {
      background: #e9ecef;
      border-color: #adb5bd;
    }
    
    .hizli-filtre.active {
      background: #20c997;
      color: white;
      border-color: #20c997;
    }
    
    /* Yemek Liste KartlarÄ± */
    .yemek-kart {
      background: white;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .yemek-kart:hover {
      border-color: #20c997;
      box-shadow: 0 2px 8px rgba(32, 201, 151, 0.15);
      transform: translateY(-1px);
    }
    
    .yemek-kart.selected {
      border-color: #20c997;
      background: #e8f8f5;
      box-shadow: 0 0 0 2px rgba(32, 201, 151, 0.2);
    }
    
    .yemek-kart-header {
      padding: 12px 15px 8px 15px;
      border-bottom: 1px solid #f8f9fa;
    }
    
    .yemek-kart-body {
      padding: 8px 15px 12px 15px;
      font-size: 13px;
      color: #666;
    }
    
    /* KÄ±sa Mesaj Sistemi */
    .toast-message {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #28a745;
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      font-weight: bold;
      font-size: 14px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 10000;
      animation: slideIn 0.3s ease-out;
    }
    
    .toast-message.error {
      background: #dc3545;
    }
    
    .toast-message.warning {
      background: #ffc107;
      color: #212529;
    }
    
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    body { 
      font-family: sans-serif; 
      margin: 0; 
      padding: 0; 
      background: #f7f7f7; 
      overflow-x: hidden;
    }
    
    /* Main Layout */
    .main-container {
      display: grid;
      grid-template-columns: 320px 4px 1fr 4px 200px;
      grid-template-rows: 60px 1fr;
      height: 100vh;
      gap: 0;
    }
    
    /* Resizable handles */
    .resize-handle {
      background: #e9ecef;
      cursor: ew-resize;
      border-left: 1px solid #dee2e6;
      border-right: 1px solid #dee2e6;
      position: relative;
      transition: background-color 0.2s;
    }
    
    .resize-handle:hover {
      background: #6c757d;
    }
    
    .resize-handle:before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 2px;
      height: 20px;
      background: #6c757d;
      border-radius: 1px;
    }
    
    .resize-handle:hover:before {
      background: white;
    }
    
    /* Header */
    .header {
      grid-column: 1 / -1;
      background: #343a40;
      color: white;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .header h2 {
      margin: 0;
      font-size: 18px;
    }
    
    /* Sol Sidebar */
    .left-sidebar {
      background: white;
      border-right: 1px solid #ddd;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
    }
    
    .sidebar-section {
      border-bottom: 1px solid #eee;
      padding: 15px;
    }
    
    .sidebar-section h3 {
      margin: 0 0 10px 0;
      font-size: 14px;
      color: #495057;
      text-transform: uppercase;
      border-bottom: 2px solid #007bff;
      padding-bottom: 5px;
    }
    
    /* Hasta Listesi */
    #hastaListesi {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    
    #hastaListesi li {
      padding: 8px 12px;
      cursor: pointer;
      border-radius: 4px;
      margin-bottom: 2px;
      font-size: 13px;
      transition: background 0.2s;
    }
    
    #hastaListesi li:hover {
      background: #f8f9fa;
    }
    
    /* SeÃ§ili hasta stili */
    #hastaListesi li.secili-hasta {
      position: relative;
      border: 2px solid #dc3545 !important;
      box-shadow: 0 0 10px rgba(220, 53, 69, 0.3) !important;
      transform: scale(1.02) !important;
    }
    
    #hastaListesi li.secili-hasta::after {
      content: 'ğŸ‘ˆ SEÃ‡Ä°LÄ°';
      position: absolute;
      top: 50%;
      right: 8px;
      transform: translateY(-50%);
      background: #dc3545;
      color: white;
      padding: 2px 6px;
      border-radius: 10px;
      font-size: 9px;
      font-weight: bold;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0% { opacity: 1; transform: translateY(-50%) scale(1); }
      50% { opacity: 0.7; transform: translateY(-50%) scale(1.1); }
      100% { opacity: 1; transform: translateY(-50%) scale(1); }
    }
    
    /* Orta Panel */
    .center-panel {
      display: flex;
      flex-direction: column;
      background: white;
      overflow-y: auto;
    }
    
    /* SaÄŸ Sidebar */
    .right-sidebar {
      background: white;
      border-left: 1px solid #ddd;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
    }
    
    /* Sistem Durumu Kompakt */
    .sistem-durumu-kompakt {
      background: #e9ecef;
      padding: 8px;
      border-radius: 4px;
      font-size: 11px;
      line-height: 1.3;
    }
    
    .sistem-durumu-kompakt .durum-item {
      display: block;
      margin-bottom: 3px;
    }
    
    /* Kompakt Grid */
    .kompakt-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-bottom: 15px;
    }
    
    .kompakt-box {
      padding: 12px;
      border-radius: 6px;
      border-left: 3px solid;
    }
    
    .pdf-box {
      background: #f8f9fa;
      border-left-color: #28a745;
    }
    
    .aciklama-box {
      background: #d1ecf1;
      border-left-color: #17a2b8;
    }
    
    textarea, input[type="file"] { width: 100%; margin-bottom: 10px; }
    button { padding: 10px 20px; }
    .matched img { width: 150px; margin: 5px; border: 1px solid #ccc; }
    
    /* Tab Sistemi CSS */
    .hafta-tabs {
      display: flex !important;
      flex-wrap: wrap !important;
      border-bottom: 2px solid #ddd;
      margin-bottom: 20px;
      background: #f8f9fa;
      padding: 5px;
      border-radius: 8px 8px 0 0;
      gap: 5px;
    }
    
    .hafta-tab {
      background: #e9ecef;
      border: 1px solid #ddd;
      border-bottom: none;
      padding: 10px 15px;
      margin-right: 3px;
      margin-bottom: 3px;
      cursor: pointer;
      border-radius: 8px 8px 0 0;
      transition: all 0.3s ease;
      min-width: 120px;
      max-width: 160px;
      text-align: center;
      position: relative;
      flex: 0 0 auto;
    }
    
    .hafta-tab:hover {
      background: #dee2e6;
      transform: translateY(-2px);
    }
    
    .hafta-tab.active {
      background: #fff;
      border-color: #007bff;
      border-width: 2px;
      font-weight: bold;
      color: #007bff;
      transform: translateY(-3px);
      box-shadow: 0 3px 10px rgba(0,123,255,0.2);
    }
    
    .hafta-tab-content {
      display: none;
      border: 2px solid #ddd;
      padding: 20px;
      border-radius: 0 8px 8px 8px;
      background: #fff;
      min-height: 400px;
    }
    
    .hafta-tab-content.active {
      display: block;
      animation: fadeIn 0.3s ease-in;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .hafta-tab-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
    }
    
    .hafta-no-input {
      width: 50px;
      font-weight: bold;
      text-align: center;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 5px;
    }
    
    .tab-status-indicators {
      display: flex;
      gap: 5px;
      margin-top: 5px;
      justify-content: center;
    }
    
    .status-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      display: inline-block;
    }
    
    .status-pdf { background: #28a745; }
    .status-kartlar { background: #ffc107; }
    .status-eslesen { background: #17a2b8; }
    .status-empty { background: #dc3545; }
    .status-locked { background: #fd7e14; }
    
    /* Kilit ikonu stili */
    .tab-lock-icon {
      position: absolute;
      top: 2px;
      right: 2px;
      font-size: 10px;
      color: #fd7e14;
      text-shadow: 0 0 2px rgba(0,0,0,0.5);
    }
    
    /* Kilitli hafta stili */
    .hafta-tab.locked {
      background: linear-gradient(135deg, #fff 0%, #fff5e6 100%);
      border-color: #fd7e14;
      position: relative;
    }
    
    .hafta-tab.locked.active {
      background: linear-gradient(135deg, #fff 0%, #fff5e6 100%);
      border-color: #fd7e14;
      color: #fd7e14;
    }
    
    /* KayÄ±t butonu stili */
    .kayit-btn {
      background: #28a745;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      font-weight: bold;
      transition: all 0.3s ease;
    }
    
    .kayit-btn:hover {
      background: #218838;
      transform: translateY(-1px);
    }
    
    .kayit-btn.saved {
      background: #6c757d;
      cursor: default;
    }
    
    .kayit-btn.saved:hover {
      transform: none;
    }
    
    /* Kilit aÃ§ma butonu */
    .kilit-ac-btn {
      background: #fd7e14;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 11px;
      margin-left: 8px;
    }
    
    .kilit-ac-btn:hover {
      background: #e8630a;
    }
    
    /* Kilitli alan stili */
    .locked-area {
      position: relative;
      opacity: 0.6;
    }
    
    /* Kilitli alandaki input ve textarea'larÄ± devre dÄ±ÅŸÄ± bÄ±rak */
    .locked-area input,
    .locked-area textarea {
      pointer-events: none;
    }
    
    /* ZIP butonlarÄ± her zaman aktif kalacak */
    .locked-area button[onclick*="zipEslesenGorseller"],
    .locked-area button[onclick*="haftaZipIndir"],
    .locked-area button[onclick*="kopyalaGptMesaj"] {
      pointer-events: auto !important;
      opacity: 1 !important;
    }
    
    .locked-area::before {
      content: 'ğŸ”’ Bu alan kilitli - Kilidi aÃ§mak iÃ§in kilit aÃ§ma butonunu kullanÄ±n';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(253, 126, 20, 0.9);
      color: white;
      padding: 8px 12px;
      border-radius: 4px;
      font-size: 11px;
      z-index: 10;
      white-space: nowrap;
      pointer-events: none;
    }
    
    .yeni-hafta-tab {
      background: #28a745;
      color: white;
      border-color: #28a745;
      font-weight: bold;
    }
    
    .yeni-hafta-tab:hover {
      background: #218838;
      transform: translateY(-2px);
    }
    
    /* Hafta numarasÄ± dÃ¼zenleme */
    .hafta-no-display {
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 4px;
      transition: all 0.2s ease;
      border: 1px solid transparent;
    }
    
    .hafta-no-display:hover {
      background: #e3f2fd;
      border-color: #90caf9;
      transform: scale(1.05);
    }
    
    /* Grid responsive */
    @media (max-width: 768px) {
      .hafta-tab-content > div:first-of-type {
        grid-template-columns: 1fr !important;
      }
      
      /* Hasta bilgi paneli responsive */
      #hastaBilgiPanel {
        padding: 8px 10px !important;
      }
      
      #hastaBilgiPanel h3 {
        font-size: 14px !important;
      }
      
      #hastaBilgiPanel p {
        font-size: 11px !important;
      }
      
      #hastaBilgiButonlar button {
        padding: 5px 8px !important;
        font-size: 10px !important;
      }
      
      #hastaBilgiPanel > div {
        flex-direction: column !important;
        align-items: flex-start !important;
        gap: 8px !important;
      }
      
      #hastaBilgiButonlar {
        margin-left: 0 !important;
        width: 100%;
      }
      
      #hastaBilgiButonlar > div {
        flex-wrap: wrap !important;
        gap: 4px !important;
      }
    }

    /* Manuel Kart Stilleri */
    .manuel-kart {
      display: inline-block;
      margin: 10px;
      position: relative;
      vertical-align: top;
    }
    
    .manuel-kart-ekleme-btn {
      background: #28a745;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      margin: 10px 0;
    }
    
    .manuel-kart-ekleme-btn:hover {
      background: #218838;
    }
  </style>
</head>
<body>

  <div class="main-container">
    <!-- Header -->
    <div class="header">
      <h2>Lipedem Hasta Takip Sistemi</h2>
      <div style="display: flex; align-items: center; gap: 10px;">
        <button id="pdfOnizlemeBtn" onclick="pdfOnizlemeAc()" style="
          background: linear-gradient(135deg, #007bff, #0056b3); 
          color: white; 
          border: none; 
          padding: 8px 16px; 
          border-radius: 5px; 
          cursor: pointer; 
          font-size: 14px; 
          display: flex;
          align-items: center; 
          gap: 6px;
          transition: all 0.3s ease;
          box-shadow: 0 2px 4px rgba(0,123,255,0.3);
        " 
        onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 8px rgba(0,123,255,0.4)'"
        onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,123,255,0.3)'">
          ğŸ“„ PDF Ã–nizleme
        </button>
      </div>
    </div>

    <!-- Sol Sidebar -->
    <div class="left-sidebar">
      <!-- Hasta Listesi -->
      <div class="sidebar-section">
        <h3>ğŸ‘¥ Hastalar</h3>
        <input type="text" id="hastaAra" placeholder="Hasta ara..." style="width:100%; padding:6px; margin-bottom:8px; border:1px solid #ddd; border-radius:4px; font-size:12px;" oninput="filtreleHastalar()">
        <select id="arsivFiltre" style="width:100%; padding:6px; margin-bottom:10px; border:1px solid #ddd; border-radius:4px; font-size:12px;" onchange="filtreleHastalar()">
          <option value="aktif">Aktif Hastalar (0)</option>
          <option value="arsiv">ArÅŸiv (0)</option>
          <option value="tum">TÃ¼mÃ¼ (0)</option>
        </select>
        <ul id="hastaListesi"></ul>
        <button onclick="yeniHastaFormu()" style="width:100%; padding:8px; margin-top:10px; background:#28a745; color:white; border:none; border-radius:4px; cursor:pointer; font-size:12px;">+ Yeni Hasta</button>
      </div>
    </div>

    <!-- Sol AyÄ±rÄ±cÄ± -->
    <div class="resize-handle" id="leftHandle"></div>

    <!-- Orta Panel -->
    <div class="center-panel">
      <!-- Hasta Bilgi Paneli (Sabit) -->
      <div id="hastaBilgiPanel" style="background: #fff; border-bottom: 2px solid #007bff; padding: 10px 15px; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
        <div style="display: flex; justify-content: space-between; align-items: center; min-height: 40px;">
          <div style="flex: 1; min-width: 0;">
            <h3 id="secilenHastaIsim" style="margin: 0; color: #007bff; font-size: 16px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">Hasta SeÃ§ilmedi</h3>
            <p id="secilenHastaNot" style="margin: 2px 0 0 0; color: #666; font-size: 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">LÃ¼tfen sol menÃ¼den bir hasta seÃ§in</p>
          </div>
          <div id="hastaBilgiButonlar" style="display: none; flex-shrink: 0; margin-left: 15px;">
            <div style="display: flex; gap: 6px; flex-wrap: wrap;">
              <button onclick="duzenleHasta()" style="padding: 6px 10px; background: #ffc107; color: #000; border: none; border-radius: 3px; cursor: pointer; font-size: 11px;">âœï¸ DÃ¼zenle</button>
              <button onclick="arsivleHasta()" style="padding: 6px 10px; background: #6c757d; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 11px;">ğŸ“¦ ArÅŸivle</button>
              <button onclick="silHasta()" style="padding: 6px 10px; background: #dc3545; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 11px;" title="DosyayÄ± arÅŸivle ve listeden kaldÄ±r">ğŸ—‘ï¸ Sil</button>
              <button onclick="sadeceLisedenKaldir()" style="padding: 6px 10px; background: #fd7e14; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 11px;" title="Sadece listeden kaldÄ±r, dosyayÄ± koru">ğŸ“‹ Listeden KaldÄ±r</button>
              <button onclick="kapatDetay()" style="padding: 6px 10px; background: #6c757d; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 11px;">âœ–ï¸ Kapat</button>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Hafta Tab'larÄ± -->
      <div id="haftaTabs" class="hafta-tabs"></div>
      
      <!-- Hafta Ä°Ã§eriÄŸi -->
      <div id="haftaTabContent"></div>
      
      <!-- EÅŸleÅŸen Kartlar (Alt Panel) -->
      <div style="border-top: 1px solid #ddd; background: #f8f9fa; padding: 15px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
          <h4 style="margin: 0; color: #6f42c1;">ğŸ”— EÅŸleÅŸen Kartlar</h4>
          <button id="manuelKartEkleBtn" onclick="manuelKartEklemeModalAc()" class="manuel-kart-ekleme-btn" style="font-size: 11px; padding: 5px 10px;">
            â• Manuel Kart Ekle
          </button>
        </div>
        <!-- ğŸ“ ACCORDION PANEL SÄ°STEMÄ° -->
        <div id="accordionContainer" style="margin-top: 10px;">
          
          <!-- 1ï¸âƒ£ EÅLEÅEN KARTLAR ACCORDION -->
          <div class="accordion-section" style="margin-bottom: 8px;">
            <button class="accordion-header" onclick="toggleAccordion('eslesen')" style="
              width: 100%;
              padding: 12px 15px;
              background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
              color: white;
              border: none;
              border-radius: 8px;
              font-weight: bold;
              cursor: pointer;
              display: flex;
              justify-content: space-between;
              align-items: center;
              font-size: 14px;
            ">
              <span id="eslesenBaslik">ğŸ“‹ EÅŸleÅŸen Kartlar</span>
              <span id="eslesenIcon">â–¶</span>
            </button>
            <div id="eslesenContent" class="accordion-content" style="
              display: none;
              background: white;
              border: 1px solid #ddd;
              border-top: none;
              border-radius: 0 0 8px 8px;
              padding: 15px;
              min-height: 200px;
              max-height: 60vh;
              overflow-y: auto;
            ">
              <div style="text-align: center; color: #666; padding: 40px;">
                Ã–nce bir hasta seÃ§in...
              </div>
            </div>
          </div>

          <!-- 3ï¸âƒ£ YEMEK KULLANIM ANALÄ°ZÄ° ACCORDION -->
          <div class="accordion-section" style="margin-bottom: 8px;">
            <button class="accordion-header" onclick="toggleAccordion('analiz')" style="
              width: 100%;
              padding: 12px 15px;
              background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
              color: white;
              border: none;
              border-radius: 8px;
              font-weight: bold;
              cursor: pointer;
              display: flex;
              justify-content: space-between;
              align-items: center;
              font-size: 14px;
            ">
              <span id="analizBaslik">  Yemek KullanÄ±m Analizi (0/239)</span>
              <span id="analizIcon">â–¶</span>
            </button>
            <div id="analizContent" class="accordion-content" style="
              display: none;
              background: white;
              border: 1px solid #ddd;
              border-top: none;
              border-radius: 0 0 8px 8px;
              padding: 15px;
            ">
              <div style="margin-bottom: 10px; text-align: center;">
                <button onclick="siralaYemekAnalizi('cok')" id="btnCok" style="margin: 2px; padding: 5px 10px; border: none; border-radius: 4px; background: #28a745; color: white; cursor: pointer; font-size: 11px;">ğŸ”º En Ã‡ok KullanÄ±lan</button>
                <button onclick="siralaYemekAnalizi('az')" id="btnAz" style="margin: 2px; padding: 5px 10px; border: none; border-radius: 4px; background: #dc3545; color: white; cursor: pointer; font-size: 11px;">ğŸ”» En Az KullanÄ±lan</button>
                <button onclick="siralaYemekAnalizi('hic')" id="btnHic" style="margin: 2px; padding: 5px 10px; border: none; border-radius: 4px; background: #6c757d; color: white; cursor: pointer; font-size: 11px;">âŒ HiÃ§ KullanÄ±lmayan</button>
                <button onclick="siralaYemekAnalizi('alfabetik')" id="btnAlfabetik" style="margin: 2px; padding: 5px 10px; border: none; border-radius: 4px; background: #17a2b8; color: white; cursor: pointer; font-size: 11px;">ğŸ“ Alfabetik</button>
              </div>
              
              <div id="yemekAnaliziListe" style="max-height: 60vh; overflow-y: auto; font-size: 13px; line-height: 1.4; border: 1px solid #eee; border-radius: 4px; background: #fafafa;">
                <div style="text-align: center; color: #666; padding: 20px;">Hasta ve hafta seÃ§in...</div>
              </div>
            </div>
          </div>

          <!-- 2ï¸âƒ£ EÅLEÅMEYEN TARÄ°FLER ACCORDION (EN ALTTA) -->
          <div class="accordion-section" style="margin-bottom: 8px;">
            <button class="accordion-header" onclick="toggleAccordion('eslesmeyenler')" style="
              width: 100%;
              padding: 12px 15px;
              background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
              color: white;
              border: none;
              border-radius: 8px;
              font-weight: bold;
              cursor: pointer;
              display: flex;
              justify-content: space-between;
              align-items: center;
              font-size: 14px;
            ">
              <span id="eslesmeyenlerBaslik">  EÅŸleÅŸmeyen Tarifler</span>
              <span id="eslesmeyenlerIcon">â–¶</span>
            </button>
            <div id="eslesmeyenlerContent" class="accordion-content" style="
              display: none;
              background: white;
              border: 1px solid #ddd;
              border-top: none;
              border-radius: 0 0 8px 8px;
              padding: 15px;
              min-height: 100px;
              max-height: 50vh;
              overflow-y: auto;
            ">
              <div style="text-align: center; color: #666; padding: 20px;">
                EÅŸleÅŸmeyen tarif bulunamadÄ±
              </div>
            </div>
          </div>

          <!-- 4ï¸âƒ£ YEMEK VERÄ°TABANI ANALÄ°ZÄ° ACCORDION -->
          <div class="accordion-section" style="margin-bottom: 8px;">
            <button class="accordion-header" onclick="toggleAccordion('veritabaniAnalizi')" style="
              width: 100%;
              padding: 12px 15px;
              background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
              color: white;
              border: none;
              border-radius: 8px;
              font-weight: bold;
              cursor: pointer;
              display: flex;
              justify-content: space-between;
              align-items: center;
              font-size: 14px;
            ">
              <span id="veritabaniAnaliziBaslik">ğŸ½ï¸ Yemek VeritabanÄ± Analizi</span>
              <span style="color: #28a745; font-size: 10px; margin-left: 5px;" title="Otomatik GitHub senkronizasyonu aktif">ğŸ”„ Auto-Sync</span>
              <!-- <button onclick="lokalFoodListGithubYukle()" style="
                background: #007bff;
                color: white;
                border: none;
                padding: 4px 8px;
                border-radius: 4px;
                font-size: 11px;
                cursor: pointer;
                margin-left: 10px;
              " title="Lokal food_list.json dosyasÄ±nÄ± GitHub'a yÃ¼kle">ğŸš€ Lokalâ†’GitHub</button> -->
              <span id="veritabaniAnaliziIcon">â–¶</span>
            </button>
            <div id="veritabaniAnaliziContent" class="accordion-content" style="
              display: none;
              background: white;
              border: 1px solid #ddd;
              border-top: none;
              border-radius: 0 0 8px 8px;
              padding: 15px;
              min-height: 100px;
              max-height: 70vh;
              overflow-y: auto;
            ">
              <div style="text-align: center; color: #666; padding: 20px;">
                PDF yÃ¼klendiÄŸinde yemek veritabanÄ± analizi burada gÃ¶rÃ¼ntÃ¼lenecek
              </div>
            </div>
          </div>
          
          <!-- BUTONLAR Ä°Ã‡Ä°N SABÄ°T ALAN (Ä°ndirme butonlarÄ± vs) -->
          <div id="sidebarButtons" style="margin-top: 10px; padding: 10px; border: 1px solid #ddd; border-radius: 8px; background: white; min-height: 60px;">
            <!-- Åablon ArÅŸivi Butonu -->
            <button onclick="acSablonArsivi()" style="
              width: 100%; 
              padding: 10px; 
              background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
              color: white; 
              border: none; 
              border-radius: 6px; 
              font-size: 14px; 
              font-weight: bold; 
              cursor: pointer;
              margin-bottom: 8px;
              transition: all 0.3s ease;
            " 
            onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(102,126,234,0.3)'" 
            onmouseout="this.style.transform='translateY(0px)'; this.style.boxShadow='none'">
              ğŸ“‹ Åablon ArÅŸivi
            </button>
            
            <!-- Diyet TÃ¼rleri YÃ¶netimi Butonu -->
            <button onclick="acDiyetTurleri()" style="
              width: 100%; 
              padding: 10px; 
              background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); 
              color: white; 
              border: none; 
              border-radius: 6px; 
              font-size: 14px; 
              font-weight: bold; 
              cursor: pointer;
              margin-bottom: 8px;
              transition: all 0.3s ease;
            " 
            onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(240,147,251,0.3)'" 
            onmouseout="this.style.transform='translateY(0px)'; this.style.boxShadow='none'">
              ğŸ¯ Diyet TÃ¼rleri
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- SaÄŸ AyÄ±rÄ±cÄ± -->
    <div class="resize-handle" id="rightHandle"></div>

    <!-- SaÄŸ Sidebar -->
    <div class="right-sidebar">
      <!-- Sistem Durumu -->
      <div class="sidebar-section">
        <h3>ğŸ“Š Sistem</h3>
        <div class="sistem-durumu-kompakt">
          <span class="durum-item" id="tariflerKlasoruDurumu">ğŸ”„ Tarifler kontrol ediliyor...</span>
          <span class="durum-item" id="dataKlasoruDurumu">ğŸ”„ Data kontrol ediliyor...</span>
          <span class="durum-item" id="githubDurumu">â³ GitHub kontrol ediliyor...</span>
        </div>
      </div>

      <!-- HÄ±zlÄ± Ä°ÅŸlemler -->
      <div class="sidebar-section">
        <h3>âš¡ Ä°ÅŸlemler</h3>
        <input type="password" id="githubToken" placeholder="GitHub Token" style="width:100%; margin-bottom:5px; padding:6px; font-size:11px; border:1px solid #ddd; border-radius:3px;" oninput="saveTokenToStorage()">
        <input type="text" id="githubRepo" placeholder="GitHub Repo (owner/repo)" value="mustafasacar35/lipodem-takip-paneli-3" style="width:100%; margin-bottom:5px; padding:6px; font-size:11px; border:1px solid #ddd; border-radius:3px;">
        <button onclick="testGitHubToken()" style="width:100%; margin-bottom:5px; padding:6px; font-size:11px; background:#17a2b8; color:white; border:none; border-radius:3px; cursor:pointer;">ğŸ” Token Test Et</button>
        <!-- Otomatik senkronizasyon aktif, manuel buton gerekmiyor -->
        <!-- <button onclick="lokalFoodListGithubYukle()" style="width:100%; margin-bottom:5px; padding:6px; font-size:11px; background:#007bff; color:white; border:none; border-radius:3px; cursor:pointer;">ğŸš€ Food List Senkronize</button> -->
      </div>

      <!-- AraÃ§lar -->
      <div class="sidebar-section">
        <h3>ğŸ› ï¸ AraÃ§lar</h3>
        <input type="file" id="cokluPdfInput" multiple accept=".pdf" style="display:none" onchange="processCokluPdf(this.files)">
        <button onclick="document.getElementById('cokluPdfInput').click()" style="width:100%; margin-bottom:5px; padding:6px; font-size:11px; background:#6f42c1; color:white; border:none; border-radius:3px; cursor:pointer; font-weight:bold;">ğŸ“ Ã‡oklu PDF YÃ¼kle</button>
        <button onclick="yeniKartFormGoster()" style="width:100%; margin-bottom:5px; padding:6px; font-size:11px; background:#17a2b8; color:white; border:none; border-radius:3px; cursor:pointer;">+ Yeni Kart</button>
        <button onclick="kartDuzenleFormGoster()" style="width:100%; margin-bottom:5px; padding:6px; font-size:11px; background:#ffc107; color:black; border:none; border-radius:3px; cursor:pointer;">âœï¸ Kart DÃ¼zenle</button>
        <button onclick="kartSilFormGoster()" style="width:100%; margin-bottom:5px; padding:6px; font-size:11px; background:#dc3545; color:white; border:none; border-radius:3px; cursor:pointer;">ğŸ—‘ï¸ Kart Sil</button>
        <button onclick="manuelEslestirmePaneliGoster()" style="width:100%; margin-bottom:5px; padding:6px; font-size:11px; background:#6f42c1; color:white; border:none; border-radius:3px; cursor:pointer;">ğŸ”— Manuel EÅŸleÅŸtirme</button>
        <button onclick="eslesmemeRegeleriPaneliGoster()" style="width:100%; margin-bottom:5px; padding:6px; font-size:11px; background:#dc3545; color:white; border:none; border-radius:3px; cursor:pointer;">ğŸš« EÅŸleÅŸme YasaklarÄ±</button>
        <button onclick="generateCustomLenfMasajTakvimi()" style="width:100%; margin-bottom:5px; padding:6px; font-size:11px; background:#28a745; color:white; border:none; border-radius:3px; cursor:pointer;">ğŸ’† Lenf Masaj Takvimi</button>
        <button onclick="generateCustomEgzersizTakvimi()" style="width:100%; margin-bottom:5px; padding:6px; font-size:11px; background:#007bff; color:white; border:none; border-radius:3px; cursor:pointer;">ğŸƒ Egzersiz Takvimi</button>
        <button onclick="openBlacklistModal()" style="width:100%; margin-bottom:5px; padding:6px; font-size:11px; background:#dc3545; color:white; border:none; border-radius:3px; cursor:pointer;">ğŸš« Karaliste</button>
        
        <!-- Alternatif Yemek Kontrolleri -->
        <div id="alternativeControls" style="display: none; border-top: 1px solid #ddd; padding-top: 10px; margin-top: 10px;">
          <h4 style="margin: 0 0 5px 0; font-size: 12px; color: #17a2b8;">ğŸ”„ Alternatif Mod</h4>
          <button onclick="alternatifleriDurdur()" style="width:48%; margin-bottom:5px; padding:6px; font-size:11px; background:#6c757d; color:white; border:none; border-radius:3px; cursor:pointer;">â¹ï¸ Durdur</button>
          <button onclick="orijinalYemegiGeriYukle()" style="width:48%; margin-bottom:5px; padding:6px; font-size:11px; background:#28a745; color:white; border:none; border-radius:3px; cursor:pointer; margin-left: 4%;">â†©ï¸ Orijinal</button>
          
          <div id="alternativeInfo" style="font-size: 10px; color: #666; margin: 5px 0; padding: 5px; background: #f8f9fa; border-radius: 3px;">
            Alternatif mod aktif deÄŸil
          </div>
          
          <!-- Alternatif Yemek Listesi -->
          <div id="alternativeList" style="display: none; max-height: 200px; overflow-y: auto; border: 1px solid #ddd; border-radius: 3px; margin-top: 5px;">
            <!-- Alternatif yemekler buraya gelecek -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- EÅŸleÅŸme YasaklarÄ± Paneli -->
  <div id="eslesmemePanel" style="display:none; background:#fff; border:2px solid #dc3545; padding:20px; margin:16px 0; border-radius:8px; position:relative;">
    <button onclick="eslesmemeRegeleriPaneliGizle()" style="position:absolute; top:10px; right:10px; background:none; border:none; font-size:20px; cursor:pointer; color:#dc3545; font-weight:bold; width:30px; height:30px; border-radius:50%; display:flex; align-items:center; justify-content:center;" title="Kapat">Ã—</button>
    <h3>EÅŸleÅŸme YasaklarÄ± Paneli</h3>
    <div style="display:flex; gap:20px; margin-bottom:20px;">
      <div style="flex:1;">
        <label style="display:block; margin-bottom:5px; font-weight:bold;">PDF'deki Yemek AdÄ±:</label>
        <textarea id="yasakTarifAdi" placeholder="Ã–rn: tavuklu hÃ¼nkar beÄŸendi" style="width:100%; height:80px; padding:8px; resize:vertical;"></textarea>
        <small style="display:block; color:#666; margin-top:5px;">
          PDF'de gÃ¶rÃ¼nen yemek adÄ±nÄ± yazÄ±n (bu hiÃ§ eÅŸleÅŸmesin)
        </small>
      </div>
      <div style="flex:1;">
        <label style="display:block; margin-bottom:5px; font-weight:bold;">YasaklÄ± Kartlar:</label>
        <input type="text" id="yasakKartArama" placeholder="Kart adÄ±nda ara..." style="width:100%; padding:8px; margin-bottom:8px;" />
        <div id="yasakKartListesi" style="height:120px; overflow-y:auto; border:1px solid #ddd; padding:8px; background:#f8f9fa;">
          <!-- Dinamik kartlar buraya gelecek -->
        </div>
        <small style="display:block; color:#666; margin-top:5px;">
          Bu kartlarla eÅŸleÅŸmesin diye iÅŸaretleyin
        </small>
      </div>
    </div>
    <div style="margin-bottom:15px;">
      <button onclick="eslesmemeKuraliEkle()" style="background:#dc3545; color:white; padding:10px 20px; border:none; border-radius:5px; cursor:pointer;">
        Yasak Ekle
      </button>
      <button onclick="eslesmemeKurallariniTemizle()" style="background:#6c757d; color:white; padding:10px 20px; border:none; border-radius:5px; cursor:pointer; margin-left:10px;">
        TÃ¼m YasaklarÄ± Temizle
      </button>
      <button onclick="eslesmemeKurallariniGitHubKaydet()" style="background:#007bff; color:white; padding:10px 20px; border:none; border-radius:5px; cursor:pointer; margin-left:10px;">
        GitHub'a Kaydet
      </button>
      <button onclick="eslesmemeKurallariniGitHubYukle()" style="background:#6f42c1; color:white; padding:10px 20px; border:none; border-radius:5px; cursor:pointer; margin-left:10px;">
        GitHub'dan YÃ¼kle
      </button>
    </div>
    <div id="eslesmemeStatus" style="margin-bottom:15px; padding:10px; border-radius:5px; display:none;"></div>
    <div>
      <h4>KayÄ±tlÄ± EÅŸleÅŸme YasaklarÄ±:</h4>
      <div id="eslesmemeListesi" style="max-height:200px; overflow-y:auto; border:1px solid #ddd; padding:10px; background:#f8f9fa;">
        <em>HenÃ¼z yasak yok</em>
      </div>
    </div>
  </div>

  <!-- Manuel EÅŸleÅŸtirme Paneli -->
  <div id="manuelEslestirmePanel" style="display:none; background:#fff; border:2px solid #28a745; padding:20px; margin:16px 0; border-radius:8px; position:relative;">
    <button onclick="manuelEslestirmePaneliGizle()" style="position:absolute; top:10px; right:10px; background:none; border:none; font-size:20px; cursor:pointer; color:#28a745; font-weight:bold; width:30px; height:30px; border-radius:50%; display:flex; align-items:center; justify-content:center;" title="Kapat">Ã—</button>
    <h3>Manuel EÅŸleÅŸtirme Paneli</h3>
    <div style="display:flex; gap:20px; margin-bottom:20px;">
      <div style="flex:1;">
        <label style="display:block; margin-bottom:5px; font-weight:bold;">PDF'deki Yemek AdÄ±:</label>
        <textarea id="manuelTarifAdi" placeholder="Ã–rn: *KÄ±ymalÄ± karnabahar /bamya yemeÄŸi" style="width:100%; height:80px; padding:8px; resize:vertical;"></textarea>
        <small style="display:block; color:#666; margin-top:5px;">
          PDF'de gÃ¶rÃ¼nen tam metni yazÄ±n (*, / iÅŸaretleri dahil)
        </small>
      </div>
      <div style="flex:1;">
        <label style="display:block; margin-bottom:5px; font-weight:bold;">EÅŸleÅŸecek Kartlar:</label>
        <input type="text" id="eskiKartArama" placeholder="Kart adÄ±nda ara..." style="width:100%; padding:8px; margin-bottom:8px;" oninput="manuelEslestirmeKartAra(this.value)" />
        <div id="manuelKartListesi" style="height:120px; overflow-y:auto; border:1px solid #ddd; padding:8px; background:#f8f9fa;">
          <!-- Dinamik kartlar buraya gelecek -->
        </div>
        <small style="display:block; color:#666; margin-top:5px;">
          EÅŸleÅŸmesini istediÄŸiniz kartlarÄ± iÅŸaretleyin
        </small>
      </div>
    </div>
    <div style="margin-bottom:15px;">
      <button onclick="manuelEslestirmeEkle()" style="background:#28a745; color:white; padding:10px 20px; border:none; border-radius:5px; cursor:pointer;">
        EÅŸleÅŸtirme Ekle
      </button>
      <button onclick="manuelEslestirmeleriTemizle()" style="background:#dc3545; color:white; padding:10px 20px; border:none; border-radius:5px; cursor:pointer; margin-left:10px;">
        TÃ¼m EÅŸleÅŸtirmeleri Temizle
      </button>
      <button onclick="manuelEslestirmeleriGitHubKaydet()" style="background:#007bff; color:white; padding:10px 20px; border:none; border-radius:5px; cursor:pointer; margin-left:10px;">
        GitHub'a Kaydet
      </button>
      <button onclick="manuelEslestirmeleriGitHubYukle()" style="background:#6f42c1; color:white; padding:10px 20px; border:none; border-radius:5px; cursor:pointer; margin-left:10px;">
        GitHub'dan YÃ¼kle
      </button>
    </div>
    <div id="manuelEslestirmeStatus" style="margin-bottom:15px; padding:10px; border-radius:5px; display:none;"></div>
    <div>
      <h4>KayÄ±tlÄ± Manuel EÅŸleÅŸtirmeler:</h4>
      <div id="manuelEslestirmeListesi" style="max-height:200px; overflow-y:auto; border:1px solid #ddd; padding:10px; background:#f8f9fa;">
        <em>HenÃ¼z manuel eÅŸleÅŸtirme yok</em>
      </div>
    </div>
  </div>

  <!-- Kart Silme Formu -->
  <div id="kartSilFormu" style="display:none; background:#fff; border:2px solid #dc3545; padding:20px; margin:16px 0; border-radius:8px; position:relative;">
    <button onclick="kartSilFormGizle()" style="position:absolute; top:10px; right:10px; background:none; border:none; font-size:20px; cursor:pointer; color:#dc3545; font-weight:bold; width:30px; height:30px; border-radius:50%; display:flex; align-items:center; justify-content:center;" title="Kapat">Ã—</button>
    <h3>Tarif KartÄ± Sil</h3>
    <div style="margin-bottom:15px;">
      <label style="display:block; margin-bottom:5px; font-weight:bold;">Silinecek KartÄ± SeÃ§in:</label>
      <input type="text" id="kartAramaInput" placeholder="Kart adÄ±nda ara... (Ã¶rn: avok salat)" style="width:300px; padding:8px; margin-bottom:8px;" />
      <select id="silinecekKart" style="width:300px; padding:8px;">
        <option value="">Kart seÃ§in...</option>
      </select>
      <small style="display:block; color:#666; margin-top:5px;">
        YukarÄ±daki arama kutusuna yazarak filtreleyin veya listeden seÃ§in
      </small>
      <small style="display:block; color:#666; margin-top:2px;">
        Bu iÅŸlem hem dosyayÄ± hem de list.json'dan kaydÄ± siler
      </small>
    </div>
    <div id="onizlemeAlani" style="margin-bottom:15px; text-align:center;"></div>
    <div style="margin-bottom:15px;">
      <button onclick="kartSil()" style="background:#dc3545; color:white; padding:10px 20px; border:none; border-radius:5px; cursor:pointer;">
        KartÄ± Sil
      </button>
      <button onclick="kartSilFormGizle()" style="background:#6c757d; color:white; padding:10px 20px; border:none; border-radius:5px; cursor:pointer; margin-left:10px;">
        Ä°ptal
      </button>
    </div>
    <div id="silmeStatus" style="margin-top:15px; padding:10px; border-radius:5px; display:none;"></div>
  </div>

  <!-- Yeni Kart Ekleme Formu -->
  <div id="yeniKartFormu" style="display:none; background:#fff; border:2px solid #007bff; padding:20px; margin:16px 0; border-radius:8px; position:relative;">
    <button onclick="yeniKartFormGizle()" style="position:absolute; top:10px; right:10px; background:none; border:none; font-size:20px; cursor:pointer; color:#007bff; font-weight:bold; width:30px; height:30px; border-radius:50%; display:flex; align-items:center; justify-content:center;" title="Kapat">Ã—</button>
    <h3>Yeni Tarif KartÄ± Ekle</h3>
    <div style="margin-bottom:15px;">
      <label style="display:block; margin-bottom:5px; font-weight:bold;">Kart AdÄ±:</label>
      <input id="yeniKartAdi" placeholder="Ã–rn: mantarli_tavuk_sote" style="width:300px; padding:8px;" />
      <small style="display:block; color:#666; margin-top:5px;">
        Not: TÃ¼rkÃ§e karakterler kullanmayÄ±n, boÅŸluk yerine _ kullanÄ±n, .jpg eklemeyin
      </small>
    </div>
    <div style="margin-bottom:15px;">
      <label style="display:block; margin-bottom:5px; font-weight:bold;">GÃ¶rsel DosyasÄ±:</label>
      <input type="file" id="yeniKartDosya" accept="image/jpeg,image/jpg,image/png" style="padding:8px;" />
      <small style="display:block; color:#666; margin-top:5px;">
        Sadece JPG/PNG dosyalarÄ± kabul edilir
      </small>
    </div>
    <div style="margin-bottom:15px;">
      <button onclick="yeniKartKaydet()" style="background:#28a745; color:white; padding:10px 20px; border:none; border-radius:5px; cursor:pointer;">
        KartÄ± Kaydet ve GitHub'a YÃ¼kle
      </button>
      <button onclick="yeniKartFormGizle()" style="background:#6c757d; color:white; padding:10px 20px; border:none; border-radius:5px; cursor:pointer; margin-left:10px;">
        Ä°ptal
      </button>
    </div>
    <div id="yuklemeStatus" style="margin-top:15px; padding:10px; border-radius:5px; display:none;"></div>
  </div>

  <!-- Kart DÃ¼zenleme Formu -->
  <div id="kartDuzenleFormu" style="display:none; background:#fff; border:2px solid #ffc107; padding:20px; margin:16px 0; border-radius:8px; position:relative;">
    <button onclick="kartDuzenleFormGizle()" style="position:absolute; top:10px; right:10px; background:none; border:none; font-size:20px; cursor:pointer; color:#ffc107; font-weight:bold; width:30px; height:30px; border-radius:50%; display:flex; align-items:center; justify-content:center;" title="Kapat">Ã—</button>
    <h3>Tarif KartÄ± DÃ¼zenle</h3>
    
    <!-- Kart SeÃ§imi -->
    <div style="margin-bottom:20px;">
      <label style="display:block; margin-bottom:5px; font-weight:bold;">DÃ¼zenlenecek KartÄ± SeÃ§in:</label>
      <div style="display:flex; gap:8px; margin-bottom:10px;">
        <input type="text" id="duzenleKartArama" placeholder="Kart adÄ±nda ara..." style="flex:1; padding:8px;" oninput="kartListesiniFiltreleForDuzenleme(this.value)" />
        <button onclick="listjsonTemizle()" style="padding:8px 12px; background:#dc3545; color:white; border:none; border-radius:4px; cursor:pointer; font-size:12px;"
                title="Mevcut olmayan dosyalarÄ± list.json'dan temizle">
          ğŸ§¹ Temizle
        </button>
      </div>
      <div id="duzenleKartListesi" style="height:150px; overflow-y:auto; border:1px solid #ddd; padding:10px; background:#f8f9fa;">
        <!-- Dinamik kartlar buraya gelecek -->
      </div>
    </div>
    
    <!-- SeÃ§ili Kart Bilgileri -->
    <div id="seciliKartBilgileri" style="display:none;">
      <div style="margin-bottom:15px;">
        <label style="display:block; margin-bottom:5px; font-weight:bold;">Mevcut Kart:</label>
        <div id="mevcutKartOnizleme" style="border:1px solid #ddd; padding:10px; background:#f8f9fa; border-radius:5px;">
          <!-- Mevcut kart Ã¶nizlemesi -->
        </div>
      </div>
      
      <div style="margin-bottom:15px;">
        <label style="display:block; margin-bottom:5px; font-weight:bold;">Yeni Kart AdÄ±:</label>
        <input id="duzenleKartYeniAdi" placeholder="Yeni kart adÄ±" style="width:300px; padding:8px;" />
        <small style="display:block; color:#666; margin-top:5px;">
          Not: TÃ¼rkÃ§e karakterler kullanmayÄ±n, boÅŸluk yerine _ kullanÄ±n, .jpg eklemeyin
        </small>
      </div>
      
      <div style="margin-bottom:15px;">
        <label style="display:block; margin-bottom:5px; font-weight:bold;">Yeni GÃ¶rsel DosyasÄ± (isteÄŸe baÄŸlÄ±):</label>
        <input type="file" id="duzenleKartYeniDosya" accept="image/jpeg,image/jpg,image/png" style="padding:8px;" />
        <small style="display:block; color:#666; margin-top:5px;">
          BoÅŸ bÄ±rakÄ±rsanÄ±z sadece isim deÄŸiÅŸir. Dosya seÃ§erseniz hem isim hem gÃ¶rsel deÄŸiÅŸir.
        </small>
      </div>
      
      <div style="margin-bottom:15px;">
        <button onclick="kartDuzenlemeKaydet()" style="background:#ffc107; color:#212529; padding:10px 20px; border:none; border-radius:5px; cursor:pointer; font-weight:bold;">
          DeÄŸiÅŸiklikleri Kaydet
        </button>
        <button onclick="kartDuzenleFormGizle()" style="background:#6c757d; color:white; padding:10px 20px; border:none; border-radius:5px; cursor:pointer; margin-left:10px;">
          Ä°ptal
        </button>
      </div>
    </div>
    
    <div id="duzenlemeStatus" style="margin-top:15px; padding:10px; border-radius:5px; display:none;"></div>
  </div>

  <!-- Manuel Kart Ekleme Modal -->
  <div id="manuelKartModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000;" onclick="manuelKartModalKapat(event)">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 8px; width: 80%; max-width: 800px; max-height: 80%; overflow: hidden;" onclick="event.stopPropagation()">
      <div style="padding: 20px; border-bottom: 1px solid #ddd;">
        <h3 style="margin: 0; color: #333;">Manuel Kart Ekleme</h3>
        <p style="margin: 5px 0 0 0; color: #666; font-size: 14px;">SeÃ§ili haftaya eklemek istediÄŸiniz tarif kartlarÄ±nÄ± seÃ§in</p>
      </div>
      
      <div style="padding: 20px;">
        <input type="text" id="manuelKartArama" placeholder="Tarif ara (boÅŸ bÄ±rakÄ±n tÃ¼mÃ¼nÃ¼ gÃ¶rmek iÃ§in)..." style="width: 100%; padding: 10px; font-size: 14px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 15px;" oninput="manuelKartAramaYap(this.value)">
        
        <div id="manuelKartListe" style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; padding: 10px;">
          <div style="text-align: center; color: #666; padding: 20px;">YÃ¼kleniyor...</div>
        </div>
      </div>
      
      <div style="padding: 20px; border-top: 1px solid #ddd; text-align: right;">
        <button onclick="manuelKartModalKapat()" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin-right: 10px;">Ä°ptal</button>
        <button onclick="secilenManuelKartlariEkle()" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">SeÃ§ilen KartlarÄ± Ekle</button>
      </div>
    </div>
  </div>

  <!-- Yemek Ekleme/DÃ¼zenleme Modal -->
  <div id="yemekDuzenleModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10001;" onclick="yemekModalKapat(event)">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 8px; width: 90%; max-width: 900px; max-height: 90%; overflow: hidden;" onclick="event.stopPropagation()">
      <div style="padding: 20px; border-bottom: 1px solid #ddd; background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white;">
        <h3 style="margin: 0;" id="yemekModalBaslik">ğŸ½ï¸ Yemek Ekle/DÃ¼zenle</h3>
        <p style="margin: 5px 0 0 0; font-size: 14px; opacity: 0.9;">Yemek veritabanÄ±na yeni yemek ekleyin veya mevcut yemeÄŸi dÃ¼zenleyin</p>
      </div>
      
      <!-- Tab Navigation -->
      <div style="display: flex; border-bottom: 1px solid #ddd; background: #f8f9fa;">
        <button type="button" id="yeniYemekTab" onclick="tabAc('yeniYemek')" style="flex: 1; padding: 12px 20px; border: none; background: transparent; cursor: pointer; font-weight: 500; transition: all 0.3s ease; border-bottom: 3px solid transparent;">
          <i class="fas fa-plus-circle" style="margin-right: 8px; color: #28a745;"></i>Yeni Yemek Ekle
        </button>
        <button type="button" id="eslestirTab" onclick="tabAc('eslestir')" style="flex: 1; padding: 12px 20px; border: none; background: transparent; cursor: pointer; font-weight: 500; transition: all 0.3s ease; border-bottom: 3px solid transparent;">
          <i class="fas fa-link" style="margin-right: 8px; color: #20c997;"></i>VeritabanÄ±ndan EÅŸleÅŸtir
        </button>
      </div>
      
      <!-- Tab Content Container -->
      <div style="padding: 20px; max-height: 60vh; overflow-y: auto;">
        
        <!-- Yeni Yemek Ekleme Tab -->
        <div id="yeniYemekContent" style="display: block;">
        <form id="yemekDuzenleForm">
          <!-- Temel Bilgiler -->
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
            <div>
              <label style="display: block; font-weight: bold; margin-bottom: 5px; color: #333;">Yemek AdÄ± *</label>
              <input type="text" id="yemekAdi" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
            </div>
            <div>
              <label style="display: block; font-weight: bold; margin-bottom: 5px; color: #333;">Kategori *</label>
              <select id="yemekKategori" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                <option value="">Kategori SeÃ§in...</option>
                <option value="KAHVALTI">KahvaltÄ±</option>
                <option value="OGLE">Ã–ÄŸle</option>
                <option value="AKSAM">AkÅŸam</option>
                <option value="APERATIF">Aperatif</option>
                <option value="TATLI">TatlÄ±</option>
                <option value="ICECEK">Ä°Ã§ecek</option>
                <option value="SALATA">Salata</option>
                <option value="CORBALAR">Ã‡orba</option>
                <option value="SEBZE">Sebze</option>
                <option value="ET">Et</option>
                <option value="BALIK">BalÄ±k</option>
                <option value="TAVUK">Tavuk</option>
              </select>
            </div>
          </div>

          <!-- Besin DeÄŸerleri -->
          <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;">
              <div>
                <label style="display: block; font-weight: bold; margin-bottom: 5px; color: #333;">
                  ğŸ§® Kalori (kcal)
                </label>
                <input type="number" id="yemekKalori" min="0" step="0.1" readonly 
                       style="width: 100%; padding: 8px; border: 1px solid #28a745; border-radius: 4px; background: #d4f4dd; color: #155724; font-weight: bold; text-align: center;"
                       title="Kalori = (Protein Ã— 4) + (Karbonhidrat Ã— 4) + (YaÄŸ Ã— 9)">
              </div>
              <div>
                <label style="display: block; font-weight: bold; margin-bottom: 5px; color: #333;">Protein (g)</label>
                <input type="number" id="yemekProtein" min="0" step="0.1" 
                       style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"
                       oninput="hesaplaKalori()">
              </div>
              <div>
                <label style="display: block; font-weight: bold; margin-bottom: 5px; color: #333;">Karbonhidrat (g)</label>
                <input type="number" id="yemekKarb" min="0" step="0.1" 
                       style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"
                       oninput="hesaplaKalori()">
              </div>
              <div>
                <label style="display: block; font-weight: bold; margin-bottom: 5px; color: #333;">YaÄŸ (g)</label>
                <input type="number" id="yemekYag" min="0" step="0.1" 
                       style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"
                       oninput="hesaplaKalori()">
              </div>
            </div>
          </div>

          <!-- Porsiyon Bilgileri -->
          <div style="background: #e8f4f8; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
            <h4 style="margin: 0 0 15px 0; color: #495057;">âš–ï¸ Porsiyon Bilgileri</h4>
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;">
              <div>
                <label style="display: block; font-weight: bold; margin-bottom: 5px; color: #333;">Min Miktar</label>
                <input type="number" id="yemekMinMiktar" min="0" step="0.1" value="0.5" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
              </div>
              <div>
                <label style="display: block; font-weight: bold; margin-bottom: 5px; color: #333;">Max Miktar</label>
                <input type="number" id="yemekMaxMiktar" min="0" step="0.1" value="1" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
              </div>
              <div>
                <label style="display: block; font-weight: bold; margin-bottom: 5px; color: #333;">AdÄ±m</label>
                <input type="number" id="yemekAdim" min="0.1" step="0.1" value="0.5" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
              </div>
              <div>
                <label style="display: block; font-weight: bold; margin-bottom: 5px; color: #333;">Ã‡arpan</label>
                <input type="number" id="yemekCarpan" min="0.1" step="0.1" value="1" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
              </div>
            </div>
          </div>

          <!-- Ã–zellikler -->
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
            <!-- Rol -->
            <div>
              <label style="display: block; font-weight: bold; margin-bottom: 5px; color: #333;">Rol</label>
              <select id="yemekRol" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                <option value="mainDish">Ana Yemek</option>
                <option value="drink">Ä°Ã§ecek</option>
                <option value="snack">Aperatif</option>
                <option value="dessert">TatlÄ±</option>
                <option value="side">Yan Yemek</option>
              </select>
            </div>

            <!-- Ã–ÄŸÃ¼n TÃ¼rleri -->
            <div>
              <label style="display: block; font-weight: bold; margin-bottom: 5px; color: #333;">Ã–ÄŸÃ¼n TÃ¼rleri</label>
              <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                <label style="display: flex; align-items: center; gap: 5px; font-size: 13px;">
                  <input type="checkbox" id="yemekKahvalti"> KahvaltÄ±
                </label>
                <label style="display: flex; align-items: center; gap: 5px; font-size: 13px;">
                  <input type="checkbox" id="yemekOgle"> Ã–ÄŸle
                </label>
                <label style="display: flex; align-items: center; gap: 5px; font-size: 13px;">
                  <input type="checkbox" id="yemekAksam"> AkÅŸam
                </label>
              </div>
            </div>
          </div>

          <!-- Diet Ã–zellikleri -->
          <div style="background: #fff3cd; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
            <h4 style="margin: 0 0 15px 0; color: #495057;">ğŸ¥— Diyet Ã–zellikleri</h4>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
              <label style="display: flex; align-items: center; gap: 8px; font-weight: bold;">
                <input type="checkbox" id="yemekKeto"> Keto Uyumlu
              </label>
              <label style="display: flex; align-items: center; gap: 8px; font-weight: bold;">
                <input type="checkbox" id="yemekLowCarb"> DÃ¼ÅŸÃ¼k Karbonhidrat
              </label>
              <label style="display: flex; align-items: center; gap: 8px; font-weight: bold;">
                <input type="checkbox" id="yemekPorsiyonSabit"> Porsiyon Sabit
              </label>
            </div>
          </div>

          <!-- Filler Ã–zellikleri -->
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
            <label style="display: flex; align-items: center; gap: 8px; font-weight: bold;">
              <input type="checkbox" id="yemekFillerOgle"> Ã–ÄŸle Filler
            </label>
            <label style="display: flex; align-items: center; gap: 8px; font-weight: bold;">
              <input type="checkbox" id="yemekFillerAksam"> AkÅŸam Filler
            </label>
          </div>

          <!-- Etiketler -->
          <div style="margin-bottom: 20px;">
            <label style="display: block; font-weight: bold; margin-bottom: 5px; color: #333;">Etiketler (virgÃ¼lle ayÄ±rÄ±n)</label>
            <input type="text" id="yemekEtiketler" placeholder="Ã¶rn: keto, protein, sebze" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            <small style="color: #666;">Arama iÃ§in kullanÄ±lacak etiketler</small>
          </div>

          <!-- Uyumluluk Etiketleri -->
          <div style="margin-bottom: 20px;">
            <label style="display: block; font-weight: bold; margin-bottom: 5px; color: #333;">Uyumluluk Etiketleri (virgÃ¼lle ayÄ±rÄ±n)</label>
            <input type="text" id="yemekUyumluluk" placeholder="Ã¶rn: salata, kuruyemiÅŸ, sebze" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            <small style="color: #666;">Bu yemekle uyumlu olan kategoriler</small>
          </div>

          <!-- Sezon Bilgileri -->
          <div style="background: #d1ecf1; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
            <h4 style="margin: 0 0 15px 0; color: #495057;">ğŸ—“ï¸ Sezon Bilgileri</h4>
            <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 15px; align-items: center;">
              <div>
                <label style="display: block; font-weight: bold; margin-bottom: 5px; color: #333;">Sezon AralÄ±ÄŸÄ± (1-12 ay)</label>
                <input type="text" id="yemekSezon" value="[1,12]" placeholder="[1,12]" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                <small style="color: #666;">Ã–rnek: [6,8] (Haziran-AÄŸustos), [1,12] (TÃ¼m yÄ±l)</small>
              </div>
              <div>
                <label style="display: flex; align-items: center; gap: 8px; font-weight: bold;">
                  <input type="checkbox" id="yemekTersSezon"> Ters Sezon
                </label>
                <small style="color: #666;">Belirtilen aylar dÄ±ÅŸÄ±nda kullanÄ±lÄ±r</small>
              </div>
            </div>
          </div>
        </form>
        </div>
        
        <!-- EÅŸleÅŸtirme Tab -->
        <div id="eslestirContent" style="display: none;">
          <div style="background: #e3f2fd; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #20c997;">
            <h4 style="margin: 0 0 10px 0; color: #0d47a1; display: flex; align-items: center; gap: 10px;">
              <i class="fas fa-link" style="color: #20c997;"></i>
              AkÄ±llÄ± Yemek EÅŸleÅŸtirme
            </h4>
            <p style="margin: 0; color: #1565c0; font-size: 14px;">
              PDF'den okunan "<strong id="eslestirYemekAdi"></strong>" yemeÄŸini veritabanÄ±ndaki mevcut bir yemekle eÅŸleÅŸtirin.
            </p>
          </div>
          
          <!-- Arama ve Filtreleme -->
          <div style="margin-bottom: 20px;">
            <div style="position: relative;">
              <input type="text" id="yemekAramaInput" placeholder="VeritabanÄ±nda yemek ara... (Ã¶rn: tavuk, pilav, salata)" 
                     style="width: 100%; padding: 12px 45px 12px 12px; border: 2px solid #20c997; border-radius: 8px; font-size: 14px;"
                     oninput="yemekListesiniFiltrele()">
              <i class="fas fa-search" style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: #20c997;"></i>
            </div>
            
            <!-- HÄ±zlÄ± Filtreler -->
            <div style="margin-top: 15px; display: flex; flex-wrap: wrap; gap: 8px;">
              <button type="button" onclick="hizliFiltre('all')" class="hizli-filtre active" data-filtre="all">
                TÃ¼mÃ¼ (<span id="toplamYemekSayisi">0</span>)
              </button>
              <button type="button" onclick="hizliFiltre('KAHVALTI')" class="hizli-filtre" data-filtre="KAHVALTI">
                ğŸŒ… KahvaltÄ±
              </button>
              <button type="button" onclick="hizliFiltre('OGLE')" class="hizli-filtre" data-filtre="OGLE">
                ğŸŒ Ã–ÄŸle
              </button>
              <button type="button" onclick="hizliFiltre('AKSAM')" class="hizli-filtre" data-filtre="AKSAM">
                ğŸŒ™ AkÅŸam
              </button>
              <button type="button" onclick="hizliFiltre('TATLI')" class="hizli-filtre" data-filtre="TATLI">
                ğŸ° TatlÄ±
              </button>
              <button type="button" onclick="hizliFiltre('ICECEK')" class="hizli-filtre" data-filtre="ICECEK">
                ğŸ¥¤ Ä°Ã§ecek
              </button>
            </div>
          </div>
          
          <!-- Yemek Listesi -->
          <div style="background: #f8f9fa; border-radius: 8px; max-height: 300px; overflow-y: auto; border: 1px solid #dee2e6;">
            <div id="yemekListesiContainer" style="padding: 10px;">
              <!-- Yemek listesi JavaScript ile doldurulacak -->
            </div>
          </div>
          
          <!-- SeÃ§ilen Yemek Bilgisi -->
          <div id="secilenYemekBilgi" style="display: none; background: #d4edda; padding: 15px; border-radius: 8px; margin-top: 15px; border: 1px solid #c3e6cb;">
            <h5 style="margin: 0 0 10px 0; color: #155724; display: flex; align-items: center; gap: 8px;">
              <i class="fas fa-check-circle"></i>
              SeÃ§ilen Yemek:
            </h5>
            <div id="secilenYemekDetay" style="color: #155724; font-size: 14px;">
              <!-- SeÃ§ilen yemek detaylarÄ± buraya gelecek -->
            </div>
          </div>
          
          <!-- Alias Ekleme SeÃ§eneÄŸi -->
          <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-top: 15px; border: 1px solid #ffeaa7;">
            <label style="display: flex; align-items: center; gap: 8px; font-weight: 500; color: #856404; margin-bottom: 10px;">
              <input type="checkbox" id="aliasEkleCheckbox" onchange="aliasEklemeToggle()">
              ğŸ”— Bu isimle yeni bir alias (takma ad) oluÅŸtur
            </label>
            <div id="aliasEklemeAlani" style="display: none; margin-top: 10px;">
              <p style="margin: 0 0 10px 0; font-size: 13px; color: #856404;">
                "<strong id="pdfYemekAdi"></strong>" ismi ile veritabanÄ±na kaydedilecek ve gelecekte otomatik olarak seÃ§ilen yemekle eÅŸleÅŸtirilecek.
              </p>
            </div>
          </div>
        </div>
        
      </div>
      
      <div style="padding: 20px; border-top: 1px solid #ddd; text-align: right; background: #f8f9fa;">
        <button onclick="yemekModalKapat()" style="background: #6c757d; color: white; border: none; padding: 12px 24px; border-radius: 4px; cursor: pointer; margin-right: 10px;">Ä°ptal</button>
        <button onclick="yemekKaydet()" style="background: #28a745; color: white; border: none; padding: 12px 24px; border-radius: 4px; cursor: pointer; display: none;" id="yemekKaydetBtn">ğŸ’¾ Kaydet</button>
        <button onclick="yemekEslestir()" style="background: #20c997; color: white; border: none; padding: 12px 24px; border-radius: 4px; cursor: pointer; display: none;" id="eslestirKaydetBtn">ğŸ”— EÅŸleÅŸtir</button>
      </div>
    </div>
  </div>

  <!-- Åablon ArÅŸivi Modal -->
  <div id="sablonArsiviModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10002;" onclick="sablonArsiviModalKapat(event)">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 8px; width: 95%; max-width: 1200px; max-height: 90%; overflow: hidden;" onclick="event.stopPropagation()">
      <div style="padding: 20px; border-bottom: 1px solid #ddd; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
        <h3 style="margin: 0; font-size: 24px;">ğŸ“‹ Åablon ArÅŸivi</h3>
        <p style="margin: 5px 0 0 0; font-size: 14px; opacity: 0.9;">KaydedilmiÅŸ Ã¶ÄŸÃ¼n ÅŸablonlarÄ±nÄ±zÄ± gÃ¶rÃ¼ntÃ¼leyin, dÃ¼zenleyin ve yÃ¶netin</p>
      </div>
      
      <!-- Ãœst Kontrol Ã‡ubuÄŸu -->
      <div style="padding: 15px 20px; border-bottom: 1px solid #ddd; background: #f8f9fa; display: flex; justify-content: space-between; align-items: center;">
        <div style="display: flex; align-items: center; gap: 15px;">
          <span id="sablonSayisiInfo" style="font-weight: bold; color: #495057;">ğŸ“Š Toplam: 0 ÅŸablon</span>
          <button onclick="sablonlariYenile()" style="
            padding: 8px 16px; 
            background: #28a745; 
            color: white; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer;
            font-size: 12px;
          ">ğŸ”„ Yenile</button>
        </div>
        <div style="display: flex; align-items: center; gap: 10px;">
          <select id="sablonFiltre" onchange="sablonlariFiltrele()" style="padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 12px;">
            <option value="">TÃ¼m Åablonlar</option>
            <option value="Ã¶ÄŸle">Ã–ÄŸle ÅablonlarÄ±</option>
            <option value="akÅŸam">AkÅŸam ÅablonlarÄ±</option>
            <option value="kahvaltÄ±">KahvaltÄ± ÅablonlarÄ±</option>
            <option value="ara">Ara Ã–ÄŸÃ¼n ÅablonlarÄ±</option>
          </select>
          <select id="diyetTuruFiltre" onchange="sablonlariFiltrele()" style="padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 12px;">
            <option value="">TÃ¼m Diyet TÃ¼rleri</option>
            <option value="no-diet">Diyet TÃ¼rÃ¼ Olmayan</option>
          </select>
          <input type="text" id="sablonArama" placeholder="Åablon ara..." onkeyup="sablonlariAra()" style="
            padding: 8px 12px; 
            border: 1px solid #ccc; 
            border-radius: 4px; 
            font-size: 12px;
            width: 200px;
          ">
        </div>
      </div>
      
      <!-- Åablon Listesi -->
      <div id="sablonListesi" style="padding: 20px; max-height: 60vh; overflow-y: auto;">
        <div style="text-align: center; color: #666; padding: 40px;">
          <i class="fas fa-spinner fa-spin" style="font-size: 24px; margin-bottom: 10px;"></i>
          <p>Åablonlar yÃ¼kleniyor...</p>
        </div>
      </div>
      
      <!-- Alt Kontrol Ã‡ubuÄŸu -->
      <div style="padding: 15px 20px; border-top: 1px solid #ddd; text-align: right; background: #f8f9fa;">
        <button onclick="sablonArsiviModalKapat()" style="background: #6c757d; color: white; border: none; padding: 12px 24px; border-radius: 4px; cursor: pointer;">Kapat</button>
      </div>
    </div>
  </div>

  <!-- SatÄ±r BÃ¶lme Modal (PDF satÄ±rÄ±nÄ± birden fazla yemeÄŸe ayÄ±r) -->
  <div id="satirBolModal" style="display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10002;" onclick="splitModalKapat(event)">
    <div style="position:absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 8px; width: 90%; max-width: 800px; max-height: 85%; overflow: hidden;" onclick="event.stopPropagation()">
      <div style="padding: 14px 18px; border-bottom: 1px solid #ddd; background: linear-gradient(135deg, #6f42c1, #8a63d2); color: white;">
        <h3 style="margin:0; font-size: 18px;">âœ‚ï¸ SatÄ±rÄ± BÃ¶l</h3>
        <div id="splitModalOrjText" style="margin-top:6px; font-size:12px; opacity:.9;"></div>
      </div>
      <div style="padding:16px; display:flex; gap:16px;">
        <div style="flex:1;">
          <label style="font-weight:600; color:#333;">Yeni Ã–ÄŸeler (her satÄ±ra bir yemek):</label>
          <textarea id="splitLinesTextarea" style="width:100%; min-height:180px; border:1px solid #ddd; border-radius:6px; padding:10px; font-size:13px;" placeholder="Ã–rnek:\nPatlÄ±can musakka\nYeÅŸil salata + 1 yemek kaÅŸÄ±ÄŸÄ± zeytinyaÄŸÄ± ile\nKollajen (1 Ã¶lÃ§ek 10 gram)"></textarea>
          <div style="margin-top:8px; font-size:12px; color:#666;">
            Ä°pucu: Buraya satÄ±rÄ± parÃ§alayÄ±p her yemeÄŸi alt alta yazÄ±n. Uygula dediÄŸinizde haftaya satÄ±rlar olarak eklenecek ve otomatik eÅŸleÅŸtirilecek.
          </div>
        </div>
        <div style="width:260px;">
          <label style="font-weight:600; color:#333;">HÄ±zlÄ± BÃ¶lme AraÃ§larÄ±</label>
          <div style="border:1px solid #eee; border-radius:6px; padding:10px;">
            <button onclick="splitQuickSuggest('kollajen')" style="display:block; width:100%; margin-bottom:6px; background:#e9ecef; border:none; padding:8px; border-radius:4px; cursor:pointer;">'Kollajen' Ã¶ncesinden bÃ¶l</button>
            <button onclick="splitQuickSuggest('doubleSpace')" style="display:block; width:100%; margin-bottom:6px; background:#e9ecef; border:none; padding:8px; border-radius:4px; cursor:pointer;">Ã‡ift boÅŸluÄŸa gÃ¶re bÃ¶l</button>
            <button onclick="splitQuickSuggest('comma')" style="display:block; width:100%; margin-bottom:6px; background:#e9ecef; border:none; padding:8px; border-radius:4px; cursor:pointer;">VirgÃ¼llere gÃ¶re bÃ¶l (temkinli)</button>
            <div style="margin-top:8px; font-size:12px; color:#666;">Not: Bu araÃ§lar Ã¶neri doldurur; dÃ¼zenleyip Uygula'ya basÄ±n.</div>
          </div>
        </div>
      </div>
      <div style="padding:12px 16px; border-top:1px solid #ddd; text-align:right;">
        <button onclick="splitModalKapat()" style="background:#6c757d; color:white; border:none; padding:8px 14px; border-radius:4px; cursor:pointer; margin-right:8px;">Ä°ptal</button>
        <button onclick="applySplitFromModal()" style="background:#28a745; color:white; border:none; padding:8px 14px; border-radius:4px; cursor:pointer;">Uygula</button>
      </div>
    </div>
  </div>

    <!-- ğŸš« Karaliste Modal (render dÄ±ÅŸÄ± bÄ±rakÄ±lan PDF satÄ±rlarÄ±) -->
    <div id="karalisteModal" style="display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10002;" onclick="closeBlacklistModal(event)">
      <div style="position:absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 8px; width: 90%; max-width: 700px; max-height: 85%; overflow: hidden;" onclick="event.stopPropagation()">
        <div style="padding: 14px 18px; border-bottom: 1px solid #ddd; background: linear-gradient(135deg, #dc3545, #c82333); color: white;">
          <h3 style="margin:0; font-size: 18px;">ğŸš« Karaliste (Render dÄ±ÅŸÄ± bÄ±rakÄ±lan satÄ±rlar)</h3>
          <div style="margin-top:6px; font-size:12px; opacity:.9;">Bu listedeki satÄ±rlar analiz tablosunda gÃ¶sterilmez. Ä°ÅŸareti kaldÄ±rarak karalisteden Ã§Ä±karabilirsiniz.</div>
        </div>
        <div style="padding:16px;">
          <div id="karalisteBos" style="display:none; color:#666; font-size:13px;">Karalistede Ã¶ÄŸe yok.</div>
          <div id="karalisteListesi" style="max-height:50vh; overflow:auto; border:1px solid #eee; border-radius:6px; padding:10px; background:#fff;"></div>
        </div>
        <div style="padding: 12px 16px; border-top: 1px solid #eee; display:flex; justify-content:space-between; gap:8px; background:#fafafa; flex-wrap: wrap;">
          <div style="display:flex; gap:8px; flex-wrap:wrap;">
            <button onclick="clearBlacklist()" style="background:#ffc107; color:#212529; border:none; padding:10px 16px; border-radius:4px; cursor:pointer;">TÃ¼mÃ¼nÃ¼ Temizle</button>
          </div>
          <button onclick="closeBlacklistModal()" style="background:#6c757d; color:white; border:none; padding:10px 16px; border-radius:4px; cursor:pointer;">Kapat</button>
        </div>
      </div>
    </div>

  <!-- PDF Ã–nizleme Modal -->
  <div id="pdfOnizlemeModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10002;" onclick="pdfModalKapat(event)">
    <div style="position: relative; width: 90%; max-width: 800px; height: 90%; margin: 2.5% auto; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.3);" onclick="event.stopPropagation()">
      
      <!-- Modal Header -->
      <div style="background: linear-gradient(135deg, #28a745, #20c997); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;">
        <h2 style="margin: 0; font-size: 18px; display: flex; align-items: center; gap: 10px;">
          <span>ğŸ“„</span>
          <span id="pdfModalBaslik">Diyet Listesi Ã–nizlemesi</span>
        </h2>
        <button onclick="pdfModalKapat()" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer; padding: 0; line-height: 1;">Ã—</button>
      </div>
      
      <!-- Modal Body - PDF Style Content -->
      <div style="height: calc(100% - 140px); overflow-y: auto; padding: 0;">
        <div id="pdfOnizlemeContent" style="padding: 30px; font-family: 'Times New Roman', serif; line-height: 1.4; background: white;">
          <!-- PDF content buraya gelecek -->
        </div>
      </div>
      
      <!-- Modal Footer -->
      <div style="padding: 15px 20px; border-top: 1px solid #ddd; text-align: right; background: #f8f9fa; display: flex; justify-content: space-between; align-items: center;">
        <div style="color: #666; font-size: 14px;">
          <span id="pdfHastaInfo">Hasta bilgileri</span>
        </div>
        <div>
          <button onclick="pdfModalKapat()" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin-right: 10px;">Kapat</button>
          <button onclick="pdfYazdir()" style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin-right: 10px;">ğŸ–¨ï¸ YazdÄ±r</button>
          <button onclick="pdfIndir()" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">ğŸ’¾ PDF Ä°ndir</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Diyet TÃ¼rleri YÃ¶netimi Modal -->
  <div id="diyetTurleriModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10003;" onclick="diyetTurleriKapat(event)">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 12px; width: 95%; max-width: 1000px; max-height: 90%; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.3);" onclick="event.stopPropagation()">
      
      <!-- Modal Header -->
      <div style="padding: 20px; border-bottom: 1px solid #ddd; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white;">
        <h3 style="margin: 0; font-size: 24px;">ğŸ¯ Diyet TÃ¼rleri YÃ¶netimi</h3>
        <p style="margin: 5px 0 0 0; opacity: 0.9; font-size: 14px;">FarklÄ± diyet tÃ¼rlerini tanÄ±mlayÄ±n ve makro oranlarÄ±nÄ± ayarlayÄ±n</p>
      </div>

      <!-- Modal Content -->
      <div style="padding: 20px; max-height: 70vh; overflow-y: auto;">
        
        <!-- Yeni Diyet TÃ¼rÃ¼ Ekleme Formu -->
        <div style="background: #f8f9fa; border-radius: 8px; padding: 20px; margin-bottom: 20px; border: 1px solid #e9ecef;">
          <h4 style="margin: 0 0 15px 0; color: #495057;">â• Yeni Diyet TÃ¼rÃ¼ Ekle</h4>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
            <div>
              <label style="display: block; font-weight: 600; color: #495057; margin-bottom: 5px;">Diyet AdÄ±:</label>
              <input type="text" id="yeniDiyetAdi" placeholder="Ã–rn: Ketojenik, DÃ¼ÅŸÃ¼k Karbonhidrat, Akdeniz" style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 4px; font-size: 14px;">
            </div>
            <div>
              <label style="display: block; font-weight: 600; color: #495057; margin-bottom: 5px;">AÃ§Ä±klama:</label>
              <input type="text" id="yeniDiyetAciklama" placeholder="KÄ±sa aÃ§Ä±klama" style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 4px; font-size: 14px;">
            </div>
          </div>

          <!-- Makro OranlarÄ± -->
          <h5 style="margin: 15px 0 10px 0; color: #495057;">ğŸ“Š Makro OranlarÄ± (Toplam %100 olmalÄ±)</h5>
          <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
            <div>
              <label style="display: block; font-weight: 600; color: #495057; margin-bottom: 5px;">Karbonhidrat %:</label>
              <input type="range" id="karbOrani" min="0" max="100" value="45" oninput="updateMakroValues()" style="width: 100%;">
              <div style="text-align: center; font-size: 14px; font-weight: bold; color: #007bff;" id="karbValue">45%</div>
            </div>
            <div>
              <label style="display: block; font-weight: 600; color: #495057; margin-bottom: 5px;">Protein %:</label>
              <input type="range" id="proteinOrani" min="0" max="100" value="25" oninput="updateMakroValues()" style="width: 100%;">
              <div style="text-align: center; font-size: 14px; font-weight: bold; color: #28a745;" id="proteinValue">25%</div>
            </div>
            <div>
              <label style="display: block; font-weight: 600; color: #495057; margin-bottom: 5px;">YaÄŸ %:</label>
              <input type="range" id="yagOrani" min="0" max="100" value="30" oninput="updateMakroValues()" style="width: 100%;">
              <div style="text-align: center; font-size: 14px; font-weight: bold; color: #dc3545;" id="yagValue">30%</div>
            </div>
          </div>
          <div style="text-align: center; margin: 10px 0; padding: 8px; background: #e7f3ff; border-radius: 4px; border: 1px solid #b8daff;">
            <span style="font-weight: bold;">Toplam: </span><span id="toplamOran" style="font-weight: bold; color: #007bff;">100%</span>
          </div>

          <!-- YasaklÄ± Anahtar Kelimeler -->
          <h5 style="margin: 15px 0 10px 0; color: #495057;">ğŸš« YasaklÄ± Anahtar Kelimeler</h5>
          <textarea id="yasakliKelimeler" placeholder="Bu diyette yasaklÄ± yemek tÃ¼rleri (virgÃ¼lle ayÄ±rÄ±n):&#10;Ã–rn: sÃ¼t, peynir, yoÄŸurt, ekmek, pilav, makarna" style="width: 100%; height: 60px; padding: 10px; border: 1px solid #ced4da; border-radius: 4px; font-size: 14px; resize: vertical;"></textarea>

          <!-- Zorunlu Ã–zellikler -->
          <h5 style="margin: 15px 0 10px 0; color: #495057;">âœ… Zorunlu Ã–zellikler</h5>
          <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
            <label style="display: flex; align-items: center; cursor: pointer;">
              <input type="checkbox" id="ketojenik" style="margin-right: 8px;">
              <span>Ketojenik Uyumlu</span>
            </label>
            <label style="display: flex; align-items: center; cursor: pointer;">
              <input type="checkbox" id="glutensiz" style="margin-right: 8px;">
              <span>GlÃ¼ten Siz</span>
            </label>
            <label style="display: flex; align-items: center; cursor: pointer;">
              <input type="checkbox" id="vegan" style="margin-right: 8px;">
              <span>Vegan</span>
            </label>
            <label style="display: flex; align-items: center; cursor: pointer;">
              <input type="checkbox" id="vegetarian" style="margin-right: 8px;">
              <span>Vejetaryen</span>
            </label>
            <label style="display: flex; align-items: center; cursor: pointer;">
              <input type="checkbox" id="dusukKalori" style="margin-right: 8px;">
              <span>DÃ¼ÅŸÃ¼k Kalori</span>
            </label>
            <label style="display: flex; align-items: center; cursor: pointer;">
              <input type="checkbox" id="yuksekProtein" style="margin-right: 8px;">
              <span>YÃ¼ksek Protein</span>
            </label>
          </div>

          <button onclick="diyetTuruEkle()" style="width: 100%; margin-top: 15px; padding: 12px; background: linear-gradient(135deg, #28a745, #20c997); color: white; border: none; border-radius: 6px; font-size: 14px; font-weight: bold; cursor: pointer;">â• Diyet TÃ¼rÃ¼ Ekle</button>
        </div>

        <!-- Mevcut Diyet TÃ¼rleri Listesi -->
        <div>
          <h4 style="margin: 0 0 15px 0; color: #495057;">ğŸ“‹ Mevcut Diyet TÃ¼rleri</h4>
          <div id="diyetTurleriListesi" style="border: 1px solid #e9ecef; border-radius: 8px; min-height: 200px; max-height: 300px; overflow-y: auto;">
            <div style="padding: 40px; text-align: center; color: #6c757d;">
              HenÃ¼z diyet tÃ¼rÃ¼ tanÄ±mlanmamÄ±ÅŸ. YukarÄ±daki formu kullanarak yeni diyet tÃ¼rÃ¼ ekleyin.
            </div>
          </div>
        </div>
      </div>

      <!-- Modal Footer -->
      <div style="padding: 15px 20px; border-top: 1px solid #ddd; background: #f8f9fa; text-align: right;">
        <button onclick="diyetTurleriKapat()" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin-right: 10px;">Kapat</button>
        <button onclick="diyetTurleriKaydet()" style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">ğŸ’¾ Kaydet</button>
      </div>
    </div>
  </div>

  <!-- Åablon Kaydetme Modal -->
  <div id="sablonKaydetModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10004;" onclick="sablonKaydetModalKapat(event)">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.3); width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto;" onclick="event.stopPropagation()">
      
      <!-- Modal Header -->
      <div style="padding: 20px; border-bottom: 1px solid #ddd; background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); color: white; border-radius: 12px 12px 0 0;">
        <h3 style="margin: 0; display: flex; align-items: center; gap: 10px;">
          <i class="fas fa-save"></i>
          Åablon Kaydet
        </h3>
        <p style="margin: 5px 0 0 0; opacity: 0.9; font-size: 14px;" id="sablonKaydetAciklama">Ã–ÄŸÃ¼n ÅŸablonunuzu kaydedin</p>
      </div>

      <!-- Modal Content -->
      <div style="padding: 20px;">
        <!-- Åablon Ä°smi -->
        <div style="margin-bottom: 20px;">
          <label style="display: block; font-weight: bold; margin-bottom: 8px; color: #333;">
            <i class="fas fa-tag"></i> Åablon Ä°smi
          </label>
          <input type="text" id="sablonKaydetIsim" placeholder="Åablon ismini girin..." style="
            width: 100%; 
            padding: 12px; 
            border: 2px solid #ddd; 
            border-radius: 6px; 
            font-size: 14px;
            transition: border-color 0.3s ease;
          " onkeyup="if(event.key==='Enter') sablonKaydetOnay()">
          <small style="color: #666; font-size: 12px;" id="sablonKaydetOneri"></small>
        </div>

        <!-- Diyet TÃ¼rÃ¼ SeÃ§imi -->
        <div style="margin-bottom: 20px;">
          <label style="display: block; font-weight: bold; margin-bottom: 8px; color: #333;">
            <i class="fas fa-chart-pie"></i> Diyet TÃ¼rÃ¼ (Ä°steÄŸe BaÄŸlÄ±)
          </label>
          <select id="sablonKaydetDiyetTuru" style="
            width: 100%; 
            padding: 12px; 
            border: 2px solid #ddd; 
            border-radius: 6px; 
            font-size: 14px;
            background: white;
            cursor: pointer;
          ">
            <option value="">Diyet tÃ¼rÃ¼ seÃ§in (isteÄŸe baÄŸlÄ±)</option>
          </select>
          <small style="color: #666; font-size: 12px;">Åablonunuza uygun diyet tÃ¼rÃ¼nÃ¼ seÃ§ebilirsiniz</small>
        </div>

        <!-- Hasta Bilgileri (Kaynak) -->
        <div id="sablonKaydetHastaBilgi" style="
          background: linear-gradient(135deg, #e8f5e8 0%, #f1f8e9 100%); 
          padding: 15px; 
          border-radius: 6px; 
          border-left: 4px solid #28a745;
          margin-bottom: 20px;
          display: none;
        ">
          <h4 style="margin: 0 0 10px 0; color: #155724; font-size: 14px;">
            <i class="fas fa-user-md"></i> Kaynak Hasta Bilgileri
          </h4>
          <div style="display: grid; grid-template-columns: 1fr; gap: 8px; font-size: 13px;">
            <div><strong>Hasta:</strong> <span id="sablonKaydetHastaIsim">-</span></div>
            <div><strong>Tarih AralÄ±ÄŸÄ±:</strong> <span id="sablonKaydetHastaTarih">-</span></div>
            <div><strong>Hafta:</strong> <span id="sablonKaydetHastaHafta">-</span></div>
            <div><strong>GÃ¼n:</strong> <span id="sablonKaydetHastaGun">-</span></div>
          </div>
          <small style="color: #155724; font-size: 11px; opacity: 0.8;">Bu ÅŸablon yukarÄ±daki hastanÄ±n PDF'inden oluÅŸturulmuÅŸtur</small>
        </div>

        <!-- Åablon Ã–zeti -->
        <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; border-left: 4px solid #007bff;">
          <h4 style="margin: 0 0 10px 0; color: #495057; font-size: 14px;">ğŸ“Š Åablon Ã–zeti</h4>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 13px;">
            <div><strong>Yemek SayÄ±sÄ±:</strong> <span id="sablonKaydetYemekSayisi">-</span></div>
            <div><strong>Toplam Kalori:</strong> <span id="sablonKaydetKalori">-</span> kcal</div>
            <div><strong>Ã–ÄŸÃ¼n Tipi:</strong> <span id="sablonKaydetOgunTipi">-</span></div>
            <div><strong>Tarih:</strong> <span id="sablonKaydetTarih">-</span></div>
          </div>
        </div>
      </div>

      <!-- Modal Footer -->
      <div style="padding: 15px 20px; border-top: 1px solid #ddd; background: #f8f9fa; text-align: right; border-radius: 0 0 12px 12px;">
        <button onclick="sablonKaydetModalKapat()" style="
          background: #6c757d; 
          color: white; 
          border: none; 
          padding: 12px 24px; 
          border-radius: 6px; 
          cursor: pointer; 
          margin-right: 10px;
          font-size: 14px;
        ">âŒ Ä°ptal</button>
        <button onclick="sablonKaydetOnay()" style="
          background: #28a745; 
          color: white; 
          border: none; 
          padding: 12px 24px; 
          border-radius: 6px; 
          cursor: pointer;
          font-size: 14px;
          font-weight: bold;
        ">ğŸ’¾ Kaydet</button>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script>
    // === GLOBAL DEÄÄ°ÅKENLER VE FONKSÄ°YONLAR ===
    window.aktifHaftaIndex = null;
    window.diyetTurleri = []; // Diyet tÃ¼rleri global deÄŸiÅŸkeni
    
    // toggleAccordion fonksiyonunu global olarak tanÄ±mla
    window.toggleAccordion = function(section) {
      const sections = ['eslesen', 'eslesmeyenler', 'analiz', 'veritabaniAnalizi'];
      
      sections.forEach(s => {
        const content = document.getElementById(s + 'Content');
        const icon = document.getElementById(s + 'Icon');
        
        if (content && icon) {
          if (s === section) {
            // SeÃ§ilen bÃ¶lÃ¼mÃ¼ aÃ§/kapat
            const isOpen = content.style.display === 'block';
            content.style.display = isOpen ? 'none' : 'block';
            icon.textContent = isOpen ? 'â–¶' : 'â–¼';
          } else {
            // DiÄŸer bÃ¶lÃ¼mleri kapat
            content.style.display = 'none';
            icon.textContent = 'â–¶';
          }
        }
      });
    };
    
    // updateYemekAnalizi fonksiyonunu global olarak tanÄ±mla
    window.updateYemekAnalizi = function() {
      console.log('ğŸ“Š updateYemekAnalizi fonksiyonu Ã§aÄŸrÄ±ldÄ±');
      
      if (!window.seciliHasta) {
        console.log('âŒ Hasta seÃ§ilmemiÅŸ, analiz yapÄ±lamÄ±yor');
        return;
      }
      
      try {
        const haftaListesi = typeof getHaftaListesi === 'function' ? getHaftaListesi() : null;
        
        if (!haftaListesi || haftaListesi.length === 0) {
          console.log('âŒ Hafta verisi bulunamadÄ±, analiz yapÄ±lamÄ±yor');
          return;
        }
        
        console.log(`âœ… Analiz verisi hazÄ±r: ${haftaListesi.length} hafta`);
        
        // Analiz grafiÄŸini gÃ¼ncelle
        if (typeof generateAnalysisChart === 'function') {
          generateAnalysisChart();
        }
        
        // Sidebar gÃ¼ncellemelerini tetikle
        if (typeof gosterEslesenKartlarSidebar === 'function' && window.aktifHaftaIndex !== null) {
          gosterEslesenKartlarSidebar(window.aktifHaftaIndex);
        }
        
      } catch (error) {
        console.error('âŒ updateYemekAnalizi hatasÄ±:', error);
      }
    };

    // === TOAST MESAJ SÄ°STEMÄ° ===
    function showToast(message, type = 'success', duration = 2500) {
      // Mevcut toast'larÄ± temizle
      const existingToasts = document.querySelectorAll('.toast-message');
      existingToasts.forEach(toast => toast.remove());
      
      // Yeni toast oluÅŸtur
      const toast = document.createElement('div');
      toast.className = `toast-message ${type}`;
      toast.textContent = message;
      
      // Body'ye ekle
      document.body.appendChild(toast);
      
      // Belirli sÃ¼re sonra kaldÄ±r
      setTimeout(() => {
        if (toast.parentNode) {
          toast.style.animation = 'slideIn 0.3s ease-out reverse';
          setTimeout(() => toast.remove(), 300);
        }
      }, duration);
    }
    
    // âš¡ Ã‡OKLU PDF Ä°ÅLEME FONKSÄ°YONU (Global)
    
    // Profesyonel PDF adÄ±nÄ± parse etme
    function parseProfessionalPdfName(fileName) {
      console.log('ğŸ” PDF dosya adÄ± parse ediliyor:', fileName);
      
      // .pdf uzantÄ±sÄ±nÄ± kaldÄ±r
      const cleanName = fileName.replace(/\.pdf$/i, '');
      
      // Regex pattern'ler (esnek format desteÄŸi)
      const patterns = [
        // "ESÄ°N KARAKUÅ 28 TEMMUZ -3 AÄUSTOS 17. HAFTA"
        /^(.+?)\s+(\d{1,2})\s+([A-Za-zÃ§Ã‡ÄŸÄÄ±Ä°Ã¶Ã–ÅŸÅÃ¼Ãœ]+)\s*-\s*(\d{1,2})\s+([A-Za-zÃ§Ã‡ÄŸÄÄ±Ä°Ã¶Ã–ÅŸÅÃ¼Ãœ]+)\s+(\d+)\.\s*HAFTA/i,
        
        // "FÄ°GEN TEZMAN 4-10 AÄUSTOS 1.HAFTA"
        /^(.+?)\s+(\d{1,2})-(\d{1,2})\s+([A-Za-zÃ§Ã‡ÄŸÄÄ±Ä°Ã¶Ã–ÅŸÅÃ¼Ãœ]+)\s+(\d+)\.?\s*HAFTA/i,
        
        // "HASTA ADI TARIH ARALIGI X. HAFTA" (genel format)
        /^(.+?)\s+(.+?)\s+(\d+)\.?\s*HAFTA/i
      ];
      
      for (const pattern of patterns) {
        const match = cleanName.match(pattern);
        if (match) {
          console.log('âœ… Pattern match bulundu:', match);
          
          let sonuc = {};
          
          if (pattern === patterns[0]) {
            // "ESÄ°N KARAKUÅ 28 TEMMUZ -3 AÄUSTOS 17. HAFTA"
            sonuc = {
              hastaAdi: match[1].trim().toUpperCase(),
              haftaNo: parseInt(match[6]),
              tarihAraligi: `${match[2]} ${match[3]} - ${match[4]} ${match[5]}`.toUpperCase(),
              baslangicGun: parseInt(match[2]),
              baslangicAy: match[3].toUpperCase(),
              bitisGun: parseInt(match[4]),
              bitisAy: match[5].toUpperCase()
            };
          } else if (pattern === patterns[1]) {
            // "FÄ°GEN TEZMAN 4-10 AÄUSTOS 1.HAFTA"
            sonuc = {
              hastaAdi: match[1].trim().toUpperCase(),
              haftaNo: parseInt(match[5]),
              tarihAraligi: `${match[2]}-${match[3]} ${match[4]}`.toUpperCase(),
              baslangicGun: parseInt(match[2]),
              bitisGun: parseInt(match[3]),
              baslangicAy: match[4].toUpperCase(),
              bitisAy: match[4].toUpperCase() // AynÄ± ay
            };
            
            console.log(`ğŸ¯ PATTERN 1 MATCH - Dosya: ${fileName}`);
            console.log(`   ğŸ“ Hasta: ${sonuc.hastaAdi}`);
            console.log(`   ğŸ“… Tarih: ${match[2]}-${match[3]} ${match[4]}`);
            console.log(`   ğŸ”¢ Hafta: ${sonuc.haftaNo}`);
            console.log(`   ğŸ—“ï¸ BaÅŸlangÄ±Ã§: ${sonuc.baslangicGun} ${sonuc.baslangicAy}`);
            console.log(`   ğŸ—“ï¸ BitiÅŸ: ${sonuc.bitisGun} ${sonuc.bitisAy}`);
          } else {
            // Genel format
            sonuc = {
              hastaAdi: match[1].trim().toUpperCase(),
              haftaNo: parseInt(match[3]),
              tarihAraligi: match[2].trim().toUpperCase()
            };
          }
          
          console.log('ğŸ“‹ Parse sonucu:', sonuc);
          return sonuc;
        }
      }
      
      console.warn('âš ï¸ HiÃ§bir pattern uyuÅŸmadÄ±:', cleanName);
      return null;
    }

    // TÃ¼rkÃ§e ay adÄ±nÄ± sayÄ±ya Ã§evir
    function turkceAyToNumber(ayAdi) {
      const aylar = {
        'OCAK': 1, 'ÅUBAT': 2, 'MART': 3, 'NÄ°SAN': 4, 'MAYIS': 5, 'HAZÄ°RAN': 6,
        'TEMMUZ': 7, 'AÄUSTOS': 8, 'EYLÃœL': 9, 'EKÄ°M': 10, 'KASIM': 11, 'ARALIK': 12
      };
      return aylar[ayAdi.toUpperCase()] || null;
    }

    // Parse edilen tarih bilgisini Date formatÄ±na Ã§evir
    function parseEdilmistarihleriDateOlarak(parsedData) {
      if (!parsedData || !parsedData.baslangicGun || !parsedData.baslangicAy) {
        return null;
      }
      
      console.log('ğŸ” parseEdilmistarihleriDateOlarak giriÅŸ:', parsedData);
      
      const currentYear = new Date().getFullYear();
      const baslangicAyNo = turkceAyToNumber(parsedData.baslangicAy);
      const bitisAyNo = parsedData.bitisAy ? turkceAyToNumber(parsedData.bitisAy) : baslangicAyNo;
      
      if (!baslangicAyNo || !bitisAyNo) {
        console.warn('âš ï¸ Ay adÄ± Ã§evrilemedi:', parsedData.baslangicAy, parsedData.bitisAy);
        return null;
      }
      
      console.log('ğŸ” Tarih bileÅŸenleri:', {
        currentYear,
        baslangicGun: parsedData.baslangicGun,
        baslangicAyNo,
        bitisGun: parsedData.bitisGun,
        bitisAyNo
      });
      
      // âš¡ TÄ°MEZONE FÄ°X: Direkt string formatÄ±nda oluÅŸtur, Date objesi kullanma!
      const baslangicDateStr = `${currentYear}-${baslangicAyNo.toString().padStart(2, '0')}-${parsedData.baslangicGun.toString().padStart(2, '0')}`;
      const bitisDateStr = `${currentYear}-${bitisAyNo.toString().padStart(2, '0')}-${(parsedData.bitisGun || parsedData.baslangicGun).toString().padStart(2, '0')}`;
      
      console.log('ğŸ” OluÅŸturulan tarih stringleri:', {
        baslangicDateStr,
        bitisDateStr
      });
      
      // GÃ¼n sayÄ±sÄ±nÄ± hesapla (Date objesi sadece hesaplama iÃ§in)
      const baslangicDate = new Date(currentYear, baslangicAyNo - 1, parsedData.baslangicGun);
      const bitisDate = new Date(currentYear, bitisAyNo - 1, parsedData.bitisGun || parsedData.baslangicGun);
      
      // BitiÅŸ tarihi baÅŸlangÄ±Ã§tan kÃ¼Ã§Ã¼kse, sonraki yÄ±la geÃ§
      if (bitisDate < baslangicDate) {
        bitisDate.setFullYear(currentYear + 1);
      }
      
      const gunSayisi = Math.ceil((bitisDate - baslangicDate) / (1000 * 60 * 60 * 24)) + 1;
      
      const result = {
        baslangic: baslangicDateStr,
        bitis: bitisDateStr,
        gunSayisi: gunSayisi
      };
      
      console.log('âœ… parseEdilmistarihleriDateOlarak sonuÃ§:', result);
      return result;
    }

    // PDF'den gelen tarih aralÄ±ÄŸÄ±na gÃ¶re tab bilgilerini gÃ¼ncelle
    function updateTabInfoFromPdf(haftaIndex, parsedPdf, parsedTarihler) {
      if (!parsedTarihler || !parsedTarihler.gunSayisi) return;
      
      const haftalar = getHaftaListesi();
      const hafta = haftalar[haftaIndex];
      
      console.log(`ğŸ¯ PDF TAB GÃœNCELLEME - Hafta ${haftaIndex + 1}`);
      console.log(`ğŸ“… PDF'den gelen tarihler:`, parsedTarihler);
      console.log(`ğŸ“… Ã–nceki hafta tarihleri:`, {
        baslangic: hafta.baslangic,
        bitis: hafta.bitis
      });
      
      // âš¡ Ã–NEMLÄ°: Hafta tarihlerini PDF'den gelen tarihlerle gÃ¼ncelle
      hafta.baslangic = parsedTarihler.baslangic;
      hafta.bitis = parsedTarihler.bitis;
      
      console.log(`âœ… Hafta tarihleri PDF'den gÃ¼ncellendi:`, {
        yeniBaslangic: hafta.baslangic,
        yeniBitis: hafta.bitis
      });
      
      // Tarih aralÄ±ÄŸÄ± 7 gÃ¼nden fazla ise Ã¶zel format kullan
      if (parsedTarihler.gunSayisi > 7) {
        console.log(`ğŸ“… PDF tarih aralÄ±ÄŸÄ± ${parsedTarihler.gunSayisi} gÃ¼n - Tab adÄ± gÃ¼ncelleniyor`);
        
        // Tab adÄ± iÃ§in Ã¶zel format: "1. Hafta\n08/13 - 08/24"
        hafta.ozelTabFormat = true;
        hafta.tabBaslik = `${hafta.haftaNo || (haftaIndex + 1)}. Hafta`;
        
        // Tarih formatÄ±nÄ± oluÅŸtur - ISO string'den direkt parse etmeye dikkat!
        // Zaman dilimi sorununu Ã¶nlemek iÃ§in direkt split kullanÄ±yoruz
        const basDateParts = parsedTarihler.baslangic.split('-'); // [2025, 08, 13]
        const bitDateParts = parsedTarihler.bitis.split('-'); // [2025, 08, 24]
        
        hafta.tabTarih = `${basDateParts[1]}/${basDateParts[2]} - ${bitDateParts[1]}/${bitDateParts[2]}`;
        
        console.log(`âœ… Tab bilgileri gÃ¼ncellendi: ${hafta.tabBaslik} - ${hafta.tabTarih}`);
      } else {
        // Normal format kullan
        hafta.ozelTabFormat = false;
        delete hafta.tabBaslik;
        delete hafta.tabTarih;
        console.log(`ğŸ“… Normal tab formatÄ± kullanÄ±lÄ±yor (${parsedTarihler.gunSayisi} gÃ¼n)`);
      }
      
      // localStorage'a kaydet
      saveToStorage();
      
      console.log(`ğŸ’¾ Hafta bilgileri localStorage'a kaydedildi`);
    }

    // DosyayÄ± Base64'e Ã§evirme
    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => {
          const base64 = reader.result.split(',')[1]; // Data URL prefix'ini kaldÄ±r
          resolve(base64);
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    // Tarih aralÄ±ÄŸÄ±nÄ± parse etme
    function parseTarihAraligi(tarihAraligi) {
      console.log('ğŸ“… Tarih aralÄ±ÄŸÄ± parse ediliyor:', tarihAraligi);
      
      const bugun = new Date();
      const yil = bugun.getFullYear();
      
      // "28 TEMMUZ - 3 AÄUSTOS" formatÄ±nÄ± parse et
      const aylar = {
        'OCAK': '01', 'ÅUBAT': '02', 'MART': '03', 'NÄ°SAN': '04',
        'MAYIS': '05', 'HAZÄ°RAN': '06', 'TEMMUZ': '07', 'AÄUSTOS': '08',
        'EYLÃœL': '09', 'EKÄ°M': '10', 'KASIM': '11', 'ARALIK': '12'
      };
      
      try {
        // Format 1: "28 TEMMUZ - 3 AÄUSTOS"
        if (tarihAraligi.includes(' - ')) {
          const parts = tarihAraligi.split(' - ');
          if (parts.length >= 2) {
            const baslangicParts = parts[0].trim().split(' ');
            const bitisParts = parts[1].trim().split(' ');
            
            const baslangicGun = baslangicParts[0].padStart(2, '0');
            const baslangicAy = aylar[baslangicParts[1]] || '01';
            
            const bitisGun = bitisParts[0].padStart(2, '0');
            const bitisAy = aylar[bitisParts[1]] || '01';
            
            const sonuc = {
              baslangic: `${yil}-${baslangicAy}-${baslangicGun}`,
              bitis: `${yil}-${bitisAy}-${bitisGun}`
            };
            
            console.log('âœ… Tarih parse baÅŸarÄ±lÄ± (Format 1):', sonuc);
            return sonuc;
          }
        }
        
        // Format 2: "4-10 AÄUSTOS" (aynÄ± ay iÃ§inde)
        const ayiciMatch = tarihAraligi.match(/^(\d{1,2})-(\d{1,2})\s+([A-Za-zÃ‡ÄIÄ°Ã–ÅÃœÃ§ÄŸÄ±Ã¶ÅŸÃ¼]+)$/i);
        if (ayiciMatch) {
          const baslangicGun = ayiciMatch[1].padStart(2, '0');
          const bitisGun = ayiciMatch[2].padStart(2, '0');
          const ayAdi = ayiciMatch[3].toUpperCase();
          const ay = aylar[ayAdi] || '01';
          
          const sonuc = {
            baslangic: `${yil}-${ay}-${baslangicGun}`,
            bitis: `${yil}-${ay}-${bitisGun}`
          };
          
          console.log('âœ… Tarih parse baÅŸarÄ±lÄ± (Format 2):', sonuc);
          return sonuc;
        }
        
        console.log('âš ï¸ Tarih formatÄ± tanÄ±nmadÄ±, pattern denemesi yapÄ±lÄ±yor...');
        
      } catch (error) {
        console.warn('âŒ Tarih parse hatasÄ±:', error);
      }
      
      // Fallback
      const fallback = {
        baslangic: bugun.toISOString().split('T')[0],
        bitis: bugun.toISOString().split('T')[0]
      };
      
      console.log('âš ï¸ Fallback tarih kullanÄ±lÄ±yor:', fallback);
      return fallback;
    }

    // Hasta bulma/oluÅŸturma (GitHub entegrasyonlu)
    // Ã‡oklu PDF iÅŸlemi iÃ§in hasta cache'i
    const cokluPdfHastaCache = new Map();

    async function findOrCreateHastaWithGitHub(hastaAdi) {
      console.log('ğŸ‘¤ Hasta aranÄ±yor/oluÅŸturuluyor:', hastaAdi);
      
      // Cache'de var mÄ± kontrol et (Ã§oklu PDF iÅŸlemi iÃ§in)
      const cacheKey = hastaAdi.toUpperCase();
      if (cokluPdfHastaCache.has(cacheKey)) {
        const cachedHasta = cokluPdfHastaCache.get(cacheKey);
        console.log('ğŸš¨ CACHE\'DEN HASTA ALINDI:', hastaAdi);
        console.log('ğŸ” Cache hafta sayÄ±sÄ±:', cachedHasta.haftalar ? cachedHasta.haftalar.length : 0);
        console.log('ğŸ” Cache hafta detaylarÄ±:', cachedHasta.haftalar ? cachedHasta.haftalar.map(h => ({ haftaNo: h.haftaNo, baslangic: h.baslangic, bitis: h.bitis })) : []);
        return cachedHasta;
      }
      
      // DÃœZELTME: Global hastalar dizisini kullan (localStorage'dan her defasÄ±nda yÃ¼kleme!)
      // let hastalar = JSON.parse(localStorage.getItem('lipedem_hasta_kayitlari') || '[]');
      
      // Mevcut hastayÄ± ara (global hastalar dizisinde)
      let hasta = hastalar.find(h => 
        (h.ad && h.ad.toUpperCase() === hastaAdi.toUpperCase()) || 
        (h.isim && h.isim.toUpperCase() === hastaAdi.toUpperCase())
      );
      
      if (!hasta) {
        // Yeni hasta oluÅŸtur (manuel kayÄ±t formatÄ±na uygun)
        const hastaId = generatePatientId(hastaAdi);
        hasta = {
          id: hastaId,
          isim: hastaAdi,
          ad: hastaAdi, // backward compatibility
          not: "",
          arsiv: false,
          kayitTarihi: new Date().toISOString(),
          haftalar: [],
          durumu: 'aktif',
          olusturmaTarihi: new Date().toISOString(),
          yeniSistem: true
        };
        hastalar.push(hasta);
        console.log('âœ… Yeni hasta oluÅŸturuldu:', hastaAdi);
        
        // GitHub'a hasta listesi kaydet
        const token = document.getElementById('githubToken').value.trim();
        if (token) {
          try {
            // Hasta listesini GitHub'a kaydet
            const hastaListesi = await hastaListesiYukle() || [];
            const yeniHastaListesi = {
              id: hastaId,
              isim: hastaAdi,
              kayitTarihi: new Date().toISOString(),
              durumu: 'aktif'
            };
            
            // AynÄ± hasta yoksa ekle
            if (!hastaListesi.find(h => h.id === hastaId)) {
              hastaListesi.push(yeniHastaListesi);
              await hastaListesiKaydet(hastaListesi);
              console.log('âœ… Hasta listesi GitHub\'a gÃ¼ncellendi');
            }
            
            // Hasta verisini GitHub'a kaydet
            await hastayiAyriKaydet(hasta);
            console.log('âœ… Hasta verisi GitHub\'a kaydedildi');
            
          } catch (error) {
            console.error('âš ï¸ GitHub kaydetme hatasÄ±:', error);
          }
        }
      } else {
        console.log('âœ… Mevcut hasta bulundu:', hastaAdi, 'Hafta sayÄ±sÄ±:', hasta.haftalar ? hasta.haftalar.length : 0);
      }
      
      // Cache'e ekle (Ã§oklu PDF iÅŸlemi iÃ§in)
      cokluPdfHastaCache.set(cacheKey, hasta);
      
      // DÃœZELTME: Manuel sistemle aynÄ± ÅŸekilde saveToStorage() kullan
      saveToStorage();
      
      return hasta;
    }

    // Hafta bulma/oluÅŸturma (GitHub gÃ¼ncellemeli)
    async function findOrCreateHaftaWithGitHub(hasta, haftaNo, tarihAraligi) {
      console.log('ğŸ“… Hafta aranÄ±yor/oluÅŸturuluyor:', haftaNo, tarihAraligi);
      
      if (!hasta.haftalar) hasta.haftalar = [];
      
      // Mevcut haftayÄ± ara (hafta numarasÄ±na gÃ¶re)
      let hafta = hasta.haftalar.find(h => h.haftaNo === haftaNo);
      
      if (!hafta) {
        // Tarihleri parse et
        const tarihBilgisi = parseTarihAraligi(tarihAraligi);
        
        console.log(`âœ¨ ${haftaNo}. hafta oluÅŸturuluyor, mevcut hafta sayÄ±sÄ±: ${hasta.haftalar.length}`);
        console.log('ğŸ“… Hafta iÃ§in hesaplanan tarihler:', tarihBilgisi);
        
        // Yeni hafta oluÅŸtur (manuel kayÄ±t formatÄ±na uygun)
        hafta = {
          haftaNo: haftaNo,
          baslangic: tarihBilgisi.baslangic,
          bitis: tarihBilgisi.bitis,
          aciklama: "",
          pdf: null,
          pdfName: null,
          pdfOrijinalIsim: null,
          pdfYolu: null,
          githubUrl: null,
          indirmeUrl: null,
          kayitTarihi: new Date().toISOString(),
          tarifKartlar: [],
          tarifler: [],
          gptMesaj: "",
          pdfFile: {}
        };
        hasta.haftalar.push(hafta);
        console.log(`âœ… ${hasta.isim || hasta.ad} iÃ§in ${haftaNo}. hafta oluÅŸturuldu (${tarihAraligi})`);
        console.log('ğŸ“‹ OluÅŸturulan hafta detayÄ±:', { haftaNo: hafta.haftaNo, baslangic: hafta.baslangic, bitis: hafta.bitis });
        
        // GitHub'a gÃ¼ncellenmiÅŸ hasta verisini kaydet
        const token = document.getElementById('githubToken').value.trim();
        if (token) {
          try {
            await hastayiAyriKaydet(hasta);
            console.log(`âœ… ${hasta.isim || hasta.ad} hafta verisi GitHub'a gÃ¼ncellendi`);
          } catch (error) {
            console.error('âš ï¸ Hafta GitHub kaydetme hatasÄ±:', error);
          }
        }
        
        // Cache'i de gÃ¼ncelle (Ã§oklu PDF iÅŸlemi iÃ§in)
        if (typeof cokluPdfHastaCache !== 'undefined') {
          const cacheKey = (hasta.isim || hasta.ad).toUpperCase();
          cokluPdfHastaCache.set(cacheKey, hasta);
          console.log(`ğŸ”„ Cache gÃ¼ncellendi: ${hasta.isim || hasta.ad} - Hafta sayÄ±sÄ±: ${hasta.haftalar.length}`);
        }
        
        // DÃœZELTME: Manuel sistemle aynÄ± ÅŸekilde saveToStorage() kullan
        saveToStorage();
      } else {
        console.log(`âœ… ${hasta.isim || hasta.ad} iÃ§in ${haftaNo}. hafta zaten mevcut`);
      }
      
      return hafta;
    }

    async function processCokluPdf(files) {
      if (!files || files.length === 0) {
        alert('LÃ¼tfen en az bir PDF dosyasÄ± seÃ§in.');
        return;
      }

      console.log('ğŸ“ Ã‡oklu PDF iÅŸlemi baÅŸlatÄ±ldÄ±:', files.length, 'dosya');
      
      const sonuclar = [];
      let basarili = 0;
      let hatali = 0;

      // Progress gÃ¶sterimi
      const progressDiv = document.createElement('div');
      progressDiv.style.cssText = `
        position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
        background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        z-index: 10000; min-width: 300px; text-align: center;
      `;
      progressDiv.innerHTML = `
        <h3>ğŸ“ PDF'ler Ä°ÅŸleniyor...</h3>
        <div id="progressBar" style="width: 100%; height: 20px; background: #f0f0f0; border-radius: 10px; overflow: hidden; margin: 10px 0;">
          <div id="progressFill" style="width: 0%; height: 100%; background: linear-gradient(45deg, #667eea, #764ba2); transition: width 0.3s;"></div>
        </div>
        <div id="progressText">0 / ${files.length}</div>
      `;
      document.body.appendChild(progressDiv);

      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        const progress = ((i + 1) / files.length) * 100;
        
        // Progress gÃ¼ncelle
        document.getElementById('progressFill').style.width = progress + '%';
        document.getElementById('progressText').textContent = `${i + 1} / ${files.length}`;
        
        try {
          console.log(`ğŸ” ${i + 1}/${files.length} - "${file.name}" analiz ediliyor...`);
          
          // Dosya adÄ±nÄ± parse et
          const parsed = parseProfessionalPdfName(file.name);
          
          if (!parsed) {
            console.warn('âš ï¸ Dosya adÄ± format hatasÄ±:', file.name);
            sonuclar.push({ dosya: file.name, durum: 'HATA', mesaj: 'Dosya adÄ± formatÄ± tanÄ±nmadÄ±' });
            hatali++;
            continue;
          }

          // Hasta oluÅŸtur/bul (GitHub entegrasyonlu)
          const hasta = await findOrCreateHastaWithGitHub(parsed.hastaAdi);
          
          // Hafta oluÅŸtur/bul (GitHub gÃ¼ncellemeli)
          const hafta = await findOrCreateHaftaWithGitHub(hasta, parsed.haftaNo, parsed.tarihAraligi);
          
          // PDF dosyasÄ±nÄ± iÅŸle
          try {
            // PDF'i GitHub'a yÃ¼kle (manuel sistemle aynÄ±)
            console.log(`ğŸ“¤ ${file.name} GitHub'a yÃ¼kleniyor...`);
            const pdfSonuc = await pdfYukleGithub(file, hasta.id, hafta.haftaNo);
            
            if (!pdfSonuc) {
              console.error(`âŒ ${file.name} yÃ¼kleme baÅŸarÄ±sÄ±z`);
              sonuclar.push({ dosya: file.name, durum: 'HATA', mesaj: 'PDF yÃ¼kleme baÅŸarÄ±sÄ±z' });
              hatali++;
              continue;
            }
            
            // Manuel sistemle aynÄ± ÅŸekilde yol referansÄ± kaydet (Base64 deÄŸil!)
            hafta.pdfOrijinalIsim = pdfSonuc.orijinalAd;
            hafta.pdfName = pdfSonuc.guvenliAd;
            hafta.pdfYolu = pdfSonuc.dosyaYolu;
            hafta.githubUrl = pdfSonuc.githubUrl;
            hafta.indirmeUrl = pdfSonuc.indirmeUrl;
            hafta.kayitTarihi = new Date().toISOString();
            
            // Tab bilgilerini gÃ¼ncelle (7 gÃ¼nden uzun aralÄ±k varsa Ã¶zel format)
            if (parsed.baslangicGun && parsed.baslangicAy) {
              const parsedTarihler = parseEdilmistarihleriDateOlarak(parsed);
              if (parsedTarihler && parsedTarihler.gunSayisi > 7) {
                console.log(`ğŸ“… Ã‡oklu PDF - uzun tarih aralÄ±ÄŸÄ± tespit edildi: ${parsedTarihler.gunSayisi} gÃ¼n`);
                hafta.ozelTabFormat = true;
                hafta.tabBaslik = `${hafta.haftaNo}. Hafta`;
                
                // Zaman dilimi sorununu Ã¶nlemek iÃ§in direkt split kullanÄ±yoruz
                const basDateParts = parsedTarihler.baslangic.split('-');
                const bitDateParts = parsedTarihler.bitis.split('-');
                hafta.tabTarih = `${basDateParts[1]}/${basDateParts[2]} - ${bitDateParts[1]}/${bitDateParts[2]}`;
              }
            }
            
            // PDF analizi iÃ§in geÃ§ici Base64 oluÅŸtur (JSON'a kaydetmiyoruz!)
            const pdfBase64 = await fileToBase64(file);
            hafta.pdfFile = file; // GeÃ§ici analiz iÃ§in File objesi
            
            // PDF'den metin Ã§Ä±kar ve tarif analizi yap
            try {
              console.log(`ğŸ” ${file.name} PDF iÃ§erik analizi baÅŸlÄ±yor...`);
              
              // Base64'den PDF metnini Ã§Ä±kar
              let base64Data = pdfBase64;
              if (base64Data.includes(',')) {
                base64Data = base64Data.split(',')[1];
              }
              
              // Base64 verisini temizle ve doÄŸrula
              base64Data = base64Data.replace(/[^A-Za-z0-9+/=]/g, '');
              
              if (!base64Data || base64Data.length === 0) {
                console.warn(`âš ï¸ ${file.name} iÃ§in geÃ§ersiz Base64 verisi`);
                hafta.tarifler = [];
                hafta.tarifKartlar = [];
                throw new Error('GeÃ§ersiz PDF Base64 verisi');
              }
              
              console.log(`ğŸ“„ Base64 veri uzunluÄŸu: ${base64Data.length} karakter`);
              
              const binaryString = atob(base64Data);
              const bytes = new Uint8Array(binaryString.length);
              for (let i = 0; i < binaryString.length; i++) {
                bytes[i] = binaryString.charCodeAt(i);
              }
              
              const pdf = await pdfjsLib.getDocument({ data: bytes }).promise;
              let fullText = '';
              
              console.log(`ğŸ“– PDF toplam sayfa sayÄ±sÄ±: ${pdf.numPages}`);
              
              // Manuel sistemle AYNI ÅŸekilde metin Ã§Ä±karma
              for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                console.log(`ğŸ“„ Sayfa ${pageNum}/${pdf.numPages} iÅŸleniyor...`);
                const page = await pdf.getPage(pageNum);
                const textContent = await page.getTextContent();
                const strings = textContent.items.map(item => item.str);
                const pageText = strings.join('\n') + '\n';
                
                console.log(`ğŸ“„ Sayfa ${pageNum} metin uzunluÄŸu: ${pageText.length} karakter`);
                console.log(`ğŸ“„ Sayfa ${pageNum} ilk 200 karakter:`, pageText.substring(0, 200));
                
                // Tavuk iÃ§eren satÄ±rlarÄ± Ã¶zel kontrol et
                if (pageText.toLowerCase().includes('tavuk')) {
                  console.log(`ğŸ” Sayfa ${pageNum}'da TAVUK bulundu!`);
                  const tavukSatirlari = pageText.split('\n').filter(line => line.toLowerCase().includes('tavuk'));
                  console.log(`ğŸ” Sayfa ${pageNum} tavuk satÄ±rlarÄ±:`, tavukSatirlari);
                }
                
                // Pirzola iÃ§eren satÄ±rlarÄ± Ã¶zel kontrol et
                if (pageText.toLowerCase().includes('pirzola')) {
                  console.log(`ğŸ¥© Sayfa ${pageNum}'da PIRZOLA bulundu!`);
                  const pirzolaSatirlari = pageText.split('\n').filter(line => line.toLowerCase().includes('pirzola'));
                  console.log(`ğŸ¥© Sayfa ${pageNum} pirzola satÄ±rlarÄ±:`, pirzolaSatirlari);
                }
                
                // 150 gr iÃ§eren satÄ±rlarÄ± Ã¶zel kontrol et
                if (pageText.includes('150') && pageText.toLowerCase().includes('gr')) {
                  console.log(`âš–ï¸ Sayfa ${pageNum}'da 150 gr bulundu!`);
                  const miktarSatirlari = pageText.split('\n').filter(line => line.includes('150') && line.toLowerCase().includes('gr'));
                  console.log(`âš–ï¸ Sayfa ${pageNum} 150 gr satÄ±rlarÄ±:`, miktarSatirlari);
                }
                
                fullText += pageText; // Manuel sistemle aynÄ±: '\n' kullan!
              }
              
              console.log(`ğŸ“„ PDF metni Ã§Ä±karÄ±ldÄ±: ${fullText.length} karakter`);
              console.log(`ğŸ“„ PDF tam metni (ilk 500 karakter):`, fullText.substring(0, 500));
              
              // Ham metinde aradÄ±ÄŸÄ±mÄ±z satÄ±rlarÄ± kontrol et
              console.log(`ğŸ” Ham metinde 'tavuk' var mÄ±?`, fullText.toLowerCase().includes('tavuk'));
              console.log(`ğŸ” Ham metinde 'pirzola' var mÄ±?`, fullText.toLowerCase().includes('pirzola'));
              console.log(`ğŸ” Ham metinde '150' var mÄ±?`, fullText.includes('150'));
              
              // Tarif detaylarÄ±nÄ± Ã§Ä±kar
              const tarifDetaylar = extractTariflerDetay(fullText);
              hafta.tarifler = tarifDetaylar;
              console.log(`ğŸ½ï¸ ${tarifDetaylar.length} tarif detayÄ± bulundu`);
              
              // Manuel sistemle AYNI ÅŸekilde eÅŸleÅŸtirme yap
              if (window.tarifKartlari && window.tarifKartlari.length > 0 && tarifDetaylar.length > 0) {
                console.log(`ğŸ”— ${file.name} iÃ§in tarif eÅŸleÅŸtirmesi baÅŸlÄ±yor (manuel sistem gibi)...`);
                
                // Global deÄŸiÅŸkenleri geÃ§ici gÃ¼ncelle (manuel sistem iÃ§in gerekli)
                const tempSeciliHasta = seciliHasta;
                const tempHastalar = window.hastalar ? [...window.hastalar] : [];
                
                // Hasta listesini gÃ¼ncelle
                if (!window.hastalar) window.hastalar = [];
                let hastaIndex = window.hastalar.findIndex(h => h.id === hasta.id);
                if (hastaIndex === -1) {
                  window.hastalar.push(hasta);
                  hastaIndex = window.hastalar.length - 1;
                } else {
                  window.hastalar[hastaIndex] = hasta;
                }
                
                // seciliHasta'yÄ± geÃ§ici olarak gÃ¼ncelle
                seciliHasta = hasta;
                
                // Manuel sistemle AYNI ÅŸekilde hafta localStorage gÃ¼ncellemesi
                const haftaIndex = hasta.haftalar.findIndex(h => h.haftaNo === hafta.haftaNo);
                if (haftaIndex >= 0) {
                  // Manuel sistemle AYNI: Ã¶nce tarifler gÃ¼ncelle
                  hasta.haftalar[haftaIndex].tarifler = tarifDetaylar;
                  
                  try {
                    // Manuel sistemle AYNI otomatik eÅŸleÅŸtirme fonksiyonunu kullan
                    const eslestirmeSonucu = await otomatikEsleHafta(haftaIndex);
                    
                    if (eslestirmeSonucu) {
                      console.log('âœ… EÅŸleÅŸtirme sonuÃ§larÄ± hafta verilerine kaydediliyor...');
                      hafta.tarifKartlar = eslestirmeSonucu.eslesenKartlar || [];
                      console.log('ğŸ“ JSON\'a kaydedilecek eÅŸleÅŸen kart sayÄ±sÄ±:', eslestirmeSonucu.eslesenKartlar?.length || 0);
                      
                      // Manuel sistemle AYNI ÅŸekilde hasta verilerini gÃ¼ncelle
                      seciliHasta.haftalar[haftaIndex].tarifKartlar = hafta.tarifKartlar || [];
                      
                      // Mevcut JSON'da eslesmeyenTarifler varsa sil (manuel sistemle aynÄ±)
                      if (seciliHasta.haftalar[haftaIndex].eslesmeyenTarifler) {
                        delete seciliHasta.haftalar[haftaIndex].eslesmeyenTarifler;
                        console.log('ğŸ§¹ Eski eslesmeyenTarifler verisi JSON\'dan temizlendi');
                      }
                      
                      // Manuel sistemle AYNI ÅŸekilde GitHub'a kaydet
                      await hastayiAyriKaydet(seciliHasta);
                      console.log('ğŸ“ EÅŸleÅŸtirme sonrasÄ± GitHub\'a kaydedildi (manuel sistem gibi)');
                    }
                    
                    console.log(`âœ… Manuel sistem uyumlu eÅŸleÅŸtirme tamamlandÄ±: ${hafta.tarifKartlar.length} eÅŸleÅŸme bulundu`);
                  } catch (eslesmeError) {
                    console.warn('âš ï¸ EÅŸleÅŸtirme hatasÄ±:', eslesmeError);
                    hafta.tarifKartlar = [];
                  }
                }
                
                // Global deÄŸiÅŸkenleri geri yÃ¼kle
                seciliHasta = tempSeciliHasta;
                window.hastalar = tempHastalar;
                
              } else {
                console.warn('âš ï¸ Tarif kartlarÄ± yÃ¼klenmemiÅŸ veya tarif bulunamadÄ±, eÅŸleÅŸtirme atlanÄ±yor');
                hafta.tarifKartlar = [];
              }
              
            } catch (pdfAnalysisError) {
              console.error('âŒ PDF analiz hatasÄ±:', pdfAnalysisError);
              hafta.tarifler = [];
              hafta.tarifKartlar = [];
            }
            
            // GeÃ§ici pdfFile'Ä± temizle (manuel sistemle aynÄ±)
            if (hafta.pdfFile) {
              delete hafta.pdfFile;
            }
            
            // GÃ¼ncellenmiÅŸ hasta verisini kaydet
            console.log(`ğŸ” DEBUG: ${file.name} - Hasta kaydedilmeden Ã¶nce hafta.tarifKartlar:`, hafta.tarifKartlar);
            console.log(`ğŸ” DEBUG: ${file.name} - Hasta kaydedilmeden Ã¶nce hafta.tarifler:`, hafta.tarifler);
            console.log(`ğŸ” DEBUG: ${file.name} - Final hafta verisi (Base64 olmadan):`, JSON.stringify(hafta, null, 2));
            await hastayiAyriKaydet(hasta);
            
            // Manuel sistemle AYNI ÅŸekilde localStorage da gÃ¼ncelle
            saveToStorage();
            
          } catch (pdfError) {
            console.warn('âš ï¸ PDF iÅŸleme hatasÄ±:', pdfError);
            // PDF hatasÄ± olsa bile hasta/hafta kaydÄ±nÄ± tamamla
          }
          
          sonuclar.push({ 
            dosya: file.name, 
            durum: 'BAÅARILI', 
            hasta: parsed.hastaAdi,
            hafta: parsed.haftaNo,
            tarihAraligi: parsed.tarihAraligi,
            tarifSayisi: hafta.tarifler ? hafta.tarifler.length : 0,
            eslesmeSayisi: hafta.tarifKartlar ? hafta.tarifKartlar.length : 0,
            mesaj: `${hafta.tarifler ? hafta.tarifler.length : 0} tarif, ${hafta.tarifKartlar ? hafta.tarifKartlar.length : 0} eÅŸleÅŸme`
          });
          basarili++;
          
          console.log(`âœ… ${file.name} baÅŸarÄ±yla iÅŸlendi`);
          
        } catch (error) {
          console.error('âŒ PDF iÅŸleme hatasÄ±:', file.name, error);
          sonuclar.push({ dosya: file.name, durum: 'HATA', mesaj: error.message });
          hatali++;
        }
        
        // KÃ¼Ã§Ã¼k bir delay (UI donmamasÄ± iÃ§in)
        await new Promise(resolve => setTimeout(resolve, 100));
      }

      // Progress dialog'u kapat
      document.body.removeChild(progressDiv);
      
      // GitHub'dan hasta listesini yeniden yÃ¼kle ve UI'Ä± gÃ¼ncelle
      if (basarili > 0) {
        try {
          console.log('ğŸ”„ Ã‡oklu PDF iÅŸlemi sonrasÄ± sistem gÃ¼ncelleniyor...');
          
          // Cache'i temizle (yeni veriler iÃ§in)
          try {
            const cacheKeys = Object.keys(localStorage).filter(key => key.startsWith('hasta_'));
            cacheKeys.forEach(key => localStorage.removeItem(key));
            console.log('âœ… Cache temizlendi');
          } catch (cacheError) {
            console.warn('âš ï¸ Cache temizleme hatasÄ±:', cacheError);
          }
          
          // Hasta listesini yeniden yÃ¼kle
          if (typeof loadHastaDataFromGitHub === 'function') {
            await loadHastaDataFromGitHub(true); // sessiz mod
            console.log('âœ… Hasta listesi GitHub\'dan yeniden yÃ¼klendi');
          }
          
          // UI'Ä± gÃ¼ncelle
          if (typeof updateHastaListesi === 'function') {
            updateHastaListesi();
            console.log('âœ… Hasta listesi UI gÃ¼ncellendi');
          } else {
            console.warn('âš ï¸ updateHastaListesi fonksiyonu bulunamadÄ±');
          }
          
          // Ana sistem UI'Ä±nÄ± gÃ¼ncelle
          if (typeof renderYeniSistem === 'function') {
            renderYeniSistem();
            console.log('âœ… Ana sistem UI gÃ¼ncellendi');
          }
          
        } catch (error) {
          console.warn('âš ï¸ Sistem gÃ¼ncelleme hatasÄ±:', error);
        }
      }
      
      // SonuÃ§ raporu gÃ¶ster
      let raporHtml = `
        <div style="max-height: 400px; overflow-y: auto;">
          <h3>ğŸ“Š Ä°ÅŸlem Raporu</h3>
          <p><strong>Toplam:</strong> ${files.length} dosya</p>
          <p><strong>BaÅŸarÄ±lÄ±:</strong> ${basarili}</p>
          <p><strong>HatalÄ±:</strong> ${hatali}</p>
          <hr>
          <h4>Detaylar:</h4>
      `;
      
      sonuclar.forEach(sonuc => {
        const ikon = sonuc.durum === 'BAÅARILI' ? 'âœ…' : 'âŒ';
        raporHtml += `<p>${ikon} <strong>${sonuc.dosya}</strong>`;
        if (sonuc.hasta) {
          raporHtml += ` â†’ ${sonuc.hasta} (${sonuc.hafta}. hafta)`;
          if (sonuc.tarifSayisi !== undefined) raporHtml += ` - ${sonuc.tarifSayisi} tarif`;
          if (sonuc.eslesmeSayisi !== undefined) raporHtml += `, ${sonuc.eslesmeSayisi} eÅŸleÅŸme`;
        }
        if (sonuc.mesaj && sonuc.durum === 'HATA') raporHtml += ` - ${sonuc.mesaj}`;
        raporHtml += `</p>`;
      });
      
      raporHtml += '</div>';
      
      // Modal dialog oluÅŸtur
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
        background: rgba(0,0,0,0.5); z-index: 10000; 
        display: flex; align-items: center; justify-content: center;
      `;
      modal.innerHTML = `
        <div style="background: white; padding: 20px; border-radius: 8px; max-width: 600px; width: 90%;">
          ${raporHtml}
          <button onclick="this.closest('div').parentElement.remove()" 
                  style="margin-top: 15px; padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
            Tamam
          </button>
        </div>
      `;
      document.body.appendChild(modal);
      
      console.log('ğŸ‰ Ã‡oklu PDF iÅŸlemi tamamlandÄ±! BaÅŸarÄ±lÄ±:', basarili, 'HatalÄ±:', hatali);
      
      // Otomatik kaydetme - Ã§oklu PDF iÅŸlemi tamamlandÄ± (Cache temizlenmeden Ã¶nce!)
      if (basarili > 0 && typeof cokluPdfHastaCache !== 'undefined') {
        console.log('ğŸ’¾ Ã‡oklu PDF iÅŸlemi baÅŸarÄ±lÄ±, tÃ¼m hasta verileri otomatik kaydediliyor...');
        
        // Cache'deki tÃ¼m hastalarÄ± global hastalar dizisine ekle/gÃ¼ncelle
        for (const [key, hasta] of cokluPdfHastaCache.entries()) {
          autoSaveHastaData(hasta);
        }
      }
      
      // Cache'i temizle
      if (typeof cokluPdfHastaCache !== 'undefined') {
        console.log('ğŸ§¹ Cache temizleniyor... Ã–nceki boyut:', cokluPdfHastaCache.size);
        cokluPdfHastaCache.clear();
      }
      
      // Final kaydetme: TÃ¼m deÄŸiÅŸiklikleri kesin olarak kaydet
      saveToStorage();
      console.log('ğŸ’¾ Ã‡oklu PDF iÅŸlemi sonrasÄ± final kaydetme tamamlandÄ±');
      
      // Yemek analizini gÃ¼ncelle (Ã§oklu PDF iÅŸlemi sonrasÄ±)
      if (basarili > 0) {
        console.log('ğŸ“Š Ã‡oklu PDF iÅŸlemi sonrasÄ± yemek analizi gÃ¼ncelleniyor...');
        setTimeout(() => {
          updateYemekAnalizi();
        }, 1000); // Veriler tamamen yÃ¼klenmesi iÃ§in 1 saniye bekle
      }
    }

    // UTF-8 Base64 decode yardÄ±mcÄ± fonksiyonu (TÃ¼rkÃ§e karakterler iÃ§in)
    function decodeBase64UTF8(base64Content) {
      try {
        // Modern tarayÄ±cÄ±larda TextDecoder kullan
        const bytes = Uint8Array.from(atob(base64Content), c => c.charCodeAt(0));
        const decoded = new TextDecoder('utf-8').decode(bytes);
        
        // ğŸ•µï¸ DEBUG: Encoding karÅŸÄ±laÅŸtÄ±rmasÄ± (sadece Ã¶nemli farklar iÃ§in log)
        const simpleDecoded = atob(base64Content);
        if (decoded !== simpleDecoded && decoded.includes('Ä°') || decoded.includes('Ä') || decoded.includes('Ãœ')) {
          console.log('ï¿½ UTF-8 decode kullanÄ±ldÄ± (TÃ¼rkÃ§e karakter tespit edildi)');
        }
        
        return decoded;
      } catch (decodeError) {
        // Fallback: Normal atob kullan
        console.warn('UTF-8 decode baÅŸarÄ±sÄ±z, normal decode deneniyor:', decodeError);
        return atob(base64Content);
      }
    }
    
    // UTF-8 encoding iÃ§in yardÄ±mcÄ± fonksiyon
    function encodeUTF8ToBase64(jsonData) {
      try {
        const jsonString = JSON.stringify(jsonData, null, 2);
        const encoder = new TextEncoder();
        const utf8Bytes = encoder.encode(jsonString);
        
        // BÃ¼yÃ¼k veri setleri iÃ§in chunk'lara bÃ¶lerek iÅŸle
        let binaryString = '';
        const chunkSize = 8192; // 8KB chunks
        for (let i = 0; i < utf8Bytes.length; i += chunkSize) {
          const chunk = utf8Bytes.slice(i, i + chunkSize);
          binaryString += String.fromCharCode.apply(null, chunk);
        }
        return btoa(binaryString);
      } catch (error) {
        console.warn('UTF-8 encode baÅŸarÄ±sÄ±z, fallback kullanÄ±lÄ±yor:', error);
        // Fallback: Eski yÃ¶ntem
        return btoa(unescape(encodeURIComponent(JSON.stringify(jsonData, null, 2))));
      }
    }
    
    // Base64'Ã¼ blob'a Ã§evir
    function base64ToBlob(base64Content, mimeType = 'application/octet-stream') {
      try {
        // Base64 string'den yeni satÄ±rlarÄ± temizle
        const cleanedBase64 = base64Content.replace(/\s/g, '');
        const byteCharacters = atob(cleanedBase64);
        const byteNumbers = new Array(byteCharacters.length);
        
        for (let i = 0; i < byteCharacters.length; i++) {
          byteNumbers[i] = byteCharacters.charCodeAt(i);
        }
        
        const byteArray = new Uint8Array(byteNumbers);
        return new Blob([byteArray], { type: mimeType });
      } catch (error) {
        console.error('Base64 to blob conversion error:', error);
        throw new Error('Base64 dosya dÃ¶nÃ¼ÅŸtÃ¼rme hatasÄ±');
      }
    }
    
    // Hasta verisini GitHub'dan al (Yeni Sistem Uyumlu)
    async function getHastaData(hastaId, githubRepo = null, githubToken = null, hastaIsim = null) {
      try {
        // Parametrelerden veya global deÄŸiÅŸkenlerden al
        const repo = githubRepo || (typeof GITHUB_REPO !== 'undefined' ? GITHUB_REPO : null);
        const token = githubToken || (typeof GITHUB_TOKEN !== 'undefined' ? GITHUB_TOKEN : null);
        
        if (!repo || !token) {
          throw new Error('GitHub repo veya token eksik');
        }
        
        // Yeni sistem: hasta_ID_ISIM.json formatÄ±nda dosya ara
        const dosyaAdlari = [];
        
        if (hastaIsim) {
          dosyaAdlari.push(generateFileName({ id: hastaId, isim: hastaIsim }));
          dosyaAdlari.push(generateFileName({ id: hastaId, isim: turkceKarakterDuzelt(hastaIsim) }));
          dosyaAdlari.push(generateFileName({ isim: hastaIsim }));
          dosyaAdlari.push(generateFileName({ isim: turkceKarakterDuzelt(hastaIsim) }));
        }
        
        // Ã‡ift entryleri kaldÄ±r
        const benzersizDosyaAdlari = [...new Set(dosyaAdlari)];
        
        console.log('ğŸ” Hasta verisi aranan dosyalar:', benzersizDosyaAdlari);
        
        // Her dosya adÄ±nÄ± dene
        for (const dosyaAdi of benzersizDosyaAdlari) {
          try {
            const response = await fetch(`https://api.github.com/repos/${repo}/contents/patients/${dosyaAdi}`, {
              headers: {
                'Authorization': `token ${token}`
              }
            });
            
            if (response.ok) {
              const data = await response.json();
              const content = decodeBase64UTF8(data.content);
              console.log(`âœ… Hasta verisi bulundu: ${dosyaAdi}`);
              return JSON.parse(content);
            }
          } catch (e) {
            console.log(`âŒ Dosya bulunamadÄ±: ${dosyaAdi}`);
          }
        }
        
        // Eski sistem de deneyelim (backward compatibility)
        try {
          const response = await fetch(`https://api.github.com/repos/${repo}/contents/patients/${hastaId}/hasta_data.json`, {
            headers: {
              'Authorization': `token ${token}`
            }
          });
          
          if (response.ok) {
            const data = await response.json();
            const content = decodeBase64UTF8(data.content);
            console.log(`âœ… Hasta verisi eski sistemde bulundu: ${hastaId}/hasta_data.json`);
            return JSON.parse(content);
          }
        } catch (e) {
          console.log(`âŒ Eski sistem de bulunamadÄ±: ${hastaId}/hasta_data.json`);
        }
        
        throw new Error('Hasta verisi bulunamadÄ±');
      } catch (error) {
        console.error('Hasta verisi alma hatasÄ±:', error);
        throw error;
      }
    }
    
    // --- GitHub'a JSON dosyasÄ± kaydetme fonksiyonu ---
    // Global deÄŸiÅŸkenler
    let seciliHasta = null;
    
    // EÅŸleÅŸmeyenler listesini gÃ¼ncelle - manuel eÅŸleÅŸtirme sonrasÄ±
    function eslesmeyenlerListesiniGuncelle() {
      const eslesmeyenlerContent = document.getElementById('eslesmeyenlerContent');
      const eslesmeyenlerBaslik = document.getElementById('eslesmeyenlerBaslik');
      
      if (!eslesmeyenlerContent || !eslesmeyenlerBaslik) {
        console.log('ğŸ” EÅŸleÅŸmeyenler DOM elementleri bulunamadÄ±');
        return;
      }
      
      // Mevcut eÅŸleÅŸmeyen tarifleri tekrar kontrol et
      const aktifHasta = seciliHasta;
      if (!aktifHasta || !aktifHasta.haftalar) {
        console.log('â„¹ï¸ Yemek analizi iÃ§in hasta seÃ§ilmedi veya hafta verisi yok');
        return;
      }
      
      let yeniEslesmeyenler = [];
      
      // Ã–nce JSON'dan kaydedilmiÅŸ eÅŸleÅŸmeyen tarifleri al
      aktifHasta.haftalar.forEach(hafta => {
        if (hafta.eslesmeyenTarifler && hafta.eslesmeyenTarifler.length > 0) {
          hafta.eslesmeyenTarifler.forEach(tarif => {
            if (!yeniEslesmeyenler.includes(tarif)) {
              yeniEslesmeyenler.push(tarif);
            }
          });
        }
      });
      
      // EÄŸer JSON'da eÅŸleÅŸmeyen tarif yoksa, eski yÃ¶ntemle hesapla
      if (yeniEslesmeyenler.length === 0) {
        aktifHasta.haftalar.forEach(hafta => {
          if (hafta.tarifler && hafta.tarifler.length > 0) {
            hafta.tarifler.forEach(tarif => {
              // Normalize et
              function normalizeLocal(str) {
                return str
                  .toLowerCase()
                  .replace(/Ã§/g, 'c').replace(/ÄŸ/g, 'g').replace(/ÅŸ/g, 's')
                  .replace(/Ã¼/g, 'u').replace(/Ã¶/g, 'o').replace(/Ä±/g, 'i')
                  .replace(/iÌ‡/g, 'i')
                  .replace(/[_*\/()]/g, ' ')
                  .replace(/\s+/g, ' ')
                  .replace(/[^a-z0-9\s]/g, '')
                  .trim();
              }
              
              const normalizedTarif = normalizeLocal(tarif);
              
              // Otomatik eÅŸleÅŸme kontrolÃ¼
              const otomatikEslesen = tariflerKlasoruGorselleri.some(kart => {
                const normalizedKart = normalizeLocal(kart.name.replace(/\.[^/.]+$/, ''));
                return normalizedKart.includes(normalizedTarif) || 
                       normalizedTarif.includes(normalizedKart) ||
                       normalizedKart === normalizedTarif;
              });
              
              // Manuel eÅŸleÅŸme kontrolÃ¼  
              const manuelEslesen = manuelEslestirmeler[normalizedTarif];
              
              // Yasak kural kontrolÃ¼
              const yasakMi = eslesmemeKurallari[normalizedTarif];
              
              // EÄŸer hiÃ§bir yerde eÅŸleÅŸmiyor ve yasaklanmamÄ±ÅŸsa eÅŸleÅŸmeyen listesine ekle
              if (!otomatikEslesen && !manuelEslesen && !yasakMi && !yeniEslesmeyenler.includes(tarif)) {
                yeniEslesmeyenler.push(tarif);
              }
            });
          }
        });
      }
      
      // UI'Ä± gÃ¼ncelle
      if (yeniEslesmeyenler.length > 0) {
        eslesmeyenlerBaslik.textContent = `ğŸš« EÅŸleÅŸmeyen Tarifler (${yeniEslesmeyenler.length})`;
        eslesmeyenlerContent.innerHTML = '';
        
        yeniEslesmeyenler.forEach(tarif => {
          const p = document.createElement('p');
          p.textContent = tarif;
          p.style.color = '#dc3545';
          p.style.margin = '6px 0';
          p.style.padding = '4px 8px';
          p.style.background = '#fff5f5';
          p.style.borderLeft = '3px solid #dc3545';
          p.style.borderRadius = '4px';
          p.style.cursor = 'pointer';
          p.style.transition = 'background-color 0.2s';
          p.title = 'TÄ±kla ve manuel eÅŸleÅŸtirme yap';
          
          p.onmouseenter = () => p.style.background = '#ffe6e6';
          p.onmouseleave = () => p.style.background = '#fff5f5';
          p.onclick = () => {
            console.log('ğŸ”— EÅŸleÅŸmeyen tarif adÄ±na tÄ±klandÄ±:', tarif);
            try {
              if (typeof eslesmeyenTarifManuelEslestir === 'function') {
                eslesmeyenTarifManuelEslestir(tarif);
              } else {
                console.error('âŒ eslesmeyenTarifManuelEslestir fonksiyonu bulunamadÄ±!');
                alert('Manuel eÅŸleÅŸtirme fonksiyonu yÃ¼klenemedi. SayfayÄ± yenileyin.');
              }
            } catch (error) {
              console.error('âŒ EÅŸleÅŸmeyen tarif tÄ±klama hatasÄ±:', error);
              alert('Hata: ' + error.message);
            }
          };
          
          eslesmeyenlerContent.appendChild(p);
        });
      } else {
        eslesmeyenlerBaslik.textContent = 'ğŸš« EÅŸleÅŸmeyen Tarifler';
        eslesmeyenlerContent.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">ğŸ‰ TÃ¼m tarifler eÅŸleÅŸtirildi!</div>';
      }
      
      console.log('ğŸ”„ EÅŸleÅŸmeyenler listesi gÃ¼ncellendi:', yeniEslesmeyenler.length, 'adet');
    }
    
    // Alias function for backward compatibility
    function updateEslesmeyenTarifler() {
      eslesmeyenlerListesiniGuncelle();
    }

    // Aktif hafta index'ini al
    function getAktifHaftaIndex() {
      const aktifTab = document.querySelector('.hafta-tab.active');
      if (aktifTab && aktifTab.dataset.haftaIndex !== undefined) {
        const index = parseInt(aktifTab.dataset.haftaIndex);
        console.log('ğŸ” Aktif hafta index bulundu:', index);
        return index;
      }
      
      // Fallback: En son hafta
      if (seciliHasta?.haftalar?.length > 0) {
        const lastIndex = seciliHasta.haftalar.length - 1;
        console.log('âš ï¸ Aktif tab bulunamadÄ±, en son hafta kullanÄ±lÄ±yor:', lastIndex);
        return lastIndex;
      }
      
      console.error('âŒ HiÃ§ hafta bulunamadÄ±!');
      return 0;
    }
    
    // Token'Ä± localStorage'da sakla ve input'a yÃ¼kle
    const TOKEN_KEY = 'github_api_token';
    function saveTokenToStorage() {
      const val = document.getElementById('githubToken').value;
      localStorage.setItem(TOKEN_KEY, val);
    }
    function loadTokenFromStorage() {
      return localStorage.getItem(TOKEN_KEY) || '';
    }
    // Sayfa aÃ§Ä±lÄ±ÅŸÄ±nda token input'u doldur ve SADECE YENÄ° SÄ°STEMÄ° YÃœKLÄ°
    window.addEventListener('DOMContentLoaded', async function() {
      const token = loadTokenFromStorage();
      const input = document.getElementById('githubToken');
      if (input) input.value = token;
      
      // ESKÄ° SÄ°STEM DEVRE DIÅI - Sadece yeni JSON sistemi kullan
      console.log('ğŸš€ Yeni sistem baÅŸlatÄ±lÄ±yor...');
      
      // Karalisteyi Ã¶nce yÃ¼kle (token varsa GitHub'dan, yoksa public)
      try {
        const tknTmp = document.getElementById('githubToken')?.value?.trim();
        if (tknTmp) {
          await karalisteGitHubYukle(true);
        } else {
          await karalistePublicYukle();
        }
      } catch {}

  // Token sonradan girilirse: GitHub'dan yÃ¼kle ve birleÅŸtir (karaliste) + diÄŸer verileri tazele
      try {
        const tokenInputEl = document.getElementById('githubToken');
        if (tokenInputEl) {
          let lastToken = tokenInputEl.value.trim();
          tokenInputEl.addEventListener('change', async () => {
            const cur = tokenInputEl.value.trim();
            if (cur && cur !== lastToken) {
      console.log('ğŸ”‘ Yeni token algÄ±landÄ±, GitHub verileri yÃ¼kleniyor...');
      // 1) Karalisteyi GitHub'dan yÃ¼kle ve yerelle birleÅŸtir (union)
      try { await karalisteGitHubYukle(true); } catch (e) { console.warn('Karaliste yÃ¼kleme uyarÄ±sÄ±:', e?.message || e); }
      // 2) Manuel eÅŸleÅŸtirmeler, eÅŸleÅŸmeme kurallarÄ± ve split kurallarÄ±nÄ± GitHub'dan tazele (sessiz)
      try { await manuelEslestirmeleriGitHubYukle(true); } catch (e) { console.warn('Manuel eÅŸleÅŸtirme yÃ¼kleme uyarÄ±sÄ±:', e?.message || e); }
      try { await eslesmemeKurallariniGitHubYukle(true); } catch (e) { console.warn('EÅŸleÅŸmeme kural yÃ¼kleme uyarÄ±sÄ±:', e?.message || e); }
      try { await splitKurallariniGitHubYukle(true); } catch (e) { console.warn('Split kural yÃ¼kleme uyarÄ±sÄ±:', e?.message || e); }
      // 3) Hasta listesini/verilerini GitHub'dan gÃ¼ncelle (sessiz)
      try { await loadHastaDataFromGitHub(true); } catch (e) { console.warn('Hasta verileri yÃ¼kleme uyarÄ±sÄ±:', e?.message || e); }
      // 4) UI'Ä± gÃ¼ncelle
      try { renderBlacklistModal(); } catch {}
      try { updateYemekVeritabaniAnalizi(); } catch {}
      try { updateYemekAnalizi(); } catch {}
      try { if (typeof eslesmeyenlerListesiniGuncelle === 'function') eslesmeyenlerListesiniGuncelle(); } catch {}
      try { if (typeof durumGuncelle === 'function') durumGuncelle(); } catch {}
            }
            lastToken = cur;
          });
        }
      } catch {}

      // Ã–nce manuel eÅŸleÅŸtirmeleri yÃ¼kle
      manuelEslestirmeleriYukle();
      eslesmemeKurallariniYukle();
      
      // Sadece yeni sistemi baÅŸlat
      loadHastaDataFromGitHub().then(() => {
        console.log('âœ… Yeni sistem hazÄ±r');
        
        // Diyet tÃ¼rlerini yÃ¼kle
        diyetTurleriYukle().then(() => {
          console.log('âœ… Diyet tÃ¼rleri yÃ¼klendi');
        }).catch(error => {
          console.log('âš ï¸ Diyet tÃ¼rleri yÃ¼klenemedi:', error.message);
        });
        
        // Otomatik senkronizasyonu baÅŸlat
        setTimeout(() => {
          otomatikGithubKontrol();
          periyodikSenkronizasyonBaslat();
        }, 2000);
        
        // Sistem yÃ¼klendikten sonra yemek analizini baÅŸlat
        setTimeout(() => {
          updateYemekAnalizi();
          // EÅŸleÅŸmeyenler listesini de gÃ¼ncelle
          setTimeout(() => {
            try {
              if (typeof eslesmeyenlerListesiniGuncelle === 'function') {
                eslesmeyenlerListesiniGuncelle();
              } else {
                console.warn('âš ï¸ eslesmeyenlerListesiniGuncelle fonksiyonu henÃ¼z yÃ¼klenmemiÅŸ');
              }
            } catch (error) {
              console.warn('âš ï¸ eslesmeyenlerListesiniGuncelle hatasÄ±:', error.message);
            }
          }, 500);
        }, 1500); // TÃ¼m veriler yÃ¼klenmesi iÃ§in 1.5 saniye bekle
        
      }).catch(error => {
        console.warn('âš ï¸ Yeni sistem yÃ¼klenemedi:', error.message);
        // BoÅŸ yeni sistem ile baÅŸlat
        renderHastalarYeniSistem();
      });
    });

    // Data klasÃ¶rÃ¼nden hasta verilerini otomatik yÃ¼kle
    // TÃ¼rkÃ§e karakter dÃ¼zeltme fonksiyonu - YENÄ° VE GÃœVENLÄ° VERSÄ°YON
    function turkceKarakterDuzelt(text) {
      if (!text || typeof text !== 'string') return text;
      
      // SADECE BOZUK KARAKTERLERI TEMÄ°ZLE, YENÄ° BOZUKLUK YARATMA!
      let temizMetin = text;
      
      // 1. Sadece gerÃ§ekten bozuk olan ÃƒÃ‚ÃƒÃ‚ kalÄ±plarÄ±nÄ± temizle
      const bozukKaliplar = [
        /ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚/g,
        /ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚/g,
        /ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚/g,
        /ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚/g,
        /Ã£Ã¢Ã£Ã¢/g,
        /Ã£Ã¢/g
      ];
      
      // Bozuk kalÄ±plarÄ± kaldÄ±r
      bozukKaliplar.forEach(kalip => {
        temizMetin = temizMetin.replace(kalip, '');
      });
      
      // 2. Ã–NCE tam isim kalÄ±plarÄ±nÄ± dÃ¼zelt (en spesifik olanlar)
      temizMetin = temizMetin.replace(/\^EYDA E EÃ‡0\^Ã‡/gi, 'ÅEYDA EÄEÃ‡Ä°Å');
      
      // 2.1. PDF'de yaygÄ±n bozuk karakterleri dÃ¼zelt
      const karakterDuzeltmeleri = {
        '^': 'Å',    // PDF'de Å karakteri ^ olarak gÃ¶rÃ¼nÃ¼yor
        '0^': 'Ä°',   // PDF'de Ä° karakteri 0^ olarak gÃ¶rÃ¼nÃ¼yor  
        'Ã‡^': 'Ã‡',   // PDF'de Ã‡ karakteri Ã‡^ olarak gÃ¶rÃ¼nÃ¼yor
        'Â°': 'Ä°',    // Alternatif Ä° gÃ¶sterimi
        '*': 'Å',    // Alternatif Å gÃ¶sterimi
        'Â§': 'Å'     // BaÅŸka bir Å gÃ¶sterimi
      };
      
      // Karakter dÃ¼zeltmelerini uygula
      for (const [bozuk, dogru] of Object.entries(karakterDuzeltmeleri)) {
        temizMetin = temizMetin.replace(new RegExp(escapeRegex(bozuk), 'g'), dogru);
      }
      
      // 2.5. DiÄŸer Ã¶zel kalÄ±plarÄ± dÃ¼zelt
      temizMetin = temizMetin.replace(/\^EYDA/g, 'ÅEYDA');
      temizMetin = temizMetin.replace(/E EÃ‡0\^Ã‡/g, 'EÄEÃ‡Ä°Å');
      temizMetin = temizMetin.replace(/EGEÃ‡0\^/g, 'EÄEÃ‡Ä°Å');
      
      // 2. Sadece kesin bozuk karakterleri dÃ¼zelt (DÄ°KKATLÄ°!)
      if (temizMetin.includes('Â°')) {
        temizMetin = temizMetin.replace(/Â°/g, 'Ä°');
      }
      if (temizMetin.includes('*')) {
        temizMetin = temizMetin.replace(/\*/g, 'Å');
      }
      
      // 3. Bilinen bozuk isimleri dÃ¼zelt
      const isimDuzeltmeleri = {
        'efKE BAY': 'ÅEFÄ°KE BAY',
        'EFÂ°KE BAY': 'ÅEFÄ°KE BAY',
        'EFKE BAY': 'ÅEFÄ°KE BAY',
        'ATAYÅ': 'ATAYÅ', // DoÄŸru halini koru
        'ATAYYÅ': 'ATAYÅ', // Ã‡ifte Å'yi dÃ¼zelt
        'KK': 'KÃ–K',
        'KARAGZ': 'KARAGÃ–Z',
        'FSUN': 'FÄ°SUN',
        'FÂ°SUN': 'FÄ°SUN'
      };
      
      // Sadece kesin bozuk isimleri dÃ¼zelt
      for (const [bozuk, dogru] of Object.entries(isimDuzeltmeleri)) {
        if (temizMetin.includes(bozuk)) {
          temizMetin = temizMetin.replace(new RegExp(bozuk, 'gi'), dogru);
        }
      }
      
      // 4. Fazla boÅŸluklarÄ± temizle
      temizMetin = temizMetin.replace(/\s+/g, ' ').trim();
      
      return temizMetin;
    }
    
    // Regex escape helper
    function escapeRegex(str) {
      return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    // PDF iÃ§in TÃ¼rkÃ§e karakterleri ASCII'ye Ã§evir
    function pdfIcinASCII(text) {
      if (!text || typeof text !== 'string') return text;
      
      return text
        .replace(/Å/g, 'S').replace(/ÅŸ/g, 's')
        .replace(/Ä/g, 'G').replace(/ÄŸ/g, 'g')
        .replace(/Ä°/g, 'I').replace(/Ä±/g, 'i')
        .replace(/Ã‡/g, 'C').replace(/Ã§/g, 'c')
        .replace(/Ã–/g, 'O').replace(/Ã¶/g, 'o')
        .replace(/Ãœ/g, 'U').replace(/Ã¼/g, 'u');
    }

    // ACIL DURUM: LocalStorage'daki bozuk verileri temizle
    function localStorageTemizle() {
      console.log('ğŸ§¹ LocalStorage bozuk veri temizliÄŸi baÅŸlatÄ±lÄ±yor...');
      
      try {
        const hastaDataKey = 'hastaData';
        const hastalarKey = 'hastalar';
        
        // Her iki key'i de kontrol et
        const keys = [hastaDataKey, hastalarKey];
        let temizlenen = 0;
        
        keys.forEach(key => {
          const data = localStorage.getItem(key);
          if (data) {
            try {
              const hastalar = JSON.parse(data);
              let degisiklik = false;
              
              hastalar.forEach(hasta => {
                const eskiIsim = hasta.isim;
                hasta.isim = turkceKarakterDuzelt(hasta.isim);
                if (eskiIsim !== hasta.isim) {
                  degisiklik = true;
                  temizlenen++;
                }
                if (hasta.not) {
                  hasta.not = turkceKarakterDuzelt(hasta.not);
                }
              });
              
              if (degisiklik) {
                localStorage.setItem(key, JSON.stringify(hastalar));
                console.log(`ğŸ’¾ ${key} gÃ¼ncellendi`);
              }
            } catch (e) {
              console.error(`âŒ ${key} parse hatasÄ±:`, e);
            }
          }
        });
        
        if (temizlenen > 0) {
          console.log(`ğŸ‰ ${temizlenen} hasta ismi temizlendi!`);
        } else {
          console.log('âœ… Veri zaten temiz!');
        }
        
      } catch (error) {
        console.error('âŒ LocalStorage temizleme hatasÄ±:', error);
      }
    }
    
    // Sayfa yÃ¼klendiÄŸinde otomatik temizleme yap
    setTimeout(() => {
      localStorageTemizle();
    }, 2000);

    // Manuel olarak mevcut hasta verilerini dÃ¼zeltme fonksiyonu
    // Manuel olarak mevcut hasta verilerini dÃ¼zeltme fonksiyonu
    function manuelHastaIsimleriniDuzelt() {
      console.log('ğŸ”§ Hasta isimlerini dÃ¼zeltiliyor...');
      let degisiklikSayisi = 0;
      
      hastalar.forEach((hasta, index) => {
        if (hasta.isim) {
          const eskiIsim = hasta.isim;
          const yeniIsim = turkceKarakterDuzelt(eskiIsim);
          
          if (eskiIsim !== yeniIsim) {
            hasta.isim = yeniIsim;
            degisiklikSayisi++;
            console.log(`âœ… ${index + 1}. "${eskiIsim}" â†’ "${yeniIsim}"`);
          }
        }
        
        // NotlarÄ± da dÃ¼zelt
        if (hasta.not) {
          const eskiNot = hasta.not;
          const yeniNot = turkceKarakterDuzelt(eskiNot);
          if (eskiNot !== yeniNot) {
            hasta.not = yeniNot;
            console.log(`ğŸ“ Not dÃ¼zeltildi: "${eskiNot}" â†’ "${yeniNot}"`);
          }
        }
      });
      
      if (degisiklikSayisi > 0) {
        // Verileri kaydet
        saveToStorage();
        
        // Hasta listesini sÄ±rala ve yenile
        hastalar.sort((a, b) => a.isim.localeCompare(b.isim, 'tr'));
        renderHastalar();
        
        // EÄŸer bir hasta seÃ§iliyse paneli gÃ¼ncelle
        if (seciliHasta) {
          const secilenHastaIsim = document.getElementById('secilenHastaIsim');
          const secilenHastaNot = document.getElementById('secilenHastaNot');
          if (secilenHastaIsim) secilenHastaIsim.textContent = seciliHasta.isim.toUpperCase();
          if (secilenHastaNot) secilenHastaNot.textContent = seciliHasta.not || 'Not bulunmuyor';
        }
        
        console.log(`ğŸ‰ RADIKAL DÃœZELTMe TAmamlandÄ±: ${degisiklikSayisi} hasta ismi dÃ¼zeltildi!`);
        alert(`âœ… RADIKAL Ã‡Ã–ZÃœM: ${degisiklikSayisi} hasta ismi dÃ¼zeltildi!\n\nArtÄ±k "AYÅÃ‚E" â†’ "AYÅE" gibi dÃ¼zeltmeler yapÄ±ldÄ±.`);
        
        // DÃ¼zeltilen hastalarÄ± yeni sisteme kaydet
        console.log('ğŸ“¤ DÃ¼zeltilen hastalar yeni sisteme kaydediliyor...');
        tumHastalariAyriKaydet().then(() => {
          console.log('âœ… TÃ¼m dÃ¼zeltmeler yeni sisteme kaydedildi');
        }).catch(error => {
          console.error('âŒ Yeni sisteme kaydetme hatasÄ±:', error);
          alert('âš ï¸ DÃ¼zeltmeler yapÄ±ldÄ± ama GitHub kaydÄ± baÅŸarÄ±sÄ±z. Token kontrolÃ¼ yapÄ±n.');
        });
      } else {
        console.log('âœ… TÃ¼m hasta isimleri zaten doÄŸru!');
        alert('âœ… TÃ¼m hasta isimleri zaten doÄŸru formatta!');
      }
    }
    window.manuelHastaIsimleriniDuzelt = manuelHastaIsimleriniDuzelt;

    // ESKÄ° SÄ°STEM DEVRE DIÅI - ArtÄ±k sadece yeni JSON sistemi kullanÄ±lÄ±yor
    async function loadDataFromFolder() {
      const durumElement = document.getElementById('dataKlasoruDurumu');
      console.log('âš ï¸ ESKÄ° SÄ°STEM DEVRE DIÅI - Sadece yeni JSON sistemi kullanÄ±lÄ±yor');
      if (durumElement) {
        durumElement.innerHTML = 'âŒ ESKÄ° SÄ°STEM DEVRE DIÅI - Yeni JSON sistemi aktif';
      }
      // Eski sistem tamamen devre dÄ±ÅŸÄ± - data/hasta_kayitlari.json artÄ±k kullanÄ±lmÄ±yor
    }

    // Fresh veri yÃ¼kleme (cache'i bypass ederek)
    async function initFreshDataLoad() {
      console.log('ğŸš€ Fresh veri yÃ¼kleme baÅŸlÄ±yor...');
      
  // Ã–nce localStorage'dan yÃ¼kle (temel veriler iÃ§in)
      manuelEslestirmeleriYukle();
      eslesmemeKurallariniYukle();
  splitKurallariniYukle();
      
      // Token varsa GitHub'dan fresh yÃ¼kle ve override et
      const token = document.getElementById('githubToken').value.trim();
      if (token) {
        try {
          console.log('ğŸ”„ GitHub\'tan fresh veriler yÃ¼kleniyor...');
          
          // Cache timestamp kontrolÃ¼ - 5 dakikadan eski ise yenile
          const lastUpdate = localStorage.getItem('lastGithubUpdate');
          const now = Date.now();
          const fiveMinutes = 5 * 60 * 1000;
          
          if (!lastUpdate || (now - parseInt(lastUpdate)) > fiveMinutes) {
            console.log('â° Cache eski, GitHub\'tan yenileniyor...');
            
            // GitHub token kontrolÃ¼
            const token = document.getElementById('githubToken').value.trim();
            if (!token) {
              console.warn('âš ï¸ GitHub token yok - Manuel eÅŸleÅŸtirme ve yasak kurallarÄ± yÃ¼klenemedi');
              console.log('ğŸ’¡ Ã‡Ã¶zÃ¼m: GitHub token girin veya localStorage\'dan yÃ¼klenecek');
            } else {
              console.log('ğŸ”‘ GitHub token mevcut, veriler yÃ¼kleniyor...');
              
              await manuelEslestirmeleriGitHubYukle(true); // sessiz yÃ¼kleme
              await eslesmemeKurallariniGitHubYukle(true); // sessiz yÃ¼kleme
              await splitKurallariniGitHubYukle(true); // sessiz yÃ¼kleme
              
              console.log('âœ… GitHub data klasÃ¶rÃ¼ verileri yÃ¼klendi:', Object.keys(manuelEslestirmeler).length, 'manuel eÅŸleÅŸtirme,', Object.keys(eslesmemeKurallari).length, 'yasak');
            }
            
            // Token olmasa bile public GitHub dosyalarÄ±nÄ± dene
            if (!token || Object.keys(manuelEslestirmeler).length === 0) {
              console.log('ğŸŒ Public GitHub dosyalarÄ± deneniyor...');
              await loadPublicGitHubData();
            }
            
            // Hasta verilerini de GitHub'dan yÃ¼kle
            await loadHastaDataFromGitHub(true); // sessiz yÃ¼kleme
            
            // Cache timestamp'ini gÃ¼ncelle
            localStorage.setItem('lastGithubUpdate', now.toString());
            
            console.log('âœ… GitHub veriler yÃ¼klendi:', Object.keys(manuelEslestirmeler).length, 'manuel eÅŸleÅŸtirme,', Object.keys(eslesmemeKurallari).length, 'yasak');
          } else {
            console.log('âœ… GitHub cache taze, localStorage kullanÄ±lÄ±yor');
          }
          
        } catch (error) {
          console.warn('âš ï¸ GitHub\'dan veri yÃ¼klenemedi, localStorage kullanÄ±lÄ±yor:', error.message);
        }
      }
      
      console.log('ğŸ“Š YÃ¼klenen veriler:');
      console.log('- Manuel eÅŸleÅŸtirmeler:', Object.keys(manuelEslestirmeler).length, 'adet');
      console.log('- EÅŸleÅŸme yasaklarÄ±:', Object.keys(eslesmemeKurallari).length, 'adet');
    }

    // Public GitHub dosyalarÄ±nÄ± token olmadan yÃ¼kle
    async function loadPublicGitHubData() {
      try {
        console.log('ğŸ“¥ Public manuel eÅŸleÅŸtirmeler yÃ¼kleniyor...');
        const manuelUrl = 'https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli-3/main/data/manuel_eslestirmeler.json';
        
        try {
          const manuelResp = await fetch(manuelUrl);
          if (manuelResp.ok) {
            const manuelData = await manuelResp.json();
            if (manuelData.eslestirmeler) {
              manuelEslestirmeler = manuelData.eslestirmeler;
            } else {
              manuelEslestirmeler = manuelData;
            }
            console.log('âœ… Public manuel eÅŸleÅŸtirmeler yÃ¼klendi:', Object.keys(manuelEslestirmeler).length, 'adet');
          } else {
            console.warn('âš ï¸ Public manuel eÅŸleÅŸtirmeler yÃ¼klenemedi:', manuelResp.status);
          }
        } catch (manuelError) {
          console.warn('âš ï¸ Public manuel eÅŸleÅŸtirme hatasÄ±:', manuelError.message);
        }

        console.log('ğŸ“¥ Public yasak kurallarÄ± yÃ¼kleniyor...');
        const yasakUrl = 'https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli-3/main/data/eslesmeme_kurallari.json';
        
        try {
          const yasakResp = await fetch(yasakUrl);
          if (yasakResp.ok) {
            const yasakData = await yasakResp.json();
            if (yasakData.kurallar) {
              eslesmemeKurallari = yasakData.kurallar;
            } else {
              eslesmemeKurallari = yasakData;
            }
            console.log('âœ… Public yasak kurallarÄ± yÃ¼klendi:', Object.keys(eslesmemeKurallari).length, 'adet');
          } else {
            console.warn('âš ï¸ Public yasak kurallarÄ± yÃ¼klenemedi:', yasakResp.status);
          }
        } catch (yasakError) {
          console.warn('âš ï¸ Public yasak kuralÄ± hatasÄ±:', yasakError.message);
        }

        // Split kurallarÄ± (public)
        try {
          console.log('ğŸ“¥ Public split kurallarÄ± yÃ¼kleniyor...');
          const splitUrl = 'https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli-3/main/data/split_kurallari.json';
          const splitResp = await fetch(splitUrl);
          if (splitResp.ok) {
            const splitData = await splitResp.json();
            if (splitData.kurallar) {
              splitKurallari = splitData.kurallar;
            } else {
              splitKurallari = splitData;
            }
            localStorage.setItem(SPLIT_KURALLARI_KEY, JSON.stringify(splitKurallari));
            console.log('âœ… Public split kurallarÄ± yÃ¼klendi:', Object.keys(splitKurallari).length, 'adet');
          } else {
            console.warn('âš ï¸ Public split kurallarÄ± yÃ¼klenemedi:', splitResp.status);
          }
        } catch (splitError) {
          console.warn('âš ï¸ Public split kuralÄ± hatasÄ±:', splitError.message);
        }

        // UI'yi gÃ¼ncelle
        if (typeof manuelEslestirmeListesiniGoster === 'function') {
          manuelEslestirmeListesiniGoster();
        }
        if (typeof eslesmemeKurallariniGoster === 'function') {
          eslesmemeKurallariniGoster();
        }

      } catch (error) {
        console.error('âŒ Public GitHub data yÃ¼kleme hatasÄ±:', error);
      }
    }

    // GitHub'dan hasta verilerini yÃ¼kle (YENÄ° SÄ°STEM)
    async function loadHastaDataFromGitHub(sessiz = false) {
      const durumElement = document.getElementById('githubDurumu');
      const token = document.getElementById('githubToken').value.trim();
      
      if (!token) {
        if (!sessiz) console.log('â„¹ï¸ GitHub token girilmedi, offline modda Ã§alÄ±ÅŸÄ±yor');
        if (durumElement) durumElement.innerHTML = 'â„¹ï¸ Offline Mod - GitHub token girilmedi';
        return;
      }
      
      try {
        if (!sessiz) console.log('ğŸ“¥ GitHub\'dan hasta listesi yÃ¼kleniyor (Yeni Sistem)...');
        if (durumElement) durumElement.innerHTML = 'ğŸ”„ GitHub\'dan hasta listesi yÃ¼kleniyor...';
        
        // Hasta listesini yÃ¼kle ve sonucu al
        const yuklenmisList = await hastaListesiYukle();
        
        if (yuklenmisList.length > 0) {
          console.log('âœ… GitHub\'dan hasta listesi yÃ¼klendi:', yuklenmisList.length, 'hasta');
          
          // Hastalar listesini yeni sistemden render et
          await renderHastalarYeniSistem();
          
          if (durumElement) {
            durumElement.innerHTML = `âœ… GitHub'dan yÃ¼klendi (${yuklenmisList.length} hasta - Yeni Sistem)`;
          }
          
          // Alert kaldÄ±rÄ±ldÄ± - sadece console'da bilgi veriliyor
        } else {
          console.log('âš ï¸ Hasta listesi boÅŸ');
          if (durumElement) durumElement.innerHTML = 'âš ï¸ Hasta listesi boÅŸ - Yeni hastalar ekleyebilirsiniz';
          
          // Alert kaldÄ±rÄ±ldÄ± - sadece console'da bilgi veriliyor
        }
      } catch (error) {
        if (!sessiz) console.warn('âš ï¸ GitHub\'dan hasta verileri yÃ¼klenemedi:', error.message);
        if (durumElement) durumElement.innerHTML = 'âŒ GitHub baÄŸlantÄ± hatasÄ±: ' + error.message;
      }
    }

    // GitHub token test fonksiyonu
    async function testGitHubToken() {
      const token = document.getElementById('githubToken').value.trim();
      if (!token) {
        alert('âŒ GitHub token girilmedi!');
        return false;
      }
      
      try {
        console.log('ğŸ” GitHub token test ediliyor...');
        
        const userResponse = await fetch('https://api.github.com/user', {
          headers: { 'Authorization': `token ${token}` }
        });
        
        if (!userResponse.ok) {
          alert(`âŒ GitHub token geÃ§ersiz!\nHata: ${userResponse.status}`);
          return false;
        }
        
        const user = await userResponse.json();
        console.log('âœ… GitHub kullanÄ±cÄ± bilgileri alÄ±ndÄ±:', user.login);
        
        alert(`âœ… GitHub token geÃ§erli!\n\nğŸ‘¤ KullanÄ±cÄ±: ${user.login}`);
        return true;
        
      } catch (error) {
        console.error('âŒ GitHub token test hatasÄ±:', error);
        alert('âŒ GitHub baÄŸlantÄ± hatasÄ±: ' + error.message);
        return false;
      }
    }

    // === YENÄ° SÄ°STEM: HASTA LÄ°STESÄ° YÃ–NETÄ°MÄ° ===
    
    // Hasta listesini GitHub'dan yÃ¼kle
    async function hastaListesiYukle() {
      try {
        const token = document.getElementById('githubToken').value.trim();
        if (!token) {
          console.log('â„¹ï¸ GitHub token yok, offline modda Ã§alÄ±ÅŸÄ±yor');
          return [];
        }
        
        const owner = 'mustafasacar35';
        const repo = 'lipodem-takip-paneli-3';
        const response = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/patients/hastalar_listesi.json`, {
          headers: { 'Authorization': `token ${token}` }
        });
        
        if (response.ok) {
          const data = await response.json();
          
          // Base64'Ã¼ UTF-8 olarak decode et (TÃ¼rkÃ§e karakterler iÃ§in)
          const contentStr = decodeBase64UTF8(data.content).trim();
          
          // BoÅŸ dosya kontrolÃ¼
          if (!contentStr || contentStr === '' || contentStr === '{}' || contentStr === 'null') {
            console.log('ğŸ“ Hasta listesi dosyasÄ± boÅŸ, yeni liste oluÅŸturulacak');
            hastaListesi = []; // Global deÄŸiÅŸkeni sÄ±fÄ±rla
            return [];
          }
          
          try {
            const content = JSON.parse(contentStr);
            if (Array.isArray(content)) {
              console.log('âœ… Hasta listesi GitHub\'dan yÃ¼klendi:', content.length, 'hasta');
              hastaListesi = content; // Global deÄŸiÅŸkeni gÃ¼ncelle
              return content;
            } else {
              console.log('âš ï¸ Hasta listesi array deÄŸil, yeni liste oluÅŸturulacak');
              hastaListesi = []; // Global deÄŸiÅŸkeni sÄ±fÄ±rla
              return [];
            }
          } catch (parseError) {
            console.error('âŒ JSON parse hatasÄ±:', parseError);
            console.log('ğŸ“ Bozuk JSON, yeni liste oluÅŸturulacak');
            hastaListesi = []; // Global deÄŸiÅŸkeni sÄ±fÄ±rla
            return [];
          }
        } else if (response.status === 404) {
          console.log('ğŸ“ Hasta listesi bulunamadÄ±, yeni liste oluÅŸturulacak');
          hastaListesi = []; // Global deÄŸiÅŸkeni sÄ±fÄ±rla
          return [];
        } else {
          throw new Error(`GitHub API hatasÄ±: ${response.status}`);
        }
      } catch (error) {
        console.error('âŒ Hasta listesi yÃ¼kleme hatasÄ±:', error);
        throw error;
      }
    }
    
    // Hasta listesini GitHub'a kaydet
    async function hastaListesiKaydet(hastaListesi) {
      const token = document.getElementById('githubToken').value.trim();
      if (!token) {
        console.warn('â„¹ï¸ GitHub token yok, offline modda Ã§alÄ±ÅŸÄ±yor');
        return false;
      }
      
      try {
        const owner = 'mustafasacar35';
        const repo = 'lipodem-takip-paneli-3';
        const branch = 'main';
        
        // UTF-8 iÃ§in doÄŸru encoding
        const content = encodeUTF8ToBase64(hastaListesi);
        
        // Ã–nce mevcut dosyanÄ±n SHA'sÄ±nÄ± al
        let sha = undefined;
        try {
          const checkResponse = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/patients/hastalar_listesi.json`, {
            headers: { 'Authorization': `token ${token}` }
          });
          if (checkResponse.ok) {
            const data = await checkResponse.json();
            sha = data.sha;
          }
        } catch (e) {}
        
        let response = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/patients/hastalar_listesi.json`, {
          method: 'PUT',
          headers: {
            'Authorization': `token ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            message: `Hasta listesi gÃ¼ncellendi: ${hastaListesi.length} hasta`,
            content: content,
            sha: sha,
            branch
          })
        });
        
        if (response.status === 409) {
          console.warn('âš ï¸ 409 Conflict: hasta listesi kaydÄ± iÃ§in yeniden deneniyor...');
          // KÄ±sa bekleme ve SHA yenile
          await new Promise(r => setTimeout(r, 1200));
          try {
            const checkResponse2 = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/patients/hastalar_listesi.json`, {
              headers: { 'Authorization': `token ${token}` }
            });
            if (checkResponse2.ok) {
              const data2 = await checkResponse2.json();
              sha = data2.sha;
            }
          } catch (_) {}
          response = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/patients/hastalar_listesi.json`, {
            method: 'PUT',
            headers: {
              'Authorization': `token ${token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              message: `Hasta listesi gÃ¼ncellendi: ${hastaListesi.length} hasta (retry)`,
              content,
              sha,
              branch
            })
          });
        }

        if (response.ok) {
          console.log('âœ… Hasta listesi GitHub\'a kaydedildi');
          return true;
        } else {
          throw new Error(`GitHub API hatasÄ±: ${response.status}`);
        }
      } catch (error) {
        console.error('âŒ Hasta listesi kaydetme hatasÄ±:', error);
        return false;
      }
    }
    
    // Hasta listesinden hasta kaldÄ±r
    async function hastaListesindenKaldir(hastaId) {
      try {
        const mevcutListe = await hastaListesiYukle();
        
        // Hasta ID'sine gÃ¶re filtrele
        const yeniListe = mevcutListe.filter(hasta => hasta.id !== hastaId);
        
        console.log(`ğŸ—‘ï¸ Hasta listesinden kaldÄ±rÄ±lÄ±yor: ID=${hastaId}`);
        console.log(`ğŸ“Š Liste boyutu: ${mevcutListe.length} â†’ ${yeniListe.length}`);
        
        // GÃ¼ncellenmiÅŸ listeyi kaydet
        const sonuc = await hastaListesiKaydet(yeniListe);
        if (sonuc) {
          console.log('âœ… Hasta listesinden baÅŸarÄ±yla kaldÄ±rÄ±ldÄ±');
          return true;
        } else {
          throw new Error('Hasta listesi gÃ¼ncellenemedi');
        }
      } catch (error) {
        console.error('âŒ Hasta listesinden kaldÄ±rma hatasÄ±:', error);
        return false;
      }
    }
    
    // Hasta listesine yeni hasta ekle
    async function hastaListesineEkle(hasta) {
      const mevcutListe = await hastaListesiYukle();
      
      // Hasta objesi veya string kontrolÃ¼
      let hastaIsim, hastaId, hastaNot, hastaArsiv;
      
      if (typeof hasta === 'string') {
        // String olarak geÃ§irildiyse (eski kullanÄ±m)
        hastaIsim = hasta;
        hastaId = generatePatientId(hastaIsim);
        hastaNot = '';
        hastaArsiv = false;
      } else {
        // Obje olarak geÃ§irildiyse
        hastaIsim = hasta.isim || hasta.ad || hasta.name;
        hastaId = hasta.id || generatePatientId(hastaIsim);
        hastaNot = hasta.not || hasta.notes || '';
        hastaArsiv = hasta.arsiv || hasta.archived || false;
      }
      
      if (!hastaIsim) {
        console.error('âŒ Hasta ismi bulunamadÄ±:', hasta);
        return false;
      }
      
      // Hasta zaten var mÄ± kontrol et
      const mevcutIndex = mevcutListe.findIndex(h => h.id === hastaId || h.isim === hastaIsim);
      
      if (mevcutIndex !== -1) {
        // Mevcut hastayÄ± gÃ¼ncelle
        mevcutListe[mevcutIndex] = {
          id: hastaId,
          isim: hastaIsim,
          not: hastaNot,
          arsiv: hastaArsiv,
          sonGuncelleme: new Date().toISOString()
        };
        console.log('ğŸ“ Mevcut hasta gÃ¼ncellendi:', hastaIsim);
      } else {
        // Yeni hasta ekle
        mevcutListe.push({
          id: hastaId,
          isim: hastaIsim,
          not: hastaNot,
          arsiv: hastaArsiv,
          olusturma: new Date().toISOString(),
          sonGuncelleme: new Date().toISOString()
        });
        console.log('â• Yeni hasta eklendi:', hastaIsim);
      }
      
      // Listeyi sÄ±rala (arsiv olmayanlar Ã¶nce, sonra alfabetik)
      mevcutListe.sort((a, b) => {
        if (a.arsiv !== b.arsiv) return a.arsiv ? 1 : -1;
        return a.isim.localeCompare(b.isim, 'tr');
      });
      
      await hastaListesiKaydet(mevcutListe);
      return mevcutListe;
    }

    // === YENÄ° SÄ°STEM: PDF YÃ–NETÄ°MÄ° ===
    
    // PDF'i GitHub'a yÃ¼kleme fonksiyonu
    async function pdfYukleGithub(file, hastaId, haftaNo) {
      const token = document.getElementById('githubToken').value.trim();
      if (!token) {
        alert('GitHub token gerekli!');
        return null;
      }
      
      try {
        console.log('ğŸ“¤ PDF GitHub\'a yÃ¼kleniyor:', file.name);
        
        const owner = 'mustafasacar35';
        const repo = 'lipodem-takip-paneli-3';
        
        // GÃ¼venli dosya adÄ± oluÅŸtur (sadece problemli karakterleri temizle)
        const guvenliDosyaAdi = file.name
          .replace(/[\/\\*?"<>|:]/g, '_')  // Sadece gerÃ§ekten problemli olanlarÄ±
          .replace(/\s+/g, ' ')            // Ã‡oklu boÅŸluklarÄ± tek yap
          .trim();
        
        const dosyaYolu = `pdfs/${guvenliDosyaAdi}`;
        
        // DosyayÄ± base64'e Ã§evir
        const base64Data = await new Promise((resolve) => {
          const reader = new FileReader();
          reader.onload = () => {
            const base64 = reader.result.split(',')[1];
            resolve(base64);
          };
          reader.readAsDataURL(file);
        });
        
        // Ã–nce dosyanÄ±n var olup olmadÄ±ÄŸÄ±nÄ± kontrol et
        let sha = undefined;
        try {
          const checkResponse = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${dosyaYolu}`, {
            headers: { 'Authorization': `token ${token}` }
          });
          if (checkResponse.ok) {
            const data = await checkResponse.json();
            sha = data.sha;
            console.log('âš ï¸ AynÄ± isimde PDF bulundu, Ã¼zerine yazÄ±lacak');
          }
        } catch (e) {
          console.log('âœ… Yeni PDF dosyasÄ±');
        }
        
        // PDF'i GitHub'a yÃ¼kle
        const response = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${dosyaYolu}`, {
          method: 'PUT',
          headers: {
            'Authorization': `token ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            message: `PDF yÃ¼klendi: ${file.name} (Hasta ID: ${hastaId}, Hafta: ${haftaNo})`,
            content: base64Data,
            sha: sha
          })
        });
        
        if (response.ok) {
          const result = await response.json();
          console.log('âœ… PDF baÅŸarÄ±yla yÃ¼klendi:', dosyaYolu);
          
          return {
            dosyaYolu: dosyaYolu,
            orijinalAd: file.name,
            guvenliAd: guvenliDosyaAdi,
            githubUrl: `https://github.com/${owner}/${repo}/blob/main/${dosyaYolu}`,
            indirmeUrl: `https://raw.githubusercontent.com/${owner}/${repo}/main/${dosyaYolu}`,
            sha: result.content.sha
          };
        } else {
          throw new Error(`GitHub API hatasÄ±: ${response.status}`);
        }
        
      } catch (error) {
        console.error('âŒ PDF yÃ¼kleme hatasÄ±:', error);
        alert(`PDF yÃ¼klenemedi: ${error.message}`);
        return null;
      }
    }

    // === YENÄ° SÄ°STEM: HER HASTA Ä°Ã‡Ä°N AYRI JSON DOSYASI ===
    
    // Dosya adÄ± oluÅŸturma fonksiyonu
    function generateFileName(hasta) {
      if (!hasta || !hasta.isim) {
        console.error('âŒ generateFileName: GeÃ§ersiz hasta objesi', hasta);
        return 'hasta_gecersiz.json';
      }
      
      const temizIsim = hasta.isim
        .toLowerCase()
        .replace(/Ã§/g, 'c').replace(/ÄŸ/g, 'g').replace(/ÅŸ/g, 's')
        .replace(/Ã¼/g, 'u').replace(/Ã¶/g, 'o').replace(/Ä±/g, 'i')
        .replace(/[^a-z0-9]/g, '_')
        .replace(/_+/g, '_')
        .replace(/^_|_$/g, '');
        
      // ID yoksa isimden oluÅŸtur
      const hastaId = hasta.id || temizIsim;
      
      return `hasta_${hastaId}_${temizIsim}.json`;
    }
    
    function generatePatientId(isim) {
      if (!isim) return 'hasta_gecersiz';
      
      return isim
        .toLowerCase()
        .replace(/Ã§/g, 'c').replace(/ÄŸ/g, 'g').replace(/ÅŸ/g, 's')
        .replace(/Ã¼/g, 'u').replace(/Ã¶/g, 'o').replace(/Ä±/g, 'i')
        .replace(/[^a-z0-9]/g, '_')
        .replace(/_+/g, '_')
        .replace(/^_|_$/g, '');
    }
    
    // Patients klasÃ¶rÃ¼nÃ¼ oluÅŸturma
    async function createPatientsFolder() {
      const token = document.getElementById('githubToken').value.trim();
      if (!token) return;
      
      try {
        const owner = 'mustafasacar35';
        const repo = 'lipodem-takip-paneli-3';
        
        // README.md dosyasÄ± ile klasÃ¶r oluÅŸtur
        const content = btoa(`# Hasta DosyalarÄ±

Bu klasÃ¶rde her hastanÄ±n ayrÄ± JSON dosyasÄ± bulunur.

## Dosya AdlandÄ±rma
- Formato: hasta_[ID]_[ISIM].json
- Ã–rnek: hasta_1_ayse_yilmaz.json

## Dosya YapÄ±sÄ±
Her hasta dosyasÄ± ÅŸu bilgileri iÃ§erir:
- Hasta bilgileri (id, isim, not)
- Hafta takip bilgileri
- PDF dosyalarÄ± (base64)
- EÅŸleÅŸtirme kartlarÄ±
- GPT mesajlarÄ±

## ArÅŸivleme
KullanÄ±cÄ± 13+ hafta olan hastalarÄ± manuel olarak arÅŸivler.
`);
        
        await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/patients/README.md`, {
          method: 'PUT',
          headers: {
            'Authorization': `token ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            message: 'Patients klasÃ¶rÃ¼ oluÅŸturuldu',
            content: content
          })
        });
        
        console.log('âœ… Patients klasÃ¶rÃ¼ oluÅŸturuldu');
        
      } catch (error) {
        console.warn('Patients klasÃ¶rÃ¼ oluÅŸturma hatasÄ±:', error);
      }
    }
    
    // Tek hasta kaydetme fonksiyonu
    async function hastayiAyriKaydet(hasta) {
      // GÃ¼venlik kontrolÃ¼
      if (!hasta || !hasta.isim) {
        alert('âŒ GeÃ§ersiz hasta verisi! LÃ¼tfen Ã¶nce bir hasta seÃ§in.');
        return false;
      }
      
      const token = document.getElementById('githubToken').value.trim();
      if (!token) {
        alert('âŒ GitHub token gerekli! LÃ¼tfen GitHub token girin.');
        return false;
      }
      
      try {
        console.log(`ğŸ’¾ ${hasta.isim} hastasÄ± kaydediliyor...`);
        
        const owner = 'mustafasacar35';
        const repo = 'lipodem-takip-paneli-3';
        const branch = 'main';
        
        // Son gÃ¼ncelleme tarihini ekle
        hasta.sonGuncelleme = new Date().toISOString();
        hasta.githubKaydedildi = true;
        
        const fileName = generateFileName(hasta);
        
        // Hasta verilerini kaydetmeden Ã¶nce hafta verilerinde GitHub linklerini gÃ¼ncelle
        if (hasta.haftalar && hasta.haftalar.length > 0) {
          hasta.haftalar.forEach(hafta => {
            if (hafta.pdf) { // PDF varsa link oluÅŸtur
              hafta.githubLink = `https://github.com/${owner}/${repo}/blob/${branch}/patients/${fileName}`;
              hafta.githubRawLink = `https://raw.githubusercontent.com/${owner}/${repo}/${branch}/patients/${fileName}`;
            }
          });
        }
        
        // UTF-8 iÃ§in doÄŸru encoding
        const content = encodeUTF8ToBase64(hasta);
        
        // Ã–nce dosyanÄ±n SHA'sÄ±nÄ± kontrol et
        let sha = undefined;
        try {
          const checkResponse = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/patients/${fileName}`, {
            headers: { 'Authorization': `token ${token}` }
          });
          if (checkResponse.ok) {
            const data = await checkResponse.json();
            sha = data.sha;
          }
        } catch (e) {}
        
        // DosyayÄ± kaydet
        const response = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/patients/${fileName}`, {
          method: 'PUT',
          headers: {
            'Authorization': `token ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            message: `Hasta kaydÄ± gÃ¼ncellendi: ${hasta.isim}`,
            content: content,
            sha: sha
          })
        });
        
        if (response.ok) {
          console.log(`âœ… ${hasta.isim} ayrÄ± dosya olarak kaydedildi`);
          
          // Hasta listesine de ekle/gÃ¼ncelle
          await hastaListesineEkle(hasta);
          
          return true;
        } else {
          throw new Error(`GitHub API hatasÄ±: ${response.status}`);
        }
        
      } catch (error) {
        console.error(`âŒ ${hasta.isim} kaydetme hatasÄ±:`, error);
        return false;
      }
    }
    
    // TÃ¼m hastalarÄ± ayrÄ± dosyalar halinde kaydetme
    async function tumHastalariAyriKaydet() {
      const token = document.getElementById('githubToken').value.trim();
      if (!token) {
        alert('GitHub token gerekli!');
        return;
      }
      
      if (!confirm('TÃ¼m hastalarÄ± ayrÄ± JSON dosyalarÄ± halinde kaydetmek istediÄŸinize emin misiniz?\n\nBu yeni sisteme geÃ§iÅŸ iÅŸlemidir.')) {
        return;
      }
      
      console.log('ğŸš€ Yeni sistem baÅŸlatÄ±lÄ±yor: Her hasta iÃ§in ayrÄ± JSON dosyasÄ±...');
      
      // Ã–nce patients klasÃ¶rÃ¼nÃ¼ oluÅŸtur
      await createPatientsFolder();
      
      let basarili = 0;
      let hatali = 0;
      
      const durum = document.getElementById('githubDurumu');
      if (durum) durum.innerHTML = 'ğŸ’¾ Yeni sisteme geÃ§iliyor...';
      
      for (const hasta of hastalar) {
        try {
          const sonuc = await hastayiAyriKaydet(hasta);
          if (sonuc) {
            basarili++;
          } else {
            hatali++;
          }
          
          // Rate limiting iÃ§in bekleme
          await new Promise(resolve => setTimeout(resolve, 500));
          
          // Ä°lerleme gÃ¶ster
          if (durum) {
            durum.innerHTML = `ğŸ’¾ Ä°ÅŸleniyor: ${basarili + hatali}/${hastalar.length} hasta`;
          }
          
        } catch (error) {
          console.error(`${hasta.isim} kaydedilemedi:`, error);
          hatali++;
        }
      }
      
      if (durum) {
        durum.innerHTML = `âœ… Yeni sistem tamamlandÄ±: ${basarili} baÅŸarÄ±lÄ±, ${hatali} hatalÄ±`;
      }
      
      alert(`ğŸ‰ Yeni sisteme geÃ§iÅŸ tamamlandÄ±!\n\nâœ… BaÅŸarÄ±lÄ±: ${basarili}\nâŒ HatalÄ±: ${hatali}\n\nArtÄ±k her hasta ayrÄ± JSON dosyasÄ±nda saklanÄ±yor.`);
      
      console.log('ğŸ¯ Yeni sistem bilgileri:');
      console.log('- Her hasta iÃ§in ayrÄ± JSON dosyasÄ± oluÅŸturuldu');
      console.log('- GitHub patients/ klasÃ¶rÃ¼nde saklaniyor');
      console.log('- 13+ hafta olan hastalar listede en altta gÃ¶rÃ¼nÃ¼r');
      console.log('- Manuel arÅŸivleme sistemi aktif');
    }

    async function uploadToGitHub() {
      const token = document.getElementById('githubToken').value.trim();
      if (!token) { 
        alert('âŒ LÃ¼tfen Ã¶nce GitHub API token girin!'); 
        return; 
      }
      
      console.log('  Yeni sisteme gÃ¶re tÃ¼m hastalar kaydediliyor...');
      
      // Yeni sistemi kullan
      await tumHastalariAyriKaydet();
    }

    // --- EÅŸleÅŸme YasaklarÄ± Paneli FonksiyonlarÄ± ---
    const ESLESMEME_KURALLARI_KEY = 'lipedem_eslesmeme_kurallari';
    let eslesmemeKurallari = {};

    async function eslesmemeRegeleriPaneliGoster() {
      // KartlarÄ± yÃ¼kle
      if (tariflerKlasoruGorselleri.length === 0) {
        await tariflerKlasoruGorselleriniYukle();
      }
      
      // Kart listesini doldur
      yasakKartListesiniGoster();
      
      // Arama iÅŸlevi
      document.getElementById('yasakKartArama').oninput = function() {
        yasakKartListesiniGoster(this.value);
      };
      
      // EÅŸleÅŸme yasaklarÄ±nÄ± gÃ¶ster
      eslesmemeListesiniGoster();
      
      document.getElementById('eslesmemePanel').style.display = 'block';
    }

    function eslesmemeRegeleriPaneliGizle() {
      document.getElementById('eslesmemePanel').style.display = 'none';
      document.getElementById('yasakTarifAdi').value = '';
      document.getElementById('yasakKartArama').value = '';
      document.getElementById('eslesmemeStatus').style.display = 'none';
      yasakKartListesiniGoster(''); // Listeyi sÄ±fÄ±rla
    }

    function yasakKartListesiniGoster(aramaMetni = '') {
      const div = document.getElementById('yasakKartListesi');
      div.innerHTML = '';
      
      // Filtreleme
      const filtrelenmisKartlar = tariflerKlasoruGorselleri.filter(kart => {
        if (!aramaMetni) return true;
        return kart.name.toLowerCase().includes(aramaMetni.toLowerCase());
      });
      
      filtrelenmisKartlar.forEach(kart => {
        const label = document.createElement('label');
        label.style.cssText = 'display:block; margin:4px 0; cursor:pointer; padding:2px;';
        label.innerHTML = `
          <input type="checkbox" data-kart="${kart.name}" style="margin-right:8px;" />
          ${kart.name}
        `;
        div.appendChild(label);
      });
    }

    function eslesmemeStatusGoster(mesaj, tip = 'info') {
      const statusDiv = document.getElementById('eslesmemeStatus');
      statusDiv.style.display = 'block';
      statusDiv.innerHTML = mesaj;
      
      if (tip === 'success') {
        statusDiv.style.background = '#d4edda';
        statusDiv.style.color = '#155724';
        statusDiv.style.border = '1px solid #c3e6cb';
      } else if (tip === 'error') {
        statusDiv.style.background = '#f8d7da';
        statusDiv.style.color = '#721c24';
        statusDiv.style.border = '1px solid #f5c6cb';
      } else {
        statusDiv.style.background = '#d1ecf1';
        statusDiv.style.color = '#0c5460';
        statusDiv.style.border = '1px solid #bee5eb';
      }
    }

    function eslesmemeKuraliEkle() {
      const tarifAdi = document.getElementById('yasakTarifAdi').value.trim();
      const checkboxes = document.querySelectorAll('#yasakKartListesi input[type="checkbox"]:checked');
      const secilenKartlar = Array.from(checkboxes).map(cb => cb.getAttribute('data-kart'));
      
      if (!tarifAdi) {
        eslesmemeStatusGoster('Yemek adÄ± boÅŸ olamaz!', 'error');
        return;
      }
      
      if (secilenKartlar.length === 0) {
        eslesmemeStatusGoster('En az bir kart seÃ§melisiniz!', 'error');
        return;
      }
      
      // Normalize et
      function normalizeLocal(str) {
        return str
          .toLowerCase()
          .replace(/Ã§/g, 'c').replace(/ÄŸ/g, 'g').replace(/ÅŸ/g, 's')
          .replace(/Ã¼/g, 'u').replace(/Ã¶/g, 'o').replace(/Ä±/g, 'i')
          .replace(/iÌ‡/g, 'i')
          .replace(/[_*\/()]/g, ' ')
          .replace(/\s+/g, ' ')
          .replace(/[^a-z0-9\s]/g, '')
          .trim();
      }
      
      const normalizeEdilmis = normalizeLocal(tarifAdi);
      
      // Kaydet
      eslesmemeKurallari[normalizeEdilmis] = {
        orijinalMetin: tarifAdi,
        yasakliKartlar: secilenKartlar,
        eklemeTarihi: new Date().toISOString()
      };
      
      eslesmemeKurallariniKaydet();
      eslesmemeListesiniGoster();
      
      eslesmemeStatusGoster(`âœ… Yasak eklendi! "${tarifAdi}" â†’ ${secilenKartlar.length} kart yasaklandÄ±`, 'success');
      
      // Formu temizle
      document.getElementById('yasakTarifAdi').value = '';
      document.querySelectorAll('#yasakKartListesi input[type="checkbox"]').forEach(cb => cb.checked = false);
    }

    function eslesmemeKurallariniKaydet() {
      try {
        localStorage.setItem(ESLESMEME_KURALLARI_KEY, JSON.stringify(eslesmemeKurallari));
        
        // Hemen render'Ä± gÃ¼ncelle - yeni kurallar ile
        console.log('ğŸ”„ EÅŸleÅŸme kurallarÄ± gÃ¼ncellendi, render gÃ¼ncelleniyor...');
        
        // 1. EÅŸleÅŸmeyen tarifler listesini gÃ¼ncelle
        setTimeout(() => {
          eslesmeyenlerListesiniGuncelle();
        }, 300);
        
        // 2. Aktif hafta iÃ§in eÅŸleÅŸen kartlarÄ± yeniden kontrol et
        setTimeout(() => {
          if (typeof window.seciliHasta !== 'undefined' && window.seciliHasta) {
            otomatikEsleHafta();
          }
        }, 800);
        
        // 3. Sidebar'daki kartlarÄ± gÃ¼ncelle
        setTimeout(() => {
          if (typeof window.aktifHaftaIndex !== 'undefined' && window.aktifHaftaIndex !== null) {
            gosterEslesenKartlarSidebar(window.aktifHaftaIndex);
          }
        }, 1200);
        
        // 4. Yemek veritabanÄ± analizini gÃ¼ncelle
        setTimeout(() => {
          updateYemekVeritabaniAnalizi();
        }, 1500);
        
        // Otomatik GitHub kaydÄ± (token varsa)
        const token = document.getElementById('githubToken').value.trim();
        if (token && Object.keys(eslesmemeKurallari).length > 0) {
          // 2 saniye bekle sonra otomatik kaydet
          setTimeout(() => {
            eslesmemeKurallariniGitHubKaydet(true); // true = sessiz kaydetme
          }, 2000);
        }
      } catch(e) {
        console.error('EÅŸleÅŸme yasaklarÄ± kaydetme hatasÄ±:', e);
      }
    }

    function eslesmemeKurallariniYukle() {
      try {
        const data = localStorage.getItem(ESLESMEME_KURALLARI_KEY);
        if (data) {
          eslesmemeKurallari = JSON.parse(data);
        }
      } catch(e) {
        console.error('EÅŸleÅŸme yasaklarÄ± yÃ¼kleme hatasÄ±:', e);
        eslesmemeKurallari = {};
      }
    }

    function eslesmemeKurallariniTemizle() {
      if (!confirm('TÃ¼m eÅŸleÅŸme yasaklarÄ±nÄ± silmek istediÄŸinize emin misiniz?')) return;
      
      eslesmemeKurallari = {};
      eslesmemeKurallariniKaydet();
      eslesmemeListesiniGoster();
      eslesmemeStatusGoster('TÃ¼m eÅŸleÅŸme yasaklarÄ± temizlendi.', 'success');
    }

    function eslesmemeListesiniGoster() {
      const div = document.getElementById('eslesmemeListesi');
      div.innerHTML = '';
      
      const anahtarlar = Object.keys(eslesmemeKurallari);
      if (anahtarlar.length === 0) {
        div.innerHTML = '<em>HenÃ¼z yasak yok</em>';
        return;
      }
      
      anahtarlar.forEach(anahtar => {
        const yasak = eslesmemeKurallari[anahtar];
        const yasakDiv = document.createElement('div');
        yasakDiv.style.cssText = 'border:1px solid #ddd; margin:8px 0; padding:8px; background:#fff; border-radius:4px;';
        yasakDiv.innerHTML = `
          <div style="font-weight:bold; color:#dc3545;">${yasak.orijinalMetin}</div>
          <div style="margin:5px 0; font-size:0.9em;">ğŸš« ${yasak.yasakliKartlar.join(', ')}</div>
          <button onclick="eslesmemeKuraliSil('${anahtar}')" style="background:#dc3545; color:white; border:none; padding:4px 8px; border-radius:3px; font-size:0.8em; cursor:pointer;">Sil</button>
        `;
        div.appendChild(yasakDiv);
      });
    }

    function eslesmemeKuraliSil(anahtar) {
      if (!confirm('Bu yasaÄŸÄ± silmek istediÄŸinize emin misiniz?')) return;
      
      delete eslesmemeKurallari[anahtar];
      eslesmemeKurallariniKaydet();
      eslesmemeListesiniGoster();
      eslesmemeStatusGoster('Yasak silindi.', 'success');
    }

    // --- SatÄ±r BÃ¶lme KurallarÄ± (KalÄ±cÄ±) ---
    const SPLIT_KURALLARI_KEY = 'lipedem_split_kurallari';
    let splitKurallari = {};

    function splitNormalize(str) {
      try {
        return (str || '')
          .toLowerCase()
          .replace(/Ã§/g, 'c').replace(/ÄŸ/g, 'g').replace(/ÅŸ/g, 's')
          .replace(/Ã¼/g, 'u').replace(/Ã¶/g, 'o').replace(/Ä±/g, 'i')
          .replace(/iÌ‡/g, 'i')
          .replace(/[_*\/()]/g, ' ')
          .replace(/\s+/g, ' ')
          .replace(/[^a-z0-9\s]/g, '')
          .trim();
      } catch { return (str || '').toLowerCase().trim(); }
    }

    function splitKurallariniYukle() {
      try {
        const data = localStorage.getItem(SPLIT_KURALLARI_KEY);
        if (data) splitKurallari = JSON.parse(data) || {};
        else splitKurallari = {};
      } catch(e) {
        console.warn('Split kurallarÄ± yÃ¼klenemedi:', e);
        splitKurallari = {};
      }
    }

    function splitKurallariniKaydet(sessiz = true) {
      try {
        localStorage.setItem(SPLIT_KURALLARI_KEY, JSON.stringify(splitKurallari));
        const token = document.getElementById('githubToken').value.trim();
        if (token && Object.keys(splitKurallari).length > 0) {
          // kÄ±sa bir gecikme ile sessiz GitHub kaydÄ±
          setTimeout(() => { splitKurallariniGitHubKaydet(true); }, 1500);
        }
        if (!sessiz) console.log('âœ… Split kurallarÄ± kaydedildi');
      } catch(e) {
        console.error('Split kurallarÄ± kaydedilemedi:', e);
      }
    }

    async function splitKurallariniGitHubKaydet(sessizKaydetme = false) {
      const token = document.getElementById('githubToken').value.trim();
      if (!token) { if (!sessizKaydetme) alert('GitHub API token gerekli!'); return; }

      const owner = 'mustafasacar35';
      const repo = 'lipodem-takip-paneli-3';
      const path = 'data/split_kurallari.json';
      const branch = 'main';

      try {
        // mevcut dosya SHA
        let sha = undefined;
        try {
          const resp = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}?ref=${branch}`, {
            headers: { Authorization: `token ${token}` }
          });
          if (resp.ok) { const data = await resp.json(); sha = data.sha; }
        } catch(e) {}

        const kayitVerisi = { version: '1.0', sonGuncelleme: new Date().toISOString(), kurallar: splitKurallari };
        const content = encodeUTF8ToBase64(kayitVerisi);

        const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, {
          method: 'PUT',
          headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: 'Split kurallarÄ± gÃ¼ncellendi', content, branch, sha })
        });

        if (res.ok) {
          localStorage.setItem('lastGithubUpdate', Date.now().toString());
          if (!sessizKaydetme) console.log('âœ… Split kurallarÄ± GitHub\'a kaydedildi');
        } else {
          throw new Error(await res.text());
        }
      } catch (error) {
        console.error('Split kurallarÄ± GitHub kaydetme hatasÄ±:', error);
        if (!sessizKaydetme) alert('GitHub split kaydetme hatasÄ±: ' + error.message);
      }
    }

    async function splitKurallariniGitHubYukle(sessizYukleme = false) {
      const token = document.getElementById('githubToken').value.trim();
      if (!token) { if (!sessizYukleme) alert('GitHub API token gerekli!'); return; }

      const owner = 'mustafasacar35';
      const repo = 'lipodem-takip-paneli-3';
      const path = 'data/split_kurallari.json';
      const branch = 'main';

      try {
        const resp = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}?ref=${branch}`, {
          headers: { Authorization: `token ${token}` }
        });
        if (resp.ok) {
          const data = await resp.json();
          const jsonContent = decodeBase64UTF8(data.content);
          const parsed = JSON.parse(jsonContent);
          splitKurallari = parsed.kurallar || parsed || {};
          localStorage.setItem(SPLIT_KURALLARI_KEY, JSON.stringify(splitKurallari));
          localStorage.setItem('lastGithubUpdate', Date.now().toString());
          if (!sessizYukleme) console.log('âœ… Split kurallarÄ± GitHub\'dan yÃ¼klendi:', Object.keys(splitKurallari).length);
        } else if (resp.status === 404) {
          if (!sessizYukleme) console.log('â„¹ï¸ GitHub\'da split kurallarÄ± dosyasÄ± bulunamadÄ±');
        } else {
          throw new Error('GitHub\'dan split okuma baÅŸarÄ±sÄ±z: ' + resp.status);
        }
      } catch (error) {
        console.error('Split kurallarÄ± yÃ¼kleme hatasÄ±:', error);
        if (!sessizYukleme) alert('Split kurallarÄ± yÃ¼klenemedi: ' + error.message);
      }
    }

    function splitKuraliEkle(orijinalMetin, ciktiSatirlari) {
      const key = splitNormalize(orijinalMetin);
      if (!key) return null;
      const temizCiktilar = (ciktiSatirlari || []).map(s => (s || '').trim()).filter(Boolean);
      if (temizCiktilar.length === 0) return null;
      splitKurallari[key] = {
        orijinalMetin,
        ciktilar: temizCiktilar,
        eklemeTarihi: new Date().toISOString()
      };
      splitKurallariniKaydet(true);
      return key;
    }

    function applySplitKurallariToList(lines) {
      if (!Array.isArray(lines) || Object.keys(splitKurallari).length === 0) return lines;
      const finalList = [];
      for (const line of lines) {
        const key = splitNormalize(line);
        const kural = splitKurallari[key];
        if (kural && Array.isArray(kural.ciktilar) && kural.ciktilar.length) {
          // Kurala gÃ¶re satÄ±rÄ± bÃ¶l ve ekle (kÃ¼Ã§Ã¼k harfe normalize ederek)
          finalList.push(...kural.ciktilar.map(s => (s || '').trim().toLowerCase()).filter(Boolean));
        } else {
          finalList.push(line);
        }
      }
      return finalList;
    }

    // GitHub entegrasyonu iÃ§in fonksiyonlar
    async function eslesmemeKurallariniGitHubKaydet(sessizKaydetme = false) {
      const token = document.getElementById('githubToken').value.trim();
      if (!token) {
        if (!sessizKaydetme) {
          alert('GitHub API token gerekli!');
        }
        return;
      }

      const owner = 'mustafasacar35';
      const repo = 'lipodem-takip-paneli-3';
      const path = 'data/eslesmeme_kurallari.json';
      const branch = 'main';

      try {
        if (!sessizKaydetme) {
          eslesmemeStatusGoster('GitHub\'a kaydediliyor...', 'info');
        }

        // Ã–nce mevcut dosyanÄ±n SHA'sÄ±nÄ± al
        let sha = undefined;
        try {
          const resp = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}?ref=${branch}`, {
            headers: { Authorization: `token ${token}` }
          });
          if (resp.ok) {
            const data = await resp.json();
            sha = data.sha;
          }
        } catch (e) {}

        // Veriyi hazÄ±rla
        const kayitVerisi = {
          version: '1.0',
          sonGuncelleme: new Date().toISOString(),
          eslesmemeKurallari: eslesmemeKurallari
        };

        // UTF-8 iÃ§in doÄŸru encoding
        const content = encodeUTF8ToBase64(kayitVerisi);

        // DosyayÄ± yÃ¼kle
        const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, {
          method: 'PUT',
          headers: {
            'Authorization': `token ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            message: 'EÅŸleÅŸme yasaklarÄ± gÃ¼ncellendi',
            content,
            branch,
            sha
          })
        });

        if (res.ok) {
          // Cache timestamp'ini gÃ¼ncelle
          localStorage.setItem('lastGithubUpdate', Date.now().toString());
          if (!sessizKaydetme) {
            eslesmemeStatusGoster('âœ… GitHub\'a baÅŸarÄ±yla kaydedildi!', 'success');
          }
        } else {
          throw new Error('GitHub kaydÄ± baÅŸarÄ±sÄ±z: ' + (await res.text()));
        }

      } catch (error) {
        console.error('GitHub kaydetme hatasÄ±:', error);
        if (!sessizKaydetme) {
          eslesmemeStatusGoster(`âŒ GitHub kaydetme hatasÄ±: ${error.message}`, 'error');
        }
      }
    }

    async function eslesmemeKurallariniGitHubYukle(sessizYukleme = false) {
      const token = document.getElementById('githubToken').value.trim();
      if (!token) {
        if (!sessizYukleme) {
          alert('GitHub API token gerekli!');
        }
        return;
      }

      const owner = 'mustafasacar35';
      const repo = 'lipodem-takip-paneli-3';
      const path = 'data/eslesmeme_kurallari.json';
      const branch = 'main';

      try {
        if (!sessizYukleme) {
          eslesmemeStatusGoster('GitHub\'dan yÃ¼kleniyor...', 'info');
        }

        const resp = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}?ref=${branch}`, {
          headers: { Authorization: `token ${token}` }
        });

        if (resp.ok) {
          const data = await resp.json();
          const jsonContent = decodeBase64UTF8(data.content);
          const kayitVerisi = JSON.parse(jsonContent);
          
          // Eski format kontrolÃ¼
          if (kayitVerisi.eslesmemeKurallari) {
            eslesmemeKurallari = kayitVerisi.eslesmemeKurallari;
          } else {
            // Eski format (direkt object)
            eslesmemeKurallari = kayitVerisi;
          }
          
          // LocalStorage'a da kaydet
          localStorage.setItem(ESLESMEME_KURALLARI_KEY, JSON.stringify(eslesmemeKurallari));
          
          // Cache timestamp'ini gÃ¼ncelle
          localStorage.setItem('lastGithubUpdate', Date.now().toString());
          
          // Listeyi gÃ¼ncelle (eÄŸer panel aÃ§Ä±ksa)
          if (document.getElementById('eslesmemePanel').style.display !== 'none') {
            eslesmemeListesiniGoster();
          }

          if (!sessizYukleme) {
            const kuralSayisi = Object.keys(eslesmemeKurallari).length;
            eslesmemeStatusGoster(`âœ… GitHub'dan ${kuralSayisi} yasak yÃ¼klendi!`, 'success');
          } else {
            const kuralSayisi = Object.keys(eslesmemeKurallari).length;
            console.log(`EÅŸleÅŸme yasaklarÄ± GitHub'dan gÃ¼ncellendi: ${kuralSayisi} adet`);
          }

        } else if (resp.status === 404) {
          // Dosya henÃ¼z yok, normal
          if (!sessizYukleme) {
            eslesmemeStatusGoster('â„¹ï¸ GitHub\'da henÃ¼z yasak dosyasÄ± yok', 'info');
          }
        } else {
          throw new Error('GitHub\'dan okuma baÅŸarÄ±sÄ±z: ' + resp.status);
        }

      } catch (error) {
        console.error('GitHub yÃ¼kleme hatasÄ±:', error);
        if (!sessizYukleme) {
          eslesmemeStatusGoster(`âŒ GitHub yÃ¼kleme hatasÄ±: ${error.message}`, 'error');
        }
      }
    }

    // --- Manuel EÅŸleÅŸtirme Paneli FonksiyonlarÄ± ---
    const MANUEL_ESLESTIRME_KEY = 'lipedem_manuel_eslestirmeler';
    let manuelEslestirmeler = {};

    // Global karakter dÃ¼zeltme fonksiyonu
    function karakterDuzelt(text) {
      if (!text) return text;
      return text
        .replace(/Ã„Â±/g, 'Ä±')
        .replace(/Ã„/g, 'ÄŸ') 
        .replace(/Ã…/g, 'ÅŸ')
        .replace(/Ä/g, 'ÄŸ')
        .replace(/ÃƒÂ¼/g, 'Ã¼')
        .replace(/ÃƒÂ¶/g, 'Ã¶')
        .replace(/ÃƒÂ§/g, 'Ã§')
        .replace(/Ã¢/g, 'a')
        .replace(/Ã®/g, 'i')
        .replace(/Ã»/g, 'u')
        .replace(/Ã´/g, 'o');
    }

    // Normalize fonksiyonu - Manuel eÅŸleÅŸtirme iÃ§in
    function normalize(str) {
      return str
        .toLowerCase()
        .replace(/Ã§/g, 'c').replace(/ÄŸ/g, 'g').replace(/ÅŸ/g, 's')
        .replace(/Ã¼/g, 'u').replace(/Ã¶/g, 'o').replace(/Ä±/g, 'i')
        .replace(/iÌ‡/g, 'i')
        .replace(/[_*\/()]/g, ' ')  // Sembolleri boÅŸlukla deÄŸiÅŸtir
        .replace(/\s+/g, ' ')       // Ã‡oklu boÅŸluklarÄ± tek boÅŸluÄŸa Ã§evir
        .replace(/[^a-z0-9\s]/g, '') // Sadece harf, rakam ve boÅŸluk bÄ±rak
        .trim();
    }

    function manuelEslestirmeleriYukle() {
      try {
        const data = localStorage.getItem(MANUEL_ESLESTIRME_KEY);
        if (data) {
          manuelEslestirmeler = JSON.parse(data);
        }
      } catch(e) {
        console.error('Manuel eÅŸleÅŸtirme yÃ¼kleme hatasÄ±:', e);
        manuelEslestirmeler = {};
      }
    }

    // Kaydetme throttle deÄŸiÅŸkenleri
    let kaydetmeZamanlayicisi = null;
    let gitHubKaydetmeDevamEdiyor = false;
    let sonKaydetmeZamani = 0;

    function manuelEslestirmeleriKaydet() {
      try {
        localStorage.setItem(MANUEL_ESLESTIRME_KEY, JSON.stringify(manuelEslestirmeler));
        console.log('ğŸ“ Manuel eÅŸleÅŸtirmeler localStorage\'a kaydedildi');
        
        // Hemen render'Ä± gÃ¼ncelle - yeni eÅŸleÅŸtirmeler ile
        console.log('ğŸ”„ Manuel eÅŸleÅŸtirme kaydedildi, render gÃ¼ncelleniyor...');
        
        // 1. EÅŸleÅŸmeyen tarifler listesini gÃ¼ncelle
        setTimeout(() => {
          eslesmeyenlerListesiniGuncelle();
        }, 300);
        
        // 2. Aktif hafta iÃ§in eÅŸleÅŸen kartlarÄ± yeniden kontrol et
        setTimeout(() => {
          if (typeof window.seciliHasta !== 'undefined' && window.seciliHasta) {
            otomatikEsleHafta();
          }
        }, 800);
        
        // 3. Sidebar'daki kartlarÄ± gÃ¼ncelle
        setTimeout(() => {
          if (typeof window.aktifHaftaIndex !== 'undefined' && window.aktifHaftaIndex !== null) {
            gosterEslesenKartlarSidebar(window.aktifHaftaIndex);
          }
        }, 1200);
        
        // 4. Yemek veritabanÄ± analizini gÃ¼ncelle
        setTimeout(() => {
          updateYemekVeritabaniAnalizi();
        }, 1500);
        
        // Otomatik GitHub kaydÄ± (token varsa)
        const token = document.getElementById('githubToken').value.trim();
        if (token && Object.keys(manuelEslestirmeler).length > 0) {
          const simdikiZaman = Date.now();
          const sonKaydetmedenGecenZaman = simdikiZaman - sonKaydetmeZamani;
          
          // Mevcut zamanlayÄ±cÄ±yÄ± iptal et
          if (kaydetmeZamanlayicisi) {
            clearTimeout(kaydetmeZamanlayicisi);
            console.log('ğŸ”„ Ã–nceki kaydetme zamanlayÄ±cÄ±sÄ± iptal edildi');
          }
          
          // EÄŸer son kaydetmeden 10 saniye geÃ§memiÅŸse, daha fazla bekle
          const beklemeZamani = sonKaydetmedenGecenZaman < 10000 ? 5000 : 3000;
          
          // Yeni zamanlayÄ±cÄ± baÅŸlat
          kaydetmeZamanlayicisi = setTimeout(async () => {
            if (!gitHubKaydetmeDevamEdiyor) {
              console.log(`â° ZamanlayÄ±cÄ± tetiklendi (${beklemeZamani}ms bekledikten sonra), GitHub\'a kaydediliyor...`);
              sonKaydetmeZamani = Date.now();
              await manuelEslestirmeleriGitHubKaydet(true); // true = sessiz kaydetme
            } else {
              console.log('âš ï¸ GitHub kaydetme devam ediyor, atlandÄ±');
            }
            kaydetmeZamanlayicisi = null;
          }, beklemeZamani);
          
          console.log(`â° GitHub kaydetme ${beklemeZamani}ms sonra yapÄ±lacak`);
        }
      } catch(e) {
        console.error('Manuel eÅŸleÅŸtirme kaydetme hatasÄ±:', e);
      }
    }

    async function manuelEslestirmePaneliGoster() {
      // KartlarÄ± yÃ¼kle
      if (tariflerKlasoruGorselleri.length === 0) {
        await tariflerKlasoruGorselleriniYukle();
      }
      
      // Kart listesini doldur
      manuelKartListesiniGoster();
      
      // Arama iÅŸlevi
      document.getElementById('manuelKartArama').oninput = function() {
        manuelKartListesiniGoster(this.value);
      };
      
      // Manuel eÅŸleÅŸtirmeleri gÃ¶ster (zaten yÃ¼klÃ¼ olmalÄ±)
      manuelEslestirmeListesiniGoster();
      
      document.getElementById('manuelEslestirmePanel').style.display = 'block';
    }

    // EÅŸleÅŸmeyen tariften direkt manuel eÅŸleÅŸtirme
    async function eslesmeyenTarifManuelEslestir(tarifAdi) {
      console.log('ğŸ”— EÅŸleÅŸmeyen tarif iÃ§in manuel eÅŸleÅŸtirme baÅŸlatÄ±lÄ±yor:', tarifAdi);
      
      // Manuel eÅŸleÅŸtirme panelini gÃ¶ster
      await manuelEslestirmePaneliGoster();
      
      // Sol kutucuÄŸa tarif adÄ±nÄ± doldur
      const yeniTarifInput = document.getElementById('manuelTarifAdi');
      if (yeniTarifInput) {
        yeniTarifInput.value = tarifAdi;
        yeniTarifInput.focus();
      }
      
      // SaÄŸ tarafta arama kutucuÄŸunu temizle (kullanÄ±cÄ± arayacak)
      const kartAramaInput = document.getElementById('eskiKartArama');
      if (kartAramaInput) {
        kartAramaInput.value = '';
        kartAramaInput.placeholder = `"${tarifAdi}" iÃ§in eÅŸleÅŸecek kartÄ± ara...`;
      }
      
      // KullanÄ±cÄ±ya bilgilendirme
      const statusDiv = document.getElementById('manuelEslestirmeStatus');
      if (statusDiv) {
        statusDiv.style.display = 'block';
        statusDiv.style.background = '#d1ecf1';
        statusDiv.style.color = '#0c5460';
        statusDiv.style.border = '1px solid #bee5eb';
        statusDiv.innerHTML = `
          <strong>ğŸ¯ EÅŸleÅŸmeyen Tarif SeÃ§ildi:</strong> "${tarifAdi}"<br>
          <small>SaÄŸdaki arama kutusundan uygun kartÄ± bulup eÅŸleÅŸtirin. EÅŸleÅŸtirme sonrasÄ± bu tarif "EÅŸleÅŸmeyenler" listesinden kaldÄ±rÄ±lacak.</small>
        `;
      }
    }

    // EÅŸleÅŸen tariften direkt manuel eÅŸleÅŸtirme (dÃ¼zenleme iÃ§in)
    async function eslesenTarifManuelEslestir(tarifAdi, eslesenKartlar) {
      console.log('ğŸ”§ EÅŸleÅŸen tarif iÃ§in manuel eÅŸleÅŸtirme dÃ¼zenleme baÅŸlatÄ±lÄ±yor:', tarifAdi, eslesenKartlar);
      
      // Manuel eÅŸleÅŸtirme panelini gÃ¶ster
      await manuelEslestirmePaneliGoster();
      
      // Sol kutucuÄŸa tarif adÄ±nÄ± doldur
      const yeniTarifInput = document.getElementById('manuelTarifAdi');
      if (yeniTarifInput) {
        yeniTarifInput.value = tarifAdi;
      }
      
      // SaÄŸ tarafta arama kutucuÄŸunu temizle
      const kartAramaInput = document.getElementById('eskiKartArama');
      if (kartAramaInput) {
        kartAramaInput.value = '';
        kartAramaInput.placeholder = `"${tarifAdi}" iÃ§in eÅŸleÅŸecek kartlarÄ± dÃ¼zenle...`;
      }
      
      // EÅŸleÅŸen kartlarÄ± otomatik seÃ§
      setTimeout(() => {
        const kartCheckboxes = document.querySelectorAll('#manuelKartListesi input[type="checkbox"]');
        const secilenKartIsimleri = eslesenKartlar.map(kart => kart.name || kart.kartResmi);
        
        kartCheckboxes.forEach(checkbox => {
          const kartAdi = checkbox.getAttribute('data-kart');
          if (secilenKartIsimleri.includes(kartAdi)) {
            checkbox.checked = true;
            console.log('âœ… Kart otomatik seÃ§ildi:', kartAdi);
          }
        });
        
        console.log('ğŸ¯ Otomatik seÃ§ilen kartlar:', secilenKartIsimleri);
      }, 500); // KartlarÄ±n yÃ¼klenmesi iÃ§in kÄ±sa bir bekleme
      
      // KullanÄ±cÄ±ya bilgilendirme
      const statusDiv = document.getElementById('manuelEslestirmeStatus');
      if (statusDiv) {
        statusDiv.style.display = 'block';
        statusDiv.style.background = '#d4edda';
        statusDiv.style.color = '#155724';
        statusDiv.style.border = '1px solid #c3e6cb';
        statusDiv.innerHTML = `
          <strong>ğŸ”§ EÅŸleÅŸen Tarif DÃ¼zenleniyor:</strong> "${tarifAdi}"<br>
          <small>Mevcut eÅŸleÅŸen kartlar otomatik seÃ§ildi. Ä°stediÄŸiniz deÄŸiÅŸiklikleri yapÄ±p kaydedin.</small>
        `;
      }
    }

    // Manuel eÅŸleÅŸtirme paneli iÃ§in dinamik kart arama
    function manuelEslestirmeKartAra(aramaMetni) {
      console.log('ğŸ” Manuel eÅŸleÅŸtirme kart arama:', aramaMetni);
      manuelKartListesiniGoster(aramaMetni);
    }

    function manuelKartListesiniGoster(aramaMetni = '') {
      const div = document.getElementById('manuelKartListesi');
      div.innerHTML = '';

      console.log('ğŸ” Manuel kart listesi gÃ¶steriliyor, arama metni:', aramaMetni);
      
      // Arama metnini kelimelere ayÄ±r ve tÃ¼rkÃ§e karakterleri normalize et
      const aramaKelimeleri = aramaMetni.trim().split(/\s+/).filter(k => k.length > 0)
        .map(kelime => karakterDuzelt(kelime.toLowerCase()));
      
      console.log('ğŸ” Arama kelimeleri:', aramaKelimeleri);
      
      // Filtreleme fonksiyonu
      function kartEslesiyorMu(kartAdi) {
        if (aramaKelimeleri.length === 0) return true;
        
        const kartMetni = karakterDuzelt(kartAdi.toLowerCase())
          .replace(/\.(jpg|jpeg|png)$/i, '') // dosya uzantÄ±sÄ±nÄ± kaldÄ±r
          .replace(/_/g, ' '); // alt Ã§izgileri boÅŸluÄŸa Ã§evir
        
        // TÃ¼m arama kelimelerinin kart adÄ±nda bulunup bulunmadÄ±ÄŸÄ±nÄ± kontrol et
        const eslesiyor = aramaKelimeleri.every(kelime => kartMetni.includes(kelime));
        
        if (aramaKelimeleri.length > 0) {
          console.log(`ğŸ” "${kartAdi}" â†’ "${kartMetni}" eÅŸleÅŸme: ${eslesiyor}`);
        }
        
        return eslesiyor;
      }
      
      // Filtreleme
      const filtrelenmisKartlar = tariflerKlasoruGorselleri.filter(kart => 
        kartEslesiyorMu(kart.name)
      );
      
      console.log(`ğŸ“‹ FiltrelenmiÅŸ kart sayÄ±sÄ±: ${filtrelenmisKartlar.length}`);
      
      // SonuÃ§larÄ± eÅŸleÅŸme skoruna gÃ¶re sÄ±rala
      if (aramaKelimeleri.length > 0) {
        filtrelenmisKartlar.sort((a, b) => {
          const aAdi = karakterDuzelt(a.name.toLowerCase()).replace(/\.(jpg|jpeg|png)$/i, '').replace(/_/g, ' ');
          const bAdi = karakterDuzelt(b.name.toLowerCase()).replace(/\.(jpg|jpeg|png)$/i, '').replace(/_/g, ' ');
          
          // Tam arama metni eÅŸleÅŸmesi
          const aramaTam = aramaKelimeleri.join(' ');
          const aIceriyor = aAdi.includes(aramaTam);
          const bIceriyor = bAdi.includes(aramaTam);
          
          if (aIceriyor && !bIceriyor) return -1;
          if (!aIceriyor && bIceriyor) return 1;
          
          // BaÅŸlangÄ±Ã§ eÅŸleÅŸmesi
          const aBaslangic = aramaKelimeleri.some(kelime => aAdi.startsWith(kelime));
          const bBaslangic = aramaKelimeleri.some(kelime => bAdi.startsWith(kelime));
          
          if (aBaslangic && !bBaslangic) return -1;
          if (!aBaslangic && bBaslangic) return 1;
          
          // Alfabetik sÄ±ralama
          return a.name.localeCompare(b.name, 'tr-TR');
        });
      }
      
      filtrelenmisKartlar.forEach(kart => {
        const label = document.createElement('label');
        label.style.cssText = 'display:block; margin:4px 0; cursor:pointer; padding:2px;';
        
        const duzeltilmisKartAdi = kart.name; // ArtÄ±k karakterDuzelt global fonksiyonu kullanÄ±lÄ±yor
        
        label.innerHTML = `
          <input type="checkbox" data-kart="${kart.name}" style="margin-right:8px;" />
          ${duzeltilmisKartAdi}
        `;
        div.appendChild(label);
      });
    }

    function manuelEslestirmePaneliGizle() {
      const panel = document.getElementById('manuelEslestirmePanel');
      const tarifAdi = document.getElementById('manuelTarifAdi');
      const kartSecimi = document.getElementById('manuelKartSecimi');
      const status = document.getElementById('manuelEslestirmeStatus');
      
      if (panel) panel.style.display = 'none';
      if (tarifAdi) tarifAdi.value = '';
      if (kartSecimi) kartSecimi.selectedIndex = -1;
      if (status) status.style.display = 'none';
      
      // Panel kapandÄ±ÄŸÄ±nda render'Ä± gÃ¼ncelle (eÄŸer deÄŸiÅŸiklik yapÄ±ldÄ±ysa)
      console.log('ğŸ”„ Manuel eÅŸleÅŸtirme paneli kapandÄ±, hafif gÃ¼ncelleme...');
      setTimeout(() => {
        if (typeof window.aktifHaftaIndex !== 'undefined' && window.aktifHaftaIndex !== null) {
          gosterEslesenKartlarSidebar(window.aktifHaftaIndex);
        }
      }, 500);
    }

    function manuelEslestirmeStatusGoster(mesaj, tip = 'info') {
      const statusDiv = document.getElementById('manuelEslestirmeStatus');
      statusDiv.style.display = 'block';
      statusDiv.innerHTML = mesaj;
      
      if (tip === 'success') {
        statusDiv.style.background = '#d4edda';
        statusDiv.style.color = '#155724';
        statusDiv.style.border = '1px solid #c3e6cb';
      } else if (tip === 'error') {
        statusDiv.style.background = '#f8d7da';
        statusDiv.style.color = '#721c24';
        statusDiv.style.border = '1px solid #f5c6cb';
      } else {
        statusDiv.style.background = '#d1ecf1';
        statusDiv.style.color = '#0c5460';
        statusDiv.style.border = '1px solid #bee5eb';
      }
    }

    function manuelEslestirmeEkle() {
      const tarifAdi = document.getElementById('manuelTarifAdi').value.trim();
      const checkboxes = document.querySelectorAll('#manuelKartListesi input[type="checkbox"]:checked');
      const secilenKartlar = Array.from(checkboxes).map(cb => cb.getAttribute('data-kart'));
      
      if (!tarifAdi) {
        manuelEslestirmeStatusGoster('Yemek adÄ± boÅŸ olamaz!', 'error');
        return;
      }
      
      if (secilenKartlar.length === 0) {
        manuelEslestirmeStatusGoster('En az bir kart seÃ§melisiniz!', 'error');
        return;
      }
      
      // Normalize et - fonksiyonu burada tanÄ±mla
      function normalizeLocal(str) {
        return str
          .toLowerCase()
          .replace(/Ã§/g, 'c').replace(/ÄŸ/g, 'g').replace(/ÅŸ/g, 's')
          .replace(/Ã¼/g, 'u').replace(/Ã¶/g, 'o').replace(/Ä±/g, 'i')
          .replace(/iÌ‡/g, 'i')
          .replace(/[_*\/()]/g, ' ')  // Sembolleri boÅŸlukla deÄŸiÅŸtir
          .replace(/\s+/g, ' ')       // Ã‡oklu boÅŸluklarÄ± tek boÅŸluÄŸa Ã§evir
          .replace(/[^a-z0-9\s]/g, '') // Sadece harf, rakam ve boÅŸluk bÄ±rak
          .trim();
      }
      
      const normalizeEdilmis = normalizeLocal(tarifAdi);
      
      // Kaydet
      manuelEslestirmeler[normalizeEdilmis] = {
        orijinalMetin: tarifAdi,
        kartlar: secilenKartlar,
        eklemeTarihi: new Date().toISOString()
      };
      
      manuelEslestirmeleriKaydet();
      manuelEslestirmeListesiniGoster();

      // Karakter dÃ¼zeltme fonksiyonu
      function karakterDuzelt(text) {
        if (!text) return text;
        return text
          .replace(/Ã„Â±/g, 'Ä±')
          .replace(/Ã„/g, 'ÄŸ') 
          .replace(/Ã…/g, 'ÅŸ')
          .replace(/Ä/g, 'ÄŸ')
          .replace(/ÃƒÂ¼/g, 'Ã¼')
          .replace(/ÃƒÂ¶/g, 'Ã¶')
          .replace(/ÃƒÂ§/g, 'Ã§')
          .replace(/Ã¢/g, 'a')
          .replace(/Ã®/g, 'i')
          .replace(/Ã»/g, 'u')
          .replace(/Ã´/g, 'o');
      }
      
      const duzeltilmisMetin = karakterDuzelt(tarifAdi);
      manuelEslestirmeStatusGoster(`âœ… EÅŸleÅŸtirme eklendi! "${duzeltilmisMetin}" â†’ ${secilenKartlar.length} kart`, 'success');
      
      // EÅŸleÅŸmeyenler listesini gÃ¼ncelle - eklenen tarifi kaldÄ±r
      eslesmeyenlerListesiniGuncelle();
      
      // Formu temizle
      document.getElementById('manuelTarifAdi').value = '';
      document.querySelectorAll('#manuelKartListesi input[type="checkbox"]').forEach(cb => cb.checked = false);
    }

    function manuelEslestirmeleriTemizle() {
      if (!confirm('TÃ¼m manuel eÅŸleÅŸtirmeleri silmek istediÄŸinize emin misiniz?')) return;
      
      manuelEslestirmeler = {};
      manuelEslestirmeleriKaydet();
      manuelEslestirmeListesiniGoster();
      manuelEslestirmeStatusGoster('TÃ¼m manuel eÅŸleÅŸtirmeler temizlendi.', 'success');
    }

    function manuelEslestirmeListesiniGoster() {
      const div = document.getElementById('manuelEslestirmeListesi');
      div.innerHTML = '';
      
      const anahtarlar = Object.keys(manuelEslestirmeler);
      if (anahtarlar.length === 0) {
        div.innerHTML = '<em>HenÃ¼z manuel eÅŸleÅŸtirme yok</em>';
        return;
      }

    function manuelEslestirmeSil(anahtar) {
      console.log('ğŸ—‘ï¸ Silme iÅŸlemi baÅŸlatÄ±ldÄ±, anahtar:', anahtar);
      
      if (!confirm('Bu eÅŸleÅŸtirmeyi silmek istediÄŸinize emin misiniz?')) {
        console.log('âŒ KullanÄ±cÄ± silme iÅŸlemini iptal etti');
        return;
      }
      
      console.log('âœ… KullanÄ±cÄ± silme iÅŸlemini onayladÄ±');
      delete manuelEslestirmeler[anahtar];
      manuelEslestirmeleriKaydet();
      manuelEslestirmeListesiniGoster();
      manuelEslestirmeStatusGoster('EÅŸleÅŸtirme silindi.', 'success');
      
      // EÅŸleÅŸtirme silindiÄŸinde eÅŸleÅŸmeyenler listesini gÃ¼ncelle
      eslesmeyenlerListesiniGuncelle();
      console.log('ğŸ”„ Silme iÅŸlemi tamamlandÄ±');
    }

    function manuelEslestirmeListesiniGoster() {
      const div = document.getElementById('manuelEslestirmeListesi');
      div.innerHTML = '';
      
      const anahtarlar = Object.keys(manuelEslestirmeler);
      if (anahtarlar.length === 0) {
        div.innerHTML = '<em>HenÃ¼z manuel eÅŸleÅŸtirme yok</em>';
        return;
      }

      // Karakter dÃ¼zeltme fonksiyonu
      function karakterDuzelt(text) {
        if (!text) return text;
        return text
          .replace(/Ã„Â±/g, 'Ä±')
          .replace(/Ã„/g, 'ÄŸ') 
          .replace(/Ã…/g, 'ÅŸ')
          .replace(/Ä/g, 'ÄŸ')
          .replace(/ÃƒÂ¼/g, 'Ã¼')
          .replace(/ÃƒÂ¶/g, 'Ã¶')
          .replace(/ÃƒÂ§/g, 'Ã§')
          .replace(/Ã¢/g, 'a')
          .replace(/Ã®/g, 'i')
          .replace(/Ã»/g, 'u')
          .replace(/Ã´/g, 'o');
      }
      
      anahtarlar.forEach(anahtar => {
        const eslestirme = manuelEslestirmeler[anahtar];
        const eslestirmeDiv = document.createElement('div');
        eslestirmeDiv.style.cssText = 'border:1px solid #ddd; margin:8px 0; padding:8px; background:#fff; border-radius:4px;';
        
        // Orijinal metni ve kartlarÄ± dÃ¼zelt
        const duzeltilmisMetin = karakterDuzelt(eslestirme.orijinalMetin);
        const duzeltilmisKartlar = eslestirme.kartlar.map(kart => karakterDuzelt(kart));
        
        eslestirmeDiv.innerHTML = `
          <div style="font-weight:bold; color:#28a745;">${duzeltilmisMetin}</div>
          <div style="margin:5px 0; font-size:0.9em;">â†’ ${duzeltilmisKartlar.join(', ')}</div>
          <div style="display:flex; gap:8px; margin-top:5px;">
            <button class="duzenle-btn" style="background:#17a2b8; color:white; border:none; padding:4px 8px; border-radius:3px; font-size:0.8em; cursor:pointer;">âœï¸ DÃ¼zenle</button>
            <button class="sil-btn" style="background:#dc3545; color:white; border:none; padding:4px 8px; border-radius:3px; font-size:0.8em; cursor:pointer;">ğŸ—‘ï¸ Sil</button>
          </div>
        `;
        
        // Event listener'larÄ± gÃ¼venli ÅŸekilde ekle
        const duzenleBtn = eslestirmeDiv.querySelector('.duzenle-btn');
        const silBtn = eslestirmeDiv.querySelector('.sil-btn');
        
        if (duzenleBtn && silBtn) {
          duzenleBtn.addEventListener('click', () => {
            console.log('ğŸ”§ DÃ¼zenle butonuna tÄ±klandÄ±, anahtar:', anahtar);
            manuelEslestirmeDuzenle(anahtar);
          });
          
          silBtn.addEventListener('click', () => {
            console.log('ğŸ—‘ï¸ Sil butonuna tÄ±klandÄ±, anahtar:', anahtar);
            manuelEslestirmeSil(anahtar);
          });
          
          console.log('âœ… Event listener\'lar eklendi, anahtar:', anahtar);
        } else {
          console.error('âŒ Butonlar bulunamadÄ±!', { duzenleBtn, silBtn });
        }
        
        div.appendChild(eslestirmeDiv);
      });
    }
      manuelEslestirmeleriKaydet();
      manuelEslestirmeListesiniGoster();
      manuelEslestirmeStatusGoster('EÅŸleÅŸtirme silindi.', 'success');
    }

    function manuelEslestirmeDuzenle(anahtar) {
      // Mevcut eÅŸleÅŸtirme verilerini al
      const mevcutEslestirme = manuelEslestirmeler[anahtar];
      if (!mevcutEslestirme) {
        alert('EÅŸleÅŸtirme bulunamadÄ±!');
        return;
      }

      // DÃ¼zenle modalÄ± oluÅŸtur
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
        background: rgba(0,0,0,0.5); z-index: 10000; 
        display: flex; align-items: center; justify-content: center;
      `;

      modal.innerHTML = `
        <div style="background: white; padding: 30px; border-radius: 10px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
          <h3 style="margin-bottom: 20px; color: #17a2b8;">âœï¸ Manuel EÅŸleÅŸtirme DÃ¼zenle</h3>
          
          <div style="margin-bottom: 15px;">
            <label style="display: block; font-weight: bold; margin-bottom: 5px;">Tarif AdÄ±:</label>
            <input type="text" id="duzenleOrijinalMetin" value="${karakterDuzelt(mevcutEslestirme.orijinalMetin)}" 
                   style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
          </div>
          
          <div style="margin-bottom: 20px;">
            <label style="display: block; font-weight: bold; margin-bottom: 5px;">EÅŸleÅŸen Kartlar (virgÃ¼lle ayÄ±rÄ±n):</label>
            <textarea id="duzenleKartlar" rows="4" 
                      style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; resize: vertical;">${mevcutEslestirme.kartlar.map(kart => karakterDuzelt(kart)).join(', ')}</textarea>
            <small style="color: #666;">Ã–rnek: karnÄ±yarÄ±k, patlÄ±can yemeÄŸi, et yemeÄŸi</small>
          </div>
          
          <div style="display: flex; gap: 10px; justify-content: flex-end; flex-wrap: wrap;">
            <button onclick="manuelEslestirmeDuzenleKaydet('${anahtar}')" 
                    style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 14px;">
              âœ… Kaydet
            </button>
            <button onclick="manuelEslestirmeDuzenleYeniKaydet('${anahtar}')" 
                    style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 14px;">
              â• Yeni Kaydet
            </button>
            <button onclick="manuelEslestirmeDuzenleIptal()" 
                    style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 14px;">
              âŒ Ä°ptal
            </button>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
      window.currentEditModal = modal;
      
      // Ä°lk input'a odaklan
      setTimeout(() => {
        document.getElementById('duzenleOrijinalMetin').focus();
      }, 100);
    }

    function manuelEslestirmeDuzenleKaydet(eskiAnahtar) {
      const yeniOrijinalMetin = document.getElementById('duzenleOrijinalMetin').value.trim();
      const yeniKartlarMetin = document.getElementById('duzenleKartlar').value.trim();

      if (!yeniOrijinalMetin || !yeniKartlarMetin) {
        alert('LÃ¼tfen tÃ¼m alanlarÄ± doldurun!');
        return;
      }

      // KartlarÄ± virgÃ¼lle ayÄ±r ve temizle
      const yeniKartlar = yeniKartlarMetin.split(',').map(kart => kart.trim()).filter(kart => kart.length > 0);
      
      if (yeniKartlar.length === 0) {
        alert('En az bir kart adÄ± girmelisiniz!');
        return;
      }

      // Yeni anahtar oluÅŸtur
      const yeniAnahtar = normalize(yeniOrijinalMetin);
      
      // Anahtar deÄŸiÅŸmiÅŸse ve yeni anahtar zaten varsa uyar
      if (eskiAnahtar !== yeniAnahtar && manuelEslestirmeler[yeniAnahtar]) {
        if (!confirm('Bu tarif adÄ± zaten mevcut! Mevcut eÅŸleÅŸtirmeyi gÃ¼ncellemek istediÄŸinize emin misiniz?')) {
          return;
        }
      }

      // Eski eÅŸleÅŸtirmeyi sil (anahtar deÄŸiÅŸmiÅŸse)
      if (eskiAnahtar !== yeniAnahtar) {
        delete manuelEslestirmeler[eskiAnahtar];
      }

      // Yeni eÅŸleÅŸtirmeyi kaydet
      manuelEslestirmeler[yeniAnahtar] = {
        orijinalMetin: yeniOrijinalMetin,
        kartlar: yeniKartlar
      };

      // Kaydet ve gÃ¼ncelle
      manuelEslestirmeleriKaydet();
      manuelEslestirmeListesiniGoster();
      manuelEslestirmeDuzenleIptal();
      
      manuelEslestirmeStatusGoster('EÅŸleÅŸtirme baÅŸarÄ±yla gÃ¼ncellendi!', 'success');
    }

    function manuelEslestirmeDuzenleYeniKaydet(eskiAnahtar) {
      console.log('â• Yeni eÅŸleÅŸtirme olarak kaydetme baÅŸlatÄ±ldÄ±, eski anahtar:', eskiAnahtar);
      
      const yeniOrijinalMetin = document.getElementById('duzenleOrijinalMetin').value.trim();
      const yeniKartlarMetin = document.getElementById('duzenleKartlar').value.trim();

      if (!yeniOrijinalMetin || !yeniKartlarMetin) {
        alert('LÃ¼tfen tÃ¼m alanlarÄ± doldurun!');
        return;
      }

      // KartlarÄ± virgÃ¼lle ayÄ±r ve temizle
      const yeniKartlar = yeniKartlarMetin.split(',').map(kart => kart.trim()).filter(kart => kart.length > 0);
      
      if (yeniKartlar.length === 0) {
        alert('En az bir kart adÄ± girmelisiniz!');
        return;
      }

      // Yeni anahtar oluÅŸtur
      function normalize(str) {
        return str
          .toLowerCase()
          .replace(/Ã§/g, 'c').replace(/ÄŸ/g, 'g').replace(/ÅŸ/g, 's')
          .replace(/Ã¼/g, 'u').replace(/Ã¶/g, 'o').replace(/Ä±/g, 'i')
          .replace(/iÌ‡/g, 'i')
          .replace(/[_*\/()]/g, ' ')
          .replace(/\s+/g, ' ')
          .replace(/[^a-z0-9\s]/g, '')
          .trim();
      }
      
      const yeniAnahtar = normalize(yeniOrijinalMetin);
      
      // Yeni anahtar zaten varsa uyar
      if (manuelEslestirmeler[yeniAnahtar]) {
        if (!confirm('Bu tarif adÄ± zaten mevcut! Mevcut eÅŸleÅŸtirmeyi gÃ¼ncellemek istediÄŸinize emin misiniz?')) {
          return;
        }
      }

      // Yeni eÅŸleÅŸtirmeyi kaydet (eski eÅŸleÅŸtirmeyi silme!)
      manuelEslestirmeler[yeniAnahtar] = {
        orijinalMetin: yeniOrijinalMetin,
        kartlar: yeniKartlar,
        eklemeTarihi: new Date().toISOString()
      };

      // Kaydet ve gÃ¼ncelle
      manuelEslestirmeleriKaydet();
      manuelEslestirmeListesiniGoster();
      manuelEslestirmeDuzenleIptal();
      
      manuelEslestirmeStatusGoster(`âœ… Yeni eÅŸleÅŸtirme oluÅŸturuldu: "${yeniOrijinalMetin}" â†’ ${yeniKartlar.length} kart`, 'success');
      
      // EÅŸleÅŸmeyenler listesini gÃ¼ncelle (yeni eÅŸleÅŸtirme eklendiÄŸinde)
      eslesmeyenlerListesiniGuncelle();
      
      console.log('âœ… Yeni eÅŸleÅŸtirme baÅŸarÄ±yla oluÅŸturuldu:', yeniAnahtar);
    }

    function manuelEslestirmeDuzenleIptal() {
      if (window.currentEditModal) {
        document.body.removeChild(window.currentEditModal);
        window.currentEditModal = null;
      }
    }

    // Sayfa yÃ¼klenirken manuel eÅŸleÅŸtirmeleri yÃ¼kle
    window.addEventListener('DOMContentLoaded', function() {
      // Bu fonksiyon yukarÄ±da initManuelEslestirmeler() ile birleÅŸtirildi
      // Ã‡ift yÃ¼klemeyi Ã¶nlemek iÃ§in kaldÄ±rÄ±ldÄ±
    });

    // GitHub'a manuel eÅŸleÅŸtirmeleri kaydetme
    async function manuelEslestirmeleriGitHubKaydet(sessizKaydetme = false) {
      // Zaten kaydetme devam ediyorsa Ã§Ä±k
      if (gitHubKaydetmeDevamEdiyor) {
        if (!sessizKaydetme) {
          console.log('âš ï¸ GitHub kaydetme zaten devam ediyor, iÅŸlem atlandÄ±');
        }
        return;
      }
      
      const token = document.getElementById('githubToken').value.trim();
      if (!token) {
        if (!sessizKaydetme) {
          alert('GitHub API token gerekli!');
        }
        return;
      }

      // Kaydetme baÅŸladÄ± iÅŸaretini koy
      gitHubKaydetmeDevamEdiyor = true;

      const owner = 'mustafasacar35';
      const repo = 'lipodem-takip-paneli-3';
      const path = 'data/manuel_eslestirmeler.json';
      const branch = 'main';

      try {
        if (!sessizKaydetme) {
          manuelEslestirmeStatusGoster('GitHub\'a kaydediliyor...', 'info');
        }

        // Ã–nce mevcut dosyanÄ±n SHA'sÄ±nÄ± al (gÃ¼ncelleme iÃ§in gerekli)
        let sha = undefined;
        try {
          const resp = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}?ref=${branch}`, {
            headers: { Authorization: `token ${token}` }
          });
          if (resp.ok) {
            const data = await resp.json();
            sha = data.sha;
          }
        } catch (e) {}

        // Veriyi hazÄ±rla
        const kayitVerisi = {
          version: '1.0',
          sonGuncelleme: new Date().toISOString(),
          eslestirmeler: manuelEslestirmeler
        };

        // UTF-8 iÃ§in doÄŸru encoding
        const content = encodeUTF8ToBase64(kayitVerisi);

        // DosyayÄ± yÃ¼kle
        const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, {
          method: 'PUT',
          headers: {
            'Authorization': `token ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            message: 'Manuel eÅŸleÅŸtirmeler gÃ¼ncellendi',
            content,
            branch,
            sha
          })
        });

        if (res.ok) {
          // Cache timestamp'ini gÃ¼ncelle
          localStorage.setItem('lastGithubUpdate', Date.now().toString());
          if (!sessizKaydetme) {
            manuelEslestirmeStatusGoster('âœ… GitHub\'a baÅŸarÄ±yla kaydedildi!', 'success');
          }
          console.log('âœ… GitHub kaydetme baÅŸarÄ±lÄ± - durum sÄ±fÄ±rlanacak');
        } else {
          throw new Error('GitHub kaydÄ± baÅŸarÄ±sÄ±z: ' + (await res.text()));
        }

      } catch (error) {
        console.error('GitHub kaydetme hatasÄ±:', error);
        
        // SHA conflict hatasÄ± varsa dosyayÄ± tekrar Ã§ek ve tekrar dene
        if (error.message && error.message.includes('but expected')) {
          console.log('ğŸ”„ SHA conflict, tekrar deneniyor...');
          try {
            // En gÃ¼ncel SHA'yÄ± al
            const sharedResp = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}?ref=${branch}`, {
              headers: { 'Authorization': `token ${token}` }
            });
            
            if (sharedResp.ok) {
              const sharedData = await sharedResp.json();
              const guncelSha = sharedData.sha;
              
              console.log('ğŸ”„ GÃ¼ncel SHA alÄ±ndÄ±, tekrar kaydediliyor...');
              
              // Tekrar dene - aynÄ± veri yapÄ±sÄ±nÄ± kullan
              const retryKayitVerisi = {
                version: '1.0',
                sonGuncelleme: new Date().toISOString(),
                eslestirmeler: manuelEslestirmeler
              };
              
              const retryRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, {
                method: 'PUT',
                headers: {
                  'Authorization': `token ${token}`,
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                  message: 'Manuel eÅŸleÅŸtirmeler gÃ¼ncellendi (retry)',
                  content: encodeUTF8ToBase64(retryKayitVerisi),
                  branch,
                  sha: guncelSha
                })
              });
              
              if (retryRes.ok) {
                console.log('âœ… Retry baÅŸarÄ±lÄ± - GitHub\'a kaydedildi!');
                localStorage.setItem('lastGithubUpdate', Date.now().toString());
                if (!sessizKaydetme) {
                  manuelEslestirmeStatusGoster('âœ… GitHub\'a baÅŸarÄ±yla kaydedildi! (retry)', 'success');
                }
                // BaÅŸarÄ±lÄ± retry sonrasÄ± da durumu sÄ±fÄ±rla
                gitHubKaydetmeDevamEdiyor = false;
                return;
              } else {
                console.error('âŒ Retry de baÅŸarÄ±sÄ±z oldu:', await retryRes.text());
              }
            }
          } catch (retryError) {
            console.error('âŒ Retry de baÅŸarÄ±sÄ±z:', retryError);
          }
        }
        
        if (!sessizKaydetme) {
          manuelEslestirmeStatusGoster(`âŒ GitHub kaydetme hatasÄ±: ${error.message}`, 'error');
        }
      } finally {
        // Kaydetme durumunu her durumda sÄ±fÄ±rla
        gitHubKaydetmeDevamEdiyor = false;
        console.log('ğŸ”„ GitHub kaydetme durumu sÄ±fÄ±rlandÄ±');
      }
    }

    // GitHub'dan manuel eÅŸleÅŸtirmeleri yÃ¼kleme
    async function manuelEslestirmeleriGitHubYukle(sessizYukleme = false) {
      const token = document.getElementById('githubToken').value.trim();
      if (!token) {
        if (!sessizYukleme) {
          alert('GitHub API token gerekli!');
        }
        return;
      }

      const owner = 'mustafasacar35';
      const repo = 'lipodem-takip-paneli-3';
      const path = 'data/manuel_eslestirmeler.json';
      const branch = 'main';

      try {
        if (!sessizYukleme) {
          manuelEslestirmeStatusGoster('GitHub\'dan yÃ¼kleniyor...', 'info');
        }

        const resp = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}?ref=${branch}`, {
          headers: { Authorization: `token ${token}` }
        });

        if (resp.ok) {
          const data = await resp.json();
          const jsonContent = decodeBase64UTF8(data.content);
          const kayitVerisi = JSON.parse(jsonContent);
          
          // Eski format kontrolÃ¼
          if (kayitVerisi.eslestirmeler) {
            manuelEslestirmeler = kayitVerisi.eslestirmeler;
          } else {
            // Eski format (direkt object)
            manuelEslestirmeler = kayitVerisi;
          }
          
          // LocalStorage'a da kaydet
          localStorage.setItem(MANUEL_ESLESTIRME_KEY, JSON.stringify(manuelEslestirmeler));
          
          // Cache timestamp'ini gÃ¼ncelle
          localStorage.setItem('lastGithubUpdate', Date.now().toString());
          
          // Listeyi gÃ¼ncelle (eÄŸer panel aÃ§Ä±ksa)
          if (document.getElementById('manuelEslestirmePanel').style.display !== 'none') {
            manuelEslestirmeListesiniGoster();
          }

          if (!sessizYukleme) {
            const eslestirmeSayisi = Object.keys(manuelEslestirmeler).length;
            manuelEslestirmeStatusGoster(`âœ… GitHub'dan ${eslestirmeSayisi} eÅŸleÅŸtirme yÃ¼klendi!`, 'success');
          } else {
            // Sessiz yÃ¼kleme olsa bile konsola yazdÄ±r
            const eslestirmeSayisi = Object.keys(manuelEslestirmeler).length;
            console.log(`Manuel eÅŸleÅŸtirmeler GitHub'dan gÃ¼ncellendi: ${eslestirmeSayisi} adet`);
          }

        } else if (resp.status === 404) {
          // Dosya henÃ¼z yok, normal
          if (!sessizYukleme) {
            manuelEslestirmeStatusGoster('â„¹ï¸ GitHub\'da henÃ¼z eÅŸleÅŸtirme dosyasÄ± yok', 'info');
          }
        } else {
          throw new Error('GitHub\'dan okuma baÅŸarÄ±sÄ±z: ' + resp.status);
        }

      } catch (error) {
        console.error('GitHub yÃ¼kleme hatasÄ±:', error);
        if (!sessizYukleme) {
          manuelEslestirmeStatusGoster(`âŒ GitHub yÃ¼kleme hatasÄ±: ${error.message}`, 'error');
        }
      }
    }

    // --- Kart Silme FonksiyonlarÄ± ---
    function kartSilFormGoster() {
      const token = document.getElementById('githubToken').value.trim();
      if (!token) {
        alert('Ã–nce GitHub API token girin!');
        return;
      }
      
      // Mevcut kartlarÄ± listele
      kartListesiniYenile();
      document.getElementById('kartSilFormu').style.display = 'block';
    }

    function kartSilFormGizle() {
      document.getElementById('kartSilFormu').style.display = 'none';
      document.getElementById('silinecekKart').value = '';
      document.getElementById('kartAramaInput').value = '';
      document.getElementById('onizlemeAlani').innerHTML = '';
      document.getElementById('silmeStatus').style.display = 'none';
    }

    async function kartListesiniYenile() {
      const select = document.getElementById('silinecekKart');
      const aramaInput = document.getElementById('kartAramaInput');
      
      // EÄŸer tarifler listesi boÅŸsa yÃ¼kle
      if (tariflerKlasoruGorselleri.length === 0) {
        await tariflerKlasoruGorselleriniYukle();
      }
      
      // TÃ¼m kartlarÄ± sakla (filtreleme iÃ§in)
      window.tumKartListesi = [...tariflerKlasoruGorselleri];
      
      // Ä°lk yÃ¼klemede tÃ¼m kartlarÄ± gÃ¶ster
      kartListesiniFiltrele('');
      
      // Arama input'una olay dinleyicisi ekle
      aramaInput.oninput = function() {
        const aramaMetni = this.value.toLowerCase();
        kartListesiniFiltrele(aramaMetni);
      };
      
      // Kart seÃ§ildiÄŸinde Ã¶nizleme gÃ¶ster
      select.onchange = function() {
        kartOnizlemeGoster(this.value);
      };
    }

    function kartListesiniFiltrele(aramaMetni) {
      const select = document.getElementById('silinecekKart');
      select.innerHTML = '<option value="">Kart seÃ§in...</option>';
      
      if (!window.tumKartListesi) return;
      
      // Arama metnini kelimelere ayÄ±r ve tÃ¼rkÃ§e karakterleri normalize et
      const aramaKelimeleri = aramaMetni.trim().split(/\s+/).filter(k => k.length > 0)
        .map(kelime => karakterDuzelt(kelime.toLowerCase()));
      
      console.log('ğŸ” Arama kelimeleri:', aramaKelimeleri);
      
      // Filtreleme fonksiyonu
      function kartEslesiyorMu(kartAdi) {
        if (aramaKelimeleri.length === 0) return true;
        
        const kartMetni = karakterDuzelt(kartAdi.toLowerCase())
          .replace(/\.(jpg|jpeg|png)$/i, '') // dosya uzantÄ±sÄ±nÄ± kaldÄ±r
          .replace(/_/g, ' '); // alt Ã§izgileri boÅŸluÄŸa Ã§evir
        
        console.log(`ğŸ” Kart "${kartAdi}" test ediliyor: "${kartMetni}"`);
        
        // TÃ¼m arama kelimelerinin kart adÄ±nda bulunup bulunmadÄ±ÄŸÄ±nÄ± kontrol et
        const eslesiyor = aramaKelimeleri.every(kelime => {
          const eslesme = kartMetni.includes(kelime);
          console.log(`  âœ“ "${kelime}" kelimesi "${kartMetni}" iÃ§inde: ${eslesme}`);
          return eslesme;
        });
        
        console.log(`ğŸ“Š "${kartAdi}" sonuÃ§: ${eslesiyor}`);
        return eslesiyor;
      }
      
      // FiltrelenmiÅŸ kartlarÄ± ekle
      const filtrelenmisKartlar = window.tumKartListesi.filter(kart => 
        kartEslesiyorMu(kart.name)
      );
      
      console.log(`ğŸ“‹ FiltrelenmiÅŸ kart sayÄ±sÄ±: ${filtrelenmisKartlar.length}`);
      
      // EÅŸleÅŸme skoruna gÃ¶re sÄ±rala (daha iyi eÅŸleÅŸenler Ã¼stte)
      filtrelenmisKartlar.sort((a, b) => {
        const aMetni = karakterDuzelt(a.name.toLowerCase()).replace(/\.(jpg|jpeg|png)$/i, '').replace(/_/g, ' ');
        const bMetni = karakterDuzelt(b.name.toLowerCase()).replace(/\.(jpg|jpeg|png)$/i, '').replace(/_/g, ' ');
        
        // Tam eÅŸleÅŸme kontrolÃ¼
        if (aramaKelimeleri.length > 0) {
          const aramaMetniTam = aramaKelimeleri.join(' ');
          const aIceriyor = aMetni.includes(aramaMetniTam);
          const bIceriyor = bMetni.includes(aramaMetniTam);
          
          if (aIceriyor && !bIceriyor) return -1;
          if (!aIceriyor && bIceriyor) return 1;
        }
        
        // Alfabetik sÄ±ralama
        return a.name.localeCompare(b.name, 'tr-TR');
      });
      
      // SeÃ§enekleri ekle
      filtrelenmisKartlar.forEach(kart => {
        const option = document.createElement('option');
        option.value = kart.name;
        option.textContent = kart.name;
        
        // EÅŸleÅŸen kelimeleri vurgula (sadece gÃ¶rsel amaÃ§lÄ±)
        if (aramaKelimeleri.length > 0) {
          let vurguluMetin = kart.name;
          aramaKelimeleri.forEach(kelime => {
            const regex = new RegExp(`(${kelime})`, 'gi');
            vurguluMetin = vurguluMetin.replace(regex, 'â†’$1â†');
          });
          option.setAttribute('title', vurguluMetin.replace(/â†’/g, '').replace(/â†/g, ''));
        }
        
        select.appendChild(option);
      });
      
      // SonuÃ§ sayÄ±sÄ±nÄ± gÃ¶ster
      const sonucSayisi = filtrelenmisKartlar.length;
      if (aramaMetni && sonucSayisi === 0) {
        const option = document.createElement('option');
        option.value = '';
        option.textContent = 'EÅŸleÅŸen kart bulunamadÄ±';
        option.disabled = true;
        select.appendChild(option);
      }
    }

    function kartOnizlemeGoster(seciliKart) {
      const onizleme = document.getElementById('onizlemeAlani');
      onizleme.innerHTML = '';
      
      if (seciliKart && window.tumKartListesi) {
        const kartBilgisi = window.tumKartListesi.find(k => k.name === seciliKart);
        if (kartBilgisi) {
          onizleme.innerHTML = `
            <p><strong>Silinecek kart:</strong> ${seciliKart}</p>
            <img src="${kartBilgisi.url}" alt="${seciliKart}" style="width:150px; border:1px solid #ccc;">
          `;
          
          // Arama input'unu seÃ§ilen kart adÄ±yla gÃ¼ncelle
          const aramaInput = document.getElementById('kartAramaInput');
          if (aramaInput.value.trim() === '') {
            aramaInput.value = seciliKart.replace(/\.(jpg|jpeg|png)$/i, '').replace(/_/g, ' ');
          }
        }
      }
    }

    function silmeStatusGoster(mesaj, tip = 'info') {
      const statusDiv = document.getElementById('silmeStatus');
      statusDiv.style.display = 'block';
      statusDiv.innerHTML = mesaj;
      
      if (tip === 'success') {
        statusDiv.style.background = '#d4edda';
        statusDiv.style.color = '#155724';
        statusDiv.style.border = '1px solid #c3e6cb';
      } else if (tip === 'error') {
        statusDiv.style.background = '#f8d7da';
        statusDiv.style.color = '#721c24';
        statusDiv.style.border = '1px solid #f5c6cb';
      } else {
        statusDiv.style.background = '#d1ecf1';
        statusDiv.style.color = '#0c5460';
        statusDiv.style.border = '1px solid #bee5eb';
      }
    }

    async function kartSil() {
      const token = document.getElementById('githubToken').value.trim();
      const silinecekKart = document.getElementById('silinecekKart').value;
      
      if (!token) {
        alert('GitHub API token gerekli!');
        return;
      }
      
      if (!silinecekKart) {
        alert('Silinecek kartÄ± seÃ§in!');
        return;
      }

      // Onay al
      if (!confirm(`"${silinecekKart}" kartÄ±nÄ± gerÃ§ekten silmek istiyorsan? Bu iÅŸlem geri alÄ±namaz!`)) {
        return;
      }

      const owner = 'mustafasacar35';
      const repo = 'lipodem-takip-paneli-3';
      const branch = 'main';

      try {
        silmeStatusGoster('Dosya bilgisi alÄ±nÄ±yor...', 'info');

        // 1. Ã–nce dosyanÄ±n SHA'sÄ±nÄ± al (silmek iÃ§in gerekli)
        const dosyaPath = `tarifler/${silinecekKart}`;
        const dosyaRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${dosyaPath}?ref=${branch}`, {
          headers: { Authorization: `token ${token}` }
        });

        if (!dosyaRes.ok) {
          throw new Error('Dosya bulunamadÄ± veya eriÅŸim hatasÄ±');
        }

        const dosyaData = await dosyaRes.json();

        silmeStatusGoster('Dosya GitHub\'dan siliniyor...', 'info');

        // 2. DosyayÄ± sil
        const silRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${dosyaPath}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `token ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            message: `Tarif kartÄ± silindi: ${silinecekKart}`,
            sha: dosyaData.sha,
            branch
          })
        });

        if (!silRes.ok) {
          throw new Error('Dosya silme baÅŸarÄ±sÄ±z: ' + (await silRes.text()));
        }

        silmeStatusGoster('list.json gÃ¼ncelleniyor...', 'info');

        // 3. list.json'u gÃ¼ncelle
        const listRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/tarifler/list.json?ref=${branch}`, {
          headers: { Authorization: `token ${token}` }
        });

        if (!listRes.ok) {
          throw new Error('list.json dosyasÄ± alÄ±namadÄ±');
        }

        const listData = await listRes.json();
        const mevcutListe = JSON.parse(decodeBase64UTF8(listData.content));
        
        // Silinen dosyayÄ± listeden Ã§Ä±kar
        const guncelListe = mevcutListe.filter(kart => kart !== silinecekKart);

        // GÃ¼ncellenmiÅŸ listeyi yÃ¼kle
        const yeniListeContent = encodeUTF8ToBase64(guncelListe);
        const listUpdateRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/tarifler/list.json`, {
          method: 'PUT',
          headers: {
            'Authorization': `token ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            message: `list.json gÃ¼ncellendi - ${silinecekKart} silindi`,
            content: yeniListeContent,
            sha: listData.sha,
            branch
          })
        });

        if (!listUpdateRes.ok) {
          throw new Error('list.json gÃ¼ncelleme baÅŸarÄ±sÄ±z: ' + (await listUpdateRes.text()));
        }

        silmeStatusGoster(`âœ… BaÅŸarÄ±lÄ±! ${silinecekKart} kartÄ± silindi ve list.json gÃ¼ncellendi.`, 'success');
        
        // Lokal listeyi de gÃ¼ncelle
        await tariflerKlasoruGorselleriniYukle();
        
        // Liste gÃ¼ncelle
        kartListesiniYenile();
        
        // Arama kutusunu ve seÃ§imi temizle
        document.getElementById('kartAramaInput').value = '';
        document.getElementById('silinecekKart').value = '';
        
        // Ã–nizlemeyi temizle
        document.getElementById('onizlemeAlani').innerHTML = '';

      } catch (error) {
        console.error('Kart silme hatasÄ±:', error);
        silmeStatusGoster(`âŒ Hata: ${error.message}`, 'error');
      }
    }

    // --- Yeni Kart Ekleme FonksiyonlarÄ± ---
    function yeniKartFormGoster() {
      const token = document.getElementById('githubToken').value.trim();
      if (!token) {
        alert('Ã–nce GitHub API token girin!');
        return;
      }
      document.getElementById('yeniKartFormu').style.display = 'block';
    }

    function yeniKartFormGizle() {
      document.getElementById('yeniKartFormu').style.display = 'none';
      document.getElementById('yeniKartAdi').value = '';
      document.getElementById('yeniKartDosya').value = '';
      document.getElementById('yuklemeStatus').style.display = 'none';
    }

    // --- Kart DÃ¼zenleme FonksiyonlarÄ± ---
    function kartDuzenleFormGoster() {
      const token = document.getElementById('githubToken').value.trim();
      if (!token) {
        alert('Ã–nce GitHub API token girin!');
        return;
      }
      document.getElementById('kartDuzenleFormu').style.display = 'block';
      document.getElementById('seciliKartBilgileri').style.display = 'none';
      kartListesiniYenileForDuzenleme();
    }

    function kartDuzenleFormGizle() {
      document.getElementById('kartDuzenleFormu').style.display = 'none';
      document.getElementById('duzenleKartArama').value = '';
      document.getElementById('duzenleKartYeniAdi').value = '';
      document.getElementById('duzenleKartYeniDosya').value = '';
      document.getElementById('seciliKartBilgileri').style.display = 'none';
      document.getElementById('duzenlemeStatus').style.display = 'none';
      seciliDuzenleKart = null;
    }

    let seciliDuzenleKart = null;

    async function kartListesiniYenileForDuzenleme() {
      const listeDiv = document.getElementById('duzenleKartListesi');
      listeDiv.innerHTML = '<div style="color:#666;">Kart listesi yÃ¼kleniyor...</div>';
      
      try {
        const token = document.getElementById('githubToken').value.trim();
        const owner = 'mustafasacar35';
        const repo = 'lipodem-takip-paneli-3';
        
        const response = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/tarifler/list.json`, {
          headers: { 'Authorization': `token ${token}` }
        });
        
        if (!response.ok) throw new Error('Kart listesi alÄ±namadÄ±');
        
        const data = await response.json();
        const content = JSON.parse(decodeBase64UTF8(data.content));
        
        kartListesiniGosterForDuzenleme(content);
        
      } catch (error) {
        console.error('Kart listesi yenileme hatasÄ±:', error);
        listeDiv.innerHTML = `<div style="color:red;">Hata: ${error.message}</div>`;
      }
    }

    function kartListesiniGosterForDuzenleme(kartlar, filtreMetni = '') {
      const listeDiv = document.getElementById('duzenleKartListesi');
      listeDiv.innerHTML = '';
      
      const filtrelenmisKartlar = kartlar.filter(kart => 
        kart.toLowerCase().includes(filtreMetni.toLowerCase())
      );
      
      if (filtrelenmisKartlar.length === 0) {
        listeDiv.innerHTML = '<div style="color:#666;">Kart bulunamadÄ±</div>';
        return;
      }
      
      // Mevcut olmayan dosyalarÄ± takip et
      
      filtrelenmisKartlar.forEach(kartAdi => {
        const kartDiv = document.createElement('div');
        kartDiv.style.cssText = 'padding:8px; margin:4px 0; border:1px solid #ddd; border-radius:4px; cursor:pointer; background:white; display:flex; align-items:center; gap:10px;';
        
        // Kart Ã¶nizlemesi
        const img = document.createElement('img');
        img.src = `https://mustafasacar35.github.io/lipodem-takip-paneli-3/tarifler/${kartAdi}`;
        img.style.cssText = 'width:40px; height:40px; object-fit:cover; border-radius:4px;';
        img.onerror = () => {
          img.style.display = 'none';
          dosyaBulunamadi(kartAdi);
          // Kart div'ini farklÄ± stil yap
          kartDiv.style.background = '#fff3cd';
          kartDiv.style.borderColor = '#ffc107';
          span.style.color = '#856404';
          span.title = 'Bu dosya bulunamÄ±yor - list.json\'dan temizlenebilir';
        };
        
        // Kart adÄ±
        const span = document.createElement('span');
        // Encoding sorunlarÄ±nÄ± temizleyip daha okunaklÄ± gÃ¶ster
        let gosterimAdi = kartAdi
          .replace(/Ã„Â±/g, 'Ä±').replace(/Ã„/g, 'a')
          .replace(/Ã…/g, 'ÅŸ').replace(/Ä/g, 'ÄŸ')
          .replace(/ÃƒÂ¼/g, 'Ã¼').replace(/ÃƒÂ¶/g, 'Ã¶')
          .replace(/Ã¢/g, 'a').replace(/Ã®/g, 'i')
          .replace(/Ã»/g, 'u').replace(/Ã´/g, 'o')
          .replace(/_/g, ' ')
          .replace('.jpg', '');
        span.textContent = gosterimAdi;
        span.setAttribute('data-original', kartAdi); // Orijinal adÄ± sakla
        span.style.flex = '1';
        
        kartDiv.appendChild(img);
        kartDiv.appendChild(span);
        
        kartDiv.onclick = () => {
          const originalName = span.getAttribute('data-original');
          kartSecForDuzenleme(originalName);
        };
        
        // Hover efekti
        kartDiv.onmouseenter = () => kartDiv.style.background = '#e3f2fd';
        kartDiv.onmouseleave = () => {
          const originalName = span.getAttribute('data-original');
          kartDiv.style.background = seciliDuzenleKart === originalName ? '#bbdefb' : 'white';
        };
        
        const originalName = span.getAttribute('data-original');
        if (seciliDuzenleKart === originalName) {
          kartDiv.style.background = '#bbdefb';
        }
        
        listeDiv.appendChild(kartDiv);
      });
    }

    function kartListesiniFiltreleForDuzenleme(aramaMetni) {
      // TÃ¼rkÃ§e karakter normalizasyonu
      const normalizeText = (text) => {
        return text.toLowerCase()
          .replace(/Ã§/g, 'c').replace(/Ã‡/g, 'c')
          .replace(/ÄŸ/g, 'g').replace(/Ä/g, 'g')
          .replace(/Ä±/g, 'i').replace(/I/g, 'i').replace(/Ä°/g, 'i')
          .replace(/Ã¶/g, 'o').replace(/Ã–/g, 'o')
          .replace(/ÅŸ/g, 's').replace(/Å/g, 's')
          .replace(/Ã¼/g, 'u').replace(/Ãœ/g, 'u')
          // Encoding sorunlarÄ± iÃ§in
          .replace(/Ã„Â±/g, 'i').replace(/Ã„/g, 'a')
          .replace(/Ã…/g, 's').replace(/Ä/g, 'g')
          .replace(/ÃƒÂ¼/g, 'u').replace(/ÃƒÂ¶/g, 'o')
          .replace(/Ã¢/g, 'a').replace(/Ã®/g, 'i')
          .replace(/Ã»/g, 'u').replace(/Ã´/g, 'o');
      };
      
      // Son yÃ¼klenen kart listesini tekrar filtrele
      kartListesiniYenileForDuzenleme().then(() => {
        // Liste yenilendikten sonra filtreyi uygula
        setTimeout(() => {
          const listeDiv = document.getElementById('duzenleKartListesi');
          const kartDivleri = Array.from(listeDiv.children);
          
          const normalizedArama = normalizeText(aramaMetni);
          
          kartDivleri.forEach(kartDiv => {
            const span = kartDiv.querySelector('span');
            const kartAdi = span?.getAttribute('data-original') || '';
            const gosterimAdi = span?.textContent || '';
            
            // Hem orijinal hem gÃ¶sterim adÄ±nda ara
            const normalizedKart = normalizeText(kartAdi);
            const normalizedGosterim = normalizeText(gosterimAdi);
            const goster = normalizedKart.includes(normalizedArama) || normalizedGosterim.includes(normalizedArama);
            kartDiv.style.display = goster ? 'flex' : 'none';
          });
          
          // Debug: Arama sonuÃ§larÄ±nÄ± gÃ¶ster
          if (aramaMetni.length > 2) {
            const goruntulenenKartlar = kartDivleri.filter(div => div.style.display !== 'none').length;
            console.log(`ğŸ” "${aramaMetni}" aramasÄ±: ${goruntulenenKartlar} kart bulundu`);
            if (aramaMetni.includes('Ã„') || aramaMetni.includes('Ä±')) {
              console.log(`ğŸ’¡ Normalizasyon: "${aramaMetni}" â†’ "${normalizedArama}"`);
            }
          }
        }, 100);
      });
    }

    function kartSecForDuzenleme(kartAdi) {
      seciliDuzenleKart = kartAdi;
      
      // GÃ¶rsel seÃ§imi gÃ¼ncelle
      const listeDiv = document.getElementById('duzenleKartListesi');
      Array.from(listeDiv.children).forEach(div => {
        const span = div.querySelector('span');
        if (span) {
          const originalName = span.getAttribute('data-original');
          div.style.background = originalName === kartAdi ? '#bbdefb' : 'white';
        }
      });
      
      // Kart bilgilerini gÃ¶ster
      document.getElementById('seciliKartBilgileri').style.display = 'block';
      
      // Mevcut kart Ã¶nizlemesi
      const onizlemeDiv = document.getElementById('mevcutKartOnizleme');
      const temizAd = kartAdi
        .replace(/Ã„Â±/g, 'Ä±').replace(/Ã„/g, 'a')
        .replace(/Ã…/g, 'ÅŸ').replace(/Ä/g, 'ÄŸ')
        .replace(/ÃƒÂ¼/g, 'Ã¼').replace(/ÃƒÂ¶/g, 'Ã¶')
        .replace(/_/g, ' ')
        .replace('.jpg', '');
      
      onizlemeDiv.innerHTML = `
        <div style="display:flex; align-items:center; gap:15px;">
          <img src="https://mustafasacar35.github.io/lipodem-takip-paneli-3/tarifler/${kartAdi}" 
               style="width:80px; height:80px; object-fit:cover; border-radius:8px; border:1px solid #ddd;" 
               onerror="this.style.display='none'; this.nextElementSibling.querySelector('.error-msg').style.display='block'">
          <div>
            <div style="font-weight:bold; font-size:16px;">${temizAd}</div>
            <div style="color:#666; font-size:12px;">Mevcut kart (${kartAdi})</div>
            <div class="error-msg" style="color:#dc3545; font-size:11px; display:none;">âŒ GÃ¶rsel bulunamadÄ±</div>
          </div>
        </div>
      `;
      
      // Yeni adÄ± Ã¶nceden doldur (kullanÄ±cÄ± isterse deÄŸiÅŸtirebilir) - encoding temizleyerek
      const yeniAdiInput = document.getElementById('duzenleKartYeniAdi');
      if (yeniAdiInput) {
        // Dosya uzantÄ±sÄ±nÄ± kaldÄ±r ve encoding sorunlarÄ±nÄ± temizle
        let temizAd = kartAdi.replace('.jpg', '').replace('.jpeg', '').replace('.png', '');
        temizAd = temizAd
          .replace(/Ã„Â±/g, 'i').replace(/Ã„/g, 'a')
          .replace(/Ã…/g, 's').replace(/Ä/g, 'g')
          .replace(/ÃƒÂ¼/g, 'u').replace(/ÃƒÂ¶/g, 'o')
          .replace(/Ã¢/g, 'a').replace(/Ã®/g, 'i')
          .replace(/Ã»/g, 'u').replace(/Ã´/g, 'o');
        yeniAdiInput.value = temizAd;
        console.log(`ğŸ’¡ Kart seÃ§ildi: "${kartAdi}" â†’ TemizlenmiÅŸ ad: "${temizAd}"`);
      }
    }

    // List.json'dan mevcut olmayan dosyalarÄ± temizle
    async function listjsonTemizle() {
      const token = document.getElementById('githubToken').value.trim();
      if (!token) {
        alert('GitHub token gerekli!');
        return;
      }
      
      if (!confirm('Mevcut olmayan dosyalar list.json\'dan temizlenecek. Emin misiniz?')) {
        return;
      }
      
      try {
        console.log('ğŸ”„ List.json temizliÄŸi baÅŸlatÄ±ldÄ±...');
        
        // Ã–nce list.json'u al
        const response = await fetch('https://api.github.com/repos/mustafasacar35/lipodem-takip-paneli-3/contents/tarifler/list.json', {
          headers: {
            'Authorization': `token ${token}`,
            'Accept': 'application/vnd.github.v3+json'
          }
        });
        
        if (!response.ok) {
          throw new Error(`List.json alÄ±namadÄ±: ${response.status}`);
        }
        
        const fileData = await response.json();
        const currentContent = JSON.parse(decodeBase64UTF8(fileData.content));
        
        // Her dosyanÄ±n varlÄ±ÄŸÄ±nÄ± kontrol et
        const validFiles = [];
        let removedCount = 0;
        
        statusGoster('Dosyalar kontrol ediliyor...', 'info');
        
        for (const fileName of currentContent) {
          try {
            const checkResponse = await fetch(`https://mustafasacar35.github.io/lipodem-takip-paneli-3/tarifler/${fileName}`, {
              method: 'HEAD'
            });
            
            if (checkResponse.ok) {
              validFiles.push(fileName);
            } else {
              console.log(`âŒ KaldÄ±rÄ±ldÄ±: ${fileName}`);
              removedCount++;
            }
          } catch (error) {
            console.log(`âŒ KaldÄ±rÄ±ldÄ±: ${fileName} (hata)`);
            removedCount++;
          }
        }
        
        if (removedCount === 0) {
          statusGoster('Temizlenecek dosya bulunamadÄ±. TÃ¼m dosyalar mevcut.', 'success');
          return;
        }
        
        statusGoster(`${removedCount} dosya temizleniyor...`, 'info');
        
        // GÃ¼ncellenmiÅŸ list.json'u gÃ¶nder
        const updateResponse = await fetch('https://api.github.com/repos/mustafasacar35/lipodem-takip-paneli-3/contents/tarifler/list.json', {
          method: 'PUT',
          headers: {
            'Authorization': `token ${token}`,
            'Accept': 'application/vnd.github.v3+json',
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            message: `List.json temizlendi: ${removedCount} dosya kaldÄ±rÄ±ldÄ±`,
            content: encodeUTF8ToBase64(validFiles),
            sha: fileData.sha
          })
        });
        
        if (!updateResponse.ok) {
          throw new Error(`List.json gÃ¼ncellenemedi: ${updateResponse.status}`);
        }
        
        alert(`âœ… BaÅŸarÄ±lÄ±! ${removedCount} mevcut olmayan dosya list.json'dan temizlendi.`);
        
        // Cache'i temizle ve listeyi yenile
        localStorage.removeItem('tarifKartlariCache');
        kartListesiniYenileForDuzenleme();
        
      } catch (error) {
        console.error('List.json temizleme hatasÄ±:', error);
        alert(`âŒ Hata: ${error.message}`);
      }
    }

    // Mevcut olmayan dosyalarÄ± toplu raporla
    let mevcutOlmayanDosyalar = new Set();
    
    function dosyaBulunamadi(dosyaAdi) {
      mevcutOlmayanDosyalar.add(dosyaAdi);
      
      // 2 saniye sonra toplu rapor ver
      setTimeout(() => {
        if (mevcutOlmayanDosyalar.size > 0) {
          const eksikler = Array.from(mevcutOlmayanDosyalar);
          console.log(`ğŸš¨ TOPLU RAPOR: ${eksikler.length} dosya bulunamadÄ±:`);
          eksikler.forEach(dosya => console.log(`  âŒ ${dosya}`));
          console.log('ğŸ’¡ Bu dosyalarÄ± temizlemek iÃ§in "ğŸ§¹ Temizle" butonunu kullanÄ±n');
          mevcutOlmayanDosyalar.clear();
        }
      }, 2000);
    }

    async function kartDuzenlemeKaydet() {
      const yeniAd = document.getElementById('duzenleKartYeniAdi').value.trim();
      const yeniDosya = document.getElementById('duzenleKartYeniDosya').files[0];
      
      if (!seciliDuzenleKart) {
        alert('LÃ¼tfen Ã¶nce dÃ¼zenlenecek kartÄ± seÃ§in!');
        return;
      }
      
      if (!yeniAd) {
        alert('Yeni kart adÄ±nÄ± girin!');
        return;
      }
      
      // Dosya adÄ±nÄ± normalize et
      let normalizeEdilmisAd = yeniAd.toLowerCase()
        .replace(/[Ã§ÄŸÄ±Ã¶ÅŸÃ¼]/g, c => ({'Ã§':'c','ÄŸ':'g','Ä±':'i','Ã¶':'o','ÅŸ':'s','Ã¼':'u'}[c] || c))
        .replace(/[^a-z0-9_]/g, '_')
        .replace(/_+/g, '_')
        .replace(/^_|_$/g, '');
      
      if (!normalizeEdilmisAd.endsWith('.jpg')) {
        normalizeEdilmisAd += '.jpg';
      }
      
      if (normalizeEdilmisAd === seciliDuzenleKart && !yeniDosya) {
        alert('Herhangi bir deÄŸiÅŸiklik yapmadÄ±nÄ±z!');
        return;
      }
      
      const token = document.getElementById('githubToken').value.trim();
      
      try {
        duzenlemeStatusGoster('Kart dÃ¼zenleniyor...', 'info');
        
        const owner = 'mustafasacar35';
        const repo = 'lipodem-takip-paneli-3';
        
        // 1. Eski kartÄ± sil
        if (normalizeEdilmisAd !== seciliDuzenleKart) {
          await kartSilGitHub(seciliDuzenleKart, token, owner, repo, false); // sessiz silme
        }
        
        // 2. Yeni kart ekle
        let gorselBase64;
        if (yeniDosya) {
          // Yeni dosya seÃ§ilmiÅŸse onu kullan
          gorselBase64 = await dosyayiBase64Cevir(yeniDosya);
        } else {
          // Dosya seÃ§ilmemiÅŸse mevcut dosyayÄ± indir ve tekrar yÃ¼kle
          const mevcutResponse = await fetch(`https://mustafasacar35.github.io/lipodem-takip-paneli-3/tarifler/${seciliDuzenleKart}`);
          const mevcutBlob = await mevcutResponse.blob();
          gorselBase64 = await new Promise(resolve => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result.split(',')[1]);
            reader.readAsDataURL(mevcutBlob);
          });
        }
        
        // GitHub'a yeni kartÄ± yÃ¼kle
        // Ã–nce dosyanÄ±n var olup olmadÄ±ÄŸÄ±nÄ± kontrol et (SHA iÃ§in)
        let existingSha = null;
        try {
          const checkResponse = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/tarifler/${normalizeEdilmisAd}`, {
            headers: { 'Authorization': `token ${token}` }
          });
          if (checkResponse.ok) {
            const existingData = await checkResponse.json();
            existingSha = existingData.sha;
            console.log(`ğŸ“„ Mevcut dosya bulundu: ${normalizeEdilmisAd}, SHA: ${existingSha}`);
          }
        } catch (e) {
          console.log(`ğŸ“„ Yeni dosya: ${normalizeEdilmisAd}`);
        }
        
        const uploadPayload = {
          message: `Kart dÃ¼zenlendi: ${seciliDuzenleKart} â†’ ${normalizeEdilmisAd}`,
          content: gorselBase64
        };
        
        // EÄŸer dosya varsa SHA'sÄ±nÄ± ekle
        if (existingSha) {
          uploadPayload.sha = existingSha;
        }
        
        const uploadResponse = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/tarifler/${normalizeEdilmisAd}`, {
          method: 'PUT',
          headers: {
            'Authorization': `token ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(uploadPayload)
        });
        
        if (!uploadResponse.ok) {
          const errorText = await uploadResponse.text();
          console.error('Upload hatasÄ±:', uploadResponse.status, errorText);
          throw new Error(`Yeni kart yÃ¼klenemedi (${uploadResponse.status}): ${errorText}`);
        }
        
        // 3. list.json'u gÃ¼ncelle
        await listJsonGuncelle(token, owner, repo);
        
        duzenlemeStatusGoster(`âœ… Kart baÅŸarÄ±yla dÃ¼zenlendi: ${normalizeEdilmisAd}`, 'success');
        
        // Cache'i temizle ve listeyi yenile
        tariflerKlasoruGorselleri = [];
        await tariflerKlasoruGorselleriniYukle();
        
        setTimeout(() => {
          kartDuzenleFormGizle();
        }, 2000);
        
      } catch (error) {
        console.error('Kart dÃ¼zenleme hatasÄ±:', error);
        duzenlemeStatusGoster(`âŒ Hata: ${error.message}`, 'error');
      }
    }

    function duzenlemeStatusGoster(mesaj, tip = 'info') {
      const statusDiv = document.getElementById('duzenlemeStatus');
      statusDiv.style.display = 'block';
      statusDiv.innerHTML = mesaj;
      
      if (tip === 'success') {
        statusDiv.style.background = '#d4edda';
        statusDiv.style.color = '#155724';
        statusDiv.style.border = '1px solid #c3e6cb';
      } else if (tip === 'error') {
        statusDiv.style.background = '#f8d7da';
        statusDiv.style.color = '#721c24';
        statusDiv.style.border = '1px solid #f5c6cb';
      } else {
        statusDiv.style.background = '#d1ecf1';
        statusDiv.style.color = '#0c5460';
        statusDiv.style.border = '1px solid #bee5eb';
      }
    }

    // YardÄ±mcÄ± fonksiyonlar
    function dosyayiBase64Cevir(dosya) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result.split(',')[1]);
        reader.onerror = reject;
        reader.readAsDataURL(dosya);
      });
    }

    async function kartSilGitHub(kartAdi, token, owner, repo, showAlert = true) {
      // Ã–nce dosyanÄ±n SHA'sÄ±nÄ± al
      const getResponse = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/tarifler/${kartAdi}`, {
        headers: { 'Authorization': `token ${token}` }
      });
      
      if (!getResponse.ok) {
        throw new Error('Dosya bulunamadÄ±');
      }
      
      const fileData = await getResponse.json();
      
      // DosyayÄ± sil
      const deleteResponse = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/tarifler/${kartAdi}`, {
        method: 'DELETE',
        headers: {
          'Authorization': `token ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          message: `Kart silindi: ${kartAdi}`,
          sha: fileData.sha
        })
      });
      
      if (!deleteResponse.ok) {
        throw new Error('Dosya silinemedi');
      }
      
      if (showAlert) {
        console.log(`âœ… ${kartAdi} baÅŸarÄ±yla silindi`);
      }
    }

    async function listJsonGuncelle(token, owner, repo) {
      // Tarifler klasÃ¶rÃ¼ndeki tÃ¼m dosyalarÄ± listele
      const response = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/tarifler`, {
        headers: { 'Authorization': `token ${token}` }
      });
      
      if (!response.ok) throw new Error('KlasÃ¶r iÃ§eriÄŸi alÄ±namadÄ±');
      
      const files = await response.json();
      const imageFiles = files
        .filter(file => file.type === 'file' && /\.(jpg|jpeg|png)$/i.test(file.name))
        .map(file => file.name)
        .sort();
      
      // list.json'un mevcut SHA'sÄ±nÄ± al
      const listResponse = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/tarifler/list.json`, {
        headers: { 'Authorization': `token ${token}` }
      });
      
      let listSha;
      if (listResponse.ok) {
        const listData = await listResponse.json();
        listSha = listData.sha;
      }
      
      // list.json'u gÃ¼ncelle
      const updateResponse = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/tarifler/list.json`, {
        method: 'PUT',
        headers: {
          'Authorization': `token ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          message: 'list.json gÃ¼ncellendi (kart dÃ¼zenleme)',
          content: encodeUTF8ToBase64(imageFiles),
          ...(listSha && { sha: listSha })
        })
      });
      
      if (!updateResponse.ok) {
        throw new Error('list.json gÃ¼ncellenemedi');
      }
    }

    function statusGoster(mesaj, tip = 'info') {
      const statusDiv = document.getElementById('yuklemeStatus');
      statusDiv.style.display = 'block';
      statusDiv.innerHTML = mesaj;
      
      if (tip === 'success') {
        statusDiv.style.background = '#d4edda';
        statusDiv.style.color = '#155724';
        statusDiv.style.border = '1px solid #c3e6cb';
      } else if (tip === 'error') {
        statusDiv.style.background = '#f8d7da';
        statusDiv.style.color = '#721c24';
        statusDiv.style.border = '1px solid #f5c6cb';
      } else {
        statusDiv.style.background = '#d1ecf1';
        statusDiv.style.color = '#0c5460';
        statusDiv.style.border = '1px solid #bee5eb';
      }
    }

    async function yeniKartKaydet() {
      const token = document.getElementById('githubToken').value.trim();
      const kartAdi = document.getElementById('yeniKartAdi').value.trim();
      const dosyaInput = document.getElementById('yeniKartDosya');
      
      // Validasyon
      if (!token) {
        alert('GitHub API token gerekli!');
        return;
      }
      
      if (!kartAdi) {
        alert('Kart adÄ± gerekli!');
        return;
      }
      
      if (!dosyaInput.files || !dosyaInput.files[0]) {
        alert('GÃ¶rsel dosyasÄ± seÃ§in!');
        return;
      }

      // Dosya adÄ±nÄ± normalize et
      let dosyaAdi = kartAdi.toLowerCase()
        .replace(/Ã§/g, 'c').replace(/ÄŸ/g, 'g').replace(/ÅŸ/g, 's')
        .replace(/Ã¼/g, 'u').replace(/Ã¶/g, 'o').replace(/Ä±/g, 'i')
        .replace(/\s+/g, '_')
        .replace(/[^a-z0-9_]/g, '');
      
      if (!dosyaAdi.endsWith('.jpg')) {
        dosyaAdi += '.jpg';
      }

      const dosya = dosyaInput.files[0];
      
      try {
        statusGoster('Dosya hazÄ±rlanÄ±yor...', 'info');
        
        // DosyayÄ± base64'e Ã§evir
        const dosyaBase64 = await new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => {
            const base64 = reader.result.split(',')[1]; // data:image/jpeg;base64, kÄ±smÄ±nÄ± Ã§Ä±kar
            resolve(base64);
          };
          reader.onerror = reject;
          reader.readAsDataURL(dosya);
        });

        const owner = 'mustafasacar35';
        const repo = 'lipodem-takip-paneli-3';
        const branch = 'main';

        statusGoster('GÃ¶rsel GitHub\'a yÃ¼kleniyor...', 'info');

        // 1. Ã–nce dosya var mÄ± kontrol et
        const gorselPath = `tarifler/${dosyaAdi}`;
        let mevcutSha = null;
        
        try {
          const mevcutRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${gorselPath}?ref=${branch}`, {
            headers: { Authorization: `token ${token}` }
          });
          
          if (mevcutRes.ok) {
            const mevcutData = await mevcutRes.json();
            mevcutSha = mevcutData.sha;
            console.log('ğŸ“ Mevcut dosya SHA bulundu:', mevcutSha);
          }
        } catch (e) {
          console.log('ğŸ“ Dosya mevcut deÄŸil, yeni dosya oluÅŸturulacak');
        }

        // 2. GÃ¶rseli tarifler klasÃ¶rÃ¼ne yÃ¼kle
        const gorselPayload = {
          message: `Yeni tarif kartÄ± eklendi: ${dosyaAdi}`,
          content: dosyaBase64,
          branch
        };
        
        // SHA varsa ekle
        if (mevcutSha) {
          gorselPayload.sha = mevcutSha;
        }
        
        const gorselRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${gorselPath}`, {
          method: 'PUT',
          headers: {
            'Authorization': `token ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(gorselPayload)
        });

        if (!gorselRes.ok) {
          const errorText = await gorselRes.text();
          throw new Error('GÃ¶rsel yÃ¼kleme baÅŸarÄ±sÄ±z: ' + errorText);
        }

        statusGoster('list.json gÃ¼ncelleniyor...', 'info');

        // 2. list.json dosyasÄ±nÄ± gÃ¼ncelle
        // Ã–nce mevcut list.json'u al
        const listRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/tarifler/list.json?ref=${branch}`, {
          headers: { Authorization: `token ${token}` }
        });

        if (!listRes.ok) {
          throw new Error('list.json dosyasÄ± alÄ±namadÄ±');
        }

        const listData = await listRes.json();
        const mevcutListe = JSON.parse(decodeBase64UTF8(listData.content));
        
        // Yeni dosyayÄ± listeye ekle (eÄŸer yoksa)
        if (!mevcutListe.includes(dosyaAdi)) {
          mevcutListe.push(dosyaAdi);
          mevcutListe.sort(); // Alfabetik sÄ±rala
        }

        // GÃ¼ncellenmiÅŸ listeyi yÃ¼kle
        const yeniListeContent = encodeUTF8ToBase64(mevcutListe);
        const listUpdateRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/tarifler/list.json`, {
          method: 'PUT',
          headers: {
            'Authorization': `token ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            message: `list.json gÃ¼ncellendi - ${dosyaAdi} eklendi`,
            content: yeniListeContent,
            sha: listData.sha,
            branch
          })
        });

        if (!listUpdateRes.ok) {
          throw new Error('list.json gÃ¼ncelleme baÅŸarÄ±sÄ±z: ' + (await listUpdateRes.text()));
        }

        statusGoster(`âœ… BaÅŸarÄ±lÄ±! ${dosyaAdi} kartÄ± eklendi ve list.json gÃ¼ncellendi.`, 'success');
        
        // Lokal listeyi de gÃ¼ncelle (anÄ±nda gÃ¶rÃ¼nmesi iÃ§in)
        await tariflerKlasoruGorselleriniYukle();
        
        // Formu temizle
        setTimeout(() => {
          yeniKartFormGizle();
        }, 2000);

      } catch (error) {
        console.error('Kart yÃ¼kleme hatasÄ±:', error);
        statusGoster(`âŒ Hata: ${error.message}`, 'error');
      }
    }
    // --- Tarifler klasÃ¶rÃ¼ gÃ¶rsellerini otomatik yÃ¼kle (GitHub Pages uyumlu) ---
    let tariflerKlasoruGorselleri = [];
    
    function durumGuncelle() {
      const durumElement = document.getElementById('tariflerKlasoruDurumu');
      if (durumElement) {
        if (tariflerKlasoruGorselleri.length > 0) {
          durumElement.innerHTML = `âœ… Tarifler klasÃ¶rÃ¼: <span style="color:green; font-weight:bold;">${tariflerKlasoruGorselleri.length} gÃ¶rsel</span>`;
          durumElement.parentElement.style.borderLeftColor = '#28a745';
        } else {
          durumElement.innerHTML = `âš ï¸ Tarifler klasÃ¶rÃ¼: <span style="color:orange; font-weight:bold;">GÃ¶rsel bulunamadÄ±</span> - Manuel yÃ¼kleme gerekli`;
          durumElement.parentElement.style.borderLeftColor = '#ffc107';
        }
      }
    }
    
    async function tariflerKlasoruGorselleriniYukle() {
      const durumElement = document.getElementById('tariflerKlasoruDurumu');
      if (durumElement) {
        durumElement.innerHTML = 'ğŸ”„ Tarifler klasÃ¶rÃ¼ kontrol ediliyor...';
        durumElement.parentElement.style.borderLeftColor = '#6c757d';
      }
      
      try {
        // Her zaman bulunduÄŸun dizinin kÃ¶kÃ¼ne gÃ¶re tarifler/ yolunu oluÅŸtur
        // Ã–nce GitHub'dan tarifler yÃ¼klemeyi deneyelim
        console.log('ğŸŒ GitHub\'dan tarifler yÃ¼kleniyor...');
        const githubTariflerUrl = 'https://mustafasacar35.github.io/lipodem-takip-paneli-3/tarifler/list.json';
        
        try {
          const githubResp = await fetch(githubTariflerUrl);
          if (githubResp.ok) {
            const responseText = await githubResp.text();
            console.log('Tarifler GitHub\'dan yÃ¼klendi (ilk 200 karakter):', responseText.substring(0, 200));
            
            const files = JSON.parse(responseText);
            console.log('GitHub\'dan yÃ¼klenen tarif dosyalarÄ±:', files.length, 'adet');
            
            tariflerKlasoruGorselleri = files.map(name => ({
              name,
              url: 'https://mustafasacar35.github.io/lipodem-takip-paneli-3/tarifler/' + name
            }));
            
            window.tarifKartlari = files;
            console.log('ğŸ”§ window.tarifKartlari GitHub\'dan ayarlandÄ±:', window.tarifKartlari.length, 'kart');
            console.log(`âœ… GitHub\'dan ${tariflerKlasoruGorselleri.length} tarif gÃ¶rsel yÃ¼klendi`);
            
            durumGuncelle();
            return; // BaÅŸarÄ±lÄ±, devam etme
          }
        } catch (githubError) {
          console.warn('âš ï¸ GitHub\'dan tarif yÃ¼kleme baÅŸarÄ±sÄ±z:', githubError.message);
        }
        
        // GitHub baÅŸarÄ±sÄ±z olduysa local denemeyi yap
        console.log('ğŸ“ Local dosya yÃ¼kleme deneniyor...');
        let basePath = window.location.pathname;
        if (!basePath.endsWith('/')) basePath = basePath.substring(0, basePath.lastIndexOf('/') + 1);
        const tariflerPath = window.location.origin + basePath + 'tarifler/';
        
        console.log('Tarifler klasÃ¶rÃ¼ aranÄ±yor:', tariflerPath);
        
        const resp = await fetch(tariflerPath + 'list.json');
        if (!resp.ok) {
          console.warn(`list.json bulunamadÄ± (${resp.status}): ${tariflerPath}list.json`);
          throw new Error(`list.json bulunamadÄ±: ${resp.status} - ${tariflerPath}list.json`);
        }
        
        const responseText = await resp.text();
        console.log('Tarifler klasÃ¶rÃ¼nden ham JSON (ilk 200 karakter):', responseText.substring(0, 200));
        
        let files;
        try {
          files = JSON.parse(responseText);
        } catch (jsonError) {
          console.error('âŒ JSON parsing hatasÄ±:', jsonError.message);
          console.log('ğŸ“„ HatalÄ± JSON iÃ§eriÄŸi (ilk 1000 karakter):', responseText.substring(0, 1000));
          
          // JSON'u satÄ±r satÄ±r kontrol et
          const lines = responseText.split('\n');
          console.log('ğŸ“Š Toplam satÄ±r sayÄ±sÄ±:', lines.length);
          
          // 200-210 arasÄ± satÄ±rlarÄ± gÃ¶ster (hata 204. satÄ±rda)
          for (let i = 200; i < Math.min(210, lines.length); i++) {
            console.log(`âŒ SatÄ±r ${i + 1}: "${lines[i]}"`);
          }
          
          throw new Error(`JSON format hatasÄ±: ${jsonError.message}`);
        }
        
        console.log('Tarifler klasÃ¶rÃ¼nden yÃ¼klenen dosyalar:', files);
        
        tariflerKlasoruGorselleri = files.map(name => ({
          name,
          url: tariflerPath + name
        }));
        
        // Manuel kart ekleme iÃ§in dosya adlarÄ±nÄ± da ayrÄ± bir diziye kaydet
        window.tarifKartlari = files;
        console.log('ğŸ”§ window.tarifKartlari ayarlandÄ±:', window.tarifKartlari.length, 'kart');
        
        console.log(`âœ… Tarifler klasÃ¶rÃ¼nden ${tariflerKlasoruGorselleri.length} gÃ¶rsel yÃ¼klendi`);
        
      } catch (e) {
        console.warn('âš ï¸ Tarifler klasÃ¶rÃ¼ yÃ¼klenemedi:', e.message);
        console.log('ğŸ’¡ Ã‡Ã¶zÃ¼m: Ana dizinde "tarifler/" klasÃ¶rÃ¼ oluÅŸturun ve iÃ§ine list.json dosyasÄ± ekleyin');
        tariflerKlasoruGorselleri = [];
        window.tarifKartlari = []; // Manuel kart ekleme iÃ§in boÅŸ dizi
        console.log('ğŸ”§ window.tarifKartlari boÅŸ dizi olarak ayarlandÄ±');
      }
      
      durumGuncelle();
    }
    tariflerKlasoruGorselleriniYukle();

    // pdf.js worker ayarÄ± (uyumluluk iÃ§in)
    if (window['pdfjsLib']) {
      pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
    }
    // --- Hasta YÃ¶netimi ModÃ¼lÃ¼ ---
    // --- KalÄ±cÄ± veri yÃ¶netimi ---
    const STORAGE_KEY = 'lipedem_hasta_kayitlari';
    function saveToStorage() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(hastalar));
        console.log('ğŸ’¾ Hastalar localStorage\'a kaydedildi');
        // Hasta sayÄ±larÄ±nÄ± gÃ¼ncelle - async olarak Ã§aÄŸÄ±r
        if (typeof guncelleHastaSayilari === 'function') {
          guncelleHastaSayilari().catch(err => console.warn('Hasta sayÄ±larÄ± gÃ¼ncelleme hatasÄ±:', err));
        }
      } catch(e) { console.error('localStorage kaydetme hatasÄ±:', e); }
    }
    
    // Veri deÄŸiÅŸtiÄŸinde otomatik kaydetme
    function autoSaveHastaData(hasta) {
      try {
        if (!hasta) return;
        
        // Global hastalar dizisinde gÃ¼ncelle
        const hastaIndex = hastalar.findIndex(h => h.id === hasta.id);
        if (hastaIndex >= 0) {
          hastalar[hastaIndex] = hasta;
          console.log('ğŸ”„ Hasta verisi gÃ¼ncellendi:', hasta.isim);
        } else {
          hastalar.push(hasta);
          console.log('â• Yeni hasta eklendi:', hasta.isim);
        }
        
        // localStorage'a kaydet
        saveToStorage();
        
        return true;
      } catch(e) { 
        console.error('Otomatik kaydetme hatasÄ±:', e); 
        return false;
      }
    }
    function loadFromStorage() {
      try {
        const data = localStorage.getItem(STORAGE_KEY);
        if (data) return JSON.parse(data);
      } catch(e) { console.error('localStorage okuma hatasÄ±:', e); }
      return null;
    }

    // BaÅŸlangÄ±Ã§ verisi veya storage'dan yÃ¼kle
    let hastalar = loadFromStorage() || [
      { id: 1, isim: "AyÅŸe YÄ±lmaz", not: "Hashimoto tiroiditi var", arsiv: false },
      { id: 2, isim: "Fatma Demir", not: "Zeytin sevmez", arsiv: false },
      { id: 3, isim: "Zeynep Kaya", not: "3. haftada kabÄ±zlÄ±k yaÅŸandÄ±", arsiv: true }
    ];
    
    // YENÄ° SÄ°STEM: Global hasta listesi
    let hastaListesi = [];
    
    // TemizlenmiÅŸ verileri kaydet
    if (hastalar.length > 0) {
      saveToStorage();
      console.log('ğŸ’¾ TemizlenmiÅŸ veriler localStorage\'a kaydedildi');
    }
    
    // Hasta listesini otomatik sÄ±rala (isim sÄ±rasÄ±) - gÃ¼venli sÄ±ralama
    hastalar.sort((a, b) => {
      const isimA = (a.isim || a.ad || '').toString();
      const isimB = (b.isim || b.ad || '').toString();
      return isimA.localeCompare(isimB, 'tr');
    });
    
    // === YENÄ° SÄ°STEM: SIDEBAR HASTA LÄ°STESÄ° ===
    
    // Yeni sistemden hasta listesini renderla
    async function renderHastalarYeniSistem() {
      const ul = document.getElementById('hastaListesi');
      const ara = document.getElementById('hastaAra').value.toLowerCase();
      const filtre = document.getElementById('arsivFiltre').value;
      ul.innerHTML = '<li style="padding: 10px; text-align: center; color: #666;">YÃ¼kleniyor...</li>';
      
      try {
        // Token kontrolÃ¼
        const token = document.getElementById('githubToken').value.trim();
        if (!token) {
          ul.innerHTML = '<li style="padding: 10px; text-align: center; color: #dc3545;">âš ï¸ GitHub token gerekli</li>';
          return;
        }
        
        // GitHub'dan hasta listesini al ve global deÄŸiÅŸkeni gÃ¼ncelle
        const yuklenmisList = await hastaListesiYukle();
        
        if (yuklenmisList.length === 0) {
          ul.innerHTML = '<li style="padding: 10px; text-align: center; color: #666;">HenÃ¼z hasta kaydÄ± yok - Yeni hasta ekleyebilirsiniz</li>';
          return;
        }
        
        ul.innerHTML = '';
        
        // Filtreleme ve sÄ±ralama - yÃ¼klenen listeyi kullan
        const filtreliHastalar = yuklenmisList.filter(hasta => {
          const hastaIsim = hasta.isim || hasta.ad || '';
          const aramaUygun = hastaIsim.toLowerCase().includes(ara);
          const filtreUygun = filtre === 'hepsi' || 
                             (filtre === 'aktif' && !hasta.arsiv) || 
                             (filtre === 'arsiv' && hasta.arsiv);
          return aramaUygun && filtreUygun;
        });
        
        // Hasta sayÄ±larÄ±nÄ± gÃ¼ncelle - yÃ¼klenen listeyi kullan
        const aktifSayisi = yuklenmisList.filter(h => !h.arsiv).length;
        const arsivSayisi = yuklenmisList.filter(h => h.arsiv).length;
        console.log(`ğŸ“Š Yeni sistem hasta sayÄ±larÄ±: Aktif=${aktifSayisi}, ArÅŸiv=${arsivSayisi}, Toplam=${yuklenmisList.length}`);
        
        // Filtreleme ve hasta hafta verilerini analiz etme
        const hastalarVeriAnaliziIle = await Promise.all(filtreliHastalar.map(async (hasta) => {
          const hastaIsim = hasta.isim || hasta.ad || 'Bilinmeyen Hasta';
          
          // En bÃ¼yÃ¼k hafta sayÄ±sÄ±nÄ± bul - sadece localStorage'a bak (gÃ¼venilir kaynak)
          let maxHafta = 0;
          let hastaDetayiBulundu = false;
          
          // Ã–nce localStorage'dan kontrol et (Ã–NCELIK: localStorage)
          const localHasta = hastalar.find(h => h && h.id === hasta.id);
          if (localHasta && localHasta.haftalar && localHasta.haftalar.length > 0) {
            const haftaNumaralari = localHasta.haftalar.map(h => h.haftaNo || h.hafta || 0);
            maxHafta = Math.max(...haftaNumaralari);
            hastaDetayiBulundu = true;
            console.log(`ğŸ“Š Hasta ${hastaIsim} - localStorage'dan hafta bilgisi alÄ±ndÄ±: maxHafta=${maxHafta}, haftalar: [${haftaNumaralari.join(', ')}]`);
          }
          
          // localStorage'da bulunamadÄ±ysa GitHub'dan dene (opsiyonel ve sadece yedek)
          if (!hastaDetayiBulundu && hasta.id) {
            try {
              const dosyaAdlari = [
                generateFileName({ id: hasta.id, isim: hasta.isim }),
                generateFileName({ isim: hasta.isim })
              ];
              
              for (const dosyaAdi of dosyaAdlari) {
                try {
                  const response = await fetch(`https://api.github.com/repos/mustafasacar35/lipodem-takip-paneli-3/contents/patients/${dosyaAdi}`, {
                    headers: { 'Authorization': `token ${token}` }
                  });
                  
                  if (response.ok) {
                    const data = await response.json();
                    const hastaDetay = JSON.parse(decodeBase64UTF8(data.content));
                    if (hastaDetay.haftalar && hastaDetay.haftalar.length > 0) {
                      const haftaNumaralari = hastaDetay.haftalar.map(h => h.haftaNo || h.hafta || 0);
                      const githubMaxHafta = Math.max(...haftaNumaralari);
                      
                      // âš ï¸ UYARI: GitHub verisi localStorage'Ä± geÃ§ersiz kÄ±lmasÄ±n
                      // Sadece localStorage boÅŸsa GitHub verisini kullan
                      maxHafta = githubMaxHafta;
                      hastaDetayiBulundu = true;
                      console.log(`ğŸ“Š Hasta ${hastaIsim} - GitHub'dan yedek hafta bilgisi alÄ±ndÄ±: maxHafta=${githubMaxHafta}, haftalar: [${haftaNumaralari.join(', ')}]`);
                      break;
                    }
                  } else if (response.status === 404) {
                    // Hasta dosyasÄ± bulunamadÄ±, diÄŸer dosya adlarÄ±nÄ± dene
                    continue;
                  }
                } catch (e) {
                  // Sessizce geÃ§
                }
              }
            } catch (e) {
              // Sessizce geÃ§
            }
          }
          
          return {
            ...hasta,
            maxHafta: maxHafta,
            hastaIsim: hastaIsim,
            hastaDetayiBulundu: hastaDetayiBulundu
          };
        }));
        
        // En bÃ¼yÃ¼k hafta numarasÄ±na gÃ¶re sÄ±rala, aynÄ± hafta numarasÄ± olanlarda alfabetik
        hastalarVeriAnaliziIle.sort((a, b) => {
          if (a.maxHafta !== b.maxHafta) {
            return a.maxHafta - b.maxHafta; // KÃ¼Ã§Ã¼k haftadan bÃ¼yÃ¼k haftaya
          }
          return a.hastaIsim.localeCompare(b.hastaIsim, 'tr'); // Alfabetik sÄ±ralama
        });
        
        hastalarVeriAnaliziIle.forEach((hasta, index) => {
          const li = document.createElement('li');
          
          // Hafta sayÄ±sÄ±na gÃ¶re renk belirleme
          const getHaftaRengi = (haftaNo) => {
            const renkPaleti = [
              // Hafta 0 - PDF Yok
              { background: 'linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%)', borderColor: '#dee2e6', textColor: '#6c757d' },
              // Hafta 1 - AÃ§Ä±k Mavi
              { background: 'linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%)', borderColor: '#2196f3', textColor: '#0d47a1' },
              // Hafta 2 - Cyan
              { background: 'linear-gradient(135deg, #e0f7fa 0%, #80deea 100%)', borderColor: '#00bcd4', textColor: '#006064' },
              // Hafta 3 - Teal
              { background: 'linear-gradient(135deg, #e0f2f1 0%, #80cbc4 100%)', borderColor: '#009688', textColor: '#004d40' },
              // Hafta 4 - YeÅŸil
              { background: 'linear-gradient(135deg, #e8f5e8 0%, #a5d6a7 100%)', borderColor: '#4caf50', textColor: '#1b5e20' },
              // Hafta 5 - AÃ§Ä±k YeÅŸil
              { background: 'linear-gradient(135deg, #f1f8e9 0%, #c5e1a5 100%)', borderColor: '#8bc34a', textColor: '#33691e' },
              // Hafta 6 - Lime
              { background: 'linear-gradient(135deg, #f9fbe7 0%, #dcedc8 100%)', borderColor: '#cddc39', textColor: '#827717' },
              // Hafta 7 - SarÄ±
              { background: 'linear-gradient(135deg, #fffde7 0%, #fff176 100%)', borderColor: '#ffeb3b', textColor: '#f57f17' },
              // Hafta 8 - Amber
              { background: 'linear-gradient(135deg, #fff8e1 0%, #ffcc02 100%)', borderColor: '#ffc107', textColor: '#ff6f00' },
              // Hafta 9 - Turuncu
              { background: 'linear-gradient(135deg, #fff3e0 0%, #ffb74d 100%)', borderColor: '#ff9800', textColor: '#e65100' },
              // Hafta 10 - Koyu Turuncu
              { background: 'linear-gradient(135deg, #fbe9e7 0%, #ffab91 100%)', borderColor: '#ff5722', textColor: '#d84315' },
              // Hafta 11 - KÄ±rmÄ±zÄ±
              { background: 'linear-gradient(135deg, #ffebee 0%, #ef9a9a 100%)', borderColor: '#f44336', textColor: '#c62828' },
              // Hafta 12 - Pink
              { background: 'linear-gradient(135deg, #fce4ec 0%, #f48fb1 100%)', borderColor: '#e91e63', textColor: '#ad1457' },
              // Hafta 13 - Mor
              { background: 'linear-gradient(135deg, #f3e5f5 0%, #ce93d8 100%)', borderColor: '#9c27b0', textColor: '#6a1b9a' }
            ];

            if (haftaNo === 0) {
              return renkPaleti[0];
            } else if (haftaNo >= 1 && haftaNo <= 13) {
              return renkPaleti[haftaNo];
            } else {
              // 14+ hafta iÃ§in Ã¶zel altÄ±n renk (baÅŸarÄ± ve deneyim)
              return {
                background: 'linear-gradient(135deg, #fff8e1 0%, #ffd54f 100%)',
                borderColor: '#ff8f00',
                textColor: '#e65100'
              };
            }
          };
          
          const renkSemasi = getHaftaRengi(hasta.maxHafta);
          
          li.style.cssText = `cursor: pointer; padding: 8px 12px; border-radius: 8px; margin-bottom: 3px; 
                             background: ${renkSemasi.background}; 
                             border-left: 4px solid ${renkSemasi.borderColor}; 
                             border: 1px solid ${renkSemasi.borderColor}20;
                             box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                             transition: all 0.3s ease;`;
          
          // Hover efekti iÃ§in
          li.onmouseenter = () => {
            li.style.transform = 'translateX(3px)';
            li.style.boxShadow = '0 4px 8px rgba(0,0,0,0.15)';
          };
          li.onmouseleave = () => {
            li.style.transform = 'translateX(0)';
            li.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)';
          };
          
          // Ä°sim div'ini ayrÄ± oluÅŸtur - hafta bilgisiyle birlikte
          const isimDiv = document.createElement('div');
          isimDiv.style.cssText = `font-weight: bold; color: ${hasta.arsiv ? '#6c757d' : renkSemasi.textColor}; font-size: 13px;`;
          
          // SÄ±ra numarasÄ±nÄ± ekle
          const siraSpan = document.createElement('span');
          siraSpan.style.cssText = `color: ${renkSemasi.textColor}80; font-weight: normal; margin-right: 8px;`;
          siraSpan.textContent = `${index + 1}.`;
          isimDiv.appendChild(siraSpan);
          
          // Ä°sim kÄ±smÄ±nÄ± ekle
          const isimSpan = document.createElement('span');
          isimSpan.textContent = `${hasta.arsiv ? '  ' : ''}${hasta.hastaIsim.toUpperCase()}`;
          isimDiv.appendChild(isimSpan);
          
          // Hafta bilgisini ekle (renkli)
          const haftaSpan = document.createElement('span');
          haftaSpan.style.cssText = `color: ${renkSemasi.borderColor}; font-weight: bold; font-size: 11px;`; // Border renginde ve bold
          if (hasta.maxHafta > 0) {
            haftaSpan.textContent = ` (${hasta.maxHafta}. hafta)`;
          } else {
            haftaSpan.textContent = ` (pdf yok)`;
          }
          isimDiv.appendChild(haftaSpan);
          
          li.appendChild(isimDiv);
          
          // Not varsa ekle
          if (hasta.not) {
            const notDiv = document.createElement('div');
            notDiv.style.cssText = `font-size: 11px; color: ${renkSemasi.textColor}90; margin-top: 2px;`;
            notDiv.textContent = hasta.not; // textContent kullan
            li.appendChild(notDiv);
          }
          
          li.onclick = () => hastaSecYeniSistem(hasta);
          li.dataset.hastaId = hasta.id;
          li.classList.add('hasta-item'); // CSS vurgulama iÃ§in
          ul.appendChild(li);
        });
        
        console.log(`âœ… Yeni sistem hasta listesi gÃ¼ncellendi: ${filtreliHastalar.length} hasta gÃ¶steriliyor`);
        
        // Sidebar'daki hasta sayÄ±larÄ±nÄ± gÃ¼ncelle
        await guncelleHastaSayilari();
        
        // Toplu ZIP butonunu ekle
        ekleTopluZipButonu();
        
      } catch (error) {
        console.error('âŒ Yeni sistem hasta listesi yÃ¼kleme hatasÄ±:', error);
        ul.innerHTML = '<li style="padding: 10px; text-align: center; color: #dc3545;">Hasta listesi yÃ¼klenemedi</li>';
      }
    }
    
    // Yeni sistemde hasta seÃ§me
    async function hastaSecYeniSistem(hastaBilgi) {
      try {
        console.log('ğŸ‘¤ Yeni sistemde hasta seÃ§iliyor:', hastaBilgi.isim);
        console.log('  GitHub\'dan hasta bilgileri alÄ±nÄ±yor:', hastaBilgi.isim);
        
        const owner = 'mustafasacar35';
        const repo = 'lipodem-takip-paneli-3';
        
        // Dosya adÄ± alternatifleri dene
        const dosyaAdlari = [
          generateFileName({ id: hastaBilgi.id, isim: hastaBilgi.isim }),
          generateFileName({ id: hastaBilgi.id, isim: turkceKarakterDuzelt(hastaBilgi.isim) }),
          generateFileName({ isim: hastaBilgi.isim }),
          generateFileName({ isim: turkceKarakterDuzelt(hastaBilgi.isim) })
        ];
        
        // Ã‡ift entryleri kaldÄ±r
        const benzersizDosyaAdlari = [...new Set(dosyaAdlari)];
        
        console.log('ğŸ” Denenen dosya adlarÄ±:', benzersizDosyaAdlari);
        
        let hastaDetay = null;
        let bulunanDosya = null;
        
        // Her dosya adÄ±nÄ± sÄ±rayla dene
        for (const dosyaAdi of benzersizDosyaAdlari) {
          try {
            console.log(`ğŸ” Denenen dosya: ${dosyaAdi}`);
            const token = document.getElementById('githubToken').value.trim();
            const headers = token ? { 'Authorization': `token ${token}` } : {};
            const response = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/patients/${dosyaAdi}`, { headers });
            
            if (response.ok) {
              const data = await response.json();
              hastaDetay = JSON.parse(decodeBase64UTF8(data.content));
              bulunanDosya = dosyaAdi;
              console.log(`âœ… Dosya bulundu: ${dosyaAdi}`);
              break;
            }
          } catch (e) {
            console.log(`âŒ Dosya bulunamadÄ±: ${dosyaAdi}`);
          }
        }
        
        if (hastaDetay) {
          // â­ YENÄ° YAKLAÅIM: localStorage'Ä± temel al, GitHub'Ä± sadece eksik PDF'ler iÃ§in kullan
          if (seciliHasta && seciliHasta.id === hastaDetay.id && seciliHasta.haftalar) {
            console.log('ğŸ”„ localStorage verisi temel alÄ±nÄ±yor, GitHub sadece eksik PDF baÄŸlantÄ±larÄ± iÃ§in kullanÄ±lacak');
            
            // LocalStorage'daki hafta verilerini koru
            const mevcutHaftalar = seciliHasta.haftalar || [];
            const gitHubHaftalar = hastaDetay.haftalar || [];
            
            console.log('ğŸ” MEVCUT HAFTALAR (localStorage - Temel):', mevcutHaftalar.map(h => ({ haftaNo: h.haftaNo, baslangic: h.baslangic, bitis: h.bitis })));
            console.log('ğŸ” GITHUB HAFTALAR (Sadece PDF link iÃ§in):', gitHubHaftalar.map(h => ({ haftaNo: h.haftaNo, baslangic: h.baslangic, bitis: h.bitis })));
            
            // LocalStorage verilerini temel al, sadece GitHub'dan PDF linklerini al
            const birlesikHaftalar = mevcutHaftalar.map(mevcutHafta => {
              const githubHafta = gitHubHaftalar.find(gh => gh.haftaNo === mevcutHafta.haftaNo);
              if (githubHafta) {
                // Sadece PDF ile ilgili alanlarÄ± GitHub'dan al
                return {
                  ...mevcutHafta, // localStorage verisi Ã¶ncelikli
                  // GitHub'dan sadece PDF linklerini al
                  ...(githubHafta.githubUrl && { githubUrl: githubHafta.githubUrl }),
                  ...(githubHafta.githubLink && { githubLink: githubHafta.githubLink }),
                  ...(githubHafta.indirmeUrl && { indirmeUrl: githubHafta.indirmeUrl }),
                  ...(githubHafta.githubRawLink && { githubRawLink: githubHafta.githubRawLink }),
                  ...(githubHafta.pdfGithubPath && { pdfGithubPath: githubHafta.pdfGithubPath })
                };
              }
              return mevcutHafta;
            });
            
            console.log('âœ… Hafta verileri localStorage temel alÄ±narak hazÄ±rlandÄ±:', birlesikHaftalar.length, 'hafta');
            
            // Hasta verisini gÃ¼ncelle (localStorage Ã¶ncelikli)
            hastaDetay.haftalar = birlesikHaftalar;
            seciliHasta.haftalar = birlesikHaftalar;
            
          } else {
            // Yeni hasta veya hafta verisi yok - GitHub verisini al
            console.log('ğŸ†• GitHub\'dan hasta verisi alÄ±nÄ±yor:', hastaDetay.isim);
          }
          
          // Cache'i de gÃ¼ncelle (Ã§oklu PDF iÅŸlemi iÃ§in)
          if (typeof cokluPdfHastaCache !== 'undefined') {
            const cacheKey = hastaDetay.isim.toUpperCase();
            cokluPdfHastaCache.set(cacheKey, hastaDetay);
            console.log(`ğŸ”„ Cache gÃ¼ncellendi: ${hastaDetay.isim} - Hafta sayÄ±sÄ±: ${hastaDetay.haftalar?.length || 0}`);
          }
          
          // Global deÄŸiÅŸkeni gÃ¼ncelle
          seciliHasta = hastaDetay;
          
          // Otomatik kaydet - hasta verilerini localStorage'a kaydet
          autoSaveHastaData(seciliHasta);
          
          // UI'Ä± gÃ¼ncelle
          const secilenHastaIsim = document.getElementById('secilenHastaIsim');
          const secilenHastaNot = document.getElementById('secilenHastaNot');
          const hastaBilgiButonlar = document.getElementById('hastaBilgiButonlar');
          
          if (secilenHastaIsim) secilenHastaIsim.textContent = hastaDetay.isim;
          if (secilenHastaNot) secilenHastaNot.textContent = hastaDetay.not || 'Not yok';
          if (hastaBilgiButonlar) hastaBilgiButonlar.style.display = 'block'; // ButonlarÄ± gÃ¶ster
          
          // SeÃ§ili hastayÄ± vurgula
          vurgulaSeciliHasta(hastaBilgi.id);
          
          console.log('âœ… Yeni sistemde hasta bilgileri yÃ¼klendi:', hastaDetay.isim);
          
          // Hafta tablarÄ±nÄ± gÃ¶ster
          gosterHaftalar();
          
          // EÅŸleÅŸmeyenler listesini gÃ¼ncelle (hasta deÄŸiÅŸtiÄŸinde)
          setTimeout(() => {
            try {
              if (typeof eslesmeyenlerListesiniGuncelle === 'function') {
                eslesmeyenlerListesiniGuncelle();
              } else {
                console.warn('âš ï¸ eslesmeyenlerListesiniGuncelle fonksiyonu henÃ¼z yÃ¼klenmemiÅŸ (hasta deÄŸiÅŸimi)');
              }
            } catch (error) {
              console.warn('âš ï¸ eslesmeyenlerListesiniGuncelle hatasÄ± (hasta deÄŸiÅŸimi):', error.message);
            }
          }, 1000);
          
        } else {
          throw new Error(`Hasta dosyasÄ± bulunamadÄ±. Denenen dosyalar: ${benzersizDosyaAdlari.join(', ')}`);
        }
        
      } catch (error) {
        console.error('âŒ Yeni sistemde hasta seÃ§me hatasÄ±:', error);
        alert(`Hasta detaylarÄ± yÃ¼klenemedi: ${error.message}`);
      }
    }

    // === ESKÄ° SÄ°STEM (GERÄ°YE UYUMLULUK) ===

    // ESKÄ° SÄ°STEM DEVRE DIÅI - Yeni sisteme yÃ¶nlendir
    function renderHastalar() {
      console.log('âš ï¸ renderHastalar Ã§aÄŸrÄ±ldÄ±, yeni sisteme yÃ¶nlendiriliyor...');
      renderHastalarYeniSistem();
    }

    // HastanÄ±n en son PDF yÃ¼klenen haftasÄ±nÄ± bul
    function getEnSonPdfHafta(hasta) {
      if (!hasta.haftalar || hasta.haftalar.length === 0) return 0;
      
      let enSonPdfHafta = 0;
      hasta.haftalar.forEach(hafta => {
        if (hafta.pdf && hafta.haftaNo > enSonPdfHafta) {
          enSonPdfHafta = hafta.haftaNo;
        }
      });
      
      return enSonPdfHafta;
    }

    function vurgulaSeciliHasta(hastaId) {
      // Ã–nce tÃ¼m hasta vurgularÄ±nÄ± kaldÄ±r
      const tumHastalar = document.querySelectorAll('.hasta-item');
      tumHastalar.forEach(hasta => {
        hasta.classList.remove('secili-hasta');
      });
      
      // SeÃ§ilen hastayÄ± vurgula
      const secilenHasta = document.querySelector(`[data-hasta-id="${hastaId}"]`);
      if (secilenHasta) {
        secilenHasta.classList.add('secili-hasta');
        console.log('âœ… Hasta vurgulandÄ±:', hastaId);
      } else {
        console.log('âš ï¸ Vurgulanacak hasta bulunamadÄ±:', hastaId);
      }
    }

    function filtreleHastalar() { 
      // Yeni sistem kullanÄ±yorsa
      if (typeof renderHastalarYeniSistem === 'function') {
        renderHastalarYeniSistem();
      } else {
        // Eski sistem fallback
        renderHastalar();
      }
    }

    async function guncelleHastaSayilari() {
      try {
        // Yeni sistemden hasta listesini al
        const hastaData = await hastaListesiYukle();
        
        let aktifSayisi = 0;
        let arsivSayisi = 0;
        
        hastaData.forEach(hasta => {
          // arsiv property'sini kontrol et
          if (hasta.arsiv) {
            arsivSayisi++;
          } else {
            aktifSayisi++;
          }
        });
        
        const tumSayisi = hastaData.length;
        
        console.log(`ğŸ“Š Yeni sistem hasta sayÄ±larÄ±: Aktif=${aktifSayisi}, ArÅŸiv=${arsivSayisi}, Toplam=${tumSayisi}`);
        
        // Select option'larÄ±nÄ± gÃ¼ncelle
        const arsivFiltre = document.getElementById('arsivFiltre');
        if (arsivFiltre) {
          const mevcutSecim = arsivFiltre.value || 'aktif'; // Mevcut seÃ§imi al
          
          arsivFiltre.innerHTML = `
            <option value="aktif">Aktif Hastalar (${aktifSayisi})</option>
            <option value="arsiv">ArÅŸiv (${arsivSayisi})</option>
            <option value="tum">TÃ¼mÃ¼ (${tumSayisi})</option>
          `;
          
          // SeÃ§ili deÄŸeri geri yÃ¼kle
          arsivFiltre.value = mevcutSecim;
        }
        
      } catch (error) {
        console.error('Hasta sayÄ±larÄ± gÃ¼ncellenirken hata:', error);
      }
    }

    function yeniHastaFormu() {
      console.log('ğŸ†• Yeni hasta ekleme baÅŸlatÄ±ldÄ± (YENÄ° SÄ°STEM)');
      
      // Yeni hasta ismini iste
      const yeniIsim = prompt('Yeni hasta ismini girin:');
      if (yeniIsim === null) return; // Ä°ptal edildi
      
      const temizIsim = yeniIsim.trim();
      if (!temizIsim) {
        alert('Ä°sim boÅŸ olamaz!');
        return;
      }
      
      // Yeni hasta notunu iste
      const yeniNot = prompt('Hasta notu (opsiyonel):');
      if (yeniNot === null) return; // Ä°ptal edildi
      
      // ARTIK KARÄ°KATER DÃœZELTMESÄ° YAPMA - OLDUÄU GÄ°BÄ° KULLAN
      const duzeltilmisIsim = temizIsim;
      
      // AynÄ± isimde hasta var mÄ± kontrol et (hem eski hem yeni sistemde)
      const mevcutHastaEski = hastalar.find(h => h && h.isim && h.isim.toLowerCase() === duzeltilmisIsim.toLowerCase());
      if (mevcutHastaEski) {
        alert('Bu isimde bir hasta zaten mevcut! (Eski sistem)');
        return;
      }
      
      // Yeni sistemde de kontrol et
      const mevcutHastaYeni = hastaListesi.find(h => h && h.isim && h.isim.toLowerCase() === duzeltilmisIsim.toLowerCase());
      if (mevcutHastaYeni) {
        alert('Bu isimde bir hasta zaten mevcut! (Yeni sistem)');
        return;
      }
      
      // Yeni hasta oluÅŸtur
      const yeniHasta = {
        id: Date.now(),
        isim: duzeltilmisIsim,
        not: yeniNot ? yeniNot.trim() : '',
        arsiv: false,
        haftalar: [],
        olusturmaTarihi: new Date().toISOString(),
        yeniSistem: true
      };
      
      console.log('âœ… Yeni hasta oluÅŸturuldu:', duzeltilmisIsim);
      
      // YENÄ° SÄ°STEME KAYDET
      // 1. Ã–nce individual hasta dosyasÄ± olarak kaydet
      hastayiAyriKaydet(yeniHasta).then(basarili => {
        if (basarili) {
          console.log('âœ… Yeni hasta GitHub\'a kaydedildi:', duzeltilmisIsim);
          
          // 2. Global hasta listesini gÃ¼ncelle
          const yeniHastaListeItem = {
            id: yeniHasta.id,
            isim: yeniHasta.isim,
            olusturmaTarihi: yeniHasta.olusturmaTarihi,
            arsiv: yeniHasta.arsiv || false
          };
          hastaListesi.push(yeniHastaListeItem);
          hastaListesi.sort((a, b) => {
            if (!a || !a.isim) return 1;
            if (!b || !b.isim) return -1;
            return a.isim.localeCompare(b.isim, 'tr');
          });
          console.log('âœ… Global hasta listesi gÃ¼ncellendi');
          
          // 3. Hasta listesini yeniden render et
          renderHastalarYeniSistem();
          
          // 4. Yeni hastayÄ± seÃ§
          seciliHasta = yeniHasta;
          
          // 5. BaÅŸarÄ± mesajÄ±
          alert(`âœ… Yeni hasta baÅŸarÄ±yla eklendi!\n\nğŸ‘¤ ${duzeltilmisIsim}\nğŸ“ Yeni sistem ile kaydedildi`);
          
        } else {
          console.error('âŒ GitHub kaydetme baÅŸarÄ±sÄ±z');
          alert('âŒ Hasta oluÅŸturuldu ama GitHub\'a kaydedilemedi!\nLÃ¼tfen GitHub token kontrolÃ¼ yapÄ±n.');
        }
      }).catch(error => {
        console.error('âŒ Hasta kaydetme hatasÄ±:', error);
        alert('âŒ Hasta kaydetme hatasÄ±: ' + error.message);
      });
      
      // ESKÄ° SÄ°STEME EKLEME (sadece local olarak - geriye uyumluluk iÃ§in)
      hastalar.push(yeniHasta);
      hastalar.sort((a, b) => {
        if (!a || !a.isim) return 1;
        if (!b || !b.isim) return -1;
        return a.isim.localeCompare(b.isim, 'tr');
      });
      saveToStorage();
      renderHastalar();
    }

    function iptalHastaFormu() {
      // Eski form elementleri kaldÄ±rÄ±ldÄ±
      console.log('Form iptal edildi');
    }

    function hastaDetayGoster(id) {
      seciliHasta = hastalar.find(h => h.id === id);
      if (!seciliHasta) return;
      
      const hastaIsim = seciliHasta.isim || seciliHasta.ad || 'Bilinmeyen Hasta';
      console.log(`ğŸ‘¤ Hasta seÃ§ildi: ${hastaIsim}`);
      
      // Hasta bilgi panelini gÃ¼ncelle ve gÃ¶ster
      const hastaBilgiPanel = document.getElementById('hastaBilgiPanel');
      const secilenHastaIsim = document.getElementById('secilenHastaIsim');
      const secilenHastaNot = document.getElementById('secilenHastaNot');
      
      console.log('ğŸ” Hasta bilgi paneli elementleri:', {
        hastaBilgiPanel: !!hastaBilgiPanel,
        secilenHastaIsim: !!secilenHastaIsim,
        secilenHastaNot: !!secilenHastaNot
      });
      
      if (hastaBilgiPanel && secilenHastaIsim && secilenHastaNot) {
        secilenHastaIsim.textContent = turkceKarakterDuzelt(hastaIsim);
        secilenHastaNot.textContent = seciliHasta.not || 'Not bulunmuyor';
        
        // ButonlarÄ± gÃ¶ster
        const hastaBilgiButonlar = document.getElementById('hastaBilgiButonlar');
        if (hastaBilgiButonlar) {
          hastaBilgiButonlar.style.display = 'block';
        }
        
        console.log('âœ… Hasta bilgi paneli gÃ¼ncellendi:', hastaIsim);
      } else {
        console.log('âŒ Hasta bilgi paneli elementleri bulunamadÄ±!');
      }
      
      // Sol sidebar'da aktif hastayÄ± vurgula
      renderHastalar();
      
      // Hafta listesini gÃ¶ster (center panel'de)
      gosterHaftalar();
      
      // Sidebar'larÄ± gÃ¼ncelle
      hastaSecildiginde(hastalar.findIndex(h => h.id === id));
      
      console.log(`âœ… ${hastaIsim} iÃ§in hafta tablarÄ± yÃ¼klendi ve aktif hafta otomatik seÃ§ilecek`);
    }

    function duzenleHasta() {
      if (!seciliHasta) return;
      
      const hastaIsim = seciliHasta.isim || seciliHasta.ad || 'Bilinmeyen Hasta';
      console.log('Hasta dÃ¼zenleme iÃ§in:', hastaIsim);
      
      // Mevcut bilgileri al
      const mevcutIsim = seciliHasta.isim || seciliHasta.ad || '';
      const mevcutNot = seciliHasta.not || '';
      
      // Yeni isim iste
      const yeniIsim = prompt('Hasta ismini dÃ¼zenleyin:', mevcutIsim);
      if (yeniIsim === null) return; // Ä°ptal edildi
      
      const temizIsim = yeniIsim.trim();
      if (!temizIsim) {
        alert('Ä°sim boÅŸ olamaz!');
        return;
      }
      
      // Yeni not iste
      const yeniNot = prompt('Hasta notunu dÃ¼zenleyin:', mevcutNot);
      if (yeniNot === null) return; // Ä°ptal edildi
      
      // ARTIK KARÄ°KATER DÃœZELTMESÄ° YAPMA - OLDUÄU GÄ°BÄ° KULLAN
      const duzeltilmisIsim = temizIsim;
      
      // DeÄŸiÅŸiklikleri kaydet
      seciliHasta.isim = duzeltilmisIsim;
      seciliHasta.not = yeniNot.trim();
      
      // Verileri kaydet
      saveToStorage();
      
      // EkranÄ± gÃ¼ncelle
      const secilenHastaIsim = document.getElementById('secilenHastaIsim');
      const secilenHastaNot = document.getElementById('secilenHastaNot');
      
      if (secilenHastaIsim) {
        secilenHastaIsim.textContent = duzeltilmisIsim;
      }
      if (secilenHastaNot) {
        secilenHastaNot.textContent = seciliHasta.not || 'Not bulunmuyor';
      }
      
      // Hasta listesini yenile ve sÄ±rala
      hastalar.sort((a, b) => {
        if (!a || !a.isim) return 1;
        if (!b || !b.isim) return -1;
        return a.isim.localeCompare(b.isim, 'tr');
      });
      renderHastalar();
      
      console.log(`âœ… Hasta bilgileri gÃ¼ncellendi: ${mevcutIsim} â†’ ${duzeltilmisIsim}`);
      
      // YENÄ° SÄ°STEM HASTA LÄ°STESÄ°NDE Ä°SMÄ° GÃœNCELLE
      const hastaListeItem = hastaListesi.find(h => h && h.id === seciliHasta.id);
      if (hastaListeItem) {
        hastaListeItem.isim = duzeltilmisIsim;
        console.log('âœ… Yeni sistem hasta listesinde isim gÃ¼ncellendi');
      }
      
      // YENÄ° SÄ°STEME KAYDET
      hastayiAyriKaydet(seciliHasta).then(basarili => {
        if (basarili) {
          console.log('âœ… Hasta gÃ¼ncellemesi GitHub\'a kaydedildi:', duzeltilmisIsim);
          renderHastalarYeniSistem(); // Yeni sistemi gÃ¼ncelle
        } else {
          console.warn('âš ï¸ GitHub kaydÄ± baÅŸarÄ±sÄ±z oldu, ancak yerel deÄŸiÅŸiklikler kaydedildi');
        }
      }).catch(error => {
        console.error('âŒ GitHub kaydetme hatasÄ±:', error);
      });
    }

    async function arsivleHasta() {
      if (!seciliHasta) {
        alert('âŒ Ã–nce bir hasta seÃ§in!');
        return;
      }
      
      try {
        // ArÅŸiv durumunu deÄŸiÅŸtir
        seciliHasta.arsiv = !seciliHasta.arsiv;
        seciliHasta.sonGuncelleme = new Date().toISOString();
        
        const durum = seciliHasta.arsiv ? 'arÅŸivlendi' : 'arÅŸivden Ã§Ä±karÄ±ldÄ±';
        console.log(`ğŸ“¦ ${seciliHasta.isim} ${durum}`);
        
        // GitHub'a kaydet
        const sonuc = await hastayiAyriKaydet(seciliHasta);
        if (sonuc) {
          alert(`âœ… ${seciliHasta.isim} ${durum}!`);
          
          // Hasta listesini yenile
          await renderHastalarYeniSistem();
          
          // Hasta bilgi panelini gÃ¼ncelle
          const secilenHastaNot = document.getElementById('secilenHastaNot');
          if (secilenHastaNot) {
            secilenHastaNot.textContent = seciliHasta.not || 'Not bulunmuyor';
          }
        } else {
          // Hata durumunda geri al
          seciliHasta.arsiv = !seciliHasta.arsiv;
          alert(`âŒ ${durum} iÅŸlemi baÅŸarÄ±sÄ±z!`);
        }
      } catch (error) {
        console.error('âŒ ArÅŸivleme hatasÄ±:', error);
        alert(`âŒ ArÅŸivleme hatasÄ±: ${error.message}`);
      }
    }

    async function silHasta() {
      if (!seciliHasta) {
        alert('âŒ Ã–nce bir hasta seÃ§in!');
        return;
      }
      
      const onay = confirm(`ğŸ—‘ï¸ "${seciliHasta.isim}" hasta kaydÄ±nÄ± silmek istediÄŸinize emin misiniz?\n\nBu iÅŸlem geri alÄ±namaz!`);
      if (!onay) return;
      
      try {
        console.log(`ğŸ—‘ï¸ ${seciliHasta.isim} hasta kaydÄ± siliniyor...`);
        
        // GitHub'dan hasta dosyasÄ±nÄ± sil
        const owner = 'mustafasacar35';
        const repo = 'lipodem-takip-paneli-3';
        const token = document.getElementById('githubToken').value.trim();
        
        if (!token) {
          alert('âŒ GitHub token gerekli!');
          return;
        }
        
        // Dosya adÄ± alternatifleri dene (hastaSecYeniSistem gibi)
        const dosyaAdlari = [
          generateFileName({ id: seciliHasta.id, isim: seciliHasta.isim }),
          generateFileName({ id: seciliHasta.id, isim: turkceKarakterDuzelt(seciliHasta.isim) }),
          generateFileName({ isim: seciliHasta.isim }),
          generateFileName({ isim: turkceKarakterDuzelt(seciliHasta.isim) })
        ];
        
        const benzersizDosyaAdlari = [...new Set(dosyaAdlari)];
        console.log('ğŸ” Silinecek dosya adlarÄ± deneniyor:', benzersizDosyaAdlari);
        
        let bulunanDosya = null;
        let dosyaSHA = null;
        
        // DosyayÄ± bul
        for (const dosyaAdi of benzersizDosyaAdlari) {
          try {
            console.log(`ğŸ” Denenen dosya: ${dosyaAdi}`);
            const shaResponse = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/patients/${dosyaAdi}`, {
              headers: { 'Authorization': `token ${token}` }
            });
            
            if (shaResponse.ok) {
              const shaData = await shaResponse.json();
              bulunanDosya = dosyaAdi;
              dosyaSHA = shaData.sha;
              console.log(`âœ… Silinecek dosya bulundu: ${dosyaAdi}`);
              break;
            }
          } catch (e) {
            console.log(`âŒ Dosya bulunamadÄ±: ${dosyaAdi}`);
          }
        }
        
        if (!bulunanDosya) {
          throw new Error(`Hasta dosyasÄ± bulunamadÄ±. Denenen dosyalar: ${benzersizDosyaAdlari.join(', ')}`);
        }
        
        // DosyayÄ± silmek yerine adÄ±nÄ± deÄŸiÅŸtir (timestamp ile benzersiz hale getir)
        const timestamp = new Date().getTime();
        const eskiDosyaAdi = bulunanDosya;
        const yeniDosyaAdi = `silindi_${timestamp}_${eskiDosyaAdi}`;
        
        console.log(`ğŸ”„ Dosya adÄ± deÄŸiÅŸtiriliyor: ${eskiDosyaAdi} â†’ ${yeniDosyaAdi}`);
        
        // Yeni dosya adÄ±nÄ±n zaten var olup olmadÄ±ÄŸÄ±nÄ± kontrol et
        try {
          const varlikKontrol = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/patients/${yeniDosyaAdi}`, {
            headers: { 'Authorization': `token ${token}` }
          });
          
          if (varlikKontrol.ok) {
            console.warn(`âš ï¸ ${yeniDosyaAdi} zaten var, farklÄ± timestamp deneniyor`);
            const yeniTimestamp = timestamp + Math.floor(Math.random() * 1000);
            yeniDosyaAdi = `silindi_${yeniTimestamp}_${eskiDosyaAdi}`;
            console.log(`ğŸ”„ Yeni dosya adÄ±: ${yeniDosyaAdi}`);
          }
        } catch (e) {
          // Dosya yok, bu iyi
          console.log(`âœ… ${yeniDosyaAdi} kullanÄ±labilir`);
        }
        
        // Ã–nce dosyanÄ±n iÃ§eriÄŸini al
        const contentResponse = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/patients/${eskiDosyaAdi}`, {
          headers: { 'Authorization': `token ${token}` }
        });
        
        if (!contentResponse.ok) {
          throw new Error(`Dosya iÃ§eriÄŸi alÄ±namadÄ±: ${contentResponse.status}`);
        }
        
        const contentData = await contentResponse.json();
        const dosyaIcerigi = contentData.content; // Base64 iÃ§erik
        
        // Yeni adla dosyayÄ± oluÅŸtur
        const createResponse = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/patients/${yeniDosyaAdi}`, {
          method: 'PUT',
          headers: {
            'Authorization': `token ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            message: `Hasta dosyasÄ± arÅŸivlendi: ${seciliHasta.isim} - ${new Date().toLocaleString('tr-TR')}`,
            content: dosyaIcerigi // Base64 iÃ§eriÄŸi direkt kullan
          })
        });
        
        if (!createResponse.ok) {
          const errorText = await createResponse.text();
          console.error('âŒ ArÅŸiv dosyasÄ± oluÅŸturma hatasÄ±:', createResponse.status, errorText);
          
          if (createResponse.status === 422) {
            throw new Error(`ArÅŸiv dosyasÄ± zaten var veya geÃ§ersiz: ${yeniDosyaAdi}. LÃ¼tfen tekrar deneyin.`);
          } else {
            throw new Error(`ArÅŸiv dosyasÄ± oluÅŸturulamadÄ±: ${createResponse.status} - ${errorText}`);
          }
        }
        
        console.log(`âœ… ArÅŸiv dosyasÄ± oluÅŸturuldu: ${yeniDosyaAdi}`);
        
        // Eski dosyayÄ± sil
        const deleteResponse = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/patients/${eskiDosyaAdi}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `token ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            message: `Hasta dosyasÄ± arÅŸivlendi (eski dosya silindi): ${seciliHasta.isim}`,
            sha: dosyaSHA
          })
        });
        
        if (deleteResponse.ok) {
          console.log(`âœ… Hasta dosyasÄ± arÅŸivlendi: ${eskiDosyaAdi} â†’ ${yeniDosyaAdi}`);
          
          // Hasta listesinden de kaldÄ±r
          const listeGuncellendi = await hastaListesindenKaldir(seciliHasta.id);
          if (listeGuncellendi) {
            alert(`âœ… ${seciliHasta.isim} hasta kaydÄ± arÅŸivlendi!\n\nDosya: ${yeniDosyaAdi}`);
            
            // Panel temizle ve listeyi yenile
            kapatDetay();
            await renderHastalarYeniSistem();
          } else {
            alert(`âš ï¸ Hasta dosyasÄ± arÅŸivlendi ama listeden kaldÄ±rÄ±lamadÄ±. SayfayÄ± yenileyin.`);
          }
        } else {
          throw new Error(`Eski dosya silinemedi: ${deleteResponse.status}`);
        }
        
      } catch (error) {
        console.error('âŒ Hasta silme hatasÄ±:', error);
        
        // 422 hatasÄ± Ã¶zel durumu - alternatif silme yÃ¶ntemi Ã¶ner
        if (error.message.includes('422') || error.message.includes('zaten var')) {
          const alternatifOnay = confirm(`âŒ ArÅŸivleme baÅŸarÄ±sÄ±z (dosya Ã§akÄ±ÅŸmasÄ±).\n\nğŸ”„ Alternatif yÃ¶ntem: Sadece hasta listesinden kaldÄ±rmak ister misiniz?\n\n(Dosya GitHub'da kalacak ama listede gÃ¶rÃ¼nmeyecek)`);
          
          if (alternatifOnay) {
            try {
              const listeGuncellendi = await hastaListesindenKaldir(seciliHasta.id);
              if (listeGuncellendi) {
                alert(`âœ… ${seciliHasta.isim} hasta listesinden kaldÄ±rÄ±ldÄ±!\n\nâš ï¸ Not: Dosya GitHub'da hala mevcut.`);
                kapatDetay();
                await renderHastalarYeniSistem();
                return;
              }
            } catch (listeError) {
              console.error('âŒ Liste gÃ¼ncelleme hatasÄ±:', listeError);
            }
          }
        }
        
        alert(`âŒ Hasta silme hatasÄ±: ${error.message}\n\nğŸ’¡ Ã–neriler:\n- AynÄ± hasta iÃ§in Ã¶nceki silme iÅŸlemi tamamlanmamÄ±ÅŸ olabilir\n- BirkaÃ§ dakika bekleyip tekrar deneyin\n- Ya da sadece "listeden kaldÄ±r" seÃ§eneÄŸini kullanÄ±n`);
      }
    }

    // Sadece listeden kaldÄ±rma fonksiyonu (dosyayÄ± silmez)
    async function sadeceLisedenKaldir() {
      if (!seciliHasta) {
        alert('âŒ Ã–nce bir hasta seÃ§in!');
        return;
      }
      
      const onay = confirm(`ğŸ“‹ "${seciliHasta.isim}" hastasÄ±nÄ± sadece listeden kaldÄ±rmak istediÄŸinize emin misiniz?\n\nâš ï¸ Dosya GitHub'da kalacak, sadece listede gÃ¶rÃ¼nmeyecek.`);
      if (!onay) return;
      
      try {
        console.log(`ğŸ“‹ ${seciliHasta.isim} listeden kaldÄ±rÄ±lÄ±yor...`);
        
        const listeGuncellendi = await hastaListesindenKaldir(seciliHasta.id);
        if (listeGuncellendi) {
          alert(`âœ… ${seciliHasta.isim} listeden kaldÄ±rÄ±ldÄ±!\n\nğŸ’¾ Dosya GitHub'da korunuyor.`);
          kapatDetay();
          await renderHastalarYeniSistem();
        } else {
          throw new Error('Liste gÃ¼ncellenemedi');
        }
        
      } catch (error) {
        console.error('âŒ Listeden kaldÄ±rma hatasÄ±:', error);
        alert(`âŒ Listeden kaldÄ±rma hatasÄ±: ${error.message}`);
      }
    }

    // Global eriÅŸim iÃ§in
    window.sadeceLisedenKaldir = sadeceLisedenKaldir;

    function kapatDetay() {
      // Hasta bilgi panelindeki bilgileri sÄ±fÄ±rla
      const secilenHastaIsim = document.getElementById('secilenHastaIsim');
      const secilenHastaNot = document.getElementById('secilenHastaNot');
      const hastaBilgiButonlar = document.getElementById('hastaBilgiButonlar');
      
      if (secilenHastaIsim) {
        secilenHastaIsim.textContent = 'Hasta SeÃ§ilmedi';
      }
      if (secilenHastaNot) {
        secilenHastaNot.textContent = 'LÃ¼tfen sol menÃ¼den bir hasta seÃ§in';
      }
      if (hastaBilgiButonlar) {
        hastaBilgiButonlar.style.display = 'none';
      }
      
      // SeÃ§ili hastayÄ± temizle
      seciliHasta = null;
      
      // Hafta tablarÄ±nÄ± temizle
      const haftaTabs = document.getElementById('haftaTabs');
      const haftaTabContent = document.getElementById('haftaTabContent');
      if (haftaTabs) haftaTabs.innerHTML = '';
      if (haftaTabContent) haftaTabContent.innerHTML = '';
      
      // Cache'i temizle
      if (typeof cokluPdfHastaCache !== 'undefined') {
        console.log('ğŸ§¹ Cache temizleniyor...');
        cokluPdfHastaCache.clear();
      }
      
      // Sol sidebar'da vurgulamayÄ± kaldÄ±r
      renderHastalar();
    }


    // --- Hasta HaftalarÄ± ---
    function getHaftaListesi() {
      if (!seciliHasta) {
        console.log('ğŸ” getHaftaListesi: seciliHasta yok');
        return [];
      }
      if (!seciliHasta.haftalar) {
        console.log('ğŸ” getHaftaListesi: haftalar array yok, oluÅŸturuluyor');
        seciliHasta.haftalar = [];
      }
      
      console.log(`ğŸ” getHaftaListesi: ${seciliHasta.haftalar.length} hafta bulundu`);
      console.log('ğŸ” getHaftaListesi detay:', seciliHasta.haftalar.map(h => ({ haftaNo: h.haftaNo, baslangic: h.baslangic, bitis: h.bitis, pdfName: h.pdfName })));
      
      // Hafta listesini hafta numarasÄ±na gÃ¶re sÄ±rala (kÃ¼Ã§Ã¼kten bÃ¼yÃ¼ÄŸe)
      const sorted = seciliHasta.haftalar.sort((a, b) => {
        const aHaftaNo = a.haftaNo || 1;
        const bHaftaNo = b.haftaNo || 1;
        return aHaftaNo - bHaftaNo;
      });
      
      console.log(`ğŸ” getHaftaListesi: SÄ±ralanmÄ±ÅŸ ${sorted.length} hafta dÃ¶ndÃ¼rÃ¼lÃ¼yor`);
      return sorted;
    }

    function haftaEkle() {
      if (!seciliHasta) return;
      if (!seciliHasta.haftalar) seciliHasta.haftalar = [];
      
      // Bir sonraki hafta numarasÄ±nÄ± hesapla
      let sonrakiHaftaNo = 1;
      if (seciliHasta.haftalar.length > 0) {
        const sonHafta = seciliHasta.haftalar[seciliHasta.haftalar.length - 1];
        sonrakiHaftaNo = (sonHafta.haftaNo || seciliHasta.haftalar.length) + 1;
      }
      
      let startDate = null;
      if (seciliHasta.haftalar.length > 0) {
        // âš¡ Ã–NEMLÄ°: En bÃ¼yÃ¼k hafta numarasÄ±na sahip haftayÄ± bul (tarih sÄ±rasÄ± deÄŸil!)
        const haftaListesi = getHaftaListesi();
        
        let enBuyukHaftaNoHafta = haftaListesi[0];
        let enBuyukHaftaNo = enBuyukHaftaNoHafta.haftaNo || 1;
        
        // En bÃ¼yÃ¼k hafta numarasÄ±nÄ± bul
        haftaListesi.forEach(hafta => {
          const haftaNo = hafta.haftaNo || 1;
          if (haftaNo > enBuyukHaftaNo) {
            enBuyukHaftaNo = haftaNo;
            enBuyukHaftaNoHafta = hafta;
          }
        });
        
        console.log('ğŸ“… En bÃ¼yÃ¼k hafta numarasÄ±:', enBuyukHaftaNo, 'Tarihi:', enBuyukHaftaNoHafta.baslangic, '-', enBuyukHaftaNoHafta.bitis);
        
        // âš¡ Ã‡Ã–ZÃœM: Tab'da gÃ¶rÃ¼nen tarihi hesapla (PDF'den gelen Ã¶zel format vs. dikkate al)
        let tabGoruntulenenBitisTarihi = null;
        
        // Ã–zel tab formatÄ± kontrolÃ¼
        if (enBuyukHaftaNoHafta.ozelTabFormat && enBuyukHaftaNoHafta.tabTarih) {
          // PDF'den gelen uzun tarih aralÄ±ÄŸÄ± iÃ§in Ã¶zel format - son tarihi Ã§Ä±kar
          const tabTarih = enBuyukHaftaNoHafta.tabTarih;
          const tarihParcalari = tabTarih.split(' - ');
          if (tarihParcalari.length === 2) {
            const bitisParcasi = tarihParcalari[1].trim();
            // MM/DD formatÄ±ndan yÄ±l ekle
            const [ay, gun] = bitisParcasi.split('/');
            const yil = new Date().getFullYear();
            tabGoruntulenenBitisTarihi = `${yil}-${ay.padStart(2, '0')}-${gun.padStart(2, '0')}`;
          }
        } else {
          // Normal hafta verisi - bitiÅŸ tarihini al
          tabGoruntulenenBitisTarihi = enBuyukHaftaNoHafta.bitis;
        }
        
        console.log('ğŸ“… Tab\'da gÃ¶rÃ¼nen bitiÅŸ tarihi:', tabGoruntulenenBitisTarihi);
        
        try {
          if (tabGoruntulenenBitisTarihi) {
            // âš¡ Ã–NEMLÄ°: Tab'da gÃ¶rÃ¼nen bitiÅŸ tarihinden 1 gÃ¼n sonra baÅŸla
            const tabBitis = new Date(tabGoruntulenenBitisTarihi + 'T00:00:00');
            startDate = new Date(tabBitis.getTime() + 1*24*60*60*1000);
            console.log('ğŸ“… Tab bitiÅŸ tarihinden yeni hafta baÅŸlangÄ±cÄ± hesaplandÄ±:', startDate.toISOString().slice(0,10));
          } else {
            throw new Error('Tab bitiÅŸ tarihi bulunamadÄ±');
          }
          
          // Tarih geÃ§erli mi kontrol et
          if (isNaN(startDate.getTime())) {
            throw new Error('GeÃ§ersiz tarih');
          }
        } catch (e) {
          console.warn('Son hafta tarih hatasÄ±:', e);
          // BugÃ¼nden baÅŸla
          const now = new Date();
          const day = now.getDay();
          const diff = (day === 0 ? 1 : 8 - day); // Gelecek pazartesi
          startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() + diff);
        }
      } else {
        // Ä°lk hafta iÃ§in bugÃ¼nÃ¼n pazartesisi
        const now = new Date();
        const day = now.getDay();
        const diff = (day === 0 ? -6 : 1) - day; // Pazartesiye Ã§ek
        startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() + diff);
      }
      
      // Final gÃ¼venlik kontrolÃ¼
      if (!startDate || isNaN(startDate.getTime())) {
        startDate = new Date(); // En son Ã§are olarak bugÃ¼n
      }
      
      // VarsayÄ±lan olarak 7 gÃ¼n (1 hafta) sÃ¼reli yap
      const endDate = new Date(startDate.getTime() + 6*24*60*60*1000); // 6 gÃ¼n ekle (toplam 7 gÃ¼n)
      
      console.log('ğŸ“… Yeni hafta tarihleri hesaplandÄ±:', {
        haftaNo: sonrakiHaftaNo,
        startDate: startDate.toISOString().slice(0,10),
        endDate: endDate.toISOString().slice(0,10),
        gunSayisi: Math.round((endDate - startDate) / (24*60*60*1000)) + 1
      });
      
      seciliHasta.haftalar.push({
        haftaNo: sonrakiHaftaNo, // YENÄ°: Hafta numarasÄ±
        baslangic: startDate.toISOString().slice(0,10),
        bitis: endDate.toISOString().slice(0,10),
        aciklama: '',
        pdf: null,
        pdfName: null,  // PDF gÃ¼venli dosya adÄ±
        pdfOrijinalIsim: null,  // PDF'nin orijinal dosya adÄ±
        pdfYolu: null,  // GitHub'daki PDF yolu (pdfs/dosya.pdf)
        githubUrl: null,  // GitHub'da gÃ¶rÃ¼ntÃ¼leme linki
        indirmeUrl: null,  // Direkt indirme linki
        kayitTarihi: null, // PDF yÃ¼kleme tarihi
        tarifKartlar: [],
        tarifler: [],
        gptMesaj: '',
        kilitli: false, // YENÄ°: Emniyet kilidi (false = aÃ§Ä±k)
        kayitTarihi: null // Kaydedilme tarihi
      });
      saveToStorage();
      
      console.log('âœ… Yeni hafta eklendi:', sonrakiHaftaNo, 'numaralÄ± hafta');
      
      // Otomatik kaydetme - hafta eklendi
      autoSaveHastaData(seciliHasta);
      
      // âš¡ Ã–NEMLÄ°: GitHub'a da kaydet (hemen)
      console.log('ğŸ’¾ Yeni hafta GitHub\'a kaydediliyor...');
      hastayiAyriKaydet(seciliHasta).then(() => {
        console.log('âœ… Yeni hafta GitHub\'a kaydedildi');
      }).catch(e => {
        console.warn('âš ï¸ GitHub kaydÄ± baÅŸarÄ±sÄ±z:', e);
      });
      
      // âš¡ Ã–NEMLÄ°: Hasta listesini gÃ¼ncelle (yan taraftaki hafta numarasÄ± iÃ§in)
      console.log('ğŸ”„ Hasta listesi gÃ¼ncelleniyor (hafta numarasÄ± iÃ§in)...');
      renderHastalar();
      
      // Tab sistemini yeniden yÃ¼kle ve yeni tab'a geÃ§
      gosterHaftalar();
      const yeniTabIndex = seciliHasta.haftalar.length - 1;
      
      // 5. hafta kontrolÃ¼ - Lenf Drenaj Takvimi otomatik oluÅŸtur
      if (sonrakiHaftaNo === 5) {
        setTimeout(() => {
          if (confirm(`ğŸ¥ 5. hafta eklendi!\n\nLenf Drenaj MasajÄ± Takvimi otomatik olarak oluÅŸturulsun mu?`)) {
            generateLenfDrenajTakvimi();
          }
        }, 500);
      }
      
      setTimeout(() => {
        switchTab(yeniTabIndex);
        // Sidebar'larÄ± gÃ¼ncelle
        hastaSecildiginde(hastalar.findIndex(h => h.id === seciliHasta.id));
      }, 100);
    }

    // Hafta verilerini normalize et (eski data format uyumluluÄŸu iÃ§in)
    function normalizeHaftaData() {
      if (!seciliHasta || !seciliHasta.haftalar) return;
      
      let dataUpdated = false;
      
      seciliHasta.haftalar.forEach((hafta, index) => {
        // Hafta numarasÄ± yoksa ekle
        if (!hafta.haftaNo) {
          hafta.haftaNo = index + 1;
          dataUpdated = true;
        }
        
        // Tarif kartlarÄ± alanÄ± yoksa ekle
        if (!hafta.tarifKartlar) {
          hafta.tarifKartlar = [];
          dataUpdated = true;
        }
        
        // Tarifler alanÄ± yoksa ekle
        if (!hafta.tarifler) {
          hafta.tarifler = [];
          dataUpdated = true;
        }
        
        // GPT mesaj alanÄ± yoksa ekle
        if (hafta.gptMesaj === undefined) {
          hafta.gptMesaj = '';
          dataUpdated = true;
        }
        
        // AÃ§Ä±klama alanÄ± yoksa ekle
        if (hafta.aciklama === undefined) {
          hafta.aciklama = '';
          dataUpdated = true;
        }
        
        // PDF alanÄ± yoksa ekle
        if (hafta.pdf === undefined) {
          hafta.pdf = null;
          dataUpdated = true;
        }
        
        // PDF dosya adÄ± yoksa ekle
        if (hafta.pdfName === undefined) {
          hafta.pdfName = null;
          dataUpdated = true;
        }
        
        // PDF orijinal isim yoksa ekle
        if (hafta.pdfOrijinalIsim === undefined) {
          hafta.pdfOrijinalIsim = hafta.pdfName; // Mevcut pdfName'i kopyala
          dataUpdated = true;
        }
        
        // PDF yolu yoksa ekle
        if (hafta.pdfYolu === undefined) {
          hafta.pdfYolu = null;
          dataUpdated = true;
        }
        
        // GitHub URL'leri yoksa ekle
        if (hafta.githubUrl === undefined) {
          hafta.githubUrl = null;
          dataUpdated = true;
        }
        
        if (hafta.indirmeUrl === undefined) {
          hafta.indirmeUrl = null;
          dataUpdated = true;
        }
        
        // KayÄ±t tarihi yoksa ekle
        if (hafta.kayitTarihi === undefined) {
          hafta.kayitTarihi = null;
          dataUpdated = true;
        }
        
        // Kilit durumu yoksa ekle (varsayÄ±lan: kilitli deÄŸil)
        if (hafta.kilitli === undefined) {
          hafta.kilitli = false;
          dataUpdated = true;
        }
        
        // BaÅŸlangÄ±Ã§ ve bitiÅŸ tarihleri yoksa oluÅŸtur
        if (!hafta.baslangic || !hafta.bitis) {
          try {
            const now = new Date();
            // Bu haftanÄ±n pazartesini bul
            const thisWeekMonday = new Date(now.getFullYear(), now.getMonth(), now.getDate() - now.getDay() + 1);
            // Ä°stenen hafta iÃ§in pazartesi (index * 7 gÃ¼n ekle)
            const weekStart = new Date(thisWeekMonday.getTime() + (index * 7 * 24 * 60 * 60 * 1000));
            const weekEnd = new Date(weekStart.getTime() + 6*24*60*60*1000);
            
            hafta.baslangic = weekStart.toISOString().slice(0,10);
            hafta.bitis = weekEnd.toISOString().slice(0,10);
            dataUpdated = true;
          } catch (e) {
            console.warn('Tarih oluÅŸturma hatasÄ± hafta', index + 1, ':', e);
          }
        } else {
          // âš¡ Ã–NEMLÄ°: PDF'den Ã¶zel tarih aralÄ±ÄŸÄ± gelen haftalarÄ± normalize etme!
          if (hafta.ozelTabFormat) {
            console.log(`ğŸ“… ${index + 1}. hafta PDF'den Ã¶zel tarih aralÄ±ÄŸÄ±na sahip, normalize edilmiyor`);
            return; // Bu haftayÄ± normal hizalama iÅŸleminden Ã§Ä±kar
          }
          
          // Mevcut baÅŸlangÄ±Ã§ tarihinin pazartesi olmasÄ±nÄ± garanti altÄ±na al
          try {
            const baslangicTarihi = new Date(hafta.baslangic);
            const gunNo = baslangicTarihi.getDay(); // 0=Pazar, 1=Pazartesi
            
            if (gunNo !== 1) { // Pazartesi deÄŸilse dÃ¼zelt
              const gunFarki = gunNo === 0 ? 1 : (1 - gunNo); // Pazartesiye kadar olan gÃ¼n farkÄ±
              baslangicTarihi.setDate(baslangicTarihi.getDate() + gunFarki);
              
              // BitiÅŸ tarihini de gÃ¼ncelle (6 gÃ¼n sonra pazar)
              const bitisTarihi = new Date(baslangicTarihi.getTime() + 6*24*60*60*1000);
              
              hafta.baslangic = baslangicTarihi.toISOString().slice(0,10);
              hafta.bitis = bitisTarihi.toISOString().slice(0,10);
              dataUpdated = true;
              
              console.log(`ğŸ“… ${index + 1}. hafta baÅŸlangÄ±cÄ± pazartesi olarak dÃ¼zeltildi:`, hafta.baslangic);
            }
          } catch (e) {
            console.warn('Tarih dÃ¼zeltme hatasÄ± hafta', index + 1, ':', e);
          }
        }
      });
      
      if (dataUpdated) {
        console.log('ğŸ”„ Hafta verileri normalize edildi');
        saveToStorage();
      }
    }

    function gosterHaftalar() {
      const tabsDiv = document.getElementById('haftaTabs');
      const contentDiv = document.getElementById('haftaTabContent');
      
      if (!tabsDiv || !contentDiv) return;
      
      // CSS class'Ä±nÄ± garanti et
      tabsDiv.className = 'hafta-tabs';
      tabsDiv.style.display = 'flex';
      tabsDiv.style.flexWrap = 'wrap';
      tabsDiv.style.gap = '5px';
      console.log('ğŸ·ï¸ Hafta tabs CSS class atandÄ±:', tabsDiv.className);
      console.log('ğŸ·ï¸ Hafta tabs computed style:', window.getComputedStyle(tabsDiv).display);
      
      tabsDiv.innerHTML = '';
      contentDiv.innerHTML = '';
      
      // Hafta verilerini normalize et
      normalizeHaftaData();
      
      const haftalar = getHaftaListesi();
      
      // DEBUG: Hafta verilerini detaylÄ± logla
      console.log('ğŸ” HAFTA VERÄ°LERÄ° DEBUG:');
      console.log('ğŸ” SeciliHasta:', seciliHasta?.isim);
      console.log('ğŸ” SeciliHasta haftalar count:', seciliHasta?.haftalar?.length);
      console.log('ğŸ” GetHaftaListesi count:', haftalar?.length);
      console.log('ğŸ” Hafta detaylarÄ±:', haftalar.map(h => ({
        haftaNo: h.haftaNo,
        baslangic: h.baslangic,
        bitis: h.bitis,
        hasPdf: !!h.pdf,
        pdfName: h.pdfName || h.pdfOrijinalIsim || 'yok'
      })));
      
      // Cache'i kontrol et
      if (typeof cokluPdfHastaCache !== 'undefined') {
        const cacheKey = seciliHasta?.isim?.toUpperCase();
        const cachedData = cokluPdfHastaCache.get(cacheKey);
        console.log('ğŸ” Cache\'te bu hasta:', !!cachedData);
        if (cachedData) {
          console.log('ğŸ” Cache\'teki hafta sayÄ±sÄ±:', cachedData.haftalar?.length);
          console.log('ğŸ” Cache\'teki haftalar:', cachedData.haftalar?.map(h => ({
            haftaNo: h.haftaNo,
            baslangic: h.baslangic,
            bitis: h.bitis
          })));
        }
      }
      
      // Backward compatibility: Mevcut haftalara hafta numarasÄ± ekle
      let haftaNumarasiDegisti = false;
      haftalar.forEach((hafta, i) => {
        if (!hafta.haftaNo) {
          hafta.haftaNo = i + 1;
          haftaNumarasiDegisti = true;
        }
      });
      if (haftaNumarasiDegisti) {
        saveToStorage();
        console.log('ğŸ”„ Mevcut haftalara hafta numaralarÄ± eklendi');
      }
      
      // TablarÄ± oluÅŸtur
      haftalar.forEach((hafta, i) => {
        const haftaNo = hafta.haftaNo || (i + 1);
        
        // Tab baÅŸlÄ±ÄŸÄ± oluÅŸtur - Ä°LK TAB AKTÄ°F OLSUN (son tÄ±klanan kalacak)
        const tabDiv = document.createElement('div');
        tabDiv.className = `hafta-tab ${i === 0 ? 'active' : ''} ${hafta.kilitli ? 'locked' : ''}`;
        tabDiv.dataset.haftaIndex = i; // Dataset ekle
        tabDiv.onclick = () => switchTab(i);
        
        // Status gÃ¶stergeleri
        const hasPdf = hafta.pdf ? 'status-pdf' : 'status-empty';
        const hasKartlar = (hafta.tarifKartlar && hafta.tarifKartlar.length > 0) ? 'status-kartlar' : 'status-empty';
        const hasEslesen = (hafta.tarifler && hafta.tarifler.length > 0) ? 'status-eslesen' : 'status-empty';
        const isLocked = hafta.kilitli ? 'status-locked' : 'status-empty';
        
        // Tarih bilgilerini gÃ¼venli ÅŸekilde kontrol et
        const baslangicTarih = hafta.baslangic || '';
        const bitisTarih = hafta.bitis || '';
        let tarihGosterim = '';
        let detayTarihGosterim = '';
        
        // Ã–zel tab formatÄ± kontrolÃ¼
        if (hafta.ozelTabFormat && hafta.tabBaslik && hafta.tabTarih) {
          // PDF'den gelen uzun tarih aralÄ±ÄŸÄ± iÃ§in Ã¶zel format
          tarihGosterim = hafta.tabTarih;
          detayTarihGosterim = hafta.tabTarih; // Detay iÃ§in de aynÄ± format
        } else if (baslangicTarih && bitisTarih) {
          try {
            // Tarihleri parse et ve doÄŸru formatta gÃ¶ster
            const basDate = new Date(baslangicTarih);
            const bitDate = new Date(bitisTarih);
            
            if (!isNaN(basDate.getTime()) && !isNaN(bitDate.getTime())) {
              const basAy = String(basDate.getMonth() + 1).padStart(2, '0');
              const basGun = String(basDate.getDate()).padStart(2, '0');
              const bitAy = String(bitDate.getMonth() + 1).padStart(2, '0');
              const bitGun = String(bitDate.getDate()).padStart(2, '0');
              tarihGosterim = `${basAy}/${basGun} - ${bitAy}/${bitGun}`;
              detayTarihGosterim = `${basDate.getFullYear()}-${basAy}-${basGun} - ${bitDate.getFullYear()}-${bitAy}-${bitGun}`;
            }
          } catch (e) {
            console.warn('Tarih parse hatasÄ±:', e);
            tarihGosterim = 'Tarih belirtilmemiÅŸ';
            detayTarihGosterim = 'Tarih belirtilmemiÅŸ';
          }
        } else {
          tarihGosterim = 'Tarih belirtilmemiÅŸ';
          detayTarihGosterim = 'Tarih belirtilmemiÅŸ';
        }
        
        // Tab baÅŸlÄ±ÄŸÄ±nÄ± belirle
        const tabBaslik = hafta.ozelTabFormat && hafta.tabBaslik ? hafta.tabBaslik : `${haftaNo}. Hafta`;
        
        tabDiv.innerHTML = `
          <div style="font-weight: bold; font-size: 14px;">${tabBaslik}</div>
          <div style="font-size: 10px; color: #666; margin-top: 2px;">
            ${tarihGosterim}
          </div>
          <div class="tab-status-indicators">
            <span class="status-indicator ${hasPdf}" title="PDF durumu"></span>
            <span class="status-indicator ${hasKartlar}" title="Manuel kartlar"></span>
            <span class="status-indicator ${hasEslesen}" title="EÅŸleÅŸen kartlar"></span>
            <span class="status-indicator ${isLocked}" title="Kilit durumu"></span>
          </div>
          ${hafta.kilitli ? '<span class="tab-lock-icon">ğŸ”’</span>' : ''}
        `;
        tabsDiv.appendChild(tabDiv);
        console.log(`ğŸ·ï¸ ${haftaNo}. hafta tab'Ä± eklendi, CSS class:`, tabDiv.className);
        
        // Tab iÃ§eriÄŸi oluÅŸtur - Ä°LK TAB AKTÄ°F OLSUN (son tÄ±klanan kalacak)
        const contentTab = document.createElement('div');
        contentTab.className = `hafta-tab-content ${i === 0 ? 'active' : ''}`;
        contentTab.id = `haftaContent_${i}`;
        
        contentTab.innerHTML = `
          <div class="hafta-tab-header">
            <div style="display: flex; align-items: center; gap: 15px;">
              <div style="display: flex; align-items: center; gap: 5px;">
                <span id="haftaNoDisplay_${i}" style="font-weight: bold; font-size: 18px; cursor: text; padding: 4px 8px; border-radius: 4px; min-width: 20px; text-align: center;" 
                      onclick="editHaftaNo(${i})" title="Hafta numarasÄ±nÄ± dÃ¼zenlemek iÃ§in tÄ±klayÄ±n">${haftaNo}</span>
                <span style="font-weight: bold; font-size: 18px;">. Hafta</span>
                <input type="number" id="haftaNo_${i}" value="${haftaNo}" min="1" max="52" 
                       style="display: none; width: 50px; font-weight: bold; text-align: center; border: 2px solid #007bff; border-radius: 4px; padding: 4px;"
                       onblur="saveHaftaNo(${i})" onkeypress="if(event.key==='Enter') saveHaftaNo(${i})">
              </div>
              <span style="color: #666; font-size: 14px;">ğŸ“… ${detayTarihGosterim}</span>
            </div>
            <div style="display: flex; gap: 5px;">
              ${!hafta.kilitli ? `
                <button onclick="haftaKaydet(${i})" class="kayit-btn" style="padding: 5px 12px; font-size: 12px;">  Kilitle</button>
              ` : `
                <button class="kayit-btn saved" style="padding: 5px 12px; font-size: 12px;">ğŸ”’ Kilitli</button>
                <button onclick="haftaKilidiAc(${i})" class="kilit-ac-btn" style="padding: 5px 10px; font-size: 11px;">ğŸ”“ Kilidi AÃ§</button>
              `}
              <button onclick="duzenleHafta(${i})" style="padding: 5px 10px; font-size: 12px;">DÃ¼zenle</button>
              <button onclick="silHafta(${i})" style="padding: 5px 10px; font-size: 12px; color: red;">Sil</button>
              ${haftaNo === 5 ? `<button onclick="haftaZipIndir(${i}, 5)" style="padding: 5px 10px; font-size: 12px; background: #17a2b8; color: white; border: none; border-radius: 4px;" title="5. hafta Ã¶zel ZIP (Kilitli durumda da kullanÄ±labilir)">ğŸ“¦ ZIP</button>` : ''}
              ${haftaNo === 9 ? `<button onclick="haftaZipIndir(${i}, 9)" style="padding: 5px 10px; font-size: 12px; background: #6f42c1; color: white; border: none; border-radius: 4px;" title="9. hafta Ã¶zel ZIP (Kilitli durumda da kullanÄ±labilir)">ğŸ“¦ ZIP</button>` : ''}
            </div>
          </div>
          
          <!-- Ana Ä°Ã§erik - Horizontal Layout (2 kolon: PDF ve AÃ§Ä±klama) -->
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
            
            <!-- PDF BÃ¶lÃ¼mÃ¼ -->
            <div style="padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #28a745;" class="${hafta.kilitli ? 'locked-area' : ''}">
              <h4 style="margin: 0 0 10px 0; color: #28a745; font-size: 14px;">ğŸ“„ PDF</h4>
              <input type="file" accept="application/pdf" onchange="pdfYukleHafta(${i}, this)" 
                     style="width: 100%; margin-bottom: 10px; font-size: 12px;" ${hafta.kilitli ? 'disabled' : ''}>
              ${hafta.pdf || hafta.pdfYolu ? `
                <div style="color: green; font-weight: bold; font-size: 12px; background: #d4edda; padding: 8px; border-radius: 4px; border-left: 3px solid #28a745;">
                  âœ… <strong style="color: #155724; font-size: 13px;">${hafta.pdfOrijinalIsim || hafta.pdfName || 'hafta.pdf'}</strong>
                  ${hafta.pdfOrijinalIsim && hafta.pdfName && hafta.pdfOrijinalIsim !== hafta.pdfName ? `
                    <div style="color: #6c757d; font-size: 11px; margin-top: 2px;">
                      ğŸ“ GÃ¼venli ad: ${hafta.pdfName}
                    </div>
                  ` : ''}
                  <div style="color: #666; font-weight: normal; margin-top: 5px; font-size: 11px;">
                    ğŸ“Š ${hafta.tarifler ? hafta.tarifler.length : 0} tarif tespit edildi
                  </div>
                  <div style="color: #495057; font-weight: normal; margin-top: 3px; font-size: 10px;">
                    ğŸ“… YÃ¼klenme: ${hafta.kayitTarihi ? new Date(hafta.kayitTarihi).toLocaleString('tr-TR') : 'Bilinmiyor'}
                  </div>
                  ${hafta.githubUrl || hafta.githubLink ? `
                    <div style="margin-top: 8px; padding-top: 5px; border-top: 1px solid #c3e6cb;">
                      <a href="javascript:void(0)" onclick="pdfGoruntule('${hafta.indirmeUrl || hafta.githubRawLink || hafta.githubUrl}')" style="color: #0066cc; text-decoration: none; font-size: 11px; display: inline-flex; align-items: center; gap: 3px;">
                        <span style="font-size: 12px;">ğŸ‘ï¸</span> PDF GÃ¶rÃ¼ntÃ¼le
                      </a>
                      <span style="margin: 0 5px; color: #dee2e6;">|</span>
                      <a href="${hafta.githubUrl || hafta.githubLink}" target="_blank" style="color: #666; text-decoration: none; font-size: 11px; display: inline-flex; align-items: center; gap: 3px;">
                        <span style="font-size: 12px;">ğŸ”—</span> GitHub'da GÃ¶rÃ¼ntÃ¼le
                      </a>
                      ${hafta.indirmeUrl || hafta.githubRawLink ? `
                        <span style="margin: 0 5px; color: #dee2e6;">|</span>
                        <a href="javascript:void(0)" onclick="pdfIndir('${hafta.indirmeUrl || hafta.githubRawLink}', '${hafta.pdfOrijinalIsim || hafta.pdfName}')" style="color: #28a745; text-decoration: none; font-size: 11px; display: inline-flex; align-items: center; gap: 3px;">
                          <span style="font-size: 12px;">ğŸ’¾</span> Ä°ndir
                        </a>
                      ` : ''}
                    </div>
                  ` : ''}
                </div>
              ` : '<div style="color: #666; font-size: 12px; background: #f8f9fa; padding: 8px; border-radius: 4px;">ğŸ“„ PDF henÃ¼z yÃ¼klenmedi</div>'}
            </div>
            
            <!-- Tarif KartlarÄ± BÃ¶lÃ¼mÃ¼ - GÄ°ZLENDÄ° -->
            <div style="display: none; padding: 15px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;">
              <h4 style="margin: 0 0 10px 0; color: #856404; font-size: 14px;">ğŸ–¼ï¸ Tarif KartlarÄ±</h4>
              <input type="file" accept="image/jpeg,image/jpg,image/png" multiple 
                     onchange="tarifKartYukleHafta(${i}, this)" style="width: 100%; font-size: 12px;">
              <div id="haftaKartGorsel_${i}" style="margin-top: 10px;"></div>
            </div>
            
            <!-- AÃ§Ä±klama BÃ¶lÃ¼mÃ¼ -->
            <div style="padding: 15px; background: #d1ecf1; border-radius: 8px; border-left: 4px solid #17a2b8;" class="${hafta.kilitli ? 'locked-area' : ''}">
              <h4 style="margin: 0 0 10px 0; color: #0c5460; font-size: 14px;">ğŸ“ AÃ§Ä±klama</h4>
              <input type="text" id="aciklama_${i}" value="${hafta.aciklama||''}" 
                     placeholder="Bu hafta hakkÄ±nda not..." 
                     style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #bee5eb; font-size: 12px;"
                     onchange="aciklamaKaydet(${i})" ${hafta.kilitli ? 'readonly' : ''}>>
            </div>
          </div>
          
          <!-- GPT MesajÄ± - Grid'in AltÄ±nda -->
          <div style="margin-bottom: 20px;" class="${hafta.kilitli ? 'locked-area' : ''}">
            <h4 style="margin: 0 0 10px 0; color: #dc3545; font-size: 16px;">ğŸ’¬ ${haftaNo}. HaftanÄ±n MesajÄ±</h4>
            <textarea id="gptMesaj_${i}" rows="3" 
                      style="width: 100%; padding: 10px; border-radius: 4px; border: 1px solid #ddd; resize: vertical;"
                      placeholder="Bu hafta iÃ§in GPT mesajÄ± veya not..."
                      ${hafta.kilitli ? 'disabled' : ''}>${hafta.gptMesaj||''}</textarea>
            <div style="margin-top: 10px; display: flex; justify-content: space-between; align-items: center;">
              <div>
                <button onclick="gptMesajKaydet(${i})" style="padding: 8px 15px; font-size: 12px;" ${hafta.kilitli ? 'disabled' : ''}>ğŸ’¾ Kaydet</button>
                <button onclick="kopyalaGptMesaj(${i})" style="padding: 8px 15px; margin-left: 10px; font-size: 12px;">ğŸ“‹ Kopyala</button>
              </div>
              <div>
                <button onclick="zipEslesenGorseller(${i})" style="
                  padding: 8px 12px; 
                  font-size: 12px; 
                  background: #17a2b8; 
                  color: white; 
                  border: none; 
                  border-radius: 4px; 
                  cursor: pointer;
                  font-weight: bold;
                " title="HaftalÄ±k PDF, eÅŸleÅŸen tarif kartlarÄ± ve GPT mesajÄ±nÄ± tek ZIP dosyasÄ±nda indirir${hafta.kilitli ? ' (Kilitli haftada da kullanÄ±labilir)' : ''}">ğŸ—œï¸ ZIP Ä°ndir</button>
              </div>
            </div>
          </div>
          
          <!-- EÅŸleÅŸen Kartlar - Full Width (Eski, Gizli) -->
          <div style="margin-bottom: 20px; display: none;">
            <h4 style="margin: 0 0 10px 0; color: #6f42c1; font-size: 16px;">ğŸ”— EÅŸleÅŸen Kartlar</h4>
            <div id="eslesenKartlar_${i}" style="border: 1px solid #ddd; padding: 15px; border-radius: 8px; background: #f9f9f9; min-height: 80px;"></div>
          </div>
          
          <!-- GPT MesajÄ± - Full Width (Eski, Gizli) -->
          <div style="margin-bottom: 20px; display: none;">
            <h4 style="margin: 0 0 10px 0; color: #dc3545; font-size: 16px;">ğŸ’¬ ${haftaNo}. HaftanÄ±n MesajÄ±</h4>
            <textarea id="gptMesaj_${i}" rows="3" 
                      style="width: 100%; padding: 10px; border-radius: 4px; border: 1px solid #ddd; resize: vertical;"
                      placeholder="Bu hafta iÃ§in GPT mesajÄ± veya not...">${hafta.gptMesaj||''}</textarea>
            <div style="margin-top: 10px;">
              <button onclick="gptMesajKaydet(${i})" style="padding: 8px 15px; font-size: 12px;">ğŸ’¾ Kaydet</button>
              <button onclick="kopyalaGptMesaj(${i})" style="padding: 8px 15px; margin-left: 10px; font-size: 12px;">ğŸ“‹ Kopyala</button>
            </div>
          </div>
        `;
        
        contentDiv.appendChild(contentTab);
        
        // Alt iÅŸlemleri Ã§alÄ±ÅŸtÄ±r (async olarak)
        setTimeout(() => {
          gosterTariflerHafta(i);
          gosterKartlarHafta(i);
          
          // PDF yÃ¼klÃ¼ ama tarifler yoksa otomatik tara
          if (hafta.pdf && (!hafta.tarifler || hafta.tarifler.length === 0)) {
            pdfOkuVeEsleHafta(i);
          } else if (hafta.tarifler && hafta.tarifler.length > 0) {
            otomatikEsleHafta(i);
          }
        }, 100 * i); // SÄ±ralÄ± yÃ¼kleme
      });
      
      // "Hafta Ekle" tab'Ä±nÄ± ekle
      const haftaEkleTab = document.createElement('div');
      haftaEkleTab.className = 'hafta-tab hafta-ekle-tab';
      haftaEkleTab.style.background = '#28a745';
      haftaEkleTab.style.color = 'white';
      haftaEkleTab.style.border = '2px solid #28a745';
      haftaEkleTab.onclick = () => haftaEkle();
      
      haftaEkleTab.innerHTML = `
        <div style="font-weight: bold; font-size: 14px;">+ Hafta Ekle</div>
        <div style="font-size: 10px; margin-top: 2px;">Yeni hafta oluÅŸtur</div>
      `;
      tabsDiv.appendChild(haftaEkleTab);
      
      // En yÃ¼ksek hafta numaralÄ± tab'Ä± aktif yap
      if (haftalar.length > 0) {
        // En bÃ¼yÃ¼k hafta numarasÄ±nÄ± bul
        let enBuyukHaftaIndex = 0;
        let enBuyukHaftaNo = haftalar[0].haftaNo || 1;
        
        haftalar.forEach((hafta, index) => {
          const haftaNo = hafta.haftaNo || (index + 1);
          if (haftaNo > enBuyukHaftaNo) {
            enBuyukHaftaNo = haftaNo;
            enBuyukHaftaIndex = index;
          }
        });
        
        console.log(`ğŸ¯ En bÃ¼yÃ¼k hafta numarasÄ±: ${enBuyukHaftaNo}, index: ${enBuyukHaftaIndex}`);
        
        // Hafta tabÄ±nÄ±n iÃ§erikleri ve eÅŸleÅŸen kartlar tamamen yÃ¼klendikten sonra aktif tab'Ä± seÃ§
        setTimeout(() => {
          console.log(`ğŸ”„ ${enBuyukHaftaIndex}. hafta tab'Ä± iÃ§in eÅŸleÅŸen kartlar kontrol ediliyor...`);
          
          // EÅŸleÅŸen kartlarÄ±n yÃ¼klenip yÃ¼klenmediÄŸini kontrol et (maksimum 10 deneme)
          let denemeSayisi = 0;
          const maxDeneme = 10;
          
          const checkAndActivate = () => {
            denemeSayisi++;
            const eslesenDiv = document.getElementById(`eslesenKartlar_${enBuyukHaftaIndex}`);
            
            if (eslesenDiv && (eslesenDiv.children.length > 0 || eslesenDiv.innerHTML.includes('henÃ¼z eÅŸleÅŸme yok'))) {
              console.log(`âœ… ${enBuyukHaftaIndex}. hafta iÃ§in eÅŸleÅŸen kartlar hazÄ±r, tab aktif hale getiriliyor`);
              switchTab(enBuyukHaftaIndex);
            } else if (denemeSayisi < maxDeneme) {
              console.log(`â³ ${enBuyukHaftaIndex}. hafta iÃ§in eÅŸleÅŸen kartlar henÃ¼z hazÄ±r deÄŸil, 200ms daha bekleniyor... (${denemeSayisi}/${maxDeneme})`);
              setTimeout(checkAndActivate, 200);
            } else {
              console.log(`âš ï¸ ${enBuyukHaftaIndex}. hafta iÃ§in eÅŸleÅŸen kartlar ${maxDeneme} denemede hazÄ±r olamadÄ±, tab zorla aktif hale getiriliyor`);
              switchTab(enBuyukHaftaIndex);
            }
          };
          
          checkAndActivate();
        }, 500); // Ä°lk gecikmeyi artÄ±rdÄ±k
      }
    }
    
    // Tab deÄŸiÅŸtirme fonksiyonu
    function switchTab(activeIndex) {
      // TÃ¼m tablarÄ± pasif yap
      document.querySelectorAll('.hafta-tab').forEach((tab, index) => {
        tab.classList.toggle('active', index === activeIndex);
      });
      
      // TÃ¼m iÃ§erikleri gizle
      document.querySelectorAll('.hafta-tab-content').forEach((content, index) => {
        content.classList.toggle('active', index === activeIndex);
      });
      
      // Sidebar'larÄ± gÃ¼ncelle
      haftaTabSecildiginde(activeIndex);
      
      console.log(`ğŸ·ï¸ ${activeIndex + 1}. hafta tab'Ä±na geÃ§ildi`);
    }
    
    // Tab deÄŸiÅŸtirme fonksiyonunu global yap
    window.switchTab = switchTab;

// Hafta aÃ§Ä±klama kaydet (otomatik)
function aciklamaKaydet(i) {
  const haftalar = getHaftaListesi();
  const hafta = haftalar[i];
  const aciklamaInput = document.getElementById('aciklama_' + i);
  
  // Kilit kontrolÃ¼
  if (hafta.kilitli) {
    alert('ğŸ”’ Bu hafta kilitli! AÃ§Ä±klama deÄŸiÅŸtirmek iÃ§in Ã¶nce kilidi aÃ§Ä±n.');
    // Eski deÄŸeri geri yÃ¼kle
    aciklamaInput.value = hafta.aciklama || '';
    return;
  }
  
  hafta.aciklama = aciklamaInput.value;
  saveToStorage();
  
  // Visual feedback
  aciklamaInput.style.backgroundColor = '#d4edda';
  aciklamaInput.style.borderColor = '#28a745';
  setTimeout(() => {
    aciklamaInput.style.backgroundColor = '';
    aciklamaInput.style.borderColor = '';
  }, 800);
  
  console.log('âœ… AÃ§Ä±klama otomatik kaydedildi:', aciklamaInput.value);
  
  // YENÄ° SÄ°STEM: GitHub'a da kaydet
  if (seciliHasta) {
    hastayiAyriKaydet(seciliHasta).then(basarili => {
      if (basarili) {
        console.log('âœ… AÃ§Ä±klama GitHub\'a da kaydedildi');
      } else {
        console.warn('âš ï¸ AÃ§Ä±klama localStorage\'a kaydedildi ama GitHub kaydÄ± baÅŸarÄ±sÄ±z');
      }
    }).catch(error => {
      console.error('âŒ GitHub kaydetme hatasÄ±:', error);
    });
  }
}

// Hafta numarasÄ± dÃ¼zenleme (inline editing)
function editHaftaNo(i) {
  const displaySpan = document.getElementById(`haftaNoDisplay_${i}`);
  const inputField = document.getElementById(`haftaNo_${i}`);
  
  // Display'i gizle, input'u gÃ¶ster
  displaySpan.style.display = 'none';
  inputField.style.display = 'inline-block';
  inputField.focus();
  inputField.select();
  
  // Visual feedback
  inputField.style.backgroundColor = '#e3f2fd';
}

function saveHaftaNo(i) {
  const displaySpan = document.getElementById(`haftaNoDisplay_${i}`);
  const inputField = document.getElementById(`haftaNo_${i}`);
  const yeniHaftaNo = parseInt(inputField.value);
  
  if (yeniHaftaNo < 1 || yeniHaftaNo > 52 || isNaN(yeniHaftaNo)) {
    alert('Hafta numarasÄ± 1-52 arasÄ±nda olmalÄ±dÄ±r!');
    const haftalar = getHaftaListesi();
    inputField.value = haftalar[i].haftaNo || (i + 1);
    return;
  }
  
  // Veriyi kaydet
  const haftalar = getHaftaListesi();
  haftalar[i].haftaNo = yeniHaftaNo;
  saveToStorage();
  
  // UI'Ä± gÃ¼ncelle
  displaySpan.textContent = yeniHaftaNo;
  displaySpan.style.display = 'inline-block';
  inputField.style.display = 'none';
  inputField.style.backgroundColor = '';
  
  // Tab baÅŸlÄ±ÄŸÄ±nÄ± gÃ¼ncelle
  const tablar = document.querySelectorAll('.hafta-tab');
  if (tablar[i]) {
    const tabBaslik = tablar[i].querySelector('div:first-child');
    if (tabBaslik) {
      tabBaslik.textContent = `${yeniHaftaNo}. Hafta`;
    }
  }
  
  // Success feedback
  displaySpan.style.backgroundColor = '#d4edda';
  displaySpan.style.color = '#155724';
  setTimeout(() => {
    displaySpan.style.backgroundColor = '';
    displaySpan.style.color = '';
  }, 1000);
  
  console.log(`Hafta numarasÄ± gÃ¼ncellendi: ${yeniHaftaNo}. hafta`);
}

// Global fonksiyonlar
window.editHaftaNo = editHaftaNo;
window.saveHaftaNo = saveHaftaNo;

// Hafta numarasÄ± kaydet (eski fonksiyon - backward compatibility)
function haftaNoKaydet(i) {
  saveHaftaNo(i);
}

// PDF dosya adÄ±ndan hafta numarasÄ±nÄ± Ã§Ä±kar
function pdfDosyaAdindenHaftaNoAl(dosyaAdi) {
  if (!dosyaAdi) return null;
  
  // FarklÄ± hafta formatlarÄ±nÄ± kontrol et
  const patterns = [
    /(\d+)\.?\s*hafta/i,           // "8. hafta", "8 hafta", "8.hafta"
    /hafta\s*(\d+)/i,              // "hafta 8", "hafta8"
    /week\s*(\d+)/i,               // "week 8", "week8"
    /(\d+)\.?\s*week/i,            // "8. week", "8 week"
    /w(\d+)/i,                     // "w8", "W8"
    /(\d+)\.?\s*hf/i,              // "8. hf", "8 hf", "8hf"
    /hf\s*(\d+)/i,                 // "hf 8", "hf8"
    /(\d+)\.?\s*h(?![a-z])/i,      // "8. h", "8 h", "8h" (ama "hafta" olmayacak)
  ];
  
  for (let pattern of patterns) {
    const match = dosyaAdi.match(pattern);
    if (match) {
      const haftaNo = parseInt(match[1]);
      if (haftaNo >= 1 && haftaNo <= 52) {
        console.log(`ğŸ“… PDF dosya adÄ±ndan hafta numarasÄ± bulundu: "${dosyaAdi}" â†’ ${haftaNo}. hafta`);
        return haftaNo;
      }
    }
  }
  
  console.log(`âš ï¸ PDF dosya adÄ±ndan hafta numarasÄ± Ã§Ä±karÄ±lamadÄ±: "${dosyaAdi}"`);
  return null;
}

// PDF iÃ§eriÄŸinden hafta numarasÄ±nÄ± Ã§Ä±kar
function pdfIcerigindenhaftaNoAl(pdfIcerik) {
  if (!pdfIcerik) return null;
  
  // Ä°lk birkaÃ§ satÄ±rdan hafta numarasÄ±nÄ± ara
  const ilkSatirlar = pdfIcerik.split('\n').slice(0, 20).join(' ');
  
  const patterns = [
    /(\d+)\.?\s*hafta/i,
    /hafta\s*(\d+)/i,
    /week\s*(\d+)/i,
    /(\d+)\.?\s*week/i,
  ];
  
  for (let pattern of patterns) {
    const match = ilkSatirlar.match(pattern);
    if (match) {
      const haftaNo = parseInt(match[1]);
      if (haftaNo >= 1 && haftaNo <= 52) {
        console.log(`ğŸ“„ PDF iÃ§eriÄŸinden hafta numarasÄ± bulundu: ${haftaNo}. hafta`);
        return haftaNo;
      }
    }
  }
  
  return null;
}

// Hafta sil
async function silHafta(i) {
  if (!seciliHasta) {
    alert('âŒ LÃ¼tfen Ã¶nce bir hasta seÃ§in!');
    return;
  }

  const haftalar = getHaftaListesi();
  const silinecekHafta = haftalar[i];
  
  if (!silinecekHafta) {
    alert('âŒ Silinecek hafta bulunamadÄ±!');
    return;
  }

  if (!confirm(`Bu haftayÄ± silmek istediÄŸinize emin misiniz?\n\nHafta: ${silinecekHafta.haftaNo}\nTarih AralÄ±ÄŸÄ±: ${silinecekHafta.baslangic} - ${silinecekHafta.bitis}\n\nâš ï¸ Bu iÅŸlem geri alÄ±namaz!`)) {
    return;
  }

  try {
    console.log(`ğŸ—‘ï¸ Hafta ${silinecekHafta.haftaNo} siliniyor...`);
    
    // 1. Web arayÃ¼zÃ¼nden sil
    haftalar.splice(i, 1);
    console.log('âœ… Hafta web arayÃ¼zÃ¼nden silindi');
    
    // 2. Cache'den sil (localStorage)
    try {
      const cacheKey = `hasta_${seciliHasta.id}`;
      const cachedData = localStorage.getItem(cacheKey);
      if (cachedData) {
        const parsedData = JSON.parse(cachedData);
        if (parsedData.haftalar) {
          parsedData.haftalar = parsedData.haftalar.filter(h => h.haftaNo !== silinecekHafta.haftaNo);
          localStorage.setItem(cacheKey, JSON.stringify(parsedData));
          console.log('âœ… Hafta cache\'den silindi');
        }
      }
    } catch (cacheError) {
      console.warn('âš ï¸ Cache temizleme hatasÄ±:', cacheError);
    }
    
    // 3. Hasta JSON dosyasÄ±ndan sil (GitHub'a kaydet)
    try {
      // seciliHasta nesnesini de gÃ¼ncelle
      if (seciliHasta.haftalar) {
        seciliHasta.haftalar = seciliHasta.haftalar.filter(h => h.haftaNo !== silinecekHafta.haftaNo);
      }
      
      // GitHub'a kaydet
      const kaydedildi = await hastayiAyriKaydet(seciliHasta);
      if (kaydedildi) {
        console.log('âœ… Hafta hasta JSON dosyasÄ±ndan silindi ve GitHub\'a kaydedildi');
      } else {
        console.warn('âš ï¸ GitHub\'a kaydetme baÅŸarÄ±sÄ±z, sadece yerel silme yapÄ±ldÄ±');
      }
    } catch (githubError) {
      console.warn('âš ï¸ GitHub kaydetme hatasÄ±:', githubError);
    }
    
    // 4. UI'Ä± gÃ¼ncelle
    gosterHaftalar();
    
    // 5. Hasta listesini gÃ¼ncelle
    if (typeof updateHastaListesi === 'function') {
      updateHastaListesi();
    }
    
    console.log(`âœ… Hafta ${silinecekHafta.haftaNo} baÅŸarÄ±yla silindi`);
    alert(`âœ… Hafta ${silinecekHafta.haftaNo} baÅŸarÄ±yla silindi!`);
    
  } catch (error) {
    console.error('âŒ Hafta silme hatasÄ±:', error);
    alert(`âŒ Hafta silinirken hata oluÅŸtu: ${error.message}`);
  }
}

// Hafta dÃ¼zenle (tarih ve aÃ§Ä±klama)
function duzenleHafta(i) {
  const haftalar = getHaftaListesi();
  const hafta = haftalar[i];
  const yeniBaslangic = prompt('Yeni baÅŸlangÄ±Ã§ tarihi (YYYY-MM-DD):', hafta.baslangic);
  if (!yeniBaslangic) return;
  const yeniBitis = prompt('Yeni bitiÅŸ tarihi (YYYY-MM-DD):', hafta.bitis);
  if (!yeniBitis) return;
  hafta.baslangic = yeniBaslangic;
  hafta.bitis = yeniBitis;
  hafta.aciklama = document.getElementById('aciklama_' + i).value;
  
  // Otomatik kaydetme - hafta dÃ¼zenlendi
  autoSaveHastaData(seciliHasta);
  
  gosterHaftalar();
}

    // PDF'i GitHub'dan indirme fonksiyonu
    async function pdfIndir(githubRawLink, dosyaAdi) {
      try {
        console.log('ğŸ“¥ PDF indiriliyor:', dosyaAdi);
        
        const response = await fetch(githubRawLink);
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = dosyaAdi;
        document.body.appendChild(a);
        a.click();
        
        // Cleanup
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
        console.log('âœ… PDF baÅŸarÄ±yla indirildi:', dosyaAdi);
        
      } catch (error) {
        console.error('âŒ PDF indirme hatasÄ±:', error);
        alert(`PDF indirilemedi: ${error.message}`);
      }
    }

    // PDF'i browser'da gÃ¶rÃ¼ntÃ¼leme fonksiyonu
    function pdfGoruntule(pdfUrl) {
      try {
        console.log('ğŸ‘ï¸ PDF gÃ¶rÃ¼ntÃ¼leniyor:', pdfUrl);
        
        if (!pdfUrl) {
          alert('PDF URL\'si bulunamadÄ±.');
          return;
        }
        
        // Yeni sekmede PDF'i aÃ§
        window.open(pdfUrl, '_blank');
        
      } catch (error) {
        console.error('âŒ PDF gÃ¶rÃ¼ntÃ¼leme hatasÄ±:', error);
        alert(`PDF gÃ¶rÃ¼ntÃ¼lenemedi: ${error.message}`);
      }
    }

    async function haftaZipIndir(haftaIndex, haftaNo) {
      try {
        console.log('ğŸš€ ZIP fonksiyonu baÅŸlatÄ±ldÄ±, hafta:', haftaNo);
        
        if (!seciliHasta) {
          alert('LÃ¼tfen Ã¶nce bir hasta seÃ§in!');
          return;
        }

        // GitHub deÄŸiÅŸkenlerini kontrol et
        console.log('ğŸ” GITHUB_REPO:', GITHUB_REPO);
        console.log('ğŸ” GITHUB_TOKEN var mÄ±:', !!GITHUB_TOKEN);
        console.log('ğŸ” SeÃ§ili hasta:', seciliHasta.id);

        const haftalar = getHaftaListesi();
        if (!haftalar[haftaIndex]) {
          alert('Hafta bulunamadÄ±!');
          return;
        }

        const hafta = haftalar[haftaIndex];
        console.log('ğŸ” Hafta bilgileri:', hafta);
        
        const hasta = await getHastaData(seciliHasta.id);
        
        // ZIP dosya adÄ±nÄ± oluÅŸtur
        const tarihAraligi = `${hafta.baslangic}_${hafta.bitis}`.replace(/\./g, '_').replace(/\s/g, '_');
        const hastaAdi = hasta.isim.toUpperCase().replace(/\s/g, '_').replace(/[Ä°Ä±Ã‡Ã§ÄÄŸÃœÃ¼ÅÅŸÃ–Ã¶]/g, match => {
          const trMap = {'Ä°': 'I', 'Ä±': 'i', 'Ã‡': 'C', 'Ã§': 'c', 'Ä': 'G', 'ÄŸ': 'g', 'Ãœ': 'U', 'Ã¼': 'u', 'Å': 'S', 'ÅŸ': 's', 'Ã–': 'O', 'Ã¶': 'o'};
          return trMap[match] || match;
        });
        const zipAdi = `${hastaAdi}_${tarihAraligi}_${haftaNo}_HAFTA.ZIP`;

        // JSZip instance oluÅŸtur
        const zip = new JSZip();

        // 5. hafta iÃ§in Ã¶zel iÃ§erik
        if (haftaNo === 5) {
          // MenÃ¼ PDF'si (5. hafta)
          if (hafta.pdfName || hafta.pdfOrijinalIsim) {
            try {
              if (!GITHUB_TOKEN) {
                console.warn('âš ï¸ GitHub token bulunamadÄ±, PDF eklenemeyecek');
                return;
              }
              
              const pdfFileName = hafta.pdfName || hafta.pdfOrijinalIsim;
              const pdfUrl = `https://api.github.com/repos/${GITHUB_REPO}/contents/patients/${seciliHasta.id}/hafta_${haftaNo}_${pdfFileName}`;
              
              console.log('ğŸ” 5. hafta PDF URL:', pdfUrl);
              console.log('ğŸ” PDF dosya adÄ±:', pdfFileName);
              
              const pdfResponse = await fetch(pdfUrl, {
                headers: { 'Authorization': `token ${GITHUB_TOKEN}` }
              });
              
              console.log('ğŸ” PDF response status:', pdfResponse.status);
              
              if (pdfResponse.ok) {
                const pdfData = await pdfResponse.json();
                const pdfBlob = base64ToBlob(pdfData.content, 'application/pdf');
                zip.file(`MENU_PDF_${hafta.pdfOrijinalIsim || hafta.pdfName || 'menu.pdf'}`, pdfBlob);
                console.log('âœ… 5. hafta MenÃ¼ PDF eklendi:', pdfFileName);
              } else {
                const errorText = await pdfResponse.text();
                console.warn('âŒ PDF yanÄ±tÄ± baÅŸarÄ±sÄ±z:', pdfResponse.status, errorText);
              }
            } catch (error) {
              console.warn('âŒ MenÃ¼ PDF eklenemedi:', error);
            }
          } else {
            console.warn('âš ï¸ 5. hafta PDF bilgisi bulunamadÄ±');
          }

          // EÅŸleÅŸen tarif kartlarÄ± (5. hafta) - JPG dosyalarÄ±
          if (hafta.tarifKartlar && hafta.tarifKartlar.length > 0) {
            for (const kart of hafta.tarifKartlar) {
              try {
                const response = await fetch(kart.data);
                if (response.ok) {
                  const blob = await response.blob();
                  zip.file(`TARIF_KARTI_${kart.name}`, blob);
                  console.log(`âœ… 5. hafta tarif kartÄ± eklendi: ${kart.name}`);
                } else {
                  console.warn(`âŒ Tarif kartÄ± indirilemedi: ${kart.name}`);
                }
              } catch (error) {
                console.warn(`âŒ Tarif kartÄ± hatasÄ±: ${kart.name}`, error);
              }
            }
          } else {
            console.warn('âš ï¸ 5. hafta tarif kartÄ± bulunamadÄ±');
          }

          // GPT MesajÄ± (5. hafta)
          if (hafta.gptMesaj && hafta.gptMesaj.trim()) {
            zip.file('GPT_MESAJI.txt', hafta.gptMesaj.trim());
            console.log('âœ… 5. hafta GPT mesajÄ± eklendi');
          } else {
            console.warn('âš ï¸ 5. hafta GPT mesajÄ± bulunamadÄ±');
          }

          // 5. hafta iÃ§in otomatik masaj planÄ± PDF'si ekle
          console.log('ğŸ¥ 5. hafta masaj PDF fonksiyonu Ã§aÄŸrÄ±lÄ±yor...');
          console.log('ğŸ” Ã‡AÄRI: haftalar verisi:', JSON.stringify(haftalar.slice(3, 6), null, 2)); // 4,5,6. haftalarÄ± gÃ¶ster
          await createAndAddLenfMasajPDF(zip, hasta, haftalar);
        }
        
        // 9. hafta iÃ§in Ã¶zel iÃ§erik
        if (haftaNo === 9) {
          // MenÃ¼ PDF'si (9. hafta)
          if (hafta.pdfName || hafta.pdfOrijinalIsim) {
            try {
              if (!GITHUB_TOKEN) {
                console.warn('âš ï¸ GitHub token bulunamadÄ±, PDF eklenemeyecek');
                return;
              }
              
              const pdfFileName = hafta.pdfName || hafta.pdfOrijinalIsim;
              const pdfUrl = `https://api.github.com/repos/${GITHUB_REPO}/contents/patients/${seciliHasta.id}/hafta_${haftaNo}_${pdfFileName}`;
              
              console.log('ğŸ” 9. hafta PDF URL:', pdfUrl);
              console.log('ğŸ” PDF dosya adÄ±:', pdfFileName);
              
              const pdfResponse = await fetch(pdfUrl, {
                headers: { 'Authorization': `token ${GITHUB_TOKEN}` }
              });
              
              console.log('ğŸ” PDF response status:', pdfResponse.status);
              
              if (pdfResponse.ok) {
                const pdfData = await pdfResponse.json();
                const pdfBlob = base64ToBlob(pdfData.content, 'application/pdf');
                zip.file(`MENU_PDF_${hafta.pdfOrijinalIsim || hafta.pdfName || 'menu.pdf'}`, pdfBlob);
                console.log('âœ… 9. hafta MenÃ¼ PDF eklendi:', pdfFileName);
              } else {
                const errorText = await pdfResponse.text();
                console.warn('âŒ PDF yanÄ±tÄ± baÅŸarÄ±sÄ±z:', pdfResponse.status, errorText);
              }
            } catch (error) {
              console.warn('âŒ MenÃ¼ PDF eklenemedi:', error);
            }
          } else {
            console.warn('âš ï¸ 9. hafta PDF bilgisi bulunamadÄ±');
          }

          // EÅŸleÅŸen tarif kartlarÄ± (9. hafta) - JPG dosyalarÄ±
          if (hafta.tarifKartlar && hafta.tarifKartlar.length > 0) {
            for (const kart of hafta.tarifKartlar) {
              try {
                const response = await fetch(kart.data);
                if (response.ok) {
                  const blob = await response.blob();
                  zip.file(`TARIF_KARTI_${kart.name}`, blob);
                  console.log(`âœ… 9. hafta tarif kartÄ± eklendi: ${kart.name}`);
                } else {
                  console.warn(`âŒ Tarif kartÄ± indirilemedi: ${kart.name}`);
                }
              } catch (error) {
                console.warn(`âŒ Tarif kartÄ± hatasÄ±: ${kart.name}`, error);
              }
            }
          } else {
            console.warn('âš ï¸ 9. hafta tarif kartÄ± bulunamadÄ±');
          }

          // GPT MesajÄ± (9. hafta)
          if (hafta.gptMesaj && hafta.gptMesaj.trim()) {
            zip.file('GPT_MESAJI.txt', hafta.gptMesaj.trim());
            console.log('âœ… 9. hafta GPT mesajÄ± eklendi');
          } else {
            console.warn('âš ï¸ 9. hafta GPT mesajÄ± bulunamadÄ±');
          }

          // 9. hafta iÃ§in otomatik egzersiz takvimi PDF'si ekle
          console.log('ğŸƒ 9. hafta egzersiz PDF fonksiyonu Ã§aÄŸrÄ±lÄ±yor...');
          // Hafta verilerini tabdakiyle senkronize et
          const guncelHaftalar = getHaftaListesi();
          await createAndAddEgzersizPDF(zip, hasta, guncelHaftalar);
        }

        // ZIP dosyasÄ±nÄ± oluÅŸtur ve indir
        const zipBlob = await zip.generateAsync({type: 'blob'});
        
        const url = window.URL.createObjectURL(zipBlob);
        const a = document.createElement('a');
        a.href = url;
        a.download = zipAdi;
        document.body.appendChild(a);
        a.click();
        
        // Cleanup
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
        console.log(`âœ… ${haftaNo}. hafta ZIP dosyasÄ± baÅŸarÄ±yla indirildi:`, zipAdi);
        
      } catch (error) {
        console.error('âŒ ZIP indirme hatasÄ±:', error);
        alert(`ZIP dosyasÄ± oluÅŸturulamadÄ±: ${error.message}`);
      }
    }

    // âš¡ YENÄ°: Belirli bir hafta tab'Ä±nÄ±n tarihini kullanarak masaj PDF'i oluÅŸtur
    async function generate5HaftaMasajPDF(besinciHaftaTab) {
      try {
        console.log('ğŸ¤² 5. hafta tab\'Ä±ndan masaj PDF oluÅŸturuluyor...', { 
          haftaNo: besinciHaftaTab.haftaNo, 
          baslangic: besinciHaftaTab.baslangic,
          bitis: besinciHaftaTab.bitis
        });
        
        // KÃ¼tÃ¼phane kontrolÃ¼
        if (!window.jspdf) {
          console.error('âŒ jsPDF kÃ¼tÃ¼phanesi yÃ¼klenmemiÅŸ');
          return null;
        }
        
        // 5. hafta tab'Ä±nÄ±n baÅŸlangÄ±Ã§ tarihini al
        const haftaBaslangici = new Date(besinciHaftaTab.baslangic + 'T00:00:00'); // Timezone safe
        console.log('âœ… 5. hafta tab baÅŸlangÄ±Ã§ tarihi:', haftaBaslangici.toLocaleDateString('tr-TR'));
        
        // PDF oluÅŸtur
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'mm', 'a4');
        
        // Hasta adÄ±nÄ± ASCII'ye Ã§evir
        const asciiHastaAdi = seciliHasta.isim
            .replace(/Å/g, 'S').replace(/ÅŸ/g, 's')
            .replace(/Ä/g, 'G').replace(/ÄŸ/g, 'g')
            .replace(/Ãœ/g, 'U').replace(/Ã¼/g, 'u')
            .replace(/Ä°/g, 'I').replace(/Ä±/g, 'i')
            .replace(/Ã–/g, 'O').replace(/Ã¶/g, 'o')
            .replace(/Ã‡/g, 'C').replace(/Ã§/g, 'c');
        
        // BaÅŸlÄ±k
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(14);
        doc.setTextColor(0, 0, 0);
        
        const title = `${asciiHastaAdi.toUpperCase()}`;
        const titleWidth = doc.getTextWidth(title);
        doc.text(title, (210 - titleWidth) / 2, 20);
        
        doc.setFontSize(12);
        const subtitle = 'LENF DRENAJ MASAJI PROGRAMI';
        const subtitleWidth = doc.getTextWidth(subtitle);
        doc.text(subtitle, (210 - subtitleWidth) / 2, 28);
        
        // AÃ§Ä±klama kutusu
        doc.setFontSize(8);
        doc.setFont('helvetica', 'normal');
        doc.rect(15, 32, 170, 10);
        doc.text('8 Haftalik Lenf Drenaj Masaji Uygulama Programi', 20, 36);
        doc.text('(5. Haftadan itibaren) - Yesil check isareti tamamlanan gunler', 20, 40);
        
        let currentY = 50;
        const gunler = ['Pazartesi', 'Sali', 'Carsamba', 'Persembe', 'Cuma', 'Cumartesi', 'Pazar'];
        
        // 8 haftalÄ±k program (5-12. haftalar)
        for (let lenfHaftaIndex = 0; lenfHaftaIndex < 8; lenfHaftaIndex++) {
          const gercekHaftaNo = lenfHaftaIndex + 5; // 5. haftadan baÅŸlar
          const haftaBaslangic = new Date(haftaBaslangici.getTime() + (lenfHaftaIndex * 7 * 24 * 60 * 60 * 1000));
          
          // Sayfa sonu kontrolÃ¼
          if (currentY > 270) {
            doc.addPage();
            currentY = 20;
          }
          
          // Hafta baÅŸlÄ±ÄŸÄ±
          doc.setTextColor(0, 0, 0);
          doc.setFont('helvetica', 'bold');
          doc.setFontSize(9);
          doc.rect(15, currentY, 170, 6);
          
          const haftaBaslangicStr = haftaBaslangic.toLocaleDateString('tr-TR');
          const haftaBitisStr = new Date(haftaBaslangic.getTime() + (6 * 24 * 60 * 60 * 1000)).toLocaleDateString('tr-TR');
          
          // âœ… 5. hafta masaj planÄ±: TÃ¼m haftalar normal siyah renkte
          doc.setTextColor(0, 0, 0);
          
          doc.text(`${gercekHaftaNo}. HAFTA (${haftaBaslangicStr} - ${haftaBitisStr})`, 20, currentY + 4);
          currentY += 8;
          
          // Tablo baÅŸlÄ±klarÄ±
          doc.setTextColor(0, 0, 0);
          doc.setFont('helvetica', 'bold');
          doc.setFontSize(9);
          
          const colWidths = [30, 40, 50, 50];
          let tableStartX = 15;
          
          // BaÅŸlÄ±k satÄ±rÄ±
          doc.rect(tableStartX, currentY, colWidths[0], 6);
          doc.text('TARIH', tableStartX + 2, currentY + 4);
          tableStartX += colWidths[0];
          
          doc.rect(tableStartX, currentY, colWidths[1], 6);
          doc.text('GUN', tableStartX + 2, currentY + 4);
          tableStartX += colWidths[1];
          
          doc.rect(tableStartX, currentY, colWidths[2], 6);
          doc.text('SABAH', tableStartX + 2, currentY + 4);
          tableStartX += colWidths[2];
          
          doc.rect(tableStartX, currentY, colWidths[3], 6);
          doc.text('AKSAM', tableStartX + 2, currentY + 4);
          currentY += 6;
          
          // Her gÃ¼n iÃ§in satÄ±r
          doc.setFont('helvetica', 'normal');
          doc.setFontSize(8);
          
          for (let gunIndex = 0; gunIndex < 7; gunIndex++) {
            const gunTarihi = new Date(haftaBaslangic.getTime() + (gunIndex * 24 * 60 * 60 * 1000));
            const tarihStr = gunTarihi.toLocaleDateString('tr-TR');
            const gun = gunler[gunIndex];
            
            // Masaj uygulama kontrolÃ¼
            let sabahUygulama = '-';
            let aksamUygulama = '-';
            
            if (lenfHaftaIndex < 2) {
              // Ä°lk 2 hafta (5-6): GÃ¼nde 2 kez
              sabahUygulama = 'Lenf Masaji';
              aksamUygulama = 'Lenf Masaji';
            } else if (lenfHaftaIndex < 4) {
              // Sonraki 2 hafta (7-8): GÃ¼nde 1 kez
              sabahUygulama = 'Lenf Masaji';
              aksamUygulama = '-';
            }
            
            tableStartX = 15;
            
            // âœ… 5. hafta masaj planÄ±: TÃ¼m yazÄ±lar normal siyah renkte
            doc.setTextColor(0, 0, 0);
            doc.setDrawColor(0, 0, 0);
            doc.setLineWidth(0.3);
            
            // Tarih sÃ¼tunu - sadece basit tablo, check yok
            doc.rect(tableStartX, currentY, colWidths[0], 5);
            doc.text(tarihStr, tableStartX + 2, currentY + 3.5);
            tableStartX += colWidths[0];
            
            // GÃ¼n sÃ¼tunu
            doc.rect(tableStartX, currentY, colWidths[1], 5);
            doc.text(gun, tableStartX + 2, currentY + 3.5);
            tableStartX += colWidths[1];
            
            // Sabah sÃ¼tunu
            doc.rect(tableStartX, currentY, colWidths[2], 5);
            doc.text(sabahUygulama, tableStartX + 2, currentY + 3.5);
            tableStartX += colWidths[2];
            
            // AkÅŸam sÃ¼tunu
            doc.rect(tableStartX, currentY, colWidths[3], 5);
            doc.text(aksamUygulama, tableStartX + 2, currentY + 3.5);
            
            currentY += 5;
          }
          
          currentY += 8;
        }
        
        // PDF'i blob olarak dÃ¶ndÃ¼r
        const pdfBlob = doc.output('blob');
        console.log('âœ… 5. hafta masaj PDF blob oluÅŸturuldu, boyut:', pdfBlob.size);
        return pdfBlob;
        
      } catch (error) {
        console.error('âŒ 5. hafta masaj PDF oluÅŸturma hatasÄ±:', error);
        return null;
      }
    }

    // 5. hafta iÃ§in Lenf Masaj PDF'si oluÅŸtur ve ZIP'e ekle
    async function createAndAddLenfMasajPDF(zip, hasta, haftalar, klasorYolu = '') {
      try {
        console.log('ğŸ¤² 5. hafta Lenf Masaj PDF oluÅŸturuluyor...', { hasta: hasta.isim });
        
        // KÃ¼tÃ¼phane kontrolÃ¼
        if (!window.jspdf) {
          console.error('âŒ jsPDF kÃ¼tÃ¼phanesi yÃ¼klenmemiÅŸ');
          return;
        }
        
        console.log('âœ… jsPDF kÃ¼tÃ¼phanesi bulundu:', typeof window.jspdf);
        
        // JSON verisinden doÄŸrudan 5. hafta baÅŸlangÄ±Ã§ tarihini al
        let haftaBaslangici = new Date();
        
        if (haftalar.length >= 5 && haftalar[4]?.baslangic) {
            console.log('  5. HAFTA RAW VERÄ°:', haftalar[4].baslangic, typeof haftalar[4].baslangic);
            // âš¡ Ã–NEMLÄ°: Tab'Ä±n baÅŸlangÄ±Ã§ tarihi zaten doÄŸru hesaplanmÄ±ÅŸ, ek hizalama yapma!
            haftaBaslangici = new Date(haftalar[4].baslangic + 'T00:00:00'); // Timezone safe parsing
            console.log('  5. HAFTA PARSED TARÄ°H:', haftaBaslangici.toISOString(), '|', haftaBaslangici.toLocaleDateString('tr-TR'));
        } else {
            console.log('âš ï¸ 5. hafta verisi bulunamadÄ±, gÃ¼ncel tarih kullanÄ±lÄ±yor');
            console.log('ğŸ” Toplam hafta sayÄ±sÄ±:', haftalar.length);
            console.log('ğŸ” 5. hafta verisi (index 4):', haftalar[4]);
            
            // Sadece veri yoksa pazartesi hizalamasÄ± yap
            const gunIndex = haftaBaslangici.getDay();
            const pazartesiyeKadarGun = gunIndex === 0 ? -6 : 1 - gunIndex;
            haftaBaslangici.setDate(haftaBaslangici.getDate() + pazartesiyeKadarGun);
        }
        
        console.log('ğŸ—“ï¸ MASAJ PDF BAÅLANGIÃ‡ TARÄ°HÄ°:', haftaBaslangici.toLocaleDateString('tr-TR'), '(gÃ¼n:', haftaBaslangici.getDay(), ')');

        // PDF oluÅŸtur - tekli tab versiyonuyla aynÄ± format
        const { jsPDF } = window.jspdf;
        if (!jsPDF) {
          console.error('âŒ jsPDF constructor bulunamadÄ±');
          return;
        }
        
        console.log('âœ… jsPDF constructor bulundu, PDF oluÅŸturuluyor...');
        
        const doc = new jsPDF('p', 'mm', 'a4'); // Tekli tab versiyonuyla aynÄ± format
        
        // Hasta adÄ±nÄ± ASCII'ye Ã§evir (tekli tab versiyonuyla aynÄ±)
        console.log('ğŸ” Orijinal hasta adÄ±:', hasta.isim);
        const asciiHastaAdi = hasta.isim
            .replace(/Å/g, 'S').replace(/ÅŸ/g, 's')
            .replace(/Ä/g, 'G').replace(/ÄŸ/g, 'g')
            .replace(/Ãœ/g, 'U').replace(/Ã¼/g, 'u')
            .replace(/Ä°/g, 'I').replace(/Ä±/g, 'i')
            .replace(/Ã–/g, 'O').replace(/Ã¶/g, 'o')
            .replace(/Ã‡/g, 'C').replace(/Ã§/g, 'c')
            .replace(/Æ/g, 'E').replace(/É™/g, 'e');
        console.log('ğŸ” ASCII hasta adÄ±:', asciiHastaAdi);
        
        // BaÅŸlÄ±k - tekli tab versiyonuyla aynÄ±
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(14);
        doc.setTextColor(0, 0, 0);
        
        const title = `${asciiHastaAdi.toUpperCase()}`;
        const titleWidth = doc.getTextWidth(title);
        doc.text(title, (210 - titleWidth) / 2, 20);
        
        doc.setFontSize(12);
        doc.setTextColor(0, 0, 0);
        
        // Lenf masaj baÅŸlÄ±ÄŸÄ± - ASCII karakterlerle
        const subtitle = 'LENF DRENAJ MASAJI PROGRAMI';
        const programBasligi = '8 Haftalik Lenf Drenaj Masaji Uygulama Programi';
        
        const subtitleWidth = doc.getTextWidth(subtitle);
        doc.text(subtitle, (210 - subtitleWidth) / 2, 28);
        
        // AÃ§Ä±klama kutusu - tekli tab versiyonuyla aynÄ±
        doc.setFontSize(8);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(0, 0, 0);
        doc.rect(15, 32, 170, 10);
        doc.text(programBasligi, 20, 36);
        doc.text(turkceKarakterDuzelt('(5. Haftadan itibaren) - Yesil check isareti tamamlanan gunler'), 20, 40);
        
        // 5. haftanÄ±n baÅŸlangÄ±cÄ±
        let currentY = 50;
        const gunler = ['Pazartesi', 'Sali', 'Carsamba', 'Persembe', 'Cuma', 'Cumartesi', 'Pazar'].map(gun => turkceKarakterDuzelt(gun));
        
        // 8 haftalÄ±k program (5-12. haftalar) - tekli tab versiyonuyla aynÄ±
        console.log('  PDF OLUÅTURMA: Ana tarih:', haftaBaslangici.toLocaleDateString('tr-TR'));
        
        for (let lenfHaftaIndex = 0; lenfHaftaIndex < 8; lenfHaftaIndex++) {
          const gercekHaftaNo = lenfHaftaIndex + 5; // 5. haftadan baÅŸlar
          const haftaBaslangic = new Date(haftaBaslangici.getTime() + (lenfHaftaIndex * 7 * 24 * 60 * 60 * 1000));
          
          if (lenfHaftaIndex === 0) { // Sadece ilk hafta (5. hafta) iÃ§in log
            console.log('ğŸŸ¢ PDF Ä°LK HAFTA:', haftaBaslangic.toLocaleDateString('tr-TR'));
          }
          
          // Sayfa sonu kontrolÃ¼ - hafta baÅŸlÄ±ÄŸÄ± iÃ§in yer var mÄ±?
          if (currentY > 270) {
            doc.addPage();
            currentY = 20;
          }
          
          // Hafta baÅŸlÄ±ÄŸÄ±
          doc.setTextColor(0, 0, 0);
          doc.setFont('helvetica', 'bold');
          doc.setFontSize(9);
          doc.rect(15, currentY, 170, 6);
          
          const haftaBaslangicStr = haftaBaslangic.toLocaleDateString('tr-TR');
          const haftaBitisStr = new Date(haftaBaslangic.getTime() + (6 * 24 * 60 * 60 * 1000)).toLocaleDateString('tr-TR');
          
          // 5. hafta PDF'si iÃ§in 9-12. haftalar soluk renkte olsun
          if (gercekHaftaNo >= 9) {
            doc.setTextColor(150, 150, 150); // Soluk gri renk
          } else {
            doc.setTextColor(0, 0, 0); // Normal siyah renk
          }
          
          doc.text(turkceKarakterDuzelt(`${gercekHaftaNo}. HAFTA (${haftaBaslangicStr} - ${haftaBitisStr})`), 20, currentY + 4);
          currentY += 8;
          
          // Tablo baÅŸlÄ±klarÄ± - tekli tab versiyonuyla aynÄ±
          doc.setTextColor(0, 0, 0);
          doc.setFont('helvetica', 'bold');
          doc.setFontSize(9);
          doc.setDrawColor(0, 0, 0);
          doc.setLineWidth(0.3);
          
          const colWidths = [30, 40, 50, 50]; // Tarih, GÃ¼n, Sabah, AkÅŸam
          let zipTableStartX = 15;
          
          // BaÅŸlÄ±k satÄ±rÄ±
          doc.rect(zipTableStartX, currentY, colWidths[0], 6);
          doc.text('TARIH', zipTableStartX + 2, currentY + 4);
          zipTableStartX += colWidths[0];
          
          doc.rect(zipTableStartX, currentY, colWidths[1], 6);
          doc.text('GUN', zipTableStartX + 2, currentY + 4);
          zipTableStartX += colWidths[1];
          
          doc.rect(zipTableStartX, currentY, colWidths[2], 6);
          doc.text('SABAH', zipTableStartX + 2, currentY + 4);
          zipTableStartX += colWidths[2];
          
          doc.rect(zipTableStartX, currentY, colWidths[3], 6);
          doc.text('AKSAM', zipTableStartX + 2, currentY + 4);
          currentY += 6;
          
          // Her gÃ¼n iÃ§in satÄ±r - tekli tab versiyonuyla aynÄ±
          doc.setFont('helvetica', 'normal');
          doc.setFontSize(8);
          
          for (let gunIndex = 0; gunIndex < 7; gunIndex++) {
            // Sayfa sonu kontrolÃ¼ - satÄ±r iÃ§in yer var mÄ±?
            if (currentY > 280) {
              doc.addPage();
              currentY = 20;
              
              // Yeni sayfada tablo baÅŸlÄ±klarÄ±nÄ± tekrar oluÅŸtur
              doc.setTextColor(0, 0, 0);
              doc.setFont('helvetica', 'bold');
              doc.setFontSize(9);
              doc.setDrawColor(0, 0, 0);
              doc.setLineWidth(0.3);
              
              let newPageTableStartX = 15;
              
              // BaÅŸlÄ±k satÄ±rÄ±
              doc.rect(newPageTableStartX, currentY, colWidths[0], 6);
              doc.text('TARIH', newPageTableStartX + 2, currentY + 4);
              newPageTableStartX += colWidths[0];
              
              doc.rect(newPageTableStartX, currentY, colWidths[1], 6);
              doc.text('GUN', newPageTableStartX + 2, currentY + 4);
              newPageTableStartX += colWidths[1];
              
              doc.rect(newPageTableStartX, currentY, colWidths[2], 6);
              doc.text('SABAH', newPageTableStartX + 2, currentY + 4);
              newPageTableStartX += colWidths[2];
              
              doc.rect(newPageTableStartX, currentY, colWidths[3], 6);
              doc.text('AKSAM', newPageTableStartX + 2, currentY + 4);
              currentY += 6;
              
              doc.setFont('helvetica', 'normal');
              doc.setFontSize(8);
            }
            
            const gunTarihi = new Date(haftaBaslangic.getTime() + (gunIndex * 24 * 60 * 60 * 1000));
            const tarihStr = gunTarihi.toLocaleDateString('tr-TR');
            const gun = gunler[gunIndex];
            
            // Uygulama kontrolÃ¼ - lenf masajÄ± versiyonu (tekli tab versiyonuyla aynÄ± mantÄ±k)
            let sabahUygulama = '-';
            let aksamUygulama = '-';
            
            if (lenfHaftaIndex < 2) {
              // Ä°lk 2 hafta (5-6): GÃ¼nde 2 kez lenf masajÄ±
              sabahUygulama = turkceKarakterDuzelt('Lenf Masaji');
              aksamUygulama = turkceKarakterDuzelt('Lenf Masaji');
            } else if (lenfHaftaIndex < 4) {
              // Sonraki 2 hafta (7-8): GÃ¼nde 1 kez lenf masajÄ± (sabah)
              sabahUygulama = turkceKarakterDuzelt('Lenf Masaji');
              aksamUygulama = '-';
            } else {
              // 9-12. haftalar: lenf masajÄ± yok (egzersiz baÅŸlamÄ±ÅŸ)
              sabahUygulama = '-';
              aksamUygulama = '-';
            }
            
            zipTableStartX = 15;
            
            // 5. hafta PDF'si iÃ§in 5-8. haftalar yeÅŸil check'li olsun
            if (gercekHaftaNo <= 8) {
              doc.setTextColor(0, 0, 0); // Normal siyah renk
            } else {
              doc.setTextColor(150, 150, 150); // Soluk gri renk
            }
            
            // Tablo Ã§izgi ayarlarÄ±
            doc.setDrawColor(0, 0, 0);
            doc.setLineWidth(0.3);
            
            // Tarih sÃ¼tunu
            doc.rect(zipTableStartX, currentY, colWidths[0], 5);
            
            // 5. hafta PDF'si ve aktif haftalar (5-8) yeÅŸil check simgesi ekle
            if (gercekHaftaNo <= 8) {
              // YeÅŸil check kutusu Ã§iz
              doc.setFillColor(0, 128, 0); // YeÅŸil dolgu
              doc.rect(zipTableStartX + 1, currentY + 1, 4, 3, 'F'); // YeÅŸil dikdÃ¶rtgen
              
              // Beyaz check Ã§izgisi Ã§iz
              doc.setDrawColor(255, 255, 255); // Beyaz Ã§izgi
              doc.setLineWidth(0.5);
              // Check iÅŸareti Ã§izgisi (V ÅŸekli)
              doc.line(zipTableStartX + 1.5, currentY + 2.5, zipTableStartX + 2.5, currentY + 3.2);
              doc.line(zipTableStartX + 2.5, currentY + 3.2, zipTableStartX + 4.2, currentY + 1.5);
              
              // Tablo Ã§izgi ayarlarÄ±nÄ± geri yÃ¼kle
              doc.setDrawColor(0, 0, 0);
              doc.setLineWidth(0.3);
              
              // Tarihi normal renkte yaz
              doc.setTextColor(0, 0, 0);
              doc.text(tarihStr, zipTableStartX + 7, currentY + 3.5);
            } else {
              // Gelecek haftalar iÃ§in tarih soluk renkte
              doc.setTextColor(150, 150, 150);
              doc.text(tarihStr, zipTableStartX + 2, currentY + 3.5);
            }
            zipTableStartX += colWidths[0];
            
            // GÃ¼n sÃ¼tunu
            doc.rect(zipTableStartX, currentY, colWidths[1], 5);
            doc.text(gun, zipTableStartX + 2, currentY + 3.5);
            zipTableStartX += colWidths[1];
            
            // Sabah sÃ¼tunu
            doc.rect(zipTableStartX, currentY, colWidths[2], 5);
            doc.text(sabahUygulama, zipTableStartX + 2, currentY + 3.5);
            zipTableStartX += colWidths[2];
            
            // AkÅŸam sÃ¼tunu
            doc.rect(zipTableStartX, currentY, colWidths[3], 5);
            doc.text(aksamUygulama, zipTableStartX + 2, currentY + 3.5);
            
            currentY += 5;
          }
          
          currentY += 8; // Haftalar arasÄ± boÅŸluk
        }
        
        // PDF'i blob olarak al ve ZIP'e ekle
        const pdfBlob = doc.output('blob');
        const dosyaAdi = `${asciiHastaAdi}_Lenf_Masaj_Takvimi.pdf`;
        zip.file(klasorYolu + dosyaAdi, pdfBlob);
        
        console.log('âœ… 5. hafta Lenf Masaj PDF ZIP\'e eklendi:', dosyaAdi);
        
      } catch (error) {
        console.error('âŒ Lenf Masaj PDF oluÅŸturma hatasÄ±:', error);
      }
    }

    async function createAndAddEgzersizPDF(zip, hasta, haftalar, klasorYolu = '') {
      try {
        console.log('ğŸƒ 9. hafta Egzersiz PDF oluÅŸturuluyor...', { hasta: hasta.isim });
        
        // KÃ¼tÃ¼phane kontrolÃ¼
        if (!window.jspdf) {
          console.error('âŒ jsPDF kÃ¼tÃ¼phanesi yÃ¼klenmemiÅŸ');
          return;
        }
        
        console.log('âœ… jsPDF kÃ¼tÃ¼phanesi bulundu:', typeof window.jspdf);
        
    // 9. hafta tabÄ±ndaki baÅŸlangÄ±Ã§ ve bitiÅŸ tarihini doÄŸrudan kullan
    let haftaBaslangici = new Date();
    let haftaBitisi = new Date();
    
    // 9. haftayÄ± hafta numarasÄ±na gÃ¶re bul (index 8 deÄŸil!)
    const dokuzuncuHafta = haftalar.find(h => h.haftaNo === 9);
    if (dokuzuncuHafta?.baslangic && dokuzuncuHafta?.bitis) {
      haftaBaslangici = new Date(dokuzuncuHafta.baslangic + 'T00:00:00');
      haftaBitisi = new Date(dokuzuncuHafta.bitis + 'T00:00:00');
      console.log('ğŸ”µ 9. HAFTA TAB BAÅLANGIÃ‡ (hafta no ile bulundu):', haftaBaslangici.toLocaleDateString('tr-TR'));
      console.log('ğŸ”µ 9. HAFTA TAB BÄ°TÄ°Å (hafta no ile bulundu):', haftaBitisi.toLocaleDateString('tr-TR'));
    } else if (haftalar.length >= 9 && haftalar[8]?.baslangic && haftalar[8]?.bitis) {
      // Fallback: index ile dene
      haftaBaslangici = new Date(haftalar[8].baslangic + 'T00:00:00');
      haftaBitisi = new Date(haftalar[8].bitis + 'T00:00:00');
      console.log('ğŸ”µ 9. HAFTA TAB BAÅLANGIÃ‡ (index ile):', haftaBaslangici.toLocaleDateString('tr-TR'));
      console.log('ğŸ”µ 9. HAFTA TAB BÄ°TÄ°Å (index ile):', haftaBitisi.toLocaleDateString('tr-TR'));
    } else if (haftalar.length >= 5 && haftalar[4]?.baslangic) {
      // 5. haftadan 4 hafta sonrasÄ±nÄ± hesapla (eski fallback)
      const besinciHafta = new Date(haftalar[4].baslangic + 'T00:00:00');
      haftaBaslangici = new Date(besinciHafta.getTime() + (4 * 7 * 24 * 60 * 60 * 1000));
      haftaBitisi = new Date(haftaBaslangici.getTime() + 6 * 24 * 60 * 60 * 1000);
      console.log('ğŸ”µ 9. HAFTA HESAPLANAN:', haftaBaslangici.toLocaleDateString('tr-TR'));
    } else {
      console.log('âš ï¸ Hafta verisi bulunamadÄ±, gÃ¼ncel tarih kullanÄ±lÄ±yor');
      console.log('ğŸ” Toplam hafta sayÄ±sÄ±:', haftalar.length);
    }

    // Pazartesi'ye hizalama kaldÄ±rÄ±ldÄ±, tabdaki tarih doÄŸrudan kullanÄ±lacak

        // PDF oluÅŸtur - tekli tab versiyonuyla aynÄ± format
        const { jsPDF } = window.jspdf;
        if (!jsPDF) {
          console.error('âŒ jsPDF constructor bulunamadÄ±');
          return;
        }
        
        console.log('âœ… jsPDF constructor bulundu, PDF oluÅŸturuluyor...');
        
        const doc = new jsPDF('p', 'mm', 'a4'); // Tekli tab versiyonuyla aynÄ± format
        
        // Hasta adÄ±nÄ± ASCII'ye Ã§evir (tekli tab versiyonuyla aynÄ±)
        console.log('ğŸ” Orijinal hasta adÄ±:', hasta.isim);
        const asciiHastaAdi = hasta.isim
            .replace(/Å/g, 'S').replace(/ÅŸ/g, 's')
            .replace(/Ä/g, 'G').replace(/ÄŸ/g, 'g')
            .replace(/Ãœ/g, 'U').replace(/Ã¼/g, 'u')
            .replace(/Ä°/g, 'I').replace(/Ä±/g, 'i')
            .replace(/Ã–/g, 'O').replace(/Ã¶/g, 'o')
            .replace(/Ã‡/g, 'C').replace(/Ã§/g, 'c')
            .replace(/Æ/g, 'E').replace(/É™/g, 'e');
        console.log('ğŸ” ASCII hasta adÄ±:', asciiHastaAdi);
        
        // BaÅŸlÄ±k - tekli tab versiyonuyla aynÄ±
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(14);
        doc.setTextColor(0, 0, 0);
        
        const title = `${asciiHastaAdi.toUpperCase()}`;
        const titleWidth = doc.getTextWidth(title);
        doc.text(title, (210 - titleWidth) / 2, 20);
        
        doc.setFontSize(12);
        doc.setTextColor(0, 0, 0);
        
        // Egzersiz + lenf masaj baÅŸlÄ±ÄŸÄ± - ASCII karakterlerle
        const subtitle = 'EGZERSIZ VE LENF DRENAJ MASAJI PROGRAMI';
        const programBasligi = '8 Haftalik Egzersiz ve Lenf Drenaj Masaji Uygulama Programi';
        
        const subtitleWidth = doc.getTextWidth(subtitle);
        doc.text(subtitle, (210 - subtitleWidth) / 2, 28);
        
        // AÃ§Ä±klama kutusu - tekli tab versiyonuyla aynÄ±
        doc.setFontSize(8);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(0, 0, 0);
        doc.rect(15, 32, 170, 10);
        doc.text(programBasligi, 20, 36);
        doc.text(turkceKarakterDuzelt('(5. Haftadan itibaren) - Yesil check isareti tamamlanan gunler'), 20, 40);
        
        // 9. haftanÄ±n baÅŸlangÄ±cÄ± (baslangicTarihi 9. hafta baÅŸlangÄ±cÄ± kabul edilir)
        let currentY = 50;
        const gunler = ['Pazartesi', 'Sali', 'Carsamba', 'Persembe', 'Cuma', 'Cumartesi', 'Pazar'].map(gun => turkceKarakterDuzelt(gun));
        
        // 8 haftalÄ±k program (5-12. haftalar) - 9. hafta tabÄ±ndaki tarih referans alÄ±nacak
        for (let lenfHaftaIndex = 0; lenfHaftaIndex < 8; lenfHaftaIndex++) {
          const gercekHaftaNo = lenfHaftaIndex + 5; // 5. haftadan baÅŸlar
          // 9. hafta tabÄ±ndaki baÅŸlangÄ±Ã§tan itibaren haftalarÄ± sÄ±rala
          const haftaBaslangic = new Date(haftaBaslangici.getTime() + ((lenfHaftaIndex - 4) * 7 * 24 * 60 * 1000));
          // Sayfa sonu kontrolÃ¼ - hafta baÅŸlÄ±ÄŸÄ± iÃ§in yer var mÄ±?
          if (currentY > 270) {
            doc.addPage();
            currentY = 20;
          }
          // Hafta baÅŸlÄ±ÄŸÄ±
          doc.setTextColor(0, 0, 0);
          doc.setFont('helvetica', 'bold');
          doc.setFontSize(9);
          doc.rect(15, currentY, 170, 6);
          const haftaBaslangicStr = haftaBaslangic.toLocaleDateString('tr-TR');
          const haftaBitisStr = new Date(haftaBaslangic.getTime() + (6 * 24 * 60 * 60 * 1000)).toLocaleDateString('tr-TR');
          // 9. hafta PDF'si iÃ§in 5-8. haftalar soluk renkte olsun
          if (gercekHaftaNo <= 8) {
            doc.setTextColor(150, 150, 150); // Soluk gri renk
          } else {
            doc.setTextColor(0, 0, 0); // Normal siyah renk
          }
          doc.text(turkceKarakterDuzelt(`${gercekHaftaNo}. HAFTA (${haftaBaslangicStr} - ${haftaBitisStr})`), 20, currentY + 4);
          currentY += 8;
          
          // Tablo baÅŸlÄ±klarÄ± - tekli tab versiyonuyla aynÄ±
          doc.setTextColor(0, 0, 0);
          doc.setFont('helvetica', 'bold');
          doc.setFontSize(9);
          doc.setDrawColor(0, 0, 0);
          doc.setLineWidth(0.3);
          
          const colWidths = [30, 40, 50, 50]; // Tarih, GÃ¼n, Sabah, AkÅŸam
          let zipTableStartX = 15;
          
          // BaÅŸlÄ±k satÄ±rÄ±
          doc.rect(zipTableStartX, currentY, colWidths[0], 6);
          doc.text('TARIH', zipTableStartX + 2, currentY + 4);
          zipTableStartX += colWidths[0];
          
          doc.rect(zipTableStartX, currentY, colWidths[1], 6);
          doc.text('GUN', zipTableStartX + 2, currentY + 4);
          zipTableStartX += colWidths[1];
          
          doc.rect(zipTableStartX, currentY, colWidths[2], 6);
          doc.text('SABAH', zipTableStartX + 2, currentY + 4);
          zipTableStartX += colWidths[2];
          
          doc.rect(zipTableStartX, currentY, colWidths[3], 6);
          doc.text('AKSAM', zipTableStartX + 2, currentY + 4);
          currentY += 6;
          
          // Her gÃ¼n iÃ§in satÄ±r - tekli tab versiyonuyla aynÄ±
          doc.setFont('helvetica', 'normal');
          doc.setFontSize(8);
          
          for (let gunIndex = 0; gunIndex < 7; gunIndex++) {
            // Sayfa sonu kontrolÃ¼ - satÄ±r iÃ§in yer var mÄ±?
            if (currentY > 280) {
              doc.addPage();
              currentY = 20;
              
              // Yeni sayfada tablo baÅŸlÄ±klarÄ±nÄ± tekrar oluÅŸtur
              doc.setTextColor(0, 0, 0);
              doc.setFont('helvetica', 'bold');
              doc.setFontSize(9);
              doc.setDrawColor(0, 0, 0);
              doc.setLineWidth(0.3);
              
              let newPageTableStartX = 15;
              
              // BaÅŸlÄ±k satÄ±rÄ±
              doc.rect(newPageTableStartX, currentY, colWidths[0], 6);
              doc.text('TARIH', newPageTableStartX + 2, currentY + 4);
              newPageTableStartX += colWidths[0];
              
              doc.rect(newPageTableStartX, currentY, colWidths[1], 6);
              doc.text('GUN', newPageTableStartX + 2, currentY + 4);
              newPageTableStartX += colWidths[1];
              
              doc.rect(newPageTableStartX, currentY, colWidths[2], 6);
              doc.text('SABAH', newPageTableStartX + 2, currentY + 4);
              newPageTableStartX += colWidths[2];
              
              doc.rect(newPageTableStartX, currentY, colWidths[3], 6);
              doc.text('AKSAM', newPageTableStartX + 2, currentY + 4);
              currentY += 6;
              
              doc.setFont('helvetica', 'normal');
              doc.setFontSize(8);
            }
            
            const gunTarihi = new Date(haftaBaslangic.getTime() + (gunIndex * 24 * 60 * 60 * 1000));
            const tarihStr = gunTarihi.toLocaleDateString('tr-TR');
            const gun = gunler[gunIndex];
            
            // Uygulama kontrolÃ¼ - egzersiz dahil versiyonu (tekli tab versiyonuyla aynÄ± mantÄ±k)
            let sabahUygulama = '-';
            let aksamUygulama = '-';
            
            if (lenfHaftaIndex < 2) {
              // Ä°lk 2 hafta (5-6): GÃ¼nde 2 kez lenf masajÄ±
              sabahUygulama = turkceKarakterDuzelt('Lenf Masaji');
              aksamUygulama = turkceKarakterDuzelt('Lenf Masaji');
            } else if (lenfHaftaIndex < 4) {
              // Sonraki 2 hafta (7-8): GÃ¼nde 1 kez lenf masajÄ± (sabah)
              sabahUygulama = turkceKarakterDuzelt('Lenf Masaji');
              aksamUygulama = '-';
            } else if (lenfHaftaIndex < 6) {
              // Sonraki 2 hafta (9-10): GÃ¼naÅŸÄ±rÄ± lenf masajÄ± + egzersiz
              if (gunIndex === 0 || gunIndex === 2 || gunIndex === 4 || gunIndex === 6) {
                // Pazartesi, Ã‡arÅŸamba, Cuma, Pazar: Lenf masajÄ± + akÅŸam egzersiz
                sabahUygulama = turkceKarakterDuzelt('Lenf Masaji');
                aksamUygulama = turkceKarakterDuzelt('Egzersiz-2');
              } else {
                // SalÄ±, PerÅŸembe, Cumartesi: Sabah ve akÅŸam egzersiz
                sabahUygulama = turkceKarakterDuzelt('Egzersiz-1');
                aksamUygulama = turkceKarakterDuzelt('Egzersiz-2');
              }
            } else {
              // Son 2 hafta (11-12): Haftada 2 gÃ¼n lenf masajÄ± + sÃ¼rekli egzersiz
              if (gunIndex === 1 || gunIndex === 4) { // SalÄ±, Cuma
                sabahUygulama = turkceKarakterDuzelt('Lenf Masaji');
                aksamUygulama = turkceKarakterDuzelt('Egzersiz-2');
              } else {
                sabahUygulama = turkceKarakterDuzelt('Egzersiz-1');
                aksamUygulama = turkceKarakterDuzelt('Egzersiz-2');
              }
            }
            
            zipTableStartX = 15;
            
            // 9. hafta PDF'si iÃ§in 5-8. haftalar soluk renkte olsun
            if (gercekHaftaNo <= 8) {
              doc.setTextColor(150, 150, 150); // Soluk gri renk
            } else {
              doc.setTextColor(0, 0, 0); // Normal siyah renk
            }
            
            // Tablo Ã§izgi ayarlarÄ±
            doc.setDrawColor(0, 0, 0);
            doc.setLineWidth(0.3);
            
            // Tarih sÃ¼tunu
            doc.rect(zipTableStartX, currentY, colWidths[0], 5);
            
            // 9. hafta PDF'si ve geÃ§miÅŸ haftalarda (5-8) yeÅŸil check simgesi ekle
            if (gercekHaftaNo <= 8) {
              // YeÅŸil check kutusu Ã§iz
              doc.setFillColor(0, 128, 0); // YeÅŸil dolgu
              doc.rect(zipTableStartX + 1, currentY + 1, 4, 3, 'F'); // YeÅŸil dikdÃ¶rtgen
              
              // Beyaz check Ã§izgisi Ã§iz
              doc.setDrawColor(255, 255, 255); // Beyaz Ã§izgi
              doc.setLineWidth(0.5);
              // Check iÅŸareti Ã§izgisi (V ÅŸekli)
              doc.line(zipTableStartX + 1.5, currentY + 2.5, zipTableStartX + 2.5, currentY + 3.2);
              doc.line(zipTableStartX + 2.5, currentY + 3.2, zipTableStartX + 4.2, currentY + 1.5);
              
              // Tablo Ã§izgi ayarlarÄ±nÄ± geri yÃ¼kle
              doc.setDrawColor(0, 0, 0);
              doc.setLineWidth(0.3);
              
              // Tarihi soluk renkte yaz
              doc.setTextColor(150, 150, 150);
              doc.text(tarihStr, zipTableStartX + 7, currentY + 3.5);
            } else {
              // Normal tarih
              doc.setTextColor(0, 0, 0);
              doc.text(tarihStr, zipTableStartX + 2, currentY + 3.5);
            }
            zipTableStartX += colWidths[0];
            
            // GÃ¼n sÃ¼tunu
            doc.rect(zipTableStartX, currentY, colWidths[1], 5);
            doc.text(gun, zipTableStartX + 2, currentY + 3.5);
            zipTableStartX += colWidths[1];
            
            // Sabah sÃ¼tunu
            doc.rect(zipTableStartX, currentY, colWidths[2], 5);
            doc.text(sabahUygulama, zipTableStartX + 2, currentY + 3.5);
            zipTableStartX += colWidths[2];
            
            // AkÅŸam sÃ¼tunu
            doc.rect(zipTableStartX, currentY, colWidths[3], 5);
            doc.text(aksamUygulama, zipTableStartX + 2, currentY + 3.5);
            
            currentY += 5;
          }
          
          currentY += 8; // Haftalar arasÄ± boÅŸluk
        }
        
        // PDF'i blob olarak al ve ZIP'e ekle
        const pdfBlob = doc.output('blob');
        const dosyaAdi = `${asciiHastaAdi}_Egzersiz_Takvimi.pdf`;
        zip.file(klasorYolu + dosyaAdi, pdfBlob);
        
        console.log('âœ… 9. hafta Egzersiz PDF ZIP\'e eklendi:', dosyaAdi);
        
      } catch (error) {
        console.error('âŒ Egzersiz PDF oluÅŸturma hatasÄ±:', error);
      }
    }

    async function pdfYukleHafta(i, input) {
      const file = input.files[0];
      if (!file) return;
      console.log('ğŸ” PDF yÃ¼kleniyor:', file.name);
      console.log('ğŸ” SeÃ§ili hasta:', seciliHasta);
      
      if (!seciliHasta) {
        alert('LÃ¼tfen Ã¶nce bir hasta seÃ§in!');
        return;
      }
      
      const haftalar = getHaftaListesi();
      const hafta = haftalar[i];
      
      // Kilit kontrolÃ¼
      if (hafta.kilitli) {
        alert('ğŸ”’ Bu hafta kilitli! PDF yÃ¼klemek iÃ§in Ã¶nce kilidi aÃ§Ä±n.');
        input.value = ''; // Input'u temizle
        return;
      }
      
      // PDF dosya adÄ±ndan tarih ve hafta numarasÄ±nÄ± Ã§Ä±kar
      const parsedPdf = parseProfessionalPdfName(file.name);
      console.log('ğŸ“‹ PDF dosya adÄ± parse sonucu:', parsedPdf);
      
      let haftaNo = hafta.haftaNo || (i + 1);
      
      // PDF'den hafta numarasÄ± varsa gÃ¼ncelle
      if (parsedPdf && parsedPdf.haftaNo) {
        console.log(`ğŸ“… PDF'den hafta numarasÄ± alÄ±ndÄ±: ${haftaNo} â†’ ${parsedPdf.haftaNo}`);
        haftaNo = parsedPdf.haftaNo;
        haftalar[i].haftaNo = parsedPdf.haftaNo;
      }
      
      // PDF'den tarih aralÄ±ÄŸÄ± varsa gÃ¼ncelle
      if (parsedPdf && parsedPdf.baslangicGun && parsedPdf.baslangicAy) {
        const parsedTarihler = parseEdilmistarihleriDateOlarak(parsedPdf);
        if (parsedTarihler) {
          console.log(`ğŸ“… Ã–NCEDEN VAROLAN HAFTA TARÄ°HLERÄ°:`, {
            eskiBas: haftalar[i].baslangic,
            eskiBit: haftalar[i].bitis
          });
          console.log(`ğŸ“… PDF'den tarih aralÄ±ÄŸÄ± alÄ±ndÄ±:`, parsedTarihler);
          
          // Tarihleri zorla gÃ¼ncelle
          haftalar[i].baslangic = parsedTarihler.baslangic;
          haftalar[i].bitis = parsedTarihler.bitis;
          
          console.log(`ğŸ“… YENÄ° HAFTA TARÄ°HLERÄ°:`, {
            yeniBas: haftalar[i].baslangic,
            yeniBit: haftalar[i].bitis
          });
          
          // Tab bilgilerini gÃ¼ncelle (7 gÃ¼nden uzun aralÄ±k varsa Ã¶zel format)
          updateTabInfoFromPdf(i, parsedPdf, parsedTarihler);
          
          // Tab'larÄ± yeniden render et (Ã¶zel format gÃ¼ncellemesi iÃ§in)
          console.log('ğŸ”„ Tab adlarÄ± gÃ¼ncelleniyor...');
          gosterHaftalar();
          
          // Hafta detayÄ±nÄ± da gÃ¼ncelle (tarih alanlarÄ± iÃ§in) - ZORUNLU GÃœNCELLEME
          console.log('ğŸ”„ Hafta detayÄ± zorla gÃ¼ncelleniyor...');
          
          // Aktif tab'Ä± yeniden seÃ§ (hafta detayÄ± yenilenmesi iÃ§in)
          setTimeout(() => {
            const activeTabIndex = i;
            console.log(`ğŸ”„ Aktif tab yeniden seÃ§iliyor: ${activeTabIndex}`);
            switchTab(activeTabIndex);
          }, 100);
          
          // localStorage'a kaydet
          saveToStorage();
          
          // BaÅŸarÄ± mesajÄ± gÃ¶ster
          const basTarih = new Date(parsedTarihler.baslangic).toLocaleDateString('tr-TR');
          const bitTarih = new Date(parsedTarihler.bitis).toLocaleDateString('tr-TR');
          console.log(`âœ… Tab tarihleri gÃ¼ncellendi: ${basTarih} - ${bitTarih} (${parsedTarihler.gunSayisi} gÃ¼n)`);
        }
      }
      
      // GitHub'a PDF yÃ¼kle
      console.log('  PDF GitHub\'a yÃ¼kleniyor...');
      const pdfSonuc = await pdfYukleGithub(file, seciliHasta.id, haftaNo);
      
      if (!pdfSonuc) {
        console.error('âŒ PDF yÃ¼kleme baÅŸarÄ±sÄ±z');
        return;
      }
      
      // Hafta verilerini gÃ¼ncelle
      haftalar[i].pdfFile = file; // GeÃ§ici olarak File objesi (analiz iÃ§in)
      haftalar[i].pdfOrijinalIsim = pdfSonuc.orijinalAd;
      haftalar[i].pdfName = pdfSonuc.guvenliAd;
      haftalar[i].pdfYolu = pdfSonuc.dosyaYolu;
      haftalar[i].githubUrl = pdfSonuc.githubUrl;
      haftalar[i].indirmeUrl = pdfSonuc.indirmeUrl;
      haftalar[i].kayitTarihi = new Date().toISOString();
      
      // YENÄ° PDF YÃœKLENINCE ESKÄ° KARTLARI TEMÄ°ZLE
      console.log('ğŸ§¹ Yeni PDF yÃ¼kleniyor, eski kartlar temizleniyor...');
      console.log('ğŸ” Temizleme Ã¶ncesi hafta verileri:', {
        haftaIndex: i,
        eskiTarifKartlar: haftalar[i].tarifKartlar?.length || 0,
        eskiManuelKartlar: haftalar[i].manuelKartlar?.length || 0,
        eskiTarifler: haftalar[i].tarifler?.length || 0
      });
      
      // 1. LocalStorage'daki hafta verilerinden eski kartlarÄ± temizle
      haftalar[i].tarifKartlar = []; // Otomatik eÅŸleÅŸen kartlarÄ± sÄ±fÄ±rla
      haftalar[i].manuelKartlar = []; // Manuel eklenen kartlarÄ± sÄ±fÄ±rla
      haftalar[i].tarifler = []; // Eski tarifleri sÄ±fÄ±rla
      
      console.log('âœ… LocalStorage hafta verileri temizlendi');
      
      console.log('âœ… PDF verileri gÃ¼ncellendi:', {
        pdfOrijinalIsim: haftalar[i].pdfOrijinalIsim,
        pdfYolu: haftalar[i].pdfYolu,
        githubUrl: haftalar[i].githubUrl,
        indirmeUrl: haftalar[i].indirmeUrl
      });
      
      // SeÃ§ili hasta objesini de gÃ¼ncelle
      if (seciliHasta && seciliHasta.haftalar) {
        const seciliHaftaIndex = seciliHasta.haftalar.findIndex(h => (h.haftaNo || 0) === haftaNo);
        if (seciliHaftaIndex !== -1) {
          seciliHasta.haftalar[seciliHaftaIndex].pdfFile = file;
          seciliHasta.haftalar[seciliHaftaIndex].pdfOrijinalIsim = pdfSonuc.orijinalAd;
          seciliHasta.haftalar[seciliHaftaIndex].pdfName = pdfSonuc.guvenliAd;
          seciliHasta.haftalar[seciliHaftaIndex].pdfYolu = pdfSonuc.dosyaYolu;
          seciliHasta.haftalar[seciliHaftaIndex].githubUrl = pdfSonuc.githubUrl;
          seciliHasta.haftalar[seciliHaftaIndex].indirmeUrl = pdfSonuc.indirmeUrl;
          seciliHasta.haftalar[seciliHaftaIndex].kayitTarihi = haftalar[i].kayitTarihi;
          
          // YENÄ° PDF YÃœKLENINCE ESKÄ° KARTLARI HASTA JSON'UNDAN DA TEMÄ°ZLE
          console.log('ğŸ” Hasta JSON temizleme Ã¶ncesi:', {
            haftaIndex: seciliHaftaIndex,
            eskiTarifKartlar: seciliHasta.haftalar[seciliHaftaIndex].tarifKartlar?.length || 0,
            eskiManuelKartlar: seciliHasta.haftalar[seciliHaftaIndex].manuelKartlar?.length || 0,
            eskiTarifler: seciliHasta.haftalar[seciliHaftaIndex].tarifler?.length || 0
          });
          
          seciliHasta.haftalar[seciliHaftaIndex].tarifKartlar = []; // Otomatik eÅŸleÅŸen kartlarÄ± sÄ±fÄ±rla
          seciliHasta.haftalar[seciliHaftaIndex].manuelKartlar = []; // Manuel eklenen kartlarÄ± sÄ±fÄ±rla
          seciliHasta.haftalar[seciliHaftaIndex].tarifler = []; // Eski tarifleri sÄ±fÄ±rla
          
          console.log('ğŸ§¹ Hasta JSON\'undan da eski kartlar temizlendi');
        }
      }

      // PDF dosya adÄ±ndan hafta numarasÄ±nÄ± ve tarih aralÄ±ÄŸÄ±nÄ± otomatik tespit et
      const parsed = parseProfessionalPdfName(file.name);
      if (parsed) {
        console.log('ğŸ“‹ PDF parse sonucu:', parsed);
        
        const eskiHaftaNo = haftalar[i].haftaNo || (i + 1);
        haftalar[i].haftaNo = parsed.haftaNo;
        
        // Tarih aralÄ±ÄŸÄ±nÄ± da gÃ¼ncelle
        if (parsed.tarihAraligi) {
          const tarihBilgisi = parseTarihAraligi(parsed.tarihAraligi);
          haftalar[i].baslangic = tarihBilgisi.baslangic;
          haftalar[i].bitis = tarihBilgisi.bitis;
          console.log('ğŸ“… Hafta tarihleri gÃ¼ncellendi:', tarihBilgisi);
          
          // SeÃ§ili hasta objesinde de gÃ¼ncelle
          if (seciliHasta && seciliHasta.haftalar) {
            const seciliHaftaIndex = seciliHasta.haftalar.findIndex(h => (h.haftaNo || 0) === parsed.haftaNo);
            if (seciliHaftaIndex !== -1) {
              seciliHasta.haftalar[seciliHaftaIndex].baslangic = tarihBilgisi.baslangic;
              seciliHasta.haftalar[seciliHaftaIndex].bitis = tarihBilgisi.bitis;
            }
          }
        }
        
        setTimeout(() => {
          const haftaNoInput = document.getElementById('haftaNo_' + i);
          if (haftaNoInput) {
            haftaNoInput.value = parsed.haftaNo;
            haftaNoInput.style.backgroundColor = '#d4edda';
            haftaNoInput.style.borderColor = '#28a745';
            setTimeout(() => {
              haftaNoInput.style.backgroundColor = '';
              haftaNoInput.style.borderColor = '';
            }, 2000);
          }
          
          // Tarih inputlarÄ±nÄ± da gÃ¼ncelle
          if (parsed.tarihAraligi) {
            const tarihBilgisi = parseTarihAraligi(parsed.tarihAraligi);
            const baslangicInput = document.getElementById('baslangic_' + i);
            const bitisInput = document.getElementById('bitis_' + i);
            
            if (baslangicInput) {
              baslangicInput.value = tarihBilgisi.baslangic;
              baslangicInput.style.backgroundColor = '#d4edda';
              baslangicInput.style.borderColor = '#28a745';
              setTimeout(() => {
                baslangicInput.style.backgroundColor = '';
                baslangicInput.style.borderColor = '';
              }, 2000);
            }
            
            if (bitisInput) {
              bitisInput.value = tarihBilgisi.bitis;
              bitisInput.style.backgroundColor = '#d4edda';
              bitisInput.style.borderColor = '#28a745';
              setTimeout(() => {
                bitisInput.style.backgroundColor = '';
                bitisInput.style.borderColor = '';
              }, 2000);
            }
          }
        }, 100);
      } else {
        // Fallback: Sadece hafta numarasÄ±nÄ± Ã§Ä±karmaya Ã§alÄ±ÅŸ
        const dosyaAdindenHaftaNo = pdfDosyaAdindenHaftaNoAl(file.name);
        if (dosyaAdindenHaftaNo) {
          haftalar[i].haftaNo = dosyaAdindenHaftaNo;
          setTimeout(() => {
            const haftaNoInput = document.getElementById('haftaNo_' + i);
            if (haftaNoInput) {
              haftaNoInput.value = dosyaAdindenHaftaNo;
              haftaNoInput.style.backgroundColor = '#fff3cd';
              haftaNoInput.style.borderColor = '#ffc107';
              setTimeout(() => {
                haftaNoInput.style.backgroundColor = '';
                haftaNoInput.style.borderColor = '';
              }, 2000);
            }
          }, 100);
        }
      }

      // Hasta verisini GitHub'a kaydet (yeni sisteme gÃ¶re)
      if (seciliHasta) {
        await hastayiAyriKaydet(seciliHasta);
      }

      // Otomatik kaydetme - hasta verileri deÄŸiÅŸti
      autoSaveHastaData(seciliHasta);
      
      renderHastalar();
      gosterHaftalar();

      // EÄŸer bu hafta ÅŸu anda aktif hafta ise, ekrandan da eski kartlarÄ± temizle
      const aktifTab = document.querySelector('.hafta-tab.active');
      const aktifHaftaIndex = aktifTab ? parseInt(aktifTab.dataset.haftaIndex) : null;
      
      if (aktifTab && aktifHaftaIndex === i) {
        console.log('ğŸ§¹ Aktif haftada PDF yenileniyor, ekrandaki kartlar temizleniyor...');
        const currentDiv = document.getElementById('eslesenContent');
        if (currentDiv) {
          currentDiv.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">PDF analiz ediliyor...</div>';
        }
      }

      // PDF'i analiz et ve tarifleri Ã§Ä±kar
      const reader = new FileReader();
      reader.onload = async function(e) {
        const bytes = new Uint8Array(e.target.result);
        const pdf = await pdfjsLib.getDocument({ data: bytes }).promise;
        let fullText = '';
        for (let p = 1; p <= pdf.numPages; p++) {
          const page = await pdf.getPage(p);
          const content = await page.getTextContent();
          const strings = content.items.map(item => item.str);
          fullText += strings.join('\n') + '\n';
        }

        // PDF iÃ§eriÄŸinden hafta numarasÄ±nÄ± kontrol et
        const iceriktenHaftaNo = pdfIcerigindenhaftaNoAl(fullText);
        if (iceriktenHaftaNo && !pdfDosyaAdindenHaftaNoAl(haftalar[i].pdfName)) {
          const eskiHaftaNo = haftalar[i].haftaNo || (i + 1);
          haftalar[i].haftaNo = iceriktenHaftaNo;
          setTimeout(() => {
            const haftaNoInput = document.getElementById('haftaNo_' + i);
            if (haftaNoInput) {
              haftaNoInput.value = iceriktenHaftaNo;
              haftaNoInput.style.backgroundColor = '#d1ecf1';
              haftaNoInput.style.borderColor = '#17a2b8';
              setTimeout(() => {
                haftaNoInput.style.backgroundColor = '';
                haftaNoInput.style.borderColor = '';
              }, 2000);
            }
          }, 100);
        }

        haftalar[i].tarifler = extractTariflerDetay(fullText);
        
        // EÅŸleÅŸtirme yap ve sonuÃ§larÄ± kaydet
        const eslestirmeSonucu = await otomatikEsleHafta(i);
        
        // JSON'a sadece eÅŸleÅŸen kartlarÄ± kaydet (eÅŸleÅŸmeyenleri kaydetme)
        if (eslestirmeSonucu) {
          console.log('âœ… EÅŸleÅŸtirme sonuÃ§larÄ± hafta verilerine kaydediliyor...');
          haftalar[i].tarifKartlar = eslestirmeSonucu.eslesenKartlar || [];
          // EÅŸleÅŸmeyen tarifleri JSON'a kaydetmiyoruz - sadece UI'da gÃ¶stereceÄŸiz
          console.log('ğŸ“ JSON\'a kaydedilecek eÅŸleÅŸen kart sayÄ±sÄ±:', eslestirmeSonucu.eslesenKartlar?.length || 0);
          console.log('ğŸ“ EÅŸleÅŸmeyen tarifler JSON\'a kaydedilmiyor (sadece UI\'da gÃ¶rÃ¼nÃ¼r)');
        }
        
        // Hasta JSON dosyasÄ±nÄ± gÃ¼ncelle
        if (seciliHasta) {
          const seciliHaftaIndex = seciliHasta.haftalar.findIndex(h => (h.haftaNo || 0) === (haftalar[i].haftaNo || (i + 1)));
          if (seciliHaftaIndex !== -1) {
            seciliHasta.haftalar[seciliHaftaIndex].tarifler = haftalar[i].tarifler;
            seciliHasta.haftalar[seciliHaftaIndex].tarifKartlar = haftalar[i].tarifKartlar || [];
            // EÅŸleÅŸmeyen tarifleri JSON'a kaydetmiyoruz - JSON boyutunu kÃ¼Ã§Ã¼k tutmak iÃ§in
            // seciliHasta.haftalar[seciliHaftaIndex].eslesmeyenTarifler = haftalar[i].eslesmeyenTarifler || [];
            
            // Mevcut JSON'da eslesmeyenTarifler varsa sil (temizlik)
            if (seciliHasta.haftalar[seciliHaftaIndex].eslesmeyenTarifler) {
              delete seciliHasta.haftalar[seciliHaftaIndex].eslesmeyenTarifler;
              console.log('ğŸ§¹ Eski eslesmeyenTarifler verisi JSON\'dan temizlendi');
            }
          }
          
          // Hasta verilerini GitHub'a kaydet
          await hastayiAyriKaydet(seciliHasta);
          console.log('ğŸ’¾ PDF analizi sonrasÄ± hasta verileri JSON\'a kaydedildi (sadece eÅŸleÅŸenler)');
        }
        
        saveToStorage();
        
        // EÄŸer bu hafta ÅŸu anda aktif hafta ise, kartlarÄ± hemen gÃ¶ster
        const aktifTab = document.querySelector('.hafta-tab.active');
        const aktifHaftaIndex = aktifTab ? parseInt(aktifTab.dataset.haftaIndex) : null;
        
        console.log('ğŸ” PDF analizi sonrasÄ± kart gÃ¼ncelleme kontrolÃ¼:', {
          pdfYuklenenHaftaIndex: i,
          aktifHaftaIndex: aktifHaftaIndex,
          aktifTabVar: !!aktifTab,
          eslestirmeSonucu: eslestirmeSonucu ? 'var' : 'yok'
        });
        
        // Verileri kaydet
        saveToStorage();
        
        // YENÄ° SÄ°STEM: GitHub'a da kaydet
        if (seciliHasta) {
          hastayiAyriKaydet(seciliHasta).then(basarili => {
            if (basarili) {
              console.log('âœ… PDF gÃ¼ncellenen hafta verileri GitHub\'a kaydedildi');
            }
          }).catch(error => {
            console.error('âŒ GitHub kaydetme hatasÄ±:', error);
          });
        }
        
        // Tab baÅŸlÄ±ÄŸÄ±nÄ± ve tarihlerini gÃ¼ncelle
        gosterHaftalar();
        
        // Aktif tab'Ä± koru
        setTimeout(() => {
          switchTab(i);
          if (aktifTab && aktifHaftaIndex === i) {
            console.log('ğŸ¯ PDF yÃ¼klenen hafta aktif hafta, kartlarÄ± gÃ¼ncelleniyor...');
            setTimeout(() => {
              gosterEslesenKartlarSidebar(i);
            }, 500); // KÄ±sa bir gecikme ile gÃ¼ncelle
          } else {
            console.log('ğŸ” PDF yÃ¼klenen hafta aktif hafta deÄŸil, kart gÃ¼ncelleme yapÄ±lmÄ±yor');
          }
        }, 200);
      };
      reader.readAsArrayBuffer(file);
    }

    // PDF'den otomatik tara ve eÅŸleÅŸtir
    async function pdfOkuVeEsleHafta(i) {
      try {
        const hafta = getHaftaListesi()[i];
        if (!hafta.pdf) {
          console.log(`âš ï¸ ${i}. hafta iÃ§in PDF bulunamadÄ±`);
          return;
        }
        
        // Base64 verisini kontrol et ve temizle
        let base64Data = hafta.pdf;
        if (base64Data.includes(',')) {
          base64Data = base64Data.split(',')[1];
        }
        
        // Base64 verisini doÄŸrula
        if (!base64Data || base64Data.length === 0) {
          console.error(`âŒ ${i}. hafta iÃ§in geÃ§ersiz PDF verisi`);
          return;
        }
        
        // Base64 karakterlerini temizle (sadece geÃ§erli karakterler)
        base64Data = base64Data.replace(/[^A-Za-z0-9+/=]/g, '');
        
        console.log(`ğŸ” ${i}. hafta PDF analizi baÅŸlÄ±yor...`);
        
        const binary = atob(base64Data);
        const len = binary.length;
        const bytes = new Uint8Array(len);
        for (let j = 0; j < len; j++) bytes[j] = binary.charCodeAt(j);
        
        const pdf = await pdfjsLib.getDocument({ data: bytes }).promise;
        let fullText = '';
        for (let p = 1; p <= pdf.numPages; p++) {
          const page = await pdf.getPage(p);
          const content = await page.getTextContent();
          const strings = content.items.map(item => item.str);
          fullText += strings.join('\n') + '\n';
        }
        
        console.log(`âœ… ${i}. hafta PDF metni Ã§Ä±karÄ±ldÄ±: ${fullText.length} karakter`);
        
        // PDF iÃ§eriÄŸinden de hafta numarasÄ±nÄ± kontrol et (dosya adÄ±ndan tespit edilmediyse)
      const haftalar = getHaftaListesi();
      const iceriktenHaftaNo = pdfIcerigindenhaftaNoAl(fullText);
      if (iceriktenHaftaNo && !pdfDosyaAdindenHaftaNoAl(hafta.pdfName)) {
        const eskiHaftaNo = haftalar[i].haftaNo || (i + 1);
        haftalar[i].haftaNo = iceriktenHaftaNo;
        
        console.log(`ğŸ“„ PDF iÃ§eriÄŸinden hafta numarasÄ± gÃ¼ncellendi: ${eskiHaftaNo}. hafta â†’ ${iceriktenHaftaNo}. hafta`);
        
        // UI'da gÃ¶rsel feedback gÃ¶ster
        setTimeout(() => {
          const haftaNoInput = document.getElementById('haftaNo_' + i);
          if (haftaNoInput) {
            haftaNoInput.value = iceriktenHaftaNo;
            haftaNoInput.style.backgroundColor = '#d1ecf1';
            haftaNoInput.style.borderColor = '#17a2b8';
            setTimeout(() => {
              haftaNoInput.style.backgroundColor = '';
              haftaNoInput.style.borderColor = '';
            }, 2000);
          }
        }, 100);
      }
      
      hafta.tarifler = extractTariflerDetay(fullText);
      saveToStorage();
      // Otomatik eÅŸleÅŸtir
      otomatikEsleHafta(i);
      
      } catch (error) {
        console.error(`âŒ ${i}. hafta PDF analizi hatasÄ±:`, error);
        console.error('PDF veri uzunluÄŸu:', hafta.pdf ? hafta.pdf.length : 'N/A');
      }
    }

    // pdfOkuHafta fonksiyonu artÄ±k kullanÄ±lmÄ±yor (otomatikleÅŸtirildi)

    // Test fonksiyonu - PDF yapÄ±sÄ±nÄ± analiz etmek iÃ§in
    async function testPdfAnalyze(fileInput) {
      const file = fileInput.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = async function(e) {
        const bytes = new Uint8Array(e.target.result);
        const pdf = await pdfjsLib.getDocument({ data: bytes }).promise;
        let fullText = '';
        
        console.log('ğŸ“„ PDF Analiz Raporu:');
        console.log('- Sayfa sayÄ±sÄ±:', pdf.numPages);
        
        for (let p = 1; p <= pdf.numPages; p++) {
          const page = await pdf.getPage(p);
          const content = await page.getTextContent();
          const strings = content.items.map(item => item.str);
          const pageText = strings.join('\n');
          fullText += pageText + '\n';
          
          console.log(`- Sayfa ${p}:`, pageText.substring(0, 200) + '...');
        }
        
        console.log('ğŸ“ Tam Ä°Ã§erik:', fullText);
        
        // PDF format analizi
        const lines = fullText.split('\n').filter(line => line.trim());
        console.log('ğŸ“Š Ä°Ã§erik analizi:');
        console.log('- Toplam satÄ±r:', lines.length);
        console.log('- Ä°lk 10 satÄ±r:', lines.slice(0, 10));
        
        // Hasta adÄ±, tarih, hafta bilgisi arama
        const hastaPattern = /([A-ZÃ‡ÄÄ°Ã–ÅÃœ][a-zÃ§ÄŸÄ±Ã¶ÅŸÃ¼]+\s+[A-ZÃ‡ÄÄ°Ã–ÅÃœ][a-zÃ§ÄŸÄ±Ã¶ÅŸÃ¼]+)/g;
        const tarihPattern = /(\d{1,2}[\.\/\-]\d{1,2}[\.\/\-]\d{2,4})/g;
        const haftaPattern = /(\d+)\.\s*hafta/gi;
        
        console.log('ğŸ” Tespit edilen veriler:');
        console.log('- Hasta adlarÄ±:', fullText.match(hastaPattern));
        console.log('- Tarihler:', fullText.match(tarihPattern));
        console.log('- Hafta bilgileri:', fullText.match(haftaPattern));
      };
      reader.readAsArrayBuffer(file);
    }

    // PDF Generator - Hasta Takip Tablosu OluÅŸtur
    function generatePatientPDF() {
      console.log('ğŸ¯ PDF Generator baÅŸlatÄ±lÄ±yor...');
      
      if (!seciliHasta) {
        alert('LÃ¼tfen Ã¶nce bir hasta seÃ§in!');
        console.log('âŒ Hasta seÃ§ilmemiÅŸ');
        return;
      }
      
      console.log('âœ… SeÃ§ili hasta:', seciliHasta.isim);
      
      const haftalar = getHaftaListesi();
      if (haftalar.length === 0) {
        alert('Bu hasta iÃ§in hiÃ§ hafta kaydÄ± bulunamadÄ±!');
        console.log('âŒ Hafta kaydÄ± bulunamadÄ±');
        return;
      }
      
      console.log('âœ… Hafta sayÄ±sÄ±:', haftalar.length);
      
      // Sadece 5. haftada lenf drenaj programÄ± oluÅŸturulacak
      const mevcutHaftaNo = haftalar.length;
      if (mevcutHaftaNo === 5) {
        console.log('âœ… 5. hafta tespit edildi, Lenf Drenaj MasajÄ± programÄ± hazÄ±rlanÄ±yor');
      } else {
        console.log(`ğŸ“‹ ${mevcutHaftaNo}. hafta - Genel takip PDF\'i oluÅŸturuluyor`);
      }
      
      // Sabit 12 haftalÄ±k program 
      const haftaSayisi = 12;
      console.log('âœ… PDF iÃ§in hafta sayÄ±sÄ±:', haftaSayisi);
      
      // TÃ¼rkÃ§e karakter dÃ¼zeltme uygula
      const duzeltilenHastaAdi = turkceKarakterDuzelt(seciliHasta.isim);
      
      if (mevcutHaftaNo === 5) {
        generateLenfDrenajPDF(duzeltilenHastaAdi, haftalar, haftaSayisi);
      } else {
        generateGenelTakipPDF(duzeltilenHastaAdi, haftalar, haftaSayisi);
      }
    }
    
    function generateLenfDrenajPDF(hastaAdi, mevcutHaftalar, toplamHaftaSayisi) {
      console.log('ğŸ“„ Lenf Drenaj MasajÄ± PDF oluÅŸturuluyor...', { hastaAdi, toplamHaftaSayisi });
      
      // jsPDF kÃ¼tÃ¼phanesini kontrol et
      console.log('jsPDF kontrol:', typeof window.jspdf, typeof jsPDF);
      
      let jsPDFLib;
      if (typeof window.jspdf !== 'undefined') {
        jsPDFLib = window.jspdf.jsPDF;
        console.log('âœ… jsPDF window.jspdf.jsPDF Ã¼zerinden yÃ¼klendi');
      } else if (typeof jsPDF !== 'undefined') {
        jsPDFLib = jsPDF;
        console.log('âœ… jsPDF global jsPDF Ã¼zerinden yÃ¼klendi');
      } else {
        console.log('âŒ jsPDF bulunamadÄ±, dinamik yÃ¼kleme yapÄ±lÄ±yor...');
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
        script.onload = () => {
          console.log('âœ… jsPDF dinamik olarak yÃ¼klendi');
          setTimeout(() => generateLenfDrenajPDF(hastaAdi, mevcutHaftalar, toplamHaftaSayisi), 100);
        };
        script.onerror = () => {
          console.log('âŒ jsPDF yÃ¼klenemedi');
          alert('PDF kÃ¼tÃ¼phanesi yÃ¼klenemedi. LÃ¼tfen internet baÄŸlantÄ±nÄ±zÄ± kontrol edin.');
        };
        document.head.appendChild(script);
        return;
      }
      
      try {
        console.log('ğŸ“ Lenf Drenaj MasajÄ± PDF dÃ¶kÃ¼manÄ± oluÅŸturuluyor...');
        const doc = new jsPDFLib('p', 'mm', 'a4'); // Portrait format
        
        // TÃ¼rkÃ§e karakter desteÄŸi
        doc.setFont('helvetica');
        
        // BaÅŸlÄ±k
        doc.setFontSize(16);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(0, 0, 0);
        
        // Hasta adÄ±nÄ± TÃ¼rkÃ§e karakter dÃ¼zeltme ile hazÄ±rla
        const temizHastaAdi = turkceKarakterDuzelt(hastaAdi);
        const title = `${temizHastaAdi.toUpperCase()}`;
        const titleWidth = doc.getTextWidth(title);
        doc.text(title, (210 - titleWidth) / 2, 20);
        
        // Alt baÅŸlÄ±k
        doc.setFontSize(12);
        doc.setTextColor(0, 0, 0);
        const subtitle = 'EGZERSIZ VE LENF DRENAJ MASAJI PROGRAMI';
        const subtitleWidth = doc.getTextWidth(subtitle);
        doc.text(subtitle, (210 - subtitleWidth) / 2, 28);
        
        // Program aÃ§Ä±klamasÄ±
        doc.setFontSize(9);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(0, 0, 0);
        doc.rect(15, 32, 170, 10);
        doc.text(window.fixTurkishChars('8 Haftalik Egzersiz ve Lenf Drenaj Masaji Uygulama Programi (5. Haftadan itibaren)'), 20, 38);
        
        // SeÃ§ili haftayÄ± al - geÃ§miÅŸ haftalarda soluk renk iÃ§in
        const seciliHaftaIndex = parseInt(document.getElementById('haftaSelect').value);
        const seciliHaftaNo = seciliHaftaIndex + 1;
        
        // 5. haftanÄ±n pazartesi tarihini hesapla
        const besinciHafta = mevcutHaftalar[4];
        if (!besinciHafta || !besinciHafta.baslangic) {
          throw new Error('5. hafta bilgisi bulunamadi!');
        }
        
        const besinciHaftaBaslangic = new Date(besinciHafta.baslangic);
        
        // 5. hafta baÅŸlangÄ±Ã§ tarihinin pazartesi olmasÄ±nÄ± garanti altÄ±na al
        const haftaGunu = besinciHaftaBaslangic.getDay(); // 0=Pazar, 1=Pazartesi, ... 6=Cumartesi
        if (haftaGunu !== 1) { // EÄŸer pazartesi deÄŸilse
          const gunFarki = haftaGunu === 0 ? 1 : (1 - haftaGunu); // Pazartesiye kadar olan gÃ¼n farkÄ±
          besinciHaftaBaslangic.setDate(besinciHaftaBaslangic.getDate() + gunFarki);
        }
        
        console.log('âœ… 5. hafta baÅŸlangÄ±cÄ± (Pazartesi):', besinciHaftaBaslangic);
        
        let currentY = 50;
        const gunler = ['Pazartesi', 'Sali', 'Carsamba', 'Persembe', 'Cuma', 'Cumartesi', 'Pazar'];
        
        // Her hafta iÃ§in basit tablo
        for (let lenfHaftaIndex = 0; lenfHaftaIndex < 8; lenfHaftaIndex++) {
          const gercekHaftaNo = lenfHaftaIndex + 5;
          const haftaBaslangic = new Date(besinciHaftaBaslangic.getTime() + (lenfHaftaIndex * 7 * 24 * 60 * 60 * 1000));
          
          // Hafta baÅŸlÄ±ÄŸÄ±
          // SeÃ§ili haftadan Ã¶nceki haftalar soluk renkte olsun
          if (gercekHaftaNo < seciliHaftaNo) {
            doc.setTextColor(150, 150, 150); // Soluk gri renk
          } else {
            doc.setTextColor(0, 0, 0); // Normal siyah renk
          }
          doc.setFont('helvetica', 'bold');
          doc.setFontSize(10);
          doc.rect(15, currentY, 170, 6);
          
          const haftaBaslangicStr = haftaBaslangic.toLocaleDateString('tr-TR');
          const haftaBitisStr = new Date(haftaBaslangic.getTime() + (6 * 24 * 60 * 60 * 1000)).toLocaleDateString('tr-TR');
          doc.text(window.fixTurkishChars(`${gercekHaftaNo}. HAFTA (${haftaBaslangicStr} - ${haftaBitisStr})`), 20, currentY + 4);
          currentY += 8;
          
          // Tablo baÅŸlÄ±klarÄ± - 4 sÃ¼tun
          doc.setTextColor(0, 0, 0);
          doc.setFont('helvetica', 'bold');
          doc.setFontSize(9);
          
          const colWidths = [30, 40, 50, 50]; // Tarih, GÃ¼n, Sabah, AkÅŸam
          let tableStartX = 15;
          
          // BaÅŸlÄ±k satÄ±rÄ±
          doc.rect(tableStartX, currentY, colWidths[0], 6);
          doc.text('TARIH', tableStartX + 2, currentY + 4);
          tableStartX += colWidths[0];
          
          doc.rect(tableStartX, currentY, colWidths[1], 6);
          doc.text('GUN', tableStartX + 2, currentY + 4);
          tableStartX += colWidths[1];
          
          doc.rect(tableStartX, currentY, colWidths[2], 6);
          doc.text('SABAH', tableStartX + 2, currentY + 4);
          tableStartX += colWidths[2];
          
          doc.rect(tableStartX, currentY, colWidths[3], 6);
          doc.text('AKSAM', tableStartX + 2, currentY + 4);
          currentY += 6;
          
          // Her gÃ¼n iÃ§in satÄ±r
          doc.setFont('helvetica', 'normal');
          doc.setFontSize(8);
          
          for (let gunIndex = 0; gunIndex < 7; gunIndex++) {
            const gunTarihi = new Date(haftaBaslangic.getTime() + (gunIndex * 24 * 60 * 60 * 1000));
            const tarihStr = gunTarihi.toLocaleDateString('tr-TR');
            const gun = gunler[gunIndex];
            
            // Uygulama kontrolÃ¼
            let sabahUygulama = '-';
            let aksamUygulama = '-';
            
            if (lenfHaftaIndex < 2) {
              // Ä°lk 2 hafta (5-6): GÃ¼nde 2 kez lenf masajÄ±
              sabahUygulama = 'Lenf Masaji';
              aksamUygulama = 'Lenf Masaji';
            } else if (lenfHaftaIndex < 4) {
              // Sonraki 2 hafta (7-8): GÃ¼nde 1 kez lenf masajÄ± (sabah)
              sabahUygulama = 'Lenf Masaji';
              aksamUygulama = '-';
            } else if (lenfHaftaIndex < 6) {
              // Sonraki 2 hafta (9-10): GÃ¼naÅŸÄ±rÄ± lenf masajÄ± + sÃ¼rekli akÅŸam egzersiz
              if (gunIndex === 0 || gunIndex === 2 || gunIndex === 4 || gunIndex === 6) {
                // Pazartesi, Ã‡arÅŸamba, Cuma, Pazar: Lenf masajÄ± + akÅŸam egzersiz
                sabahUygulama = 'Lenf Masaji';
                aksamUygulama = 'Egzersiz-2';
              } else {
                // SalÄ±, PerÅŸembe, Cumartesi: Sabah ve akÅŸam egzersiz
                sabahUygulama = 'Egzersiz-1';
                aksamUygulama = 'Egzersiz-2';
              }
            } else {
              // Son 2 hafta (11-12): SalÄ±, Cuma lenf masajÄ± + sÃ¼rekli akÅŸam egzersiz
              if (gunIndex === 1 || gunIndex === 4) {
                // SalÄ±, Cuma: Lenf masajÄ± + akÅŸam egzersiz
                sabahUygulama = 'Lenf Masaji';
                aksamUygulama = 'Egzersiz-2';
              } else {
                // DiÄŸer gÃ¼nler: Sabah ve akÅŸam egzersiz
                sabahUygulama = 'Egzersiz-1';
                aksamUygulama = 'Egzersiz-2';
              }
            }
            
            tableStartX = 15;
            
            // SeÃ§ili haftadan Ã¶nceki haftalar soluk renkte olsun
            if (gercekHaftaNo < seciliHaftaNo) {
              doc.setTextColor(150, 150, 150); // Soluk gri renk
            } else {
              doc.setTextColor(0, 0, 0); // Normal siyah renk
            }
            
            // Tarih sÃ¼tunu
            doc.rect(tableStartX, currentY, colWidths[0], 5);
            doc.text(tarihStr, tableStartX + 2, currentY + 3.5);
            tableStartX += colWidths[0];
            
            // GÃ¼n sÃ¼tunu
            doc.rect(tableStartX, currentY, colWidths[1], 5);
            doc.text(gun, tableStartX + 2, currentY + 3.5);
            tableStartX += colWidths[1];
            
            // Sabah sÃ¼tunu
            doc.rect(tableStartX, currentY, colWidths[2], 5);
            doc.text(sabahUygulama, tableStartX + 2, currentY + 3.5);
            tableStartX += colWidths[2];
            
            // AkÅŸam sÃ¼tunu
            doc.rect(tableStartX, currentY, colWidths[3], 5);
            doc.text(aksamUygulama, tableStartX + 2, currentY + 3.5);
            
            currentY += 5;
          }
          
          currentY += 5; // Haftalar arasÄ± boÅŸluk
          
          // Sayfa sonu kontrolÃ¼
          if (currentY > 240 && lenfHaftaIndex < 7) {
            doc.addPage('p');
            currentY = 20;
          }
        }
        
        
        console.log('âœ… Basit lenf drenaj tablosu tamamlandÄ±, PDF indiriliyor...');
        
        // PDF'yi indir
        const tarih = new Date().toISOString().slice(0, 10);
        const dosyaAdi = `${hastaAdi}_Lenf_Drenaj_Programi_${tarih}.pdf`;
        doc.save(dosyaAdi);
        
        console.log('âœ… Lenf Drenaj PDF baÅŸarÄ±yla oluÅŸturuldu:', dosyaAdi);
        alert(`Lenf Drenaj MasajÄ± ProgramÄ± PDF'i baÅŸarÄ±yla oluÅŸturuldu!\n\nDosya: ${dosyaAdi}\n\n8 haftalÄ±k program 5. haftanÄ±zÄ±n pazartesi gÃ¼nÃ¼ (${besinciHaftaBaslangic.toLocaleDateString('tr-TR')}) baÅŸlayacak ÅŸekilde hazÄ±rlandÄ±.`);
        
      } catch (error) {
        console.error('âŒ Lenf Drenaj PDF oluÅŸturma hatasÄ±:', error);
        alert('Lenf Drenaj PDF oluÅŸtururken hata oluÅŸtu: ' + error.message);
      }
    }

    function generateGenelTakipPDF(hastaAdi, mevcutHaftalar, toplamHaftaSayisi) {
      console.log('ğŸ“„ Genel Takip PDF oluÅŸturuluyor...', { hastaAdi, toplamHaftaSayisi });
      alert('HenÃ¼z 5. hafta kaydÄ±nÄ±z yok. Genel takip PDF\'i oluÅŸturuluyor.\n5. hafta sonrasÄ± Lenf Drenaj MasajÄ± programÄ± otomatik eklenecektir.');
      
      // Basit takip PDF oluÅŸtur (eski sistem)
      try {
        const doc = new jsPDF('l', 'mm', 'a4');
        doc.setFont('helvetica');
        doc.setFontSize(16);
        doc.setFont('helvetica', 'bold');
        const temizHastaAdi = turkceKarakterDuzelt(hastaAdi);
        
        // jsPDF iÃ§in TÃ¼rkÃ§e karakterleri ASCII'ye Ã§evir
        const pdfUygunHastaAdi = temizHastaAdi
          .replace(/Å/g, 'S').replace(/ÅŸ/g, 's')
          .replace(/Ä/g, 'G').replace(/ÄŸ/g, 'g')
          .replace(/Ä°/g, 'I').replace(/Ä±/g, 'i')
          .replace(/Ã‡/g, 'C').replace(/Ã§/g, 'c')
          .replace(/Ã–/g, 'O').replace(/Ã¶/g, 'o')
          .replace(/Ãœ/g, 'U').replace(/Ã¼/g, 'u');
        
        doc.text(`${pdfUygunHastaAdi.toUpperCase()} - GENEL TAKIP`, 20, 20);
        
        doc.setFontSize(10);
        doc.setFont('helvetica', 'normal');
        doc.text('Hasta takip tablosu (Lenf drenaj programÄ± 5. hafta sonrasÄ± eklenecektir)', 20, 30);
        
        // Basit tablo
        const startY = 45;
        let currentY = startY;
        
        doc.setFontSize(9);
        doc.text('Hafta', 20, currentY);
        doc.text('Durum', 60, currentY);
        doc.text('Notlar', 120, currentY);
        currentY += 10;
        
        for (let i = 0; i < Math.min(mevcutHaftalar.length, toplamHaftaSayisi); i++) {
          const hafta = mevcutHaftalar[i];
          doc.text(`${i + 1}. Hafta`, 20, currentY);
          doc.text(hafta ? 'TamamlandÄ±' : 'Beklemede', 60, currentY);
          doc.text(hafta && hafta.aciklama ? hafta.aciklama.substring(0, 30) : '', 120, currentY);
          currentY += 8;
        }
        
        const tarih = new Date().toISOString().slice(0, 10);
        const dosyaAdi = `${hastaAdi}_Genel_Takip_${tarih}.pdf`;
        doc.save(dosyaAdi);
        
        console.log('âœ… Genel Takip PDF baÅŸarÄ±yla oluÅŸturuldu:', dosyaAdi);
        
      } catch (error) {
        console.error('âŒ Genel Takip PDF hatasÄ±:', error);
        alert('PDF oluÅŸtururken hata oluÅŸtu: ' + error.message);
      }
    }

    // ZIP iÃ§in Lenf Drenaj PDF Blob oluÅŸturucu (indirmeden, sadece memory'de)
    async function generateLenfDrenajPDFBlob(belirliHaftaNo = null, belirliHaftaIndex = null) {
      try {
        console.log('ğŸ“„ Lenf Drenaj PDF Blob oluÅŸturuluyor...');
        
        if (!seciliHasta) {
          console.warn('âŒ SeÃ§ili hasta yok');
          return null;
        }
        
        const haftalar = getHaftaListesi();
        console.log('ğŸ” Hafta listesi uzunluÄŸu:', haftalar.length);
        
        // Hasta ve hafta bilgilerini detaylÄ± kontrol et
        if (!haftalar || haftalar.length === 0) {
          console.warn('âŒ HiÃ§ hafta verisi yok');
          return null;
        }
        
        console.log('ğŸ” Hasta bilgileri:', {
          id: seciliHasta.id,
          isim: seciliHasta.isim,
          haftaSayisi: haftalar.length,
          belirliHaftaNo: belirliHaftaNo,
          belirliHaftaIndex: belirliHaftaIndex
        });
        
        // Hafta sayÄ±sÄ± kontrolÃ¼nÃ¼ kaldÄ±r - tek hafta bile olsa masaj takvimi oluÅŸturulabilir
        // if (haftalar.length < 5) return null; // KALDIRILDI
        
        // SeÃ§ili haftayÄ± al - eÄŸer belirli hafta belirtilmiÅŸse onu kullan
        let egzersizDahilMi;
        let dokuzuncuHaftaOzelModu = false; // 9. hafta iÃ§in Ã¶zel mod
        
        if (belirliHaftaNo !== null) {
          // ZIP iÃ§in belirli bir hafta belirtilmiÅŸ
          egzersizDahilMi = belirliHaftaNo >= 9; // 9. hafta ve sonrasÄ± iÃ§in egzersiz dahil
          dokuzuncuHaftaOzelModu = belirliHaftaNo === 9; // 9. hafta Ã¶zel modu
          console.log(`ğŸ¯ ZIP iÃ§in ${belirliHaftaNo}. hafta PDF'i oluÅŸturuluyor, egzersiz dahil: ${egzersizDahilMi}, 9. hafta Ã¶zel mod: ${dokuzuncuHaftaOzelModu}`);
        } else {
          // Normal PDF indirme iÃ§in seÃ§ili haftayÄ± kullan
          const seciliHaftaIndex = parseInt(document.getElementById('haftaSelect').value);
          egzersizDahilMi = seciliHaftaIndex >= 8; // 9. hafta ve sonrasÄ± iÃ§in egzersiz dahil
        }
        
        console.log('ğŸ” jsPDF kontrolÃ¼ baÅŸlÄ±yor...');
        // jsPDF kontrolÃ¼
        let jsPDFLib;
        if (typeof window.jspdf !== 'undefined') {
          jsPDFLib = window.jspdf.jsPDF;
          console.log('âœ… window.jspdf bulundu');
        } else if (typeof jsPDF !== 'undefined') {
          jsPDFLib = jsPDF;
          console.log('âœ… global jsPDF bulundu');
        } else {
          console.warn('âŒ jsPDF bulunamadÄ±');
          return null;
        }
        
        console.log('ğŸ” Hasta adÄ± alÄ±nÄ±yor...');
        const hastaAdi = turkceKarakterDuzelt(seciliHasta.isim);
        console.log('ğŸ” Hasta adÄ±:', hastaAdi);
        
        console.log('ğŸ” PDF dokÃ¼manÄ± oluÅŸturuluyor...');
        const doc = new jsPDFLib('p', 'mm', 'a4'); // Portrait - mobil uyumlu
        
        console.log('ğŸ” PDF ayarlarÄ± yapÄ±lÄ±yor...');
        // PDF iÃ§eriÄŸini oluÅŸtur (yeni mobil dostu stil ile)
        
        // ğŸ”§ TÃ¼rkÃ§e karakter sorunu iÃ§in Ã¶zel encoding
        console.log('ğŸ”§ TÃ¼rkÃ§e karakter encoding ayarlarÄ±...');
        
        // Ham hasta adÄ±nÄ± al (tÃ¼rkce dÃ¼zeltme yapmadan)
        const rawHastaAdi = seciliHasta.isim;
        console.log('ğŸ” Ham hasta adÄ±:', rawHastaAdi);
        console.log('ğŸ” seciliHasta objesi:', seciliHasta);
        
        // TÃ¼rkÃ§e karakterleri ASCII'ye Ã§evir - KEKesin Ã§Ã¶zÃ¼m
        const asciiHastaAdi = rawHastaAdi
            .replace(/Å/g, 'S').replace(/ÅŸ/g, 's')
            .replace(/Ä/g, 'G').replace(/ÄŸ/g, 'g')
            .replace(/Ãœ/g, 'U').replace(/Ã¼/g, 'u')
            .replace(/Ä°/g, 'I').replace(/Ä±/g, 'i')
            .replace(/Ã–/g, 'O').replace(/Ã¶/g, 'o')
            .replace(/Ã‡/g, 'C').replace(/Ã§/g, 'c')
            .replace(/Æ/g, 'E').replace(/É™/g, 'e'); // Azerbaijan karakteri de varsa
            
        console.log('ğŸ” ASCII hasta adÄ±:', asciiHastaAdi);
        
        doc.setFont('helvetica');
        doc.setLanguage('tr');
        
        // BaÅŸlÄ±k - Merkezi
        doc.setFontSize(16);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(0, 0, 0);
        const title = `${asciiHastaAdi.toUpperCase()}`;
        const titleWidth = doc.getTextWidth(title);
        doc.text(title, (210 - titleWidth) / 2, 20);
        console.log('âœ… PDF baÅŸlÄ±ÄŸÄ±nda ASCII kullanÄ±ldÄ±:', title);
        
        doc.setFontSize(12);
        doc.setTextColor(0, 0, 0);
        
        // Hangi hafta iÃ§in PDF oluÅŸturulduÄŸuna gÃ¶re farklÄ± baÅŸlÄ±k
        let subtitle, programBasligi;
        if (egzersizDahilMi) {
          subtitle = 'EGZERSIZ VE LENF DRENAJ MASAJI PROGRAMI';
          programBasligi = '8 Haftalik Egzersiz ve Lenf Drenaj Masaji Uygulama Programi';
        } else {
          subtitle = 'LENF DRENAJ MASAJI PROGRAMI';
          programBasligi = '8 Haftalik Lenf Drenaj Masaji Uygulama Programi';
        }
        
        const subtitleWidth = doc.getTextWidth(subtitle);
        doc.text(subtitle, (210 - subtitleWidth) / 2, 28);
        
        // AÃ§Ä±klama kutusu
        doc.setFontSize(8);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(0, 0, 0);
        doc.rect(15, 32, 170, 10);
        doc.text(programBasligi, 20, 36);
        if (egzersizDahilMi) {
          doc.text('(5. Haftadan itibaren) - Yesil check isareti tamamlanan gunler', 20, 40);
        } else {
          doc.text('(5. Haftadan itibaren)', 20, 40);
        }
        
        console.log('ğŸ” Hafta verilerini belirleniyor...');
        // BaÅŸlangÄ±Ã§ haftasÄ±nÄ± belirle
        let baslangicHaftaIndex;
        let baslangicHafta;
        
        if (belirliHaftaIndex !== null) {
          // âš¡ Ã–NCELIK: EÄŸer hafta index'i belirtilmiÅŸse onu kullan (ZIP iÃ§in)
          baslangicHaftaIndex = belirliHaftaIndex;
          console.log('ğŸ¯ Belirtilen hafta index\'i kullanÄ±lÄ±yor:', baslangicHaftaIndex);
        } else if (dokuzuncuHaftaOzelModu) {
          // 9. hafta Ã¶zel modu: 9. haftayÄ± referans al
          const dokuzuncuHaftaIndex = haftalar.findIndex(h => h.haftaNo === 9);
          if (dokuzuncuHaftaIndex !== -1) {
            baslangicHaftaIndex = dokuzuncuHaftaIndex; // 9. haftanÄ±n gerÃ§ek index'i
            console.log('ğŸ¯ 9. hafta Ã¶zel modu: 9. hafta tabÄ±ndaki tarihten baÅŸlayacak, index:', dokuzuncuHaftaIndex);
          } else {
            baslangicHaftaIndex = 4; // fallback: 5. hafta
            console.log('âš ï¸ 9. hafta bulunamadÄ±, 5. hafta fallback kullanÄ±lÄ±yor');
          }
        } else {
          // Normal mod
          baslangicHaftaIndex = belirliHaftaNo ? belirliHaftaNo - 1 : 4; // 5. hafta = index 4
        }
        
        if (baslangicHaftaIndex < haftalar.length) {
          // Belirtilen hafta mevcut
          baslangicHafta = haftalar[baslangicHaftaIndex];
          console.log('âœ… Belirtilen hafta bulundu:', baslangicHafta);
        } else {
          // Belirtilen hafta yok, mevcut ilk haftayÄ± kullan
          baslangicHafta = haftalar[0];
          console.log('âš ï¸ Belirtilen hafta yok, ilk hafta kullanÄ±lÄ±yor:', baslangicHafta);
        }
        
        console.log('ğŸ” BaÅŸlangÄ±Ã§ tarihi hesaplanÄ±yor...');
        const baslangicTarihi = new Date(baslangicHafta.baslangic);
        
        // Tab baÅŸlangÄ±Ã§ tarihini olduÄŸu gibi kullan - zaten doÄŸru tarihlendirilmiÅŸ
        console.log('âœ… BaÅŸlangÄ±Ã§ tarihi (tab tarihinden):', baslangicTarihi);
        
        let currentY = 50;
        const gunler = ['Pazartesi', 'Sali', 'Carsamba', 'Persembe', 'Cuma', 'Cumartesi', 'Pazar'];
        
        // Kompakt tablo (Blob iÃ§in)
        const haftaSayisi = dokuzuncuHaftaOzelModu ? 8 : 8; // 9. hafta Ã¶zel modunda 8 hafta (5-12), normal modda 8 hafta
        for (let lenfHaftaIndex = 0; lenfHaftaIndex < haftaSayisi; lenfHaftaIndex++) {
          // 9. hafta Ã¶zel modunda 5. haftadan baÅŸla (5,6,7,8,9,10,11,12), normal modda belirtilen haftadan
          const gercekHaftaNo = dokuzuncuHaftaOzelModu ? (lenfHaftaIndex + 5) : (lenfHaftaIndex + (belirliHaftaNo || 5));
          
          // Tarih hesaplamasÄ± dÃ¼zeltildi
          let haftaBaslangic;
          if (dokuzuncuHaftaOzelModu) {
            // 9. hafta Ã¶zel modu: 5. haftadan baÅŸlayarak 8 hafta gÃ¶ster
            // baslangicTarihi = 9. hafta baÅŸlangÄ±Ã§ tarihi
            // 5. hafta = 9. haftadan 4 hafta Ã¶nce
            // 6. hafta = 9. haftadan 3 hafta Ã¶nce
            // ...
            // 9. hafta = 9. haftadan 0 hafta Ã¶nce
            // 10. hafta = 9. haftadan 1 hafta sonra
            const haftaFarki = (lenfHaftaIndex + 5) - 9; // 5. hafta=-4, 6. hafta=-3, ..., 9. hafta=0, 10. hafta=+1
            haftaBaslangic = new Date(baslangicTarihi.getTime() + (haftaFarki * 7 * 24 * 60 * 60 * 1000));
          } else {
            // Normal mod: baÅŸlangÄ±Ã§ tarihinden itibaren hafta hafta ilerle
            haftaBaslangic = new Date(baslangicTarihi.getTime() + (lenfHaftaIndex * 7 * 24 * 60 * 60 * 1000));
          }
          
          // Hafta baÅŸlÄ±ÄŸÄ±
          doc.setTextColor(0, 0, 0);
          doc.setFont('helvetica', 'bold');
          doc.setFontSize(9);
          doc.rect(15, currentY, 170, 6);
          
          const haftaBaslangicStr = haftaBaslangic.toLocaleDateString('tr-TR');
          const haftaBitisStr = new Date(haftaBaslangic.getTime() + (6 * 24 * 60 * 60 * 1000)).toLocaleDateString('tr-TR');
          
          // 9. hafta PDF'si iÃ§in 5-8. haftalar soluk renkte olsun, 9-12. haftalar normal
          const eskiHaftaMi = dokuzuncuHaftaOzelModu && gercekHaftaNo >= 5 && gercekHaftaNo <= 8; // Sadece 5-8. haftalar
          if (eskiHaftaMi) {
            doc.setTextColor(150, 150, 150); // Soluk gri renk
          } else {
            doc.setTextColor(0, 0, 0); // Normal siyah renk
          }
          
          doc.text(`${gercekHaftaNo}. HAFTA (${haftaBaslangicStr} - ${haftaBitisStr})`, 20, currentY + 4);
          
          // 9. hafta Ã¶zel modunda 5-8. haftalar iÃ§in tamamlandÄ± iÅŸareti
          if (eskiHaftaMi) {
            doc.setTextColor(0, 128, 0); // YeÅŸil renk
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(10);
            doc.text('âœ“ TAMAMLANDI', 120, currentY + 4);
            doc.setFont('helvetica', 'normal');
          }
          currentY += 8;
          
          // Tablo baÅŸlÄ±klarÄ± - 4 sÃ¼tun
          doc.setTextColor(0, 0, 0);
          doc.setFont('helvetica', 'bold');
          doc.setFontSize(9);
          doc.setDrawColor(0, 0, 0);
          doc.setLineWidth(0.3);
          
          const colWidths = [30, 40, 50, 50]; // Tarih, GÃ¼n, Sabah, AkÅŸam
          let zipTableStartX = 15;
          
          // BaÅŸlÄ±k satÄ±rÄ±
          doc.rect(zipTableStartX, currentY, colWidths[0], 6);
          doc.text('TARIH', zipTableStartX + 2, currentY + 4);
          zipTableStartX += colWidths[0];
          
          doc.rect(zipTableStartX, currentY, colWidths[1], 6);
          doc.text('GUN', zipTableStartX + 2, currentY + 4);
          zipTableStartX += colWidths[1];
          
          doc.rect(zipTableStartX, currentY, colWidths[2], 6);
          doc.text('SABAH', zipTableStartX + 2, currentY + 4);
          zipTableStartX += colWidths[2];
          
          doc.rect(zipTableStartX, currentY, colWidths[3], 6);
          doc.text('AKSAM', zipTableStartX + 2, currentY + 4);
          currentY += 6;
          
          // Her gÃ¼n iÃ§in satÄ±r
          doc.setFont('helvetica', 'normal');
          doc.setFontSize(8);
          
          for (let gunIndex = 0; gunIndex < 7; gunIndex++) {
            const gunTarihi = new Date(haftaBaslangic.getTime() + (gunIndex * 24 * 60 * 60 * 1000));
            const tarihStr = gunTarihi.toLocaleDateString('tr-TR');
            const gun = gunler[gunIndex];
            
            // Uygulama kontrolÃ¼ - seÃ§ili haftaya gÃ¶re egzersiz dahil edilir
            let sabahUygulama = '-';
            let aksamUygulama = '-';
            
            if (lenfHaftaIndex < 2) {
              // Ä°lk 2 hafta (5-6): GÃ¼nde 2 kez lenf masajÄ±
              sabahUygulama = 'Lenf Masaji';
              aksamUygulama = 'Lenf Masaji';
            } else if (lenfHaftaIndex < 4) {
              // Sonraki 2 hafta (7-8): GÃ¼nde 1 kez lenf masajÄ± (sabah)
              sabahUygulama = 'Lenf Masaji';
              aksamUygulama = '-';
            } else if (lenfHaftaIndex < 6) {
              // Sonraki 2 hafta (9-10): GÃ¼naÅŸÄ±rÄ± lenf masajÄ±
              if (egzersizDahilMi) {
                // Egzersiz dahil versiyonu (9. hafta seÃ§iliyse)
                if (gunIndex === 0 || gunIndex === 2 || gunIndex === 4 || gunIndex === 6) {
                  // Pazartesi, Ã‡arÅŸamba, Cuma, Pazar: Lenf masajÄ± + akÅŸam egzersiz
                  sabahUygulama = 'Lenf Masaji';
                  aksamUygulama = 'Egzersiz-2';
                } else {
                  // SalÄ±, PerÅŸembe, Cumartesi: Sabah ve akÅŸam egzersiz
                  sabahUygulama = 'Egzersiz-1';
                  aksamUygulama = 'Egzersiz-2';
                }
              } else {
                // Sadece lenf masajÄ± versiyonu (5-8. hafta seÃ§iliyse)
                if (gunIndex === 0 || gunIndex === 2 || gunIndex === 4 || gunIndex === 6) {
                  sabahUygulama = 'Lenf Masaji';
                } else {
                  sabahUygulama = '-';
                }
                aksamUygulama = '-';
              }
            } else {
              // Son 2 hafta (11-12): SalÄ±, Cuma lenf masajÄ±
              if (egzersizDahilMi) {
                // Egzersiz dahil versiyonu (9+ hafta seÃ§iliyse)
                if (gunIndex === 1 || gunIndex === 4) {
                  // SalÄ±, Cuma: Lenf masajÄ± + akÅŸam egzersiz
                  sabahUygulama = 'Lenf Masaji';
                  aksamUygulama = 'Egzersiz-2';
                } else {
                  // DiÄŸer gÃ¼nler: Sabah ve akÅŸam egzersiz
                  sabahUygulama = 'Egzersiz-1';
                  aksamUygulama = 'Egzersiz-2';
                }
              } else {
                // Sadece lenf masajÄ± versiyonu (5-8. hafta seÃ§iliyse)
                if (gunIndex === 1 || gunIndex === 4) {
                  sabahUygulama = 'Lenf Masaji';
                } else {
                  sabahUygulama = '-';
                }
                aksamUygulama = '-';
              }
            }
            
            zipTableStartX = 15;
            
            // 9. hafta PDF'si iÃ§in 5-8. haftalar soluk renkte olsun, 9-12. haftalar normal
            const eskiHaftaMi = dokuzuncuHaftaOzelModu && gercekHaftaNo >= 5 && gercekHaftaNo <= 8; // Sadece 5-8. haftalar
            if (eskiHaftaMi) {
              doc.setTextColor(150, 150, 150); // Soluk gri renk
            } else {
              doc.setTextColor(0, 0, 0); // Normal siyah renk
            }
            
            // Tablo Ã§izgi ayarlarÄ±
            doc.setDrawColor(0, 0, 0);
            doc.setLineWidth(0.3);
            
            // Tarih sÃ¼tunu
            doc.rect(zipTableStartX, currentY, colWidths[0], 5);
            
            // 9. hafta PDF'si ve geÃ§miÅŸ haftalarda (5-8) yeÅŸil check simgesi ekle
            if (egzersizDahilMi && gercekHaftaNo <= 8) {
              // YeÅŸil check kutusu Ã§iz
              doc.setFillColor(0, 128, 0); // YeÅŸil dolgu
              doc.rect(zipTableStartX + 1, currentY + 1, 4, 3, 'F'); // YeÅŸil dikdÃ¶rtgen
              
              // Beyaz check Ã§izgisi Ã§iz
              doc.setDrawColor(255, 255, 255); // Beyaz Ã§izgi
              doc.setLineWidth(0.5);
              // Check iÅŸareti Ã§izgisi (V ÅŸekli)
              doc.line(zipTableStartX + 1.5, currentY + 2.5, zipTableStartX + 2.5, currentY + 3.2);
              doc.line(zipTableStartX + 2.5, currentY + 3.2, zipTableStartX + 4.2, currentY + 1.5);
              
              // Tablo Ã§izgi ayarlarÄ±nÄ± geri yÃ¼kle
              doc.setDrawColor(0, 0, 0);
              doc.setLineWidth(0.3);
              
              // Tarihi soluk renkte yaz
              doc.setTextColor(150, 150, 150);
              doc.text(tarihStr, zipTableStartX + 7, currentY + 3.5);
            } else {
              // Normal tarih
              doc.setTextColor(0, 0, 0);
              doc.text(tarihStr, zipTableStartX + 2, currentY + 3.5);
            }
            zipTableStartX += colWidths[0];
            
            // GÃ¼n sÃ¼tunu
            doc.rect(zipTableStartX, currentY, colWidths[1], 5);
            doc.text(gun, zipTableStartX + 2, currentY + 3.5);
            zipTableStartX += colWidths[1];
            
            // Sabah sÃ¼tunu
            doc.rect(zipTableStartX, currentY, colWidths[2], 5);
            doc.text(sabahUygulama, zipTableStartX + 2, currentY + 3.5);
            zipTableStartX += colWidths[2];
            
            // AkÅŸam sÃ¼tunu
            doc.rect(zipTableStartX, currentY, colWidths[3], 5);
            doc.text(aksamUygulama, zipTableStartX + 2, currentY + 3.5);
            
            currentY += 5;
          }
          
          currentY += 5; // Haftalar arasÄ± boÅŸluk
          
          // Sayfa kontrolÃ¼
          if (currentY > 250 && lenfHaftaIndex < 7) {
            doc.addPage('p');
            currentY = 20;
          }
        }
        
        // Blob olarak dÃ¶ndÃ¼r (indirmeden)
        const pdfBlob = doc.output('blob');
        console.log('âœ… Basit Lenf Drenaj PDF Blob oluÅŸturuldu');
        return pdfBlob;
        
      } catch (error) {
        console.error('âŒ Lenf Drenaj PDF Blob hatasÄ±:', error);
        console.error('âŒ Hata detaylarÄ±:', {
          message: error.message,
          stack: error.stack,
          belirliHaftaNo: belirliHaftaNo,
          seciliHasta: seciliHasta ? seciliHasta.isim : 'null'
        });
        return null;
      }
    }

    // Lenf Drenaj MasajÄ± Takvimi PDF OluÅŸturucu
    function generateLenfDrenajTakvimi() {
      console.log('ğŸ¥ Lenf Drenaj MasajÄ± Takvimi PDF oluÅŸturuluyor...');
      
      if (!seciliHasta) {
        alert('LÃ¼tfen Ã¶nce bir hasta seÃ§in!');
        return;
      }
      
      const haftalar = getHaftaListesi();
      if (haftalar.length < 5) {
        alert('En az 5 hafta kaydÄ± olmalÄ±! Mevcut hafta sayÄ±sÄ±: ' + haftalar.length);
        return;
      }
      
      // 5. haftanÄ±n baÅŸlangÄ±Ã§ tarihini al
      const besinciHafta = haftalar[4]; // 5. hafta (index 4)
      if (!besinciHafta || !besinciHafta.baslangic) {
        alert('5. hafta baÅŸlangÄ±Ã§ tarihi bulunamadÄ±!');
        return;
      }
      
      const baslangicTarihi = new Date(besinciHafta.baslangic);
      
      // 5. hafta baÅŸlangÄ±Ã§ tarihinin pazartesi olmasÄ±nÄ± garanti altÄ±na al
      const haftaGunu = baslangicTarihi.getDay(); // 0=Pazar, 1=Pazartesi, ... 6=Cumartesi
      if (haftaGunu !== 1) { // EÄŸer pazartesi deÄŸilse
        const gunFarki = haftaGunu === 0 ? 1 : (1 - haftaGunu); // Pazartesiye kadar olan gÃ¼n farkÄ±
        baslangicTarihi.setDate(baslangicTarihi.getDate() + gunFarki);
      }
      
      try {
        const doc = new jsPDFLib('p', 'mm', 'a4'); // Portrait format
        
        // TÃ¼rkÃ§e karakter desteÄŸi iÃ§in font encoding ayarla
        doc.setFont('helvetica');
        doc.setLanguage('tr-TR');
        
        // BaÅŸlÄ±k
        doc.setFontSize(16);
        doc.setFont('helvetica', 'bold');
        const hastaAdi = turkceKarakterDuzelt(seciliHasta.isim);
        console.log('ğŸ¯ PDF iÃ§in hasta adÄ± dÃ¼zeltmesi:', seciliHasta.isim, ' â†’ ', hastaAdi);
        
        // Manuel ASCII dÃ¶nÃ¼ÅŸtÃ¼rme - Kesin Ã‡alÄ±ÅŸan Versiyon
        const asciiHastaAdi = hastaAdi
          .replace(/Å/g, 'S').replace(/ÅŸ/g, 's')
          .replace(/Ä/g, 'G').replace(/ÄŸ/g, 'g')  
          .replace(/Ä°/g, 'I').replace(/Ä±/g, 'i')
          .replace(/Ã‡/g, 'C').replace(/Ã§/g, 'c')
          .replace(/Ã–/g, 'O').replace(/Ã¶/g, 'o')
          .replace(/Ãœ/g, 'U').replace(/Ã¼/g, 'u');
        
        console.log('ğŸ” FINAL ASCII:', hastaAdi, ' â†’ ', asciiHastaAdi);
        doc.text(asciiHastaAdi.toUpperCase(), 20, 20);
        
        // Debug: Hem orijinal hem ASCII versiyonu deneyelim
        console.log('ğŸ” Debug - orijinal isim:', hastaAdi);
        const pdfUygunHastaAdi = window.fixTurkishChars(hastaAdi);
        console.log('  Debug - ASCII isim:', pdfUygunHastaAdi);
        
        // Ä°ki versiyon da deneyelim
        try {
          // Ã–nce ASCII versiyonu dene
          doc.text(pdfUygunHastaAdi.toUpperCase(), 20, 20);
          console.log('âœ… ASCII versiyon kullanÄ±ldÄ±');
        } catch (e) {
          // ASCII baÅŸarÄ±sÄ±z olursa orijinali dene
          doc.text(hastaAdi.toUpperCase(), 20, 20);
          console.log('âš ï¸ Orijinal versiyon kullanÄ±ldÄ±');
        }
        
        doc.setFontSize(14);
        doc.text(window.fixTurkishChars('LENF DRENAJ MASAJI TAKVIMI'), 20, 35);
        
        // AÃ§Ä±klama
        doc.setFontSize(10);
        doc.setFont('helvetica', 'normal');
        doc.text('5. hafta baÅŸlangÄ±cÄ±ndan itibaren 8 haftalÄ±k program', 20, 50);
        
        // Tablo parametreleri
        const startX = 20;
        const startY = 65;
        const rowHeight = 12;
        const colWidths = [15, 50, 50, 50]; // Hafta, Tarih, Sabah, AkÅŸam
        const tableWidth = colWidths.reduce((a, b) => a + b, 0);
        
        // Tablo baÅŸlÄ±klarÄ±
        doc.setFontSize(10);
        doc.setFont('helvetica', 'bold');
        
        // BaÅŸlÄ±k satÄ±rÄ± arka planÄ±
        doc.setFillColor(230, 230, 230);
        doc.rect(startX, startY, tableWidth, rowHeight, 'F');
        
        // BaÅŸlÄ±k metinleri
        doc.setTextColor(0, 0, 0);
        doc.text('Hafta', startX + 5, startY + 8);
        doc.text('Tarih AralÄ±ÄŸÄ±', startX + colWidths[0] + 5, startY + 8);
        doc.text('Sabah', startX + colWidths[0] + colWidths[1] + 5, startY + 8);
        doc.text('AkÅŸam', startX + colWidths[0] + colWidths[1] + colWidths[2] + 5, startY + 8);
        
        // Tablo Ã§erÃ§evesi
        doc.setDrawColor(0, 0, 0);
        doc.setLineWidth(0.3);
        doc.rect(startX, startY, tableWidth, rowHeight);
        
        // SÃ¼tun ayÄ±rÄ±cÄ±larÄ± (baÅŸlÄ±k satÄ±rÄ± iÃ§in)
        let currentX = startX;
        for (let i = 0; i < colWidths.length - 1; i++) {
          currentX += colWidths[i];
          doc.line(currentX, startY, currentX, startY + rowHeight);
        }
        
        // 8 haftalÄ±k veri satÄ±rlarÄ±
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(9);
        
        for (let hafta = 1; hafta <= 8; hafta++) {
          const currentY = startY + (hafta * rowHeight);
          
          // Hafta baÅŸlangÄ±Ã§ tarihini hesapla
          const haftaBaslangic = new Date(baslangicTarihi);
          haftaBaslangic.setDate(haftaBaslangic.getDate() + ((hafta - 1) * 7));
          
          const haftaSonu = new Date(haftaBaslangic);
          haftaSonu.setDate(haftaSonu.getDate() + 6);
          
          // Tarih formatÄ±
          const baslangicStr = haftaBaslangic.toLocaleDateString('tr-TR');
          const bitisStr = haftaSonu.toLocaleDateString('tr-TR');
          const tarihAraligi = `${baslangicStr} - ${bitisStr}`;
          
          // Lenf drenaj programÄ±na gÃ¶re metin
          let sabahMetin = '';
          let aksamMetin = '';
          
          if (hafta === 1) {
            // 1. hafta: GÃ¼nde 2 kez (sabah + akÅŸam)
            sabahMetin = 'âœ“ Uygulanacak';
            aksamMetin = 'âœ“ Uygulanacak';
          } else if (hafta === 2 || hafta === 3) {
            // 2-3. hafta: Sadece sabahlarÄ±
            sabahMetin = 'âœ“ Uygulanacak';
            aksamMetin = '-';
          } else if (hafta === 4 || hafta === 5) {
            // 4-5. hafta: GÃ¼naÅŸÄ±rÄ± sabahlarÄ±
            sabahMetin = 'âœ“ GÃ¼naÅŸÄ±rÄ±';
            aksamMetin = '-';
          } else if (hafta === 6 || hafta === 7 || hafta === 8) {
            // 6-7-8. hafta: Haftada 2 gÃ¼n (SalÄ±-Cuma)
            sabahMetin = 'âœ“ SalÄ±-Cuma';
            aksamMetin = '-';
          }
          
          // SatÄ±r arka planÄ± (her iki satÄ±rda bir)
          if (hafta % 2 === 0) {
            doc.setFillColor(248, 248, 248);
            doc.rect(startX, currentY, tableWidth, rowHeight, 'F');
          }
          
          // SatÄ±r Ã§erÃ§evesi
          doc.setDrawColor(0, 0, 0);
          doc.setLineWidth(0.3);
          doc.rect(startX, currentY, tableWidth, rowHeight);
          
          // SÃ¼tun ayÄ±rÄ±cÄ±larÄ±
          currentX = startX;
          for (let i = 0; i < colWidths.length - 1; i++) {
            currentX += colWidths[i];
            doc.line(currentX, currentY, currentX, currentY + rowHeight);
          }
          
          // Metinleri ekle
          doc.setTextColor(0, 0, 0);
          doc.text(`${hafta}. Hafta`, startX + 3, currentY + 8);
          doc.text(tarihAraligi, startX + colWidths[0] + 3, currentY + 8);
          doc.text(sabahMetin, startX + colWidths[0] + colWidths[1] + 3, currentY + 8);
          doc.text(aksamMetin, startX + colWidths[0] + colWidths[1] + colWidths[2] + 3, currentY + 8);
        }
        
        // Alt aÃ§Ä±klama
        const aciklamaY = startY + (9 * rowHeight) + 10;
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(10);
        doc.text('UYGULAMA TALÄ°MATI:', startX, aciklamaY);
        
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(9);
        doc.text('â€¢ 1. hafta: GÃ¼nde 2 kez (sabah + akÅŸam) uygulanacak', startX, aciklamaY + 12);
        doc.text('â€¢ 2-3. hafta: Sadece sabahlarÄ± uygulanacak', startX, aciklamaY + 22);
        doc.text('â€¢ 4-5. hafta: GÃ¼naÅŸÄ±rÄ± sabahlarÄ± uygulanacak', startX, aciklamaY + 32);
        doc.text('â€¢ 6-7-8. hafta: Haftada 2 gÃ¼n (SalÄ±-Cuma) sabahlarÄ± uygulanacak', startX, aciklamaY + 42);
        
        // PDF'yi kaydet
        const tarih = new Date().toISOString().slice(0, 10);
        const dosyaAdi = `${hastaAdi}_Lenf_Drenaj_Takvimi_${tarih}.pdf`;
        doc.save(dosyaAdi);
        
        console.log('âœ… Lenf Drenaj Takvimi PDF oluÅŸturuldu:', dosyaAdi);
        alert(`âœ… Lenf Drenaj MasajÄ± Takvimi PDF oluÅŸturuldu!\n\nDosya: ${dosyaAdi}`);
        
      } catch (error) {
        console.error('âŒ Lenf Drenaj Takvimi PDF hatasÄ±:', error);
        alert('PDF oluÅŸtururken hata oluÅŸtu: ' + error.message);
      }
    }

    // Ã–zelleÅŸtirilebilir Lenf Masaj Takvimi
    async function generateCustomLenfMasajTakvimi() {
      try {
        // Default deÄŸerleri hazÄ±rla
        let defaultHastaAdi = '';
        let defaultBaslangicTarihi = '';
        
        // Mevcut seÃ§ili hasta varsa al
        if (seciliHasta) {
          defaultHastaAdi = seciliHasta.isim || '';
        }
        
        // 5. hafta baÅŸlangÄ±Ã§ tarihini bulmaya Ã§alÄ±ÅŸ
        try {
          const haftalar = getHaftaListesi();
          if (haftalar.length >= 5 && haftalar[4].baslangic) {
            const besinciHaftaTarihi = new Date(haftalar[4].baslangic);
            // Pazartesi kontrolÃ¼
            const gunNo = besinciHaftaTarihi.getDay();
            if (gunNo !== 1) {
              const gunFarki = gunNo === 0 ? 1 : (1 - gunNo);
              besinciHaftaTarihi.setDate(besinciHaftaTarihi.getDate() + gunFarki);
            }
            defaultBaslangicTarihi = besinciHaftaTarihi.toISOString().slice(0, 10);
          } else {
            // BugÃ¼nden itibaren bir sonraki pazartesi
            const bugun = new Date();
            const gelecekPazartesi = new Date(bugun.getFullYear(), bugun.getMonth(), bugun.getDate() - bugun.getDay() + 8);
            defaultBaslangicTarihi = gelecekPazartesi.toISOString().slice(0, 10);
          }
        } catch (e) {
          // Hata durumunda bir sonraki pazartesi
          const bugun = new Date();
          const gelecekPazartesi = new Date(bugun.getFullYear(), bugun.getMonth(), bugun.getDate() - bugun.getDay() + 8);
          defaultBaslangicTarihi = gelecekPazartesi.toISOString().slice(0, 10);
        }
        
        // KullanÄ±cÄ±dan bilgileri al
        const hastaAdi = prompt('Hasta AdÄ±:', defaultHastaAdi);
        if (!hastaAdi) {
          alert('Hasta adÄ± girilmedi, iÅŸlem iptal edildi.');
          return;
        }
        
        const baslangicTarihi = prompt('BaÅŸlangÄ±Ã§ Tarihi (YYYY-MM-DD):', defaultBaslangicTarihi);
        if (!baslangicTarihi) {
          alert('BaÅŸlangÄ±Ã§ tarihi girilmedi, iÅŸlem iptal edildi.');
          return;
        }
        
        // Tarih kontrolÃ¼
        const tarihObj = new Date(baslangicTarihi);
        if (isNaN(tarihObj.getTime())) {
          alert('GeÃ§ersiz tarih formatÄ±! YYYY-MM-DD formatÄ±nda giriniz.');
          return;
        }
        
        // Pazartesi kontrolÃ¼
        const gunNo = tarihObj.getDay();
        if (gunNo !== 1) {
          const gunIsimleri = ['Pazar', 'Pazartesi', 'SalÄ±', 'Ã‡arÅŸamba', 'PerÅŸembe', 'Cuma', 'Cumartesi'];
          const mevcutGun = gunIsimleri[gunNo];
          if (!confirm(`SeÃ§ilen tarih ${mevcutGun} gÃ¼nÃ¼. Lenf masaj programÄ± pazartesi gÃ¼nleri baÅŸlar.\n\nEn yakÄ±n pazartesi gÃ¼nÃ¼ne otomatik ayarlansÄ±n mÄ±?`)) {
            return;
          }
          
          // En yakÄ±n pazartesiye ayarla
          const gunFarki = gunNo === 0 ? 1 : (1 - gunNo);
          tarihObj.setDate(tarihObj.getDate() + gunFarki);
        }
        
        // Ã–zel lenf masaj PDF'i oluÅŸtur (5. hafta benzeri)
        await generateCustomLenfMasajPDF(hastaAdi, tarihObj);
        
      } catch (error) {
        console.error('âŒ Ã–zel Lenf Masaj Takvimi hatasÄ±:', error);
        alert('PDF oluÅŸtururken hata oluÅŸtu: ' + error.message);
      }
    }

    // Ã–zelleÅŸtirilebilir Egzersiz Takvimi 
    async function generateCustomEgzersizTakvimi() {
      try {
        // Default deÄŸerleri hazÄ±rla
        let defaultHastaAdi = '';
        let defaultBaslangicTarihi = '';
        
        // Mevcut seÃ§ili hasta varsa al
        if (seciliHasta) {
          defaultHastaAdi = seciliHasta.isim || '';
        }
        
        // 9. hafta baÅŸlangÄ±Ã§ tarihini bulmaya Ã§alÄ±ÅŸ (5. haftadan 4 hafta sonra)
        try {
          const haftalar = getHaftaListesi();
          if (haftalar.length >= 5 && haftalar[4].baslangic) {
            const besinciHaftaTarihi = new Date(haftalar[4].baslangic);
            // Pazartesi kontrolÃ¼
            const gunNo = besinciHaftaTarihi.getDay();
            if (gunNo !== 1) {
              const gunFarki = gunNo === 0 ? 1 : (1 - gunNo);
              besinciHaftaTarihi.setDate(besinciHaftaTarihi.getDate() + gunFarki);
            }
            // 9. hafta = 5. haftadan 4 hafta (28 gÃ¼n) sonra
            const dokuzuncuHaftaTarihi = new Date(besinciHaftaTarihi.getTime() + (4 * 7 * 24 * 60 * 60 * 1000));
            defaultBaslangicTarihi = dokuzuncuHaftaTarihi.toISOString().slice(0, 10);
          } else {
            // BugÃ¼nden itibaren bir sonraki pazartesi
            const bugun = new Date();
            const gelecekPazartesi = new Date(bugun.getFullYear(), bugun.getMonth(), bugun.getDate() - bugun.getDay() + 8);
            defaultBaslangicTarihi = gelecekPazartesi.toISOString().slice(0, 10);
          }
        } catch (e) {
          // Hata durumunda bir sonraki pazartesi
          const bugun = new Date();
          const gelecekPazartesi = new Date(bugun.getFullYear(), bugun.getMonth(), bugun.getDate() - bugun.getDay() + 8);
          defaultBaslangicTarihi = gelecekPazartesi.toISOString().slice(0, 10);
        }
        
        // KullanÄ±cÄ±dan bilgileri al
        const hastaAdi = prompt('Hasta AdÄ±:', defaultHastaAdi);
        if (!hastaAdi) {
          alert('Hasta adÄ± girilmedi, iÅŸlem iptal edildi.');
          return;
        }
        
        const baslangicTarihi = prompt('BaÅŸlangÄ±Ã§ Tarihi (YYYY-MM-DD):', defaultBaslangicTarihi);
        if (!baslangicTarihi) {
          alert('BaÅŸlangÄ±Ã§ tarihi girilmedi, iÅŸlem iptal edildi.');
          return;
        }
        
        // Tarih kontrolÃ¼
        const tarihObj = new Date(baslangicTarihi);
        if (isNaN(tarihObj.getTime())) {
          alert('GeÃ§ersiz tarih formatÄ±! YYYY-MM-DD formatÄ±nda giriniz.');
          return;
        }
        
        // Pazartesi kontrolÃ¼
        const gunNo = tarihObj.getDay();
        if (gunNo !== 1) {
          const gunIsimleri = ['Pazar', 'Pazartesi', 'SalÄ±', 'Ã‡arÅŸamba', 'PerÅŸembe', 'Cuma', 'Cumartesi'];
          const mevcutGun = gunIsimleri[gunNo];
          if (!confirm(`SeÃ§ilen tarih ${mevcutGun} gÃ¼nÃ¼. Egzersiz programÄ± pazartesi gÃ¼nleri baÅŸlar.\n\nEn yakÄ±n pazartesi gÃ¼nÃ¼ne otomatik ayarlansÄ±n mÄ±?`)) {
            return;
          }
          
          // En yakÄ±n pazartesiye ayarla
          const gunFarki = gunNo === 0 ? 1 : (1 - gunNo);
          tarihObj.setDate(tarihObj.getDate() + gunFarki);
        }
        
        // Ã–zel egzersiz + lenf masaj PDF'i oluÅŸtur (9. hafta benzeri)
        await generateCustomEgzersizPDF(hastaAdi, tarihObj);
        
      } catch (error) {
        console.error('âŒ Ã–zel Egzersiz Takvimi hatasÄ±:', error);
        alert('PDF oluÅŸtururken hata oluÅŸtu: ' + error.message);
      }
    }

    function gosterTariflerHafta(i) {
      const hafta = getHaftaListesi()[i];
      const ul = document.getElementById('haftaTarifListesi_' + i);
      if (!ul) return;
      ul.innerHTML = '';
      (hafta.tarifler||[]).forEach(t => {
        const li = document.createElement('li');
        li.textContent = t;
        ul.appendChild(li);
      });
    }

    function tarifKartYukleHafta(i, input) {
      const hafta = getHaftaListesi()[i];
      hafta.tarifKartlar = [];
      const gorselDiv = document.getElementById('haftaKartGorsel_' + i);
      gorselDiv.innerHTML = '';
      Array.from(input.files).forEach(file => {
        const reader = new FileReader();
        reader.onload = function (e) {
          hafta.tarifKartlar.push({ name: file.name, data: e.target.result });
          const img = document.createElement('img');
          img.src = e.target.result;
          img.alt = file.name;
          img.style.width = '100px';
          img.style.margin = '4px';
          gorselDiv.appendChild(img);
          saveToStorage();
          
          console.log('âœ… Tarif kartÄ± eklendi:', file.name, 'hafta:', i + 1);
          
          // Otomatik GitHub kaydetme kaldÄ±rÄ±ldÄ± (Ã§akÄ±ÅŸmalarÄ± Ã¶nlemek iÃ§in)
          // Manuel kaydetme iÃ§in GitHub'a Kaydet butonunu kullanÄ±n
        };
        reader.readAsDataURL(file);
      });
    }

    function gosterKartlarHafta(i) {
      const hafta = getHaftaListesi()[i];
      const gorselDiv = document.getElementById('haftaKartGorsel_' + i);
      if (!gorselDiv) return;
      gorselDiv.innerHTML = '';
      (hafta.tarifKartlar||[]).forEach(kart => {
        const img = document.createElement('img');
        // GÃ¼venli src atama - undefined hatasÄ± Ã¶nleme
        img.src = kart.data || kart.kartData || `https://mustafasacar35.github.io/lipodem-takip-paneli-3/tarifler/${kart.kartResmi || 'default.jpg'}`;
        img.alt = kart.name || kart.tarifAdi || 'Tarif kartÄ±';
        img.style.width = '100px';
        img.style.margin = '4px';
        gorselDiv.appendChild(img);
      });
    }

    async function otomatikEsleHafta(i) {
  // Tarif satÄ±rÄ±ndan alternatifli yemek adlarÄ±nÄ± ayÄ±kla
  function extractYemekAdlari(satir) {
    // BaÅŸtaki * ve miktarlarÄ± temizle
    let s = satir.replace(/^\*+\s*/, '');
    // Parantez iÃ§ini, + ile eklenenleri, miktarlarÄ± temizle
    s = s.replace(/\(.*?\)/g, '');
    s = s.replace(/\+.*$/, '');
    s = s.replace(/([0-9]+\s*(gram|gr|adet|yemek\s*kaÅŸÄ±ÄŸÄ±|tatlÄ±\s*kaÅŸÄ±ÄŸÄ±|su\s*bardaÄŸÄ±|dilim|kase|Ã§ay\s*bardaÄŸÄ±|bardak|kaÅŸÄ±k|tbsp|tsp|ml|kg|g))($|\s)/gi, '');
    s = s.replace(/(istenilen baharatlarla|istenirse|isteÄŸe baÄŸlÄ±|arzuya gÃ¶re|isteÄŸe gÃ¶re|isteÄŸe baÄŸlÄ± olarak|isteÄŸe gÃ¶re baharat|isteÄŸe gÃ¶re malzeme|isteÄŸe gÃ¶re eklenebilir)/gi, '');
    
    // Ã–nce "ya da", "veya" ile ayrÄ±lmÄ±ÅŸ alternatifleri ayÄ±r
    let alternatifler = s.split(/\s*(ya da|veya)\s*/i).map(a => a.trim()).filter(a => a.length > 0);
    let tumAdlar = [];
    
    // Her alternatif iÃ§in ayrÄ± iÅŸlem yap
    alternatifler.forEach(alt => {
      // "ile", "iÃ§in", "ve" kelimelerini temizle
      alt = alt.replace(/\b(ile|iÃ§in|ve)\b/gi, '');
      // "/" ve "," ile ayrÄ±lmÄ±ÅŸ alt seÃ§enekleri de ayÄ±r - YENÄ°: / iÅŸaretini de dahil et
      let adlar = alt.split(/\s*[\/|,]\s*/).map(a => a.trim()).filter(a => a.length > 0);
      // Sadece ana yemek adÄ±nÄ± ayÄ±kla: baÅŸtaki ve sondaki boÅŸluklarÄ±, miktarlarÄ±, "iÃ§in" ve fazlalÄ±klarÄ± sil
      adlar = adlar.map(a => a.replace(/^[0-9]+\s*/, '').replace(/\s*[0-9]+\s*(gram|gr|adet|dilim|kase|bardak|ml|kg|tsp|tbsp)?\s*$/i, '').replace(/\s*icin?$/i, '').replace(/\s*ile$/i, '').trim());
      // Ã‡ok kÄ±sa olanlarÄ± atma - sadece boÅŸ olanlarÄ± at
      adlar = adlar.filter(a => a.length > 0);
      tumAdlar = tumAdlar.concat(adlar);
    });
    
    return tumAdlar;
  }

  // Manuel eÅŸleÅŸtirme kontrolÃ¼
  function manuelEslestirmeKontrol(tarifSatir) {
    // Normalize fonksiyonu burada da tanÄ±mla
    function normalizeLocal(str) {
      return str
        .toLowerCase()
        .replace(/Ã§/g, 'c').replace(/ÄŸ/g, 'g').replace(/ÅŸ/g, 's')
        .replace(/Ã¼/g, 'u').replace(/Ã¶/g, 'o').replace(/Ä±/g, 'i')
        .replace(/iÌ‡/g, 'i')
        .replace(/[_*\/()]/g, ' ')  // Sembolleri boÅŸlukla deÄŸiÅŸtir
        .replace(/\s+/g, ' ')       // Ã‡oklu boÅŸluklarÄ± tek boÅŸluÄŸa Ã§evir
        .replace(/[^a-z0-9\s]/g, '') // Sadece harf, rakam ve boÅŸluk bÄ±rak
        .trim();
    }
    
    const normalizeEdilmis = normalizeLocal(tarifSatir);
    
    if (manuelEslestirmeler[normalizeEdilmis]) {
      const eslestirme = manuelEslestirmeler[normalizeEdilmis];
      return eslestirme.kartlar.map(kartAdi => {
        const kart = tumKartlar.find(k => k.name === kartAdi);
        return kart || null;
      }).filter(k => k !== null);
    }
    
    return null;
  }

  // EÅŸleÅŸme yasaÄŸÄ± kontrolÃ¼
  function eslesmemeKontrolu(tarifSatir, kartAdi) {
    // Normalize fonksiyonu
    function normalizeLocal(str) {
      return str
        .toLowerCase()
        .replace(/Ã§/g, 'c').replace(/ÄŸ/g, 'g').replace(/ÅŸ/g, 's')
        .replace(/Ã¼/g, 'u').replace(/Ã¶/g, 'o').replace(/Ä±/g, 'i')
        .replace(/iÌ‡/g, 'i')
        .replace(/[_*\/()]/g, ' ')
        .replace(/\s+/g, ' ')
        .replace(/[^a-z0-9\s]/g, '')
        .trim();
    }
    
    const normalizeEdilmis = normalizeLocal(tarifSatir);
    
    if (eslesmemeKurallari[normalizeEdilmis]) {
      const yasak = eslesmemeKurallari[normalizeEdilmis];
      return yasak.yasakliKartlar.includes(kartAdi);
    }
    
    return false; // Yasak yok, eÅŸleÅŸebilir
  }
  // Dosya adÄ±ndaki miktar ve aÃ§Ä±klama kelimelerini temizle
  function temizleDosyaAdi(ad) {
    if (!ad || typeof ad !== 'string') return ''; // GÃ¼venlik kontrolÃ¼
    let s = ad.replace(/\.(jpg|jpeg|png)$/i, '');
    s = s.replace(/_\d+(gr|gram|adet|dilim|kase|bardak|ml|kg|tsp|tbsp)?/gi, '');
    s = s.replace(/\(.*?\)/g, '');
    s = s.replace(/_?(istenilen_baharatlarla|istenirse|istege_bagli|arzuya_gore|istege_gore|istege_bagli_olarak|istege_gore_baharat|istege_gore_malzeme|istege_gore_eklenebilir)/gi, '');
    s = s.replace(/_+/g, '_');
    s = s.replace(/\s+/g, '_');
    s = s.replace(/\+.*$/, '');
    return s.trim();
  }
   // Normalize fonksiyonu - sembolleri ve TÃ¼rkÃ§e karakterleri temizle
  function normalize(str) {
    return str
      .toLowerCase()
      .replace(/Ã§/g, 'c').replace(/ÄŸ/g, 'g').replace(/ÅŸ/g, 's')
      .replace(/Ã¼/g, 'u').replace(/Ã¶/g, 'o').replace(/Ä±/g, 'i')
      .replace(/iÌ‡/g, 'i')
      .replace(/[_*\/()]/g, ' ')  // Sembolleri boÅŸlukla deÄŸiÅŸtir
      .replace(/\s+/g, ' ')       // Ã‡oklu boÅŸluklarÄ± tek boÅŸluÄŸa Ã§evir
      .replace(/[^a-z0-9\s]/g, '') // Sadece harf, rakam ve boÅŸluk bÄ±rak
      .trim();
  }

  // Tarif kartÄ±ndaki TÃœM kelimelerin PDF yemeÄŸinde ardÄ±ÅŸÄ±k olarak bulunup bulunmadÄ±ÄŸÄ±nÄ± kontrol et
  function kartKelimeleriniKontrolEt(kartKelimeler, tarifKelimeler) {
    if (kartKelimeler.length === 0) return false;
    
    // Kart kelimelerini birleÅŸtir (ardÄ±ÅŸÄ±k arama iÃ§in)
    const kartMetni = kartKelimeler.join(' ');
    const tarifMetni = tarifKelimeler.join(' ');
    
    // Kart metninin tarif metninde ardÄ±ÅŸÄ±k olarak bulunup bulunmadÄ±ÄŸÄ±nÄ± kontrol et
    return tarifMetni.includes(kartMetni);
  }
 // EÄŸer gÃ¶rseller henÃ¼z yÃ¼klenmediyse, Ã¶nce yÃ¼kle
  if (tariflerKlasoruGorselleri.length === 0) {
    await tariflerKlasoruGorselleriniYukle();
  }

  const hafta = getHaftaListesi()[i];
  const eslesenDiv = document.getElementById('eslesenKartlar_' + i);
  
  // DOM element kontrolÃ¼ - Ã§oklu PDF iÅŸleminde element olmayabilir
  const domElementMevcut = eslesenDiv !== null;
  if (domElementMevcut) {
    eslesenDiv.innerHTML = '';
  }

  if (!hafta.tarifler.length) {
    if (domElementMevcut) {
      eslesenDiv.innerHTML = '<i>Ã–nce PDF yÃ¼kleyin ve tarifleri Ã§Ä±karÄ±n.</i>';
    }
    return [];
  }

  // Hem manuel yÃ¼klenen hem tarifler klasÃ¶rÃ¼ gÃ¶rsellerini birleÅŸtir
  const tumKartlar = [].concat(
    hafta.tarifKartlar || [],
    tariflerKlasoruGorselleri.map(g => ({ name: g.name, data: g.url, url: g.url }))
  ).filter(kart => kart && kart.name); // Null/undefined kartlarÄ± filtrele

  if (!tumKartlar.length) {
    // Daha detaylÄ± hata mesajÄ± ve Ã§Ã¶zÃ¼m Ã¶nerileri
    const hataDiv = document.createElement('div');
    hataDiv.style.padding = '15px';
    hataDiv.style.border = '2px solid #dc3545';
    hataDiv.style.borderRadius = '8px';
    hataDiv.style.backgroundColor = '#f8d7da';
    hataDiv.style.color = '#721c24';
    hataDiv.innerHTML = `
      <h4 style="margin-top:0; color:#721c24;">âŒ Tarif kartlarÄ± bulunamadÄ±</h4>
      <p><strong>Sebep:</strong> Bu hafta iÃ§in eÅŸleÅŸme yapÄ±labilecek hiÃ§bir tarif kartÄ± bulunamadÄ±.</p>
      <div style="margin-top:15px;">
        <p><strong>Ã‡Ã¶zÃ¼m seÃ§enekleri:</strong></p>
        <ol style="margin-left:20px;">
          <li><strong>Manuel gÃ¶rsel yÃ¼kle:</strong> Bu hafta iÃ§in "Tarif KartlarÄ±" bÃ¶lÃ¼mÃ¼nden gÃ¶rsel dosyalarÄ± yÃ¼kleyin</li>
          <li><strong>Tarifler klasÃ¶rÃ¼ oluÅŸtur:</strong> Web sitenizin ana dizininde "tarifler/" klasÃ¶rÃ¼ oluÅŸturun ve iÃ§ine gÃ¶rsel dosyalarÄ±nÄ± ekleyin</li>
          <li><strong>list.json dosyasÄ±:</strong> "tarifler/" klasÃ¶rÃ¼nde dosya listesini iÃ§eren "list.json" dosyasÄ± oluÅŸturun</li>
        </ol>
      </div>
      <div style="margin-top:15px; padding:10px; background:#fff3cd; border:1px solid #ffeaa7; border-radius:5px;">
        <strong>ğŸ’¡ Ä°pucu:</strong> Tarifler klasÃ¶rÃ¼ durumu: 
        <span style="color:${tariflerKlasoruGorselleri.length > 0 ? 'green' : 'red'};">
          ${tariflerKlasoruGorselleri.length} gÃ¶rsel bulundu
        </span>
        <br>
        Manuel yÃ¼klenen kartlar: 
        <span style="color:${(hafta.tarifKartlar && hafta.tarifKartlar.length > 0) ? 'green' : 'red'};">
          ${(hafta.tarifKartlar && hafta.tarifKartlar.length) || 0} adet
        </span>
      </div>
      <div style="margin-top:15px; text-align:center;">
        <button onclick="yeniBirDenemeEt(${i})" style="background:#28a745; color:white; padding:10px 20px; border:none; border-radius:5px; cursor:pointer; margin-right:10px;">
          ğŸ”„ Tarifler KlasÃ¶rÃ¼nÃ¼ Yeniden YÃ¼kle
        </button>
        <button onclick="debugTariflerKlasoru()" style="background:#17a2b8; color:white; padding:10px 20px; border:none; border-radius:5px; cursor:pointer;">
          ğŸ” DetaylÄ± Debug
        </button>
      </div>
    `;
    if (domElementMevcut) {
      eslesenDiv.appendChild(hataDiv);
    }
    return [];
  }

  // Normalize fonksiyonu - sembolleri ve TÃ¼rkÃ§e karakterleri temizle
  function normalize(str) {
    return str
      .toLowerCase()
      .replace(/Ã§/g, 'c').replace(/ÄŸ/g, 'g').replace(/ÅŸ/g, 's')
      .replace(/Ã¼/g, 'u').replace(/Ã¶/g, 'o').replace(/Ä±/g, 'i')
      .replace(/iÌ‡/g, 'i')
      .replace(/[_*\/()]/g, ' ')  // Sembolleri boÅŸlukla deÄŸiÅŸtir
      .replace(/\s+/g, ' ')       // Ã‡oklu boÅŸluklarÄ± tek boÅŸluÄŸa Ã§evir
      .replace(/[^a-z0-9\s]/g, '') // Sadece harf, rakam ve boÅŸluk bÄ±rak
      .trim();
  }

  // Basit Levenshtein mesafesi (benzerlik iÃ§in)
  function levenshtein(a, b) {
    const matrix = Array(a.length + 1).fill(null).map(() => Array(b.length + 1).fill(null));
    for (let i = 0; i <= a.length; i++) matrix[i][0] = i;
    for (let j = 0; j <= b.length; j++) matrix[0][j] = j;
    for (let i = 1; i <= a.length; i++) {
      for (let j = 1; j <= b.length; j++) {
        const cost = a[i - 1] === b[j - 1] ? 0 : 1;
        matrix[i][j] = Math.min(
          matrix[i - 1][j] + 1,
          matrix[i][j - 1] + 1,
          matrix[i - 1][j - 1] + cost
        );
      }
    }
    return matrix[a.length][b.length];
  }

  const kullanilanKartlar = new Set();
  let eslesenKartlarListesi = [];
  let eslesmeyenTarifler = [];
  let eslesmeyenOneriler = [];

  // Her tarif iÃ§in eÅŸleÅŸtirme yap
  hafta.tarifler.forEach(tarif => {
    let tarifSatir = tarif.replace(/^\*+\s*/, '').trim();
    let eslesen = null;
    let eslesenKartlar = [];
    let eslesenTip = '';

    // Debug: mantarlÄ± tavuk sote iÃ§in Ã¶zel Ã§Ä±ktÄ±
    if (tarifSatir.toLowerCase().includes('mantarlÄ± tavuk sote') || tarifSatir.toLowerCase().includes('mantarli tavuk sote')) {
      console.log('DEBUG - MantarlÄ± tavuk sote analizi:');
      console.log('Orijinal tarif:', tarifSatir);
      console.log('DEBUG - Toplam kart sayÄ±sÄ±:', tumKartlar.length);
      console.log('DEBUG - mantarli_tavuk_sote.jpg var mÄ±?', tumKartlar.some(k => k.name === 'mantarli_tavuk_sote.jpg'));
    }

    // 1. Ã–nce manuel eÅŸleÅŸtirme kontrol et
    const manuelEslesenler = manuelEslestirmeKontrol(tarif);
    if (manuelEslesenler && manuelEslesenler.length > 0) {
      // Manuel eÅŸleÅŸtirme bulundu
      const kullanilamayacaklar = manuelEslesenler.filter(kart => kullanilanKartlar.has(kart.name));
      const kullanilabilirler = manuelEslesenler.filter(kart => !kullanilanKartlar.has(kart.name));
      
      if (kullanilabilirler.length > 0) {
        eslesenKartlar = kullanilabilirler;
        eslesenTip = 'manuel eÅŸleÅŸtirme';
        kullanilabilirler.forEach(kart => kullanilanKartlar.add(kart.name));
      }
    } else {
      // 2. Otomatik eÅŸleÅŸtirme dene
      let yemekAdlari = extractYemekAdlari(tarifSatir);

      // Her yemek adÄ± iÃ§in eÅŸleÅŸtirme dene
      for (let yemekAdi of yemekAdlari) {
        const tarifNorm = normalize(yemekAdi);
        const tarifKelimeler = tarifNorm.split(' ').filter(k => k.length > 0);

        // KullanÄ±lmayan kartlar arasÄ±nda ara
        for (let kart of tumKartlar) {
          if (kullanilanKartlar.has(kart.name)) continue;

          // EÅŸleÅŸme yasaÄŸÄ± kontrolÃ¼ - Ã–NCE BU KONTROL EDÄ°LÄ°R
          if (eslesmemeKontrolu(tarif, kart.name)) {
            continue; // Bu kart yasaklÄ±, sonrakine geÃ§
          }

          const kartNorm = normalize(temizleDosyaAdi(kart.name));
          const kartKelimeler = kartNorm.split(' ').filter(k => k.length > 0);

          // 1. Ã–nce tam eÅŸleÅŸme kontrol et
          if (tarifNorm === kartNorm) {
            eslesen = kart;
            eslesenKartlar = [kart];
            eslesenTip = 'tam eÅŸleÅŸme';
            break;
          }

          // 2. Kart kelimelerinin tarif iÃ§inde ardÄ±ÅŸÄ±k olarak bulunup bulunmadÄ±ÄŸÄ±nÄ± kontrol et
          if (kartKelimeleriniKontrolEt(kartKelimeler, tarifKelimeler)) {
            eslesen = kart;
            eslesenKartlar = [kart];
            eslesenTip = 'ardÄ±ÅŸÄ±k eÅŸleÅŸme';
            break;
          }
        }

        // EÅŸleÅŸme bulunursa bu yemek adÄ± iÃ§in dur
        if (eslesen) {
          kullanilanKartlar.add(eslesen.name);
          break;
        }
      }
    }

    // EÅŸleÅŸme bulunduysa kaydet
    if (eslesenKartlar.length > 0) {
      eslesenKartlar.forEach(kart => {
        eslesenKartlarListesi.push({ 
          tarif: tarif, 
          kart: kart, 
          tip: eslesenTip 
        });
      });
    } else {
      eslesmeyenTarifler.push(tarif);
    }
  });

  // SonuÃ§larÄ± gÃ¶ster (sadece DOM element varsa)
  if (domElementMevcut) {
    if (eslesenKartlarListesi.length === 0) {
      eslesenDiv.innerHTML = '<p>EÅŸleÅŸme bulunamadÄ±.</p>';
    } else {
      // Tarifleri grupla ve gÃ¶ster
      const tarifGruplari = {};
      eslesenKartlarListesi.forEach(({ tarif, kart, tip }) => {
        if (!tarifGruplari[tarif]) {
          tarifGruplari[tarif] = { kartlar: [], tip: tip };
        }
        tarifGruplari[tarif].kartlar.push(kart);
      });

      Object.keys(tarifGruplari).forEach(tarif => {
        const grup = tarifGruplari[tarif];
        const p = document.createElement('p');
        const kartIsimleri = grup.kartlar.map(k => k.name).join(', ');
        
        // Tarif adÄ±nÄ± tÄ±klanabilir span iÃ§ine al
        const tarifSpan = document.createElement('span');
        tarifSpan.innerHTML = `<b>${tarif}</b>`;
        tarifSpan.style.cursor = 'pointer';
        tarifSpan.style.textDecoration = 'underline';
        tarifSpan.style.color = '#007bff';
        tarifSpan.title = 'TÄ±kla ve manuel eÅŸleÅŸtirme panelini aÃ§';
        
        // TÄ±klama olayÄ± - Manuel eÅŸleÅŸtirme panelini aÃ§ ve bilgileri doldur
        tarifSpan.onclick = () => {
          console.log('ğŸ”§ EÅŸleÅŸen tarif adÄ±na tÄ±klandÄ±:', tarif, grup.kartlar);
          try {
            if (typeof eslesenTarifManuelEslestir === 'function') {
              eslesenTarifManuelEslestir(tarif, grup.kartlar);
            } else {
              console.error('âŒ eslesenTarifManuelEslestir fonksiyonu bulunamadÄ±!');
              alert('Manuel eÅŸleÅŸtirme fonksiyonu yÃ¼klenemedi. SayfayÄ± yenileyin.');
            }
          } catch (error) {
            console.error('âŒ EÅŸleÅŸen tarif tÄ±klama hatasÄ±:', error);
            alert('Hata: ' + error.message);
          }
        };
        
        // Full p elementi oluÅŸtur (innerHTML += kullanmadan)
        p.appendChild(tarifSpan);
        
        const okSpan = document.createElement('span');
        okSpan.innerHTML = ` â†’ <span style="color:green;">${kartIsimleri}</span> <small style="color:blue;">(${grup.tip})</small>`;
        p.appendChild(okSpan);
        
        eslesenDiv.appendChild(p);
        
        // Her kart iÃ§in gÃ¶rsel ekle
        grup.kartlar.forEach(kart => {
          const img = document.createElement('img');
          // GÃ¼venli src atama - undefined hatasÄ± Ã¶nleme
          img.src = kart.data || kart.kartData || `https://mustafasacar35.github.io/lipodem-takip-paneli-3/tarifler/${kart.kartResmi || kart.name || 'default.jpg'}`;
          img.alt = tarif;
          img.title = kart.name || kart.tarifAdi || 'Tarif kartÄ±';
          img.style.width = '120px';
          img.style.margin = '4px';
          eslesenDiv.appendChild(img);
        });
      });
      
      // Ä°ndir butonlarÄ± ekle
      const indirDiv = document.createElement('div');
      indirDiv.style.marginTop = '15px';
      indirDiv.style.display = 'flex';
      indirDiv.style.gap = '10px';
      indirDiv.style.flexWrap = 'wrap';
      
      // ZIP olarak indir butonu
      const zipBtn = document.createElement('button');
      zipBtn.textContent = 'ğŸ“¦ TÃ¼m DosyalarÄ± ZIP Ä°ndir';
      zipBtn.style.background = '#28a745';
      zipBtn.style.color = 'white';
      zipBtn.style.border = 'none';
      zipBtn.style.padding = '10px 15px';
      zipBtn.style.borderRadius = '5px';
    zipBtn.style.cursor = 'pointer';
    zipBtn.style.marginBottom = '10px';
    zipBtn.title = 'HaftalÄ±k PDF, eÅŸleÅŸen tarif kartlarÄ± ve GPT mesajÄ±nÄ± tek ZIP dosyasÄ±nda indirir';
    zipBtn.onclick = function() { 
      console.log('ğŸ” ZIP butonuna tÄ±klandÄ±, hafta index:', i);
      zipEslesenGorseller(i); 
    };
    
    // PDF Takip Tablosu oluÅŸtur butonu
    const pdfBtn = document.createElement('button');
    pdfBtn.textContent = 'ğŸ“„ Takip Tablosu PDF';
    pdfBtn.style.background = '#dc3545';
    pdfBtn.style.color = 'white';
    pdfBtn.style.border = 'none';
    pdfBtn.style.padding = '10px 15px';
    pdfBtn.style.borderRadius = '5px';
    pdfBtn.style.cursor = 'pointer';
    pdfBtn.onclick = function() { generatePatientPDF(); };
    
    // ZIP + PDF Combo butonu
    const comboBtn = document.createElement('button');
    comboBtn.textContent = 'ğŸ¯ Kartlar + PDF Tablosu';
    comboBtn.style.background = '#6f42c1';
    comboBtn.style.color = 'white';
    comboBtn.style.border = 'none';
    comboBtn.style.padding = '10px 15px';
    comboBtn.style.borderRadius = '5px';
    comboBtn.style.cursor = 'pointer';
    comboBtn.onclick = function() { 
      zipEslesenGorseller(i); 
      setTimeout(() => generatePatientPDF(), 1000); 
    };
    
    // Sidebar butonlarÄ± artÄ±k GPT alanÄ±nda olduÄŸu iÃ§in kaldÄ±rÄ±ldÄ±
  }
  } // domElementMevcut kapanÄ±ÅŸÄ±

  // EÅŸleÅŸmeyen tarifleri yeni accordion sistemine ekle (sadece DOM varsa)
  if (domElementMevcut && eslesmeyenTarifler.length > 0) {
    const eslesmeyenlerContent = document.getElementById('eslesmeyenlerContent');
    const eslesmeyenlerBaslik = document.getElementById('eslesmeyenlerBaslik');
    
    if (eslesmeyenlerContent && eslesmeyenlerBaslik) {
      // BaÅŸlÄ±ÄŸÄ± gÃ¼ncelle
      eslesmeyenlerBaslik.textContent = `ğŸš« EÅŸleÅŸmeyen Tarifler (${eslesmeyenTarifler.length})`;
      
      // Ä°Ã§eriÄŸi temizle ve yeniden doldur
      eslesmeyenlerContent.innerHTML = '';
      
      eslesmeyenTarifler.forEach(tarif => {
        const p = document.createElement('p');
        p.textContent = tarif;
        p.style.color = '#dc3545';
        p.style.margin = '6px 0';
        p.style.padding = '4px 8px';
        p.style.background = '#fff5f5';
        p.style.borderLeft = '3px solid #dc3545';
        p.style.borderRadius = '4px';
        p.style.cursor = 'pointer';
        p.style.transition = 'background-color 0.2s';
        p.title = 'TÄ±kla ve manuel eÅŸleÅŸtirme yap';
        
        // Hover efekti
        p.onmouseenter = () => p.style.background = '#ffe6e6';
        p.onmouseleave = () => p.style.background = '#fff5f5';
        
        // TÄ±klama olayÄ± - Manuel eÅŸleÅŸtirme panelini aÃ§ ve tarif adÄ±nÄ± doldur
        p.onclick = () => {
          eslesmeyenTarifManuelEslestir(tarif);
        };
        
        eslesmeyenlerContent.appendChild(p);
      });
    }
  } else if (domElementMevcut) {
    // EÅŸleÅŸmeyen tarif yoksa baÅŸlÄ±ÄŸÄ± sÄ±fÄ±rla
    const eslesmeyenlerBaslik = document.getElementById('eslesmeyenlerBaslik');
    const eslesmeyenlerContent = document.getElementById('eslesmeyenlerContent');
    
    if (eslesmeyenlerBaslik) {
      eslesmeyenlerBaslik.textContent = 'ğŸš« EÅŸleÅŸmeyen Tarifler';
    }
    if (eslesmeyenlerContent) {
      eslesmeyenlerContent.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">EÅŸleÅŸmeyen tarif bulunamadÄ±</div>';
    }
  }

  // EÅŸleÅŸen kartlarÄ± hafta verisine JSON uyumlu formatta kaydet
  hafta.tarifKartlar = eslesenKartlarListesi.map(e => ({
    tarifAdi: e.tarif,
    kartResmi: e.kart.name,
    kartData: e.kart.data || `https://mustafasacar35.github.io/lipodem-takip-paneli-3/tarifler/${e.kart.name}`,
    eslesmeTuru: e.tip
  }));
  
  // EÅŸleÅŸmeyen tarifleri ayrÄ± array'de sakla (JSON'a da kaydedilsin)
  const eslesenTarifIsimleri = eslesenKartlarListesi.map(e => e.tarif.toLowerCase());
  hafta.eslesmeyenTarifler = eslesmeyenTarifler; // JSON'a kaydet
  
  // Orijinal tarifler listesini koruyalÄ±m ama eÅŸleÅŸen/eÅŸleÅŸmeyen diye ayÄ±ralÄ±m
  hafta.eslesenTarifler = hafta.tarifler ? hafta.tarifler.filter(tarif => 
    eslesenTarifIsimleri.includes(tarif.toLowerCase())
  ) : [];
  
  console.log('ğŸ“ EÅŸleÅŸtirme Ã¶ncesi toplam tarif:', hafta.tarifler ? hafta.tarifler.length : 0);
  console.log('ğŸ“ EÅŸleÅŸen tarif isimleri:', eslesenTarifIsimleri);
  console.log('ğŸ“ EÅŸleÅŸen tarif sayÄ±sÄ±:', hafta.eslesenTarifler.length);
  console.log('ğŸš« EÅŸleÅŸmeyen tarifler:', eslesmeyenTarifler.length, 'adet kaydedildi');
  
  // Otomatik kaydetme - hafta verileri deÄŸiÅŸti
  if (seciliHasta) {
    autoSaveHastaData(seciliHasta);
  } else {
    saveToStorage(); // Fallback
  }
  
  // EÅŸleÅŸtirme sonuÃ§larÄ±nÄ± dÃ¶ndÃ¼r (JSON'a sadece eÅŸleÅŸenler kaydedilecek)
  const sonuc = {
    eslesenKartlar: hafta.tarifKartlar,
    eslesmeyenTarifler: eslesmeyenTarifler // UI iÃ§in dÃ¶ndÃ¼r ama JSON'a kaydetme
  };
  
  console.log('âœ… otomatikEsleHafta tamamlandÄ±:', {
    haftaIndex: i,
    eslesenKartSayisi: hafta.tarifKartlar ? hafta.tarifKartlar.length : 0,
    eslesmeyenTarifSayisi: eslesmeyenTarifler.length
  });
  
  // EÅŸleÅŸtirme sonrasÄ± yemek analizini gÃ¼ncelle
  setTimeout(() => {
    updateYemekAnalizi();
    updateYemekVeritabaniAnalizi(); // Yeni: Food_list.json analizi
  }, 300); // Veriler tamamen gÃ¼ncellenmesi iÃ§in kÄ±sa bir gecikme
  
  return sonuc;
}

// ğŸ½ï¸ YEMEK VERÄ°TABANI ANALÄ°ZÄ° FONKSÄ°YONU
async function updateYemekVeritabaniAnalizi() {
  console.log('ğŸ½ï¸ Yemek veritabanÄ± analizi baÅŸlatÄ±lÄ±yor...');
  
  // HaftalÄ±k tekrarlanan yemekleri tespit etme fonksiyonu
  function tesbitEtHaftalikTekrarlar(eslesmeDurumu) {
    const yemekSayilari = new Map();
    const haftalikTekrarlar = new Map();
    
    // Sadece kurÅŸun geÃ§irmez kahve iÃ§in haftalÄ±k gruplama
    const haftalikGruplanacaklar = [
      'kurÅŸun geÃ§irmez kahve',
      'kurÅŸungeÃ§irmez kahve',
      'kurÅŸun geÃ§irmez',
      'kurÅŸungeÃ§irmez'
    ];
    
    // Her yemeÄŸi say
    eslesmeDurumu.forEach(item => {
      if (item.gunOgunSatiri || item.karalistede) return;
      
      const yemekAdi = item.tarifAdi.toLowerCase();
      const sayim = yemekSayilari.get(yemekAdi) || 0;
      yemekSayilari.set(yemekAdi, sayim + 1);
    });
    
    // Sadece kurÅŸun geÃ§irmez kahve ve 5+ tekrarlananlarÄ± haftalÄ±k grupla
    yemekSayilari.forEach((sayi, yemekAdi) => {
      if (sayi >= 5) {
        // Sadece kurÅŸun geÃ§irmez kahve iÃ§in haftalÄ±k gruplama
        const kurÅŸunKahveMi = haftalikGruplanacaklar.some(anahtar => 
          yemekAdi.includes(anahtar)
        );
        
        if (kurÅŸunKahveMi) {
          haftalikTekrarlar.set(yemekAdi, {
            gunlukSayi: sayi,
            haftalikToplam: sayi,
            anahtarKelimeVar: true,
            ornekItem: eslesmeDurumu.find(item => 
              item.tarifAdi.toLowerCase() === yemekAdi && 
              !item.gunOgunSatiri && 
              !item.karalistede
            )
          });
        }
      }
    });
    
    return haftalikTekrarlar;
  }
  
  const veritabaniAnaliziContent = document.getElementById('veritabaniAnaliziContent');
  if (!veritabaniAnaliziContent) {
    console.log('âš ï¸ VeritabanÄ± analizi container bulunamadÄ±');
    return;
  }

  // Erken koruma: hasta/hafta seÃ§ilmeden analiz Ã§aÄŸrÄ±lÄ±rsa sessizce Ã§Ä±k
  const haftaListesi = getHaftaListesi();
  if (!seciliHasta || !haftaListesi || haftaListesi.length === 0) {
    veritabaniAnaliziContent.innerHTML = `
      <div style="text-align: center; color: #666; padding: 20px;">
        HenÃ¼z hasta/hafta seÃ§ilmedi
      </div>
    `;
    return;
  }

  const seciliHaftaIndex = getAktifHaftaIndex();
  const hafta = haftaListesi[seciliHaftaIndex];
  
  if (!hafta || !hafta.tarifler || hafta.tarifler.length === 0) {
    veritabaniAnaliziContent.innerHTML = `
      <div style="text-align: center; color: #666; padding: 20px;">
        Bu hafta iÃ§in henÃ¼z tarif bulunamadÄ±
      </div>
    `;
    return;
  }

  // Food_list.json'u fetch et
  try {
    // GitHub raw URL'sini kullan (CORS sorunlarÄ± iÃ§in)
    // Yerel test iÃ§in: 'food_list.json' ve http://localhost:8000 kullanÄ±n
  // Cache-buster ekleyerek en gÃ¼ncel food_list.json'Ä± al (sayfa yenilemeden hemen sonra)
  const response = await fetch(`https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli-3/refs/heads/main/food_list.json?nocache=${Date.now()}&t=${Math.random()}`);
    if (!response.ok) {
      throw new Error('Food_list.json dosyasÄ± yÃ¼klenemedi');
    }
    
    const foodData = await response.json();
    console.log('ğŸ•µï¸ DEBUG: GitHub RAW food_list.json yÃ¼klendi!');
    console.log('ğŸ•µï¸ DEBUG: Ä°lk yemek Ã¶rneÄŸi (GitHub RAW):', foodData.categories?.[0]?.items?.[0]);
    
    // TÃ¼m yemek isimlerini Ã§Ä±kar - FULL DATA
    const allFoodNames = [];
    foodData.categories.forEach(category => {
      category.items.forEach(item => {
        allFoodNames.push({
          // Temel bilgiler
          name: item.name.toLowerCase(),
          originalName: item.name,
          category: item.category || category.name,
          
          // Besin deÄŸerleri
          calories: item.calories || 0,
          protein: item.protein || 0,
          carbs: item.carbs || 0,
          fat: item.fat || 0,
          
          // TÃ¼m diÄŸer alanlarÄ± da ekle
          maxQuantity: item.maxQuantity || 1,
          minQuantity: item.minQuantity || 0.5,
          step: item.step || 0.5,
          tags: item.tags || [],
          role: item.role || 'mainDish',
          mealType: item.mealType || [],
          keto: item.keto || false,
          lowcarb: item.lowcarb || false,
          fillerLunch: item.fillerLunch || false,
          fillerDinner: item.fillerDinner || false,
          portionFixed: item.portionFixed || false,
          multiplier: item.multiplier || 1,
          seasonRange: item.seasonRange || '[1,12]',
          isReversedSeason: item.isReversedSeason || false,
          compatibilityTags: item.compatibilityTags || []
        });
      });
    });
    
    // Global flat listeyi hazÄ±rla (eÅŸleÅŸtirme sekmesi iÃ§in)
    try {
      if (typeof flattenFoodDataToGlobal === 'function') {
        flattenFoodDataToGlobal(foodData);
        console.log('âœ… Global yemek listesi hazÄ±rlandÄ± (flat):', window.globalFoodListFlat?.length || 0);
      }
    } catch (e) {
      console.warn('âš ï¸ Global flat liste hazÄ±rlanamadÄ±:', e);
    }

    // PDF'deki yemekleri analiz et - HAFTA KAYNAKLARI Ä°LE UYUMLU (eÅŸleÅŸen/esleÅŸmeyen + baÅŸlÄ±klar)
    const eslesmeDurumu = [];

    // YardÄ±mcÄ±: TÃ¼rkÃ§e karakter ve sembol normalize
    const normalizeTr = (str) => (str || '')
      .toString()
      .toLowerCase()
      .replace(/Ã§/g, 'c').replace(/ÄŸ/g, 'g').replace(/ÅŸ/g, 's')
      .replace(/Ã¼/g, 'u').replace(/Ã¶/g, 'o').replace(/Ä±/g, 'i').replace(/iÌ‡/g, 'i')
      .replace(/[_*\/()]/g, ' ')
      .replace(/\s+/g, ' ')
      .replace(/[^a-z0-9\s]/g, '')
      .trim();

    // HÄ±zlÄ± eriÅŸim iÃ§in map/set hazÄ±rla
    const matchedTarifSet = new Set((hafta.eslesenTarifler || [])
      .map(t => t && t.toLowerCase()));

    // tarif -> kart mapping
    const tarifToKartMap = new Map();
    (hafta.tarifKartlar || []).forEach(k => {
      if (k && k.tarifAdi) {
        const key = k.tarifAdi.toLowerCase();
        if (!tarifToKartMap.has(key)) {
          tarifToKartMap.set(key, k);
        }
      }
    });

    // Food list aramasÄ± iÃ§in yardÄ±mcÄ±lar
    const findFoodMatch = (textCandidates = []) => {
      for (const cand of textCandidates) {
        const n = normalizeTr(cand);
        if (!n) continue;
        // 1) Tam eÅŸleÅŸme (normalize)
        const exact = allFoodNames.find(f => normalizeTr(f.originalName) === n || normalizeTr(f.name) === n);
        if (exact) return exact;
        // 2) Ä°Ã§eren eÅŸleÅŸme (daha serbest)
        const incl = allFoodNames.find(f => {
          const fn = normalizeTr(f.originalName);
          return fn.includes(n) || n.includes(fn);
        });
        if (incl) return incl;
      }
      return null;
    };

    // Daha gÃ¼venli: sadece TAM eÅŸleÅŸme yapan arama (kart eÅŸleÅŸmesi yoksa kullanÄ±lacak)
    const findFoodExactMatch = (text) => {
      const n = normalizeTr(text);
      if (!n) return null;
      return allFoodNames.find(f => normalizeTr(f.originalName) === n || normalizeTr(f.name) === n) || null;
    };

    // Birim/miktar kelimelerini ve sayÄ±larÄ± filtreleyip token bazlÄ± benzerlik skoru hesapla
    const unitStop = new Set([
      'adet','gr','gram','kg','yemek','kasigi','yk','tatli','cay','tk','ck',
      'yaprak','dal','orta','boy','kucuk','buyuk','olcek','fincan','bardak',
      'dilim','avuc','paket','tatli_kasigi','yemek_kasigi','cay_kasigi','yuzde',
      'yarim','ceyrek'
    ]);
    const stopFillers = new Set(['ve','veya','ile','artÄ±','arti','plus','ya','vs','vb']);
    const tokenize = (text) => normalizeTr(text)
      .replace(/\d+/g, ' ') // sayÄ±larÄ± kaldÄ±r
      .replace(/\b(ml|lt|cc|mg|mcg)\b/g, ' ')
      .split(/\s+/)
      .filter(t => t && t.length > 2 && !unitStop.has(t) && !stopFillers.has(t));

    const bestFoodFuzzyMatch = (rawText) => {
      if (!rawText) return null;
      // ParÃ§alarÄ± Ã¼ret
      const parts = String(rawText)
        .split(/\+|\,|\/|\(|\)|\-|\bile\b|\bve\b|\bveya\b/gi)
        .map(p => p.trim())
        .filter(Boolean);
      let best = null;
      let bestScore = 0;
      const consider = (segment) => {
        const segTokens = tokenize(segment);
        if (!segTokens.length) return;
        for (const f of allFoodNames) {
          const fTokens = tokenize(f.originalName || f.name);
          if (!fTokens.length) continue;
          // KesiÅŸim skoru
          const setB = new Set(fTokens);
          let overlap = 0;
          let longHit = false;
          for (const t of segTokens) {
            if (setB.has(t)) {
              overlap++;
              if (t.length >= 4) longHit = true;
            }
          }
          // Kabul kriteri: en az 2 kelime eÅŸleÅŸmesi veya tek ama uzun kelime eÅŸleÅŸmesi
          const score = overlap + (longHit ? 0.5 : 0);
          if (overlap >= 2 || (overlap >= 1 && longHit)) {
            if (score > bestScore) { best = f; bestScore = score; }
          }
        }
      };
      if (!parts.length) parts.push(rawText);
      parts.forEach(consider);
      return best;
    };

  hafta.tarifler.forEach((tarif, index) => {
      const tarifLower = (tarif || '').toLowerCase();
      const tarifTemiz = tarifLower.trim();

      // GÃ¼n ve Ã¶ÄŸÃ¼n isimlerini tespit et (yemek deÄŸil)
      const gunOgunFiltreleri = [
        'pazartesi', 'sali', 'Ã§arÅŸamba', 'perÅŸembe', 'cuma', 'cumartesi', 'pazar',
        'sabah', 'Ã¶ÄŸle', 'akÅŸam', 'kahvaltÄ±', 'Ã¶ÄŸlen', 'akÅŸam yemeÄŸi',
        'saat 07:00', 'saat 12:00', 'hava kararÄ±nca', 'civarÄ±nda'
      ];
      const gunOgunMu = gunOgunFiltreleri.some(filtre =>
        tarifTemiz.includes(filtre) || tarifTemiz === filtre
      );

    if (gunOgunMu) {
        eslesmeDurumu.push({
          tarifAdi: tarif,
      eslestiMi: false, // veritabanÄ± eÅŸleÅŸmesi yok
      kartEslestiMi: false, // baÅŸlÄ±k satÄ±rÄ±
          eslesenYemek: null,
          siraNo: index + 1,
          gunOgunSatiri: true
        });
        return; // baÅŸlÄ±k satÄ±rÄ±
      }

      // Karaliste kontrolÃ¼ (normalleÅŸtirilmiÅŸ)
      if (isBlacklisted(tarif)) {
        eslesmeDurumu.push({
          tarifAdi: tarif,
          eslestiMi: false,
          kartEslestiMi: false,
          eslesenYemek: null,
          siraNo: index + 1,
          gunOgunSatiri: false,
          karalistede: true
        });
        return;
      }

      // Bu satÄ±r, otomatik/manuel eÅŸleÅŸen tarifler arasÄ±nda mÄ±?
  const kartEslestiMi = matchedTarifSet.has(tarifLower);

      let eslesenYemek = null;
      if (kartEslestiMi) {
        // Ã–ncelik: kart adÄ±ndan food_list eÅŸleÅŸmesi (daha gÃ¼venilir)
        const kart = tarifToKartMap.get(tarifLower);
        if (kart && (kart.kartResmi || kart.name)) {
          const kartBase = (kart.kartResmi || kart.name)
            .replace(/\.(jpg|jpeg|png)$/i, '')
            .replace(/_/g, ' ');
          eslesenYemek = findFoodMatch([kartBase, tarif]);
        } else {
          // Fallback: tarif satÄ±rÄ±ndan arama
          eslesenYemek = findFoodMatch([tarif]);
        }
      } else {
        // Kart eÅŸleÅŸmesi yoksa: Ã¶nce TAM eÅŸleÅŸme, olmazsa bulanÄ±k (token tabanlÄ±) eÅŸleÅŸme dene
        eslesenYemek = findFoodExactMatch(tarif) || bestFoodFuzzyMatch(tarif);
      }

      eslesmeDurumu.push({
        tarifAdi: tarif,
        eslestiMi: !!eslesenYemek, // veritabanÄ± (food_list) eÅŸleÅŸmesi varsa makrolar gÃ¶sterilir
        kartEslestiMi: !!kartEslestiMi, // kart (gÃ¶rsel) eÅŸleÅŸmesi varsa ikon yeÅŸil
        eslesenYemek: eslesenYemek,
        siraNo: index + 1,
        gunOgunSatiri: false
      });
    });
    
  // SonuÃ§larÄ± gÃ¶rÃ¼ntÃ¼le
  const normalSatirlar = eslesmeDurumu.filter(item => !item.gunOgunSatiri && !item.karalistede);
  // Bir satÄ±r yeÅŸil tik ise ya kart ya da veritabanÄ± eÅŸleÅŸmesi vardÄ±r
  const eslesenSayisi = normalSatirlar.filter(item => item.kartEslestiMi || item.eslestiMi).length;
  const eslesmeyenSayisi = normalSatirlar.length - eslesenSayisi;
    
    // Global deÄŸiÅŸkende sakla (buton tÄ±klamalarÄ± iÃ§in)
    window.currentFoodAnalysisData = eslesmeDurumu;
    
    // HaftalÄ±k tekrarlanan yemekleri tespit et ve grupla
    const haftalikTekrarlananlari = tesbitEtHaftalikTekrarlar(eslesmeDurumu);
    
    // BaÅŸlÄ±ÄŸÄ± gÃ¼ncelle
    const veritabaniAnaliziBaslik = document.getElementById('veritabaniAnaliziBaslik');
    if (veritabaniAnaliziBaslik) {
      veritabaniAnaliziBaslik.textContent = `ğŸ½ï¸ Yemek VeritabanÄ± Analizi (${eslesenSayisi}/${normalSatirlar.length})`;
    }
    
    // Ä°Ã§eriÄŸi oluÅŸtur - Makro deÄŸerleri ile tablo formatÄ±
    
    // Ä°Ã§eriÄŸi oluÅŸtur - Makro deÄŸerleri ile tablo formatÄ±
    let htmlContent = `
      <div style="margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
          <strong>ğŸ“Š Ã–zet:</strong>
          <div>
            <span style="color: #28a745; font-weight: bold;">âœ“ ${eslesenSayisi}</span> / 
            <span style="color: #dc3545; font-weight: bold;">âœ— ${eslesmeyenSayisi}</span> / 
            <span style="font-weight: bold;">Toplam ${normalSatirlar.length} yemek</span>
          </div>
        </div>
        <div style="font-size: 12px; color: #666;">
          Toplam ${normalSatirlar.length} yemek analiz edildi
        </div>
      </div>
      
      <!-- Makro DeÄŸerleri Tablosu -->
      <div style="overflow-x: auto; margin-bottom: 15px;">
        <table style="width: 100%; border-collapse: collapse; font-size: 11px; background: white; border-radius: 5px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
          ${(() => {
            // Hasta ismi ve tarih bilgisini bul (genellikle ilk satÄ±rda)
            let hastaBaslikSatiri = '';
            if (normalSatirlar.length > 0) {
              const ilkSatir = normalSatirlar[0];
              // EÄŸer ilk satÄ±r yemek deÄŸilse (âŒ ile baÅŸlayÄ±p - - - - deÄŸerleri varsa), hasta bilgisi olabilir
              if (!ilkSatir.eslestiMi && ilkSatir.tarifAdi && 
                  !ilkSatir.tarifAdi.includes('ğŸ½ï¸') && 
                  !ilkSatir.tarifAdi.includes('ğŸ“…')) {
                
                // Hasta ismi ve tarih iÃ§eren satÄ±rÄ± beyaz arkaplan ile gÃ¶ster
                const hastaBilgisi = ilkSatir.tarifAdi;
                
                // Ä°sim ve tarihi ayÄ±r (/ iÅŸareti varsa)
                const parts = hastaBilgisi.split('/');
                let isimKismi = hastaBilgisi.trim().toUpperCase(); // TÃ¼m metni bÃ¼yÃ¼k harfe Ã§evir
                let tarihKismi = '';
                
                if (parts.length >= 2) {
                  isimKismi = parts[0].trim().toUpperCase();
                  tarihKismi = parts.slice(1).join('/').trim().toUpperCase();
                }
                
                hastaBaslikSatiri = `
                  <thead>
                    <tr style="background: white; border: 2px solid #007bff;">
                      <td colspan="6" style="padding: 15px 20px; border: 1px solid #ddd; font-size: 14px; font-weight: bold;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                          <span style="color: #007bff; font-size: 16px;">ğŸ“‹ ${isimKismi}</span>
                          <span style="color: #666; font-size: 14px;">${tarihKismi}</span>
                        </div>
                      </td>
                    </tr>
                  </thead>
                `;
              }
            }
            return hastaBaslikSatiri;
          })()}
          <thead>
            <tr style="background: linear-gradient(135deg, #007bff, #0056b3); color: white;">
              <th style="padding: 6px 8px; text-align: left; border: 1px solid #ddd; font-size: 12px;">Yemek AdÄ±</th>
              <th style="padding: 6px; text-align: center; border: 1px solid #ddd; width: 70px; font-size: 11px;">Kalori</th>
              <th style="padding: 6px; text-align: center; border: 1px solid #ddd; width: 70px; font-size: 11px;">Karb</th>
              <th style="padding: 6px; text-align: center; border: 1px solid #ddd; width: 70px; font-size: 11px;">Protein</th>
              <th style="padding: 6px; text-align: center; border: 1px solid #ddd; width: 70px; font-size: 11px;">YaÄŸ</th>
              <th style="padding: 6px; text-align: center; border: 1px solid #ddd; width: 90px; font-size: 11px;">Ä°ÅŸlemler</th>
            </tr>
          </thead>
          <tbody>
    `;
    
    let toplamKalori = 0;
    let toplamProtein = 0;
    let toplamKarb = 0;
    let toplamYag = 0;
    
    // GÃ¼n/Ã¶ÄŸÃ¼n makro toplamlarÄ±nÄ± hesaplamak iÃ§in yardÄ±mcÄ± deÄŸiÅŸkenler
    let gunOgunMakroToplam = new Map(); // key: gÃ¼n/Ã¶ÄŸÃ¼n adÄ±, value: {kalori, protein, karb, yag}
    let currentGun = '';
    let currentOgun = '';
    
    // Ä°lk geÃ§iÅŸ: gÃ¼n/Ã¶ÄŸÃ¼n makro toplamlarÄ±nÄ± hesapla
    eslesmeDurumu.forEach((item, index) => {
      if (item.karalistede) return;
      
      if (item.gunOgunSatiri) {
        const gunlerList = ['pazartesi', 'sali', 'Ã§arÅŸamba', 'perÅŸembe', 'cuma', 'cumartesi', 'pazar'];
        const isGun = gunlerList.some(gun => item.tarifAdi.toLowerCase().includes(gun));
        
        if (isGun) {
          currentGun = item.tarifAdi.toUpperCase();
          currentOgun = '';
          if (!gunOgunMakroToplam.has(currentGun)) {
            gunOgunMakroToplam.set(currentGun, {kalori: 0, protein: 0, karb: 0, yag: 0});
          }
        } else {
          currentOgun = item.tarifAdi;
          const ogunKey = `${currentGun}_${currentOgun}`;
          if (!gunOgunMakroToplam.has(ogunKey)) {
            gunOgunMakroToplam.set(ogunKey, {kalori: 0, protein: 0, karb: 0, yag: 0});
          }
        }
      } else if (item.eslestiMi && item.eslesenYemek) {
        // Normal yemek satÄ±rÄ± - mevcut gÃ¼n/Ã¶ÄŸÃ¼ne ekle
        const kalori = item.eslesenYemek.calories || 0;
        const protein = item.eslesenYemek.protein || 0;
        const karb = item.eslesenYemek.carbs || 0;
        const yag = item.eslesenYemek.fat || 0;
        
        if (currentGun) {
          const gunToplam = gunOgunMakroToplam.get(currentGun);
          gunToplam.kalori += kalori;
          gunToplam.protein += protein;
          gunToplam.karb += karb;
          gunToplam.yag += yag;
        }
        
        if (currentOgun) {
          const ogunKey = `${currentGun}_${currentOgun}`;
          const ogunToplam = gunOgunMakroToplam.get(ogunKey);
          if (ogunToplam) {
            ogunToplam.kalori += kalori;
            ogunToplam.protein += protein;
            ogunToplam.karb += karb;
            ogunToplam.yag += yag;
          }
        }
      }
    });
    
    // Ä°kinci geÃ§iÅŸ: tabloyu oluÅŸtur
    currentGun = '';
    currentOgun = '';
    const processedWeeklyItems = new Set(); // HaftalÄ±k grupladÄ±ÄŸÄ±mÄ±z Ã¶ÄŸeleri takip et
    
    eslesmeDurumu.forEach((item, index) => {
      // Karalistede olan satÄ±rlarÄ± tabloda hiÃ§ gÃ¶stermeyelim
      if (item.karalistede) return;
      
      // Ä°lk satÄ±r hasta bilgisi ise ve yukarÄ±da baÅŸlÄ±k olarak gÃ¶sterildiyse atla
      if (index === 0 && !item.eslestiMi && item.tarifAdi && 
          !item.tarifAdi.includes('ğŸ½ï¸') && 
          !item.tarifAdi.includes('ğŸ“…')) {
        return; // Bu satÄ±rÄ± tabloda gÃ¶sterme, zaten baÅŸlÄ±kta var
      }
      
      // HaftalÄ±k tekrarlanan yemek kontrol et
      const yemekAdiLower = item.tarifAdi.toLowerCase();
      const haftalikBilgi = haftalikTekrarlananlari.get(yemekAdiLower);
      
      // EÄŸer bu yemek haftalÄ±k gruplanacaksa ve daha Ã¶nce iÅŸlenmemiÅŸse
      if (haftalikBilgi && !processedWeeklyItems.has(yemekAdiLower)) {
        processedWeeklyItems.add(yemekAdiLower);
        
        // HaftalÄ±k gruplama - "x7 gÃ¼n" formatÄ±nda gÃ¶ster
        const ornekItem = haftalikBilgi.ornekItem;
        const gunlukSayi = haftalikBilgi.gunlukSayi;
        
        let kalori = 0, protein = 0, karb = 0, yag = 0;
        
        if (ornekItem.eslestiMi && ornekItem.eslesenYemek) {
          // HaftalÄ±k toplam makrolar (gÃ¼nlÃ¼k x haftalÄ±k sayi)
          kalori = (ornekItem.eslesenYemek.calories || 0) * gunlukSayi;
          protein = (ornekItem.eslesenYemek.protein || 0) * gunlukSayi;
          karb = (ornekItem.eslesenYemek.carbs || 0) * gunlukSayi;
          yag = (ornekItem.eslesenYemek.fat || 0) * gunlukSayi;
          
          // Toplam makrolara ekle
          toplamKalori += kalori;
          toplamProtein += protein;
          toplamKarb += karb;
          toplamYag += yag;
        }
        
        // Ä°kon ve renk
        const ikon = ornekItem.kartEslestiMi ? 'âœ…' : (ornekItem.eslestiMi ? 'âœ…' : 'âŒ');
        const renk = (ornekItem.kartEslestiMi || ornekItem.eslestiMi) ? '#28a745' : '#dc3545';
        
        // HaftalÄ±k gruplama satÄ±rÄ±
        htmlContent += `
          <tr style="cursor: pointer; transition: background 0.2s; background: #fff8dc;" 
              onmouseover="this.style.background='#fff5cd'" onmouseout="this.style.background='#fff8dc'"
              title="HaftalÄ±k Gruplama: ${gunlukSayi} kez tekrarlandÄ±">
            <td style="padding: 4px 6px; border: 1px solid #ddd; text-align: left;">
              <span style="color: ${renk}; margin-right: 6px; font-size: 14px;">${ikon}</span>
              <span style="font-weight: bold; color: #8b5a2b;">
                ğŸ”„ ${ornekItem.tarifAdi} (x${gunlukSayi} gÃ¼n)
              </span>
            </td>
            <td style="padding: 4px; text-align: center; border: 1px solid #ddd; font-weight: bold; color: #8b5a2b;">
              ${ornekItem.eslestiMi ? kalori.toFixed(0) : '-'}
            </td>
            <td style="padding: 4px; text-align: center; border: 1px solid #ddd; font-weight: bold; color: #8b5a2b;">
              ${ornekItem.eslestiMi ? karb.toFixed(1) : '-'}
            </td>
            <td style="padding: 4px; text-align: center; border: 1px solid #ddd; font-weight: bold; color: #8b5a2b;">
              ${ornekItem.eslestiMi ? protein.toFixed(1) : '-'}
            </td>
            <td style="padding: 4px; text-align: center; border: 1px solid #ddd; font-weight: bold; color: #8b5a2b;">
              ${ornekItem.eslestiMi ? yag.toFixed(1) : '-'}
            </td>
            <td style="padding: 4px; text-align: center; border: 1px solid #ddd; color: #8b5a2b;">
              ğŸ“Š HaftalÄ±k
            </td>
          </tr>
        `;
        
        return; // Bu yemeÄŸi tekil olarak gÃ¶sterme
      }
      
      // EÄŸer bu yemek haftalÄ±k gruplanmÄ±ÅŸsa ve daha Ã¶nce iÅŸlendiyse atla
      if (haftalikBilgi && processedWeeklyItems.has(yemekAdiLower)) {
        return;
      }
      
      // Ä°kon ve renk: Kart veya veritabanÄ± eÅŸleÅŸmesi varsa yeÅŸil gÃ¶ster
      const ikon = item.kartEslestiMi ? 'âœ…' : (item.eslestiMi ? 'âœ…' : 'âŒ');
      const renk = (item.kartEslestiMi || item.eslestiMi) ? '#28a745' : '#dc3545';
      
      let kalori = 0, protein = 0, karb = 0, yag = 0;
      
      if (item.eslestiMi && item.eslesenYemek) {
        kalori = item.eslesenYemek.calories || 0;
        protein = item.eslesenYemek.protein || 0;
        karb = item.eslesenYemek.carbs || 0;
        yag = item.eslesenYemek.fat || 0;
        
        toplamKalori += kalori;
        toplamProtein += protein;
        toplamKarb += karb;
        toplamYag += yag;
      }
      
      // GÃ¼n/Ã¶ÄŸÃ¼n satÄ±rlarÄ± iÃ§in Ã¶zel stil
      if (item.gunOgunSatiri) {
        // GÃ¼nler iÃ§in Ã¶zel stil (BÃœYÃœK HARF)
        const gunlerList = ['pazartesi', 'sali', 'Ã§arÅŸamba', 'perÅŸembe', 'cuma', 'cumartesi', 'pazar'];
        const isGun = gunlerList.some(gun => item.tarifAdi.toLowerCase().includes(gun));
        
        if (isGun) {
          currentGun = item.tarifAdi.toUpperCase();
          currentOgun = '';
          const gunToplam = gunOgunMakroToplam.get(currentGun) || {kalori: 0, protein: 0, karb: 0, yag: 0};
          
          // GÃœN satÄ±rÄ± - Sol hizalÄ±, saÄŸda gÃ¼nlÃ¼k makro toplamlarÄ±
          htmlContent += `
            <tr style="background: linear-gradient(135deg, #007bff, #0056b3); color: white; cursor: default;" 
                title="GÃ¼n baÅŸlÄ±ÄŸÄ± - GÃ¼nlÃ¼k Toplam: ${gunToplam.kalori.toFixed(0)} kcal">
              <td style="padding: 8px; border: 1px solid #ddd; text-align: left; font-weight: bold; font-size: 14px; text-transform: uppercase; letter-spacing: 1px;">
                ğŸ“… ${currentGun}
              </td>
              <td style="padding: 8px; border: 1px solid #ddd; text-align: center; font-weight: bold; font-size: 12px;">
                ${gunToplam.kalori > 0 ? gunToplam.kalori.toFixed(0) : '-'}
              </td>
              <td style="padding: 8px; border: 1px solid #ddd; text-align: center; font-weight: bold; font-size: 12px;">
                ${gunToplam.karb > 0 ? gunToplam.karb.toFixed(1) : '-'}
              </td>
              <td style="padding: 8px; border: 1px solid #ddd; text-align: center; font-weight: bold; font-size: 12px;">
                ${gunToplam.protein > 0 ? gunToplam.protein.toFixed(1) : '-'}
              </td>
              <td style="padding: 8px; border: 1px solid #ddd; text-align: center; font-weight: bold; font-size: 12px;">
                ${gunToplam.yag > 0 ? gunToplam.yag.toFixed(1) : '-'}
              </td>
              <td style="padding: 8px; border: 1px solid #ddd; text-align: center; font-size: 10px; color: rgba(255,255,255,0.7);">ğŸ“Š</td>
            </tr>
          `;
        } else {
          currentOgun = item.tarifAdi;
          const ogunKey = `${currentGun}_${currentOgun}`;
          const ogunToplam = gunOgunMakroToplam.get(ogunKey) || {kalori: 0, protein: 0, karb: 0, yag: 0};
          
          // Sabah rutini kontrolÃ¼ - bu tÃ¼r Ã¶ÄŸÃ¼nlerde kaydet butonu gÃ¶sterme
          const isSabahRutini = item.tarifAdi.toLowerCase().includes('her sabah') || 
                                item.tarifAdi.toLowerCase().includes('gÃ¼ne baÅŸlarken') ||
                                item.tarifAdi.toLowerCase().includes('gune baslarken');
          
          // Ã–ÄÃœN satÄ±rÄ± - Sol hizalÄ±, saÄŸda Ã¶ÄŸÃ¼n makro toplamlarÄ±
          const ogunAdi = item.tarifAdi.charAt(0).toUpperCase() + item.tarifAdi.slice(1).toLowerCase();
          htmlContent += `
            <tr style="background: linear-gradient(135deg, #28a745, #20c997); color: white; cursor: default;" 
                title="Ã–ÄŸÃ¼n baÅŸlÄ±ÄŸÄ± - Ã–ÄŸÃ¼n Toplam: ${ogunToplam.kalori.toFixed(0)} kcal">
              <td style="padding: 6px; border: 1px solid #ddd; text-align: left; font-weight: bold; font-size: 12px;">
                ğŸ½ï¸ ${ogunAdi}
              </td>
              <td style="padding: 6px; border: 1px solid #ddd; text-align: center; font-weight: bold; font-size: 11px;">
                ${ogunToplam.kalori > 0 ? ogunToplam.kalori.toFixed(0) : '-'}
              </td>
              <td style="padding: 6px; border: 1px solid #ddd; text-align: center; font-weight: bold; font-size: 11px;">
                ${ogunToplam.karb > 0 ? ogunToplam.karb.toFixed(1) : '-'}
              </td>
              <td style="padding: 6px; border: 1px solid #ddd; text-align: center; font-weight: bold; font-size: 11px;">
                ${ogunToplam.protein > 0 ? ogunToplam.protein.toFixed(1) : '-'}
              </td>
              <td style="padding: 6px; border: 1px solid #ddd; text-align: center; font-weight: bold; font-size: 11px;">
                ${ogunToplam.yag > 0 ? ogunToplam.yag.toFixed(1) : '-'}
              </td>
              <td style="padding: 6px; border: 1px solid #ddd; text-align: center; font-size: 9px; color: rgba(255,255,255,0.7);">
                ${!isSabahRutini ? `
                  <button onclick="kaydetOgunSablonu('${currentGun}', '${currentOgun}')" 
                          style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px; cursor: pointer;" 
                          title="Bu Ã¶ÄŸÃ¼nÃ¼ ÅŸablon olarak kaydet">
                    ğŸ’¾ Kaydet
                  </button>
                  <button onclick="alternatifleriGosterOgun('${currentGun}', '${currentOgun}')" 
                          style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px; cursor: pointer; margin-left: 4px;" 
                          title="Alternatif Ã¶ÄŸÃ¼nleri gÃ¶ster">
                    ğŸ”„ Alt
                  </button>
                ` : `
                  <span style="color: rgba(255,255,255,0.5); font-size: 9px;">Rutin</span>
                `}
              </td>
            </tr>
          `;
        }
        return; // GÃ¼n/Ã¶ÄŸÃ¼n satÄ±rlarÄ± iÃ§in erken dÃ¶n
      }
      
      // ButonlarÄ± ayarla - Index kullan (sadece normal yemek satÄ±rlarÄ± iÃ§in)
  // âœ‚ï¸ BÃ¶lme butonu: sadece normal yemek satÄ±rlarÄ±nda gÃ¶rÃ¼nsÃ¼n
  const splitBtn = `<button onclick="event.stopPropagation(); openSplitModal(${index})" 
         style="background: #6f42c1; color: white; border: none; padding: 2px 4px; border-radius: 3px; font-size: 9px; margin-right: 2px; cursor: pointer;"
         title="SatÄ±rÄ± BÃ¶l">âœ‚ï¸</button>`;

  const karalisteBtn = `<button onclick="event.stopPropagation(); toggleBlacklistForRow(${index})" 
    style="background: #343a40; color: white; border: none; padding: 2px 4px; border-radius: 3px; font-size: 9px; margin-right: 2px; cursor: pointer;"
    title="Karalisteye al/Ã§Ä±kar">ğŸš«</button>`;

  const butonlar = item.eslestiMi ? 
        `<button onclick="event.stopPropagation(); showFoodDetailByIndex(${index})" 
                 style="background: #ffc107; color: #212529; border: none; padding: 2px 4px; border-radius: 3px; font-size: 9px; margin-right: 2px; cursor: pointer;"
                 title="DÃ¼zenle">âœï¸</button>
         <button onclick="event.stopPropagation(); yemekSilByIndex(${index})" 
         style="background: #dc3545; color: white; border: none; padding: 2px 4px; border-radius: 3px; font-size: 9px; margin-right: 2px; cursor: pointer;"
         title="Sil">ğŸ—‘ï¸</button>
         <button onclick="event.stopPropagation(); alternatifYemekAc(${index})" 
         style="background: #17a2b8; color: white; border: none; padding: 2px 4px; border-radius: 3px; font-size: 9px; margin-right: 2px; cursor: pointer;"
         title="Alternatif Yemekler">ğŸ”„</button>${karalisteBtn}${splitBtn}` :
        `<button onclick="event.stopPropagation(); showFoodDetailByIndex(${index})" 
                 style="background: #28a745; color: white; border: none; padding: 2px 4px; border-radius: 3px; font-size: 9px; margin-right: 2px; cursor: pointer;"
                 title="Ekle">â•</button>
         <button onclick="event.stopPropagation(); eslestirmeModeAc(${index})" 
         style="background: #20c997; color: white; border: none; padding: 2px 4px; border-radius: 3px; font-size: 9px; margin-right: 2px; cursor: pointer;"
         title="EÅŸleÅŸtir">ğŸ”—</button>${karalisteBtn}${splitBtn}`;
      
      htmlContent += `
        <tr data-sira-no="${item.siraNo || index + 1}" onclick="showFoodDetailByIndex(${index})" style="cursor: pointer; transition: background 0.2s;" 
            onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='white'">
          <td style="padding: 4px 6px; border: 1px solid #ddd; text-align: left;">
            <span style="color: ${renk}; margin-right: 6px; font-size: 14px;">${ikon}</span>
            <span style="font-weight: ${item.eslestiMi ? 'normal' : 'bold'}; color: ${item.eslestiMi ? '#333' : '#dc3545'};">
              ${item.tarifAdi}
            </span>
          </td>
          <td style="padding: 4px; text-align: center; border: 1px solid #ddd; font-weight: bold;">
            ${item.eslestiMi ? kalori : '-'}
          </td>
          <td style="padding: 4px; text-align: center; border: 1px solid #ddd; font-weight: bold;">
            ${item.eslestiMi ? karb.toFixed(1) : '-'}
          </td>
          <td style="padding: 4px; text-align: center; border: 1px solid #ddd; font-weight: bold;">
            ${item.eslestiMi ? protein.toFixed(1) : '-'}
          </td>
          <td style="padding: 4px; text-align: center; border: 1px solid #ddd; font-weight: bold;">
            ${item.eslestiMi ? yag.toFixed(1) : '-'}
          </td>
          <td style="padding: 4px; text-align: center; border: 1px solid #ddd;">
            ${butonlar}
          </td>
        </tr>
      `;
    });
    
    // GÃ¼nlÃ¼k ortalama makrolar hesapla (haftalÄ±k toplam Ã· gÃ¼n sayÄ±sÄ±)
    // Renderdaki gÃ¼n sayÄ±sÄ±nÄ± say
    const gunSayisi = Array.from(gunOgunMakroToplam.keys()).filter(key => !key.includes('_')).length;
    const gunlukOrtalamaKalori = gunSayisi > 0 ? toplamKalori / gunSayisi : 0;
    const gunlukOrtalamaProtein = gunSayisi > 0 ? toplamProtein / gunSayisi : 0;
    const gunlukOrtalamaKarb = gunSayisi > 0 ? toplamKarb / gunSayisi : 0;
    const gunlukOrtalamaYag = gunSayisi > 0 ? toplamYag / gunSayisi : 0;
    
    htmlContent += `
          <tr style="background: linear-gradient(135deg, #28a745, #20c997); color: white; font-weight: bold;">
            <td style="padding: 6px; border: 1px solid #ddd; text-align: left; font-size: 12px;">
              ğŸ“Š GÃœNLÃœK ORTALAMA (${gunSayisi} gÃ¼n)
            </td>
            <td style="padding: 6px; text-align: center; border: 1px solid #ddd; font-size: 12px;">
              ${gunlukOrtalamaKalori.toFixed(0)}
            </td>
            <td style="padding: 6px; text-align: center; border: 1px solid #ddd; font-size: 12px;">
              ${gunlukOrtalamaKarb.toFixed(1)}
            </td>
            <td style="padding: 6px; text-align: center; border: 1px solid #ddd; font-size: 12px;">
              ${gunlukOrtalamaProtein.toFixed(1)}
            </td>
            <td style="padding: 6px; text-align: center; border: 1px solid #ddd; font-size: 12px;">
              ${gunlukOrtalamaYag.toFixed(1)}
            </td>
            <td style="padding: 6px; border: 1px solid #ddd;"></td>
          </tr>
        </tbody>
      </table>
    </div>`;
    veritabaniAnaliziContent.innerHTML = htmlContent;
    
    console.log('âœ… Yemek veritabanÄ± analizi tamamlandÄ±:', {
      toplam: eslesmeDurumu.length,
      eslesen: eslesenSayisi,
      eslemeyen: eslesmeyenSayisi
    });
    
  } catch (error) {
    console.error('âŒ Food_list.json yÃ¼klenirken hata:', error);
    veritabaniAnaliziContent.innerHTML = `
      <div style="text-align: center; color: #dc3545; padding: 20px;">
        <div style="font-weight: bold;">âŒ Hata</div>
        <div style="font-size: 12px; margin-top: 5px;">
          Yemek veritabanÄ± yÃ¼klenemedi: ${error.message}
        </div>
      </div>
    `;
  }
}

// Yemek detaylarÄ±nÄ± gÃ¶ster
function showFoodDetail(tarifAdi, eslestiMi, eslesenYemek) {
  console.log('ğŸ” Yemek detayÄ± gÃ¶steriliyor:', tarifAdi, eslestiMi, eslesenYemek);
  console.log('ğŸ” eslesenYemek tipi:', typeof eslesenYemek);
  console.log('ğŸ” eslesenYemek iÃ§eriÄŸi:', JSON.stringify(eslesenYemek, null, 2));
  
  if (eslestiMi && eslesenYemek) {
    // EÅŸleÅŸen yemek - dÃ¼zenleme modalÄ± aÃ§
    yemekDuzenleModalAc(eslesenYemek, 'duzenle');
  } else {
    // EÅŸleÅŸmeyen yemek - ekleme modalÄ± aÃ§
    yemekDuzenleModalAc({name: tarifAdi}, 'ekle');
  }
}

// Index kullanarak yemek detayÄ± gÃ¶ster
function showFoodDetailByIndex(index) {
  console.log('ğŸ” Index ile yemek detayÄ± gÃ¶steriliyor:', index);
  
  if (!window.currentFoodAnalysisData || !window.currentFoodAnalysisData[index]) {
    console.error('âŒ Yemek verisi bulunamadÄ±, index:', index);
    alert('Yemek verisi bulunamadÄ±. SayfayÄ± yenileyin.');
    return;
  }
  
  const item = window.currentFoodAnalysisData[index];
  console.log('ğŸ” Bulunan item:', JSON.stringify(item, null, 2));
  
  if (item.eslestiMi && item.eslesenYemek) {
    // EÅŸleÅŸen yemek - dÃ¼zenleme modalÄ± aÃ§
    yemekDuzenleModalAc(item.eslesenYemek, 'duzenle');
  } else {
    // EÅŸleÅŸmeyen yemek - ekleme modalÄ± aÃ§
    yemekDuzenleModalAc({name: item.tarifAdi}, 'ekle');
  }
}

// Index kullanarak eÅŸleÅŸtirme modunu aÃ§
function eslestirmeModeAc(index) {
  console.log('ğŸ”— Index ile eÅŸleÅŸtirme modu aÃ§Ä±lÄ±yor:', index);
  
  if (!window.currentFoodAnalysisData || !window.currentFoodAnalysisData[index]) {
    console.error('âŒ Yemek verisi bulunamadÄ±, index:', index);
    alert('Yemek verisi bulunamadÄ±. SayfayÄ± yenileyin.');
    return;
  }
  
  const item = window.currentFoodAnalysisData[index];
  console.log('ğŸ”— EÅŸleÅŸtirme iÃ§in item:', JSON.stringify(item, null, 2));
  
  // EÅŸleÅŸtirme modalÄ±nÄ± aÃ§ (String olarak yemek adÄ±nÄ± gÃ¶nder)
  yemekDuzenleModalAc(item.tarifAdi, 'eslestir');
}

// Index kullanarak yemek sil
function yemekSilByIndex(index) {
  console.log('ğŸ—‘ï¸ Index ile yemek siliniyor:', index);
  
  if (!window.currentFoodAnalysisData || !window.currentFoodAnalysisData[index]) {
    console.error('âŒ Yemek verisi bulunamadÄ±, index:', index);
    alert('Yemek verisi bulunamadÄ±. SayfayÄ± yenileyin.');
    return;
  }
  
  const item = window.currentFoodAnalysisData[index];
  if (item.eslesenYemek) {
    yemekSil(item.eslesenYemek);
  }
}

// Global fonksiyonlarÄ± window objesine ata
window.showFoodDetailByIndex = showFoodDetailByIndex;
window.yemekSilByIndex = yemekSilByIndex;
window.eslestirmeModeAc = eslestirmeModeAc;

// ğŸ½ï¸ YEMEK EKLEME/DÃœZENLEME MODAL FONKSÄ°YONLARI
function yemekDuzenleModalAc(yemekData, mod = 'ekle') {
  console.log('ğŸ” Modal aÃ§Ä±lÄ±yor, gelen data:', yemekData);
  console.log('ğŸ” Modal modu:', mod);
  
  const modal = document.getElementById('yemekDuzenleModal');
  const baslik = document.getElementById('yemekModalBaslik');
  const kaydetBtn = document.getElementById('yemekKaydetBtn');
  const eslestirBtn = document.getElementById('eslestirKaydetBtn');
  
  // EÄŸer yemekData string ise (PDF'den gelen), eÅŸleÅŸtirme modunda aÃ§
  if (typeof yemekData === 'string') {
    // EÅŸleÅŸtirme modunda baÅŸlat
    baslik.textContent = 'ğŸ”— Yemek EÅŸleÅŸtirme';
    eslestirBtn.style.display = 'inline-block';
    kaydetBtn.style.display = 'none';
    
    // EÅŸleÅŸtirme tab'Ä±nÄ± aktif et
    tabAc('eslestir');
    
    // PDF yemek adÄ±nÄ± gÃ¶ster
    document.getElementById('eslestirYemekAdi').textContent = yemekData;
    document.getElementById('pdfYemekAdi').textContent = yemekData;
    
  // Yemek listesini yÃ¼kle
  try { yemekListesiniYukle(); } catch (e) { console.warn('âš ï¸ Liste yÃ¼kleme hatasÄ±:', e); }
    
  } else {
    // Normal ekleme/dÃ¼zenleme modu
    if (mod === 'ekle') {
      baslik.textContent = 'ğŸ½ï¸ Yeni Yemek Ekle';
      kaydetBtn.textContent = 'â• Ekle';
      kaydetBtn.style.background = '#28a745';
    } else {
      baslik.textContent = 'ğŸ½ï¸ Yemek DÃ¼zenle';
      kaydetBtn.textContent = 'ğŸ’¾ GÃ¼ncelle';
      kaydetBtn.style.background = '#ffc107';
    }
    
    kaydetBtn.style.display = 'inline-block';
    eslestirBtn.style.display = 'none';
    
    // Yeni yemek tab'Ä±nÄ± aktif et
    tabAc('yeniYemek');
    
  // Formu doldur
  yemekFormDoldur(yemekData);
  }
  
  // ModalÄ± gÃ¶ster
  modal.style.display = 'block';
  
  // Modal modunu sakla
  modal.dataset.mod = mod;
  modal.dataset.originalData = JSON.stringify(yemekData);
}

// TAB FONKSÄ°YONLARI
function tabAc(tabName) {
  console.log('ğŸ”„ Tab deÄŸiÅŸtiriliyor:', tabName);
  
  // Tab butonlarÄ±nÄ± gÃ¼ncelle
  const yeniYemekTab = document.getElementById('yeniYemekTab');
  const eslestirTab = document.getElementById('eslestirTab');
  
  // Tab iÃ§eriklerini gÃ¼ncelle
  const yeniYemekContent = document.getElementById('yeniYemekContent');
  const eslestirContent = document.getElementById('eslestirContent');
  
  if (tabName === 'yeniYemek') {
    // Yeni Yemek tab'Ä±nÄ± aktif et
    yeniYemekTab.classList.add('tab-button', 'active');
    eslestirTab.classList.remove('active');
    eslestirTab.classList.add('tab-button');
    
    yeniYemekContent.style.display = 'block';
    eslestirContent.style.display = 'none';
    
  } else if (tabName === 'eslestir') {
    // EÅŸleÅŸtir tab'Ä±nÄ± aktif et
    eslestirTab.classList.add('tab-button', 'active');
    yeniYemekTab.classList.remove('active');
    yeniYemekTab.classList.add('tab-button');
    
    yeniYemekContent.style.display = 'none';
    eslestirContent.style.display = 'block';

    // PDF'den gelen ya da formdaki yemek adÄ±nÄ± baÅŸlÄ±ÄŸa yansÄ±t
    try {
      const formYemekAdi = (document.getElementById('yemekAdi')?.value || '').trim();
      if (formYemekAdi) {
        const hedef1 = document.getElementById('eslestirYemekAdi');
        const hedef2 = document.getElementById('pdfYemekAdi');
        if (hedef1) hedef1.textContent = formYemekAdi;
        if (hedef2) hedef2.textContent = formYemekAdi;
      }
    } catch (e) {
      console.warn('âš ï¸ EÅŸleÅŸtirme sekmesinde yemek adÄ± set edilemedi:', e);
    }

    // Ä°lk aÃ§Ä±lÄ±ÅŸta listeyi yÃ¼kle
    try { yemekListesiniYukle(); } catch (e) { console.warn('âš ï¸ Liste yÃ¼kleme hatasÄ±:', e); }
  }
}

// âœ‚ï¸ SATIR BÃ–LME FONKSÄ°YONLARI
let splitContext = { index: null, original: '' };

function openSplitModal(index) {
  if (!window.currentFoodAnalysisData || !currentFoodAnalysisData[index]) return;
  const item = currentFoodAnalysisData[index];
  if (item.gunOgunSatiri) return; // baÅŸlÄ±k satÄ±rÄ±
  splitContext.index = index;
  splitContext.original = item.tarifAdi;
  document.getElementById('splitModalOrjText').textContent = `Orijinal: ${item.tarifAdi}`;
  const ta = document.getElementById('splitLinesTextarea');
  ta.value = smartSplitSuggest(item.tarifAdi).join('\n');
  document.getElementById('satirBolModal').style.display = 'block';
}

function splitModalKapat(e) {
  if (e && e.target && e.currentTarget && e.target !== e.currentTarget) return;
  document.getElementById('satirBolModal').style.display = 'none';
  splitContext = { index: null, original: '' };
}

function smartSplitSuggest(text) {
  // BazÄ± yaygÄ±n ayÄ±rÄ±cÄ±larÄ±n kombinasyonu ile Ã¶neri
  const raw = (text || '').trim();
  if (!raw) return [];
  // Ã–nce ' + ' ve ' , ' ile parÃ§alar (salata vb. + yaÄŸ ifadeleri ayrÄ± kalabilir)
  let parts = raw
    .replace(/\s\+\s/g, ' | ') // + yerine gÃ¼venli ayracÄ± koy
    .split(/\s\|\s|\s{2,}/g)
    .map(s => s.trim())
    .filter(Boolean);
  // 'Kollajen' gibi takviyeleri ayrÄ± parÃ§alara Ã§ekmeye Ã§alÄ±ÅŸ
  const splitKeywords = ['kollajen', 'protein', 'magnesium', 'omega', 'balÄ±k yaÄŸÄ±'];
  parts = parts.flatMap(p => {
    const lower = p.toLowerCase();
    const hit = splitKeywords.find(k => lower.includes(k));
    if (!hit) return [p];
    // anahtar kelime Ã¶ncesi/sonrasÄ± bÃ¶l
    const idx = lower.indexOf(hit);
    const left = p.slice(0, idx).trim();
    const right = p.slice(idx).trim();
    return [left, right].filter(Boolean);
  });
  return parts;
}

function splitQuickSuggest(mode) {
  const src = splitContext.original || '';
  let suggestion = [];
  if (mode === 'kollajen') {
    suggestion = smartSplitSuggest(src);
  } else if (mode === 'doubleSpace') {
    suggestion = src.split(/\s{2,}/).map(s => s.trim()).filter(Boolean);
  } else if (mode === 'comma') {
    suggestion = src.split(',').map(s => s.trim()).filter(Boolean);
  }
  document.getElementById('splitLinesTextarea').value = suggestion.join('\n');
}

async function applySplitFromModal() {
  try {
    const ta = document.getElementById('splitLinesTextarea');
    const lines = ta.value.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
    if (!lines.length) { showToast('En az bir Ã¶ÄŸe girin', 'warning'); return; }
    const seciliIndex = getAktifHaftaIndex();
    const haftalar = getHaftaListesi();
    const hafta = haftalar[seciliIndex];
    if (!hafta || !Array.isArray(hafta.tarifler)) { showToast('Hafta verisi bulunamadÄ±', 'error'); return; }

    // Orijinal satÄ±rÄ± bul ve yerine yeni satÄ±rlarÄ± koy
    const original = splitContext.original;
    const pos = hafta.tarifler.findIndex(t => (t||'').toLowerCase() === (original||'').toLowerCase());
    const insertAt = pos >= 0 ? pos : hafta.tarifler.length;
    if (pos >= 0) { hafta.tarifler.splice(pos, 1, ...lines); }
    else { hafta.tarifler.push(...lines); }

    // Kural olarak kaydet (kalÄ±cÄ±)
    try {
      splitKuraliEkle(original, lines);
    } catch(e) { console.warn('Split kuralÄ± eklenemedi:', e); }

    // EÅŸleÅŸmeleri yeniden Ã§alÄ±ÅŸtÄ±r ve UI gÃ¼ncelle
    await otomatikEsleHafta(seciliIndex);
    eslesmeyenlerListesiniGuncelle();
    updateYemekVeritabaniAnalizi();
    // Hasta JSON'unu da kaydet (GitHub'a)
    try {
      if (seciliHasta) {
        await hastayiAyriKaydet(seciliHasta);
      }
    } catch (e) { console.warn('Split sonrasÄ± hasta kaydÄ± atlandÄ±:', e?.message || e); }
    showToast('SatÄ±r bÃ¶lÃ¼ndÃ¼ ve yeniden analiz edildi', 'success');
  } catch (e) {
    console.error('SatÄ±r bÃ¶lme hatasÄ±:', e);
    showToast('SatÄ±r bÃ¶lÃ¼nemedi', 'error');
  } finally {
    splitModalKapat();
  }
}

// Global eriÅŸim
window.openSplitModal = openSplitModal;
window.applySplitFromModal = applySplitFromModal;
window.splitModalKapat = splitModalKapat;
window.splitQuickSuggest = splitQuickSuggest;

// YEMEK LÄ°STESÄ° FONKSÄ°YONLARI
let mevcutYemekListesi = [];
let secilenYemek = null;
let aktifFiltre = 'all';

// Global, normalize edilmiÅŸ yemek listesi (food_list.json'dan)
window.globalFoodListFlat = window.globalFoodListFlat || null;

// TÃ¼rkÃ§e karakterleri ASCII'ye indirgeme (ID ve arama iÃ§in)
function turkishToAscii(str) {
  return (str || '')
    .replace(/Ã§/g, 'c').replace(/Ã‡/g, 'c')
    .replace(/ÄŸ/g, 'g').replace(/Ä/g, 'g')
    .replace(/ÅŸ/g, 's').replace(/Å/g, 's')
    .replace(/Ã¼/g, 'u').replace(/Ãœ/g, 'u')
    .replace(/Ã¶/g, 'o').replace(/Ã–/g, 'o')
    .replace(/Ä±/g, 'i').replace(/Ä°/g, 'i');
}

// === Karaliste (render dÄ±ÅŸÄ± satÄ±rlar) ===
const BLACKLIST_KEY = 'pdf_line_blacklist_v1';
const BLACKLIST_GITHUB_PATH = 'data/karaliste_satirlari.json';
let blacklistGitHubKaydetmeDevamEdiyor = false;
function getBlacklist() {
  try { return JSON.parse(localStorage.getItem(BLACKLIST_KEY)) || []; } catch { return []; }
}
function saveBlacklist(list) {
  try { localStorage.setItem(BLACKLIST_KEY, JSON.stringify(Array.from(new Set(list)))); } catch {}
}
function normalizeForBlacklist(str) {
  return normalizeTrSimple(str).replace(/\s+/g,' ').trim();
}
function addToBlacklist(raw) {
  const norm = normalizeForBlacklist(raw);
  if (!norm) return;
  const list = getBlacklist();
  if (!list.includes(norm)) {
    list.push(norm);
    saveBlacklist(list);
    console.log('ğŸš« Karaliste: eklendi ->', norm, `(toplam: ${list.length})`);
    showToast('SatÄ±r karalisteye eklendi', 'success');
    try { karalisteGitHubKaydet(true); } catch {}
  }
}
function removeFromBlacklist(raw) {
  const norm = normalizeForBlacklist(raw);
  const list = getBlacklist().filter(x => x !== norm);
  saveBlacklist(list);
  console.log('ğŸš« Karaliste: kaldÄ±rÄ±ldÄ± ->', norm, `(toplam: ${list.length})`);
  try { karalisteGitHubKaydet(true); } catch {}
}
function isBlacklisted(raw) {
  const norm = normalizeForBlacklist(raw);
  return getBlacklist().includes(norm);
}
function openBlacklistModal() {
  renderBlacklistModal();
  const m = document.getElementById('karalisteModal');
  if (m) m.style.display = 'block';
}
function closeBlacklistModal(e) {
  if (e && e.target && e.currentTarget && e.target !== e.currentTarget) return;
  const m = document.getElementById('karalisteModal');
  if (m) m.style.display = 'none';
}
function renderBlacklistModal() {
  const listDiv = document.getElementById('karalisteListesi');
  const emptyDiv = document.getElementById('karalisteBos');
  if (!listDiv) return;
  const list = getBlacklist();
  if (!list.length) {
    if (emptyDiv) emptyDiv.style.display = 'block';
    listDiv.innerHTML = '';
    return;
  }
  if (emptyDiv) emptyDiv.style.display = 'none';
  listDiv.innerHTML = list.map((norm, i) => `
    <label style="display:flex; align-items:center; gap:8px; padding:6px 8px; border-bottom:1px dashed #eee;">
      <input type="checkbox" checked onchange="toggleBlacklistByNorm('${norm.replace(/'/g,"&#39;")}')">
      <span style="font-family:monospace;">${norm}</span>
      <button onclick="toggleBlacklistByNorm('${norm.replace(/'/g,"&#39;")}')" style="margin-left:auto; background:#dc3545; color:#fff; border:none; padding:4px 8px; border-radius:4px; cursor:pointer; font-size:12px;">KaldÄ±r</button>
    </label>
  `).join('');
}
function toggleBlacklistByNorm(norm) {
  const list = getBlacklist();
  const idx = list.indexOf(norm);
  if (idx >= 0) list.splice(idx,1); else list.push(norm);
  saveBlacklist(list);
  console.log('ğŸš« Karaliste: toggle ->', norm, `(artÄ±k listede mi?: ${list.includes(norm)}) (toplam: ${list.length})`);
  renderBlacklistModal();
  updateYemekVeritabaniAnalizi();
  try { karalisteGitHubKaydet(true); } catch {}
}
function clearBlacklist() {
  saveBlacklist([]);
  console.log('ğŸš« Karaliste: tÃ¼mÃ¼ temizlendi');
  renderBlacklistModal();
  updateYemekVeritabaniAnalizi();
  try { karalisteGitHubKaydet(true); } catch {}
}

// Tablo satÄ±rÄ± iÃ§in hÄ±zlÄ± karaliste toggle
function toggleBlacklistForRow(index) {
  try {
    const data = window.currentFoodAnalysisData || [];
    const item = data[index];
    if (!item || !item.tarifAdi) return;
    const norm = normalizeForBlacklist(item.tarifAdi);
    const list = getBlacklist();
    const exists = list.includes(norm);
    if (exists) {
      saveBlacklist(list.filter(x => x !== norm));
  console.log('ğŸš« Karaliste (tablo): kaldÄ±rÄ±ldÄ± ->', norm);
      showToast('Karalisteden Ã§Ä±karÄ±ldÄ±', 'warning');
    } else {
      list.push(norm);
      saveBlacklist(list);
  console.log('ğŸš« Karaliste (tablo): eklendi ->', norm);
      showToast('Karalisteye eklendi', 'success');
    }
    // UI gÃ¼ncelle
    renderBlacklistModal();
    updateYemekVeritabaniAnalizi();
  try { karalisteGitHubKaydet(true); } catch {}
  } catch (e) {
    console.warn('toggleBlacklistForRow hatasÄ±:', e);
  }
}
// Global eriÅŸim
window.openBlacklistModal = openBlacklistModal;
window.closeBlacklistModal = closeBlacklistModal;
window.clearBlacklist = clearBlacklist;
window.toggleBlacklistByNorm = toggleBlacklistByNorm;
window.toggleBlacklistForRow = toggleBlacklistForRow;

// --- Karaliste GitHub entegrasyonu ---
async function karalisteGitHubKaydet(sessizKaydetme = false) {
  if (blacklistGitHubKaydetmeDevamEdiyor) return;
  const token = document.getElementById('githubToken')?.value?.trim();
  if (!token) { if (!sessizKaydetme) alert('GitHub API token gerekli!'); return; }
  blacklistGitHubKaydetmeDevamEdiyor = true;
  const owner = 'mustafasacar35';
  const repo = 'lipodem-takip-paneli-3';
  const path = BLACKLIST_GITHUB_PATH;
  const branch = 'main';
  try {
    let sha;
    try {
      const resp = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}?ref=${branch}`, { headers: { Authorization: `token ${token}` } });
      if (resp.ok) { const data = await resp.json(); sha = data.sha; }
    } catch {}
    const list = getBlacklist();
    const kayitVerisi = { version: '1.0', sonGuncelleme: new Date().toISOString(), karaliste: list };
    const content = encodeUTF8ToBase64(kayitVerisi);
    const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, {
      method: 'PUT', headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
      body: JSON.stringify({ message: 'Karaliste gÃ¼ncellendi', content, branch, sha })
    });
    if (!res.ok) {
      const errText = await res.text();
      // SHA conflict retry
      if (/expected/i.test(errText) || /sha/i.test(errText)) {
        try {
          const getResp = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}?ref=${branch}`, { headers: { Authorization: `token ${token}` } });
          if (getResp.ok) {
            const getData = await getResp.json();
            const retrySha = getData.sha;
            const retryRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, {
              method: 'PUT', headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
              body: JSON.stringify({ message: 'Karaliste gÃ¼ncellendi (retry)', content, branch, sha: retrySha })
            });
            if (!retryRes.ok) throw new Error(await retryRes.text());
          } else {
            throw new Error(errText);
          }
        } catch (retryErr) {
          throw retryErr;
        }
      } else {
        throw new Error(errText);
      }
    }
  localStorage.setItem('lastGithubUpdate', Date.now().toString());
  console.log('âœ… Karaliste GitHub\'a kaydedildi:', getBlacklist().length, 'Ã¶ÄŸe');
  if (!sessizKaydetme) showToast('Karaliste GitHub\'a kaydedildi', 'success');
  } catch (e) {
    console.error('Karaliste GitHub kaydetme hatasÄ±:', e);
    if (!sessizKaydetme) showToast('Karaliste GitHub kaydetme hatasÄ±', 'error');
  } finally { blacklistGitHubKaydetmeDevamEdiyor = false; }
}

async function karalisteGitHubYukle(sessizYukleme = false) {
  const token = document.getElementById('githubToken')?.value?.trim();
  if (!token) { if (!sessizYukleme) alert('GitHub API token gerekli!'); return; }
  const owner = 'mustafasacar35';
  const repo = 'lipodem-takip-paneli-3';
  const path = BLACKLIST_GITHUB_PATH;
  const branch = 'main';
  try {
    const resp = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}?ref=${branch}`, { headers: { Authorization: `token ${token}` } });
    if (resp.ok) {
      const data = await resp.json();
      const jsonContent = decodeBase64UTF8(data.content);
      const kayitVerisi = JSON.parse(jsonContent);
      const remote = kayitVerisi.karaliste || kayitVerisi || [];
      // Not: GitHub yÃ¼klemesi otoritatif olsun (overwrite) ki silmeler de senkron olsun
      const temiz = Array.isArray(remote) ? remote : [];
      saveBlacklist(temiz);
      localStorage.setItem('lastGithubUpdate', Date.now().toString());
      console.log('ğŸ“¥ Karaliste GitHub\'dan yÃ¼klendi:', temiz.length, 'Ã¶ÄŸe (overwrite)');
      if (!sessizYukleme) showToast(`GitHub'dan karaliste yÃ¼klendi (${temiz.length})`, 'success');
      try { updateYemekVeritabaniAnalizi(); } catch {}
      try { renderBlacklistModal(); } catch {}
    } else if (resp.status === 404) {
      if (!sessizYukleme) showToast('GitHub\'da karaliste dosyasÄ± yok', 'warning');
    } else {
      throw new Error('GitHub okuma hatasÄ±: ' + resp.status);
    }
  } catch (e) {
    console.error('Karaliste GitHub yÃ¼kleme hatasÄ±:', e);
    if (!sessizYukleme) showToast('Karaliste GitHub yÃ¼kleme hatasÄ±', 'error');
  }
}

async function karalistePublicYukle() {
  try {
    const url = 'https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli-3/main/data/karaliste_satirlari.json';
    const resp = await fetch(url + `?t=${Date.now()}`);
    if (resp.ok) {
      const data = await resp.json();
      const remote = data.karaliste || data || [];
      const union = Array.from(new Set([...(getBlacklist() || []), ...(Array.isArray(remote) ? remote : [])]));
      saveBlacklist(union);
      try { updateYemekVeritabaniAnalizi(); } catch {}
    }
  } catch {}
}

window.karalisteGitHubKaydet = karalisteGitHubKaydet;
window.karalisteGitHubYukle = karalisteGitHubYukle;

// Basit ama stabil bir hash (ID Ã§akÄ±ÅŸmalarÄ±nÄ± Ã¶nlemek iÃ§in suffix)
function simpleHash(str) {
  let h = 0;
  for (let i = 0; i < (str || '').length; i++) {
    h = ((h << 5) - h) + str.charCodeAt(i);
    h |= 0; // 32-bit
  }
  return Math.abs(h).toString(36);
}

// UI aramasÄ± iÃ§in normalize (boÅŸluk/iÅŸaret sadeleÅŸtirme)
function normalizeTrSimple(str) {
  return turkishToAscii((str || '').toString().toLowerCase())
    .replace(/[_*\/()\[\],.]/g, ' ')
    .replace(/\s+/g, ' ')
    .trim();
}

function generateStableId(name, kategori) {
  try {
    const n = turkishToAscii((name || '').toLowerCase());
    const k = turkishToAscii((kategori || '').toLowerCase());
    const base = `${n}_${k}`
      .replace(/\s+/g, '_')
      .replace(/[^a-z0-9_\-]/g, '');
    const suffix = simpleHash(`${name}::${kategori}`);
    return 'db_' + base + '_' + suffix;
  } catch { return 'db_' + Math.random().toString(36).slice(2); }
}

function flattenFoodDataToGlobal(foodData) {
  if (!foodData || !Array.isArray(foodData.categories)) return [];
  const flat = [];
  foodData.categories.forEach(cat => {
    const kategori = cat?.name || 'GENEL';
    (cat?.items || []).forEach(item => {
      flat.push({
        id: generateStableId(item.name, kategori),
        ad: item.name,
        kategori: item.category || kategori,
        kalori: item.calories || 0,
        protein: item.protein || 0,
        karbonhidrat: item.carbs || 0,
        yag: item.fat || 0,
        etiketler: item.tags || []
      });
    });
  });
  window.globalFoodListFlat = flat;
  return flat;
}

function yemekListesiniYukle() {
  console.log('ğŸ“‹ Yemek listesi yÃ¼kleniyor...');
  
  // Ã–nce global, normalize edilmiÅŸ listeyi kullan
  if (window.globalFoodListFlat && Array.isArray(window.globalFoodListFlat) && window.globalFoodListFlat.length) {
    console.log('ğŸ•µï¸ DEBUG: Global flat listeden yÃ¼kleniyor, adet:', window.globalFoodListFlat.length);
    console.log('ğŸ•µï¸ DEBUG: Ä°lk yemek Ã¶rneÄŸi (global):', window.globalFoodListFlat[0]);
    mevcutYemekListesi = [...window.globalFoodListFlat];
  } else {
    // ğŸš¨ LOKAL FALLBACK DEVRE DIÅI - SADECE GITHUB'DAN
    console.log('âŒ Global liste bulunamadÄ±! SADECE GitHub\'dan yÃ¼kleme aktif.');
    console.log('â„¹ï¸ LÃ¼tfen GitHub token\'Ä±nÄ±zÄ± kontrol edin ve internet baÄŸlantÄ±nÄ±zÄ± doÄŸrulayÄ±n.');
    mevcutYemekListesi = [];
  }
  
  // Toplam sayÄ±yÄ± gÃ¼ncelle
  if (document.getElementById('toplamYemekSayisi')) {
    document.getElementById('toplamYemekSayisi').textContent = mevcutYemekListesi.length || 0;
  }
  
  // Listeyi gÃ¶ster
  if (mevcutYemekListesi && mevcutYemekListesi.length) {
    yemekListesiniGoster(mevcutYemekListesi);
  }
}

function yemekListesiniGoster(liste) {
  const container = document.getElementById('yemekListesiContainer');
  
  if (!liste || liste.length === 0) {
    container.innerHTML = `
      <div style="text-align: center; padding: 40px; color: #666;">
        <i class="fas fa-search" style="font-size: 32px; margin-bottom: 10px; opacity: 0.5;"></i>
        <p style="margin: 0; font-size: 14px;">AramanÄ±zla eÅŸleÅŸen yemek bulunamadÄ±.</p>
      </div>
    `;
    return;
  }
  
  const html = liste.map(yemek => {
    const kategoriIcon = getKategoriIcon(yemek.kategori);
    const makrolar = `P:${yemek.protein || 0}g, K:${yemek.karbonhidrat || 0}g, Y:${yemek.yag || 0}g`;
    
    return `
      <div class="yemek-kart" onclick="yemekSec('${yemek.id}')" data-yemek-id="${yemek.id}">
        <div class="yemek-kart-header">
          <div style="display: flex; justify-content: space-between; align-items: start;">
            <div style="flex: 1;">
              <h6 style="margin: 0; color: #333; font-weight: 600; font-size: 14px;">
                ${kategoriIcon} ${yemek.ad}
              </h6>
              <div style="font-size: 11px; color: #20c997; margin-top: 2px; font-weight: 500;">
                ${yemek.kategori || 'Kategori belirsiz'}
              </div>
            </div>
            <div style="font-size: 12px; color: #28a745; font-weight: bold;">
              ${yemek.kalori || 0} kcal
            </div>
          </div>
        </div>
        <div class="yemek-kart-body">
          <div style="margin-bottom: 5px;">${makrolar}</div>
          ${yemek.etiketler ? `<div style="font-size: 11px; color: #888;">ğŸ·ï¸ ${Array.isArray(yemek.etiketler) ? yemek.etiketler.join(', ') : yemek.etiketler}</div>` : ''}
        </div>
      </div>
    `;
  }).join('');
  
  container.innerHTML = html;
}

function getKategoriIcon(kategori) {
  const iconMap = {
    'KAHVALTI': 'ğŸŒ…',
    'OGLE': 'ğŸŒ', 
    'AKSAM': 'ğŸŒ™',
    'TATLI': 'ğŸ°',
    'ICECEK': 'ğŸ¥¤',
    'SALATA': 'ğŸ¥—',
    'CORBALAR': 'ğŸ²',
    'SEBZE': 'ğŸ¥¬',
    'ET': 'ğŸ¥©',
    'BALIK': 'ğŸŸ',
    'TAVUK': 'ğŸ”',
    'APERATIF': 'ğŸ¥¨'
  };
  return iconMap[kategori] || 'ğŸ½ï¸';
}

function yemekSec(yemekId) {
  console.log('ğŸ¯ Yemek seÃ§ildi:', yemekId);
  
  // Ã–nceki seÃ§imi temizle
  const oncekiSecim = document.querySelector('.yemek-kart.selected');
  if (oncekiSecim) {
    oncekiSecim.classList.remove('selected');
  }
  
  // Yeni seÃ§imi iÅŸaretle
  const yeniSecim = document.querySelector(`[data-yemek-id="${yemekId}"]`);
  if (yeniSecim) {
    yeniSecim.classList.add('selected');
  }
  
  // SeÃ§ilen yemeÄŸi bul
  secilenYemek = mevcutYemekListesi.find(y => y.id === yemekId);
  
  if (secilenYemek) {
    // SeÃ§ilen yemek bilgisini gÃ¶ster
    const bilgiDiv = document.getElementById('secilenYemekBilgi');
    const detayDiv = document.getElementById('secilenYemekDetay');
    
    const makrolar = `Protein: ${secilenYemek.protein || 0}g, Karbonhidrat: ${secilenYemek.karbonhidrat || 0}g, YaÄŸ: ${secilenYemek.yag || 0}g`;
    
    detayDiv.innerHTML = `
      <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 15px; margin-bottom: 10px;">
        <div>
          <strong>${getKategoriIcon(secilenYemek.kategori)} ${secilenYemek.ad}</strong>
          <div style="margin-top: 5px; font-size: 13px;">${makrolar}</div>
        </div>
        <div style="text-align: right;">
          <div style="font-size: 16px; font-weight: bold; color: #28a745;">${secilenYemek.kalori || 0} kcal</div>
          <div style="font-size: 12px; color: #20c997;">${secilenYemek.kategori}</div>
        </div>
      </div>
      ${secilenYemek.etiketler ? `<div style="font-size: 12px; color: #666;"><strong>Etiketler:</strong> ${Array.isArray(secilenYemek.etiketler) ? secilenYemek.etiketler.join(', ') : secilenYemek.etiketler}</div>` : ''}
    `;
    
    bilgiDiv.style.display = 'block';
  }
}

function yemekListesiniFiltrele() {
  const aramaHam = document.getElementById('yemekAramaInput').value || '';
  const aramaMetni = normalizeTrSimple(aramaHam);

  let filtrelenmisListe = [...mevcutYemekListesi];

  // Kategori filtresi uygula
  if (aktifFiltre !== 'all') {
    filtrelenmisListe = filtrelenmisListe.filter(yemek => yemek.kategori === aktifFiltre);
  }

  // Arama filtresi uygula (TÃ¼rkÃ§e karakter duyarlÄ± normalize)
  if (aramaMetni) {
    filtrelenmisListe = filtrelenmisListe.filter(yemek => {
      const adNorm = normalizeTrSimple(yemek.ad);
      let etiketNorm = '';
      if (yemek.etiketler) {
        etiketNorm = Array.isArray(yemek.etiketler)
          ? normalizeTrSimple(yemek.etiketler.join(' '))
          : normalizeTrSimple(String(yemek.etiketler));
      }
      return adNorm.includes(aramaMetni) || (etiketNorm && etiketNorm.includes(aramaMetni));
    });
  }

  yemekListesiniGoster(filtrelenmisListe);
  console.log(`ğŸ” Filtreleme: "${aramaHam}" => "${aramaMetni}" + kategori:"${aktifFiltre}" = ${filtrelenmisListe.length} sonuÃ§`);
}

function hizliFiltre(kategori) {
  console.log('âš¡ HÄ±zlÄ± filtre:', kategori);
  
  aktifFiltre = kategori;
  
  // Buton stillerini gÃ¼ncelle
  const tÃ¼mButonlar = document.querySelectorAll('.hizli-filtre');
  tÃ¼mButonlar.forEach(btn => {
    btn.classList.remove('active');
    if (btn.dataset.filtre === kategori) {
      btn.classList.add('active');
    }
  });
  
  // Filtrelemeyi uygula
  yemekListesiniFiltrele();
}

function aliasEklemeToggle() {
  const checkbox = document.getElementById('aliasEkleCheckbox');
  const alan = document.getElementById('aliasEklemeAlani');
  
  if (checkbox.checked) {
    alan.style.display = 'block';
  } else {
    alan.style.display = 'none';
  }
}

function yemekEslestir() {
  if (!secilenYemek) {
    showToast('LÃ¼tfen eÅŸleÅŸtirmek iÃ§in bir yemek seÃ§in!', 'warning');
    return;
  }
  
  const aliasEkle = document.getElementById('aliasEkleCheckbox').checked;
  const pdfYemekAdi = document.getElementById('pdfYemekAdi').textContent;
  
  console.log('ğŸ”— Yemek eÅŸleÅŸtiriliyor:', {
    pdfAdi: pdfYemekAdi,
    secilenYemek: secilenYemek.ad,
    aliasEkle: aliasEkle
  });
  
  if (aliasEkle && pdfYemekAdi && pdfYemekAdi !== secilenYemek.ad) {
    // Alias oluÅŸtur - seÃ§ilen yemeÄŸin kopyasÄ±nÄ± yeni isimle ekle
    const yeniYemek = { ...secilenYemek };
    yeniYemek.id = generateId();
    yeniYemek.ad = pdfYemekAdi;
    yeniYemek.aliasOf = secilenYemek.id;
    yeniYemek.createdDate = new Date().toISOString();
    
    // Yemek listesine ekle
    foodList.push(yeniYemek);
    
    // GitHub'a kaydet
    yemekGithubKaydet()
      .then(() => {
        showToast(`"${pdfYemekAdi}" ismiyle alias oluÅŸturuldu ve "${secilenYemek.ad}" ile eÅŸleÅŸtirildi!`, 'success');
        yemekModalKapat();
      })
      .catch(error => {
        console.error('âŒ Alias kaydetme hatasÄ±:', error);
        showToast('Alias kaydedilirken hata oluÅŸtu: ' + error.message, 'error');
      });
  } else {
    // Sadece eÅŸleÅŸtirme yap
    showToast(`"${pdfYemekAdi}" "${secilenYemek.ad}" ile eÅŸleÅŸtirildi!`, 'success');
    yemekModalKapat();
  }
}

// Global fonksiyonlarÄ± window objesine ata
window.tabAc = tabAc;
window.yemekListesiniFiltrele = yemekListesiniFiltrele;
window.hizliFiltre = hizliFiltre;
window.aliasEklemeToggle = aliasEklemeToggle;
window.yemekEslestir = yemekEslestir;

// ğŸ”„ ALTERNATÄ°F YEMEK SÄ°STEMÄ°
let alternativeModeActive = false;
let currentAlternativeIndex = -1;
let originalFoodData = null;
let alternativeFoods = [];
let currentAlternativeStep = 0;

// Bu ilk fonksiyon devre dÄ±ÅŸÄ± - Ã¼Ã§Ã¼ncÃ¼ fonksiyon kullanÄ±lÄ±yor
function alternatifYemekAc_ILKVERSIYON(index) {
  
  if (!window.currentFoodAnalysisData || !window.currentFoodAnalysisData[index]) {
    console.error('âŒ Yemek verisi bulunamadÄ±, index:', index);
    showToast('Yemek verisi bulunamadÄ±!', 'error');
    return;
  }
  
  const item = window.currentFoodAnalysisData[index];
  
  if (!item.eslestiMi || !item.eslesenYemek) {
    showToast('Sadece eÅŸleÅŸen yemekler iÃ§in alternatif Ã¶nerileri yapÄ±labilir!', 'warning');
    return;
  }
  
  console.log('ğŸ¯ Alternatif aranacak yemek:', item.eslesenYemek);
  
  // Mevcut durumu kaydet
  originalFoodData = { ...item.eslesenYemek };
  currentAlternativeIndex = index;
  currentAlternativeStep = 0;
  
  // Alternatif yemekleri bulup uygula
  alternatifleriBaslat(item.eslesenYemek);
}

async function alternatifleriBaslat(currentFood) {
  try {
    showToast('ğŸ” Alternatif yemekler aranÄ±yor...', 'info');
    
    // GitHub'dan yemek veritabanÄ±nÄ± yÃ¼kle
    const response = await fetch('https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli-3/refs/heads/main/food_list.json');
    if (!response.ok) {
      throw new Error('Yemek veritabanÄ± yÃ¼klenemedi');
    }
    
    const foodData = await response.json();
    
    // TÃ¼m yemekleri dÃ¼z listeye Ã§evir
    const allFoods = [];
    foodData.categories.forEach(category => {
      category.items.forEach(item => {
        allFoods.push({
          id: item.id || generateId(),
          name: item.name,
          category: item.category || category.name,
          calories: item.calories || 0,
          protein: item.protein || 0,
          carbs: item.carbs || 0,
          fat: item.fat || 0,
          tags: item.tags || [],
          originalName: item.name
        });
      });
    });
    
    console.log('ğŸ“Š Toplam yemek sayÄ±sÄ±:', allFoods.length);
    
    // Benzer yemekleri bul (makro deÄŸerlere gÃ¶re)
    const currentMacros = {
      calories: currentFood.calories || 0,
      protein: currentFood.protein || 0,
      carbs: currentFood.carbs || 0,
      fat: currentFood.fat || 0
    };
    
    console.log('ğŸ¯ Referans makrolar:', currentMacros);
    
    // Benzerlik skorunu hesapla
    const scoredFoods = allFoods
      .filter(food => food.name.toLowerCase() !== currentFood.originalName.toLowerCase()) // AynÄ± yemeÄŸi hariÃ§ tut
      .map(food => {
        const score = calculateSimilarityScore(currentMacros, {
          calories: food.calories,
          protein: food.protein,
          carbs: food.carbs,
          fat: food.fat
        });
        
        return { ...food, similarityScore: score };
      })
      .sort((a, b) => b.similarityScore - a.similarityScore) // YÃ¼ksek skordan dÃ¼ÅŸÃ¼ÄŸe
      .slice(0, 10); // En benzer 10 tanesini al
    
    alternativeFoods = scoredFoods;
    console.log('ğŸ”„ Bulunan alternatifler:', alternativeFoods.length);
    
    if (alternativeFoods.length === 0) {
      showToast('Bu yemeÄŸe benzer alternatif bulunamadÄ±!', 'warning');
      return;
    }
    
    // Alternatif modunu baÅŸlat
    alternativeModeActive = true;
    updateAlternativeControls();
    sonrakiAlternatifeGec();
    
    showToast(`ğŸ”„ Alternatif mod baÅŸladÄ±! ${alternativeFoods.length} seÃ§enek bulundu. Sidebar'dan seÃ§ebilirsiniz.`, 'success', 4000);
    
  } catch (error) {
    console.error('âŒ Alternatif yemek hatasÄ±:', error);
    showToast('Alternatif yemekler yÃ¼klenirken hata: ' + error.message, 'error');
  }
}

function calculateSimilarityScore(macro1, macro2) {
  // Weighted similarity score - kalori aÄŸÄ±rlÄ±ÄŸÄ± daha yÃ¼ksek
  const calorieWeight = 0.4;
  const proteinWeight = 0.25;
  const carbWeight = 0.2;
  const fatWeight = 0.15;
  
  // Normalize edilmiÅŸ farklarÄ± hesapla (0-100 arasÄ±)
  const calorieDiff = Math.abs(macro1.calories - macro2.calories);
  const proteinDiff = Math.abs(macro1.protein - macro2.protein);
  const carbDiff = Math.abs(macro1.carbs - macro2.carbs);
  const fatDiff = Math.abs(macro1.fat - macro2.fat);
  
  // Maksimum farklar (normalize etmek iÃ§in)
  const maxCalorie = Math.max(macro1.calories, macro2.calories, 1);
  const maxProtein = Math.max(macro1.protein, macro2.protein, 1);
  const maxCarb = Math.max(macro1.carbs, macro2.carbs, 1);
  const maxFat = Math.max(macro1.fat, macro2.fat, 1);
  
  // Benzerlik skorlarÄ± (1 = tamamen benzer, 0 = tamamen farklÄ±)
  const calorieScore = 1 - (calorieDiff / maxCalorie);
  const proteinScore = 1 - (proteinDiff / maxProtein);
  const carbScore = 1 - (carbDiff / maxCarb);
  const fatScore = 1 - (fatDiff / maxFat);
  
  // AÄŸÄ±rlÄ±klÄ± toplam skor
  const totalScore = (
    calorieScore * calorieWeight +
    proteinScore * proteinWeight +
    carbScore * carbWeight +
    fatScore * fatWeight
  ) * 100;
  
  return Math.max(0, totalScore); // Negatif deÄŸerleri Ã¶nle
}

function sonrakiAlternatifeGec() {
  if (!alternativeModeActive || alternativeFoods.length === 0) {
    return;
  }
  
  // DÃ¶ngÃ¼sel olarak sonraki alternatife geÃ§
  const alternative = alternativeFoods[currentAlternativeStep % alternativeFoods.length];
  currentAlternativeStep++;
  
  console.log(`ğŸ”„ Alternatif ${currentAlternativeStep}/${alternativeFoods.length}:`, alternative);
  
  // Mevcut yemek verisini gÃ¼ncelle
  const currentItem = window.currentFoodAnalysisData[currentAlternativeIndex];
  currentItem.eslesenYemek = {
    ...alternative,
    originalName: alternative.name
  };
  
  // Sidebar kontrollerini gÃ¼ncelle
  updateAlternativeControls();
  
  // Sadece ilgili satÄ±rÄ± gÃ¼ncelle (tÃ¼m tabloyu yeniden render etme)
  updateFoodTableRow(currentAlternativeIndex, currentItem);
  
  // Bilgi mesajÄ± gÃ¶ster
  const scoreText = alternative.similarityScore ? ` (Benzerlik: ${alternative.similarityScore.toFixed(1)}%)` : '';
  showToast(`ğŸ”„ ${alternative.name}${scoreText}`, 'info', 2000);
}

function alternatifleriDurdur() {
  if (!alternativeModeActive) {
    return;
  }
  
  console.log('â¹ï¸ Alternatif mod durduruluyor');
  
  alternativeModeActive = false;
  currentAlternativeIndex = -1;
  alternativeFoods = [];
  currentAlternativeStep = 0;
  
  updateAlternativeControls();
  showToast('â¹ï¸ Alternatif mod durduruldu', 'info');
}

function orijinalYemegiGeriYukle() {
  if (!originalFoodData || currentAlternativeIndex === -1) {
    showToast('Geri yÃ¼klenecek orijinal yemek bulunamadÄ±!', 'warning');
    return;
  }
  
  console.log('â†©ï¸ Orijinal yemek geri yÃ¼kleniyor:', originalFoodData);
  
  // Orijinal veriyi geri yÃ¼kle
  const currentItem = window.currentFoodAnalysisData[currentAlternativeIndex];
  currentItem.eslesenYemek = { ...originalFoodData };
  
  // Alternatif modu durdur
  alternatifleriDurdur();
  
  // Sadece ilgili satÄ±rÄ± gÃ¼ncelle (tÃ¼m tabloyu yeniden render etme)
  updateFoodTableRow(currentAlternativeIndex, currentItem);
  
  showToast('â†©ï¸ Orijinal yemek geri yÃ¼klendi', 'success');
  
  // Veriyi temizle
  originalFoodData = null;
}

function updateAlternativeControls() {
  const controlsDiv = document.getElementById('alternativeControls');
  const infoDiv = document.getElementById('alternativeInfo');
  const listDiv = document.getElementById('alternativeList');
  
  if (!controlsDiv || !infoDiv || !listDiv) {
    return;
  }
  
  if (alternativeModeActive) {
    controlsDiv.style.display = 'block';
    listDiv.style.display = 'block';
    
    const currentItem = window.currentFoodAnalysisData[currentAlternativeIndex];
    const currentFood = currentItem ? currentItem.eslesenYemek : null;
    
    if (currentFood) {
      infoDiv.innerHTML = `
        <strong>Aktif Yemek:</strong><br>
        ${currentFood.name}<br>
        <small>AdÄ±m: ${currentAlternativeStep}/${alternativeFoods.length}</small><br>
        <small>${currentFood.calories || 0} kcal</small>
      `;
      
      // Alternatif liste oluÅŸtur
      renderAlternativeList();
    } else {
      infoDiv.innerHTML = 'Alternatif mod aktif';
      listDiv.innerHTML = '';
    }
  } else {
    controlsDiv.style.display = 'none';
    listDiv.style.display = 'none';
    infoDiv.innerHTML = 'Alternatif mod aktif deÄŸil';
  }
}

function renderAlternativeList() {
  const listDiv = document.getElementById('alternativeList');
  if (!listDiv || !alternativeFoods || alternativeFoods.length === 0) {
    return;
  }
  
  const currentItem = window.currentFoodAnalysisData[currentAlternativeIndex];
  const currentFoodName = currentItem ? currentItem.eslesenYemek.name : '';
  
  let html = '';
  
  // Orijinal yemeÄŸi en Ã¼ste ekle
  if (originalFoodData) {
    const isActive = currentFoodName === originalFoodData.originalName;
    html += `
      <div onclick="alternatifSec('original')" 
           style="padding: 8px; border-bottom: 1px solid #eee; cursor: pointer; background: ${isActive ? '#e8f5e8' : 'white'}; font-size: 10px; transition: background 0.2s;"
           onmouseover="this.style.background='#f0f8ff'" 
           onmouseout="this.style.background='${isActive ? '#e8f5e8' : 'white'}'">
        <div style="font-weight: bold; color: #28a745; margin-bottom: 2px;">
          ${isActive ? 'âœ… ' : ''}ğŸ”„ ${originalFoodData.originalName} (ORÄ°JÄ°NAL)
        </div>
        <div style="color: #666; font-size: 9px;">
          ${originalFoodData.calories || 0} kcal â€¢ P:${originalFoodData.protein || 0}g â€¢ K:${originalFoodData.carbs || 0}g â€¢ Y:${originalFoodData.fat || 0}g
        </div>
      </div>
    `;
  }
  
  // Alternatif yemekleri ekle
  alternativeFoods.forEach((food, index) => {
    const isActive = currentFoodName === food.name;
    const scoreText = food.similarityScore ? ` â€¢ ${food.similarityScore.toFixed(0)}%` : '';
    
    html += `
      <div onclick="alternatifSec(${index})" 
           style="padding: 8px; border-bottom: 1px solid #eee; cursor: pointer; background: ${isActive ? '#e8f5e8' : 'white'}; font-size: 10px; transition: background 0.2s;"
           onmouseover="this.style.background='#f0f8ff'" 
           onmouseout="this.style.background='${isActive ? '#e8f5e8' : 'white'}'">
        <div style="font-weight: bold; color: #17a2b8; margin-bottom: 2px;">
          ${isActive ? 'âœ… ' : ''}${food.name}${scoreText}
        </div>
        <div style="color: #666; font-size: 9px;">
          ${food.calories || 0} kcal â€¢ P:${food.protein || 0}g â€¢ K:${food.carbs || 0}g â€¢ Y:${food.fat || 0}g
        </div>
        <div style="color: #888; font-size: 8px; margin-top: 1px;">
          ${food.category || 'Kategori yok'}
        </div>
      </div>
    `;
  });
  
  listDiv.innerHTML = html;
}

function updateFoodTableRow(index, item) {
  console.log('ğŸ”„ Sadece tablo satÄ±rÄ± gÃ¼ncelleniyor, index:', index);
  console.log('ğŸ” Ä°tem details:', {
    tarifAdi: item.tarifAdi,
    siraNo: item.siraNo,
    gunOgunSatiri: item.gunOgunSatiri
  });
  
  // SÄ±ra numarasÄ±na gÃ¶re doÄŸru satÄ±rÄ± bul (data-sira-no attribute kullanarak)
  const targetRow = document.querySelector(`#veritabaniAnaliziContent table tbody tr[data-sira-no="${item.siraNo}"]`);
  
  if (!targetRow) {
    console.warn('âš ï¸ SÄ±ra numarasÄ± ile tablo satÄ±rÄ± bulunamadÄ±:', item.siraNo);
    
    // Alternatif: tÃ¼m satÄ±rlarÄ± kontrol et
    const allRows = document.querySelectorAll('#veritabaniAnaliziContent table tbody tr');
    console.log('ğŸ” Tablo satÄ±r sayÄ±sÄ±:', allRows.length);
    allRows.forEach((row, i) => {
      const siraNo = row.getAttribute('data-sira-no');
      console.log(`ğŸ” SatÄ±r ${i}: data-sira-no="${siraNo}"`);
    });
    return;
  }
  
  console.log('âœ… DoÄŸru satÄ±r bulundu:', targetRow);
  
  // Sadece makro deÄŸerleri gÃ¼ncelle
  const cells = targetRow.querySelectorAll('td');
  if (cells.length >= 6) {
    let kalori = 0, protein = 0, karb = 0, yag = 0;
    
    if (item.eslestiMi && item.eslesenYemek) {
      kalori = item.eslesenYemek.calories || 0;
      protein = item.eslesenYemek.protein || 0;
      karb = item.eslesenYemek.carbs || 0;
      yag = item.eslesenYemek.fat || 0;
    }
    
    // Yemek adÄ±nÄ± gÃ¼ncelle (0. sÃ¼tun)
    const nameCell = cells[0];
    if (nameCell && item.eslesenYemek) {
      const nameSpan = nameCell.querySelector('span:last-child');
      if (nameSpan) {
        nameSpan.innerHTML = `<span style="font-weight: normal; color: #333;">
          ğŸ”„ ${item.eslesenYemek.name || item.eslesenYemek.originalName} (ALTERNATÄ°F)
        </span>`;
      }
    }
    
    // Kalori (1. sÃ¼tun)
    cells[1].innerHTML = `<span style="font-weight: bold;">${kalori}</span>`;
    
    // Karbonhidrat (2. sÃ¼tun) 
    cells[2].innerHTML = `<span style="font-weight: bold;">${karb.toFixed(1)}</span>`;
    
    // Protein (3. sÃ¼tun)
    cells[3].innerHTML = `<span style="font-weight: bold;">${protein.toFixed(1)}</span>`;
    
    // YaÄŸ (4. sÃ¼tun)
    cells[4].innerHTML = `<span style="font-weight: bold;">${yag.toFixed(1)}</span>`;
    
    // SatÄ±rÄ±n rengini deÄŸiÅŸtir (alternatif gÃ¶stergesi)
    targetRow.style.background = 'linear-gradient(90deg, #e8f5e8 0%, #f0f8f0 100%)';
    targetRow.style.borderLeft = '4px solid #17a2b8';
    
    console.log('âœ… Tablo satÄ±rÄ± gÃ¼ncellendi:', {
      siraNo: item.siraNo,
      yemek: item.eslesenYemek.name,
      kalori,
      protein,
      karb,
      yag
    });
    
    // Toplam satÄ±rlarÄ±nÄ± da gÃ¼ncelle
    updateTotalRows();
  } else {
    console.warn('âš ï¸ Yeterli sÃ¼tun bulunamadÄ±:', cells.length);
  }
}

function updateTotalRows() {
  console.log('ğŸ“Š Toplam satÄ±rlarÄ± gÃ¼ncelleniyor...');
  console.log('ğŸ“Š currentFoodAnalysisData uzunluk:', window.currentFoodAnalysisData?.length);
  
  if (!window.currentFoodAnalysisData) {
    console.error('âŒ currentFoodAnalysisData bulunamadÄ±!');
    return;
  }

  // Tablo satÄ±rlarÄ±nÄ± sÄ±rasÄ±yla analiz et
  const tableRows = document.querySelectorAll('#veritabaniAnaliziContent table tbody tr');
  console.log('ğŸ“Š Toplam tablo satÄ±r sayÄ±sÄ±:', tableRows.length);
  
  let currentGun = null;
  let currentOgun = null;
  let gunMakrolari = new Map(); // Gun adÄ± -> makrolar
  let ogunMakrolari = new Map(); // Ã–ÄŸÃ¼n satÄ±r index -> makrolar
  
  // Her satÄ±rÄ± analiz et
  tableRows.forEach((row, rowIndex) => {
    const firstCell = row.querySelector('td');
    if (!firstCell) return;
    
    const cellText = firstCell.textContent.trim();
    const siraNo = row.getAttribute('data-sira-no');
    
    // GÃ¼n satÄ±rÄ± mÄ± kontrol et - iki format destekle
    // Format 1: "ğŸ“… PAZARTESÄ°", "ğŸ“… SALI" vb.
    // Format 2: "1. GÃ¼n (Pazartesi)" vb.
    const isGunRow1 = cellText.includes('ğŸ“…') && (
      cellText.includes('PAZARTESÄ°') || cellText.includes('SALI') || 
      cellText.includes('Ã‡ARÅAMBA') || cellText.includes('PERÅEMBE') || 
      cellText.includes('CUMA') || cellText.includes('CUMARTESÄ°') || 
      cellText.includes('PAZAR')
    );
    
    const isGunRow2 = cellText.includes('GÃ¼n') && (
      cellText.includes('Pazartesi') || cellText.includes('SalÄ±') || 
      cellText.includes('Ã‡arÅŸamba') || cellText.includes('PerÅŸembe') || 
      cellText.includes('Cuma') || cellText.includes('Cumartesi') || 
      cellText.includes('Pazar')
    );
    
    if (isGunRow1 || isGunRow2) {
      currentGun = cellText;
      currentOgun = null;
      
      if (!gunMakrolari.has(currentGun)) {
        gunMakrolari.set(currentGun, { kalori: 0, protein: 0, karb: 0, yag: 0, rowIndex });
      }
      console.log('ğŸ—“ï¸ Yeni gÃ¼n tespit edildi:', currentGun, 'rowIndex:', rowIndex);
      return;
    }
    
    // Ã–ÄŸÃ¼n satÄ±rÄ± mÄ± kontrol et (ğŸ½ï¸ ile baÅŸlayan)
    if (cellText.includes('ğŸ½ï¸')) {
      currentOgun = rowIndex;
      ogunMakrolari.set(currentOgun, { kalori: 0, protein: 0, karb: 0, yag: 0 });
      console.log('ğŸ½ï¸ Yeni Ã¶ÄŸÃ¼n tespit edildi:', cellText, 'Row:', rowIndex);
      return;
    }
    
    // Normal yemek satÄ±rÄ± - sÄ±ra numarasÄ± varsa
    if (siraNo && siraNo !== 'null') {
      const item = window.currentFoodAnalysisData.find(data => data.siraNo == siraNo);
      
      if (item && item.eslestiMi && item.eslesenYemek && !item.gunOgunSatiri) {
        const kalori = item.eslesenYemek.calories || 0;
        const protein = item.eslesenYemek.protein || 0;
        const karb = item.eslesenYemek.carbs || 0;
        const yag = item.eslesenYemek.fat || 0;
        
        console.log('ğŸ Yemek verisi ekleniyor:', {
          siraNo,
          yemek: item.eslesenYemek.name,
          kalori, protein, karb, yag,
          currentGun, currentOgun
        });
        
        // GÃ¼nlÃ¼k toplama ekle
        if (currentGun && gunMakrolari.has(currentGun)) {
          const gunTotal = gunMakrolari.get(currentGun);
          gunTotal.kalori += kalori;
          gunTotal.protein += protein;
          gunTotal.karb += karb;
          gunTotal.yag += yag;
          console.log('ğŸ“… GÃ¼n toplamÄ±na eklendi:', currentGun, 'yeni toplam:', gunTotal);
        } else {
          console.warn('âš ï¸ GÃ¼n bulunamadÄ± veya mevcut deÄŸil:', currentGun);
        }
        
        // Ã–ÄŸÃ¼n toplama ekle
        if (currentOgun !== null && ogunMakrolari.has(currentOgun)) {
          const ogunTotal = ogunMakrolari.get(currentOgun);
          ogunTotal.kalori += kalori;
          ogunTotal.protein += protein;
          ogunTotal.karb += karb;
          ogunTotal.yag += yag;
          console.log('ğŸ½ï¸ Ã–ÄŸÃ¼n toplamÄ±na eklendi:', currentOgun, 'yeni toplam:', ogunTotal);
        } else {
          console.warn('âš ï¸ Ã–ÄŸÃ¼n bulunamadÄ± veya mevcut deÄŸil:', currentOgun);
        }
      } else {
        if (!item) {
          console.log('âšª SÄ±ra numarasÄ± iÃ§in veri yok:', siraNo);
        } else if (!item.eslestiMi) {
          console.log('âšª EÅŸleÅŸmemiÅŸ yemek:', siraNo);
        } else if (item.gunOgunSatiri) {
          console.log('âšª GÃ¼n/Ã¶ÄŸÃ¼n satÄ±rÄ±:', siraNo);
        }
      }
    } else {
      console.log('âšª SÄ±ra numarasÄ± yok:', cellText.substring(0, 50));
    }
  });

  // GÃ¼n satÄ±rlarÄ±nÄ± gÃ¼ncelle
  console.log('ğŸ”„ GÃ¼n satÄ±rlarÄ± gÃ¼ncelleniyor, toplam gÃ¼n:', gunMakrolari.size);
  gunMakrolari.forEach((makro, gunAdi) => {
    console.log('ğŸ“… GÃ¼ncellenen gÃ¼n:', gunAdi, 'rowIndex:', makro.rowIndex, 'makrolar:', makro);
    const gunRow = tableRows[makro.rowIndex];
    if (gunRow) {
      const cells = gunRow.querySelectorAll('td');
      console.log('ğŸ“… GÃ¼n satÄ±rÄ±nda hÃ¼cre sayÄ±sÄ±:', cells.length);
      if (cells.length >= 5) {
        cells[1].innerHTML = `<strong style="color: #2196F3;">${makro.kalori.toFixed(0)}</strong>`;
        cells[2].innerHTML = `<strong style="color: #2196F3;">${makro.karb.toFixed(1)}</strong>`;
        cells[3].innerHTML = `<strong style="color: #2196F3;">${makro.protein.toFixed(1)}</strong>`;
        cells[4].innerHTML = `<strong style="color: #2196F3;">${makro.yag.toFixed(1)}</strong>`;
        console.log(`âœ… ${gunAdi} gÃ¼nÃ¼ gÃ¼ncellendi:`, makro);
      } else {
        console.warn('âš ï¸ GÃ¼n satÄ±rÄ±nda yeterli hÃ¼cre yok:', cells.length);
      }
    } else {
      console.warn('âš ï¸ GÃ¼n satÄ±rÄ± bulunamadÄ±, rowIndex:', makro.rowIndex);
    }
  });

  // Ã–ÄŸÃ¼n satÄ±rlarÄ±nÄ± gÃ¼ncelle
  ogunMakrolari.forEach((makro, ogunRowIndex) => {
    const ogunRow = tableRows[ogunRowIndex];
    if (ogunRow) {
      const cells = ogunRow.querySelectorAll('td');
      if (cells.length >= 5) {
        cells[1].innerHTML = `<strong style="color: #FF9800;">${makro.kalori.toFixed(0)}</strong>`;
        cells[2].innerHTML = `<strong style="color: #FF9800;">${makro.karb.toFixed(1)}</strong>`;
        cells[3].innerHTML = `<strong style="color: #FF9800;">${makro.protein.toFixed(1)}</strong>`;
        cells[4].innerHTML = `<strong style="color: #FF9800;">${makro.yag.toFixed(1)}</strong>`;
      }
    }
  });

  // GÃœNLÃœK ORTALAMA satÄ±rÄ±nÄ± gÃ¼ncelle
  console.log('ğŸ“Š GÃ¼nlÃ¼k ortalama satÄ±rÄ± aranÄ±yor...');
  
  // SADECE "GÃœNLÃœK ORTALAMA" text'i iÃ§eren satÄ±rÄ± bul
  let totalRow = null;
  const allRows = document.querySelectorAll('#veritabaniAnaliziContent table tbody tr');
  
  for (const row of allRows) {
    const firstCell = row.querySelector('td');
    if (firstCell && firstCell.textContent.includes('ğŸ“Š GÃœNLÃœK ORTALAMA')) {
      totalRow = row;
      console.log('ğŸ“Š GERÃ‡EK gÃ¼nlÃ¼k ortalama satÄ±rÄ± bulundu:', firstCell.textContent);
      break;
    }
  }
  
  // KaÃ§ tane gradient satÄ±rÄ± var kontrol et (debug iÃ§in)
  const allGradientRows = document.querySelectorAll('tr[style*="background: linear-gradient(135deg, #28a745, #20c997)"]');
  console.log('ğŸ“Š Toplam gradient satÄ±r sayÄ±sÄ±:', allGradientRows.length);
  
  console.log('ğŸ“Š GÃ¼nlÃ¼k ortalama satÄ±rÄ± bulundu mu?', !!totalRow);
  if (totalRow) {
    console.log('ğŸ“Š GÃ¼nlÃ¼k ortalama satÄ±rÄ±nÄ±n style:', totalRow.getAttribute('style'));
  }
  
  if (totalRow) {
    const cells = totalRow.querySelectorAll('td');
    console.log('ğŸ“Š GÃ¼nlÃ¼k ortalama satÄ±rÄ±nda hÃ¼cre sayÄ±sÄ±:', cells.length);
    if (cells.length >= 5) {
      const gunSayisi = gunMakrolari.size;
      console.log('ğŸ“Š Hesaplanacak gÃ¼n sayÄ±sÄ±:', gunSayisi);
      
      // TÃ¼m gÃ¼nlerin toplamÄ±nÄ± hesapla
      let toplamKalori = 0, toplamProtein = 0, toplamKarb = 0, toplamYag = 0;
      gunMakrolari.forEach((makro) => {
        toplamKalori += makro.kalori;
        toplamProtein += makro.protein;
        toplamKarb += makro.karb;
        toplamYag += makro.yag;
      });
      console.log('ğŸ“Š Toplam deÄŸerler:', { toplamKalori, toplamProtein, toplamKarb, toplamYag });
      
      if (gunSayisi > 0) {
        const ortKalori = (toplamKalori / gunSayisi).toFixed(0);
        const ortKarb = (toplamKarb / gunSayisi).toFixed(1);
        const ortProtein = (toplamProtein / gunSayisi).toFixed(1);
        const ortYag = (toplamYag / gunSayisi).toFixed(1);
        
        cells[0].innerHTML = `ğŸ“Š GÃœNLÃœK ORTALAMA (${gunSayisi} gÃ¼n)`;
        cells[1].innerHTML = ortKalori;
        cells[2].innerHTML = ortKarb;
        cells[3].innerHTML = ortProtein;
        cells[4].innerHTML = ortYag;
        
        // HÃ¼creleri force update et
        cells.forEach((cell, index) => {
          cell.style.backgroundColor = ''; // Renk sÄ±fÄ±rla
          cell.style.backgroundColor = '#28a745'; // Yeniden ata
        });
        
        console.log('âœ… GÃ¼nlÃ¼k ortalama hÃ¼creler gÃ¼ncellendi:', {
          gunSayisi,
          hucre0: cells[0].innerHTML,
          hucre1: cells[1].innerHTML,
          hucre2: cells[2].innerHTML,
          hucre3: cells[3].innerHTML,
          hucre4: cells[4].innerHTML,
          ortalama: { kalori: ortKalori, protein: ortProtein, karb: ortKarb, yag: ortYag }
        });
        
        console.log('ğŸ“Š DETAY: Kalori=' + ortKalori + ', Karb=' + ortKarb + ', Protein=' + ortProtein + ', YaÄŸ=' + ortYag);
      } else {
        console.warn('âš ï¸ GÃ¼n sayÄ±sÄ± 0, ortalama hesaplanamÄ±yor');
      }
    } else {
      console.warn('âš ï¸ GÃ¼nlÃ¼k ortalama satÄ±rÄ±nda yeterli hÃ¼cre yok:', cells.length);
    }
  } else {
    console.warn('âš ï¸ GÃ¼nlÃ¼k ortalama satÄ±rÄ± bulunamadÄ±! Selector: tr[style*="background: linear-gradient(135deg, #28a745, #20c997)"]');
    
    // Alternatif selector'lar deneyeceÄŸiz
    const alternativeSelectors = [
      'tr[style*="background: linear-gradient(135deg, #28a745, #20c997)"]',
      'tr[style*="#28a745"]',
      'tr:contains("GÃœNLÃœK ORTALAMA")',
      'tr td:contains("GÃœNLÃœK ORTALAMA")'
    ];
    
    alternativeSelectors.forEach((selector, index) => {
      const row = document.querySelector(selector);
      console.log(`ğŸ“Š Alternatif selector ${index + 1}:`, selector, 'â†’', !!row);
    });
  }
}

function alternatifYemekAc(index) {
  console.log('ï¿½ Toplam satÄ±rlarÄ± gÃ¼ncelleniyor...');
  
  if (!window.currentFoodAnalysisData) {
    return;
  }
  
  // Sadece eÅŸleÅŸen yemeklerin makrolarÄ±nÄ± topla
  let toplamKalori = 0;
  let toplamProtein = 0;
  let toplamKarb = 0;
  let toplamYag = 0;
  let eslesenSayisi = 0;
  
  window.currentFoodAnalysisData.forEach(item => {
    if (item.eslestiMi && item.eslesenYemek && !item.gunOgunSatiri) {
      const kalori = item.eslesenYemek.calories || 0;
      const protein = item.eslesenYemek.protein || 0;
      const karb = item.eslesenYemek.carbs || 0;
      const yag = item.eslesenYemek.fat || 0;
      
      toplamKalori += kalori;
      toplamProtein += protein;
      toplamKarb += karb;
      toplamYag += yag;
      eslesenSayisi++;
    }
  });
  
  // GÃœNLÃœK ORTALAMA satÄ±rÄ±nÄ± bul ve gÃ¼ncelle
  const totalRow = document.querySelector('tr[style*="linear-gradient(135deg, #28a745, #20c997)"]');
  if (totalRow) {
    const cells = totalRow.querySelectorAll('td');
    if (cells.length >= 5) {
      // GÃ¼n sayÄ±sÄ±nÄ± hesapla - eÄŸer gÃ¼nlÃ¼k veriler varsa onlarÄ± kullan
      const gunSayisi = 1; // BasitleÅŸtirilmiÅŸ versiyon
      
      cells[0].innerHTML = `ğŸ“Š GÃœNLÃœK ORTALAMA (${gunSayisi} gÃ¼n)`;
      cells[1].innerHTML = `${(toplamKalori / gunSayisi).toFixed(0)}`;
      cells[2].innerHTML = `${(toplamKarb / gunSayisi).toFixed(1)}`;
      cells[3].innerHTML = `${(toplamProtein / gunSayisi).toFixed(1)}`;
      cells[4].innerHTML = `${(toplamYag / gunSayisi).toFixed(1)}`;
      
      console.log('âœ… Toplam satÄ±rlarÄ± gÃ¼ncellendi:', {
        toplamKalori,
        toplamProtein,
        toplamKarb,
        toplamYag,
        eslesenSayisi,
        gunSayisi
      });
    }
  }
  
  // Ã–ÄŸÃ¼n toplam satÄ±rlarÄ±nÄ± da bul ve gÃ¼ncelle
  const ogunRows = document.querySelectorAll('tr[style*="background: #ffc107"]');
  ogunRows.forEach(ogunRow => {
    const cells = ogunRow.querySelectorAll('td');
    if (cells.length >= 5 && cells[0].textContent.includes('ğŸ½ï¸')) {
      // Bu Ã¶ÄŸÃ¼nÃ¼n yemeklerini topla - burada basit bir hesaplama yapÄ±yoruz
      // GerÃ§ek implementasyonda Ã¶ÄŸÃ¼n bazÄ±nda detaylÄ± hesaplama yapÄ±labilir
      let ogunKalori = 0, ogunProtein = 0, ogunKarb = 0, ogunYag = 0;
      
      // Bu Ã¶ÄŸÃ¼nle ilgili yemekleri bul (Ã¶ÄŸÃ¼n adÄ±nÄ± parse ederek)
      const ogunText = cells[0].textContent;
      window.currentFoodAnalysisData.forEach(item => {
        if (item.eslestiMi && item.eslesenYemek && !item.gunOgunSatiri) {
          // Ã–ÄŸÃ¼n eÅŸleÅŸtirmesi iÃ§in basit kontrol
          ogunKalori += (item.eslesenYemek.calories || 0) * 0.25; // GeÃ§ici hesaplama
          ogunProtein += (item.eslesenYemek.protein || 0) * 0.25;
          ogunKarb += (item.eslesenYemek.carbs || 0) * 0.25;
          ogunYag += (item.eslesenYemek.fat || 0) * 0.25;
        }
      });
      
      cells[1].innerHTML = `<strong>${ogunKalori.toFixed(0)}</strong>`;
      cells[2].innerHTML = `<strong>${ogunKarb.toFixed(1)}</strong>`;
      cells[3].innerHTML = `<strong>${ogunProtein.toFixed(1)}</strong>`;
      cells[4].innerHTML = `<strong>${ogunYag.toFixed(1)}</strong>`;
    }
  });
}

// Alternatif mod aÃ§Ä±kken yeniden tÄ±klanÄ±rsa sonraki alternatife geÃ§
function alternatifYemekAc(index) {
  // EÄŸer aynÄ± yemek iÃ§in alternatif mod zaten aktifse, sonraki alternatife geÃ§
  if (alternativeModeActive && currentAlternativeIndex === index) {
    sonrakiAlternatifeGec();
    
    // SeÃ§imi hemen uygula (otomatik seÃ§im modu)
    if (alternativeFoods && alternativeFoods.length > 0) {
      const currentStep = (currentAlternativeStep - 1) % alternativeFoods.length;
      alternatifSec(currentStep);
    }
    return;
  }
  
  // BaÅŸka bir yemek iÃ§in alternatif mod baÅŸlatÄ±lÄ±yorsa, Ã¶ncekini durdur
  if (alternativeModeActive && currentAlternativeIndex !== index) {
    alternatifleriDurdur();
  }
  
  // Yeni alternatif mod baÅŸlat - orijinal kodu Ã§aÄŸÄ±r
  console.log('ğŸ”„ Alternatif yemek sistemi baÅŸlatÄ±lÄ±yor, index:', index);
  
  if (!window.currentFoodAnalysisData || !window.currentFoodAnalysisData[index]) {
    console.error('âŒ Yemek verisi bulunamadÄ±, index:', index);
    showToast('Yemek verisi bulunamadÄ±!', 'error');
    return;
  }
  
  const item = window.currentFoodAnalysisData[index];
  
  if (!item.eslestiMi || !item.eslesenYemek) {
    showToast('Sadece eÅŸleÅŸen yemekler iÃ§in alternatif Ã¶nerileri yapÄ±labilir!', 'warning');
    return;
  }
  
  console.log('ğŸ¯ Alternatif aranacak yemek:', item.eslesenYemek);
  
  // Mevcut durumu kaydet
  originalFoodData = { ...item.eslesenYemek };
  currentAlternativeIndex = index;
  currentAlternativeStep = 0;
  
  // Alternatif yemekleri bulup uygula
  alternatifleriBaslat(item.eslesenYemek);
}

function alternatifSec(index) {
  if (!alternativeModeActive) {
    console.warn('âš ï¸ Alternatif mod aktif deÄŸil!');
    return;
  }
  
  console.log('ğŸ¯ Alternatif seÃ§ildi:', index);
  console.log('ğŸ” currentAlternativeIndex:', currentAlternativeIndex);
  console.log('ğŸ” window.currentFoodAnalysisData uzunluÄŸu:', window.currentFoodAnalysisData?.length);
  
  const currentItem = window.currentFoodAnalysisData[currentAlternativeIndex];
  if (!currentItem) {
    console.error('âŒ currentItem bulunamadÄ±! currentAlternativeIndex:', currentAlternativeIndex);
    return;
  }
  
  console.log('ğŸ” Ä°ÅŸlenecek item:', currentItem);
  
  if (index === 'original') {
    // Orijinal yemeÄŸi seÃ§
    if (originalFoodData) {
      currentItem.eslesenYemek = { ...originalFoodData };
      currentAlternativeStep = 0; // Orijinal iÃ§in step sÄ±fÄ±rla
      console.log('â†©ï¸ Orijinal yemek seÃ§ildi:', originalFoodData.originalName);
      showToast(`â†©ï¸ ${originalFoodData.originalName} seÃ§ildi`, 'success', 1500);
    }
  } else {
    // Alternatif yemek seÃ§
    const selectedFood = alternativeFoods[index];
    if (selectedFood) {
      currentItem.eslesenYemek = {
        ...selectedFood,
        originalName: selectedFood.name
      };
      currentAlternativeStep = index + 1;
      console.log('ğŸ”„ Alternatif yemek seÃ§ildi:', selectedFood.name);
      console.log('ğŸ” GÃ¼ncellenen currentItem:', currentItem);
      console.log('ğŸ Yeni makrolar: Kalori=' + selectedFood.calories + ', Protein=' + selectedFood.protein + ', Karb=' + selectedFood.carbs + ', YaÄŸ=' + selectedFood.fat);
      
      const scoreText = selectedFood.similarityScore ? ` (${selectedFood.similarityScore.toFixed(1)}% benzer)` : '';
      showToast(`ğŸ”„ ${selectedFood.name} seÃ§ildi${scoreText}`, 'info', 1500);
    }
  }
  
  // UI'yi gÃ¼ncelle - sadece sidebar'Ä± gÃ¼ncelle, tablo yeniden render edilmesin
  updateAlternativeControls();
  
  // Tabloyu elle gÃ¼ncelle (updateYemekVeritabaniAnalizi Ã§aÄŸÄ±rmadan)
  console.log('ğŸ”§ updateFoodTableRow Ã§aÄŸrÄ±lÄ±yor, index:', currentAlternativeIndex);
  updateFoodTableRow(currentAlternativeIndex, currentItem);
  
  // GÃ¼nlÃ¼k ortalama gÃ¼ncellenmesini zorunlu kÄ±l
  setTimeout(() => {
    console.log('ğŸ”„ Alternatif seÃ§imi sonrasÄ± gÃ¼nlÃ¼k ortalama zorla gÃ¼ncelleniyor...');
    updateTotalRows();
  }, 100);
}

// Global fonksiyonlarÄ± ekle
window.alternatifYemekAc = alternatifYemekAc;
window.alternatifleriDurdur = alternatifleriDurdur;
window.orijinalYemegiGeriYukle = orijinalYemegiGeriYukle;
window.updateAlternativeControls = updateAlternativeControls;
window.alternatifSec = alternatifSec;

// Global fonksiyonlarÄ± window objesine ata
window.yemekDuzenleModalAc = yemekDuzenleModalAc;
window.yemekSil = yemekSil;

// ğŸ§® KALORÄ° HESAPLAMA FONKSÄ°YONU
function hesaplaKalori() {
  // Besin deÄŸerlerini al
  const protein = parseFloat(document.getElementById('yemekProtein').value) || 0;
  const karb = parseFloat(document.getElementById('yemekKarb').value) || 0;
  const yag = parseFloat(document.getElementById('yemekYag').value) || 0;
  
  // Kalori hesapla: Protein=4kcal/g, Karb=4kcal/g, YaÄŸ=9kcal/g
  const proteinKalori = protein * 4;
  const karbKalori = karb * 4;
  const yagKalori = yag * 9;
  const toplam = proteinKalori + karbKalori + yagKalori;
  
  // Kalori input'unu gÃ¼ncelle
  const kaloriInput = document.getElementById('yemekKalori');
  kaloriInput.value = toplam.toFixed(1);
  
  // Visual feedback - hesaplama animasyonu (aÃ§Ä±k yeÅŸil tema)
  kaloriInput.style.background = '#a8d8a8';
  kaloriInput.style.borderColor = '#28a745';
  setTimeout(() => {
    kaloriInput.style.background = '#d4f4dd';
    kaloriInput.style.borderColor = '#28a745';
  }, 500);
  
  // DetaylÄ± hesaplama bilgisi iÃ§in title tooltip
  kaloriInput.title = `Hesaplama DetayÄ±:\n` +
    `â€¢ Protein: ${protein}g Ã— 4 = ${proteinKalori.toFixed(1)} kcal\n` +
    `â€¢ Karbonhidrat: ${karb}g Ã— 4 = ${karbKalori.toFixed(1)} kcal\n` +
    `â€¢ YaÄŸ: ${yag}g Ã— 9 = ${yagKalori.toFixed(1)} kcal\n` +
    `â€¢ TOPLAM: ${toplam.toFixed(1)} kcal`;
  
  console.log(`ğŸ§® Kalori hesaplandÄ±: P:${protein}g (${proteinKalori.toFixed(1)}kcal) + K:${karb}g (${karbKalori.toFixed(1)}kcal) + Y:${yag}g (${yagKalori.toFixed(1)}kcal) = ${toplam.toFixed(1)}kcal`);
}

// Global fonksiyon yap
window.hesaplaKalori = hesaplaKalori;

function yemekFormDoldur(data) {
  console.log('ğŸ” Form dolduruluyor, data:', data);
  
  // Temel bilgiler
  const isim = data.name || data.ad || data.originalName || '';
  document.getElementById('yemekAdi').value = isim;
  // EÅŸleÅŸtirme sekmesi aÃ§Ä±kken baÅŸlÄ±klarÄ± da gÃ¼ncel tut
  try {
    if (isim) {
      const hedef1 = document.getElementById('eslestirYemekAdi');
      const hedef2 = document.getElementById('pdfYemekAdi');
      if (hedef1) hedef1.textContent = isim;
      if (hedef2) hedef2.textContent = isim;
    }
  } catch {}
  
  // Kategori debug
  console.log('ğŸ” Gelen kategori:', data.category);
  
  // Kategori eÅŸleÅŸtirme tablosu
  const kategoriEslestirme = {
    'Ã–ÄLEN': 'OGLE',
    'KAHVALTI': 'KAHVALTI',
    'AKÅAM': 'AKSAM',
    'APERATIF': 'APERATIF',
    'TATLI': 'TATLI',
    'Ä°Ã‡ECEK': 'ICECEK',
    'SALATA': 'SALATA',
    'Ã‡ORBALAR': 'CORBALAR',
    'SEBZE': 'SEBZE',
    'ET': 'ET',
    'BALIK': 'BALIK',
    'TAVUK': 'TAVUK'
  };
  
  const kategoriSelect = document.getElementById('yemekKategori');
  const gelenKategori = data.category || '';
  const eslesmisKategori = kategoriEslestirme[gelenKategori] || gelenKategori;
  
  kategoriSelect.value = eslesmisKategori;
  console.log('ğŸ” Gelen kategori:', gelenKategori);
  console.log('ğŸ” EÅŸleÅŸmiÅŸ kategori:', eslesmisKategori);
  console.log('ğŸ” Select value set to:', kategoriSelect.value);
  console.log('ğŸ” Select selectedIndex:', kategoriSelect.selectedIndex);
  
  // Besin deÄŸerleri - Ã–nce makrolarÄ± set et, sonra kaloriyi hesapla
  document.getElementById('yemekProtein').value = data.protein || 0;
  document.getElementById('yemekKarb').value = data.carbs || 0;
  document.getElementById('yemekYag').value = data.fat || 0;
  
  // EÄŸer kalori verisi varsa onu kullan, yoksa hesapla
  if (data.calories && data.calories > 0) {
    document.getElementById('yemekKalori').value = data.calories;
  } else {
    // Kaloriyi makrolardan hesapla (timeout ile DOM gÃ¼ncellemesini bekle)
    setTimeout(() => {
      hesaplaKalori();
    }, 100);
  }
  
  // Porsiyon bilgileri
  document.getElementById('yemekMinMiktar').value = data.minQuantity || 0.5;
  document.getElementById('yemekMaxMiktar').value = data.maxQuantity || 1;
  document.getElementById('yemekAdim').value = data.step || 0.5;
  document.getElementById('yemekCarpan').value = data.multiplier || 1;
  
  // Rol
  document.getElementById('yemekRol').value = data.role || 'mainDish';
  
  // Ã–ÄŸÃ¼n tÃ¼rleri
  const mealTypes = data.mealType || [];
  console.log('ğŸ” MealTypes:', mealTypes);
  document.getElementById('yemekKahvalti').checked = mealTypes.includes('breakfast');
  document.getElementById('yemekOgle').checked = mealTypes.includes('lunch');
  document.getElementById('yemekAksam').checked = mealTypes.includes('dinner');
  
  // Diyet Ã¶zellikleri
  console.log('ğŸ” Keto:', data.keto, 'LowCarb:', data.lowcarb);
  document.getElementById('yemekKeto').checked = data.keto || false;
  document.getElementById('yemekLowCarb').checked = data.lowcarb || false;
  document.getElementById('yemekPorsiyonSabit').checked = data.portionFixed || false;
  
  // Filler Ã¶zellikleri
  console.log('ğŸ” FillerLunch:', data.fillerLunch, 'FillerDinner:', data.fillerDinner);
  document.getElementById('yemekFillerOgle').checked = data.fillerLunch || false;
  document.getElementById('yemekFillerAksam').checked = data.fillerDinner || false;
  
  // Etiketler
  console.log('ğŸ” Tags:', data.tags, 'CompatibilityTags:', data.compatibilityTags);
  document.getElementById('yemekEtiketler').value = (data.tags || []).join(', ');
  document.getElementById('yemekUyumluluk').value = (data.compatibilityTags || []).join(', ');
  
  // Sezon bilgileri
  document.getElementById('yemekSezon').value = data.seasonRange || '[1,12]';
  document.getElementById('yemekTersSezon').checked = data.isReversedSeason || false;
}

function yemekModalKapat(event) {
  if (event && event.target !== event.currentTarget) return;
  
  const modal = document.getElementById('yemekDuzenleModal');
  modal.style.display = 'none';
  
  // Modal state'ini temizle
  secilenYemek = null;
  aktifFiltre = 'all';
  
  // SeÃ§imleri temizle
  const secilenKart = document.querySelector('.yemek-kart.selected');
  if (secilenKart) {
    secilenKart.classList.remove('selected');
  }
  
  // SeÃ§ilen yemek bilgisini gizle
  document.getElementById('secilenYemekBilgi').style.display = 'none';
  
  // Alias checkbox'Ä±nÄ± sÄ±fÄ±rla
  document.getElementById('aliasEkleCheckbox').checked = false;
  document.getElementById('aliasEklemeAlani').style.display = 'none';
  
  // Arama alanÄ±nÄ± temizle
  document.getElementById('yemekAramaInput').value = '';
  
  // Filtreleri sÄ±fÄ±rla
  const tÃ¼mButonlar = document.querySelectorAll('.hizli-filtre');
  tÃ¼mButonlar.forEach(btn => {
    btn.classList.remove('active');
    if (btn.dataset.filtre === 'all') {
      btn.classList.add('active');
    }
  });
}

// ID GENERATOR FONKSÄ°YONU
function generateId() {
  return 'food_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
}

async function yemekKaydet() {
  const modal = document.getElementById('yemekDuzenleModal');
  const mod = modal.dataset.mod;
  // Orijinal veri (duzenle modunda gÃ¼ncelleme iÃ§in gerekli)
  let originalData = {};
  try { originalData = JSON.parse(modal.dataset.originalData || '{}'); } catch {}
  
  try {
    // Form verilerini topla
    const yemekData = yemekFormVerileriniAl();
    
    if (!yemekData.name.trim()) {
      alert('Yemek adÄ± boÅŸ olamaz!');
      return;
    }
    
    if (!yemekData.category) {
      alert('Kategori seÃ§ilmelidir!');
      return;
    }
    
  // GitHub'a kaydet (orijinal veri ile)
  const basarili = await yemekGithubKaydet(yemekData, mod, originalData);
    
    if (basarili) {
      showToast(mod === 'ekle' ? 'Yemek baÅŸarÄ±yla eklendi!' : 'Yemek baÅŸarÄ±yla gÃ¼ncellendi!', 'success');
      yemekModalKapat();
      
      // Hemen render'Ä± gÃ¼ncelle - yeni yemek verileri ile
      console.log('ğŸ”„ Yemek kaydedildi, render gÃ¼ncelleniyor...');
      
      // 1. Yemek veritabanÄ± analizini gÃ¼ncelle
      setTimeout(() => {
        updateYemekVeritabaniAnalizi();
      }, 500);
      
      // 2. EÅŸleÅŸmeyen tarifler listesini gÃ¼ncelle
      setTimeout(() => {
        eslesmeyenlerListesiniGuncelle();
      }, 1000);
      
      // 3. Aktif hafta iÃ§in eÅŸleÅŸen kartlarÄ± yeniden kontrol et
      setTimeout(() => {
        if (typeof window.seciliHasta !== 'undefined' && window.seciliHasta) {
          otomatikEsleHafta();
        }
      }, 1500);
      
      // 4. Sidebar'daki kartlarÄ± gÃ¼ncelle
      setTimeout(() => {
        if (typeof window.aktifHaftaIndex !== 'undefined' && window.aktifHaftaIndex !== null) {
          gosterEslesenKartlarSidebar(window.aktifHaftaIndex);
        }
      }, 2000);
      
    } else {
      showToast('Kaydetme iÅŸlemi baÅŸarÄ±sÄ±z!', 'error');
    }
    
  } catch (error) {
    console.error('âŒ Yemek kaydetme hatasÄ±:', error);
    showToast('Beklenmeyen bir hata oluÅŸtu!', 'error');
  }
}

function yemekFormVerileriniAl() {
  // Ã–ÄŸÃ¼n tÃ¼rlerini topla
  const mealTypes = [];
  if (document.getElementById('yemekKahvalti').checked) mealTypes.push('breakfast');
  if (document.getElementById('yemekOgle').checked) mealTypes.push('lunch');
  if (document.getElementById('yemekAksam').checked) mealTypes.push('dinner');
  
  // Etiketleri iÅŸle
  const tags = document.getElementById('yemekEtiketler').value
    .split(',')
    .map(tag => tag.trim())
    .filter(tag => tag.length > 0);
    
  const compatibilityTags = document.getElementById('yemekUyumluluk').value
    .split(',')
    .map(tag => tag.trim())
    .filter(tag => tag.length > 0);
  
  return {
    name: document.getElementById('yemekAdi').value.trim(),
    category: document.getElementById('yemekKategori').value,
    calories: parseFloat(document.getElementById('yemekKalori').value) || 0,
    protein: parseFloat(document.getElementById('yemekProtein').value) || 0,
    carbs: parseFloat(document.getElementById('yemekKarb').value) || 0,
    fat: parseFloat(document.getElementById('yemekYag').value) || 0,
    minQuantity: parseFloat(document.getElementById('yemekMinMiktar').value) || 0.5,
    maxQuantity: parseFloat(document.getElementById('yemekMaxMiktar').value) || 1,
    step: parseFloat(document.getElementById('yemekAdim').value) || 0.5,
    multiplier: parseFloat(document.getElementById('yemekCarpan').value) || 1,
    role: document.getElementById('yemekRol').value,
    mealType: mealTypes,
    keto: document.getElementById('yemekKeto').checked,
    lowcarb: document.getElementById('yemekLowCarb').checked,
    portionFixed: document.getElementById('yemekPorsiyonSabit').checked,
    fillerLunch: document.getElementById('yemekFillerOgle').checked,
    fillerDinner: document.getElementById('yemekFillerAksam').checked,
    tags: tags,
    compatibilityTags: compatibilityTags,
    seasonRange: document.getElementById('yemekSezon').value || '[1,12]',
    isReversedSeason: document.getElementById('yemekTersSezon').checked
  };
}

async function yemekGithubKaydet(yemekData, mod, originalData = {}) {
  try {
    const token = document.getElementById('githubToken').value.trim();
    
    if (!token) {
      alert('âš ï¸ GitHub token gerekli!\nSaÄŸ Ã¼st kÃ¶ÅŸeden GitHub token\'Ä±nÄ±zÄ± girin.');
      return false;
    }

    // GitHub'dan mevcut food_list.json'Ä± al
    console.log('ğŸ“¥ GitHub\'dan mevcut food_list.json alÄ±nÄ±yor...');
    
    // ğŸ”„ Raw URL kullan encoding sorunlarÄ± iÃ§in
    const rawResponse = await fetch(`https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli-3/refs/heads/main/food_list.json?nocache=${Date.now()}&t=${Math.random()}`);
    if (!rawResponse.ok) {
      throw new Error('food_list.json dosyasÄ± GitHub\'dan alÄ±namadÄ± (raw)');
    }
    const currentContent = await rawResponse.json();
    console.log('  Raw food_list.json yÃ¼klendi:', Object.keys(currentContent));
    console.log('ğŸ•µï¸ DEBUG: Raw ilk yemek:', currentContent.categories?.[0]?.items?.[0]);
    
    // GitHub API'dan sadece SHA al
    const getResponse = await fetch('https://api.github.com/repos/mustafasacar35/lipodem-takip-paneli-3/contents/food_list.json', {
      headers: {
        'Authorization': `token ${token}`,
        'Accept': 'application/vnd.github.v3+json'
      }
    });

    if (!getResponse.ok) {
      throw new Error('food_list.json SHA bilgisi alÄ±namadÄ±');
    }

  const fileData = await getResponse.json();
  console.log('ğŸ•µï¸ DEBUG: GitHub API dosya SHA:', fileData.sha);

    // YardÄ±mcÄ±: TR normalize (eÅŸleÅŸtirme iÃ§in)
    const normTr = (s) => (s || '')
      .toString()
      .toLowerCase()
      .replace(/Ã§/g, 'c').replace(/ÄŸ/g, 'g').replace(/ÅŸ/g, 's')
      .replace(/Ã¼/g, 'u').replace(/Ã¶/g, 'o').replace(/Ä±/g, 'i').replace(/iÌ‡/g, 'i')
      .replace(/\s+/g, ' ') // iÃ§ boÅŸluklarÄ± sadeleÅŸtir
      .trim();

    // Yeni yemeÄŸi uygun kategoriye ekle/gÃ¼ncelle
    let kategoriIndex = currentContent.categories.findIndex(cat => cat.name === yemekData.category);
    
    if (kategoriIndex === -1) {
      // Kategori yoksa oluÅŸtur
      currentContent.categories.push({
        name: yemekData.category,
        items: []
      });
      kategoriIndex = currentContent.categories.length - 1;
      console.log('â• Yeni kategori oluÅŸturuldu:', yemekData.category);
    }

    if (mod === 'ekle') {
      // Yeni yemek ekle
      currentContent.categories[kategoriIndex].items.push(yemekData);
      console.log('â• Yeni yemek eklendi:', yemekData.name);
    } else {
      // Mevcut yemeÄŸi gÃ¼ncelle: Ã¶nce orijinal adÄ±/kategorisi ile ara, yoksa isim-normalize eÅŸleÅŸmesi yap
      const originalName = originalData.originalName || originalData.name || yemekData.name;
      const originalCategory = originalData.category || yemekData.category;

      // 1) Orijinal kategoride ara
      let found = false;
      let fromCategoryIdx = currentContent.categories.findIndex(cat => cat.name === originalCategory);
      if (fromCategoryIdx !== -1) {
        let items = currentContent.categories[fromCategoryIdx].items;
        let idx = items.findIndex(it => normTr(it.name) === normTr(originalName));
        if (idx !== -1) {
          // Kategori deÄŸiÅŸmiÅŸse taÅŸÄ±
          if (fromCategoryIdx !== kategoriIndex) {
            const [removed] = items.splice(idx, 1);
            currentContent.categories[kategoriIndex].items.push({ ...yemekData });
            console.log(`ğŸ”€ Yemek kategori deÄŸiÅŸti: ${originalCategory} â†’ ${yemekData.category}`);
          } else {
            // AynÄ± kategoride gÃ¼ncelle
            items[idx] = yemekData;
            console.log('ğŸ’¾ Yemek gÃ¼ncellendi (aynÄ± kategori):', yemekData.name);
          }
          found = true;
        }
      }

      // 2) BulunamadÄ±ysa tÃ¼m kategorilerde normalize isimle tara (Ã§ift kaydÄ± Ã¶nle)
      if (!found) {
        outer: for (let c = 0; c < currentContent.categories.length; c++) {
          const items = currentContent.categories[c].items;
          for (let i = 0; i < items.length; i++) {
            if (normTr(items[i].name) === normTr(originalName)) {
              if (c !== kategoriIndex) {
                const [removed] = items.splice(i, 1);
                currentContent.categories[kategoriIndex].items.push({ ...yemekData });
                console.log(`ğŸ”€ Yemek kategori taÅŸÄ±ndÄ± (genel arama): ${currentContent.categories[c].name} â†’ ${yemekData.category}`);
              } else {
                items[i] = yemekData;
                console.log('ğŸ’¾ Yemek gÃ¼ncellendi (genel arama):', yemekData.name);
              }
              found = true;
              break outer;
            }
          }
        }
      }

      // 3) HÃ¢lÃ¢ bulunamadÄ±ysa, mevcut kategoride aynÄ± isim var mÄ±? Onu gÃ¼ncelle; yoksa ekle
      if (!found) {
        const items = currentContent.categories[kategoriIndex].items;
        const idx = items.findIndex(it => normTr(it.name) === normTr(yemekData.name));
        if (idx !== -1) {
          items[idx] = yemekData;
          console.log('ğŸ’¾ Yemek gÃ¼ncellendi (fallback):', yemekData.name);
        } else {
          console.warn('âš ï¸ GÃ¼ncellenecek yemek bulunamadÄ±, yeni olarak ekleniyor');
          items.push(yemekData);
        }
      }
    }

    // GÃ¼ncellenmiÅŸ iÃ§eriÄŸi GitHub'a gÃ¶nder (TÃ¼rkÃ§e karakter uyumlu)
  const updatedContent = encodeUTF8ToBase64(currentContent);
    
    const updateResponse = await fetch('https://api.github.com/repos/mustafasacar35/lipodem-takip-paneli-3/contents/food_list.json', {
      method: 'PUT',
      headers: {
        'Authorization': `token ${token}`,
        'Accept': 'application/vnd.github.v3+json',
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        message: mod === 'ekle' ? 
          `ğŸ½ï¸ Yeni yemek eklendi: ${yemekData.name}` : 
          `ğŸ’¾ Yemek gÃ¼ncellendi: ${yemekData.name}`,
        content: updatedContent,
        sha: fileData.sha
      })
    });

    if (!updateResponse.ok) {
      const errorData = await updateResponse.json();
      throw new Error(`GitHub gÃ¼ncelleme hatasÄ±: ${errorData.message}`);
    }

    console.log('âœ… food_list.json GitHub\'a baÅŸarÄ±yla kaydedildi');
    
    // ğŸ•µï¸ DEBUG: Kaydetme sonrasÄ± RAW URL'den kontrol et
    setTimeout(async () => {
      try {
        console.log('ğŸ•µï¸ DEBUG: Kaydetme sonrasÄ± RAW URL kontrolÃ¼ yapÄ±lÄ±yor...');
        const checkResponse = await fetch(`https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli-3/refs/heads/main/food_list.json?check=${Date.now()}`);
        
        if (checkResponse.ok) {
          const checkContent = await checkResponse.json();
          console.log('ğŸ•µï¸ DEBUG: Kaydetme sonrasÄ± RAW ilk yemek:', checkContent.categories?.[0]?.items?.[0]);
          
          // Kaydedilen yemeÄŸi bul
          let bulunan = false;
          checkContent.categories.forEach(cat => {
            cat.items.forEach(item => {
              if (item.name === yemekData.name) {
                console.log('âœ… DEBUG: Kaydedilen yemek RAW URL\'de BULUNDU:', item);
                bulunan = true;
              }
            });
          });
          
          if (!bulunan) {
            console.error('ğŸš¨ DEBUG: Kaydedilen yemek RAW URL\'de BULUNAMADI!');
          }
        }
      } catch (err) {
        console.error('ğŸš¨ DEBUG: Kaydetme sonrasÄ± RAW kontrol hatasÄ±:', err);
      }
    }, 3000);
    
    // Otomatik senkronizasyon tetikle
    yemekKaydetSonrasiSenkronizasyon();
    
    return true;
    
  } catch (error) {
    console.error('âŒ GitHub kaydetme hatasÄ±:', error);
    
    // Hata detaylarÄ±nÄ± kullanÄ±cÄ±ya gÃ¶ster
    if (error.message.includes('404')) {
      alert('âŒ Dosya bulunamadÄ±!\nRepo adresini kontrol edin: mustafasacar35/lipodem-takip-paneli-3');
    } else if (error.message.includes('401') || error.message.includes('403')) {
      alert('âŒ Yetki hatasÄ±!\nGitHub token\'Ä±nÄ±zÄ± kontrol edin.');
    } else {
      alert(`âŒ Beklenmeyen hata:\n${error.message}`);
    }
    
    return false;
  }
}

// ğŸ—‘ï¸ YEMEK SÄ°LME FONKSÄ°YONU
async function yemekSil(yemekData) {
  const onay = confirm(`âš ï¸ "${yemekData.originalName}" yemeÄŸini silmek istediÄŸinizden emin misiniz?\n\nBu iÅŸlem geri alÄ±namaz!`);
  
  if (!onay) return;
  
  try {
    const token = document.getElementById('githubToken').value.trim();
    
    if (!token) {
      alert('âš ï¸ GitHub token gerekli!\nSaÄŸ Ã¼st kÃ¶ÅŸeden GitHub token\'Ä±nÄ±zÄ± girin.');
      return;
    }

    console.log('ğŸ—‘ï¸ Yemek siliniyor:', yemekData);

    // GitHub'dan mevcut food_list.json'Ä± al
    const getResponse = await fetch('https://api.github.com/repos/mustafasacar35/lipodem-takip-paneli-3/contents/food_list.json', {
      headers: {
        'Authorization': `token ${token}`,
        'Accept': 'application/vnd.github.v3+json'
      }
    });

    if (!getResponse.ok) {
      throw new Error('food_list.json dosyasÄ± GitHub\'dan alÄ±namadÄ±');
    }

  const fileData = await getResponse.json();
  const currentContent = JSON.parse(decodeBase64UTF8(fileData.content));
    
    // YemeÄŸi bul ve sil
    let silindi = false;
    
    for (let kategori of currentContent.categories) {
      const itemIndex = kategori.items.findIndex(item => 
        item.name === yemekData.originalName || item.name === yemekData.name
      );
      
      if (itemIndex !== -1) {
        kategori.items.splice(itemIndex, 1);
        silindi = true;
        console.log('ğŸ—‘ï¸ Yemek silindi:', yemekData.originalName || yemekData.name);
        break;
      }
    }

    if (!silindi) {
      alert('âŒ Silinecek yemek bulunamadÄ±!');
      return;
    }

    // GÃ¼ncellenmiÅŸ iÃ§eriÄŸi GitHub'a gÃ¶nder (TÃ¼rkÃ§e karakter uyumlu)
  const updatedContent = encodeUTF8ToBase64(currentContent);
    
    const updateResponse = await fetch('https://api.github.com/repos/mustafasacar35/lipodem-takip-paneli-3/contents/food_list.json', {
      method: 'PUT',
      headers: {
        'Authorization': `token ${token}`,
        'Accept': 'application/vnd.github.v3+json',
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        message: `ğŸ—‘ï¸ Yemek silindi: ${yemekData.originalName || yemekData.name}`,
        content: updatedContent,
        sha: fileData.sha
      })
    });

    if (!updateResponse.ok) {
      const errorData = await updateResponse.json();
      throw new Error(`GitHub gÃ¼ncelleme hatasÄ±: ${errorData.message}`);
    }

    showToast('Yemek baÅŸarÄ±yla silindi!', 'success');
    console.log('âœ… Yemek GitHub\'dan baÅŸarÄ±yla silindi');
    
    // VeritabanÄ± analizini gÃ¼ncelle
    setTimeout(() => {
      updateYemekVeritabaniAnalizi();
    }, 1000);
    
  } catch (error) {
    console.error('âŒ Yemek silme hatasÄ±:', error);
    
    if (error.message.includes('404')) {
      alert('âŒ Dosya bulunamadÄ±!\nRepo adresini kontrol edin.');
    } else if (error.message.includes('401') || error.message.includes('403')) {
      alert('âŒ Yetki hatasÄ±!\nGitHub token\'Ä±nÄ±zÄ± kontrol edin.');
    } else {
      alert(`âŒ Silme hatasÄ±:\n${error.message}`);
    }
  }
}

    function gptMesajKaydet(i) {
      const hafta = getHaftaListesi()[i];
      
      // Kilit kontrolÃ¼
      if (hafta.kilitli) {
        alert('ğŸ”’ Bu hafta kilitli! GPT mesajÄ±nÄ± deÄŸiÅŸtirmek iÃ§in Ã¶nce kilidi aÃ§Ä±n.');
        return;
      }
      
      hafta.gptMesaj = document.getElementById('gptMesaj_' + i).value;
      saveToStorage();
      
      console.log('âœ… GPT mesajÄ± kaydedildi hafta:', i + 1);
      
      // YENÄ° SÄ°STEM: GitHub'a da kaydet
      if (seciliHasta) {
        hastayiAyriKaydet(seciliHasta).then(basarili => {
          if (basarili) {
            console.log('âœ… GPT mesajÄ± GitHub\'a da kaydedildi');
          } else {
            console.warn('âš ï¸ GPT mesajÄ± localStorage\'a kaydedildi ama GitHub kaydÄ± baÅŸarÄ±sÄ±z');
          }
        }).catch(error => {
          console.error('âŒ GitHub kaydetme hatasÄ±:', error);
        });
      }
      
      showToast('ğŸ’¾ Hafta mesajÄ± kaydedildi!');
    }
    // --- JSON dÄ±ÅŸa aktar/yÃ¼kle fonksiyonlarÄ± ---
    function exportData() {
      // KullanÄ±cÄ±ya seÃ§enek sun
      const tariflerDahil = confirm('Tarif verilerini de dahil etmek istiyor musunuz?\n\nâœ… EVET: Tam veri (daha bÃ¼yÃ¼k dosya)\nâŒ HAYIR: Sadece Ã¶nemli veriler (kÃ¼Ã§Ã¼k dosya, GitHub ile uyumlu)');
      
      let dataToExport;
      
      if (tariflerDahil) {
        // TÃ¼m veriler dahil
        dataToExport = hastalar;
        console.log('ğŸ“¤ Tam veriler (tarifler dahil) JSON olarak hazÄ±rlanÄ±yor...');
      } else {
        // Tarifler olmadan
        dataToExport = hastalar.map(hasta => {
          return {
            ...hasta,
            haftalar: (hasta.haftalar || []).map(hafta => {
              const { tarifler, ...haftaWithoutTarifler } = hafta;
              return haftaWithoutTarifler;
            })
          };
        });
        console.log('ğŸ“¤ Kompakt veriler (tarifler hariÃ§) JSON olarak hazÄ±rlanÄ±yor...');
      }
      
      const dataStr = JSON.stringify(dataToExport, null, 2);
      const blob = new Blob([dataStr], {type: 'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = tariflerDahil ? 'hasta_kayitlari_tam.json' : 'hasta_kayitlari.json';
      document.body.appendChild(a);
      a.click();
      setTimeout(() => { document.body.removeChild(a); URL.revokeObjectURL(url); }, 100);
      
      console.log('ğŸ“¤ Hasta verileri JSON olarak indirildi:', tariflerDahil ? '(tam veri)' : '(kompakt veri)');
      console.log('ğŸ’¾ Data klasÃ¶rÃ¼ne kaydetmek iÃ§in indirilen dosyayÄ± ./data/hasta_kayitlari.json olarak kaydedin');
    }

    function importData(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = JSON.parse(e.target.result);
          if (Array.isArray(data)) {
            hastalar = data;
            
            // Hasta listesini otomatik sÄ±rala (isim sÄ±rasÄ±)
            hastalar.sort((a, b) => a.isim.localeCompare(b.isim, 'tr'));
            
            saveToStorage();
            renderHastalar();
            alert('Veriler baÅŸarÄ±yla yÃ¼klendi ve sÄ±ralandÄ±!');
          } else {
            alert('GeÃ§ersiz JSON formatÄ±!');
          }
        } catch(err) {
          alert('JSON okuma hatasÄ±: ' + err);
        }
      };
      reader.readAsText(file);
      event.target.value = '';
    }

    function kopyalaGptMesaj(i) {
      const textarea = document.getElementById('gptMesaj_' + i);
      textarea.select();
      textarea.setSelectionRange(0, 99999); // mobile uyumlu
      document.execCommand('copy');
      alert('GPT mesajÄ± kopyalandÄ±!');
    }
    window.kopyalaGptMesaj = kopyalaGptMesaj;

    // Ortak fonksiyonlar
    
    // TÃ¼m hasta JSON'larÄ±ndan eslesmeyenTarifler verilerini temizle
    async function temizleEslesmeyenTarifleriJSON() {
      console.log('ğŸ§¹ TÃ¼m hasta JSON\'larÄ±ndan eslesmeyenTarifler verileri temizleniyor...');
      
      const hastalar = getHastaListesi();
      let temizlenenSayisi = 0;
      
      for (const hasta of hastalar) {
        let temizlemeYapildi = false;
        
        if (hasta.haftalar) {
          hasta.haftalar.forEach(hafta => {
            if (hafta.eslesmeyenTarifler) {
              delete hafta.eslesmeyenTarifler;
              temizlemeYapildi = true;
            }
          });
        }
        
        if (temizlemeYapildi) {
          await hastayiAyriKaydet(hasta);
          temizlenenSayisi++;
          console.log(`âœ… ${hasta.isim} - eslesmeyenTarifler verileri temizlendi`);
        }
      }
      
      console.log(`ğŸ¯ Toplam ${temizlenenSayisi} hasta JSON'u temizlendi`);
      
      if (temizlenenSayisi > 0) {
        alert(`âœ… ${temizlenenSayisi} hasta JSON dosyasÄ±ndan eÅŸleÅŸmeyen tarif verileri temizlendi!\n\nArtÄ±k JSON dosyalarÄ± daha kÃ¼Ã§Ã¼k ve hÄ±zlÄ± olacak.`);
      } else {
        alert('âœ… TÃ¼m JSON dosyalarÄ± zaten temiz!');
      }
    }
    
    // Global olarak eriÅŸilebilir yap
    window.temizleEslesmeyenTarifleriJSON = temizleEslesmeyenTarifleriJSON;

  function extractTariflerDetay(text) {
      console.log('ğŸ” extractTariflerDetay baÅŸlÄ±yor...');
      console.log('ğŸ“„ Ham metin uzunluÄŸu:', text.length);
      
      // Her satÄ±rÄ± temizle, baÅŸÄ±nda * veya miktar varsa da al
      let lines = text.split('\n').map(line => line.trim()).filter(l => l.length > 1);

      // 1) PDF baÅŸÄ±ndaki isim/tarih ve genel talimatlarÄ± atla: Ä°lk gÃ¶rÃ¼nen GÃœN ismine kadar kÄ±rp
      try {
        const dayNames = ['pazartesi','sali','carsamba','persembe','cuma','cumartesi','pazar'];
        const findFirstDayIndex = () => {
          for (let i = 0; i < lines.length; i++) {
            const norm = turkishToAscii(lines[i] || '').toLowerCase();
            for (const g of dayNames) {
              // Kelime sÄ±nÄ±rÄ± benzeri: satÄ±rÄ±n herhangi yerinde gÃ¼n adÄ± geÃ§sin
              if (new RegExp(`(^|[^a-z])${g}([^a-z]|$)`).test(norm)) {
                return i;
              }
            }
          }
          return -1;
        };
        const firstDayIdx = findFirstDayIndex();
        if (firstDayIdx > 0) {
          console.log(`âœ‚ï¸ BaÅŸ kÄ±sÄ±m atlandÄ±: ${firstDayIdx} satÄ±r (ilk gÃ¼n: ${lines[firstDayIdx]})`);
          lines = lines.slice(firstDayIdx);
        }

        // 2) GÃœN baÅŸlÄ±klarÄ±nÄ± ve gereksiz Ã¼stbilgi satÄ±rlarÄ±nÄ± tamamen filtrele
        const isPureDayHeader = (s) => {
          const n = turkishToAscii((s || '')).toLowerCase().replace(/[^a-z0-9\s:]/g, '').trim();
          // Not: RegExp ctor kullanÄ±rken \s kaÃ§Ä±ÅŸÄ± Ã§ift yazÄ±lmalÄ±
          return dayNames.some(g => new RegExp('^' + g + '\\s*:?$').test(n));
        };
        lines = lines.filter(l => {
          const n = turkishToAscii(l).toLowerCase();
          // "hafta" iÃ§eren baÅŸlÄ±klarÄ± at
          if (/\bhafta\b/.test(n)) return false;
          // genelde sabah rutini talimatÄ±: "her sabah", "gune baslarken"
          if (n.includes('her sabah') || n.includes('gune baslarken')) return false;
          // Salt gÃ¼n baÅŸlÄ±klarÄ±nÄ± at
          if (isPureDayHeader(l)) return false;
          return true;
        });
      } catch (e) {
        console.warn('âš ï¸ GÃ¼n kÄ±rpma/baÅŸlÄ±k filtreleme sÄ±rasÄ±nda hata:', e);
      }
      console.log('ğŸ“ Toplam satÄ±r sayÄ±sÄ± (>1 karakter):', lines.length);
      
      // * ile baÅŸlayan satÄ±rlarÄ± Ã¶zel olarak logla
      const yildizliSatirlar = lines.filter(l => /^\*/.test(l));
      console.log('â­ * ile baÅŸlayan satÄ±rlar:', yildizliSatirlar);
      
      // Avokado iÃ§eren satÄ±rlarÄ± bul
      const avokadoSatirlar = lines.filter(l => l.toLowerCase().includes('avokado'));
      console.log('ğŸ¥‘ "avokado" iÃ§eren satÄ±rlar:', avokadoSatirlar);
      
      // Tavuk iÃ§eren satÄ±rlarÄ± bul
      const tavukSatirlar = lines.filter(l => l.toLowerCase().includes('tavuk'));
      console.log('ğŸ” "tavuk" iÃ§eren satÄ±rlar:', tavukSatirlar);
      
      // Pirzola iÃ§eren satÄ±rlarÄ± bul
      const pirzolaSatirlar = lines.filter(l => l.toLowerCase().includes('pirzola'));
      console.log('ğŸ¥© "pirzola" iÃ§eren satÄ±rlar:', pirzolaSatirlar);
      
      // SatÄ±r baÅŸÄ±nda rakam, *, miktar, FRAKSÄ°YON/ONDALIK, bÃ¼yÃ¼k harf, veya yemek adÄ± olabilecek her ÅŸeyi al
      const filtered = lines.filter(l =>
        /^[0-9]+\./.test(l) || // 1. ...
        /^\*/.test(l) || // * ...
        // miktar ile baÅŸlayan (nokta, virgÃ¼l, boÅŸluk veya satÄ±r sonu ile biter)
        /^[0-9]+[\.,]?\s*(gram|gr|adet|yemek\s*kaÅŸÄ±ÄŸÄ±|tatlÄ±\s*kaÅŸÄ±ÄŸÄ±|su\s*bardaÄŸÄ±|dilim|kase|Ã§ay\s*bardaÄŸÄ±|bardak|kaÅŸÄ±k|tbsp|tsp|ml|kg|g)(\s|\.|\,|$)/i.test(l) ||
        // fraksiyon (1/2, 3/4), unicode fraksiyon (Â½), veya ondalÄ±k (0.5) ile baÅŸlayÄ±p ardÄ±ndan kelime gelen satÄ±rlar
        /^([0-9]+\/[0-9]+)\s+\S+/.test(l) ||
        /^[Â¼Â½Â¾â…“â…”â…›â…œâ…â…]\s+\S+/.test(l) ||
        /^[0-9]+[\.,][0-9]+\s+\S+/.test(l) ||
        // dÃ¼z sayÄ± + kelime (Ã¶rn: "1 avokado")
        /^[0-9]+\s+\S+/.test(l) ||
        /^[A-ZÄ°IÄ±ÄÄŸÃœÃ¼ÅÅŸÃ–Ã¶Ã‡Ã§]/.test(l) // bÃ¼yÃ¼k/Ã¶zel TÃ¼rkÃ§e harf ile baÅŸlayan
      );
      
      console.log('ğŸ” FiltrelenmiÅŸ satÄ±r sayÄ±sÄ±:', filtered.length);
      console.log('ğŸ“‹ FiltrelenmiÅŸ satÄ±rlar:', filtered);
      
      // BaÅŸtaki numara, * iÅŸareti ve miktar kÄ±smÄ±nÄ± temizle, ama yemek adÄ±nÄ± koru
      const result = filtered.map(line => {
        let temizlenmis = line;
        
        // BaÅŸtaki numara temizle
        temizlenmis = temizlenmis.replace(/^[0-9]+\.\s*/, '');
        
        // BaÅŸtaki yÄ±ldÄ±z temizle
        temizlenmis = temizlenmis.replace(/^\*+\s*/, '');

        // NOT: GÃ¶rselde "1/2 avokado" gibi ifadeleri KORU. Sadece baÅŸtaki miktar bir ÃœNÄ°T ile birlikteyse kaldÄ±r.
        // Ã–rn: "150 gr tavuk" â†’ miktarÄ± kaldÄ±r; "1/2 avokado" â†’ bÄ±rak.
        const unitGroup = '(gram|gr|adet|yemek\\s*kaÅŸÄ±ÄŸÄ±|tatlÄ±\\s*kaÅŸÄ±ÄŸÄ±|su\\s*bardaÄŸÄ±|dilim|kase|Ã§ay\\s*bardaÄŸÄ±|bardak|kaÅŸÄ±k|tbsp|tsp|ml|kg|g)';
        const leadingFractionWithUnit = new RegExp('^((?:[0-9]+\\/[0-9]+)|(?:[Â¼Â½Â¾â…“â…”â…›â…œâ…â…])|(?:[0-9]+[\\.,][0-9]+))\\s*' + unitGroup + '(?:[\\.,]?\\s*)', 'i');
        const leadingWordQtyWithUnit = new RegExp('^(yarÄ±m|yarim|Ã§eyrek|ceyrek)\\s+' + unitGroup + '(?:[\\.,]?\\s*)', 'i');
        if (leadingFractionWithUnit.test(temizlenmis)) {
          const once = temizlenmis;
          temizlenmis = temizlenmis.replace(leadingFractionWithUnit, '');
          console.log(`ğŸ§® FRAKSÄ°YON+ÃœNÄ°T BAÅLANGIÃ‡ TEMÄ°ZLENDÄ°: "${once}" â†’ "${temizlenmis}"`);
        }
        if (leadingWordQtyWithUnit.test(temizlenmis)) {
          const once = temizlenmis;
          temizlenmis = temizlenmis.replace(leadingWordQtyWithUnit, '');
          console.log(`ğŸ§® KELÄ°ME MÄ°KTAR+ÃœNÄ°T BAÅLANGIÃ‡ TEMÄ°ZLENDÄ°: "${once}" â†’ "${temizlenmis}"`);
        }
        
        // Miktar kÄ±smÄ±nÄ± akÄ±llÄ±ca temizle - sadece baÅŸÄ±ndakini al, ortadakini bÄ±rak
        // "150 gr. Tavuk pirzola" â†’ "Tavuk pirzola"
        // "150gr KÃ¶fte" â†’ "KÃ¶fte" 
        // "100 gram Et" â†’ "Et"
        // "150 gr." â†’ "" (sadece miktar varsa boÅŸ dÃ¶ner)
  const miktarRegex = /^([0-9]+[\.,]?\s*)(gram|gr|adet|yemek\s*kaÅŸÄ±ÄŸÄ±|tatlÄ±\s*kaÅŸÄ±ÄŸÄ±|su\s*bardaÄŸÄ±|dilim|kase|Ã§ay\s*bardaÄŸÄ±|bardak|kaÅŸÄ±k|tbsp|tsp|ml|kg|g)[\.,]?\s*/i;
        temizlenmis = temizlenmis.replace(miktarRegex, '');
        
        // Fazla boÅŸluklarÄ± temizle
        temizlenmis = temizlenmis.replace(/\s+/g, ' ').trim().toLowerCase();
        
        // Miktar iÃ§eren satÄ±rlarÄ± Ã¶zel logla
        if (line.match(/^[0-9]+\s*(gram|gr|adet|yemek\s*kaÅŸÄ±ÄŸÄ±|tatlÄ±\s*kaÅŸÄ±ÄŸÄ±|su\s*bardaÄŸÄ±|dilim|kase|Ã§ay\s*bardaÄŸÄ±|bardak|kaÅŸÄ±k|tbsp|tsp|ml|kg|g)/i)) {
          console.log(`âš–ï¸ MIKTAR SATIRI: "${line}" â†’ "${temizlenmis}"`);
        }
        
        // Avokado iÃ§eren satÄ±rlarÄ± Ã¶zel logla
        if (line.toLowerCase().includes('avokado')) {
          console.log(`ğŸ¥‘ AVOKADO SATIRI: "${line}" â†’ "${temizlenmis}"`);
        }
        
        // Tavuk iÃ§eren satÄ±rlarÄ± Ã¶zel logla
        if (line.toLowerCase().includes('tavuk')) {
          console.log(`ğŸ” TAVUK SATIRI: "${line}" â†’ "${temizlenmis}"`);
        }
        
        // Pirzola iÃ§eren satÄ±rlarÄ± Ã¶zel logla
        if (line.toLowerCase().includes('pirzola')) {
          console.log(`ğŸ¥© PIRZOLA SATIRI: "${line}" â†’ "${temizlenmis}"`);
        }
        
        return temizlenmis;
      });
      
  // Split kurallarÄ±nÄ± otomatik uygula
  const autoApplied = applySplitKurallariToList(result);
  console.log('âœ… Final tarif listesi (split kurallarÄ± uygulandÄ±):', autoApplied);
  console.log('ğŸ¥‘ Final listede avokado var mÄ±?', autoApplied.filter(r => r.includes('avokado')));
  console.log('ğŸ” Final listede tavuk var mÄ±?', autoApplied.filter(r => r.includes('tavuk')));
  console.log('ğŸ¥© Final listede pirzola var mÄ±?', autoApplied.filter(r => r.includes('pirzola')));
      
  return autoApplied;
    }

    function normalizeNameDetay(name) {
      return name
        .toLowerCase()
        .replace(/Ã§/g, 'c').replace(/ÄŸ/g, 'g').replace(/ÅŸ/g, 's')
        .replace(/Ã¼/g, 'u').replace(/Ã¶/g, 'o').replace(/Ä±/g, 'i')
        .replace(/\s+/g, '_')
        .replace(/[^a-z0-9_]/g, '');
    }

    // Sayfa aÃ§Ä±lÄ±ÅŸÄ±nda storage'dan yÃ¼kle ve listele
    renderHastalar();

    // Ã–zel Lenf Masaj PDF oluÅŸturucu (5. hafta ZIP benzeri)
    async function generateCustomLenfMasajPDF(hastaAdi, baslangicTarihi) {
      try {
        console.log('ğŸ’† Ã–zel Lenf Masaj PDF oluÅŸturuluyor...', { hastaAdi, baslangicTarihi });
        
        // jsPDF kÃ¼tÃ¼phane kontrolÃ¼
        let jsPDFLib;
        if (typeof window.jspdf !== 'undefined') {
          jsPDFLib = window.jspdf.jsPDF;
          console.log('âœ… jsPDF window.jspdf.jsPDF Ã¼zerinden yÃ¼klendi');
        } else if (typeof jsPDF !== 'undefined') {
          jsPDFLib = jsPDF;
          console.log('âœ… jsPDF global jsPDF Ã¼zerinden yÃ¼klendi');
        } else {
          console.log('âŒ jsPDF bulunamadÄ±, dinamik yÃ¼kleme yapÄ±lÄ±yor...');
          
          // Dinamik jsPDF yÃ¼kleme
          const script = document.createElement('script');
          script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
          script.onload = () => {
            console.log('âœ… jsPDF dinamik olarak yÃ¼klendi');
            setTimeout(() => generateCustomLenfMasajPDF(hastaAdi, baslangicTarihi), 100);
          };
          script.onerror = () => {
            console.log('âŒ jsPDF yÃ¼klenemedi');
            alert('PDF kÃ¼tÃ¼phanesi yÃ¼klenemedi. LÃ¼tfen internet baÄŸlantÄ±nÄ±zÄ± kontrol edin.');
          };
          document.head.appendChild(script);
          return; // Fonksiyondan Ã§Ä±k, yÃ¼kleme sonrasÄ± tekrar Ã§alÄ±ÅŸacak
        }
        
        const doc = new jsPDFLib('p', 'mm', 'a4'); // ZIP sistemiyle ayn  format
        
        // Hasta adÄ±nÄ± ASCII'ye Ã§evir (ZIP sistemiyle aynÄ±)
        console.log('ğŸ” Orijinal hasta adÄ±:', hastaAdi);
        const asciiHastaAdi = hastaAdi
            .replace(/Å/g, 'S').replace(/ÅŸ/g, 's')
            .replace(/Ä/g, 'G').replace(/ÄŸ/g, 'g')
            .replace(/Ãœ/g, 'U').replace(/Ã¼/g, 'u')
            .replace(/Ä°/g, 'I').replace(/Ä±/g, 'i')
            .replace(/Ã–/g, 'O').replace(/Ã¶/g, 'o')
            .replace(/Ã‡/g, 'C').replace(/Ã§/g, 'c')
            .replace(/Æ/g, 'E').replace(/É™/g, 'e');
        console.log('ğŸ” ASCII hasta adÄ±:', asciiHastaAdi);
        
        // BaÅŸlÄ±k - ZIP sistemindeki gibi
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(14);
        doc.setTextColor(0, 0, 0);
        
        const title = `${asciiHastaAdi.toUpperCase()}`;
        const titleWidth = doc.getTextWidth(title);
        doc.text(title, (210 - titleWidth) / 2, 20);
        
        doc.setFontSize(12);
        doc.setTextColor(0, 0, 0);
        
        // Lenf masaj baÅŸlÄ±ÄŸÄ± - ASCII karakterlerle
        const subtitle = 'LENF DRENAJ MASAJI PROGRAMI';
        const programBasligi = '8 Haftalik Lenf Drenaj Masaji Uygulama Programi';
        
        const subtitleWidth = doc.getTextWidth(subtitle);
        doc.text(subtitle, (210 - subtitleWidth) / 2, 28);
        
        // AÃ§Ä±klama kutusu
        doc.setFontSize(8);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(0, 0, 0);
        doc.rect(15, 32, 170, 10);
        doc.text(programBasligi, 20, 36);
        doc.text(turkceKarakterDuzelt('(5. Haftadan itibaren)'), 20, 40);
        
        // Tab baÅŸlangÄ±Ã§ tarihi zaten pazartesi olarak planlanmÄ±ÅŸ, deÄŸiÅŸtirme
        console.log('ğŸ” Tekli lenf masaj - 5. hafta tab baÅŸlangÄ±Ã§ tarihi (pazartesi olarak kabul):', baslangicTarihi.toLocaleDateString('tr-TR'));
        
        // Tab tarihi direkt kullan - zaten hafta baÅŸÄ± olarak planlanmÄ±ÅŸ
        const hizalanmisBaslangic = baslangicTarihi;
        
        // 5. haftanÄ±n baÅŸlangÄ±cÄ±
        let currentY = 50;
        const gunler = ['Pazartesi', 'Sali', 'Carsamba', 'Persembe', 'Cuma', 'Cumartesi', 'Pazar'].map(gun => turkceKarakterDuzelt(gun));
        
        // 8 haftalÄ±k lenf masaj programÄ± (ZIP sistemindeki gibi)
        for (let lenfHaftaIndex = 0; lenfHaftaIndex < 8; lenfHaftaIndex++) {
          const gercekHaftaNo = lenfHaftaIndex + 5; // 5. haftadan baÅŸlar
          const haftaBaslangic = new Date(hizalanmisBaslangic.getTime() + (lenfHaftaIndex * 7 * 24 * 60 * 60 * 1000));
          
          // Sayfa sonu kontrolÃ¼ - hafta baÅŸlÄ±ÄŸÄ± iÃ§in yer var mÄ±?
          if (currentY > 270) {
            doc.addPage();
            currentY = 20;
          }
          
          // Hafta baÅŸlÄ±ÄŸÄ±
          doc.setTextColor(0, 0, 0);
          doc.setFont('helvetica', 'bold');
          doc.setFontSize(9);
          doc.rect(15, currentY, 170, 6);
          
          const haftaBaslangicStr = haftaBaslangic.toLocaleDateString('tr-TR');
          const haftaBitisStr = new Date(haftaBaslangic.getTime() + (6 * 24 * 60 * 60 * 1000)).toLocaleDateString('tr-TR');
          
          doc.text(turkceKarakterDuzelt(`${gercekHaftaNo}. HAFTA (${haftaBaslangicStr} - ${haftaBitisStr})`), 20, currentY + 4);
          currentY += 8;
          
          // Tablo baÅŸlÄ±klarÄ± - ZIP sistemindeki gibi
          doc.setTextColor(0, 0, 0);
          doc.setFont('helvetica', 'bold');
          doc.setFontSize(9);
          doc.setDrawColor(0, 0, 0);
          doc.setLineWidth(0.3);
          
          const colWidths = [30, 40, 50, 50]; // Tarih, GÃ¼n, Sabah, AkÅŸam
          let zipTableStartX = 15;
          
          // BaÅŸlÄ±k satÄ±rÄ±
          doc.rect(zipTableStartX, currentY, colWidths[0], 6);
          doc.text('TARIH', zipTableStartX + 2, currentY + 4);
          zipTableStartX += colWidths[0];
          
          doc.rect(zipTableStartX, currentY, colWidths[1], 6);
          doc.text('GUN', zipTableStartX + 2, currentY + 4);
          zipTableStartX += colWidths[1];
          
          doc.rect(zipTableStartX, currentY, colWidths[2], 6);
          doc.text('SABAH', zipTableStartX + 2, currentY + 4);
          zipTableStartX += colWidths[2];
          
          doc.rect(zipTableStartX, currentY, colWidths[3], 6);
          doc.text('AKSAM', zipTableStartX + 2, currentY + 4);
          currentY += 6;
          
          // Her gÃ¼n iÃ§in satÄ±r - ZIP sistemindeki gibi
          doc.setFont('helvetica', 'normal');
          doc.setFontSize(8);
          
          for (let gunIndex = 0; gunIndex < 7; gunIndex++) {
            // Sayfa sonu kontrolÃ¼ - satÄ±r iÃ§in yer var mÄ±?
            if (currentY > 280) {
              doc.addPage();
              currentY = 20;
              
              // Yeni sayfada tablo baÅŸlÄ±klarÄ±nÄ± tekrar oluÅŸtur
              doc.setTextColor(0, 0, 0);
              doc.setFont('helvetica', 'bold');
              doc.setFontSize(9);
              doc.setDrawColor(0, 0, 0);
              doc.setLineWidth(0.3);
              
              let newPageTableStartX = 15;
              
              // BaÅŸlÄ±k satÄ±rÄ±
              doc.rect(newPageTableStartX, currentY, colWidths[0], 6);
              doc.text('TARIH', newPageTableStartX + 2, currentY + 4);
              newPageTableStartX += colWidths[0];
              
              doc.rect(newPageTableStartX, currentY, colWidths[1], 6);
              doc.text('GUN', newPageTableStartX + 2, currentY + 4);
              newPageTableStartX += colWidths[1];
              
              doc.rect(newPageTableStartX, currentY, colWidths[2], 6);
              doc.text('SABAH', newPageTableStartX + 2, currentY + 4);
              newPageTableStartX += colWidths[2];
              
              doc.rect(newPageTableStartX, currentY, colWidths[3], 6);
              doc.text('AKSAM', newPageTableStartX + 2, currentY + 4);
              currentY += 6;
              
              doc.setFont('helvetica', 'normal');
              doc.setFontSize(8);
            }
            
            const gunTarihi = new Date(haftaBaslangic.getTime() + (gunIndex * 24 * 60 * 60 * 1000));
            const tarihStr = gunTarihi.toLocaleDateString('tr-TR');
            const gun = gunler[gunIndex];
            
            // Lenf masaj uygulama kontrolÃ¼ (ZIP sistemindeki aynÄ± mantÄ±k)
            let sabahUygulama = '-';
            let aksamUygulama = '-';
            
            if (lenfHaftaIndex < 2) {
              // Ä°lk 2 hafta (5-6): GÃ¼nde 2 kez lenf masajÄ±
              sabahUygulama = turkceKarakterDuzelt('Lenf Masaji');
              aksamUygulama = turkceKarakterDuzelt('Lenf Masaji');
            } else if (lenfHaftaIndex < 4) {
              // Sonraki 2 hafta (7-8): GÃ¼nde 1 kez lenf masajÄ± (sabah)
              sabahUygulama = turkceKarakterDuzelt('Lenf Masaji');
              aksamUygulama = '-';
            } else if (lenfHaftaIndex < 6) {
              // Sonraki 2 hafta (9-10): GÃ¼naÅŸÄ±rÄ± lenf masajÄ±
              if (gunIndex === 0 || gunIndex === 2 || gunIndex === 4 || gunIndex === 6) {
                sabahUygulama = turkceKarakterDuzelt('Lenf Masaji');
                aksamUygulama = '-';
              } else {
                sabahUygulama = '-';
                aksamUygulama = '-';
              }
            } else {
              // Son 2 hafta (11-12): Haftada 2 gÃ¼n (SalÄ±-Cuma)
              if (gunIndex === 1 || gunIndex === 4) { // SalÄ±, Cuma
                sabahUygulama = turkceKarakterDuzelt('Lenf Masaji');
                aksamUygulama = '-';
              } else {
                sabahUygulama = '-';
                aksamUygulama = '-';
              }
            }
            
            zipTableStartX = 15;
            
            // Tablo Ã§izgi ayarlarÄ±
            doc.setDrawColor(0, 0, 0);
            doc.setLineWidth(0.3);
            
            // Tarih sÃ¼tunu
            doc.rect(zipTableStartX, currentY, colWidths[0], 5);
            doc.setTextColor(0, 0, 0);
            doc.text(tarihStr, zipTableStartX + 2, currentY + 3.5);
            zipTableStartX += colWidths[0];
            
            // GÃ¼n sÃ¼tunu
            doc.rect(zipTableStartX, currentY, colWidths[1], 5);
            doc.text(gun, zipTableStartX + 2, currentY + 3.5);
            zipTableStartX += colWidths[1];
            
            // Sabah sÃ¼tunu
            doc.rect(zipTableStartX, currentY, colWidths[2], 5);
            doc.text(sabahUygulama, zipTableStartX + 2, currentY + 3.5);
            zipTableStartX += colWidths[2];
            
            // AkÅŸam sÃ¼tunu
            doc.rect(zipTableStartX, currentY, colWidths[3], 5);
            doc.text(aksamUygulama, zipTableStartX + 2, currentY + 3.5);
            
            currentY += 5;
          }
          
          currentY += 8; // Haftalar arasÄ± boÅŸluk
        }
        
        // PDF'yi kaydet
        const tarih = new Date().toISOString().slice(0, 10);
        const dosyaAdi = `${asciiHastaAdi}_Lenf_Masaj_Takvimi_${tarih}.pdf`;
        doc.save(dosyaAdi);
        
        console.log('âœ… Ã–zel Lenf Masaj Takvimi PDF oluÅŸturuldu:', dosyaAdi);
        alert(`âœ… Lenf Masaj Takvimi PDF oluÅŸturuldu!\n\nDosya: ${dosyaAdi}\n\nBaÅŸlangÄ±Ã§ Tarihi: ${baslangicTarihi.toLocaleDateString('tr-TR')}`);
        
      } catch (error) {
        console.error('âŒ Ã–zel Lenf Masaj PDF hatasÄ±:', error);
        throw error;
      }
    }

    // Ã–zel Egzersiz + Lenf Masaj PDF oluÅŸturucu (9. hafta ZIP benzeri)
    async function generateCustomEgzersizPDF(hastaAdi, baslangicTarihi) {
      try {
        console.log('ğŸƒ Ã–zel Egzersiz + Lenf Masaj PDF oluÅŸturuluyor...', { hastaAdi, baslangicTarihi });
        
        // jsPDF kÃ¼tÃ¼phane kontrolÃ¼
        let jsPDFLib;
        if (typeof window.jspdf !== 'undefined') {
          jsPDFLib = window.jspdf.jsPDF;
          console.log('âœ… jsPDF window.jspdf.jsPDF Ã¼zerinden yÃ¼klendi');
        } else if (typeof jsPDF !== 'undefined') {
          jsPDFLib = jsPDF;
          console.log('âœ… jsPDF global jsPDF Ã¼zerinden yÃ¼klendi');
        } else {
          console.log('âŒ jsPDF bulunamadÄ±, dinamik yÃ¼kleme yapÄ±lÄ±yor...');
          
          // Dinamik jsPDF yÃ¼kleme
          const script = document.createElement('script');
          script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
          script.onload = () => {
            console.log('âœ… jsPDF dinamik olarak yÃ¼klendi');
            setTimeout(() => generateCustomEgzersizPDF(hastaAdi, baslangicTarihi), 100);
          };
          script.onerror = () => {
            console.log('âŒ jsPDF yÃ¼klenemedi');
            alert('PDF kÃ¼tÃ¼phanesi yÃ¼klenemedi. LÃ¼tfen internet baÄŸlantÄ±nÄ±zÄ± kontrol edin.');
          };
          document.head.appendChild(script);
          return; // Fonksiyondan Ã§Ä±k, yÃ¼kleme sonrasÄ± tekrar Ã§alÄ±ÅŸacak
        }
        
        const doc = new jsPDFLib('p', 'mm', 'a4'); // ZIP sistemiyle ayn  format
        
        // Hasta adÄ±nÄ± ASCII'ye Ã§evir (ZIP sistemiyle aynÄ±)
        console.log('ğŸ” Orijinal hasta adÄ±:', hastaAdi);
        const asciiHastaAdi = hastaAdi
            .replace(/Å/g, 'S').replace(/ÅŸ/g, 's')
            .replace(/Ä/g, 'G').replace(/ÄŸ/g, 'g')
            .replace(/Ãœ/g, 'U').replace(/Ã¼/g, 'u')
            .replace(/Ä°/g, 'I').replace(/Ä±/g, 'i')
            .replace(/Ã–/g, 'O').replace(/Ã¶/g, 'o')
            .replace(/Ã‡/g, 'C').replace(/Ã§/g, 'c')
            .replace(/Æ/g, 'E').replace(/É™/g, 'e');
        console.log('ğŸ” ASCII hasta adÄ±:', asciiHastaAdi);
        
        // BaÅŸlÄ±k - ZIP sistemindeki gibi
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(14);
        doc.setTextColor(0, 0, 0);
        
        const title = `${asciiHastaAdi.toUpperCase()}`;
        const titleWidth = doc.getTextWidth(title);
        doc.text(title, (210 - titleWidth) / 2, 20);
        
        doc.setFontSize(12);
        doc.setTextColor(0, 0, 0);
        
        // Egzersiz + lenf masaj baÅŸlÄ±ÄŸÄ± - ASCII karakterlerle
        const subtitle = 'EGZERSIZ VE LENF DRENAJ MASAJI PROGRAMI';
        const programBasligi = '8 Haftalik Egzersiz ve Lenf Drenaj Masaji Uygulama Programi';
        
        const subtitleWidth = doc.getTextWidth(subtitle);
        doc.text(subtitle, (210 - subtitleWidth) / 2, 28);
        
        // AÃ§Ä±klama kutusu
        doc.setFontSize(8);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(0, 0, 0);
        doc.rect(15, 32, 170, 10);
        doc.text(programBasligi, 20, 36);
        doc.text(turkceKarakterDuzelt('(5. Haftadan itibaren) - Yesil check isareti tamamlanan gunler'), 20, 40);
        
        // Tab baÅŸlangÄ±Ã§ tarihi zaten pazartesi olarak planlanmÄ±ÅŸ, deÄŸiÅŸtirme
        console.log('ğŸ” Tekli egzersiz - 9. hafta tab baÅŸlangÄ±Ã§ tarihi (pazartesi olarak kabul):', baslangicTarihi.toLocaleDateString('tr-TR'));
        
        // Tab tarihi direkt kullan - zaten hafta baÅŸÄ± olarak planlanmÄ±ÅŸ
        const hizalanmisBaslangic = baslangicTarihi;
        
        // 9. haftanÄ±n baÅŸlangÄ±cÄ± (baslangicTarihi 9. hafta baÅŸlangÄ±cÄ± kabul edilir)
        let currentY = 50;
        const gunler = ['Pazartesi', 'Sali', 'Carsamba', 'Persembe', 'Cuma', 'Cumartesi', 'Pazar'].map(gun => turkceKarakterDuzelt(gun));
        
        // 8 haftalÄ±k program (5-12. haftalar) - ZIP sistemindeki gibi
        for (let lenfHaftaIndex = 0; lenfHaftaIndex < 8; lenfHaftaIndex++) {
          const gercekHaftaNo = lenfHaftaIndex + 5; // 5. haftadan baÅŸlar
          
          // 9. haftayÄ± referans alarak diÄŸer hafta baÅŸlangÄ±Ã§larÄ±nÄ± hesapla
          // 5. hafta: 9. haftadan 4 hafta Ã¶nce (-4 * 7 gÃ¼n)
          // 6. hafta: 9. haftadan 3 hafta Ã¶nce (-3 * 7 gÃ¼n)
          // ...
          // 9. hafta: 9. haftadan 0 hafta Ã¶nce (0 * 7 gÃ¼n)
          // 10. hafta: 9. haftadan 1 hafta sonra (+1 * 7 gÃ¼n)
          const haftaFarki = gercekHaftaNo - 9; // 5. hafta=-4, 6. hafta=-3, ..., 9. hafta=0, 10. hafta=+1
          const haftaBaslangic = new Date(hizalanmisBaslangic.getTime() + (haftaFarki * 7 * 24 * 60 * 60 * 1000));
          
          // Sayfa sonu kontrolÃ¼ - hafta baÅŸlÄ±ÄŸÄ± iÃ§in yer var mÄ±?
          if (currentY > 270) {
            doc.addPage();
            currentY = 20;
          }
          
          // Hafta baÅŸlÄ±ÄŸÄ±
          doc.setTextColor(0, 0, 0);
          doc.setFont('helvetica', 'bold');
          doc.setFontSize(9);
          doc.rect(15, currentY, 170, 6);
          
          const haftaBaslangicStr = haftaBaslangic.toLocaleDateString('tr-TR');
          const haftaBitisStr = new Date(haftaBaslangic.getTime() + (6 * 24 * 60 * 60 * 1000)).toLocaleDateString('tr-TR');
          
          // 9. hafta PDF'si iÃ§in 5-8. haftalar soluk renkte olsun
          if (gercekHaftaNo <= 8) {
            doc.setTextColor(150, 150, 150); // Soluk gri renk
          } else {
            doc.setTextColor(0, 0, 0); // Normal siyah renk
          }
          
          doc.text(turkceKarakterDuzelt(`${gercekHaftaNo}. HAFTA (${haftaBaslangicStr} - ${haftaBitisStr})`), 20, currentY + 4);
          currentY += 8;
          
          // Tablo baÅŸlÄ±klarÄ± - ZIP sistemindeki gibi
          doc.setTextColor(0, 0, 0);
          doc.setFont('helvetica', 'bold');
          doc.setFontSize(9);
          doc.setDrawColor(0, 0, 0);
          doc.setLineWidth(0.3);
          
          const colWidths = [30, 40, 50, 50]; // Tarih, GÃ¼n, Sabah, AkÅŸam
          let zipTableStartX = 15;
          
          // BaÅŸlÄ±k satÄ±rÄ±
          doc.rect(zipTableStartX, currentY, colWidths[0], 6);
          doc.text('TARIH', zipTableStartX + 2, currentY + 4);
          zipTableStartX += colWidths[0];
          
          doc.rect(zipTableStartX, currentY, colWidths[1], 6);
          doc.text('GUN', zipTableStartX + 2, currentY + 4);
          zipTableStartX += colWidths[1];
          
          doc.rect(zipTableStartX, currentY, colWidths[2], 6);
          doc.text('SABAH', zipTableStartX + 2, currentY + 4);
          zipTableStartX += colWidths[2];
          
          doc.rect(zipTableStartX, currentY, colWidths[3], 6);
          doc.text('AKSAM', zipTableStartX + 2, currentY + 4);
          currentY += 6;
          
          // Her gÃ¼n iÃ§in satÄ±r - ZIP sistemindeki gibi
          doc.setFont('helvetica', 'normal');
          doc.setFontSize(8);
          
          for (let gunIndex = 0; gunIndex < 7; gunIndex++) {
            // Sayfa sonu kontrolÃ¼ - satÄ±r iÃ§in yer var mÄ±?
            if (currentY > 280) {
              doc.addPage();
              currentY = 20;
              
              // Yeni sayfada tablo baÅŸlÄ±klarÄ±nÄ± tekrar oluÅŸtur
              doc.setTextColor(0, 0, 0);
              doc.setFont('helvetica', 'bold');
              doc.setFontSize(9);
              doc.setDrawColor(0, 0, 0);
              doc.setLineWidth(0.3);
              
              let newPageTableStartX = 15;
              
              // BaÅŸlÄ±k satÄ±rÄ±
              doc.rect(newPageTableStartX, currentY, colWidths[0], 6);
              doc.text('TARIH', newPageTableStartX + 2, currentY + 4);
              newPageTableStartX += colWidths[0];
              
              doc.rect(newPageTableStartX, currentY, colWidths[1], 6);
              doc.text('GUN', newPageTableStartX + 2, currentY + 4);
              newPageTableStartX += colWidths[1];
              
              doc.rect(newPageTableStartX, currentY, colWidths[2], 6);
              doc.text('SABAH', newPageTableStartX + 2, currentY + 4);
              newPageTableStartX += colWidths[2];
              
              doc.rect(newPageTableStartX, currentY, colWidths[3], 6);
              doc.text('AKSAM', newPageTableStartX + 2, currentY + 4);
              currentY += 6;
              
              doc.setFont('helvetica', 'normal');
              doc.setFontSize(8);
            }
            
            const gunTarihi = new Date(haftaBaslangic.getTime() + (gunIndex * 24 * 60 * 60 * 1000));
            const tarihStr = gunTarihi.toLocaleDateString('tr-TR');
            const gun = gunler[gunIndex];
            
            // Uygulama kontrolÃ¼ - egzersiz dahil versiyonu (ZIP sistemindeki aynÄ± mantÄ±k)
            let sabahUygulama = '-';
            let aksamUygulama = '-';
            
            if (lenfHaftaIndex < 2) {
              // Ä°lk 2 hafta (5-6): GÃ¼nde 2 kez lenf masajÄ±
              sabahUygulama = turkceKarakterDuzelt('Lenf Masaji');
              aksamUygulama = turkceKarakterDuzelt('Lenf Masaji');
            } else if (lenfHaftaIndex < 4) {
              // Sonraki 2 hafta (7-8): GÃ¼nde 1 kez lenf masajÄ± (sabah)
              sabahUygulama = turkceKarakterDuzelt('Lenf Masaji');
              aksamUygulama = '-';
            } else if (lenfHaftaIndex < 6) {
              // Sonraki 2 hafta (9-10): GÃ¼naÅŸÄ±rÄ± lenf masajÄ± + egzersiz
              if (gunIndex === 0 || gunIndex === 2 || gunIndex === 4 || gunIndex === 6) {
                // Pazartesi, Ã‡arÅŸamba, Cuma, Pazar: Lenf masajÄ± + akÅŸam egzersiz
                sabahUygulama = turkceKarakterDuzelt('Lenf Masaji');
                aksamUygulama = turkceKarakterDuzelt('Egzersiz-2');
              } else {
                // SalÄ±, PerÅŸembe, Cumartesi: Sabah ve akÅŸam egzersiz
                sabahUygulama = turkceKarakterDuzelt('Egzersiz-1');
                aksamUygulama = turkceKarakterDuzelt('Egzersiz-2');
              }
            } else {
              // Son 2 hafta (11-12): Haftada 2 gÃ¼n lenf masajÄ± + sÃ¼rekli egzersiz
              if (gunIndex === 1 || gunIndex === 4) { // SalÄ±, Cuma
                sabahUygulama = turkceKarakterDuzelt('Lenf Masaji');
                aksamUygulama = turkceKarakterDuzelt('Egzersiz-2');
              } else {
                sabahUygulama = turkceKarakterDuzelt('Egzersiz-1');
                aksamUygulama = turkceKarakterDuzelt('Egzersiz-2');
              }
            }
            
            zipTableStartX = 15;
            
            // 9. hafta PDF'si iÃ§in 5-8. haftalar soluk renkte olsun
            if (gercekHaftaNo <= 8) {
              doc.setTextColor(150, 150, 150); // Soluk gri renk
            } else {
              doc.setTextColor(0, 0, 0); // Normal siyah renk
            }
            
            // Tablo Ã§izgi ayarlarÄ±
            doc.setDrawColor(0, 0, 0);
            doc.setLineWidth(0.3);
            
            // Tarih sÃ¼tunu
            doc.rect(zipTableStartX, currentY, colWidths[0], 5);
            
            // 9. hafta PDF'si ve geÃ§miÅŸ haftalarda (5-8) yeÅŸil check simgesi ekle
            if (gercekHaftaNo <= 8) {
              // YeÅŸil check kutusu Ã§iz
              doc.setFillColor(0, 128, 0); // YeÅŸil dolgu
              doc.rect(zipTableStartX + 1, currentY + 1, 4, 3, 'F'); // YeÅŸil dikdÃ¶rtgen
              
              // Beyaz check Ã§izgisi Ã§iz
              doc.setDrawColor(255, 255, 255); // Beyaz Ã§izgi
              doc.setLineWidth(0.5);
              // Check iÅŸareti Ã§izgisi (V ÅŸekli)
              doc.line(zipTableStartX + 1.5, currentY + 2.5, zipTableStartX + 2.5, currentY + 3.2);
              doc.line(zipTableStartX + 2.5, currentY + 3.2, zipTableStartX + 4.2, currentY + 1.5);
              
              // Tablo Ã§izgi ayarlarÄ±nÄ± geri yÃ¼kle
              doc.setDrawColor(0, 0, 0);
              doc.setLineWidth(0.3);
              
              // Tarihi soluk renkte yaz
              doc.setTextColor(150, 150, 150);
              doc.text(tarihStr, zipTableStartX + 7, currentY + 3.5);
            } else {
              // Normal tarih
              doc.setTextColor(0, 0, 0);
              doc.text(tarihStr, zipTableStartX + 2, currentY + 3.5);
            }
            zipTableStartX += colWidths[0];
            
            // GÃ¼n sÃ¼tunu
            doc.rect(zipTableStartX, currentY, colWidths[1], 5);
            doc.text(gun, zipTableStartX + 2, currentY + 3.5);
            zipTableStartX += colWidths[1];
            
            // Sabah sÃ¼tunu
            doc.rect(zipTableStartX, currentY, colWidths[2], 5);
            doc.text(sabahUygulama, zipTableStartX + 2, currentY + 3.5);
            zipTableStartX += colWidths[2];
            
            // AkÅŸam sÃ¼tunu
            doc.rect(zipTableStartX, currentY, colWidths[3], 5);
            doc.text(aksamUygulama, zipTableStartX + 2, currentY + 3.5);
            
            currentY += 5;
          }
          
          currentY += 8; // Haftalar arasÄ± boÅŸluk
        }
        
        // PDF'yi kaydet
        const tarih = new Date().toISOString().slice(0, 10);
        const dosyaAdi = `${asciiHastaAdi}_Egzersiz_Takvimi_${tarih}.pdf`;
        doc.save(dosyaAdi);
        
        console.log('âœ… Ã–zel Egzersiz + Lenf Masaj Takvimi PDF oluÅŸturuldu:', dosyaAdi);
        alert(`âœ… Egzersiz + Lenf Masaj Takvimi PDF oluÅŸturuldu!\n\nDosya: ${dosyaAdi}\n\nBaÅŸlangÄ±Ã§ Tarihi: ${baslangicTarihi.toLocaleDateString('tr-TR')}`);
        
      } catch (error) {
        console.error('âŒ Ã–zel Egzersiz PDF hatasÄ±:', error);
        throw error;
      }
    }

    async function zipEslesenGorseller(i) {
      try {
        console.log('ğŸ¯ ZIP fonksiyonu baÅŸlatÄ±ldÄ±, hafta indeksi:', i);
        
        // Hemen scope test edelim
        console.log('ğŸ” Scope test - i deÄŸeri:', i);
        
        // GitHub deÄŸiÅŸkenlerini input'lardan al - null check ile
        const tokenElement = document.getElementById('githubToken');
        const repoElement = document.getElementById('githubRepo');
        
        const GITHUB_TOKEN = tokenElement ? tokenElement.value.trim() : '';
        const GITHUB_REPO = repoElement ? repoElement.value.trim() || 'mustafasacar35/lipodem-takip-paneli' : 'mustafasacar35/lipodem-takip-paneli';
        
        if (!GITHUB_TOKEN) {
          console.warn('âš ï¸ GitHub token bulunamadÄ±');
          alert('GitHub token ayarlanmamÄ±ÅŸ. PDF dosyalarÄ± eklenemeyecek.');
        } else {
          console.log('âœ… GitHub token mevcut');
        }
        
        console.log('ğŸ” GITHUB_REPO:', GITHUB_REPO);
        
        // KÃ¼tÃ¼phane kontrolÃ¼
        if (typeof JSZip === 'undefined') {
          console.error('âŒ JSZip kÃ¼tÃ¼phanesi yÃ¼klenmemiÅŸ!');
          alert('JSZip kÃ¼tÃ¼phanesi yÃ¼klenmemiÅŸ! SayfayÄ± yenileyin.');
          return;
        }
        
        if (typeof saveAs === 'undefined') {
          console.error('âŒ FileSaver kÃ¼tÃ¼phanesi yÃ¼klenmemiÅŸ!');
          alert('FileSaver kÃ¼tÃ¼phanesi yÃ¼klenmemiÅŸ! SayfayÄ± yenileyin.');
          return;
        }
        
        console.log('âœ… KÃ¼tÃ¼phaneler yÃ¼klÃ¼: JSZip:', typeof JSZip, 'saveAs:', typeof saveAs);
        
      const haftalar = getHaftaListesi();
      console.log('ğŸ” Hafta listesi alÄ±ndÄ±, uzunluk:', haftalar ? haftalar.length : 'null');
      
      const hafta = haftalar[i];
      console.log('  Hafta objesi alÄ±ndÄ±:', hafta);
      
      console.log('ğŸ” Hafta objesi tamamÄ±:', JSON.stringify(hafta, null, 2));
      
      // haftaNo tanÄ±mÄ±ndan Ã¶nce hafta objesi kontrolÃ¼
      if (!hafta) {
        console.error('âŒ Hafta objesi bulunamadÄ±, index:', i);
        alert('Hafta bilgisi bulunamadÄ±!');
        return;
      }
      
      console.log('ğŸ” hafta.haftaNo deÄŸeri:', hafta.haftaNo);
      console.log('ğŸ” i + 1 deÄŸeri:', i + 1);
      
      // Hafta numarasÄ±nÄ± Ã¶nce tanÄ±mla - DEBUG ile
      console.log('ğŸ” haftaNo tanÄ±mlanmadan Ã¶nce...');
      const haftaNo = hafta.haftaNo || (i + 1);
      console.log('ğŸ” haftaNo tanÄ±mlandÄ±:', haftaNo);
      
      // EÄŸer PDF varsa ama pdfName yoksa, bunu dÃ¼zelt
      if (hafta.pdf && !hafta.pdfName) {
        console.log('ğŸ”§ PDF var ama pdfName yok, dÃ¼zeltiliyor...');
        // Hasta adÄ±ndan PDF adÄ± oluÅŸtur (TÃ¼rkÃ§e karakter dÃ¼zeltme ile)
        const hastaAdi = seciliHasta && seciliHasta.isim ? turkceKarakterDuzelt(seciliHasta.isim).replace(/\s+/g, '_') : 'Hasta';
        const tarih = new Date().toISOString().slice(0,10);
        hafta.pdfName = `${hastaAdi}_Hafta_${haftaNo}_${tarih}.pdf`;
        saveToStorage(); // DeÄŸiÅŸikliÄŸi kaydet
        console.log('âœ… PDF adÄ± oluÅŸturuldu:', hafta.pdfName);
      }
      
      const eslesenDiv = document.getElementById('eslesenKartlar_' + i);
      const imgs = eslesenDiv.querySelectorAll('img');
      
      // Ä°Ã§erik kontrolÃ¼
      const hasPdf = hafta.pdf;
      const hasGptMessage = hafta.gptMesaj && hafta.gptMesaj.trim();
      const hasImages = imgs.length > 0;
      
      if (!hasImages && !hasPdf && !hasGptMessage) {
        alert('Ä°ndirilecek iÃ§erik yok!\n\nâ€¢ PDF dosyasÄ±\nâ€¢ EÅŸleÅŸen tarif kartlarÄ±\nâ€¢ GPT mesajÄ±');
        return;
      }
      
      const zip = new JSZip();
      let fileCount = 0;      let baseName, zipName, pdfFileName, txtFileName;
      
      console.log('ğŸ” Debug - hafta objesi:', hafta);
      console.log('ğŸ” Debug - hafta.pdfName:', hafta.pdfName);
      console.log('ğŸ” Debug - hafta indeksi:', i);
      console.log('ğŸ” Debug - tÃ¼m hafta listesi:', getHaftaListesi().map(h => ({haftaNo: h.haftaNo, pdfName: h.pdfName})));
      
      if (hafta.pdfName && hafta.pdfName.trim()) {
        // YÃ¼klenen PDF dosyasÄ±nÄ±n adÄ±nÄ± kullan - TÃ¼rkÃ§e karakterleri dÃ¼zelt
        const duzeltilmisPdfName = turkceKarakterDuzelt(hafta.pdfName);
        baseName = duzeltilmisPdfName.replace(/\.[^.]+$/, '');  // UzantÄ±sÄ±z ad
        zipName = duzeltilmisPdfName.replace(/\.pdf$/i, '.zip');  // PDF uzantÄ±sÄ±nÄ± ZIP ile deÄŸiÅŸtir
        pdfFileName = duzeltilmisPdfName;  // DÃ¼zeltilmiÅŸ PDF adÄ±nÄ± kullan
        txtFileName = baseName + '.txt';
        console.log('âœ… PDF adÄ± kullanÄ±lÄ±yor (dÃ¼zeltilmiÅŸ):', duzeltilmisPdfName);
      } else {
        // PDF adÄ± yoksa, PDF iÃ§eriÄŸinden veya hasta adÄ±ndan tÃ¼retelim
        console.log('âš ï¸ PDF adÄ± yok, alternatif Ã§Ã¶zÃ¼m arÄ±yor...');
        
        // Hasta adÄ±ndan ve hafta numarasÄ±ndan dosya adÄ± oluÅŸtur (TÃ¼rkÃ§e karakter dÃ¼zeltme ile)
        const hastaAdi = seciliHasta && seciliHasta.isim ? turkceKarakterDuzelt(seciliHasta.isim).replace(/\s+/g, '_') : 'Hasta';
        const tarih = new Date().toISOString().slice(0,10);
        
        baseName = `${hastaAdi}_Hafta_${haftaNo}_${tarih}`;
        zipName = baseName + '.zip';
        pdfFileName = baseName + '.pdf';
        txtFileName = baseName + '.txt';
        console.log('ğŸ“ OluÅŸturulan dosya adÄ±:', baseName);
      }
      
      console.log('ğŸ“¦ ZIP oluÅŸturuluyor:', {
        hasPdf,
        hasGptMessage,
        hasImages,
        pdfName: hafta.pdfName,
        zipName: zipName,
        pdfFileName: pdfFileName,
        txtFileName: txtFileName
      });
      
      // 2. EÅŸleÅŸen tarif kartlarÄ±nÄ± ana dizine ekle
      for (let img of imgs) {
        try {
          const url = img.src;
          const name = img.title || img.alt || `eslesen_kart_${fileCount + 1}.jpg`;
          const response = await fetch(url);
          const blob = await response.blob();
          zip.file(name, blob);  // Ana dizine ekle
          fileCount++;
          console.log('âœ… EÅŸleÅŸen kart eklendi:', name);
        } catch (e) {
          console.warn('âš ï¸ EÅŸleÅŸen kart eklenemedi:', img.alt, e);
        }
      }
      
      // 2b. Manuel eklenen kartlarÄ± da ana dizine ekle
      if (hafta.manuelKartlar && hafta.manuelKartlar.length > 0) {
        console.log('ğŸ“ Manuel kartlar ZIP\'e ekleniyor...', hafta.manuelKartlar);
        for (let manuelKart of hafta.manuelKartlar) {
          try {
            const response = await fetch(manuelKart.data);
            const blob = await response.blob();
            const manuelName = `MANUEL_${manuelKart.name}`;
            zip.file(manuelName, blob);  // Ana dizine ekle, MANUEL_ prefix ile
            fileCount++;
            console.log('âœ… Manuel kart eklendi:', manuelName);
          } catch (e) {
            console.warn('âš ï¸ Manuel kart eklenemedi:', manuelKart.name, e);
          }
        }
      }
      
      // 2c. Ã‡oklu PDF'den eklenen kartlarÄ± da ana dizine ekle
      if (hafta.cokluPdfVerileri && hafta.cokluPdfVerileri.length > 0) {
        console.log('ğŸ“ Ã‡oklu PDF kartlarÄ± ZIP\'e ekleniyor...', hafta.cokluPdfVerileri);
        for (let veri of hafta.cokluPdfVerileri) {
          if (veri.tarifKartlar && veri.tarifKartlar.length > 0) {
            for (let cokluKart of veri.tarifKartlar) {
              try {
                const response = await fetch(cokluKart.data);
                const blob = await response.blob();
                const cokluName = `COKLU_PDF_${cokluKart.name}`;
                zip.file(cokluName, blob);  // Ana dizine ekle, COKLU_PDF_ prefix ile
                fileCount++;
                console.log('âœ… Ã‡oklu PDF kartÄ± eklendi:', cokluName);
              } catch (e) {
                console.warn('âš ï¸ Ã‡oklu PDF kartÄ± eklenemedi:', cokluKart.name, e);
              }
            }
          }
        }
      }
      
      // 3. PDF dosyasÄ±nÄ± ekle
      if (hasPdf) {
        try {
          const base64 = hafta.pdf.split(',')[1];
          if (base64 && base64.length > 0) {
            // Base64 string boyutunu kontrol et (minimum 100 karakter olmalÄ± - Ã§ok kÃ¼Ã§Ã¼k PDF'leri engelle)
            if (base64.length < 100) {
              console.warn('âš ï¸ PDF Ã§ok kÃ¼Ã§Ã¼k (100 karakterden az), eklenmedi:', base64.length, 'karakter');
            } else {
              zip.file(pdfFileName, base64, {base64: true});
              fileCount++;
              console.log('âœ… PDF eklendi:', pdfFileName, 'boyut:', base64.length, 'karakter');
            }
          } else {
            console.warn('âš ï¸ PDF base64 verisi boÅŸ');
          }
        } catch (e) {
          console.warn('âš ï¸ PDF eklenemedi:', e);
        }
      }
      
      // 5. GPT mesajÄ±nÄ± txt dosyasÄ± olarak ekle (sadece iÃ§erik)
      if (hasGptMessage) {
        try {
          const mesajIcerigi = hafta.gptMesaj.trim();  // Sadece GPT mesajÄ± iÃ§eriÄŸi
          
          zip.file(txtFileName, mesajIcerigi);
          fileCount++;
          console.log('âœ… GPT mesajÄ± eklendi:', txtFileName);
        } catch (e) {
          console.warn('âš ï¸ GPT mesajÄ± eklenemedi:', e);
        }
      }
      
      // MENÃœ PDF'Si EKLEME (TÃœM HAFTALAR Ä°Ã‡Ä°N)
      if ((hafta.pdfName || hafta.pdfOrijinalIsim) && GITHUB_TOKEN) {
        try {
          console.log(`ğŸ” ${haftaNo}. hafta MenÃ¼ PDF ekleniyor...`);
          console.log('ğŸ” PDF bilgileri:', {
            pdfName: hafta.pdfName,
            pdfOrijinalIsim: hafta.pdfOrijinalIsim,
            hastaId: seciliHasta.id,
            haftaNo: haftaNo
          });
          
          const pdfFileName = hafta.pdfName || hafta.pdfOrijinalIsim;
          
          // pdfYolu varsa Ã¶nce onu dene
          let pdfUrl;
          if (hafta.pdfYolu) {
            pdfUrl = `https://api.github.com/repos/${GITHUB_REPO}/contents/${hafta.pdfYolu}`;
            console.log('ğŸ” Ä°lk denenen PDF URL (pdfYolu):', pdfUrl);
          } else {
            // Ã–nce patients klasÃ¶rÃ¼nde dene
            pdfUrl = `https://api.github.com/repos/${GITHUB_REPO}/contents/patients/${seciliHasta.id}/hafta_${haftaNo}_${pdfFileName}`;
            console.log('ğŸ” Ä°lk denenen PDF URL (patients):', pdfUrl);
          }
          
          let pdfResponse = await fetch(pdfUrl, {
            headers: { 'Authorization': `token ${GITHUB_TOKEN}` }
          });
          
          console.log('ğŸ” Ä°lk PDF response status:', pdfResponse.status);
          
          // EÄŸer bulunamazsa pdfs klasÃ¶rÃ¼nÃ¼ dene
          if (!pdfResponse.ok && !hafta.pdfYolu) {
            console.log('ğŸ” patients klasÃ¶rÃ¼nde bulunamadÄ±, pdfs klasÃ¶rÃ¼nÃ¼ deniyor...');
            pdfUrl = `https://api.github.com/repos/${GITHUB_REPO}/contents/pdfs/${pdfFileName}`;
            
            console.log('ğŸ” Ä°kinci denenen PDF URL (pdfs):', pdfUrl);
            
            pdfResponse = await fetch(pdfUrl, {
              headers: { 'Authorization': `token ${GITHUB_TOKEN}` }
            });
            
            console.log('ğŸ” Ä°kinci PDF response status:', pdfResponse.status);
          }
          
          if (pdfResponse.ok) {
            const pdfData = await pdfResponse.json();
            const pdfBlob = base64ToBlob(pdfData.content, 'application/pdf');
            
            // PDF boyutunu kontrol et (minimum 1KB olmalÄ±)
            if (pdfBlob && pdfBlob.size > 1024) {
              const menuPdfName = `MENU_PDF_${hafta.pdfOrijinalIsim || hafta.pdfName || 'menu.pdf'}`;
              zip.file(menuPdfName, pdfBlob);
              fileCount++;
              console.log(`âœ… ${haftaNo}. hafta MenÃ¼ PDF eklendi:`, menuPdfName, 'boyut:', pdfBlob.size, 'bytes');
            } else {
              console.warn(`âš ï¸ ${haftaNo}. hafta MenÃ¼ PDF Ã§ok kÃ¼Ã§Ã¼k (1KB altÄ±), eklenmedi:`, pdfBlob ? pdfBlob.size : 'null', 'bytes');
            }
          } else {
            const errorText = await pdfResponse.text();
            console.warn(`âŒ ${haftaNo}. hafta PDF yanÄ±tÄ± baÅŸarÄ±sÄ±z:`, pdfResponse.status, errorText);
            
            // API yanÄ±tÄ±nÄ± detaylÄ± logla
            console.warn('âŒ PDF API yanÄ±t detaylarÄ±:', {
              url: pdfUrl,
              status: pdfResponse.status,
              statusText: pdfResponse.statusText,
              errorText: errorText
            });
          }
        } catch (error) {
          console.warn(`âŒ ${haftaNo}. hafta MenÃ¼ PDF eklenemedi:`, error);
          console.warn('âŒ PDF ekleme hatasÄ± detaylarÄ±:', {
            errorMessage: error.message,
            errorStack: error.stack,
            pdfUrl: pdfUrl
          });
        }
      } else {
        console.warn(`â„¹ï¸ ${haftaNo}. hafta PDF bilgisi bulunamadÄ±`, {
          haftaNo: haftaNo,
          pdfName: hafta.pdfName,
          pdfOrijinalIsim: hafta.pdfOrijinalIsim,
          hasToken: !!GITHUB_TOKEN
        });
      }

      // 6. EÄŸer bu hafta "5. hafta" ise masaj takvimi oluÅŸtur
      if (haftaNo === 5) {
        try {
          console.log('ğŸ¥ 5. hafta tespit edildi, Masaj Takvim PDF\'i oluÅŸturuluyor...');
          console.log('ğŸ” Bu hafta bilgileri:', { index: i, haftaNo: haftaNo, baslangic: hafta.baslangic, bitis: hafta.bitis });
          
          // âš¡ Ã–NEMLÄ°: Bu 5. hafta tab'Ä±nÄ±n tarihini kullan
          const masajTakvimBlob = await generate5HaftaMasajPDF(hafta);
          console.log('ğŸ” generate5HaftaMasajPDF sonucu:', masajTakvimBlob ? 'Blob var' : 'Blob yok');
          
          if (masajTakvimBlob && masajTakvimBlob.size > 0) {
            const masajTakvimFileName = `${baseName}_Masaj_Takvimi.pdf`;
            console.log('ğŸ” Masaj PDF boyutu:', masajTakvimBlob.size, 'bytes');
            console.log('ğŸ” Masaj PDF dosya adÄ±:', masajTakvimFileName);
            zip.file(masajTakvimFileName, masajTakvimBlob);
            fileCount++;
            console.log('âœ… Masaj Takvim PDF\'i ZIP\'e eklendi:', masajTakvimFileName);
          } else {
            console.warn('âŒ Masaj Takvim PDF Blob oluÅŸturulamadÄ± veya boyutu 0 KB:', masajTakvimBlob ? masajTakvimBlob.size : 'null');
          }
        } catch (e) {
          console.warn('âš ï¸ Masaj Takvim PDF\'i eklenemedi:', e);
          console.warn('âŒ Masaj PDF hatasÄ± detaylarÄ±:', e.stack);
        }
      }
      
      // 7. Sadece 9. haftada "Masaj + Egzersiz" Takvim PDF'ini ekle
      if (haftaNo === 9) {
        try {
          console.log('ğŸ‹ï¸ 9. hafta tespit edildi, Masaj + Egzersiz Takvim PDF\'i oluÅŸturuluyor...');
          
          // Masaj + egzersiz iÃ§eren takvim PDF'ini oluÅŸtur (9. hafta iÃ§in, egzersiz dahil)
          const masajEgzersizTakvimBlob = await generateLenfDrenajPDFBlob(9);
          if (masajEgzersizTakvimBlob && masajEgzersizTakvimBlob.size > 0) {
            const masajEgzersizTakvimFileName = `${baseName}_Masaj_Egzersiz_Takvimi.pdf`;
            console.log('ğŸ” Masaj+Egzersiz PDF boyutu:', masajEgzersizTakvimBlob.size, 'bytes');
            zip.file(masajEgzersizTakvimFileName, masajEgzersizTakvimBlob);
            fileCount++;
            console.log('âœ… Masaj + Egzersiz Takvim PDF\'i ZIP\'e eklendi:', masajEgzersizTakvimFileName);
          } else {
            console.warn('âŒ Masaj + Egzersiz Takvim PDF Blob oluÅŸturulamadÄ± veya boyutu 0 KB:', masajEgzersizTakvimBlob ? masajEgzersizTakvimBlob.size : 'null');
          }
        } catch (e) {
          console.warn('âš ï¸ Masaj + Egzersiz Takvim PDF\'i eklenemedi:', e);
        }
      }
      
      // 8. ZIP dosyasÄ±nÄ± oluÅŸtur ve indir
      if (fileCount === 0) {
        alert('HiÃ§bir dosya eklenemedi!');
        return;
      }
      
      console.log(`ğŸ“¦ ZIP hazÄ±rlanÄ±yor: ${fileCount} dosya, adÄ±: ${zipName}`);
      
      zip.generateAsync({type:'blob'}).then(function(content) {
        saveAs(content, zipName);
        console.log('âœ… ZIP indirildi:', zipName);
        alert(`ZIP dosyasÄ± hazÄ±rlandÄ±!\n\nğŸ“ ${zipName}\nğŸ“„ ${fileCount} dosya dahil`);
      }).catch(function(error) {
        console.error('âŒ ZIP oluÅŸturma hatasÄ±:', error);
        alert('ZIP dosyasÄ± oluÅŸturulurken hata oluÅŸtu: ' + error.message);
      });
      
    } catch (error) {
        console.error('âŒ ZIP fonksiyonu genel hatasÄ±:', error);
        alert('ZIP oluÅŸturma hatasÄ±: ' + error.message);
      }
    }
    
    window.zipEslesenGorseller = zipEslesenGorseller;
    window.generatePatientPDF = generatePatientPDF;
    
    // PDF Test fonksiyonu
    function testPDFGenerator() {
      console.log('ğŸ§ª PDF Test baÅŸlatÄ±lÄ±yor...');
      console.log('jsPDF kontrol:', typeof window.jspdf, typeof jsPDF);
      
      if (typeof window.jspdf !== 'undefined') {
        console.log('âœ… jsPDF mevcut, test PDF oluÅŸturuluyor...');
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.text('Test PDF - TÃ¼rkÃ§e karakter: Ã§ÄŸÄ±Ã¶ÅŸÃ¼Ã‡ÄIÃ–ÅÃœ', 10, 10);
        doc.save('test.pdf');
        console.log('âœ… Test PDF oluÅŸturuldu!');
      } else {
        console.log('âŒ jsPDF bulunamadÄ±');
        alert('jsPDF kÃ¼tÃ¼phanesi yÃ¼klenmemiÅŸ');
      }
    }
    window.testPDFGenerator = testPDFGenerator;

    // Debug fonksiyonu - Tarifler klasÃ¶rÃ¼ durumunu kontrol et
    async function debugTariflerKlasoru() {
      console.log('ğŸ” Tarifler KlasÃ¶rÃ¼ Debug BaÅŸlÄ±yor...');
      
      // Mevcut durum
      console.log('ğŸ“Š Mevcut tariflerKlasoruGorselleri:', tariflerKlasoruGorselleri);
      console.log('ğŸ“Š GÃ¶rsel sayÄ±sÄ±:', tariflerKlasoruGorselleri.length);
      
      // Yol hesaplama
      let basePath = window.location.pathname;
      if (!basePath.endsWith('/')) basePath = basePath.substring(0, basePath.lastIndexOf('/') + 1);
      const tariflerPath = window.location.origin + basePath + 'tarifler/';
      console.log('ğŸŒ Hesaplanan tarifler yolu:', tariflerPath);
      
      // list.json kontrolÃ¼
      try {
        console.log('ğŸ“‚ list.json dosyasÄ± kontrol ediliyor...');
        const resp = await fetch(tariflerPath + 'list.json');
        console.log('ğŸ“„ list.json response status:', resp.status);
        
        if (resp.ok) {
          const responseText = await resp.text();
          console.log('ğŸ“„ Ham list.json iÃ§eriÄŸi (ilk 500 karakter):', responseText.substring(0, 500));
          
          try {
            const files = JSON.parse(responseText);
            console.log('âœ… list.json baÅŸarÄ±yla okundu:', files);
            console.log('ğŸ“ Dosya sayÄ±sÄ±:', files.length);
            
            // Her dosyanÄ±n eriÅŸilebilirliÄŸini test et
            for (let fileName of files.slice(0, 3)) { // Ä°lk 3 dosyayÄ± test et
              try {
                const fileResp = await fetch(tariflerPath + fileName);
                console.log(`ğŸ–¼ï¸ ${fileName}: ${fileResp.ok ? 'âœ… EriÅŸilebilir' : 'âŒ EriÅŸilemez'} (${fileResp.status})`);
              } catch (e) {
                console.log(`ğŸ–¼ï¸ ${fileName}: âŒ Hata - ${e.message}`);
              }
            }
          } catch (jsonError) {
            console.log('âŒ JSON parsing hatasÄ±:', jsonError.message);
            console.log('ğŸ“„ HatalÄ± JSON iÃ§eriÄŸi:', responseText);
            
            // JSON'u satÄ±r satÄ±r kontrol et
            const lines = responseText.split('\n');
            console.log('ğŸ“Š Toplam satÄ±r sayÄ±sÄ±:', lines.length);
            
            // 200-210 arasÄ± satÄ±rlarÄ± gÃ¶ster (hata 204. satÄ±rda)
            for (let i = 200; i < Math.min(210, lines.length); i++) {
              console.log(`SatÄ±r ${i + 1}: "${lines[i]}"`);
            }
          }
        } else {
          console.log('âŒ list.json bulunamadÄ±');
        }
      } catch (e) {
        console.log('âŒ list.json okuma hatasÄ±:', e.message);
      }
      
      // Hasta verilerini kontrol et
      console.log('ğŸ‘¥ Toplam hasta sayÄ±sÄ±:', hastalar.length);
      
      if (hastalar.length > 0) {
        const mevcutSeciliHasta = hastalar.find(h => h.secili);
        if (mevcutSeciliHasta) {
          console.log('ğŸ‘¤ SeÃ§ili hasta:', mevcutSeciliHasta.ad);
          const haftalar = mevcutSeciliHasta.haftalar || [];
          console.log('ğŸ“… Hafta sayÄ±sÄ±:', haftalar.length);
          
          haftalar.forEach((hafta, index) => {
            const manuelKartSayisi = (hafta.tarifKartlar && hafta.tarifKartlar.length) || 0;
            const tarifSayisi = (hafta.tarifler && hafta.tarifler.length) || 0;
            const haftaNo = hafta.haftaNo || (index + 1);
            const pdfDurum = hafta.pdf ? 'âœ… PDF var' : 'âŒ PDF yok';
            console.log(`ğŸ“… Hafta ${haftaNo} (sÄ±ra: ${index + 1}): ${manuelKartSayisi} manuel kart, ${tarifSayisi} tarif, ${pdfDurum}`);
          });
        } else {
          console.log('âš ï¸ SeÃ§ili hasta yok');
        }
      }
      
      // SonuÃ§ Ã¶zeti
      alert(`ğŸ” Debug SonuÃ§larÄ± (Konsolu kontrol edin):
      
ğŸ“Š Tarifler klasÃ¶rÃ¼ gÃ¶rsel sayÄ±sÄ±: ${tariflerKlasoruGorselleri.length}
ğŸŒ Tarifler yolu: ${tariflerPath}
ğŸ‘¥ Hasta sayÄ±sÄ±: ${hastalar.length}

DetaylÄ± bilgiler iÃ§in tarayÄ±cÄ± konsolunu (F12) aÃ§Ä±n.`);
    }
    window.debugTariflerKlasoru = debugTariflerKlasoru;

    // Tarifler klasÃ¶rÃ¼nÃ¼ yeniden yÃ¼kleme ve eÅŸleÅŸtirme fonksiyonu
    async function yeniBirDenemeEt(haftaIndex) {
      console.log('ğŸ”„ Yeniden deneme baÅŸlÄ±yor...');
      
      // Ã–nce tarifler klasÃ¶rÃ¼nÃ¼ sÄ±fÄ±rla ve yeniden yÃ¼kle
      tariflerKlasoruGorselleri = [];
      await tariflerKlasoruGorselleriniYukle();
      
      // Durum gÃ¼ncelle
      durumGuncelle();
      
      // Sonra o hafta iÃ§in eÅŸleÅŸtirmeyi yeniden Ã§alÄ±ÅŸtÄ±r
      await otomatikEsleHafta(haftaIndex);
      
      console.log('âœ… Yeniden deneme tamamlandÄ±');
    }
    window.yeniBirDenemeEt = yeniBirDenemeEt;

    // GitHub'tan fresh yÃ¼kleme (cache'i temizle ve GitHub'tan yÃ¼kle)
    async function githubdanYenileVeYukle() {
      const token = document.getElementById('githubToken').value.trim();
      if (!token) {
        alert('âŒ GitHub token gerekli!\n\nÃ–nce GitHub API token\'Ä±nÄ±zÄ± girin.');
        return;
      }
      
      if (!confirm('ğŸ”„ FRESH YÃœKLEME\n\nBu iÅŸlem:\nâ€¢ Yerel cache\'i temizleyecek\nâ€¢ GitHub\'tan en gÃ¼ncel verileri yÃ¼kleyecek\nâ€¢ Tarifler klasÃ¶rÃ¼nÃ¼ yeniden tarayacak\n\nDevam etmek istiyor musunuz?')) {
        return;
      }
      
      try {
        console.log('ğŸ”„ GitHub\'tan fresh yÃ¼kleme baÅŸlÄ±yor...');
        
        // Sadece veri cache'lerini temizle (hasta kayÄ±tlarÄ±nÄ± tutmak iÃ§in)
        manuelEslestirmeler = {};
        eslesmemeKurallari = {};
        tariflerKlasoruGorselleri = [];
        
        // GitHub'tan yÃ¼kle
  await manuelEslestirmeleriGitHubYukle(false); // sessiz deÄŸil
  await eslesmemeKurallariniGitHubYukle(false); // sessiz deÄŸil
  await karalisteGitHubYukle(false); // karaliste de
        
        // Tarifler klasÃ¶rÃ¼nÃ¼ yeniden yÃ¼kle
        await tariflerKlasoruGorselleriniYukle();
        
        // Durumu gÃ¼ncelle
        durumGuncelle();
        
  alert('âœ… GitHub\'tan fresh yÃ¼kleme tamamlandÄ±!\n\n' +
              `â€¢ Manuel eÅŸleÅŸtirmeler: ${Object.keys(manuelEslestirmeler).length} adet\n` +
              `â€¢ EÅŸleÅŸme yasaklarÄ±: ${Object.keys(eslesmemeKurallari).length} adet\n` +
              `â€¢ Tarifler klasÃ¶rÃ¼: ${tariflerKlasoruGorselleri.length} gÃ¶rsel`);
              
      } catch (error) {
        console.error('GitHub fresh yÃ¼kleme hatasÄ±:', error);
        alert('âŒ GitHub\'tan yÃ¼kleme hatasÄ±:\n\n' + error.message);
      }
    }
    window.githubdanYenileVeYukle = githubdanYenileVeYukle;

    // Sadece tarifler klasÃ¶rÃ¼nÃ¼ yenile
    async function sadeceTariflerKlasoruYenile() {
      try {
        console.log('ğŸ“ Tarifler klasÃ¶rÃ¼ yenileniyor...');
        
        // Cache'i temizle
        tariflerKlasoruGorselleri = [];
        
        // Yeniden yÃ¼kle
        await tariflerKlasoruGorselleriniYukle();
        
        // Durumu gÃ¼ncelle
        durumGuncelle();
        
        alert(`âœ… Tarifler klasÃ¶rÃ¼ yenilendi!\n\n${tariflerKlasoruGorselleri.length} gÃ¶rsel bulundu.`);
        
      } catch (error) {
        console.error('Tarifler klasÃ¶rÃ¼ yenileme hatasÄ±:', error);
        alert('âŒ Tarifler klasÃ¶rÃ¼ yenileme hatasÄ±:\n\n' + error.message);
      }
    }
    window.sadeceTariflerKlasoruYenile = sadeceTariflerKlasoruYenile;

    // ========================
    // YENÄ° SIDEBAR LAYOUT FONKSÄ°YONLARI
    // ========================

    // Aktif hastayÄ± seÃ§tiÄŸimizde eÅŸleÅŸen kartlarÄ± gÃ¶ster
    function hastaSecildiginde(hastaIndex) {
      console.log(`ğŸ‘¤ Hasta seÃ§ildi: ${hastaIndex}`);
      
      // PDF butonunu gÃ¶ster/gizle
      togglePdfButton();
      
      // Mevcut aktif hafta iÃ§in eÅŸleÅŸen kartlarÄ± sidebar'da gÃ¶ster
      const actTab = document.querySelector('.hafta-tab.active');
      if (actTab) {
        const haftaIndex = parseInt(actTab.dataset.haftaIndex);
        if (!isNaN(haftaIndex)) {
          gosterEslesenKartlarSidebar(haftaIndex);
        }
      }
      
      // Hasta seÃ§ildiÄŸinde yemek analizini gÃ¼ncelle
      setTimeout(() => {
        updateYemekAnalizi();
      }, 500); // Hasta verilerinin yÃ¼klenmesi iÃ§in kÄ±sa gecikme
    }
    window.hastaSecildiginde = hastaSecildiginde;

    // Hafta tab'Ä± seÃ§ildiÄŸinde sidebar'larÄ± gÃ¼ncelle
    function haftaTabSecildiginde(haftaIndex) {
      console.log(`ğŸ”„ Hafta tab'Ä± seÃ§ildi: ${haftaIndex}`);
      window.aktifHaftaIndex = haftaIndex;
      gosterEslesenKartlarSidebar(haftaIndex);
      
      // Yemek analizini her hafta deÄŸiÅŸiminde otomatik gÃ¼ncelle
      updateYemekAnalizi();
      
      // Yemek veritabanÄ± analizini de gÃ¼ncelle
      updateYemekVeritabaniAnalizi();
      
      // EÅŸleÅŸmeyen tarifleri hafta tabÄ±na gÃ¶re gÃ¼ncelle
      updateEslesmeyenTariflerHaftaTabina(haftaIndex);
    }
    window.haftaTabSecildiginde = haftaTabSecildiginde;

    // EÅŸleÅŸmeyen tarifleri hafta tabÄ±na gÃ¶re gÃ¼ncelle
    function updateEslesmeyenTariflerHaftaTabina(haftaIndex) {
      console.log(`ğŸ”„ EÅŸleÅŸmeyen tarifler gÃ¼ncelleniyor, hafta: ${haftaIndex}`);
      
      const eslesmeyenlerContent = document.getElementById('eslesmeyenlerContent');
      const eslesmeyenlerBaslik = document.getElementById('eslesmeyenlerBaslik');
      
      if (!eslesmeyenlerContent || !eslesmeyenlerBaslik) {
        console.log('ğŸ” EÅŸleÅŸmeyenler DOM elementleri bulunamadÄ±');
        return;
      }
      
      const haftaListesi = getHaftaListesi();
      const hafta = haftaListesi[haftaIndex];
      
      if (!hafta || !hafta.tarifler || hafta.tarifler.length === 0) {
        eslesmeyenlerBaslik.textContent = 'ğŸš« EÅŸleÅŸmeyen Tarifler';
        eslesmeyenlerContent.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">Bu hafta iÃ§in tarif bulunamadÄ±</div>';
        return;
      }
      
      let eslesmeyenTarifler = [];
      
      // Ã–nce JSON'dan kaydedilmiÅŸ eÅŸleÅŸmeyen tarifleri al
      if (hafta.eslesmeyenTarifler && hafta.eslesmeyenTarifler.length > 0) {
        eslesmeyenTarifler = [...hafta.eslesmeyenTarifler];
      } else {
        // JSON'da yoksa hesapla
        hafta.tarifler.forEach(tarif => {
          // Normalize et
          function normalizeLocal(str) {
            return str
              .toLowerCase()
              .replace(/Ã§/g, 'c').replace(/ÄŸ/g, 'g').replace(/ÅŸ/g, 's')
              .replace(/Ã¼/g, 'u').replace(/Ã¶/g, 'o').replace(/Ä±/g, 'i')
              .replace(/iÌ‡/g, 'i')
              .replace(/[_*\/()]/g, ' ')
              .replace(/\s+/g, ' ')
              .replace(/[^a-z0-9\s]/g, '')
              .trim();
          }
          
          const normalizedTarif = normalizeLocal(tarif);
          
          // Otomatik eÅŸleÅŸme kontrolÃ¼
          const otomatikEslesen = tariflerKlasoruGorselleri.some(kart => {
            const normalizedKart = normalizeLocal(kart.name.replace(/\.[^/.]+$/, ''));
            return normalizedKart.includes(normalizedTarif) || 
                   normalizedTarif.includes(normalizedKart) ||
                   normalizedKart === normalizedTarif;
          });
          
          // Manuel eÅŸleÅŸme kontrolÃ¼  
          const manuelEslesen = manuelEslestirmeler[normalizedTarif];
          
          // Yasak kural kontrolÃ¼
          const yasakMi = eslesmemeKurallari[normalizedTarif];
          
          // EÄŸer hiÃ§bir yerde eÅŸleÅŸmiyor ve yasaklanmamÄ±ÅŸsa eÅŸleÅŸmeyen listesine ekle
          if (!otomatikEslesen && !manuelEslesen && !yasakMi && !eslesmeyenTarifler.includes(tarif)) {
            eslesmeyenTarifler.push(tarif);
          }
        });
      }
      
      // UI'Ä± gÃ¼ncelle
      if (eslesmeyenTarifler.length > 0) {
        eslesmeyenlerBaslik.textContent = `ğŸš« EÅŸleÅŸmeyen Tarifler (${eslesmeyenTarifler.length})`;
        eslesmeyenlerContent.innerHTML = '';
        
        eslesmeyenTarifler.forEach(tarif => {
          const p = document.createElement('p');
          p.textContent = tarif;
          p.style.color = '#dc3545';
          p.style.margin = '6px 0';
          p.style.padding = '4px 8px';
          p.style.background = '#fff5f5';
          p.style.borderLeft = '3px solid #dc3545';
          p.style.borderRadius = '4px';
          p.style.cursor = 'pointer';
          p.style.transition = 'background-color 0.2s';
          p.title = 'TÄ±kla ve manuel eÅŸleÅŸtirme yap';
          
          p.onmouseenter = () => p.style.background = '#ffe6e6';
          p.onmouseleave = () => p.style.background = '#fff5f5';
          p.onclick = () => {
            console.log('ğŸ”— EÅŸleÅŸmeyen tarif adÄ±na tÄ±klandÄ±:', tarif);
            try {
              if (typeof eslesmeyenTarifManuelEslestir === 'function') {
                eslesmeyenTarifManuelEslestir(tarif);
              } else {
                console.error('âŒ eslesmeyenTarifManuelEslestir fonksiyonu bulunamadÄ±!');
                alert('Manuel eÅŸleÅŸtirme fonksiyonu yÃ¼klenemedi. SayfayÄ± yenileyin.');
              }
            } catch (error) {
              console.error('âŒ EÅŸleÅŸmeyen tarif tÄ±klama hatasÄ±:', error);
              alert('Hata: ' + error.message);
            }
          };
          
          eslesmeyenlerContent.appendChild(p);
        });
      } else {
        eslesmeyenlerBaslik.textContent = 'ğŸš« EÅŸleÅŸmeyen Tarifler';
        eslesmeyenlerContent.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">ğŸ‰ TÃ¼m tarifler eÅŸleÅŸtirildi!</div>';
      }
      
      console.log(`ğŸ”„ Hafta ${haftaIndex + 1} eÅŸleÅŸmeyen tarifleri gÃ¼ncellendi:`, eslesmeyenTarifler.length, 'adet');
    }

    // EÅŸleÅŸen kartlarÄ± saÄŸ sidebar'da gÃ¶ster
    function gosterEslesenKartlarSidebar(haftaIndex) {
      console.log(`ğŸ” gosterEslesenKartlarSidebar Ã§aÄŸrÄ±ldÄ±, hafta index: ${haftaIndex}`);
      
      const currentDiv = document.getElementById('eslesenContent');
      if (!currentDiv) {
        console.log('âŒ eslesenContent div bulunamadÄ±!');
        return;
      }
      
      const eskiDiv = document.getElementById(`eslesenKartlar_${haftaIndex}`);
      console.log(`ğŸ” eslesenKartlar_${haftaIndex} div:`, eskiDiv);
      console.log(`ğŸ” eskiDiv children count:`, eskiDiv ? eskiDiv.children.length : 'div null');
      
      // Ã–nce temizle
      currentDiv.innerHTML = '';
      
      // EÅŸleÅŸen kartlar baÅŸlÄ±ÄŸÄ±nÄ± gÃ¼ncelle
      const eslesenBaslik = document.getElementById('eslesenBaslik');
      
      let kartVarMi = false;
      
      // 1. Otomatik eÅŸleÅŸen kartlarÄ± ekle
      if (eskiDiv && eskiDiv.children.length > 0) {
        console.log('âœ… Otomatik eÅŸleÅŸen kartlar bulundu, sidebar\'a klonlanÄ±yor...');
        
        // Her child elementi klonla ve onclick eventleri yeniden ekle
        Array.from(eskiDiv.children).forEach(child => {
          const clonedChild = child.cloneNode(true);
          
          // Klonlanan element iÃ§indeki tÄ±klanabilir span'larÄ± bul ve onclick ekle
          const clickableSpans = clonedChild.querySelectorAll('span[style*="cursor: pointer"]');
          clickableSpans.forEach(span => {
            const tarifText = span.textContent.replace(/^[^:]*:\s*/, '').trim(); // "Tarif: xyz" formatÄ±ndan "xyz" al
            console.log('ğŸ”§ Sidebar klonuna onclick ekleniyor:', tarifText);
            
            span.onclick = () => {
              console.log('ğŸ”§ Sidebar\'dan eÅŸleÅŸen tarif adÄ±na tÄ±klandÄ±:', tarifText);
              try {
                if (typeof eslesenTarifManuelEslestir === 'function') {
                  // Orjinal kartlarÄ± bul
                  const aktifHaftaIndex = getAktifHaftaIndex();
                  const hafta = seciliHasta?.haftalar?.[aktifHaftaIndex];
                  if (hafta?.tarifKartlar) {
                    const eslesmeTarifKartlari = hafta.tarifKartlar.filter(kart => 
                      kart.tarifAdi.toLowerCase() === tarifText.toLowerCase()
                    );
                    eslesenTarifManuelEslestir(tarifText, eslesmeTarifKartlari);
                  }
                } else {
                  console.error('âŒ eslesenTarifManuelEslestir fonksiyonu bulunamadÄ±!');
                  alert('Manuel eÅŸleÅŸtirme fonksiyonu yÃ¼klenemedi. SayfayÄ± yenileyin.');
                }
              } catch (error) {
                console.error('âŒ Sidebar eÅŸleÅŸen tarif tÄ±klama hatasÄ±:', error);
                alert('Hata: ' + error.message);
              }
            };
          });
          
          currentDiv.appendChild(clonedChild);
        });
        
        kartVarMi = true;
      }
      
      // 2. Manuel eklenen kartlarÄ± ekle
      if (seciliHasta && seciliHasta.haftalar && seciliHasta.haftalar[haftaIndex]) {
        const hafta = seciliHasta.haftalar[haftaIndex];
        if (hafta.manuelKartlar && hafta.manuelKartlar.length > 0) {
          console.log('âœ… Manuel kartlar bulundu, ekleniyor...', hafta.manuelKartlar);
          
          hafta.manuelKartlar.forEach(kart => {
            const kartDiv = document.createElement('div');
            kartDiv.style.cssText = 'display: inline-block; margin: 10px; position: relative; vertical-align: top;';
            kartDiv.className = 'manuel-kart';
            
            // Kart adÄ±nÄ± dÃ¼zenle
            const kartBaslik = kart.name.replace('.jpg', '').replace(/_/g, ' ');
            
            kartDiv.innerHTML = `
              <div style="background: white; border: 3px solid #ffd700; border-radius: 12px; padding: 15px; width: 200px; box-shadow: 0 4px 8px rgba(255,215,0,0.3);">
                <img src="${kart.data}" alt="${kart.name}" title="${kartBaslik}" 
                     style="width: 100%; height: 120px; object-fit: cover; object-position: top; border-radius: 8px; margin-bottom: 10px;">
                
                <div style="font-size: 13px; font-weight: bold; color: #333; margin-bottom: 5px; text-align: center;">
                  ${kartBaslik}
                </div>
                
                <div style="background: #ffd700; color: #333; text-align: center; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: bold; margin-bottom: 8px;">
                  ğŸ–ï¸ MANUEL EKLENEN
                </div>
                
                <div style="text-align: center;">
                  <button onclick="manuelKartSil('${kart.name}', ${haftaIndex})" 
                          style="background: #dc3545; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 11px;">
                    ğŸ—‘ï¸ Sil
                  </button>
                </div>
              </div>
            `;
            
            currentDiv.appendChild(kartDiv);
          });
          
          kartVarMi = true;
        }
        
        // 3. Ã‡oklu PDF'den eklenen kartlarÄ± ekle
        if (hafta.cokluPdfVerileri && hafta.cokluPdfVerileri.length > 0) {
          console.log('âœ… Ã‡oklu PDF kartlarÄ± bulundu, ekleniyor...', hafta.cokluPdfVerileri);
          
          hafta.cokluPdfVerileri.forEach((veri, veriIndex) => {
            if (veri.tarifKartlar && veri.tarifKartlar.length > 0) {
              veri.tarifKartlar.forEach(kart => {
                const kartDiv = document.createElement('div');
                kartDiv.style.cssText = 'display: inline-block; margin: 10px; position: relative; vertical-align: top;';
                kartDiv.className = 'coklu-pdf-kart';
                kartDiv.setAttribute('data-kart-name', kart.name);
                
                // Kart adÄ±nÄ± dÃ¼zenle
                const kartBaslik = kart.name.replace('.jpg', '').replace(/_/g, ' ');
                
                kartDiv.innerHTML = `
                  <div style="background: white; border: 3px solid #17a2b8; border-radius: 12px; padding: 15px; width: 200px; box-shadow: 0 4px 8px rgba(23,162,184,0.3);">
                    <img src="${kart.data}" alt="${kart.name}" title="${kartBaslik}" 
                         style="width: 100%; height: 120px; object-fit: cover; object-position: top; border-radius: 8px; margin-bottom: 10px;">
                    
                    <div style="font-size: 13px; font-weight: bold; color: #333; margin-bottom: 5px; text-align: center;">
                      ${kartBaslik}
                    </div>
                    
                    <div style="background: #17a2b8; color: white; text-align: center; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: bold; margin-bottom: 8px;">
                      ğŸ“ Ã‡OKLU PDF'DEN
                    </div>
                    
                    <div style="text-align: center;">
                      <button onclick="cokluPdfKartSil('${kart.name}', ${haftaIndex}, ${veriIndex})" 
                              style="background: #dc3545; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 11px;">
                        ğŸ—‘ï¸ Sil
                      </button>
                    </div>
                  </div>
                `;
                
                currentDiv.appendChild(kartDiv);
              });
            }
          });
          
          kartVarMi = true;
        }
      }
      
      // 3. EÄŸer hiÃ§ kart yoksa mesaj gÃ¶ster
      if (!kartVarMi) {
        console.log('âŒ HiÃ§ kart bulunamadÄ±');
        currentDiv.innerHTML = '<div style="text-align: center; color: #666; padding: 40px; font-size: 12px;">Bu hafta iÃ§in henÃ¼z eÅŸleÅŸme yok.</div>';
        if (eslesenBaslik) {
          eslesenBaslik.textContent = 'ğŸ“‹ EÅŸleÅŸen Kartlar';
        }
      } else {
        console.log('âœ… Kartlar sidebar\'a baÅŸarÄ±yla eklendi');
        
        // Benzersiz yemek Ã§eÅŸidi sayÄ±sÄ±nÄ± hesapla
        const benzersizYemekler = new Set();
        
        // TÃ¼m kartlardaki yemek isimlerini topla
        const tumKartlar = currentDiv.querySelectorAll('[data-kart-name]');
        tumKartlar.forEach(kart => {
          const kartName = kart.getAttribute('data-kart-name');
          if (kartName) {
            // .jpg uzantÄ±sÄ±nÄ± kaldÄ±r ve normalize et
            const yemekAdi = kartName.replace('.jpg', '').replace(/_/g, ' ').toLowerCase();
            benzersizYemekler.add(yemekAdi);
          }
        });
        
        // EÄŸer data-kart-name yoksa, gÃ¶rsel isimlerden Ã§Ä±kar
        if (benzersizYemekler.size === 0) {
          const gorselKartlari = currentDiv.querySelectorAll('img');
          gorselKartlari.forEach(img => {
            if (img.src && img.src.includes('/')) {
              const dosyaAdi = img.src.split('/').pop();
              const yemekAdi = dosyaAdi.replace('.jpg', '').replace(/_/g, ' ').toLowerCase();
              benzersizYemekler.add(yemekAdi);
            }
          });
        }
        
        const benzersizSayisi = benzersizYemekler.size;
        console.log('ğŸ½ï¸ Benzersiz yemek Ã§eÅŸidi sayÄ±sÄ±:', benzersizSayisi, 'Toplam kart:', currentDiv.children.length);
        
        // BaÅŸlÄ±k gÃ¼ncelle - benzersiz yemek Ã§eÅŸidi sayÄ±sÄ± ile
        if (eslesenBaslik) {
          eslesenBaslik.textContent = `ğŸ“‹ EÅŸleÅŸen Kartlar (${benzersizSayisi})`;
        }
        
        // Sadece gÃ¼venlik iÃ§in onclick'leri yeniden ata (otomatik kartlar iÃ§in)
        const tumButonlar = currentDiv.querySelectorAll('button:not(.manuel-kart-silme-btn)');
        console.log('ğŸ” Sidebar\'da bulunan buton sayÄ±sÄ±:', tumButonlar.length);
        
        tumButonlar.forEach((btn, index) => {
          if (btn.textContent.includes('ZIP Ä°ndir')) {
            console.log('ğŸ” ZIP butonu bulundu, onclick kontrol ediliyor...');
            if (!btn.onclick) {
              console.log('ğŸ”§ ZIP butonu onclick eksik, yeniden atanÄ±yor...');
              btn.onclick = function(e) { 
                e.preventDefault();
                console.log('ğŸ¯ ZIP butonuna tÄ±klandÄ± (sidebar), hafta index:', haftaIndex);
                zipEslesenGorseller(haftaIndex); 
              };
            }
          }
        });
      }
    }
    window.gosterEslesenKartlarSidebar = gosterEslesenKartlarSidebar;

    // ========================
    // SAYFA BAÅLATMA
    // ========================
    
    // Sayfa yÃ¼klendiÄŸinde Ã§alÄ±ÅŸacak baÅŸlatma fonksiyonu - SADECE YENÄ° SÄ°STEM
    async function sayfaBaslat() {
      console.log('ğŸš€ YENÄ° SÄ°STEM BAÅLATILIYOR - Eski sistem devre dÄ±ÅŸÄ±');
      
      // Sadece yeni sistemi yÃ¼kle
      console.log('ğŸ“‹ SADECE YENÄ° SÄ°STEM: hasta listesi yÃ¼kleniyor...');
      
      // Token kontrolÃ¼
      const token = document.getElementById('githubToken').value.trim();
      if (!token) {
        console.log('â„¹ï¸ GitHub token yok - Offline modda baÅŸlatÄ±lÄ±yor');
        
        // BoÅŸ yeni sistem baÅŸlat
        hastaListesi = [];
        renderHastalarYeniSistem();
        
        // KullanÄ±cÄ±ya bilgi ver
        const durum = document.getElementById('githubDurumu');
        if (durum) {
          durum.innerHTML = 'âš ï¸ GitHub token gerekli - Token girin';
        }
        
        return;
      }
      
      // Token varsa direkt yeni sistemi yÃ¼kle
      try {
        console.log('ğŸ”„ GitHub token mevcut, yeni sistem yÃ¼kleniyor...');
        await loadHastaDataFromGitHub(true); // sessiz yÃ¼kleme
        console.log('âœ… Yeni sistem baÅŸarÄ±yla yÃ¼klendi');
      } catch (error) {
        console.warn('âš ï¸ Yeni sistem yÃ¼klenemedi, boÅŸ sistem baÅŸlatÄ±lÄ±yor:', error.message);
        hastaListesi = [];
        renderHastalarYeniSistem();
      }
      
      // Toplu ZIP butonunu ekle
      ekleTopluZipButonu();
    }
    
    // Toplu ZIP butonunu sidebar'a ekle
    function ekleTopluZipButonu() {
      const sidebarButtons = document.getElementById('sidebarButtons');
      if (sidebarButtons) {
        // EÄŸer buton zaten varsa tekrar ekleme
        if (sidebarButtons.querySelector('.toplu-zip-button')) {
          return;
        }
        
        const topluZipButton = document.createElement('button');
        topluZipButton.className = 'toplu-zip-button';
        topluZipButton.innerHTML = 'ğŸ—œï¸ TOPLU ZIP Ä°NDÄ°R';
        topluZipButton.title = 'TÃ¼m aktif hastalarÄ±n en son hafta tablarÄ±nÄ± tek ZIP dosyasÄ±nda indir';
        topluZipButton.style.cssText = `
          width: 100%; 
          padding: 12px; 
          font-size: 14px; 
          font-weight: bold; 
          background: linear-gradient(45deg, #ff6b6b, #ee5a24); 
          color: white; 
          border: none; 
          border-radius: 6px; 
          cursor: pointer; 
          margin-bottom: 10px;
          box-shadow: 0 2px 4px rgba(0,0,0,0.2);
          transition: all 0.3s ease;
        `;
        
        // Hover efekti iÃ§in
        topluZipButton.addEventListener('mouseenter', function() {
          this.style.transform = 'translateY(-2px)';
          this.style.boxShadow = '0 4px 8px rgba(0,0,0,0.3)';
        });
        
        topluZipButton.addEventListener('mouseleave', function() {
          this.style.transform = 'translateY(0)';
          this.style.boxShadow = '0 2px 4px rgba(0,0,0,0.2)';
        });
        
        topluZipButton.onclick = function() {
          topluZipIndir();
        };
        
        // Butonu sidebar'a ekle
        sidebarButtons.appendChild(topluZipButton);
        console.log('âœ… Toplu ZIP butonu eklendi');
      }
    }
    
    // === MÄ°GRATION COMPLETED - YENÄ° SÄ°STEM AKTÄ°F ===
    // ARTIK SADECE YENÄ° JSON SÄ°STEMÄ° KULLANILIYOR
    // - data/hasta_kayitlari.json kullanÄ±lmÄ±yor
    // - TÃ¼m hastalar patients/ klasÃ¶rÃ¼nde ayrÄ± JSON dosyalarÄ±
    // - Hasta listesi patients/hastalar_listesi.json dosyasÄ±nda
    // - Eski sistem fonksiyonlarÄ± yeni sisteme yÃ¶nlendiriliyor
    
    // ========================
    // MANUEL KART EKLEME SÄ°STEMÄ°
    // ========================
    
    let aktifHaftaIndex = null;
    let secilenManuelKartlar = [];
    
    // YEMEK ANALÄ°ZÄ° DEÄÄ°ÅKENLERÄ°
    let yemekAnaliziAcikMi = false;
    let yemekAnaliziSiralama = 'cok'; // 'cok', 'az', 'alfabetik'
    
    function manuelKartEklemeModalAc() {
      // Hasta kontrolÃ¼
      if (!seciliHasta) {
        alert('Ã–nce bir hasta seÃ§in!');
        return;
      }
      
      // Ã–nce aktif hafta tab'Ä±nÄ± bul
      const aktifTab = document.querySelector('.hafta-tab.active');
      if (!aktifTab) {
        alert('Ã–nce bir hafta seÃ§in!');
        return;
      }
      
      aktifHaftaIndex = parseInt(aktifTab.dataset.haftaIndex);
      if (isNaN(aktifHaftaIndex)) {
        alert('Hafta bilgisi alÄ±namadÄ±!');
        return;
      }
      
      // Hafta verisi kontrolÃ¼
      if (!seciliHasta.haftalar || !seciliHasta.haftalar[aktifHaftaIndex]) {
        alert('Bu hafta iÃ§in veri bulunamadÄ±!');
        return;
      }
      
      const hafta = seciliHasta.haftalar[aktifHaftaIndex];
      
      console.log('ğŸ” Manuel kart ekleme baÅŸlatÄ±ldÄ±:', {
        hastaId: seciliHasta.id,
        hastaAdi: seciliHasta.isim,
        haftaIndex: aktifHaftaIndex,
        haftaNo: hafta.haftaNo || 'belirsiz'
      });
      
      // Modal'Ä± aÃ§
      document.getElementById('manuelKartModal').style.display = 'block';
      document.getElementById('manuelKartArama').value = '';
      secilenManuelKartlar = [];
      
      // TÃ¼m kartlarÄ± yÃ¼kle (arama boÅŸ bÄ±rakÄ±lmÄ±ÅŸ gibi)
      manuelKartAramaYap('');
      
      // Modal baÅŸlÄ±ÄŸÄ±nÄ± gÃ¼ncelle
      const modalBaslik = document.querySelector('#manuelKartModal h3');
      if (modalBaslik) {
        modalBaslik.textContent = `Manuel Kart Ekleme - ${seciliHasta.isim} (${hafta.haftaNo || aktifHaftaIndex + 1}. Hafta)`;
      }
    }
    
    function manuelKartModalKapat(event) {
      if (event && event.target !== document.getElementById('manuelKartModal')) return;
      
      console.log('ğŸ”’ Manuel kart modal kapatÄ±lÄ±yor');
      
      document.getElementById('manuelKartModal').style.display = 'none';
      secilenManuelKartlar = [];
      aktifHaftaIndex = null; // State'i temizle
      
      // Modal baÅŸlÄ±ÄŸÄ±nÄ± sÄ±fÄ±rla
      const modalBaslik = document.querySelector('#manuelKartModal h3');
      if (modalBaslik) {
        modalBaslik.textContent = 'Manuel Kart Ekleme';
      }
    }
    
    function manuelKartAramaYap(aramaMetni) {
      const liste = document.getElementById('manuelKartListe');
      
      console.log('ğŸ” Manuel kart arama debug:', {
        aramaMetni,
        windowTarifKartlari: window.tarifKartlari,
        tarifKartlariLength: window.tarifKartlari ? window.tarifKartlari.length : 'undefined'
      });
      
      // Tarif kartlarÄ± listesinden ara
      if (!window.tarifKartlari || window.tarifKartlari.length === 0) {
        console.log('âŒ Tarif kartlarÄ± yÃ¼klenmemiÅŸ veya boÅŸ!');
        liste.innerHTML = '<div style="text-align: center; color: #dc3545; padding: 20px;">Tarif kartlarÄ± yÃ¼klenmemiÅŸ!</div>';
        return;
      }
      
      // Mevcut kartlarÄ± kategorize et
      const mevcutOtomatikKartlar = [];
      const mevcutManuelKartlar = [];
      
      if (seciliHasta && seciliHasta.haftalar && aktifHaftaIndex !== null && seciliHasta.haftalar[aktifHaftaIndex]) {
        const hafta = seciliHasta.haftalar[aktifHaftaIndex];
        
        // Otomatik eÅŸleÅŸen kartlar
        if (hafta.tarifKartlar) {
          hafta.tarifKartlar.forEach(kart => {
            if (kart.name) {
              mevcutOtomatikKartlar.push(kart.name);
            }
          });
        }
        
        // Manuel eklenen kartlar
        if (hafta.manuelKartlar) {
          hafta.manuelKartlar.forEach(kart => {
            if (kart.name) {
              mevcutManuelKartlar.push(kart.name);
            }
          });
        }
      }
      
      // TÃ¼m kartlarÄ± filtrele (arama kriterlerine gÃ¶re)
      let tumKartlar = window.tarifKartlari;
      
      // Arama metni varsa filtreleme yap
      if (aramaMetni && aramaMetni.trim().length > 0) {
        const aramaKelimeler = aramaMetni.toLowerCase().trim().split(/\s+/)
          .map(kelime => karakterDuzelt(kelime));
        
        console.log('ğŸ” Arama kelimeleri (normalize edilmiÅŸ):', aramaKelimeler);
        
        tumKartlar = tumKartlar.filter(kart => {
          const kartAdi = karakterDuzelt(kart.replace('.jpg', '').replace(/_/g, ' ').toLowerCase());
          
          console.log(`ğŸ” Test edilen kart: "${kart}" â†’ normalize: "${kartAdi}"`);
          
          // TÃ¼m arama kelimelerinin kart adÄ±nda bulunmasÄ± gerekiyor
          const eslesiyor = aramaKelimeler.every(kelime => {
            const bulundu = kartAdi.includes(kelime);
            console.log(`  âœ“ "${kelime}" kelimesi "${kartAdi}" iÃ§inde: ${bulundu}`);
            return bulundu;
          });
          
          console.log(`ğŸ“Š "${kart}" filtreleme sonucu: ${eslesiyor}`);
          return eslesiyor;
        });
        
        console.log(`ğŸ“‹ Filtreleme sonrasÄ± kart sayÄ±sÄ±: ${tumKartlar.length}`);
      }
      
      // SonuÃ§larÄ± eÅŸleÅŸme skoruna gÃ¶re sÄ±rala
      if (aramaMetni && aramaMetni.trim().length > 0) {
        const aramaKelimeler = aramaMetni.toLowerCase().trim().split(/\s+/)
          .map(kelime => karakterDuzelt(kelime));
        
        tumKartlar.sort((a, b) => {
          const aAdi = karakterDuzelt(a.replace('.jpg', '').replace(/_/g, ' ').toLowerCase());
          const bAdi = karakterDuzelt(b.replace('.jpg', '').replace(/_/g, ' ').toLowerCase());
          
          // Tam arama metni eÅŸleÅŸmesi
          const aramaTam = aramaKelimeler.join(' ');
          const aIceriyor = aAdi.includes(aramaTam);
          const bIceriyor = bAdi.includes(aramaTam);
          
          if (aIceriyor && !bIceriyor) return -1;
          if (!aIceriyor && bIceriyor) return 1;
          
          // BaÅŸlangÄ±Ã§ eÅŸleÅŸmesi
          const aBaslangic = aramaKelimeler.some(kelime => aAdi.startsWith(kelime));
          const bBaslangic = aramaKelimeler.some(kelime => bAdi.startsWith(kelime));
          
          if (aBaslangic && !bBaslangic) return -1;
          if (!aBaslangic && bBaslangic) return 1;
          
          // Alfabetik sÄ±ralama
          return a.localeCompare(b, 'tr-TR');
        });
      }
      
      if (tumKartlar.length === 0) {
        liste.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">SonuÃ§ bulunamadÄ±</div>';
        return;
      }
      
      // SonuÃ§larÄ± liste olarak gÃ¶ster
      let html = '<div style="max-height: 300px; overflow-y: auto;">';
      
      tumKartlar.forEach(kart => {
        const kartAdi = kart.replace('.jpg', '').replace(/_/g, ' ');
        const otomatikMi = mevcutOtomatikKartlar.includes(kart);
        const manuelMi = mevcutManuelKartlar.includes(kart);
        const seciliMi = secilenManuelKartlar.includes(kart);
        const pasifMi = otomatikMi || manuelMi;
        
        let backgroundColor, hoverColor, textColor, prefix, icon;
        
        if (manuelMi) {
          // Manuel eklenen - SarÄ± marker
          backgroundColor = 'rgba(255, 215, 0, 0.2)'; // Transparan sarÄ±
          hoverColor = 'rgba(255, 215, 0, 0.3)';
          textColor = '#666';
          prefix = 'ğŸ–ï¸ ';
          icon = '';
        } else if (otomatikMi) {
          // Otomatik eÅŸleÅŸen - YeÅŸil marker  
          backgroundColor = 'rgba(40, 167, 69, 0.2)'; // Transparan yeÅŸil
          hoverColor = 'rgba(40, 167, 69, 0.3)';
          textColor = '#666';
          prefix = 'ğŸ”— ';
          icon = '';
        } else if (seciliMi) {
          // Yeni seÃ§ilen
          backgroundColor = '#e8f5e8';
          hoverColor = '#d4edda';
          textColor = '#333';
          prefix = '';
          icon = '';
        } else {
          // HenÃ¼z eklenmemiÅŸ
          backgroundColor = 'white';
          hoverColor = '#f8f9fa';
          textColor = '#333';
          prefix = '';
          icon = '';
        }
        
        html += `
          <div ${pasifMi ? '' : `onclick="manuelKartToggle('${kart}')"`} style="
            cursor: ${pasifMi ? 'not-allowed' : 'pointer'}; 
            padding: 8px 12px; 
            border-bottom: 1px solid #eee;
            background: ${backgroundColor};
            display: flex;
            align-items: center;
            transition: background 0.2s;
            opacity: ${pasifMi ? '0.7' : '1'};
          " ${pasifMi ? '' : `onmouseover="this.style.background='${hoverColor}'" onmouseout="this.style.background='${backgroundColor}'"`}>
            ${pasifMi ? 
              `<span style="margin-right: 10px; color: #999;">â—</span>` : 
              `<input type="checkbox" ${seciliMi ? 'checked' : ''} style="margin-right: 10px; pointer-events: none;" />`
            }
            <span style="font-size: 14px; color: ${textColor}; flex: 1;">${prefix}${kartAdi}</span>
            ${manuelMi ? '<span style="font-size: 11px; color: #856404; background: rgba(255, 215, 0, 0.3); padding: 2px 6px; border-radius: 10px; margin-left: 8px;">MANUEL</span>' : ''}
            ${otomatikMi ? '<span style="font-size: 11px; color: #155724; background: rgba(40, 167, 69, 0.3); padding: 2px 6px; border-radius: 10px; margin-left: 8px;">OTOMATÄ°K</span>' : ''}
          </div>
        `;
      });
      
      html += '</div>';
      liste.innerHTML = html;
    }
    
    function manuelKartToggle(kartAdi) {
      const index = secilenManuelKartlar.indexOf(kartAdi);
      if (index > -1) {
        secilenManuelKartlar.splice(index, 1);
      } else {
        secilenManuelKartlar.push(kartAdi);
      }
      
      // Listeyi gÃ¼ncelle (mevcut arama metnini koru)
      const aramaMetni = document.getElementById('manuelKartArama').value;
      manuelKartAramaYap(aramaMetni);
    }
    
    function getMevcutHaftaKartlari() {
      if (!seciliHasta || !seciliHasta.haftalar || aktifHaftaIndex === null || !seciliHasta.haftalar[aktifHaftaIndex]) {
        return [];
      }
      
      const hafta = seciliHasta.haftalar[aktifHaftaIndex];
      const kartlar = [];
      
      console.log('ğŸ” Mevcut hafta kartlarÄ± kontrol ediliyor:', {
        hastaId: seciliHasta.id,
        hastaAdi: seciliHasta.isim,
        haftaIndex: aktifHaftaIndex,
        haftaNo: hafta.haftaNo
      });
      
      // Otomatik eÅŸleÅŸen kartlar
      if (hafta.tarifKartlar) {
        hafta.tarifKartlar.forEach(kart => {
          if (kart.name) {
            kartlar.push(kart.name);
            console.log('ğŸ“„ Otomatik kart bulundu:', kart.name);
          }
        });
      }
      
      // Manuel eklenen kartlar (sadece bu hafta iÃ§in)
      if (hafta.manuelKartlar) {
        hafta.manuelKartlar.forEach(kart => {
          if (kart.name) {
            kartlar.push(kart.name);
            console.log('ğŸ–ï¸ Manuel kart bulundu:', kart.name);
          }
        });
      }
      
      console.log('âœ… Toplam mevcut kartlar:', kartlar);
      return kartlar;
    }
    
    function secilenManuelKartlariEkle() {
      if (secilenManuelKartlar.length === 0) {
        alert('HiÃ§ kart seÃ§ilmedi!');
        return;
      }
      
      if (!seciliHasta) {
        alert('Hasta seÃ§ilmemiÅŸ!');
        return;
      }
      
      console.log('ğŸ“ Manuel kartlar ekleniyor:', secilenManuelKartlar);
      
      // Hasta verilerine manuel kartlarÄ± ekle
      if (!seciliHasta.haftalar[aktifHaftaIndex]) {
        alert('Hafta verisi bulunamadÄ±!');
        return;
      }
      
      const hafta = seciliHasta.haftalar[aktifHaftaIndex];
      if (!hafta.manuelKartlar) {
        hafta.manuelKartlar = [];
      }
      
      // Yeni kartlarÄ± ekle
      secilenManuelKartlar.forEach(kartAdi => {
        hafta.manuelKartlar.push({
          name: kartAdi,
          data: `https://mustafasacar35.github.io/lipodem-takip-paneli-3/tarifler/${kartAdi}`,
          eklenmeTarihi: new Date().toISOString()
        });
      });
      
      console.log('âœ… Manuel kartlar hafta verisine eklendi');
      
      // Alert iÃ§in kart sayÄ±sÄ±nÄ± sakla (modal kapatÄ±lmadan Ã¶nce)
      const eklenenKartSayisi = secilenManuelKartlar.length;
      
      // Verileri kaydet
      saveToStorage();
      hastayiAyriKaydet(seciliHasta);
      
      // Sidebar'Ä± gÃ¼ncelle
      haftaTabSecildiginde(aktifHaftaIndex);
      
      // Modal'Ä± kapat
      manuelKartModalKapat();
      
      // Yemek analizini gÃ¼ncelle
      updateYemekAnalizi();
      
      alert(`âœ… ${eklenenKartSayisi} kart baÅŸarÄ±yla eklendi!`);
    }
    
    // Manuel kart silme fonksiyonu
    function manuelKartSil(kartAdi, haftaIndex) {
      if (!seciliHasta || !seciliHasta.haftalar[haftaIndex]) {
        alert('Hasta veya hafta verisi bulunamadÄ±!');
        return;
      }
      
      const hafta = seciliHasta.haftalar[haftaIndex];
      if (!hafta.manuelKartlar) return;
      
      // KartÄ± listeden Ã§Ä±kar
      hafta.manuelKartlar = hafta.manuelKartlar.filter(kart => kart.name !== kartAdi);
      
      console.log('ğŸ—‘ï¸ Manuel kart silindi:', kartAdi);
      
      // Verileri kaydet
      saveToStorage();
      hastayiAyriKaydet(seciliHasta);
      
      // Sidebar'Ä± gÃ¼ncelle
      haftaTabSecildiginde(haftaIndex);
      
      // Yemek analizini gÃ¼ncelle
      updateYemekAnalizi();
    }
    
    // Ã‡oklu PDF kartÄ±nÄ± silme fonksiyonu
    function cokluPdfKartSil(kartAdi, haftaIndex, veriIndex) {
      if (!seciliHasta || !seciliHasta.haftalar[haftaIndex]) {
        alert('Hasta veya hafta verisi bulunamadÄ±!');
        return;
      }
      
      const hafta = seciliHasta.haftalar[haftaIndex];
      if (!hafta.cokluPdfVerileri || !hafta.cokluPdfVerileri[veriIndex]) return;
      
      const pdfVeri = hafta.cokluPdfVerileri[veriIndex];
      if (!pdfVeri.tarifKartlar) return;
      
      // KartÄ± listeden Ã§Ä±kar
      pdfVeri.tarifKartlar = pdfVeri.tarifKartlar.filter(kart => kart.name !== kartAdi);
      
      console.log('ğŸ—‘ï¸ Ã‡oklu PDF kartÄ± silindi:', kartAdi);
      
      // Verileri kaydet
      saveToStorage();
      hastayiAyriKaydet(seciliHasta);
      
      // Sidebar'Ä± gÃ¼ncelle
      haftaTabSecildiginde(haftaIndex);
      
      // Yemek analizini gÃ¼ncelle
      updateYemekAnalizi();
    }
    
    // Global olarak eriÅŸilebilir yap
    window.manuelKartEklemeModalAc = manuelKartEklemeModalAc;
    window.manuelKartModalKapat = manuelKartModalKapat;
    window.manuelKartAramaYap = manuelKartAramaYap;
    window.manuelKartToggle = manuelKartToggle;
    window.secilenManuelKartlariEkle = secilenManuelKartlariEkle;
    window.manuelKartSil = manuelKartSil;
    window.cokluPdfKartSil = cokluPdfKartSil;

    // ========================
    // SÃœRÃœKLENEBÄ°LÄ°R SIDEBAR
    // ========================
    
    function initResizableSidebars() {
      const container = document.querySelector('.main-container');
      const leftHandle = document.getElementById('leftHandle');
      const rightHandle = document.getElementById('rightHandle');
      
      let isResizing = false;
      let currentHandle = null;
      
      // Sol ayÄ±rÄ±cÄ± iÃ§in
      leftHandle.addEventListener('mousedown', (e) => {
        isResizing = true;
        currentHandle = 'left';
        document.body.style.cursor = 'ew-resize';
        document.body.style.userSelect = 'none';
        e.preventDefault();
      });
      
      // SaÄŸ ayÄ±rÄ±cÄ± iÃ§in
      rightHandle.addEventListener('mousedown', (e) => {
        isResizing = true;
        currentHandle = 'right';
        document.body.style.cursor = 'ew-resize';
        document.body.style.userSelect = 'none';
        e.preventDefault();
      });
      
      // Mouse move
      document.addEventListener('mousemove', (e) => {
        if (!isResizing) return;
        
        const containerRect = container.getBoundingClientRect();
        const mouseX = e.clientX - containerRect.left;
        
        if (currentHandle === 'left') {
          // Sol sidebar geniÅŸliÄŸini ayarla (min: 200px, max: 400px)
          const newLeftWidth = Math.max(200, Math.min(400, mouseX));
          container.style.gridTemplateColumns = `${newLeftWidth}px 4px 1fr 4px 200px`;
        } else if (currentHandle === 'right') {
          // SaÄŸ sidebar geniÅŸliÄŸini ayarla (min: 200px, max: 500px)
          const newRightWidth = Math.max(200, Math.min(500, containerRect.width - mouseX));
          container.style.gridTemplateColumns = `280px 4px 1fr 4px ${newRightWidth}px`;
        }
      });
      
      // Mouse up
      document.addEventListener('mouseup', () => {
        if (isResizing) {
          isResizing = false;
          currentHandle = null;
          document.body.style.cursor = '';
          document.body.style.userSelect = '';
        }
      });
    }
    
    // Sayfa yÃ¼klendiÄŸinde baÅŸlat
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
    // === YEMEK KULLANIM ANALÄ°ZÄ° FONKSIYONLARI ===
    
    function siralaYemekAnalizi(tip) {
      yemekAnaliziSiralama = tip;
      updateYemekAnalizi();
    }
    
    // SÄ±ralama fonksiyonunu global yap
    window.siralaYemekAnalizi = siralaYemekAnalizi;
    
    function updateYemekAnalizi() {
      console.log('ğŸ“Š updateYemekAnalizi fonksiyonu Ã§aÄŸrÄ±ldÄ±');
      
      if (!seciliHasta || !seciliHasta.haftalar) {
        document.getElementById('yemekAnaliziListe').innerHTML = 
          '<div style="text-align: center; color: #666; padding: 20px;">Hasta seÃ§ilmemiÅŸ</div>';
        return;
      }
      
      // aktifHaftaIndex null ise en son haftayÄ± al
      if (aktifHaftaIndex === null || aktifHaftaIndex === undefined) {
        aktifHaftaIndex = seciliHasta.haftalar.length - 1;
        console.log('âš ï¸ aktifHaftaIndex null, en son hafta atandÄ±:', aktifHaftaIndex);
      }
      
      // Hafta index sÄ±nÄ±rlarÄ±nÄ± kontrol et
      if (aktifHaftaIndex < 0 || aktifHaftaIndex >= seciliHasta.haftalar.length) {
        aktifHaftaIndex = seciliHasta.haftalar.length - 1;
        console.log('âš ï¸ aktifHaftaIndex sÄ±nÄ±r dÄ±ÅŸÄ±, dÃ¼zeltildi:', aktifHaftaIndex);
      }
      
      // TÃ¼m tarif kartlarÄ± yoksa veya yÃ¼klenmediyse yeniden yÃ¼kleme dene
      if (!window.tarifKartlari || window.tarifKartlari.length === 0) {
        console.log('âš ï¸ Tarif kartlarÄ± yÃ¼klenmemiÅŸ, yeniden yÃ¼kleme deneniyor...');
        
        // Tarif kartlarÄ±nÄ± yeniden yÃ¼kleme dene
        if (typeof loadTarifKartlariFromGitHub === 'function') {
          loadTarifKartlariFromGitHub().then(() => {
            console.log('âœ… Tarif kartlarÄ± yeniden yÃ¼klendi, analiz tekrar deneniyor');
            setTimeout(() => updateYemekAnalizi(), 1000); // 1 saniye sonra tekrar dene
          }).catch(err => {
            console.error('âŒ Tarif kartlarÄ± yeniden yÃ¼klenemedi:', err);
          });
        }
        
        document.getElementById('yemekAnaliziListe').innerHTML = 
          '<div style="text-align: center; color: #dc3545; padding: 20px;">Tarif kartlarÄ± yÃ¼klenmeyi bekliyor... <br><small>GitHub\'dan tarif kartlarÄ± Ã§ekiliyor</small></div>';
        return;
      }
      
      const aktifHafta = seciliHasta.haftalar[aktifHaftaIndex];
      const aktifHaftaNo = aktifHafta ? (aktifHafta.haftaNo || (aktifHaftaIndex + 1)) : 1;
      
      console.log('ğŸ“Š Yemek analizi baÅŸlatÄ±lÄ±yor:', {
        hastaId: seciliHasta.id,
        aktifHaftaIndex,
        aktifHaftaNo,
        toplamTarifKartSayisi: window.tarifKartlari.length
      });
      
      // TÃœM tarif kartlarÄ± iÃ§in kullanÄ±m sayacÄ± baÅŸlat
      const yemekKullanimlari = {};
      
      // Ã–nce tÃ¼m tarif kartlarÄ±nÄ± 0 ile baÅŸlat
      window.tarifKartlari.forEach(kart => {
        const yemekAdi = kart.replace('.jpg', '').replace(/_/g, ' ');
        yemekKullanimlari[yemekAdi] = { sayac: 0, haftalar: [] };
      });
      
      console.log('ğŸ”„ Yemek analizi baÅŸlatÄ±ldÄ±:', {
        hasta: seciliHasta.ad,
        haftaSayisi: seciliHasta.haftalar.length,
        aktifHafta: aktifHaftaNo,
        analizEdilenHaftalar: seciliHasta.haftalar.filter((_, index) => (index + 1) <= aktifHaftaNo).length
      });
      
      // SeÃ§ili haftaya kadar olan tÃ¼m haftalarÄ± kontrol et
      seciliHasta.haftalar.forEach((hafta, index) => {
        const haftaNo = hafta.haftaNo || (index + 1);
        
        // Sadece seÃ§ili haftaya kadar olan haftalarÄ± say
        if (haftaNo <= aktifHaftaNo) {
          const haftaninYemekleri = new Set(); // AynÄ± hafta iÃ§inde tekrar saymamasÄ± iÃ§in Set kullan
          
          console.log(`ğŸ” Hafta ${haftaNo} analiz ediliyor:`, {
            tarifKartlar: hafta.tarifKartlar?.length || 0,
            manuelKartlar: hafta.manuelKartlar?.length || 0,
            cokluPdfVerileri: hafta.cokluPdfVerileri?.length || 0,
            tarifKartlarVeriTipi: hafta.tarifKartlar ? typeof hafta.tarifKartlar[0] : 'undefined',
            tarifKartlarOrnek: hafta.tarifKartlar ? hafta.tarifKartlar.slice(0, 2) : [],
            manuelKartlarOrnek: hafta.manuelKartlar ? hafta.manuelKartlar.slice(0, 2) : []
          });
          
          // 1. Otomatik eÅŸleÅŸen kartlar (Manuel PDF yÃ¼kleme + Ã‡oklu PDF otomatik eÅŸleÅŸtirme)
          if (hafta.tarifKartlar && hafta.tarifKartlar.length > 0) {
            hafta.tarifKartlar.forEach(kart => {
              let kartAdi = null;
              
              // FarklÄ± veri yapÄ±larÄ±nÄ± kontrol et
              if (typeof kart === 'string') {
                kartAdi = kart; // Direkt string
              } else if (kart.name) {
                kartAdi = kart.name; // {name: "kart_adi.jpg"}
              } else if (kart.kartResmi) {
                kartAdi = kart.kartResmi; // {kartResmi: "kart_adi.jpg"}
              }
              
              if (kartAdi) {
                const yemekAdi = kartAdi.replace('.jpg', '').replace(/_/g, ' ');
                haftaninYemekleri.add(yemekAdi);
                console.log(`âœ… Otomatik eÅŸleÅŸen: ${yemekAdi}`);
              }
            });
          }
          
          // 2. Manuel eklenen kartlar (Sidebar'dan manuel ekleme)
          if (hafta.manuelKartlar && hafta.manuelKartlar.length > 0) {
            hafta.manuelKartlar.forEach(kart => {
              let kartAdi = null;
              
              // FarklÄ± veri yapÄ±larÄ±nÄ± kontrol et
              if (typeof kart === 'string') {
                kartAdi = kart; // Direkt string
              } else if (kart.name) {
                kartAdi = kart.name; // {name: "kart_adi.jpg"}
              }
              
              if (kartAdi) {
                const yemekAdi = kartAdi.replace('.jpg', '').replace(/_/g, ' ');
                haftaninYemekleri.add(yemekAdi);
                console.log(`âœ… Manuel eklenen: ${yemekAdi}`);
              }
            });
          }
          
          // 3. Ã‡oklu PDF'den eklenen kartlar (Eski yapÄ± - geriye uyumluluk)
          if (hafta.cokluPdfVerileri && hafta.cokluPdfVerileri.length > 0) {
            hafta.cokluPdfVerileri.forEach(veri => {
              if (veri.tarifKartlar && veri.tarifKartlar.length > 0) {
                veri.tarifKartlar.forEach(kart => {
                  let kartAdi = null;
                  
                  // FarklÄ± veri yapÄ±larÄ±nÄ± kontrol et
                  if (typeof kart === 'string') {
                    kartAdi = kart; // Direkt string
                  } else if (kart.name) {
                    kartAdi = kart.name; // {name: "kart_adi.jpg"}
                  } else if (kart.kartResmi) {
                    kartAdi = kart.kartResmi; // {kartResmi: "kart_adi.jpg"}
                  }
                  
                  if (kartAdi) {
                    const yemekAdi = kartAdi.replace('.jpg', '').replace(/_/g, ' ');
                    haftaninYemekleri.add(yemekAdi);
                    console.log(`âœ… Ã‡oklu PDF (eski): ${yemekAdi}`);
                  }
                });
              }
            });
          }
          
          // Her hafta iÃ§in toplam eÅŸsiz yemek sayÄ±sÄ±nÄ± raporla  
          console.log(`ğŸ“Š Hafta ${haftaNo} toplam eÅŸsiz yemek: ${haftaninYemekleri.size}`);
          
          // Bu haftada kullanÄ±lan her benzersiz yemeÄŸi kaydet
          haftaninYemekleri.forEach(yemekAdi => {
            if (yemekKullanimlari[yemekAdi]) {
              yemekKullanimlari[yemekAdi].sayac++;
              yemekKullanimlari[yemekAdi].haftalar.push(haftaNo);
            }
          });
        }
      });
      
      console.log('ğŸ“Š Toplam analiz edilen yemek sayÄ±sÄ±:', Object.keys(yemekKullanimlari).length);
      console.log('ğŸ“‹ Analiz edilen yemekler:', Object.keys(yemekKullanimlari));
      
      // Debug: Hasta verilerinin yapÄ±sÄ±nÄ± incele
      console.log('ğŸ” Hasta veri yapÄ±sÄ± analizi:', {
        hastalar: Object.keys(window.hastalar || {}),
        seciliHasta: seciliHasta?.ad || 'SeÃ§ili deÄŸil',
        haftaSayisi: seciliHasta?.haftalar?.length || 0,
        aktifHafta: aktifHaftaNo
      });
      
      // SonuÃ§larÄ± diziye Ã§evir ve sÄ±rala
      let yemekListesi = Object.keys(yemekKullanimlari).map(yemekAdi => ({
        ad: yemekAdi,
        sayac: yemekKullanimlari[yemekAdi].sayac,
        haftalar: yemekKullanimlari[yemekAdi].haftalar.sort((a,b) => a-b)
      }));
      
      // SÄ±ralama yap
      if (yemekAnaliziSiralama === 'cok') {
        yemekListesi.sort((a, b) => b.sayac - a.sayac || a.ad.localeCompare(b.ad));
      } else if (yemekAnaliziSiralama === 'az') {
        yemekListesi.sort((a, b) => a.sayac - b.sayac || a.ad.localeCompare(b.ad));
      } else if (yemekAnaliziSiralama === 'hic') {
        // Ã–nce hiÃ§ kullanÄ±lmayanlar (0), sonra kullanÄ±lanlar az->Ã§ok
        yemekListesi.sort((a, b) => {
          if (a.sayac === 0 && b.sayac === 0) return a.ad.localeCompare(b.ad);
          if (a.sayac === 0) return -1;
          if (b.sayac === 0) return 1;
          return a.sayac - b.sayac || a.ad.localeCompare(b.ad);
        });
      } else { // alfabetik
        yemekListesi.sort((a, b) => a.ad.localeCompare(b.ad));
      }
      
      // Aktif buton stilini gÃ¼ncelle
      document.querySelectorAll('[id^="btn"]').forEach(btn => {
        btn.style.background = '#6c757d';
      });
      
      if (yemekAnaliziSiralama === 'cok') document.getElementById('btnCok').style.background = '#28a745';
      else if (yemekAnaliziSiralama === 'az') document.getElementById('btnAz').style.background = '#dc3545';
      else if (yemekAnaliziSiralama === 'hic') document.getElementById('btnHic').style.background = '#6c757d';
      else document.getElementById('btnAlfabetik').style.background = '#17a2b8';
      
      // HTML oluÅŸtur
      const listeDiv = document.getElementById('yemekAnaliziListe');
      const kullanilmayanSayisi = yemekListesi.filter(y => y.sayac === 0).length;
      const kullanilanSayisi = yemekListesi.filter(y => y.sayac > 0).length;
      
      let html = `<div style="background: #f8f9fa; padding: 10px; margin-bottom: 10px; font-weight: bold; color: #333; border-bottom: 1px solid #ddd;">
        ${aktifHaftaNo}. haftaya kadar â€¢ Toplam: ${yemekListesi.length} tarif â€¢ KullanÄ±lan: ${kullanilanSayisi} â€¢ KullanÄ±lmayan: ${kullanilmayanSayisi}
      </div>`;
      
      yemekListesi.forEach(yemek => {
        let renkKodu, durum;
        if (yemek.sayac === 0) {
          renkKodu = '#6c757d';
          durum = 'KULLANILMADI';
        } else if (yemek.sayac >= 5) {
          renkKodu = '#28a745';
          durum = 'Ã‡OK KULLANILDI';
        } else if (yemek.sayac >= 3) {
          renkKodu = '#ffc107';
          durum = 'ORTA SEVÄ°YE';
        } else {
          renkKodu = '#dc3545';
          durum = 'AZ KULLANILDI';
        }
        
        const haftalarStr = yemek.sayac > 0 ? yemek.haftalar.join('-') : '';
        
        html += `
          <div style="display: flex; align-items: center; padding: 8px 12px; border-bottom: 1px solid #f0f0f0; background: white; margin-bottom: 1px;">
            <span style="background: ${renkKodu}; color: white; border-radius: 50%; width: 30px; height: 30px; display: inline-flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; margin-right: 12px; min-width: 30px;">
              ${yemek.sayac}
            </span>
            <span style="flex: 1; font-weight: 500; color: #333; margin-right: 10px;">
              ${yemek.ad}
            </span>
            ${yemek.sayac > 0 ? 
              `<span style="font-size: 11px; color: #666; background: #e9ecef; padding: 3px 8px; border-radius: 12px; margin-right: 8px;">
                ${haftalarStr}
              </span>` : ''
            }
            <span style="font-size: 10px; color: ${renkKodu}; font-weight: bold; min-width: 80px; text-align: right;">
              ${durum}
            </span>
          </div>
        `;
      });
      
      listeDiv.innerHTML = html;
      
      // Accordion baÅŸlÄ±ÄŸÄ±nÄ± gÃ¼ncelle
      const analizBaslik = document.getElementById('analizBaslik');
      if (analizBaslik) {
        analizBaslik.textContent = `ğŸ“Š Yemek KullanÄ±m Analizi (${kullanilanSayisi}/${yemekListesi.length})`;
      }
      
      // Toplam bilgi elementi artÄ±k accordion sisteminde yok, kaldÄ±rÄ±ldÄ±
      // document.getElementById('analizToplamBilgi').textContent = 
      //   `${yemekListesi.length} tarif â€¢ ${kullanilanSayisi} kullanÄ±lan`;
    }
    
    // Analiz fonksiyonunu da global yap
    window.updateYemekAnalizi = updateYemekAnalizi;

    // ğŸ¯ ACCORDION SÄ°STEMÄ°
    function toggleAccordion(section) {
      const sections = ['eslesen', 'eslesmeyenler', 'analiz', 'veritabaniAnalizi'];
      
      sections.forEach(s => {
        const content = document.getElementById(s + 'Content');
        const icon = document.getElementById(s + 'Icon');
        
        if (s === section) {
          // SeÃ§ilen bÃ¶lÃ¼mÃ¼ aÃ§/kapat
          const isOpen = content.style.display === 'block';
          content.style.display = isOpen ? 'none' : 'block';
          icon.textContent = isOpen ? 'â–¶' : 'â–¼';
        } else {
          // DiÄŸer bÃ¶lÃ¼mleri kapat
          content.style.display = 'none';
          icon.textContent = 'â–¶';
        }
      });
    }
    
    // Global accordion fonksiyonu
    window.toggleAccordion = toggleAccordion;

    // GitHub Token fonksiyonlarÄ±
    function saveTokenToStorage() {
      const token = document.getElementById('githubToken').value;
      if (token) {
        localStorage.setItem('githubToken', token);
        console.log('ğŸ”‘ GitHub token kaydedildi');
      }
    }

    async function testGitHubToken() {
      const token = document.getElementById('githubToken').value;
      const repo = document.getElementById('githubRepo').value;
      
      if (!token) {
        alert('GitHub token giriniz!');
        return;
      }
      
      if (!repo) {
        alert('GitHub repo giriniz!');
        return;
      }
      
      try {
        const response = await fetch(`https://api.github.com/repos/${repo}`, {
          headers: {
            'Authorization': `token ${token}`,
            'Accept': 'application/vnd.github.v3+json'
          }
        });
        
        if (response.ok) {
          const data = await response.json();
          alert(`âœ… Token baÅŸarÄ±lÄ±! Repo: ${data.full_name}\nStar: ${data.stargazers_count}\nFork: ${data.forks_count}`);
          console.log('âœ… GitHub token test baÅŸarÄ±lÄ±:', data);
        } else {
          alert(`âŒ Token hatalÄ±! HTTP ${response.status}: ${response.statusText}`);
          console.error('âŒ GitHub token test baÅŸarÄ±sÄ±z:', response.status, response.statusText);
        }
      } catch (error) {
        alert(`âŒ BaÄŸlantÄ± hatasÄ±: ${error.message}`);
        console.error('âŒ GitHub token test hatasÄ±:', error);
      }
    }

    // Global fonksiyonlarÄ± ekle
    window.saveTokenToStorage = saveTokenToStorage;
    window.testGitHubToken = testGitHubToken;

    // ğŸ“ Ã‡OKLU PDF UPLOAD SÄ°STEMÄ°
    function parseProfessionalPdfName(fileName) {
      // TÃ¼rkÃ§e karakterleri normalize et
      fileName = fileName.replace(/[Ä°Ä±ÄÄŸÃœÃ¼ÅÅŸÃ–Ã¶Ã‡Ã§]/g, (match) => {
        const map = {'Ä°': 'I', 'Ä±': 'i', 'Ä': 'G', 'ÄŸ': 'g', 'Ãœ': 'U', 'Ã¼': 'u', 'Å': 'S', 'ÅŸ': 's', 'Ã–': 'O', 'Ã¶': 'o', 'Ã‡': 'C', 'Ã§': 'c'};
        return map[match] || match;
      });

      // TÃ¼rkÃ§e ay isimleri mapping
      const aylar = {
        'OCAK': 1, 'SUBAT': 2, 'MART': 3, 'NISAN': 4,
        'MAYIS': 5, 'HAZIRAN': 6, 'TEMMUZ': 7, 'AGUSTOS': 8,
        'EYLUL': 9, 'EKIM': 10, 'KASIM': 11, 'ARALIK': 12
      };

      // Regex pattern - Birden fazla format desteÄŸi
      const patterns = [
        // ESÄ°N KARAKUÅ 28 TEMMUZ -3 AÄUSTOS 17. HAFTA
        /^(.+?)\s+(\d{1,2})\s+(\w+)\s*-\s*(\d{1,2})\s+(\w+)\s+(\d+)\.\s*HAFTA/i,
        // DERYA BAYINDIR 9-15 HAZÄ°RAN 11. HAFTA
        /^(.+?)\s+(\d{1,2})\s*-\s*(\d{1,2})\s+(\w+)\s+(\d+)\.\s*HAFTA/i,
        // DERYA BAYINDIR 2-8 HAZÄ°RAN 10.HAFTA (boÅŸluksuz)
        /^(.+?)\s+(\d{1,2})\s*-\s*(\d{1,2})\s+(\w+)\s+(\d+)\.HAFTA/i
      ];
      
      for (let pattern of patterns) {
        const match = fileName.replace('.pdf', '').match(pattern);
        
        if (match) {
          if (match.length === 7) {
            // Format: HASTA ADI GUN1 AY1 - GUN2 AY2 HAFTA
            const [_, hastaAdi, gun1, ay1, gun2, ay2, haftaNo] = match;
            return {
              hastaAdi: hastaAdi.trim(),
              baslangicTarihi: `${gun1} ${ay1}`,
              bitisTarihi: `${gun2} ${ay2}`,
              haftaNo: parseInt(haftaNo),
              tarihAraligi: `${gun1} ${ay1} - ${gun2} ${ay2}`
            };
          } else if (match.length === 6) {
            // Format: HASTA ADI GUN1-GUN2 AY HAFTA
            const [_, hastaAdi, gun1, gun2, ay, haftaNo] = match;
            return {
              hastaAdi: hastaAdi.trim(),
              baslangicTarihi: `${gun1} ${ay}`,
              bitisTarihi: `${gun2} ${ay}`,
              haftaNo: parseInt(haftaNo),
              tarihAraligi: `${gun1}-${gun2} ${ay}`
            };
          }
        }
      }
      
      return null;
    }

    function findOrCreateHasta(hastaAdi) {
      // Null/undefined check
      if (!hastaAdi || typeof hastaAdi !== 'string') {
        console.error('âŒ GeÃ§ersiz hasta adÄ±:', hastaAdi);
        return null;
      }

      // hastalar array kontrol
      if (!hastalar || !Array.isArray(hastalar)) {
        console.error('âŒ hastalar array tanÄ±mlÄ± deÄŸil, boÅŸ array oluÅŸturuluyor');
        window.hastalar = [];
      }

      console.log('ğŸ” findOrCreateHasta Ã§aÄŸrÄ±ldÄ±:', hastaAdi, 'Mevcut hasta sayÄ±sÄ±:', hastalar.length);

      // Mevcut hastalar arasÄ±nda ara
      let mevcutHasta = hastalar.find(h => {
        console.log('ğŸ” Hasta kontrol:', h);
        return h && h.ad && h.ad.toLowerCase() === hastaAdi.toLowerCase();
      });
      
      if (!mevcutHasta) {
        // Yeni hasta oluÅŸtur
        const yeniHastaId = 'hasta_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        mevcutHasta = {
          id: yeniHastaId,
          ad: hastaAdi,
          haftalar: []
        };
        hastalar.push(mevcutHasta);
        console.log('âœ… Yeni hasta oluÅŸturuldu:', hastaAdi);
      }
      
      return mevcutHasta;
    }

    function findOrCreateHafta(hasta, haftaNo, tarihAraligi) {
      // Mevcut hafta var mÄ± kontrol et
      let mevcutHafta = hasta.haftalar.find(h => h.haftaNo === haftaNo);
      
      if (!mevcutHafta) {
        // Yeni hafta oluÅŸtur
        mevcutHafta = {
          haftaNo: haftaNo,
          tarihAraligi: tarihAraligi,
          tarifler: [],
          tarifKartlar: [],
          manuelKartlar: [],
          gptMesaj: '',
          aciklama: ''
        };
        hasta.haftalar.push(mevcutHafta);
        
        // Hafta sÄ±rasÄ±na gÃ¶re sÄ±rala
        hasta.haftalar.sort((a, b) => a.haftaNo - b.haftaNo);
        
        console.log(`âœ… ${hasta.ad} iÃ§in ${haftaNo}. hafta oluÅŸturuldu (${tarihAraligi})`);
      }
      
      return mevcutHafta;
    }

    // ğŸ”§ YARDIMCI FONKSÄ°YONLAR
    function extractTariflerFromText(pdfText) {
      if (!pdfText) return [];
      
      // Basit tarif Ã§Ä±karma - satÄ±rlarÄ± al ve temizle
      const satirlar = pdfText.split('\n').filter(satir => 
        satir.trim().length > 2 && 
        !satir.includes('HAFTA') && 
        !satir.includes('TEMMUZ') &&
        !satir.includes('AÄUSTOS')
      );
      
      console.log('ğŸ“ PDF\'den Ã§Ä±karÄ±lan tarifler:', satirlar.length);
      return satirlar.slice(0, 20); // Ä°lk 20 satÄ±rÄ± al
    }

    async function extractPdfText(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = async function(e) {
          try {
            const typedarray = new Uint8Array(e.target.result);
            const pdf = await pdfjsLib.getDocument(typedarray).promise;
            let fullText = '';
            
            for (let i = 1; i <= pdf.numPages; i++) {
              const page = await pdf.getPage(i);
              const textContent = await page.getTextContent();
              const pageText = textContent.items.map(item => item.str).join(' ');
              fullText += pageText + '\n';
            }
            
            resolve(fullText);
          } catch (error) {
            reject(error);
          }
        };
        reader.onerror = () => reject(new Error('PDF okuma hatasÄ±'));
        reader.readAsArrayBuffer(file);
      });
    }

    async function performTarifEslestirmesi(hafta, hasta) {
      if (!hafta.tarifler || hafta.tarifler.length === 0) {
        return;
      }

      console.log(`ğŸ”— ${hasta.ad} ${hafta.haftaNo}. hafta: tarif eÅŸleÅŸtirmesi baÅŸlatÄ±ldÄ±`);
      
      // Basit eÅŸleÅŸtirme - mevcut tarif kartlarÄ± ile karÅŸÄ±laÅŸtÄ±r
      if (window.tarifKartlari && window.tarifKartlari.length > 0) {
        hafta.tarifKartlar = [];
        
        // Her tarifi kontrol et
        hafta.tarifler.forEach(tarif => {
          const eslesen = window.tarifKartlari.find(kart => {
            const kartAdi = kart.replace('.jpg', '').replace(/_/g, ' ').toLowerCase();
            return tarif.toLowerCase().includes(kartAdi) || kartAdi.includes(tarif.toLowerCase());
          });
          
          if (eslesen) {
            hafta.tarifKartlar.push({ name: eslesen });
          }
        });
        
        console.log(`ğŸ”— ${hasta.ad} ${hafta.haftaNo}. hafta: ${hafta.tarifKartlar.length} tarif eÅŸleÅŸti`);
      }
    }

    // Ã‡oklu PDF sonuÃ§larÄ±nÄ± gÃ¶ster
    function showCokluPdfSonuclari(sonuclar, basarili, hatali) {
      const mesajlar = [];
      
      sonuclar.forEach(sonuc => {
        if (sonuc.durum === 'BAÅARILI') {
          mesajlar.push(`âœ… ${sonuc.dosya} â†’ ${sonuc.hasta} (${sonuc.hafta}. hafta) - ${sonuc.tarifSayisi || 0} tarif, ${sonuc.eslesmeSayisi || 0} eÅŸleÅŸme`);
        } else {
          mesajlar.push(`âŒ ${sonuc.dosya} â†’ ${sonuc.mesaj}`);
        }
      });
      
      const rapor = `
ğŸ“ Ã‡OKLU PDF Ä°ÅLEME RAPORU

âœ… BaÅŸarÄ±lÄ±: ${basarili}
âŒ HatalÄ±: ${hatali}
ğŸ“Š Toplam: ${sonuclar.length}

DETAYLAR:
${mesajlar.join('\n')}
      `;
      
      // Raporu modal olarak gÃ¶ster
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.5); z-index: 10000;
        display: flex; align-items: center; justify-content: center;
      `;
      
      modal.innerHTML = `
        <div style="background: white; padding: 20px; border-radius: 8px; max-width: 600px; max-height: 80vh; overflow-y: auto;">
          <h3>ğŸ“ PDF Ä°ÅŸleme SonuÃ§larÄ±</h3>
          <pre style="background: #f5f5f5; padding: 15px; border-radius: 4px; white-space: pre-wrap; font-size: 12px;">${rapor}</pre>
          <button onclick="this.closest('.modal').remove()" style="margin-top: 15px; padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">Kapat</button>
        </div>
      `;
      
      modal.className = 'modal';
      document.body.appendChild(modal);
      
      // Modal dÄ±ÅŸÄ±na tÄ±klanÄ±rsa kapat
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.remove();
        }
      });
      
      console.log('ğŸ“Š PDF iÅŸleme raporu gÃ¶sterildi');
    }

    // Global eriÅŸim iÃ§in
    window.showCokluPdfSonuclari = showCokluPdfSonuclari;

    // Hasta listesini gÃ¼ncelle (sidebar'Ä± yenile)
    function updateHastaListesi() {
      console.log('ğŸ”„ Hasta listesi gÃ¼ncelleniyor...');
      
      // Yeni sistem hasta listesini kullan
      if (typeof renderHastalarYeniSistem === 'function') {
        console.log('âœ… Yeni sisteme yÃ¶nlendiriliyor...');
        renderHastalarYeniSistem();
        return;
      }
      
      // Fallback: Eski sistem
      const hastaListesiDiv = document.getElementById('hastaListesi');
      if (!hastaListesiDiv) {
        console.warn('âš ï¸ hastaListesi elementi bulunamadÄ±');
        return;
      }
      
      // GitHub'dan gelen hasta listesini kullan
      const aktifHastalar = window.hastalar || [];
      console.log(`âœ… Hasta listesi gÃ¼ncellendi: ${aktifHastalar.length} hasta`);
      
      // Bu fonksiyon artÄ±k renderHastalarYeniSistem'e yÃ¶nlendiriyor
      // Detaylar o fonksiyonda iÅŸleniyor
    }

    // Global eriÅŸim iÃ§in
    window.updateHastaListesi = updateHastaListesi;

    // Hasta seÃ§ildiÄŸinde Ã§aÄŸrÄ±lan fonksiyon
    async function hastaSecildi(index) {
      seciliHasta = hastalar[index];
      console.log('ğŸ‘¤ Hasta seÃ§ildi:', seciliHasta.isim);
      
      // UI'Ä± gÃ¼ncelle
      updateHastaListesi(); // SeÃ§imi gÃ¼ncelle
      if (typeof renderHastalarYeniSistem === 'function') {
        await renderHastalarYeniSistem(); // Ana iÃ§eriÄŸi gÃ¼ncelle
      }
    }

    // Global eriÅŸim iÃ§in
    window.hastaSecildi = hastaSecildi;

    //  ï¸ TOPLU ZIP FONKSÄ°YONU
    async function topluZipIndir() {
      try {
        console.log('ğŸš€ Toplu ZIP indirme baÅŸlatÄ±ldÄ±');
        
        // GitHub token kontrolÃ¼
        const tokenElement = document.getElementById('githubToken');
        const repoElement = document.getElementById('githubRepo');
        
        const GITHUB_TOKEN = tokenElement ? tokenElement.value.trim() : '';
        const GITHUB_REPO = repoElement ? repoElement.value.trim() || 'mustafasacar35/lipodem-takip-paneli' : 'mustafasacar35/lipodem-takip-paneli';
        
        if (!GITHUB_TOKEN) {
          alert('GitHub token ayarlanmamÄ±ÅŸ. LÃ¼tfen Ã¶nce GitHub token\'Ä±nÄ±zÄ± girin.');
          return;
        }
        
        // Hasta listesini al (GitHub'dan direkt yÃ¼kle)
        console.log('ğŸ“‹ Hasta listesi yÃ¼kleniyor...');
        const tumHastalar = await hastaListesiYukle();
        
        if (!tumHastalar || tumHastalar.length === 0) {
          alert('Hasta listesi yÃ¼klenmemiÅŸ! LÃ¼tfen GitHub token\'Ä±nÄ±zÄ± kontrol edin.');
          return;
        }
        
        const aktifHastalar = tumHastalar.filter(hasta => !hasta.arsiv);
        
        if (aktifHastalar.length === 0) {
          alert('Aktif hasta bulunamadÄ±!');
          return;
        }
        
        console.log(`ğŸ“Š ${aktifHastalar.length} aktif hasta bulundu`);
        
        // Ana ZIP dosyasÄ±nÄ± oluÅŸtur
        const anaZip = new JSZip();
        const bugununTarihi = new Date().toISOString().slice(0,10);
        const anaZipAdi = `TOPLU_HASTA_ZIP_${bugununTarihi}.zip`;
        
        // Progress gÃ¶sterimi
        const progressDiv = document.createElement('div');
        progressDiv.style.cssText = `
          position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
          background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);
          z-index: 10000; min-width: 400px; text-align: center;
        `;
        progressDiv.innerHTML = `
          <h3>ğŸ—œï¸ Toplu ZIP HazÄ±rlanÄ±yor...</h3>
          <div id="progressBar" style="width: 100%; height: 20px; background: #f0f0f0; border-radius: 10px; overflow: hidden; margin: 10px 0;">
            <div id="progressFill" style="width: 0%; height: 100%; background: linear-gradient(45deg, #667eea, #764ba2); transition: width 0.3s;"></div>
          </div>
          <div id="progressText">0 / ${aktifHastalar.length}</div>
          <div id="currentHasta" style="margin-top: 10px; font-weight: bold; color: #666;"></div>
        `;
        document.body.appendChild(progressDiv);
        
        let basariliHastalar = 0;
        let hataliHastalar = 0;
        
        // Her hasta iÃ§in iÅŸlem yap
        for (let i = 0; i < aktifHastalar.length; i++) {
          const hasta = aktifHastalar[i];
          
          // Progress gÃ¼ncelle
          const progress = ((i + 1) / aktifHastalar.length) * 100;
          document.getElementById('progressFill').style.width = progress + '%';
          document.getElementById('progressText').textContent = `${i + 1} / ${aktifHastalar.length}`;
          document.getElementById('currentHasta').textContent = `Ä°ÅŸleniyor: ${hasta.isim}`;
          
          try {
            console.log(`ğŸ‘¤ ${hasta.isim} iÅŸleniyor...`);
            
            // Hasta verilerini al
            const hastaData = await getHastaData(hasta.id, GITHUB_REPO, GITHUB_TOKEN, hasta.isim);
            if (!hastaData || !hastaData.haftalar) {
              console.warn(`âš ï¸ ${hasta.isim} iÃ§in veri bulunamadÄ±`);
              hataliHastalar++;
              continue;
            }
            
            // En bÃ¼yÃ¼k hafta numarasÄ±nÄ± bul
            const haftalar = hastaData.haftalar || [];
            let enBuyukHafta = null;
            let enBuyukHaftaNo = 0;
            
            haftalar.forEach(hafta => {
              const haftaNo = hafta.haftaNo || 0;
              if (haftaNo > enBuyukHaftaNo) {
                enBuyukHaftaNo = haftaNo;
                enBuyukHafta = hafta;
              }
            });
            
            if (!enBuyukHafta) {
              console.warn(`âš ï¸ ${hasta.isim} iÃ§in hafta verisi bulunamadÄ±`);
              hataliHastalar++;
              continue;
            }
            
            console.log(`ğŸ“… ${hasta.isim} - En bÃ¼yÃ¼k hafta: ${enBuyukHaftaNo}`);
            
            // Hasta klasÃ¶rÃ¼ oluÅŸtur - menÃ¼ PDF adÄ±nÄ± kullan
            let hastaKlasorAdi = hasta.isim.toUpperCase().replace(/\s/g, '_').replace(/[Ä°Ä±Ã‡Ã§ÄÄŸÃœÃ¼ÅÅŸÃ–Ã¶]/g, match => {
              const trMap = {'Ä°': 'I', 'Ä±': 'i', 'Ã‡': 'C', 'Ã§': 'c', 'Ä': 'G', 'ÄŸ': 'g', 'Ãœ': 'U', 'Ã¼': 'u', 'Å': 'S', 'ÅŸ': 's', 'Ã–': 'O', 'Ã¶': 'o'};
              return trMap[match] || match;
            });
            
            // Sadece en bÃ¼yÃ¼k hafta iÃ§in menÃ¼ PDF'sini ekle
            if (enBuyukHafta.githubUrl || enBuyukHafta.indirmeUrl || (enBuyukHafta.pdf && (enBuyukHafta.pdfName || enBuyukHafta.pdfOrijinalIsim))) {
              try {
                let pdfFileName = enBuyukHafta.pdfName || enBuyukHafta.pdfOrijinalIsim;
                
                // KlasÃ¶r adÄ±nÄ± menÃ¼ PDF adÄ±yla deÄŸiÅŸtir (MENU_ prefix'i olmadan)
                if (pdfFileName) {
                  hastaKlasorAdi = pdfFileName.replace('.pdf', '');
                }
                
                console.log(`ğŸ“„ ${hasta.isim} - En bÃ¼yÃ¼k hafta (${enBuyukHaftaNo}) menÃ¼ PDF'i indiriliyor`);
                
                // Raw GitHub URL'sini kullan
                let pdfUrl;
                if (enBuyukHafta.githubUrl) {
                  // githubUrl varsa raw formatÄ±na Ã§evir
                  pdfUrl = enBuyukHafta.githubUrl
                    .replace('github.com', 'raw.githubusercontent.com')
                    .replace('/blob/', '/');
                  // PDF dosya adÄ±nÄ± URL'den Ã§Ä±kar
                  if (!pdfFileName) {
                    pdfFileName = decodeURIComponent(pdfUrl.split('/').pop());
                  }
                } else if (enBuyukHafta.indirmeUrl) {
                  // indirmeUrl varsa raw formatÄ±na Ã§evir
                  pdfUrl = enBuyukHafta.indirmeUrl
                    .replace('github.com', 'raw.githubusercontent.com')
                    .replace('/blob/', '/');
                  // PDF dosya adÄ±nÄ± URL'den Ã§Ä±kar
                  if (!pdfFileName) {
                    pdfFileName = decodeURIComponent(pdfUrl.split('/').pop());
                  }
                } else {
                  // Standart raw format ile dene
                  const encodedFileName = encodeURIComponent(pdfFileName);
                  pdfUrl = `https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli/main/pdfs/${encodedFileName}`;
                }
                
                console.log(`  PDF URL: ${pdfUrl}`);
                
                const pdfResponse = await fetch(pdfUrl);
                
                if (pdfResponse.ok) {
                  const pdfBlob = await pdfResponse.blob();
                  anaZip.file(`${hastaKlasorAdi}/MENU_PDF_${pdfFileName}`, pdfBlob);
                  console.log(`âœ… ${hasta.isim} - MenÃ¼ PDF eklendi: ${pdfFileName}`);
                } else {
                  console.warn(`âŒ ${hasta.isim} - MenÃ¼ PDF indirilemedi (${pdfResponse.status}): ${pdfUrl}`);
                }
              } catch (error) {
                console.warn(`âŒ ${hasta.isim} - MenÃ¼ PDF eklenemedi:`, error);
              }
            } else {
              console.log(`â„¹ï¸ ${hasta.isim} - En bÃ¼yÃ¼k hafta iÃ§in PDF verisi yok (githubUrl: ${!!enBuyukHafta.githubUrl}, indirmeUrl: ${!!enBuyukHafta.indirmeUrl}, pdf: ${!!enBuyukHafta.pdf}, pdfName: ${!!enBuyukHafta.pdfName})`);
            }
            
            // Tarif kartlarÄ±nÄ± ekle
            if (enBuyukHafta.tarifKartlar && enBuyukHafta.tarifKartlar.length > 0) {
              console.log(`ğŸ” ${hasta.isim} - Tarif kartlarÄ±:`, enBuyukHafta.tarifKartlar);
              for (const kart of enBuyukHafta.tarifKartlar) {
                try {
                  console.log(`ğŸ” ${hasta.isim} - Kart objesi:`, kart);
                  // DoÄŸru Ã¶zellik adÄ±nÄ± kullan: kartData
                  const kartUrl = kart.kartData || kart.data;
                  if (!kartUrl) {
                    console.warn(`âš ï¸ ${hasta.isim} - Kart URL'si bulunamadÄ±:`, kart);
                    continue;
                  }
                  const response = await fetch(kartUrl);
                  if (response.ok) {
                    const blob = await response.blob();
                    const fileName = kartUrl.split('/').pop() || `tarif_${kart.tarifAdi || 'kart'}.jpg`;
                    anaZip.file(`${hastaKlasorAdi}/${fileName}`, blob);
                    console.log(`âœ… ${hasta.isim} - Tarif kartÄ± eklendi:`, fileName);
                  }
                } catch (error) {
                  console.warn(`âŒ ${hasta.isim} - Tarif kartÄ± eklenemedi:`, kart.tarifAdi || 'bilinmeyen', error);
                }
              }
            }
            
            // Manuel kartlarÄ± ekle
            if (enBuyukHafta.manuelKartlar && enBuyukHafta.manuelKartlar.length > 0) {
              console.log(`ğŸ” ${hasta.isim} - Manuel kartlar:`, enBuyukHafta.manuelKartlar);
              for (const kart of enBuyukHafta.manuelKartlar) {
                try {
                  // DoÄŸru Ã¶zellik adÄ±nÄ± kullan: kartData
                  const kartUrl = kart.kartData || kart.data;
                  if (!kartUrl) {
                    console.warn(`âš ï¸ ${hasta.isim} - Manuel kart URL'si bulunamadÄ±:`, kart);
                    continue;
                  }
                  const response = await fetch(kartUrl);
                  if (response.ok) {
                    const blob = await response.blob();
                    const fileName = kartUrl.split('/').pop() || `manuel_${kart.tarifAdi || 'kart'}.jpg`;
                    anaZip.file(`${hastaKlasorAdi}/${fileName}`, blob);
                    console.log(`âœ… ${hasta.isim} - Manuel kart eklendi:`, fileName);
                  }
                } catch (error) {
                  console.warn(`âŒ ${hasta.isim} - Manuel kart eklenemedi:`, kart.tarifAdi || 'bilinmeyen', error);
                }
              }
            }
            
            // Ã‡oklu PDF kartlarÄ±nÄ± ekle
            if (enBuyukHafta.cokluPdfVerileri && enBuyukHafta.cokluPdfVerileri.length > 0) {
              console.log(`ğŸ” ${hasta.isim} - Ã‡oklu PDF verileri:`, enBuyukHafta.cokluPdfVerileri);
              for (const veri of enBuyukHafta.cokluPdfVerileri) {
                if (veri.tarifKartlar && veri.tarifKartlar.length > 0) {
                  for (const kart of veri.tarifKartlar) {
                    try {
                      // DoÄŸru Ã¶zellik adÄ±nÄ± kullan: kartData
                      const kartUrl = kart.kartData || kart.data;
                      if (!kartUrl) {
                        console.warn(`âš ï¸ ${hasta.isim} - Ã‡oklu PDF kart URL'si bulunamadÄ±:`, kart);
                        continue;
                      }
                      const response = await fetch(kartUrl);
                      if (response.ok) {
                        const blob = await response.blob();
                        const fileName = kartUrl.split('/').pop() || `coklu_${kart.tarifAdi || 'kart'}.jpg`;
                        anaZip.file(`${hastaKlasorAdi}/${fileName}`, blob);
                        console.log(`âœ… ${hasta.isim} - Ã‡oklu PDF kartÄ± eklendi:`, fileName);
                      }
                    } catch (error) {
                      console.warn(`âŒ ${hasta.isim} - Ã‡oklu PDF kartÄ± eklenemedi:`, kart.tarifAdi || 'bilinmeyen', error);
                    }
                  }
                }
              }
            }
            
            // GPT mesajÄ±nÄ± ekle
            if (enBuyukHafta.gptMesaj && enBuyukHafta.gptMesaj.trim()) {
              anaZip.file(`${hastaKlasorAdi}/GPT_MESAJI.txt`, enBuyukHafta.gptMesaj.trim());
            }
            
            // Lenf masajÄ± planÄ±nÄ± ekle (5. hafta iÃ§in)
            if (enBuyukHaftaNo === 5) {
              try {
                await createAndAddLenfMasajPDF(anaZip, hastaData, haftalar, `${hastaKlasorAdi}/`);
              } catch (error) {
                console.warn(`âŒ ${hasta.isim} - Lenf masajÄ± planÄ± eklenemedi:`, error);
              }
            }
            
            // Egzersiz planÄ±nÄ± ekle (9. hafta iÃ§in)
            if (enBuyukHaftaNo === 9) {
              try {
                await createAndAddEgzersizPDF(anaZip, hastaData, haftalar, `${hastaKlasorAdi}/`);
              } catch (error) {
                console.warn(`âŒ ${hasta.isim} - Egzersiz planÄ± eklenemedi:`, error);
              }
            }
            
            basariliHastalar++;
            console.log(`âœ… ${hasta.isim} baÅŸarÄ±yla iÅŸlendi`);
            
          } catch (error) {
            console.error(`âŒ ${hasta.isim} iÅŸlenirken hata:`, error);
            hataliHastalar++;
          }
          
          // KÃ¼Ã§Ã¼k delay (performans iÃ§in)
          await new Promise(resolve => setTimeout(resolve, 100));
        }
        
        // Progress'i kapat
        document.body.removeChild(progressDiv);
        
        if (basariliHastalar === 0) {
          alert('HiÃ§bir hasta baÅŸarÄ±yla iÅŸlenemedi!');
          return;
        }
        
        // ZIP dosyasÄ±nÄ± oluÅŸtur ve indir
        console.log('ğŸ—œï¸ ZIP dosyasÄ± oluÅŸturuluyor...');
        const zipBlob = await anaZip.generateAsync({type: 'blob'});
        
        // Ä°ndirme iÅŸlemi
        const link = document.createElement('a');
        link.href = URL.createObjectURL(zipBlob);
        link.download = anaZipAdi;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        // BaÅŸarÄ± mesajÄ±
        alert(`ğŸ‰ Toplu ZIP baÅŸarÄ±yla oluÅŸturuldu!\n\n` +
              `âœ… BaÅŸarÄ±lÄ±: ${basariliHastalar} hasta\n` +
              `âŒ HatalÄ±: ${hataliHastalar} hasta\n\n` +
              `Dosya adÄ±: ${anaZipAdi}`);
        
        console.log('ğŸ‰ Toplu ZIP iÅŸlemi tamamlandÄ±!');
        
      } catch (error) {
        console.error('âŒ Toplu ZIP hatasÄ±:', error);
        alert('Toplu ZIP oluÅŸturulurken hata oluÅŸtu: ' + error.message);
      }
    }
    
    // Global eriÅŸim iÃ§in
    window.topluZipIndir = topluZipIndir;

    //  ğŸ“ ANA Ã‡OKLU PDF FONKSÄ°YONU
    async function processCokluPdf(files) {
      if (!files || files.length === 0) {
        alert('LÃ¼tfen en az bir PDF dosyasÄ± seÃ§in.');
        return;
      }

      console.log('ğŸ“ Ã‡oklu PDF iÅŸlemi baÅŸlatÄ±ldÄ±:', files.length, 'dosya');
      
      const sonuclar = [];
      let basarili = 0;
      let hatali = 0;

      // Progress gÃ¶sterimi
      const progressDiv = document.createElement('div');
      progressDiv.style.cssText = `
        position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
        background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        z-index: 10000; min-width: 300px; text-align: center;
      `;
      progressDiv.innerHTML = `
        <h3>ğŸ“ PDF'ler Ä°ÅŸleniyor...</h3>
        <div id="progressBar" style="width: 100%; height: 20px; background: #f0f0f0; border-radius: 10px; overflow: hidden; margin: 10px 0;">
          <div id="progressFill" style="width: 0%; height: 100%; background: linear-gradient(45deg, #667eea, #764ba2); transition: width 0.3s;"></div>
        </div>
        <div id="progressText">0 / ${files.length}</div>
      `;
      document.body.appendChild(progressDiv);

      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        const progress = ((i + 1) / files.length) * 100;
        
        // Progress gÃ¼ncelle
        document.getElementById('progressFill').style.width = progress + '%';
        document.getElementById('progressText').textContent = `${i + 1} / ${files.length}`;
        
        try {
          console.log(`ğŸ” ${i + 1}/${files.length} - "${file.name}" analiz ediliyor...`);
          
          // Dosya adÄ±nÄ± parse et
          const parsed = parseProfessionalPdfName(file.name);
          
          if (!parsed) {
            console.warn('âš ï¸ Dosya adÄ± format hatasÄ±:', file.name);
            sonuclar.push({ dosya: file.name, durum: 'HATA', mesaj: 'Dosya adÄ± formatÄ± tanÄ±nmadÄ±' });
            hatali++;
            continue;
          }

          // Hasta oluÅŸtur/bul
          const hasta = findOrCreateHasta(parsed.hastaAdi);
          
          // Hafta oluÅŸtur/bul
          const hafta = findOrCreateHafta(hasta, parsed.haftaNo, parsed.tarihAraligi);
          
          // PDF'i Base64'e Ã§evir ve sakla
          const pdfBase64 = await fileToBase64(file);
          hafta.pdf = pdfBase64;
          hafta.pdfName = file.name;
          hafta.pdfOrijinalIsim = file.name;
          hafta.pdfYolu = `pdfs/${file.name}`;
          hafta.kayitTarihi = new Date().toISOString();
          hafta.pdfFile = {
            name: file.name,
            size: file.size,
            type: file.type
          };
          
          // PDF'i analiz et ve tarifleri Ã§Ä±kar
          let pdfText = '';
          let tarifler = [];
          let eslesenKartlar = [];
          let recipeCount = 0;
          let matchCount = 0;
          
          try {
            // PDF iÃ§eriÄŸini Ã§Ä±kar
            const loadingTask = pdfjsLib.getDocument({data: atob(pdfBase64)});
            const pdf = await loadingTask.promise;
            
            for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
              const page = await pdf.getPage(pageNum);
              const textContent = await page.getTextContent();
              const pageText = textContent.items.map(item => item.str).join(' ');
              pdfText += pageText + ' ';
            }
            
            // Tarifleri analiz et
            if (typeof window.tarifKartlari !== 'undefined' && Array.isArray(window.tarifKartlari)) {
              window.tarifKartlari.forEach(kart => {
                const tarifAdi = kart.querySelector('.card-title')?.textContent?.trim();
                if (tarifAdi && pdfText.toLowerCase().includes(tarifAdi.toLowerCase())) {
                  tarifler.push(tarifAdi);
                  eslesenKartlar.push({
                    id: kart.id,
                    name: tarifAdi,
                    kategori: kart.dataset.kategori || 'Genel',
                    type: 'auto',
                    eklenmeTarihi: new Date().toISOString()
                  });
                  matchCount++;
                }
              });
            }
            
            // Toplam tarif sayÄ±sÄ±nÄ± tahmin et
            const tarifMatches = pdfText.match(/tarif|yemek|Ã¶ÄŸÃ¼n/gi);
            recipeCount = tarifMatches ? tarifMatches.length : 0;
            
          } catch (pdfError) {
            console.warn('PDF iÃ§erik Ã§Ä±karma hatasÄ±:', pdfError);
          }
          
          // Hafta verilerini gÃ¼ncelle
          hafta.tarifler = tarifler;
          hafta.tarifKartlar = eslesenKartlar;
          hafta.pdfText = pdfText.substring(0, 2000); // Ä°lk 2000 karakter
          hafta.gptMesaj = `PDF analizi: ${recipeCount} tarif tespit edildi, ${matchCount} eÅŸleÅŸme bulundu.`;
          
          sonuclar.push({ 
            dosya: file.name, 
            durum: 'BAÅARILI', 
            hasta: parsed.hastaAdi,
            hafta: parsed.haftaNo,
            tarifSayisi: recipeCount,
            eslesmeSayisi: matchCount
          });
          basarili++;
          
          console.log(`âœ… ${file.name} baÅŸarÄ±yla iÅŸlendi - ${recipeCount} tarif, ${matchCount} eÅŸleÅŸme`);
          
        } catch (error) {
          console.error('âŒ PDF iÅŸleme hatasÄ±:', file.name, error);
          sonuclar.push({ dosya: file.name, durum: 'HATA', mesaj: error.message });
          hatali++;
        }
        
        // KÃ¼Ã§Ã¼k bir delay (UI donmamasÄ± iÃ§in)
        await new Promise(resolve => setTimeout(resolve, 100));
      }

      // Progress dialog'u kapat
      document.body.removeChild(progressDiv);
      
      // SonuÃ§larÄ± kaydet
      localStorage.setItem('lipedem_hasta_kayitlari', JSON.stringify(hastalar));
      
      // Otomatik kaydetme - hasta verileri deÄŸiÅŸti
      if (seciliHasta) {
        autoSaveHastaData(seciliHasta);
      }
      
      // UI'Ä± gÃ¼ncelle ve sidebar'Ä± yenile
      if (typeof renderHastalarYeniSistem === 'function') {
        await renderHastalarYeniSistem();
      }
      updateHastaListesi(); // Sidebar'daki hasta listesini gÃ¼ncelle
      
      // SonuÃ§ raporu gÃ¶ster
      showCokluPdfSonuclari(sonuclar, basarili, hatali);
      
      console.log('ğŸ‰ Ã‡oklu PDF iÅŸlemi tamamlandÄ±! BaÅŸarÄ±lÄ±:', basarili, 'HatalÄ±:', hatali);
    }
    
    // === EMNÄ°YET KÄ°LÄ°DÄ° FONKSÄ°YONLARI ===
    
    // Hafta kaydet ve kilitle
    async function haftaKaydet(haftaIndex) {
      if (!seciliHasta || !seciliHasta.haftalar[haftaIndex]) {
        showToast('âŒ GeÃ§ersiz hafta!', 'error');
        return;
      }
      
      const hafta = seciliHasta.haftalar[haftaIndex];
      const haftaNo = hafta.haftaNo || (haftaIndex + 1);
      
      try {
        // Ã–NEMLÄ°: GPT mesajÄ±nÄ± kaydet (eÄŸer textarea'da yazÄ±lÄ± metin varsa ve henÃ¼z kaydedilmemiÅŸse)
        const gptTextarea = document.getElementById('gptMesaj_' + haftaIndex);
        if (gptTextarea && gptTextarea.value !== (hafta.gptMesaj || '')) {
          console.log('ğŸ“ GPT mesajÄ± hafta kilitleme sÄ±rasÄ±nda otomatik kaydediliyor...');
          hafta.gptMesaj = gptTextarea.value;
        }
        
        // Hafta verilerini kilitle
        hafta.kilitli = true;
        hafta.kayitTarihi = new Date().toISOString();
        
        // localStorage'a kaydet
        saveToStorage();
        
        // GitHub'a kaydet
        const kaydedildi = await hastayiAyriKaydet(seciliHasta);
        
        if (kaydedildi) {
          console.log(`âœ… ${haftaNo}. hafta baÅŸarÄ±yla kaydedildi ve kilitlendi`);
          
          // UI'Ä± gÃ¼ncelle
          gosterHaftalar();
          
          // BaÅŸarÄ± mesajÄ±
          showToast(`ğŸ”’ ${haftaNo}. hafta kilitlendi!`);
          
        } else {
          // GitHub kaydetme baÅŸarÄ±sÄ±z
          hafta.kilitli = false; // Kilidi geri aÃ§
          hafta.kayitTarihi = null;
          saveToStorage();
          
          showToast('âŒ GitHub\'a kaydetme baÅŸarÄ±sÄ±z!', 'error');
        }
        
      } catch (error) {
        console.error('âŒ Hafta kaydetme hatasÄ±:', error);
        
        // Hata durumunda kilidi geri aÃ§
        hafta.kilitli = false;
        hafta.kayitTarihi = null;
        saveToStorage();
        
        showToast(`âŒ Hafta kaydetme hatasÄ±: ${error.message}`, 'error');
      }
    }
    
    // Hafta kilidini aÃ§
    async function haftaKilidiAc(haftaIndex) {
      if (!seciliHasta || !seciliHasta.haftalar[haftaIndex]) {
        showToast('âŒ GeÃ§ersiz hafta!', 'error');
        return;
      }
      
      const hafta = seciliHasta.haftalar[haftaIndex];
      const haftaNo = hafta.haftaNo || (haftaIndex + 1);
      
      try {
        // Hafta kilidini aÃ§
        hafta.kilitli = false;
        
        // localStorage'a kaydet
        saveToStorage();
        
        // GitHub'a kaydet
        const kaydedildi = await hastayiAyriKaydet(seciliHasta);
        
        if (kaydedildi) {
          console.log(`ğŸ”“ ${haftaNo}. hafta kilidi aÃ§Ä±ldÄ±`);
          
          // UI'Ä± gÃ¼ncelle
          gosterHaftalar();
          
          // BaÅŸarÄ± mesajÄ±
          showToast(`ğŸ”“ ${haftaNo}. hafta kilidi aÃ§Ä±ldÄ±!`);
          
        } else {
          // GitHub kaydetme baÅŸarÄ±sÄ±z
          hafta.kilitli = true; // Kilidi geri koy
          saveToStorage();
          
          showToast('âŒ GitHub\'a kaydetme baÅŸarÄ±sÄ±z!', 'error');
        }
        
      } catch (error) {
        console.error('âŒ Kilit aÃ§ma hatasÄ±:', error);
        
        // Hata durumunda kilidi geri koy
        hafta.kilitli = true;
        saveToStorage();
        
        showToast(`âŒ Kilit aÃ§ma hatasÄ±!`, 'error');
      }
    }
    
    // Global fonksiyonlar
    window.haftaKaydet = haftaKaydet;
    window.haftaKilidiAc = haftaKilidiAc;

        sayfaBaslat();
        initResizableSidebars();
      });
    } else {
      sayfaBaslat();
      initResizableSidebars();
    }
    
    // Global fonksiyon yap
    window.processCokluPdf = processCokluPdf;

    // ===== EMNÄ°YET KÄ°LÄ°DÄ° SÄ°STEMÄ° FONKSIYONLARI =====
    
    // Hafta kaydet ve kilitle
    async function haftaKaydet(i) {
      if (!seciliHasta) {
        showToast('âŒ LÃ¼tfen Ã¶nce bir hasta seÃ§in!', 'error');
        return;
      }
      
      const haftalar = getHaftaListesi();
      const hafta = haftalar[i];
      
      if (hafta.kilitli) {
        showToast('âš ï¸ Bu hafta zaten kilitli!', 'warning');
        return;
      }
      
      try {
        // 0. Ã–NEMLÄ°: GPT mesajÄ±nÄ± kaydet (eÄŸer textarea'da yazÄ±lÄ± metin varsa ve henÃ¼z kaydedilmemiÅŸse)
        const gptTextarea = document.getElementById('gptMesaj_' + i);
        if (gptTextarea && gptTextarea.value !== (hafta.gptMesaj || '')) {
          console.log('ğŸ“ GPT mesajÄ± hafta kilitleme sÄ±rasÄ±nda otomatik kaydediliyor...');
          hafta.gptMesaj = gptTextarea.value;
        }
        
        // 1. Hafta verilerini gÃ¼ncelle
        hafta.kilitli = true;
        hafta.kilitlenmeTarihi = new Date().toISOString();
        
        // 2. LocalStorage'a kaydet
        saveToStorage();
        
        // 3. GitHub'a kaydet
        const githubBasarili = await hastayiAyriKaydet(seciliHasta);
        
        if (githubBasarili) {
          console.log(`âœ… ${hafta.haftaNo}. hafta kaydedildi ve kilitlendi`);
          showToast(`ğŸ”’ ${hafta.haftaNo}. hafta kilitlendi!`);
        } else {
          console.warn(`âš ï¸ ${hafta.haftaNo}. hafta kilitlendi ama GitHub kaydÄ± baÅŸarÄ±sÄ±z`);
          showToast(`ğŸ”’ ${hafta.haftaNo}. hafta kilitlendi (GitHub kayÄ±t hatasÄ±)`, 'warning');
        }
        
        // 4. UI'Ä± gÃ¼ncelle
        gosterHaftalar();
        
        // 5. Aktif tab'Ä± koru
        setTimeout(() => switchTab(i), 100);
        
      } catch (error) {
        console.error('âŒ Hafta kaydetme ve kilitleme hatasÄ±:', error);
        showToast(`âŒ Hafta kaydetme baÅŸarÄ±sÄ±z!`, 'error');
      }
    }
    
    // Hafta kilidini aÃ§
    async function haftaKilidiAc(i) {
      if (!seciliHasta) {
        showToast('âŒ LÃ¼tfen Ã¶nce bir hasta seÃ§in!', 'error');
        return;
      }
      
      const haftalar = getHaftaListesi();
      const hafta = haftalar[i];
      
      if (!hafta.kilitli) {
        showToast('âš ï¸ Bu hafta zaten kilitli deÄŸil!', 'warning');
        return;
      }
      
      try {
        // 1. Hafta verilerini gÃ¼ncelle
        hafta.kilitli = false;
        hafta.kilitAcmaTarihi = new Date().toISOString();
        
        // 2. LocalStorage'a kaydet
        saveToStorage();
        
        // 3. GitHub'a kaydet
        const githubBasarili = await hastayiAyriKaydet(seciliHasta);
        
        if (githubBasarili) {
          console.log(`ğŸ”“ ${hafta.haftaNo}. hafta kilidi aÃ§Ä±ldÄ±`);
          showToast(`ğŸ”“ ${hafta.haftaNo}. hafta kilidi aÃ§Ä±ldÄ±!`);
        } else {
          console.warn(`âš ï¸ ${hafta.haftaNo}. hafta kilidi aÃ§Ä±ldÄ± ama GitHub kaydÄ± baÅŸarÄ±sÄ±z`);
          showToast(`ğŸ”“ ${hafta.haftaNo}. hafta kilidi aÃ§Ä±ldÄ± (GitHub kayÄ±t hatasÄ±)`, 'warning');
        }
        
        // 4. UI'Ä± gÃ¼ncelle
        gosterHaftalar();
        
        // 5. Aktif tab'Ä± koru
        setTimeout(() => switchTab(i), 100);
        
      } catch (error) {
        console.error('âŒ Hafta kilit aÃ§ma hatasÄ±:', error);
        showToast(`âŒ Kilit aÃ§ma baÅŸarÄ±sÄ±z!`, 'error');
      }
    }
    
    // Global fonksiyonlar
    window.haftaKaydet = haftaKaydet;
    window.haftaKilidiAc = haftaKilidiAc;

    // PDF Ã–NIZLEME FONKSÄ°YONLARI
    function pdfOnizlemeAc() {
      console.log('ğŸ“„ PDF Ã¶nizleme aÃ§Ä±lÄ±yor...');
      
      let hasta, hafta, aktifHaftaIndex;
      
      if (!seciliHasta) {
        // Test verisi oluÅŸtur
        console.log('âš ï¸ Hasta seÃ§ili deÄŸil, test verisi oluÅŸturuluyor...');
        hasta = {
          isim: 'Ã–RNEK HASTA',
          id: 'test-123'
        };
        aktifHaftaIndex = 0;
        hafta = {
          tarihAraligi: '1-7 EYLÃœL',
          tarifler: [
            'HaÅŸlanmÄ±ÅŸ Yumurta (1 adet) + 1 TatlÄ± KaÅŸÄ±ÄŸÄ± TereyaÄŸÄ±',
            'Beyaz Peynir (30 gr) + Domates ve SalatalÄ±k',
            'Izgara Tavuk GÃ¶ÄŸsÃ¼ (100 gr)',
            'YeÅŸil Salata + ZeytinyaÄŸÄ±',
            'Mercimek Ã‡orbasÄ± (1 kase)',
            'Bulgur PilavÄ± (2 yemek kaÅŸÄ±ÄŸÄ±)',
            'YoÄŸurt (1 su bardaÄŸÄ±)',
            'Elma (1 adet)',
            'FÄ±ndÄ±k (10 adet)',
            'Ã‡ilek (5-6 adet)',
            'KÄ±rmÄ±zÄ± Et (80 gr)',
            'Åehriye Ã‡orbasÄ±',
            'Marul + HavuÃ§ SalatasÄ±',
            'Tam BuÄŸday EkmeÄŸi (1 dilim)'
          ]
        };
      } else {
        aktifHaftaIndex = getAktifHaftaIndex();
        const haftaListesi = getHaftaListesi();
        hafta = haftaListesi[aktifHaftaIndex];
        hasta = seciliHasta;
        
        if (!hafta) {
          alert('Bu hafta iÃ§in veri bulunamadÄ±!');
          return;
        }
      }
      
      // PDF iÃ§eriÄŸi oluÅŸtur (geÃ§ici olarak makro verisi olmadan)
      const pdfContent = createPdfContent(hasta, hafta, aktifHaftaIndex);
      
      // Modal'Ä± aÃ§
      const modal = document.getElementById('pdfOnizlemeModal');
      const content = document.getElementById('pdfOnizlemeContent');
      const baslik = document.getElementById('pdfModalBaslik');
      const hastaInfo = document.getElementById('pdfHastaInfo');
      
      baslik.textContent = `${hasta.isim.toUpperCase()} - ${aktifHaftaIndex + 1}. Hafta Diyet Listesi`;
      hastaInfo.textContent = `${hasta.isim.toUpperCase()} â€¢ ${hafta.tarihAraligi || 'Tarih bilgisi yok'} â€¢ ${aktifHaftaIndex + 1}. Hafta`;
      content.innerHTML = pdfContent;
      
      modal.style.display = 'block';
    }
    
    // PDF iÃ§in makro verilerini hazÄ±rla
    async function prepareMacroDataForPdf(tarifler) {
      try {
        // EÄŸer food data yoksa GitHub'dan al
        if (!window.foodData || window.foodData.length === 0) {
          console.log('Food data yÃ¼kleniyor...');
          await loadFoodData();
        }
        
        if (!window.foodData || window.foodData.length === 0) {
          console.log('Food data yÃ¼klenemedi, PDF basit gÃ¶rÃ¼nÃ¼mde oluÅŸturulacak');
          window.currentFoodAnalysisData = [];
          return;
        }
        
        // Tarifleri analiz et
        const analysisData = [];
        tarifler.forEach((tarif, index) => {
          const normalizedTarif = tarif.toLowerCase()
            .replace(/Ä±/g, 'i')
            .replace(/ÄŸ/g, 'g')
            .replace(/Ã¼/g, 'u')
            .replace(/ÅŸ/g, 's')
            .replace(/Ã¶/g, 'o')
            .replace(/Ã§/g, 'c');
          
          // Yemek veritabanÄ±nda ara
          const eslesenYemek = window.foodData.find(food => {
            const normalizedFoodName = food.name.toLowerCase()
              .replace(/Ä±/g, 'i')
              .replace(/ÄŸ/g, 'g')
              .replace(/Ã¼/g, 'u')
              .replace(/ÅŸ/g, 's')
              .replace(/Ã¶/g, 'o')
              .replace(/Ã§/g, 'c');
            
            return normalizedFoodName.includes(normalizedTarif) || 
                   normalizedTarif.includes(normalizedFoodName);
          });
          
          analysisData.push({
            index: index,
            tarif: tarif,
            eslestiMi: !!eslesenYemek,
            eslesenYemek: eslesenYemek || null
          });
        });
        
        // Global deÄŸiÅŸkene kaydet
        window.currentFoodAnalysisData = analysisData;
        
      } catch (error) {
        console.error('Makro verisi hazÄ±rlama hatasÄ±:', error);
        window.currentFoodAnalysisData = [];
      }
    }
    
    function createPdfContent(hasta, hafta, haftaIndex) {
      const tarihBilgisi = hafta.tarihAraligi || `${haftaIndex + 1}. HAFTA`;
      
      let html = `
        <!-- PDF Header -->
        <div style="text-align: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px solid #333;">
          <h1 style="margin: 0; font-size: 24px; font-weight: bold; color: #333;">BESLENME UZMANLIGI</h1>
          <h2 style="margin: 10px 0; font-size: 20px; color: #666;">${hasta.isim.toUpperCase()}</h2>
          <h3 style="margin: 10px 0; font-size: 16px; color: #888;">${tarihBilgisi} ${haftaIndex + 1}. HAFTA</h3>
        </div>
      `;
      
      if (!hafta.tarifler || hafta.tarifler.length === 0) {
        html += `
          <div style="text-align: center; padding: 40px; color: #666; font-style: italic;">
            Bu hafta iÃ§in henÃ¼z yemek verisi bulunmuyor.
          </div>
        `;
        return html;
      }
      
      // Yemek veritabanÄ±ndan makro bilgileri al
      let allFoodNames = [];
      try {
        // Bu fonksiyon sadece PDF iÃ§inde kullanÄ±lacak basit makro hesaplamasÄ± yapar
        // GerÃ§ek veritabanÄ± analizi iÃ§in updateYemekVeritabaniAnalizi kullanÄ±lmalÄ±
        allFoodNames = window.currentFoodAnalysisData || [];
      } catch (error) {
        console.log('Makro verileri alÄ±namadÄ±, basit gÃ¶rÃ¼nÃ¼m kullanÄ±lacak');
      }
      
      // GÃ¼nleri oluÅŸtur
      const gunler = ['PAZARTESÄ°', 'SALI', 'Ã‡ARÅAMBA', 'PERÅEMBE', 'CUMA', 'CUMARTESÄ°', 'PAZAR'];
      const ogunler = [
        { ad: 'SABAH', saat: '(saat 07:00 civarÄ±nda)', ikon: 'ğŸŒ…' },
        { ad: 'Ã–ÄLE', saat: '(saat 12:00 civarÄ±nda)', ikon: 'â˜€ï¸' },
        { ad: 'AKÅAM', saat: '(hava kararÄ±nca)', ikon: 'ğŸŒ™' }
      ];
      
      // HaftalÄ±k toplam makrolar
      let haftalikToplamKalori = 0;
      let haftalikToplamProtein = 0;
      let haftalikToplamKarb = 0;
      let haftalikToplamYag = 0;
      
      // Tarifleri gÃ¼nlere daÄŸÄ±t (basit daÄŸÄ±tÄ±m)
      const gunBasiTarif = Math.ceil(hafta.tarifler.length / 7);
      
      gunler.forEach((gun, gunIndex) => {
        // GÃ¼nlÃ¼k makro toplamlarÄ±
        let gunlukKalori = 0;
        let gunlukProtein = 0;
        let gunlukKarb = 0;
        let gunlukYag = 0;

        // GÃ¼n iÃ§eriÄŸini Ã¶nce oluÅŸtur (Ã¶ÄŸÃ¼nleri ve Ã¶ÄŸe listelerini toplayalÄ±m)
        let gunIcerikHtml = '';

        ogunler.forEach(ogun => {
          // Bu Ã¶ÄŸÃ¼n iÃ§in tarifleri ekle (basit daÄŸÄ±tÄ±m)
          const baslangicIndex = (gunIndex * gunBasiTarif + ogunler.indexOf(ogun)) % hafta.tarifler.length;
          const bitis = Math.min(baslangicIndex + 2, hafta.tarifler.length);

          // Ã–ÄŸÃ¼n makro toplamlarÄ±
          let ogunKalori = 0;
          let ogunProtein = 0;
          let ogunKarb = 0;
          let ogunYag = 0;

          let ogunItemsHtml = '';
          for (let i = baslangicIndex; i < bitis && i < hafta.tarifler.length; i++) {
            const tarif = hafta.tarifler[i];

            // Makro bilgilerini bul
            let kalori = 0, protein = 0, karb = 0, yag = 0;
            if (allFoodNames[i] && allFoodNames[i].eslestiMi) {
              const yemek = allFoodNames[i].eslesenYemek;
              kalori = yemek.calories || 0;
              protein = yemek.protein || 0;
              karb = yemek.carbs || 0;
              yag = yemek.fat || 0;
            }

            ogunKalori += kalori;
            ogunProtein += protein;
            ogunKarb += karb;
            ogunYag += yag;

            ogunItemsHtml += `
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; padding: 6px 10px; background: white; border-radius: 3px; border: 1px solid #dee2e6;">
                <span style="flex: 1; color: #333; font-weight: 500; text-align: left;">${tarif}</span>
                ${kalori > 0 ? `
                  <div style="display: flex; gap: 8px; font-size: 11px; color: #666; margin-left: 10px;">
                    <span style="background: #fff3cd; padding: 2px 6px; border-radius: 3px;">ğŸ”¥ ${kalori}</span>
                    <span style="background: #d4edda; padding: 2px 6px; border-radius: 3px;">P: ${protein.toFixed(1)}g</span>
                    <span style="background: #cce7ff; padding: 2px 6px; border-radius: 3px;">K: ${karb.toFixed(1)}g</span>
                    <span style="background: #f8c2c2; padding: 2px 6px; border-radius: 3px;">Y: ${yag.toFixed(1)}g</span>
                  </div>
                ` : ''}
              </div>
            `;
          }

          // Ã–ÄŸÃ¼n toplamlarÄ±nÄ± gÃ¼nlÃ¼k toplama ekle
          gunlukKalori += ogunKalori;
          gunlukProtein += ogunProtein;
          gunlukKarb += ogunKarb;
          gunlukYag += ogunYag;

          // Ã–ÄŸÃ¼n baÅŸlÄ±k satÄ±rÄ±: sola yaslÄ± metin + saÄŸda makro toplamlarÄ±
          gunIcerikHtml += `
            <div style="margin-bottom: 15px; margin-left: 20px;">
              <div style="display: flex; align-items: center; justify-content: space-between; border-bottom: 2px solid #dee2e6; padding: 6px 0;">
                <h4 style="margin: 0; font-size: 16px; font-weight: bold; color: #495057; text-transform: uppercase; text-align: left;">
                  ${ogun.ikon} <strong>${ogun.ad}</strong> ${ogun.saat}
                </h4>
                ${ogunKalori > 0 ? `
                  <div style="display: flex; gap: 8px; font-size: 12px; color: #333;">
                    <span style="background: #fff3cd; padding: 3px 8px; border-radius: 4px;">ğŸ”¥ ${ogunKalori.toFixed(0)} kcal</span>
                    <span style="background: #d4edda; padding: 3px 8px; border-radius: 4px;">P: ${ogunProtein.toFixed(1)}g</span>
                    <span style="background: #cce7ff; padding: 3px 8px; border-radius: 4px;">K: ${ogunKarb.toFixed(1)}g</span>
                    <span style="background: #f8c2c2; padding: 3px 8px; border-radius: 4px;">Y: ${ogunYag.toFixed(1)}g</span>
                  </div>
                ` : ''}
              </div>
              <div style="background: #f8f9fa; padding: 10px; border-radius: 5px; border-left: 3px solid #28a745;">
                ${ogunItemsHtml}
              </div>
            </div>
          `;
        });

        // GÃ¼n kapsayÄ±cÄ±: baÅŸlÄ±k satÄ±rÄ± (sola yaslÄ±) + saÄŸda gÃ¼nlÃ¼k toplam makrolar
        html += `
          <div style="margin-bottom: 25px; page-break-inside: avoid;">
            <div style="display: flex; align-items: center; justify-content: space-between; background: linear-gradient(135deg, #007bff, #0056b3); color: white; padding: 12px 16px; margin: 0 0 15px 0; border-radius: 5px; font-size: 18px; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; box-shadow: 0 2px 4px rgba(0,123,255,0.3);">
              <h3 style="margin: 0; font-size: 18px; font-weight: bold; text-align: left;">${gun}</h3>
              ${gunlukKalori > 0 ? `
                <div style="display: flex; gap: 10px; font-size: 12px; color: #fff;">
                  <span style="background: rgba(255,255,255,0.15); padding: 4px 10px; border-radius: 4px;">ğŸ”¥ ${gunlukKalori.toFixed(0)} kcal</span>
                  <span style="background: rgba(255,255,255,0.15); padding: 4px 10px; border-radius: 4px;">P: ${gunlukProtein.toFixed(1)}g</span>
                  <span style="background: rgba(255,255,255,0.15); padding: 4px 10px; border-radius: 4px;">K: ${gunlukKarb.toFixed(1)}g</span>
                  <span style="background: rgba(255,255,255,0.15); padding: 4px 10px; border-radius: 4px;">Y: ${gunlukYag.toFixed(1)}g</span>
                </div>
              ` : ''}
            </div>
            ${gunIcerikHtml}
          </div>
        `;

        // HaftalÄ±k toplama ekle
        haftalikToplamKalori += gunlukKalori;
        haftalikToplamProtein += gunlukProtein;
        haftalikToplamKarb += gunlukKarb;
        haftalikToplamYag += gunlukYag;
      });
      
      // HaftalÄ±k ortalama makrolar (yalnÄ±zca ortalamalar gÃ¶sterilir)
      if (haftalikToplamKalori > 0) {
        const gunSayisi = 7;
        html += `
          <div style="margin-top: 30px; padding: 20px; background: linear-gradient(135deg, #6f42c1, #5a2d91); color: white; border-radius: 10px; text-align: center; box-shadow: 0 4px 8px rgba(111,66,193,0.4);">
            <h3 style="margin: 0 0 15px 0; font-size: 20px; font-weight: bold;">ğŸ“ˆ GÃœNLÃœK ORTALAMA MAKROLAR</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 15px;">
              <div style="background: rgba(255,255,255,0.1); padding: 12px; border-radius: 8px;">
                <div style="font-size: 14px; margin-bottom: 5px;">ğŸ”¥ GÃ¼nlÃ¼k Ortalama Kalori</div>
                <div style="font-size: 24px; font-weight: bold;">${(haftalikToplamKalori / gunSayisi).toFixed(0)}</div>
              </div>
              <div style="background: rgba(255,255,255,0.1); padding: 12px; border-radius: 8px;">
                <div style="font-size: 14px; margin-bottom: 5px;">ğŸ¥© GÃ¼nlÃ¼k Ortalama Protein</div>
                <div style="font-size: 24px; font-weight: bold;">${(haftalikToplamProtein / gunSayisi).toFixed(1)}g</div>
              </div>
              <div style="background: rgba(255,255,255,0.1); padding: 12px; border-radius: 8px;">
                <div style="font-size: 14px; margin-bottom: 5px;">ğŸ GÃ¼nlÃ¼k Ortalama Karbonhidrat</div>
                <div style="font-size: 24px; font-weight: bold;">${(haftalikToplamKarb / gunSayisi).toFixed(1)}g</div>
              </div>
              <div style="background: rgba(255,255,255,0.1); padding: 12px; border-radius: 8px;">
                <div style="font-size: 14px; margin-bottom: 5px;">ğŸ¥‘ GÃ¼nlÃ¼k Ortalama YaÄŸ</div>
                <div style="font-size: 24px; font-weight: bold;">${(haftalikToplamYag / gunSayisi).toFixed(1)}g</div>
              </div>
            </div>
          </div>
        `;
      }
      
      // Footer
      html += `
        <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd; text-align: center; color: #666; font-size: 12px;">
          <p>Bu diyet listesi ${hasta.isim} iÃ§in Ã¶zel olarak hazÄ±rlanmÄ±ÅŸtÄ±r.</p>
          <p>OluÅŸturulma Tarihi: ${new Date().toLocaleDateString('tr-TR')}</p>
        </div>
      `;
      
      return html;
    }
    
    function pdfModalKapat(event) {
      if (event && event.target !== event.currentTarget) return;
      
      const modal = document.getElementById('pdfOnizlemeModal');
      modal.style.display = 'none';
    }
    
    function pdfYazdir() {
      const content = document.getElementById('pdfOnizlemeContent').innerHTML;
      const printWindow = window.open('', '_blank');
      printWindow.document.write(`
        <html>
          <head>
            <title>Diyet Listesi</title>
            <style>
              body { font-family: 'Times New Roman', serif; line-height: 1.4; margin: 20px; }
              @page { margin: 2cm; }
              @media print { 
                body { margin: 0; }
                .no-print { display: none; }
              }
            </style>
          </head>
          <body>
            ${content}
          </body>
        </html>
      `);
      printWindow.document.close();
      printWindow.print();
    }
    
    function pdfIndir() {
      alert('PDF indirme Ã¶zelliÄŸi yakÄ±nda eklenecek!');
    }
    
    // Hasta seÃ§ildiÄŸinde PDF butonunu gÃ¶ster/gizle
    function togglePdfButton() {
      const pdfBtn = document.getElementById('pdfOnizlemeBtn');
      if (seciliHasta) {
        pdfBtn.style.display = 'flex';
      } else {
        pdfBtn.style.display = 'none';
      }
    }
    
    //   OTOMATÄ°K SENKRONIZASYON SÄ°STEMÄ°
    
    // Senkronizasyon durumu gÃ¶stergesi gÃ¼ncelle
    function senkronizasyonDurumuGuncelle(durum, mesaj) {
      const gosterge = document.querySelector('[title*="Otomatik GitHub senkronizasyonu"]');
      if (gosterge) {
        switch (durum) {
          case 'syncing':
            gosterge.textContent = 'ğŸ”„ Syncing...';
            gosterge.style.color = '#ffc107';
            break;
          case 'success':
            gosterge.textContent = 'âœ… Synced';
            gosterge.style.color = '#28a745';
            setTimeout(() => {
              gosterge.textContent = 'ğŸ”„ Auto-Sync';
              gosterge.style.color = '#28a745';
            }, 3000);
            break;
          case 'error':
            gosterge.textContent = 'âŒ Error';
            gosterge.style.color = '#dc3545';
            setTimeout(() => {
              gosterge.textContent = 'ğŸ”„ Auto-Sync';
              gosterge.style.color = '#28a745';
            }, 5000);
            break;
          case 'offline':
            gosterge.textContent = 'ğŸ“´ Offline';
            gosterge.style.color = '#6c757d';
            break;
        }
        if (mesaj) {
          gosterge.title = mesaj;
        }
      }
    }
    
    // GitHub token alma fonksiyonu
    function getGithubToken() {
      return document.getElementById('githubToken')?.value?.trim() || null;
    }
    
    // Otomatik GitHub senkronizasyonu
    async function otomatikGithubSenkronizasyon() {
      const token = getGithubToken();
      if (!token) {
        console.log('â„¹ï¸ GitHub token yok, otomatik senkronizasyon devre dÄ±ÅŸÄ±');
        senkronizasyonDurumuGuncelle('offline', 'GitHub token gerekli');
        return;
      }
      
      try {
        console.log('ğŸ”„ Otomatik GitHub senkronizasyonu baÅŸlÄ±yor...');
        senkronizasyonDurumuGuncelle('syncing', 'Senkronizasyon devam ediyor...');
        
        // GitHub'dan son versiyonu kontrol et
        const githubResponse = await fetch('https://api.github.com/repos/mustafasacar35/lipodem-takip-paneli-3/contents/food_list.json', {
          headers: {
            'Authorization': `token ${token}`,
            'Accept': 'application/vnd.github.v3+json'
          }
        });
        
        if (!githubResponse.ok) {
          console.log('âš ï¸ GitHub dosyasÄ± kontrol edilemedi');
          senkronizasyonDurumuGuncelle('error', 'GitHub eriÅŸim hatasÄ±');
          return;
        }
        
        console.log('âœ… GitHub ile baÄŸlantÄ± baÅŸarÄ±lÄ±, sistem gÃ¼ncel');
        senkronizasyonDurumuGuncelle('success', 'GitHub ile senkronize');
        
      } catch (error) {
        console.error('âŒ Otomatik senkronizasyon hatasÄ±:', error);
        senkronizasyonDurumuGuncelle('error', `Hata: ${error.message}`);
      }
    }
    
    // Otomatik GitHub baÄŸlantÄ± kontrolÃ¼
    async function otomatikGithubKontrol() {
      const token = getGithubToken();
      try {
        console.log('ğŸ” GitHub baÄŸlantÄ±sÄ± kontrol ediliyor...');
        senkronizasyonDurumuGuncelle('syncing', 'GitHub kontrolÃ¼...');
        
        const response = await fetch('https://api.github.com/repos/mustafasacar35/lipodem-takip-paneli-3/contents/food_list.json', {
          headers: {
            'Authorization': `token ${token}`,
            'Accept': 'application/vnd.github.v3+json'
          }
        });
        
        if (response.ok) {
          console.log('âœ… GitHub baÄŸlantÄ±sÄ± baÅŸarÄ±lÄ±');
          senkronizasyonDurumuGuncelle('success', 'GitHub eriÅŸimi aktif');
          
          // ğŸš¨ DEBUG: GitHub'daki food_list.json'u kontrol et
          const githubData = await response.json();
          const githubContent = JSON.parse(atob(githubData.content));
          console.log('ğŸ•µï¸ GITHUB DEBUG - food_list.json SHA:', githubData.sha);
          console.log('ğŸ•µï¸ GITHUB DEBUG - Ä°lk yemek Ã¶rneÄŸi:', githubContent.categories?.[0]?.items?.[0]);
          
        } else {
          console.log('âŒ GitHub baÄŸlantÄ± hatasÄ±');
          senkronizasyonDurumuGuncelle('error', 'GitHub eriÅŸim hatasÄ±');
        }
      } catch (error) {
        console.error('âŒ GitHub kontrolÃ¼ hatasÄ±:', error);
        senkronizasyonDurumuGuncelle('error', `GitHub hatasÄ±: ${error.message}`);
      }
    }
    
    // Yemek kaydetme iÅŸleminden sonra otomatik senkronizasyon tetikleme
    function yemekKaydetSonrasiSenkronizasyon() {
      // 1 saniye sonra GitHub kontrolÃ¼ baÅŸlat (modal kapanmasÄ± iÃ§in)
      setTimeout(() => {
        otomatikGithubKontrol();
      }, 1000);
    }
    
    // Periyodik senkronizasyon (her 5 dakikada bir kontrol)
    function periyodikSenkronizasyonBaslat() {
      setInterval(() => {
        otomatikGithubKontrol();
      }, 5 * 60 * 1000); // 5 dakika
    }
    
    //  ğŸš€ LOKAL FOOD_LIST.JSON'U GITHUB'A YÃœKLEME FONKSÄ°YONU
    async function lokalFoodListGithubYukle() {
      console.log('ğŸš€ Lokal food_list.json GitHub\'a yÃ¼kleniyor...');
      
      const token = getGithubToken();
      if (!token) {
        alert('âŒ GitHub token bulunamadÄ±! YÃ¼kleme iÅŸlemi iptal edildi.');
        return;
      }
      
      try {
        // Lokal food_list.json dosyasÄ±nÄ± oku
        const response = await fetch('./food_list.json');
        if (!response.ok) {
          throw new Error('Lokal food_list.json dosyasÄ± okunamadÄ±');
        }
        const lokalData = await response.json();
        console.log('ğŸ“„ Lokal food_list.json okundu:', Object.keys(lokalData));
        
        // GitHub'daki mevcut dosyayÄ± al
        const gitHubResponse = await fetch('https://api.github.com/repos/mustafasacar35/lipodem-takip-paneli-3/contents/food_list.json', {
          headers: {
            'Authorization': `token ${token}`,
            'Accept': 'application/vnd.github.v3+json'
          }
        });
        
        if (!gitHubResponse.ok) {
          throw new Error('GitHub dosyasÄ± alÄ±namadÄ±');
        }
        
        const gitHubData = await gitHubResponse.json();
        console.log('ğŸ“„ GitHub food_list.json SHA:', gitHubData.sha);
        
        // Lokal dosyayÄ± encode et
        const encodedContent = encodeUTF8ToBase64(lokalData);
        
        // GitHub'a yÃ¼kle
        const uploadResponse = await fetch('https://api.github.com/repos/mustafasacar35/lipodem-takip-paneli-3/contents/food_list.json', {
          method: 'PUT',
          headers: {
            'Authorization': `token ${token}`,
            'Accept': 'application/vnd.github.v3+json',
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            message: 'ğŸ½ï¸ Lokal food_list.json gÃ¼ncellemeleri GitHub\'a yÃ¼klendi',
            content: encodedContent,
            sha: gitHubData.sha
          })
        });
        
        if (!uploadResponse.ok) {
          const errorText = await uploadResponse.text();
          throw new Error(`GitHub yÃ¼kleme hatasÄ±: ${errorText}`);
        }
        
        console.log('âœ… Lokal food_list.json baÅŸarÄ±yla GitHub\'a yÃ¼klendi!');
        alert('âœ… Lokal food_list.json baÅŸarÄ±yla GitHub\'a yÃ¼klendi!');
        
        // YÃ¼kleme sonrasÄ± yemek veritabanÄ± analizini gÃ¼ncelle
        updateYemekVeritabaniAnalizi();
        
      } catch (error) {
        console.error('âŒ Lokal food_list.json GitHub\'a yÃ¼klenirken hata:', error);
        alert(`âŒ Hata: ${error.message}`);
      }
    }
    
    // Global fonksiyonlarÄ± ekle
    window.pdfOnizlemeAc = pdfOnizlemeAc;
    window.pdfModalKapat = pdfModalKapat;
    window.pdfYazdir = pdfYazdir;
    window.pdfIndir = pdfIndir;
    window.lokalFoodListGithubYukle = lokalFoodListGithubYukle;

    // ==================== Ã–ÄÃœN ÅABLON SÄ°STEMÄ° ====================
    
    // GitHub Raw URL'leri (mevcut repository kullanÄ±lÄ±yor)
    const GITHUB_MEAL_TEMPLATES_URL = 'https://raw.githubusercontent.com/mustafasacar/lipodem-takip-paneli-3/main/meal-templates.json';
    const GITHUB_DAY_TEMPLATES_URL = 'https://raw.githubusercontent.com/mustafasacar/lipodem-takip-paneli-3/main/day-templates.json';
    
    async function kaydetOgunSablonu(gunAdi, ogunAdi) {
      console.log('ğŸ’¾ Ã–ÄŸÃ¼n ÅŸablonu kaydetme baÅŸlatÄ±ldÄ±:', gunAdi, ogunAdi);
      
      // Bu Ã¶ÄŸÃ¼n altÄ±ndaki tÃ¼m yemek satÄ±rlarÄ±nÄ± bul
      const ogunYemekleri = [];
      let eslesmemisYemekSayisi = 0;
      
      if (!window.currentFoodAnalysisData) {
        showToast('âŒ Veri bulunamadÄ±!', 'error');
        return;
      }
      
      console.log('ğŸ” Toplam veri satÄ±rÄ±:', window.currentFoodAnalysisData.length);
      
      // Turkish character normalization function
      function normalizeTurkish(text) {
        return text.toLowerCase()
          .replace(/iÌ‡/g, 'i')
          .replace(/Ä±/g, 'i')
          .replace(/ÄŸ/g, 'g')
          .replace(/Ã¼/g, 'u')
          .replace(/ÅŸ/g, 's')
          .replace(/Ã¶/g, 'o')
          .replace(/Ã§/g, 'c');
      }
      
      // Ã–ÄŸÃ¼n altÄ±ndaki yemekleri topla - Ä°yileÅŸtirilmiÅŸ algoritma
      let ogunBulundu = false;
      let mevcutGun = '';
      let dogruGun = false;
      
      const normalizedGunAdi = normalizeTurkish(gunAdi);
      const normalizedOgunAdi = normalizeTurkish(ogunAdi);
      
      console.log('ğŸ¯ Hedef:', { gunAdi, ogunAdi, normalizedGunAdi, normalizedOgunAdi });
      
      window.currentFoodAnalysisData.forEach((item, index) => {
        console.log(`ğŸ” [${index}] SatÄ±r: ${item.text || item.tarifAdi} | gunOgunSatiri: ${item.gunOgunSatiri} | karalistede: ${item.karalistede}`);
        
        const itemText = item.text || item.tarifAdi;
        
        // GÃ¼n tespit et - GÃ¼nleri direkt algÄ±la
        if (item.gunOgunSatiri && !item.karalistede) {
          const normalizedText = normalizeTurkish(itemText.toLowerCase().trim());
          const gunIsimleri = ['pazartesi', 'sali', 'carsamba', 'persembe', 'cuma', 'cumartesi', 'pazar'];
          
          // Bu satÄ±r bir gÃ¼n adÄ± iÃ§eriyor mu kontrol et
          const bulunanGun = gunIsimleri.find(gun => normalizedText.includes(normalizeTurkish(gun)));
          
          if (bulunanGun) {
            mevcutGun = itemText;
            
            // GÃ¼n eÅŸleÅŸme kontrolÃ¼
            const normalizedMevcutGun = normalizeTurkish(mevcutGun);
            dogruGun = normalizedMevcutGun.includes(normalizedGunAdi);
            
            ogunBulundu = false;
            console.log('ğŸ“… GÃ¼n tespit edildi:', mevcutGun, '| DoÄŸru gÃ¼n:', dogruGun, '| bulunanGun:', bulunanGun);
            return;
          }
        }
        
        // Ã–ÄŸÃ¼n tespit et - Daha esnek algÄ±lama
        if (item.gunOgunSatiri && !item.karalistede && dogruGun) {
          const normalizedOgunSatiri = normalizeTurkish(itemText);
          
          // Ã–ÄŸÃ¼n pattern kontrolÃ¼
          const ogunPatterns = ['Ã¶ÄŸle', 'aksam', 'sabah', 'kahvalti', 'ara Ã¶ÄŸÃ¼n'];
          let ogunEslesti = false;
          
          // Direct match kontrolÃ¼
          if (normalizedOgunSatiri.includes(normalizedOgunAdi)) {
            ogunEslesti = true;
          } else {
            // Pattern match kontrolÃ¼
            for (const pattern of ogunPatterns) {
              const normalizedPattern = normalizeTurkish(pattern);
              if (normalizedOgunAdi.includes(normalizedPattern) && normalizedOgunSatiri.includes(normalizedPattern)) {
                ogunEslesti = true;
                break;
              }
            }
          }
          
          console.log('ğŸ½ï¸ Ã–ÄŸÃ¼n kontrolÃ¼:', {
            ogunSatiri: itemText,
            normalizedOgunSatiri,
            normalizedOgunAdi,
            ogunEslesti,
            dogruGun
          });
          
          if (ogunEslesti) {
            ogunBulundu = true;
            console.log('âœ… Hedef Ã¶ÄŸÃ¼n bulundu!');
          } else {
            ogunBulundu = false;
          }
        }
        
        // Bu Ã¶ÄŸÃ¼n altÄ±ndaki yemekler
        if (ogunBulundu && !item.gunOgunSatiri && !item.karalistede) {
          console.log('ğŸ Ã–ÄŸÃ¼n altÄ±ndaki yemek:', itemText, '| eslestiMi:', item.eslestiMi, '| eslesenYemek:', !!item.eslesenYemek);
          
          if (!item.eslestiMi) {
            eslesmemisYemekSayisi++;
            console.log('âŒ EÅŸleÅŸmemiÅŸ yemek:', itemText);
          } else if (item.eslesenYemek) {
            console.log('âœ… Yemek ekleniyor:', itemText, 'â†’', item.eslesenYemek.originalName || item.eslesenYemek.name);
            ogunYemekleri.push({
              foodName: item.eslesenYemek.originalName || item.eslesenYemek.name,
              originalText: itemText,
              calories: item.eslesenYemek.calories || 0,
              protein: item.eslesenYemek.protein || 0,
              carbs: item.eslesenYemek.carbs || 0,
              fat: item.eslesenYemek.fat || 0
            });
            console.log('âœ… EÅŸleÅŸen yemek eklendi:', item.tarifAdi);
          } else {
            console.log('âš ï¸ EÅŸleÅŸti ama eslesenYemek verisi yok:', item.tarifAdi, '| item:', item);
          }
        }
      });
      
      console.log('ğŸ“Š SonuÃ§:', {
        ogunYemekleri: ogunYemekleri.length,
        eslesmemisYemekSayisi,
        hedeflenenGun: gunAdi,
        hedeflenenOgun: ogunAdi,
        bulunanYemekler: ogunYemekleri.map(y => y.originalText)
      });
      
      console.log('ğŸ” EslesmemisYemekSayisi kontrol:', eslesmemisYemekSayisi, '> 0 =', eslesmemisYemekSayisi > 0);
      console.log('ğŸ” OgunYemekleri length kontrol:', ogunYemekleri.length, '=== 0 =', ogunYemekleri.length === 0);
      
      // GÃ¼venlik kontrolÃ¼
      if (eslesmemisYemekSayisi > 0) {
        console.log('âŒ EÅŸleÅŸmemiÅŸ yemek nedeniyle durduruluyor');
        showToast(`âŒ Bu Ã¶ÄŸÃ¼n kaydedilemez! ${eslesmemisYemekSayisi} yemek eÅŸleÅŸmemiÅŸ. Ã–nce tÃ¼m yemekleri eÅŸleÅŸtirin.`, 'error', 5000);
        return;
      }
      
      if (ogunYemekleri.length === 0) {
        console.log('âŒ Yemek bulunamadÄ±ÄŸÄ± iÃ§in durduruluyor');
        showToast('âŒ Bu Ã¶ÄŸÃ¼nde kaydetmeye uygun yemek bulunamadÄ±!', 'error');
        return;
      }
      
      console.log('âœ… TÃ¼m kontroller geÃ§ildi, ÅŸablon modal aÃ§Ä±lÄ±yor...');
      
      // Hasta bilgilerini PDF'den topla
      let hastaBilgileri = null;
      
      if (seciliHasta && aktifHaftaIndex !== null && seciliHasta.haftalar[aktifHaftaIndex]) {
        const aktifHafta = seciliHasta.haftalar[aktifHaftaIndex];
        
        // PDF'den isim ve tarih bilgisini al
        let pdfIsim = null;
        let pdfTarihAraligi = null;
        let pdfHaftaNo = null;
        
        // PDF orijinal isminden bilgileri Ã§Ä±kar
        if (aktifHafta.pdfOrijinalIsim) {
          const pdfAdi = aktifHafta.pdfOrijinalIsim;
          console.log('ğŸ” PDF adÄ±ndan bilgi Ã§Ä±karÄ±lÄ±yor:', pdfAdi);
          
          // "AYÅEGÃœL FAROOQ 8-14 EYLÃœL 2. HAFTA.pdf" formatÄ±ndan parse et
          // Regex'i daha esnek yap - isim kÄ±smÄ±nda Ã¶zel karakterler olabilir
          const pdfMatch = pdfAdi.match(/^(.+?)\s+(\d{1,2}-\d{1,2}\s+[A-ZÃœÃ‡ÄÃ–ÅÄ°]+(?:\s+\d{4})?)\s+(\d+)\.\s*HAFTA\.pdf$/i);
          
          console.log('ğŸ” Regex test sonucu:', pdfMatch);
          
          if (pdfMatch) {
            pdfIsim = pdfMatch[1].trim().toUpperCase();
            pdfTarihAraligi = pdfMatch[2].trim().toUpperCase();
            pdfHaftaNo = parseInt(pdfMatch[3]);
            console.log('âœ… PDF bilgileri baÅŸarÄ±yla Ã§Ä±karÄ±ldÄ±:', { pdfIsim, pdfTarihAraligi, pdfHaftaNo });
          } else {
            console.log('âš ï¸ PDF adÄ± beklenilen formatta deÄŸil, alternatif parse dene');
            
            // Alternatif parse - boÅŸluklarla ayÄ±r
            const parts = pdfAdi.replace('.pdf', '').split(/\s+/);
            console.log('ğŸ” PDF adÄ± parÃ§alara ayrÄ±ldÄ±:', parts);
            
            // Son kÄ±sÄ±mda "X. HAFTA" ara
            let haftaIndex = -1;
            for (let i = parts.length - 2; i >= 0; i--) {
              if (parts[i].match(/^\d+\.$/) && parts[i + 1] && parts[i + 1].toUpperCase() === 'HAFTA') {
                haftaIndex = i;
                break;
              }
            }
            
            if (haftaIndex > 0) {
              pdfHaftaNo = parseInt(parts[haftaIndex].replace('.', ''));
              
              // Ä°sim kÄ±smÄ±nÄ± al (hafta bilgisinden Ã¶nceki kÄ±sÄ±m)
              let isimParts = [];
              let tarihParts = [];
              let tarihBasladi = false;
              
              for (let i = 0; i < haftaIndex; i++) {
                const part = parts[i];
                // Tarih pattern'i kontrol et (sayÄ±-sayÄ± formatÄ±)
                if (part.match(/^\d{1,2}-\d{1,2}$/) || tarihBasladi) {
                  tarihBasladi = true;
                  tarihParts.push(part);
                } else {
                  isimParts.push(part);
                }
              }
              
              pdfIsim = isimParts.join(' ').toUpperCase();
              pdfTarihAraligi = tarihParts.join(' ').toUpperCase();
              
              console.log('âœ… Alternatif parse baÅŸarÄ±lÄ±:', { pdfIsim, pdfTarihAraligi, pdfHaftaNo });
            } else {
              console.log('âŒ Hafta bilgisi bulunamadÄ±, varsayÄ±lan deÄŸerleri kullan');
              pdfIsim = seciliHasta.isim;
              pdfTarihAraligi = aktifHafta.tarihAraligi;
              pdfHaftaNo = aktifHaftaIndex + 1;
            }
          }
        } else {
          // PDF bilgisi yoksa mevcut bilgileri kullan
          pdfIsim = seciliHasta.isim;
          pdfTarihAraligi = aktifHafta.tarihAraligi;
          pdfHaftaNo = aktifHaftaIndex + 1;
        }
        
        hastaBilgileri = {
          isim: pdfIsim,
          tarihAraligi: pdfTarihAraligi,
          haftaNo: pdfHaftaNo,
          gunAdi: gunAdi // Hangi gÃ¼nden alÄ±ndÄ±ÄŸÄ±nÄ± ekle
        };
        
        console.log('ğŸ“‹ Hasta bilgileri hazÄ±rlandÄ±:', hastaBilgileri);
      }
      
      // Modal ile ÅŸablon kaydetme
      await sablonKaydetModalAc(ogunAdi, ogunYemekleri, hastaBilgileri);
    }
    
    // GitHub'a ÅŸablon kaydetme fonksiyonu
    async function githubaSablonKaydet(dosyaAdi, yeniSablon) {
      const token = document.getElementById('githubToken').value.trim();
      if (!token) {
        throw new Error('GitHub token bulunamadÄ±');
      }
      
      const repoOwner = 'mustafasacar35';
      const repoName = 'lipodem-takip-paneli-3';
      const apiUrl = `https://api.github.com/repos/${repoOwner}/${repoName}/contents/${dosyaAdi}`;
      
      try {
        // Ã–nce mevcut dosyayÄ± al
        let mevcutIcerik = [];
        let sha = null;
        
        const mevcutResponse = await fetch(apiUrl, {
          headers: { 'Authorization': `token ${token}` }
        });
        
        if (mevcutResponse.ok) {
          const mevcutData = await mevcutResponse.json();
          // UTF-8 decode kullan (atob yerine)
          const cleanBase64 = mevcutData.content.replace(/\s/g, '');
          const content = decodeBase64UTF8(cleanBase64);
          mevcutIcerik = JSON.parse(content);
          sha = mevcutData.sha;
          console.log('âœ… Mevcut ÅŸablonlar yÃ¼klendi:', mevcutIcerik.length, 'adet');
          console.log('ğŸ” Ä°lk ÅŸablon adÄ±:', mevcutIcerik[0]?.name?.substring(0, 50));
        } else if (mevcutResponse.status === 404) {
          console.log('ğŸ“„ meal-templates.json dosyasÄ± yok, yeni oluÅŸturulacak');
          mevcutIcerik = [];
          sha = null;
        } else {
          throw new Error(`GitHub API dosya okuma hatasÄ±: ${mevcutResponse.status}`);
        }
        
        // Yeni ÅŸablonu ekle
        mevcutIcerik.push(yeniSablon);
        
        // TÃ¼rkÃ§e karakter desteÄŸi iÃ§in UTF-8 encoding
        const jsonString = JSON.stringify(mevcutIcerik, null, 2);
        console.log('ğŸ” JSON string uzunluÄŸu:', jsonString.length);
        
        // UTF-8 string'i base64'e Ã§evir - daha gÃ¼venli yÃ¶ntem
        const base64String = btoa(unescape(encodeURIComponent(jsonString)));
        console.log('ğŸ” Base64 string uzunluÄŸu:', base64String.length);
        
        const kaydetPayload = {
          message: `Yeni Ã¶ÄŸÃ¼n ÅŸablonu eklendi: ${yeniSablon.name}`,
          content: base64String
        };
        
        // EÄŸer dosya zaten varsa SHA ekle
        if (sha) {
          kaydetPayload.sha = sha;
        }
        
        const kaydetResponse = await fetch(apiUrl, {
          method: 'PUT',
          headers: {
            'Authorization': `token ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(kaydetPayload)
        });
        
        console.log('ğŸ” GitHub kaydet response status:', kaydetResponse.status);
        console.log('ğŸ” GitHub kaydet response headers:', Object.fromEntries(kaydetResponse.headers.entries()));
        
        if (!kaydetResponse.ok) {
          let errorMessage = `GitHub API hatasÄ±: ${kaydetResponse.status} ${kaydetResponse.statusText}`;
          try {
            const errorData = await kaydetResponse.json();
            console.log('ğŸ” GitHub error detail:', errorData);
            if (errorData.message) {
              errorMessage = `GitHub API hatasÄ±: ${errorData.message}`;
            }
          } catch (e) {
            console.log('ğŸ” JSON parse error:', e.message);
            // JSON parse error, use status message
          }
          throw new Error(errorMessage);
        }
        
        console.log('âœ… GitHub kaydetme baÅŸarÄ±lÄ±!');
      } catch (error) {
        console.error('âŒ GitHub kaydetme hatasÄ±:', error);
        throw error;
      }
    }
    
    async function alternatifleriGosterOgun(gunAdi, ogunAdi) {
      console.log('ğŸ”„ Ã–ÄŸÃ¼n alternatifleri gÃ¶steriliyor:', gunAdi, ogunAdi);
      showToast('ğŸ”„ Ã–ÄŸÃ¼n alternatifleri Ã¶zelliÄŸi yakÄ±nda eklenecek!', 'info');
      
      // TODO: GitHub'dan Ã¶ÄŸÃ¼n ÅŸablonlarÄ±nÄ± Ã§ek ve benzer makrolara gÃ¶re sÄ±rala
    }

    // === ÅABLON KAYDETME MODAL SÄ°STEMÄ° ===
    
    // Modal'Ä± aÃ§ ve verilerle doldur
    async function sablonKaydetModalAc(ogunAdi, ogunYemekleri, hastaBilgileri = null) {
      const modal = document.getElementById('sablonKaydetModal');
      
      // Ã–nce diyet tÃ¼rlerini yÃ¼kle
      try {
        if (!window.diyetTurleri || window.diyetTurleri.length === 0) {
          console.log('ğŸ”„ Diyet tÃ¼rleri yÃ¼kleniyor...');
          await diyetTurleriYukle();
        }
      } catch (error) {
        console.log('âš ï¸ Diyet tÃ¼rleri yÃ¼klenemedi:', error.message);
      }
      
      // En bÃ¼yÃ¼k ÅŸablon numarasÄ±nÄ± bul - mevcut ÅŸablonlardan
      let enBuyukNumara = 0;
      mevcutSablonlar.forEach(sablon => {
        if (sablon.name) {
          // Åablon isminin baÅŸÄ±ndaki numarayÄ± Ã§Ä±kar
          const numaraMatch = sablon.name.match(/^(\d+)\./);
          if (numaraMatch) {
            const numara = parseInt(numaraMatch[1]);
            if (numara > enBuyukNumara) {
              enBuyukNumara = numara;
            }
          }
        }
      });
      
      // SÄ±radaki numara
      const yeniSablonNumarasi = enBuyukNumara + 1;
      
      console.log('ğŸ”¢ Åablon numaralandÄ±rma:', {
        mevcutSablonSayisi: mevcutSablonlar.length,
        enBuyukNumara,
        yeniSablonNumarasi
      });
      
      // Ã–ÄŸÃ¼n adÄ±nÄ± temizle - sadece Ã¶ÄŸÃ¼n tipi
      let temizOgunAdi = ogunAdi.toLowerCase();
      if (temizOgunAdi.includes('tercihen')) {
        if (temizOgunAdi.includes('Ã¶ÄŸle')) {
          temizOgunAdi = 'Ã¶ÄŸle';
        } else if (temizOgunAdi.includes('akÅŸam')) {
          temizOgunAdi = 'akÅŸam';
        }
      }
      
      // Hasta bilgisi varsa yeni format kullan
      let oncerilerinIsim = `${temizOgunAdi}-${yeniSablonNumarasi}`;
      if (hastaBilgileri && hastaBilgileri.isim && hastaBilgileri.tarihAraligi && hastaBilgileri.haftaNo) {
        const formatliTarih = hastaBilgileri.tarihAraligi.includes('2025') ? 
          hastaBilgileri.tarihAraligi : `${hastaBilgileri.tarihAraligi} 2025`;
        
        // GÃ¼n adÄ±nÄ± da ekle - TÃ¼rkÃ§e formatÄ±nda
        const gunAdi = hastaBilgileri.gunAdi ? hastaBilgileri.gunAdi.charAt(0).toUpperCase() + hastaBilgileri.gunAdi.slice(1).toLowerCase() : '';
        
        // Tek satÄ±rda format - dÃ¼zgÃ¼n boÅŸluklarla, gÃ¼n bilgisi ile
        oncerilerinIsim = `${yeniSablonNumarasi}. ğŸ“‹ ${hastaBilgileri.isim} - ${formatliTarih} - ${gunAdi} - ${temizOgunAdi}. ${hastaBilgileri.haftaNo}. hafta`;
      }
      
      // Formu doldur
      document.getElementById('sablonKaydetIsim').value = oncerilerinIsim;
      document.getElementById('sablonKaydetOneri').textContent = `ğŸ’¡ Ã–nerilen format: ${oncerilerinIsim}`;
      document.getElementById('sablonKaydetAciklama').textContent = `${ogunYemekleri.length} yemek kaydedilecek`;
      
      // Diyet tÃ¼rleri dropdown'Ä±nÄ± doldur
      const diyetSelect = document.getElementById('sablonKaydetDiyetTuru');
      diyetSelect.innerHTML = '<option value="">Diyet tÃ¼rÃ¼ seÃ§in (isteÄŸe baÄŸlÄ±)</option>';
      
      console.log('ğŸ” Diyet tÃ¼rleri kontrol:', window.diyetTurleri ? window.diyetTurleri.length : 'undefined');
      
      if (window.diyetTurleri && window.diyetTurleri.length > 0) {
        console.log('âœ… Diyet tÃ¼rleri bulundu, dropdown dolduruluyor...');
        window.diyetTurleri.forEach(diyet => {
          const option = document.createElement('option');
          option.value = diyet.id;
          option.textContent = `${diyet.name} (${diyet.karbOrani}% K, ${diyet.proteinOrani}% P, ${diyet.yagOrani}% Y)`;
          diyetSelect.appendChild(option);
          console.log('ğŸ“‹ Diyet tÃ¼rÃ¼ eklendi:', diyet.name);
        });
      } else {
        console.log('âš ï¸ Diyet tÃ¼rleri bulunamadÄ±, varsayÄ±lan seÃ§enekler ekleniyor...');
        // VarsayÄ±lan diyet tÃ¼rleri ekle
        const varsayilanDiyetler = [
          { id: 'ketogenic', name: 'Ketojenik', karbOrani: 5, proteinOrani: 25, yagOrani: 70 },
          { id: 'low-carb', name: 'DÃ¼ÅŸÃ¼k Karbonhidrat', karbOrani: 20, proteinOrani: 30, yagOrani: 50 },
          { id: 'mediterranean', name: 'Akdeniz Diyeti', karbOrani: 40, proteinOrani: 20, yagOrani: 40 }
        ];
        
        varsayilanDiyetler.forEach(diyet => {
          const option = document.createElement('option');
          option.value = diyet.id;
          option.textContent = `${diyet.name} (${diyet.karbOrani}% K, ${diyet.proteinOrani}% P, ${diyet.yagOrani}% Y)`;
          diyetSelect.appendChild(option);
        });
      }
      
      // Hasta bilgilerini doldur
      const hastaBilgiDiv = document.getElementById('sablonKaydetHastaBilgi');
      if (hastaBilgileri && hastaBilgileri.isim) {
        // Hasta bilgileri varsa gÃ¶ster
        hastaBilgiDiv.style.display = 'block';
        document.getElementById('sablonKaydetHastaIsim').textContent = hastaBilgileri.isim.toUpperCase();
        document.getElementById('sablonKaydetHastaTarih').textContent = hastaBilgileri.tarihAraligi || 'Tarih bilgisi yok';
        document.getElementById('sablonKaydetHastaHafta').textContent = hastaBilgileri.haftaNo ? `${hastaBilgileri.haftaNo}. Hafta` : 'Hafta bilgisi yok';
        document.getElementById('sablonKaydetHastaGun').textContent = hastaBilgileri.gunAdi || 'GÃ¼n bilgisi yok';
      } else {
        // Hasta bilgileri yoksa gizle
        hastaBilgiDiv.style.display = 'none';
      }
      
      // Toplam makrolarÄ± hesapla
      const toplamMakrolar = ogunYemekleri.reduce((toplam, yemek) => ({
        kalori: toplam.kalori + yemek.calories,
        protein: toplam.protein + yemek.protein,
        karb: toplam.karb + yemek.carbs,
        yag: toplam.yag + yemek.fat
      }), {kalori: 0, protein: 0, karb: 0, yag: 0});
      
      // Ã–zet bilgilerini doldur
      document.getElementById('sablonKaydetYemekSayisi').textContent = ogunYemekleri.length;
      document.getElementById('sablonKaydetKalori').textContent = toplamMakrolar.kalori.toFixed(0);
      document.getElementById('sablonKaydetOgunTipi').textContent = ogunAdi;
      document.getElementById('sablonKaydetTarih').textContent = new Date().toLocaleDateString('tr-TR');
      
      // Modal verilerini sakla
      modal.ogunAdi = ogunAdi;
      modal.ogunYemekleri = ogunYemekleri;
      modal.toplamMakrolar = toplamMakrolar;
      modal.hastaBilgileri = hastaBilgileri; // Hasta bilgilerini de sakla
      
      // Modal'Ä± gÃ¶ster
      modal.style.display = 'block';
      
      // Ä°sim alanÄ±na focus
      document.getElementById('sablonKaydetIsim').focus();
      document.getElementById('sablonKaydetIsim').select();
    }
    
    // Modal'Ä± kapat
    function sablonKaydetModalKapat(event) {
      if (event && event.target !== event.currentTarget) return;
      document.getElementById('sablonKaydetModal').style.display = 'none';
    }
    
    // Åablon kaydetme onayÄ±
    async function sablonKaydetOnay() {
      const modal = document.getElementById('sablonKaydetModal');
      const sablonIsmi = document.getElementById('sablonKaydetIsim').value.trim();
      const diyetTuruId = document.getElementById('sablonKaydetDiyetTuru').value;
      
      if (!sablonIsmi) {
        showToast('âŒ Åablon ismi girilmedi!', 'error');
        document.getElementById('sablonKaydetIsim').focus();
        return;
      }
      
      // SeÃ§ilen diyet tÃ¼rÃ¼nÃ¼ bul
      let seciliDiyetTuru = null;
      if (diyetTuruId && window.diyetTurleri) {
        seciliDiyetTuru = window.diyetTurleri.find(d => d.id === diyetTuruId);
      }
      
      // Åablon nesnesini oluÅŸtur
      const yeniSablon = {
        id: Date.now().toString(),
        name: sablonIsmi,
        type: modal.ogunAdi.toLowerCase(),
        createdDate: new Date().toISOString().split('T')[0],
        dietType: seciliDiyetTuru ? seciliDiyetTuru.id : null,
        dietTypeName: seciliDiyetTuru ? seciliDiyetTuru.name : null,
        totalMacros: modal.toplamMakrolar,
        foods: modal.ogunYemekleri.map(yemek => ({
          foodName: yemek.foodName,
          originalText: yemek.originalText
        })),
        // Hasta bilgilerini ekle
        sourcePatient: modal.hastaBilgileri ? {
          name: modal.hastaBilgileri.isim,
          dateRange: modal.hastaBilgileri.tarihAraligi,
          weekNumber: modal.hastaBilgileri.haftaNo,
          dayName: modal.hastaBilgileri.gunAdi
        } : null
      };
      
      console.log('âœ… Åablon hazÄ±rlandÄ±:', yeniSablon);
      
      // Modal'Ä± kapat
      sablonKaydetModalKapat();
      
      // GitHub'a kaydet
      try {
        await githubaSablonKaydet('meal-templates.json', yeniSablon);
        const diyetInfo = seciliDiyetTuru ? ` (${seciliDiyetTuru.name})` : '';
        showToast(`âœ… "${sablonIsmi}" ÅŸablonu kaydedildi!${diyetInfo} (${modal.ogunYemekleri.length} yemek, ${modal.toplamMakrolar.kalori.toFixed(0)} kcal)`, 'success', 4000);
      } catch (error) {
        console.error('âŒ GitHub kaydetme hatasÄ±:', error);
        showToast(`âš ï¸ Åablon hazÄ±r ama GitHub'a kaydedilemedi: ${error.message}`, 'warning', 5000);
      }
    }

    // === ÅABLON ARÅÄ°VÄ° SÄ°STEMÄ° ===

    // Global deÄŸiÅŸkenler
    let mevcutSablonlar = [];
    let filtrelenmisSablonlar = [];

    // Åablon arÅŸivini aÃ§
    async function acSablonArsivi() {
      console.log('ğŸ“‹ Åablon arÅŸivi aÃ§Ä±lÄ±yor...');
      document.getElementById('sablonArsiviModal').style.display = 'block';
      await sablonlariYukle();
    }

    // Åablon arÅŸivi modalÄ±nÄ± kapat
    function sablonArsiviModalKapat(event) {
      if (event && event.target !== event.currentTarget) return;
      document.getElementById('sablonArsiviModal').style.display = 'none';
    }

    // GitHub'dan ÅŸablonlarÄ± yÃ¼kle
    async function sablonlariYukle() {
      const token = document.getElementById('githubToken').value.trim();
      if (!token) {
        document.getElementById('sablonListesi').innerHTML = `
          <div style="text-align: center; color: #dc3545; padding: 40px;">
            <i class="fas fa-exclamation-triangle" style="font-size: 24px; margin-bottom: 10px;"></i>
            <p>GitHub token bulunamadÄ±!</p>
            <p style="font-size: 12px; color: #666;">ÅablonlarÄ± gÃ¶rÃ¼ntÃ¼lemek iÃ§in GitHub token'Ä±nÄ±zÄ± girin.</p>
          </div>`;
        return;
      }

      try {
        const repoOwner = 'mustafasacar35';
        const repoName = 'lipodem-takip-paneli-3';
        const apiUrl = `https://api.github.com/repos/${repoOwner}/${repoName}/contents/meal-templates.json`;

        console.log('ğŸ”„ GitHub\'dan ÅŸablonlar yÃ¼kleniyor...');
        
        const response = await fetch(apiUrl, {
          headers: { 'Authorization': `token ${token}` }
        });

        if (response.ok) {
          const data = await response.json();
          // GitHub base64 iÃ§eriÄŸini temizle (satÄ±r sonlarÄ± ve boÅŸluklarÄ± kaldÄ±r)
          const cleanBase64 = data.content.replace(/\s/g, '');
          const content = decodeBase64UTF8(cleanBase64);
          console.log('ğŸ•µï¸ DEBUG: Ä°lk 200 karakter:', content.substring(0, 200));
          
          // KarÄ±ÅŸÄ±k encoding sorununu tespit et ve onar
          mevcutSablonlar = JSON.parse(content);
          
          // Bozuk karakterli ÅŸablonlarÄ± tespit et
          let bozukSablonSayisi = 0;
          mevcutSablonlar.forEach((sablon, index) => {
            // GÃ¼venli field eriÅŸimi
            const isim = sablon.name || sablon.isim || '';
            const aciklama = sablon.type || sablon.aciklama || '';
            
            const hasBozukChar = isim.includes('ÃƒÃ‚') || isim.includes('Ãƒ') || aciklama.includes('ÃƒÃ‚') || aciklama.includes('Ãƒ');
            if (hasBozukChar) {
              bozukSablonSayisi++;
              console.log(`ğŸ”§ Bozuk ÅŸablon tespit edildi [${index}]: ${isim.substring(0, 50)}...`);
            }
          });
          
          if (bozukSablonSayisi > 0) {
            console.log(`âš ï¸ TOPLAM ${bozukSablonSayisi} adet bozuk ÅŸablon tespit edildi!`);
            console.log('ğŸ’¡ Bu ÅŸablonlarÄ± silip yeniden oluÅŸturmanÄ±zÄ± Ã¶neririz.');
          }
          
          // ÅablonlarÄ± tarihe gÃ¶re sÄ±rala (eskiden yeniye)
          mevcutSablonlar.sort((a, b) => {
            const dateA = new Date(a.createdDate || '2024-01-01');
            const dateB = new Date(b.createdDate || '2024-01-01');
            return dateA - dateB;
          });
          
          // Otomatik numaralandÄ±rma uygula
          mevcutSablonlar.forEach((sablon, index) => {
            const yeniNumara = index + 1;
            
            // EÄŸer ÅŸablon isminde numara varsa, gÃ¼ncelle
            if (sablon.name) {
              // Mevcut numarayÄ± kaldÄ±r ve yeni numara ekle
              let temizIsim = sablon.name;
              
              // BaÅŸÄ±ndaki numarayÄ± kaldÄ±r: "5. ğŸ“‹ HASTA ADI..." â†’ "ğŸ“‹ HASTA ADI..."
              temizIsim = temizIsim.replace(/^\d+\.\s*/, '');
              
              // Yeni numara ekle
              sablon.displayName = `${yeniNumara}. ${temizIsim}`;
              
              console.log(`ğŸ”¢ Åablon ${index + 1}: "${sablon.name}" â†’ "${sablon.displayName}"`);
            } else {
              sablon.displayName = sablon.name || `Åablon ${yeniNumara}`;
            }
          });
          
          filtrelenmisSablonlar = [...mevcutSablonlar];
          
          console.log('âœ… Åablonlar yÃ¼klendi:', mevcutSablonlar.length, 'adet');
          diyetTuruFiltresiniGuncelle();
          sablonlariRender();
        } else if (response.status === 404) {
          mevcutSablonlar = [];
          filtrelenmisSablonlar = [];
          document.getElementById('sablonListesi').innerHTML = `
            <div style="text-align: center; color: #6c757d; padding: 40px;">
              <i class="fas fa-inbox" style="font-size: 48px; margin-bottom: 15px; opacity: 0.5;"></i>
              <h4 style="margin: 0 0 10px 0;">HenÃ¼z ÅŸablon yok</h4>
              <p style="margin: 0; font-size: 14px;">Ä°lk ÅŸablonunuzu oluÅŸturmak iÃ§in bir Ã¶ÄŸÃ¼nÃ¼n yanÄ±ndaki ğŸ’¾ Kaydet butonunu kullanÄ±n.</p>
            </div>`;
        } else {
          throw new Error(`GitHub API hatasÄ±: ${response.status}`);
        }
      } catch (error) {
        console.error('âŒ Åablon yÃ¼kleme hatasÄ±:', error);
        document.getElementById('sablonListesi').innerHTML = `
          <div style="text-align: center; color: #dc3545; padding: 40px;">
            <i class="fas fa-exclamation-triangle" style="font-size: 24px; margin-bottom: 10px;"></i>
            <p>Åablon yÃ¼kleme hatasÄ±!</p>
            <p style="font-size: 12px; color: #666;">${error.message}</p>
          </div>`;
      }
    }

    // ÅablonlarÄ± yenile
    async function sablonlariYenile() {
      document.getElementById('sablonListesi').innerHTML = `
        <div style="text-align: center; color: #666; padding: 40px;">
          <i class="fas fa-spinner fa-spin" style="font-size: 24px; margin-bottom: 10px;"></i>
          <p>Åablonlar yenileniyor...</p>
        </div>`;
      await sablonlariYukle();
    }

    // ÅablonlarÄ± render et
    function sablonlariRender() {
      const container = document.getElementById('sablonListesi');
      const sayiInfo = document.getElementById('sablonSayisiInfo');
      
      sayiInfo.textContent = `ğŸ“Š Toplam: ${filtrelenmisSablonlar.length} ÅŸablon`;

      if (filtrelenmisSablonlar.length === 0) {
        container.innerHTML = `
          <div style="text-align: center; color: #6c757d; padding: 40px;">
            <i class="fas fa-search" style="font-size: 24px; margin-bottom: 10px; opacity: 0.5;"></i>
            <p>Filtreye uygun ÅŸablon bulunamadÄ±.</p>
          </div>`;
        return;
      }

      let html = '';
      filtrelenmisSablonlar.forEach((sablon, index) => {
        const kaloriInfo = sablon.totalMacros ? ` (${sablon.totalMacros.kalori.toFixed(0)} kcal)` : '';
        const yemekSayisi = sablon.foods ? sablon.foods.length : 0;
        
        html += `
          <div style="
            border: 1px solid #ddd; 
            border-radius: 8px; 
            margin-bottom: 15px; 
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
          " 
          onmouseover="this.style.boxShadow='0 4px 8px rgba(0,0,0,0.15)'; this.style.transform='translateY(-2px)'" 
          onmouseout="this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)'; this.style.transform='translateY(0px)'">
            
            <!-- Åablon BaÅŸlÄ±ÄŸÄ± -->
            <div style="padding: 15px 20px; border-bottom: 1px solid #f0f0f0; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
              <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 15px;">
                <!-- Sol Taraf: BaÅŸlÄ±k ve Bilgiler -->
                <div style="flex: 1;">
                  <h4 style="margin: 0 0 8px 0; color: #495057; font-size: 15px; line-height: 1.3;">${sablon.displayName || sablon.name}</h4>
                  <div style="display: flex; flex-wrap: wrap; align-items: center; gap: 12px; font-size: 12px; color: #6c757d;">
                    <span><i class="fas fa-utensils"></i> ${sablon.type}</span>
                    <span><i class="fas fa-calendar"></i> ${sablon.createdDate}</span>
                    <span><i class="fas fa-list"></i> ${yemekSayisi} yemek${kaloriInfo}</span>
                    ${sablon.dietTypeName ? `<span><i class="fas fa-chart-pie"></i> ${sablon.dietTypeName}</span>` : ''}
                  </div>
                </div>
                
                <!-- SaÄŸ Taraf: Butonlar -->
                <div style="display: flex; gap: 6px; flex-shrink: 0;">
                  <button onclick="sablonDuzenle('${sablon.id}')" title="DÃ¼zenle" style="
                    padding: 6px 10px; 
                    background: #007bff; 
                    color: white; 
                    border: none; 
                    border-radius: 4px; 
                    cursor: pointer; 
                    font-size: 11px;
                  ">âœï¸</button>
                  <button onclick="sablonKopyala('${sablon.id}')" title="Kopyala" style="
                    padding: 6px 10px; 
                    background: #28a745; 
                    color: white; 
                    border: none; 
                    border-radius: 4px; 
                    cursor: pointer; 
                    font-size: 11px;
                  ">ğŸ“‹</button>
                  <button onclick="sablonSil('${sablon.id}')" title="Sil" style="
                    padding: 6px 10px; 
                    background: #dc3545; 
                    color: white; 
                    border: none; 
                    border-radius: 4px; 
                    cursor: pointer; 
                    font-size: 11px;
                  ">ğŸ—‘ï¸</button>
                </div>
              </div>
            </div>
            
            <!-- Yemek Listesi -->
            <div style="padding: 15px 20px;">
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 10px;">
                ${sablon.foods.map(yemek => `
                  <div style="
                    padding: 8px 12px; 
                    background: #f8f9fa; 
                    border-radius: 6px; 
                    border-left: 3px solid #28a745;
                    font-size: 13px;
                  ">
                    <strong>${yemek.foodName}</strong>
                    ${yemek.originalText !== yemek.foodName ? `<br><small style="color: #6c757d;">${yemek.originalText}</small>` : ''}
                  </div>
                `).join('')}
              </div>
            </div>
          </div>`;
      });
      
      container.innerHTML = html;
    }

    // ÅablonlarÄ± filtrele
    function sablonlariFiltrele() {
      const filtre = document.getElementById('sablonFiltre').value.toLowerCase();
      const diyetFiltre = document.getElementById('diyetTuruFiltre').value;
      const aramaMetni = document.getElementById('sablonArama').value.toLowerCase();
      
      filtrelenmisSablonlar = mevcutSablonlar.filter(sablon => {
        const tipUygun = !filtre || sablon.type.toLowerCase().includes(filtre);
        
        // Diyet tÃ¼rÃ¼ filtresi
        let diyetUygun = true;
        if (diyetFiltre) {
          if (diyetFiltre === 'no-diet') {
            diyetUygun = !sablon.dietType;
          } else {
            diyetUygun = sablon.dietType === diyetFiltre;
          }
        }
        
        const aramaUygun = !aramaMetni || 
          sablon.name.toLowerCase().includes(aramaMetni) ||
          sablon.type.toLowerCase().includes(aramaMetni) ||
          (sablon.dietTypeName && sablon.dietTypeName.toLowerCase().includes(aramaMetni)) ||
          sablon.foods.some(yemek => 
            yemek.foodName.toLowerCase().includes(aramaMetni) ||
            yemek.originalText.toLowerCase().includes(aramaMetni)
          );
        
        return tipUygun && diyetUygun && aramaUygun;
      });
      
      sablonlariRender();
    }

    // ÅablonlarÄ± ara
    function sablonlariAra() {
      sablonlariFiltrele();
    }
    
    // Diyet tÃ¼rÃ¼ filtresini gÃ¼ncelle
    function diyetTuruFiltresiniGuncelle() {
      const diyetFiltresi = document.getElementById('diyetTuruFiltre');
      if (!diyetFiltresi) return;
      
      // Åablonlardaki benzersiz diyet tÃ¼rlerini bul
      const kullanililanDiyetTurleri = new Set();
      mevcutSablonlar.forEach(sablon => {
        if (sablon.dietType && sablon.dietTypeName) {
          kullanililanDiyetTurleri.add(JSON.stringify({
            id: sablon.dietType,
            name: sablon.dietTypeName
          }));
        }
      });
      
      // Mevcut seÃ§ili deÄŸeri koru
      const mevcutSecim = diyetFiltresi.value;
      
      // Dropdown'Ä± yeniden oluÅŸtur
      diyetFiltresi.innerHTML = `
        <option value="">TÃ¼m Diyet TÃ¼rleri</option>
        <option value="no-diet">Diyet TÃ¼rÃ¼ Olmayan</option>
      `;
      
      // KullanÄ±lan diyet tÃ¼rlerini ekle
      Array.from(kullanililanDiyetTurleri).forEach(diyetStr => {
        const diyet = JSON.parse(diyetStr);
        const option = document.createElement('option');
        option.value = diyet.id;
        option.textContent = diyet.name;
        diyetFiltresi.appendChild(option);
      });
      
      // Ã–nceki seÃ§imi geri yÃ¼kle
      if (mevcutSecim) {
        diyetFiltresi.value = mevcutSecim;
      }
    }

    // Åablon dÃ¼zenle
    function sablonDuzenle(sablonId) {
      const sablon = mevcutSablonlar.find(s => s.id === sablonId);
      if (!sablon) return;
      
      const yeniIsim = prompt(`Åablon adÄ±nÄ± dÃ¼zenleyin:`, sablon.name);
      if (yeniIsim && yeniIsim.trim() !== '' && yeniIsim !== sablon.name) {
        sablon.name = yeniIsim.trim();
        sablonuGuncelle(sablon);
      }
    }

    // Åablon kopyala
    function sablonKopyala(sablonId) {
      const sablon = mevcutSablonlar.find(s => s.id === sablonId);
      if (!sablon) return;
      
      // AynÄ± Ã¶ÄŸÃ¼n tipindeki ÅŸablonlarÄ± say ve otomatik numara oluÅŸtur
      const ogunTipi = sablon.type;
      const ayniTipteSablonlar = mevcutSablonlar.filter(s => s.type === ogunTipi);
      const sonrakiNumara = ayniTipteSablonlar.length + 1;
      const ogunAdi = ogunTipi.charAt(0).toUpperCase() + ogunTipi.slice(1); // Ä°lk harfi bÃ¼yÃ¼t
      const otomatikIsim = `${ogunAdi}-${sonrakiNumara}`;
      
      const yeniIsim = prompt(`Kopyalanan ÅŸablon iÃ§in yeni ad:\n\nğŸ’¡ Ã–nerilen format: ${otomatikIsim}`, otomatikIsim);
      if (yeniIsim && yeniIsim.trim() !== '') {
        // Diyet tÃ¼rÃ¼ seÃ§imi
        let seciliDiyetTuru = null;
        if (window.diyetTurleri && window.diyetTurleri.length > 0) {
          const diyetSecenekleri = window.diyetTurleri.map((diyet, index) => `${index + 1}. ${diyet.name}`).join('\n');
          const diyetSecimi = prompt(
            `ğŸ“‹ Kopyalanan ÅŸablon iÃ§in diyet tÃ¼rÃ¼ seÃ§in (isteÄŸe baÄŸlÄ±):\n\n${diyetSecenekleri}\n\n0. Diyet tÃ¼rÃ¼ olmadan devam et\n\nSeÃ§iminizi girin (1-${window.diyetTurleri.length} veya 0):`,
            sablon.dietType ? (window.diyetTurleri.findIndex(d => d.id === sablon.dietType) + 1).toString() : '0'
          );
          
          if (diyetSecimi && diyetSecimi.trim() !== '' && diyetSecimi !== '0') {
            const secimIndex = parseInt(diyetSecimi) - 1;
            if (secimIndex >= 0 && secimIndex < window.diyetTurleri.length) {
              seciliDiyetTuru = window.diyetTurleri[secimIndex];
            }
          }
        }
        
        const yeniSablon = {
          ...sablon,
          id: Date.now().toString(),
          name: yeniIsim.trim(),
          createdDate: new Date().toISOString().split('T')[0],
          dietType: seciliDiyetTuru ? seciliDiyetTuru.id : null,
          dietTypeName: seciliDiyetTuru ? seciliDiyetTuru.name : null
        };
        
        sablonEkle(yeniSablon);
      }
    }

    // Åablon sil
    function sablonSil(sablonId) {
      const sablon = mevcutSablonlar.find(s => s.id === sablonId);
      if (!sablon) return;
      
      if (confirm(`"${sablon.name}" ÅŸablonunu silmek istediÄŸinizden emin misiniz?`)) {
        mevcutSablonlar = mevcutSablonlar.filter(s => s.id !== sablonId);
        sablonlariGithubKaydet();
      }
    }

    // Åablonu gÃ¼ncelle
    async function sablonuGuncelle(sablon) {
      const index = mevcutSablonlar.findIndex(s => s.id === sablon.id);
      if (index !== -1) {
        mevcutSablonlar[index] = sablon;
        await sablonlariGithubKaydet();
      }
    }

    // Yeni ÅŸablon ekle
    async function sablonEkle(yeniSablon) {
      mevcutSablonlar.push(yeniSablon);
      await sablonlariGithubKaydet();
    }

    // ÅablonlarÄ± GitHub'a kaydet
    async function sablonlariGithubKaydet() {
      const token = document.getElementById('githubToken').value.trim();
      if (!token) {
        alert('GitHub token bulunamadÄ±!');
        return;
      }

      try {
        const repoOwner = 'mustafasacar35';
        const repoName = 'lipodem-takip-paneli-3';
        const apiUrl = `https://api.github.com/repos/${repoOwner}/${repoName}/contents/meal-templates.json`;

        // Ã–nce mevcut SHA'yi al
        let sha = null;
        try {
          const getResponse = await fetch(apiUrl, {
            headers: { 'Authorization': `token ${token}` }
          });
          if (getResponse.ok) {
            const getData = await getResponse.json();
            sha = getData.sha;
          }
        } catch (e) {
          console.log('SHA alÄ±namadÄ±, yeni dosya oluÅŸturulacak');
        }

        // JSON'u UTF-8 base64'e Ã§evir
        const jsonString = JSON.stringify(mevcutSablonlar, null, 2);
        const utf8Bytes = new TextEncoder().encode(jsonString);
        let base64String = '';
        const chunkSize = 8192;
        
        for (let i = 0; i < utf8Bytes.length; i += chunkSize) {
          const chunk = utf8Bytes.slice(i, i + chunkSize);
          const binaryString = String.fromCharCode.apply(null, chunk);
          base64String += btoa(binaryString);
        }

        const payload = {
          message: `Åablon arÅŸivi gÃ¼ncellendi: ${mevcutSablonlar.length} ÅŸablon`,
          content: base64String
        };

        if (sha) {
          payload.sha = sha;
        }

        const response = await fetch(apiUrl, {
          method: 'PUT',
          headers: {
            'Authorization': `token ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(payload)
        });

        if (response.ok) {
          console.log('âœ… Åablonlar GitHub\'a kaydedildi');
          showToast('âœ… Åablonlar baÅŸarÄ±yla gÃ¼ncellendi!', 'success');
          await sablonlariYukle(); // Yeniden yÃ¼kle
        } else {
          throw new Error(`GitHub API hatasÄ±: ${response.status}`);
        }
      } catch (error) {
        console.error('âŒ Åablon kaydetme hatasÄ±:', error);
        showToast(`âš ï¸ Åablon kaydetme hatasÄ±: ${error.message}`, 'error');
      }
    }
    
    // Global fonksiyonlarÄ± window objesine ata
    window.kaydetOgunSablonu = kaydetOgunSablonu;
    window.alternatifleriGosterOgun = alternatifleriGosterOgun;

    // =============================
    // DÄ°YET TÃœRLERÄ° YÃ–NETÄ°MÄ° FONKSÄ°YONLARI
    // =============================
    
    let mevcutDiyetTurleri = [];
    
    // Diyet tÃ¼rleri modalÄ±nÄ± aÃ§
    function acDiyetTurleri() {
      console.log('ğŸ¯ Diyet tÃ¼rleri paneli aÃ§Ä±lÄ±yor...');
      document.getElementById('diyetTurleriModal').style.display = 'block';
      diyetTurleriYukle();
    }
    
    // Diyet tÃ¼rleri modalÄ±nÄ± kapat
    function diyetTurleriKapat(event) {
      if (event && event.target !== event.currentTarget) return;
      document.getElementById('diyetTurleriModal').style.display = 'none';
    }
    
    // Makro deÄŸerlerini gÃ¼ncelle
    function updateMakroValues() {
      const karb = document.getElementById('karbOrani').value;
      const protein = document.getElementById('proteinOrani').value;
      const yag = document.getElementById('yagOrani').value;
      
      document.getElementById('karbValue').textContent = karb + '%';
      document.getElementById('proteinValue').textContent = protein + '%';
      document.getElementById('yagValue').textContent = yag + '%';
      
      const toplam = parseInt(karb) + parseInt(protein) + parseInt(yag);
      const toplamSpan = document.getElementById('toplamOran');
      toplamSpan.textContent = toplam + '%';
      
      // Renk ayarla
      if (toplam === 100) {
        toplamSpan.style.color = '#28a745';
      } else if (toplam > 95 && toplam < 105) {
        toplamSpan.style.color = '#ffc107';
      } else {
        toplamSpan.style.color = '#dc3545';
      }
    }
    
    // Yeni diyet tÃ¼rÃ¼ ekle
    function diyetTuruEkle() {
      const ad = document.getElementById('yeniDiyetAdi').value.trim();
      const aciklama = document.getElementById('yeniDiyetAciklama').value.trim();
      const karb = parseInt(document.getElementById('karbOrani').value);
      const protein = parseInt(document.getElementById('proteinOrani').value);
      const yag = parseInt(document.getElementById('yagOrani').value);
      const yasakliKelimeler = document.getElementById('yasakliKelimeler').value.trim();
      
      // Validasyon
      if (!ad) {
        alert('Diyet adÄ± gerekli!');
        return;
      }
      
      const toplam = karb + protein + yag;
      if (Math.abs(toplam - 100) > 5) {
        alert('Makro oranlarÄ± toplamÄ± %100\'e yakÄ±n olmalÄ±! (Åu an: %' + toplam + ')');
        return;
      }
      
      // Zorunlu Ã¶zellikler
      const ozellikler = {
        ketojenik: document.getElementById('ketojenik').checked,
        glutensiz: document.getElementById('glutensiz').checked,
        vegan: document.getElementById('vegan').checked,
        vegetarian: document.getElementById('vegetarian').checked,
        dusukKalori: document.getElementById('dusukKalori').checked,
        yuksekProtein: document.getElementById('yuksekProtein').checked
      };
      
      // YasaklÄ± kelimeleri array'e Ã§evir
      const yasakliArray = yasakliKelimeler ? 
        yasakliKelimeler.split(',').map(k => k.trim().toLowerCase()).filter(k => k) : [];
      
      const yeniDiyet = {
        id: Date.now().toString(),
        ad: ad,
        aciklama: aciklama,
        makroOranlari: {
          karbonhidrat: karb,
          protein: protein,
          yag: yag
        },
        yasakliKelimeler: yasakliArray,
        zorunluOzellikler: ozellikler,
        olusturmaTarihi: new Date().toISOString().split('T')[0]
      };
      
      mevcutDiyetTurleri.push(yeniDiyet);
      diyetTurleriRender();
      diyetFormTemizle();
      
      console.log('âœ… Yeni diyet tÃ¼rÃ¼ eklendi:', yeniDiyet);
    }
    
    // Diyet tÃ¼rlerini render et
    function diyetTurleriRender() {
      const liste = document.getElementById('diyetTurleriListesi');
      
      if (mevcutDiyetTurleri.length === 0) {
        liste.innerHTML = `
          <div style="padding: 40px; text-align: center; color: #6c757d;">
            HenÃ¼z diyet tÃ¼rÃ¼ tanÄ±mlanmamÄ±ÅŸ. YukarÄ±daki formu kullanarak yeni diyet tÃ¼rÃ¼ ekleyin.
          </div>
        `;
        return;
      }
      
      let html = '';
      mevcutDiyetTurleri.forEach(diyet => {
        const ozellikBadges = Object.entries(diyet.zorunluOzellikler)
          .filter(([key, value]) => value)
          .map(([key, value]) => {
            const labels = {
              ketojenik: 'Ketojenik',
              glutensiz: 'GlÃ¼ten Siz',
              vegan: 'Vegan',
              vegetarian: 'Vejetaryen',
              dusukKalori: 'DÃ¼ÅŸÃ¼k Kalori',
              yuksekProtein: 'YÃ¼ksek Protein'
            };
            return `<span style="background: #e7f3ff; color: #0066cc; padding: 2px 6px; border-radius: 3px; font-size: 11px; margin-right: 4px;">${labels[key]}</span>`;
          }).join('');
          
        html += `
          <div style="border-bottom: 1px solid #eee; padding: 15px;">
            <div style="display: flex; justify-content: between; align-items: start; margin-bottom: 10px;">
              <div style="flex: 1;">
                <h5 style="margin: 0; color: #495057; font-size: 16px;">${diyet.ad}</h5>
                <p style="margin: 5px 0 0 0; color: #6c757d; font-size: 13px;">${diyet.aciklama || 'AÃ§Ä±klama yok'}</p>
              </div>
              <div style="display: flex; gap: 8px;">
                <button onclick="diyetDuzenle('${diyet.id}')" style="background: #ffc107; color: #212529; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">âœï¸</button>
                <button onclick="diyetSil('${diyet.id}')" style="background: #dc3545; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">ğŸ—‘ï¸</button>
              </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 10px;">
              <div style="text-align: center; background: #e7f3ff; padding: 8px; border-radius: 4px;">
                <div style="font-size: 12px; color: #666;">Karbonhidrat</div>
                <div style="font-weight: bold; color: #007bff;">%${diyet.makroOranlari.karbonhidrat}</div>
              </div>
              <div style="text-align: center; background: #e8f5e8; padding: 8px; border-radius: 4px;">
                <div style="font-size: 12px; color: #666;">Protein</div>
                <div style="font-weight: bold; color: #28a745;">%${diyet.makroOranlari.protein}</div>
              </div>
              <div style="text-align: center; background: #ffe6e6; padding: 8px; border-radius: 4px;">
                <div style="font-size: 12px; color: #666;">YaÄŸ</div>
                <div style="font-weight: bold; color: #dc3545;">%${diyet.makroOranlari.yag}</div>
              </div>
            </div>
            
            ${ozellikBadges ? `<div style="margin-bottom: 8px;">${ozellikBadges}</div>` : ''}
            
            ${diyet.yasakliKelimeler.length > 0 ? `
              <div style="font-size: 12px; color: #dc3545;">
                <strong>ğŸš« YasaklÄ±:</strong> ${diyet.yasakliKelimeler.join(', ')}
              </div>
            ` : ''}
          </div>
        `;
      });
      
      liste.innerHTML = html;
    }
    
    // Diyet formu temizle
    function diyetFormTemizle() {
      document.getElementById('yeniDiyetAdi').value = '';
      document.getElementById('yeniDiyetAciklama').value = '';
      document.getElementById('karbOrani').value = 45;
      document.getElementById('proteinOrani').value = 25;
      document.getElementById('yagOrani').value = 30;
      document.getElementById('yasakliKelimeler').value = '';
      
      // CheckboxlarÄ± temizle
      ['ketojenik', 'glutensiz', 'vegan', 'vegetarian', 'dusukKalori', 'yuksekProtein'].forEach(id => {
        document.getElementById(id).checked = false;
      });
      
      updateMakroValues();
    }
    
    // Diyet sil
    function diyetSil(diyetId) {
      const diyet = mevcutDiyetTurleri.find(d => d.id === diyetId);
      if (!diyet) return;
      
      if (confirm(`"${diyet.ad}" diyet tÃ¼rÃ¼nÃ¼ silmek istediÄŸinizden emin misiniz?`)) {
        mevcutDiyetTurleri = mevcutDiyetTurleri.filter(d => d.id !== diyetId);
        diyetTurleriRender();
        console.log('ğŸ—‘ï¸ Diyet tÃ¼rÃ¼ silindi:', diyet.ad);
      }
    }
    
    // Diyet dÃ¼zenle
    function diyetDuzenle(diyetId) {
      // TODO: DÃ¼zenleme modalÄ± aÃ§Ä±lacak
      alert('DÃ¼zenleme Ã¶zelliÄŸi yakÄ±nda eklenecek!');
    }
    
    // Diyet tÃ¼rlerini GitHub'dan yÃ¼kle
    async function diyetTurleriYukle() {
      try {
        const token = document.getElementById('githubToken').value.trim();
        if (!token) {
          console.log('â„¹ï¸ GitHub token yok, varsayÄ±lan diyet tÃ¼rleri yÃ¼kleniyor');
          varsayilanDiyetTurleriYukle();
          return;
        }
        
        const response = await fetch('https://api.github.com/repos/mustafasacar35/lipodem-takip-paneli-3/contents/diet-types.json', {
          headers: { 'Authorization': `token ${token}` }
        });
        
        if (response.ok) {
          const data = await response.json();
          const cleanBase64 = data.content.replace(/\\s/g, '');
          const content = decodeBase64UTF8(cleanBase64);
          mevcutDiyetTurleri = JSON.parse(content);
          window.diyetTurleri = mevcutDiyetTurleri; // Global deÄŸiÅŸkeni de gÃ¼ncelle
          console.log('âœ… Diyet tÃ¼rleri GitHub\'dan yÃ¼klendi:', mevcutDiyetTurleri.length, 'adet');
        } else {
          console.log('ğŸ“„ diet-types.json bulunamadÄ±, varsayÄ±lan tÃ¼rler yÃ¼kleniyor');
          varsayilanDiyetTurleriYukle();
        }
      } catch (error) {
        console.error('âŒ Diyet tÃ¼rleri yÃ¼kleme hatasÄ±:', error);
        varsayilanDiyetTurleriYukle();
      }
      
      diyetTurleriRender();
    }
    
    // VarsayÄ±lan diyet tÃ¼rlerini yÃ¼kle
    function varsayilanDiyetTurleriYukle() {
      const varsayilanlar = [
        {
          id: 'ketojenik',
          name: 'Ketojenik',
          ad: 'Ketojenik',
          aciklama: 'Ã‡ok dÃ¼ÅŸÃ¼k karbonhidrat, yÃ¼ksek yaÄŸ diyeti',
          karbOrani: 5,
          proteinOrani: 25,
          yagOrani: 70,
          makroOranlari: { karbonhidrat: 5, protein: 25, yag: 70 },
          yasakliKelimeler: ['ekmek', 'pilav', 'makarna', 'ÅŸeker', 'meyve', 'patates'],
          zorunluOzellikler: { ketojenik: true, glutensiz: false, vegan: false, vegetarian: false, dusukKalori: false, yuksekProtein: false },
          olusturmaTarihi: '2025-01-01'
        },
        {
          id: 'dusuk_karb',
          name: 'DÃ¼ÅŸÃ¼k Karbonhidrat',
          ad: 'DÃ¼ÅŸÃ¼k Karbonhidrat',
          aciklama: 'Orta dÃ¼zeyde karbonhidrat kÄ±sÄ±tlamasÄ±',
          karbOrani: 20,
          proteinOrani: 30,
          yagOrani: 50,
          makroOranlari: { karbonhidrat: 20, protein: 30, yag: 50 },
          yasakliKelimeler: ['ÅŸeker', 'tatlÄ±', 'makarna'],
          zorunluOzellikler: { ketojenik: false, glutensiz: false, vegan: false, vegetarian: false, dusukKalori: true, yuksekProtein: true },
          olusturmaTarihi: '2025-01-01'
        },
        {
          id: 'akdeniz',
          name: 'Akdeniz Diyeti',
          ad: 'Akdeniz Diyeti',
          aciklama: 'Geleneksel Akdeniz beslenme modeli',
          karbOrani: 50,
          proteinOrani: 20,
          yagOrani: 30,
          makroOranlari: { karbonhidrat: 50, protein: 20, yag: 30 },
          yasakliKelimeler: ['iÅŸlenmiÅŸ et', 'ÅŸeker', 'trans yaÄŸ'],
          zorunluOzellikler: { ketojenik: false, glutensiz: false, vegan: false, vegetarian: false, dusukKalori: false, yuksekProtein: false },
          olusturmaTarihi: '2025-01-01'
        }
      ];
      
      mevcutDiyetTurleri = varsayilanlar;
      window.diyetTurleri = varsayilanlar; // Global deÄŸiÅŸkeni de gÃ¼ncelle
      console.log('âœ… VarsayÄ±lan diyet tÃ¼rleri yÃ¼klendi:', window.diyetTurleri.length, 'adet');
    }
    
    // Diyet tÃ¼rlerini GitHub'a kaydet
    async function diyetTurleriKaydet() {
      const token = document.getElementById('githubToken').value.trim();
      if (!token) {
        alert('GitHub token bulunamadÄ±!');
        return;
      }
      
      try {
        const repoOwner = 'mustafasacar35';
        const repoName = 'lipodem-takip-paneli-3';
        const apiUrl = `https://api.github.com/repos/${repoOwner}/${repoName}/contents/diet-types.json`;
        
        // Ã–nce mevcut SHA'yi al
        let sha = null;
        try {
          const getResponse = await fetch(apiUrl, {
            headers: { 'Authorization': `token ${token}` }
          });
          if (getResponse.ok) {
            const getData = await getResponse.json();
            sha = getData.sha;
          }
        } catch (e) {
          console.log('SHA alÄ±namadÄ±, yeni dosya oluÅŸturulacak');
        }
        
        // JSON'u UTF-8 base64'e Ã§evir
        const jsonString = JSON.stringify(mevcutDiyetTurleri, null, 2);
        const utf8Bytes = new TextEncoder().encode(jsonString);
        let base64String = '';
        const chunkSize = 8192;
        
        for (let i = 0; i < utf8Bytes.length; i += chunkSize) {
          const chunk = utf8Bytes.slice(i, i + chunkSize);
          const binaryString = String.fromCharCode.apply(null, chunk);
          base64String += btoa(binaryString);
        }
        
        const payload = {
          message: `Diyet tÃ¼rleri gÃ¼ncellendi: ${mevcutDiyetTurleri.length} tÃ¼r`,
          content: base64String
        };
        
        if (sha) {
          payload.sha = sha;
        }
        
        const response = await fetch(apiUrl, {
          method: 'PUT',
          headers: {
            'Authorization': `token ${token}`,
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(payload)
        });
        
        if (response.ok) {
          console.log('âœ… Diyet tÃ¼rleri GitHub\'a kaydedildi');
          showToast('âœ… Diyet tÃ¼rleri baÅŸarÄ±yla kaydedildi!', 'success');
        } else {
          const errorData = await response.text();
          throw new Error(`GitHub API hatasÄ±: ${response.status} - ${errorData}`);
        }
      } catch (error) {
        console.error('âŒ Diyet tÃ¼rleri kaydetme hatasÄ±:', error);
        showToast(`âš ï¸ Kaydetme hatasÄ±: ${error.message}`, 'error');
      }
    }
    
    // Global fonksiyonlarÄ± window objesine ata
    window.acDiyetTurleri = acDiyetTurleri;
    window.diyetTurleriKapat = diyetTurleriKapat;
    window.updateMakroValues = updateMakroValues;
    window.diyetTuruEkle = diyetTuruEkle;
    window.diyetSil = diyetSil;
    window.diyetDuzenle = diyetDuzenle;
    window.diyetTurleriKaydet = diyetTurleriKaydet;

  </script>
</body>
</html>










